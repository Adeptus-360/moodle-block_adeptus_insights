/**
 * JavaScript for the block edit form - report selection UI with searchable dropdown.
 *
 * @module     block_adeptus_insights/edit_form
 * @copyright  2025 Adeptus Analytics
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("block_adeptus_insights/edit_form",["jquery","core/str","core/notification"],(function($,Str,Notification){var KPI_ICONS=[{id:"fa-users",label:"Users",category:"People"},{id:"fa-user",label:"User",category:"People"},{id:"fa-user-plus",label:"New User",category:"People"},{id:"fa-graduation-cap",label:"Education",category:"Education"},{id:"fa-book",label:"Book",category:"Education"},{id:"fa-certificate",label:"Certificate",category:"Education"},{id:"fa-clock-o",label:"Time",category:"Time"},{id:"fa-calendar",label:"Calendar",category:"Time"},{id:"fa-hourglass-half",label:"Hourglass",category:"Time"},{id:"fa-check-circle",label:"Complete",category:"Status"},{id:"fa-check",label:"Check",category:"Status"},{id:"fa-trophy",label:"Trophy",category:"Status"},{id:"fa-star",label:"Star",category:"Status"},{id:"fa-bar-chart",label:"Bar Chart",category:"Analytics"},{id:"fa-line-chart",label:"Line Chart",category:"Analytics"},{id:"fa-pie-chart",label:"Pie Chart",category:"Analytics"},{id:"fa-area-chart",label:"Area Chart",category:"Analytics"},{id:"fa-percent",label:"Percent",category:"Numbers"},{id:"fa-hashtag",label:"Number",category:"Numbers"},{id:"fa-sort-numeric-asc",label:"Ranking",category:"Numbers"},{id:"fa-dollar",label:"Dollar",category:"Financial"},{id:"fa-gbp",label:"Pound",category:"Financial"},{id:"fa-money",label:"Money",category:"Financial"},{id:"fa-tasks",label:"Tasks",category:"Progress"},{id:"fa-spinner",label:"Progress",category:"Progress"},{id:"fa-bullseye",label:"Target",category:"Progress"},{id:"fa-flag",label:"Flag",category:"Progress"},{id:"fa-envelope",label:"Email",category:"Communication"},{id:"fa-comments",label:"Comments",category:"Communication"},{id:"fa-bell",label:"Notifications",category:"Communication"},{id:"fa-exclamation-triangle",label:"Warning",category:"Alerts"},{id:"fa-info-circle",label:"Info",category:"Alerts"},{id:"fa-thumbs-up",label:"Thumbs Up",category:"Feedback"},{id:"fa-thumbs-down",label:"Thumbs Down",category:"Feedback"},{id:"fa-smile-o",label:"Satisfaction",category:"Feedback"}],DEFAULT_KPI_ICONS=["fa-users","fa-graduation-cap","fa-clock-o","fa-check-circle"],ReportSelector=function(options){this.mode=options.mode||"kpi",this.apiKey=options.apiKey||"",this.containerId=options.containerId,this.textareaName=options.textareaName,this.container=null,this.textarea=null,this.reports=[],this.filteredReports=[],this.selectedReports=[],this.strings={},this.searchTimeout=null,this.highlightedIndex=-1,this.isDropdownOpen=!1,this.init()};ReportSelector.prototype={init:function(){var self=this;this.container=$("#"+this.containerId),this.textarea=$('[name="'+this.textareaName+'"]'),this.container.length&&this.textarea.length&&(this.loadExistingSelection(),this.loadStrings().then((function(){self.render(),self.fetchReports(),self.bindEvents(),self.container.show()})))},loadStrings:function(){var self=this;return Str.get_strings([{key:"addreport",component:"block_adeptus_insights"},{key:"removereport",component:"block_adeptus_insights"},{key:"noreportsselected",component:"block_adeptus_insights"},{key:"selectareport",component:"block_adeptus_insights"},{key:"loading",component:"block_adeptus_insights"},{key:"config_alert_report_placeholder",component:"block_adeptus_insights"}]).then((function(strings){self.strings={addreport:strings[0],removereport:strings[1],noreportsselected:strings[2],selectareport:strings[3],loading:strings[4],searchplaceholder:strings[5]||"Search reports by name, category, or type..."}}))},loadExistingSelection:function(){try{var value=this.textarea.val();value&&(this.selectedReports=JSON.parse(value))}catch(e){this.selectedReports=[]}},render:function(){var html='<div class="report-selector-ui"><div class="report-selector-header d-flex justify-content-between align-items-center mb-2"><span class="font-weight-bold">'+({kpi:"KPI Reports",tabs:"Tab Reports",manual:"Selected Reports"}[this.mode]||"Reports")+'</span><span class="badge badge-secondary report-count">0 selected</span></div><div class="report-selector-search-container mb-3 position-relative"><div class="input-group"><div class="input-group-prepend"><span class="input-group-text"><i class="fa fa-search"></i></span></div><input type="text" class="form-control report-search-input" id="'+(this.mode+"-search-"+Date.now())+'" placeholder="'+this.strings.searchplaceholder+'" autocomplete="off" aria-haspopup="listbox" aria-expanded="false"><div class="input-group-append"><button type="button" class="btn btn-primary report-selector-add-btn" disabled><i class="fa fa-plus"></i> '+this.strings.addreport+'</button></div></div><div class="report-search-dropdown position-absolute w-100 bg-white border rounded shadow-sm" style="display:none; z-index:1050; max-height:350px; overflow-y:auto; top:100%; left:0;"><div class="report-search-results"></div><div class="report-search-empty text-muted text-center py-3" style="display:none;"><i class="fa fa-search"></i> No matching reports found</div><div class="report-search-loading text-center py-3" style="display:none;"><i class="fa fa-spinner fa-spin"></i> '+this.strings.loading+'</div></div></div><div class="report-selector-list-container"><ul class="list-group report-selector-list"></ul><div class="report-selector-empty text-muted text-center py-3"><i class="fa fa-inbox fa-2x mb-2"></i><br>'+this.strings.noreportsselected+"</div></div></div>";this.container.html(html),this.updateListDisplay(),this.updateSelectedCount()},fetchReports:function(){var self=this;if(!this.apiKey)return this.container.find(".report-search-loading").hide(),void this.container.find(".report-search-empty").show().html('<i class="fa fa-exclamation-triangle"></i> API key not configured');this.container.find(".report-search-loading").show();var baseUrl="https://backend.adeptus360.com/api/v1";$.when($.ajax({url:baseUrl+"/wizard-reports",method:"GET",headers:{Authorization:"Bearer "+this.apiKey,Accept:"application/json"},timeout:15e3}),$.ajax({url:baseUrl+"/ai-reports",method:"GET",headers:{Authorization:"Bearer "+this.apiKey,Accept:"application/json"},timeout:15e3})).then((function(wizardResult,aiResult){var allReports=[];(wizardResult[0].reports||wizardResult[0].data||[]).forEach((function(r){r.source="wizard",r.displayName=r.name||r.title||r.display_name||r.slug,r.categoryName=r.category_info?r.category_info.name:"General",allReports.push(r)})),(aiResult[0].reports||aiResult[0].data||[]).forEach((function(r){r.source="ai",r.displayName=r.name||r.title||r.display_name||r.slug,r.categoryName=r.category_info?r.category_info.name:"AI Generated",allReports.push(r)})),allReports.sort((function(a,b){return a.displayName.localeCompare(b.displayName)})),self.reports=allReports,self.filteredReports=self.getAvailableReports(),self.container.find(".report-search-loading").hide(),self.renderSelectedList()})).fail((function(){self.container.find(".report-search-loading").hide(),Notification.addNotification({message:"Failed to load reports",type:"error"})}))},getAvailableReports:function(){var self=this;return this.reports.filter((function(report){return!self.selectedReports.some((function(s){return s.slug===report.slug&&s.source===report.source}))}))},filterReports:function(query){var available=this.getAvailableReports();if(!query||query.length<1)return available;var terms=(query=query.toLowerCase().trim()).split(/\s+/);return available.filter((function(report){var searchText=(report.displayName+" "+report.categoryName+" "+report.source+" "+(report.slug||"")).toLowerCase();return terms.every((function(term){return-1!==searchText.indexOf(term)}))})).slice(0,50)},renderSearchResults:function(query){var self=this,resultsContainer=this.container.find(".report-search-results"),emptyContainer=this.container.find(".report-search-empty");if(resultsContainer.empty(),0!==this.filteredReports.length){emptyContainer.hide();var byCategory={};this.filteredReports.forEach((function(report){var cat=report.categoryName||"Other";byCategory[cat]||(byCategory[cat]=[]),byCategory[cat].push(report)}));var index=0;Object.keys(byCategory).sort().forEach((function(category){resultsContainer.append('<div class="report-search-category px-3 py-1 bg-light border-bottom"><small class="text-muted font-weight-bold">'+self.escapeHtml(category)+"</small></div>"),byCategory[category].forEach((function(report){var highlightedName=self.highlightMatch(report.displayName,query),sourceBadge="ai"===report.source?'<span class="badge badge-info ml-2">AI</span>':'<span class="badge badge-primary ml-2">Wizard</span>',itemHtml='<div class="report-search-item px-3 py-2 cursor-pointer" data-index="'+index+'" data-slug="'+report.slug+'" data-source="'+report.source+'" role="option" tabindex="-1"><div class="d-flex justify-content-between align-items-center"><span class="report-name">'+highlightedName+"</span>"+sourceBadge+"</div></div>";resultsContainer.append(itemHtml),index++}))})),resultsContainer.find(".report-search-item").css("cursor","pointer").hover((function(){$(this).addClass("bg-light"),self.highlightedIndex=parseInt($(this).data("index"),10),self.updateHighlight()}),(function(){$(this).removeClass("bg-light")}))}else emptyContainer.show()},highlightMatch:function(text,query){if(!query||!text)return this.escapeHtml(text);var escaped=this.escapeHtml(text);return query.toLowerCase().trim().split(/\s+/).forEach((function(term){if(term.length>0){var regex=new RegExp("("+term.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+")","gi");escaped=escaped.replace(regex,'<mark class="bg-warning px-0">$1</mark>')}})),escaped},updateHighlight:function(){var items=this.container.find(".report-search-item");if(items.removeClass("bg-primary text-white bg-light"),this.highlightedIndex>=0&&this.highlightedIndex<items.length){var item=items.eq(this.highlightedIndex);item.removeClass("bg-light").addClass("bg-primary text-white");var dropdown=this.container.find(".report-search-dropdown"),itemTop=item.position().top,itemHeight=item.outerHeight(),dropdownHeight=dropdown.height(),scrollTop=dropdown.scrollTop();itemTop<0?dropdown.scrollTop(scrollTop+itemTop):itemTop+itemHeight>dropdownHeight&&dropdown.scrollTop(scrollTop+itemTop+itemHeight-dropdownHeight)}},openDropdown:function(){if(!this.isDropdownOpen){this.isDropdownOpen=!0,this.highlightedIndex=-1;var dropdown=this.container.find(".report-search-dropdown"),input=this.container.find(".report-search-input");dropdown.show(),input.attr("aria-expanded","true");var query=input.val();this.filteredReports=this.filterReports(query),this.renderSearchResults(query)}},closeDropdown:function(){if(this.isDropdownOpen){this.isDropdownOpen=!1,this.highlightedIndex=-1;var dropdown=this.container.find(".report-search-dropdown"),input=this.container.find(".report-search-input");dropdown.hide(),input.attr("aria-expanded","false")}},handleSearch:function(query){var self=this;this.searchTimeout&&clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout((function(){self.filteredReports=self.filterReports(query),self.renderSearchResults(query),self.highlightedIndex=-1}),150)},selectHighlightedItem:function(){if(!(this.highlightedIndex<0||this.highlightedIndex>=this.filteredReports.length)){var report=this.filteredReports[this.highlightedIndex];this.addReport(report)}},addReport:function(report){var defaultIcon=DEFAULT_KPI_ICONS[this.selectedReports.length%DEFAULT_KPI_ICONS.length],reportData={slug:report.slug,source:report.source,name:report.displayName||report.name||report.title||report.slug};"kpi"===this.mode&&(reportData.icon=defaultIcon),this.selectedReports.push(reportData),this.saveSelection(),this.updateSelectedCount(),this.filteredReports=this.getAvailableReports(),this.container.find(".report-search-input").val(""),this.closeDropdown(),this.renderSelectedList()},renderSelectedList:function(){var self=this,list=this.container.find(".report-selector-list");list.empty(),this.selectedReports.forEach((function(selected,index){var report=self.reports.find((function(r){return r.slug===selected.slug&&r.source===selected.source})),name=selected.name||(report?report.displayName:selected.slug),categoryName=report?report.categoryName:"Unknown",iconPicker="";if("kpi"===self.mode){var currentIcon=selected.icon||DEFAULT_KPI_ICONS[index%DEFAULT_KPI_ICONS.length];iconPicker=self.buildIconPicker(currentIcon,index)}var item='<li class="list-group-item d-flex justify-content-between align-items-center" data-index="'+index+'" data-slug="'+selected.slug+'" data-source="'+selected.source+'"><div class="d-flex align-items-center flex-grow-1 min-width-0"><span class="drag-handle mr-2" style="cursor: move;"><i class="fa fa-bars text-muted"></i></span>'+iconPicker+'<span class="badge badge-secondary mr-2">'+(index+1)+'</span><span class="text-truncate" title="'+self.escapeHtml(name)+'">'+self.escapeHtml(name)+'</span><small class="text-muted ml-2 d-none d-md-inline">['+self.escapeHtml(categoryName)+']</small><span class="badge badge-'+("ai"===selected.source?"info":"primary")+' ml-2">'+selected.source.toUpperCase()+'</span></div><button type="button" class="btn btn-sm btn-outline-danger report-selector-remove ml-2" title="'+self.strings.removereport+'"><i class="fa fa-times"></i></button></li>';list.append(item)})),this.updateListDisplay(),this.initSortable(),this.initIconPickers()},buildIconPicker:function(currentIcon,index){var html='<div class="dropdown kpi-icon-picker mr-2" data-index="'+index+'"><button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" title="Select icon"><i class="fa '+currentIcon+'"></i></button><div class="dropdown-menu kpi-icon-dropdown"><div class="px-2 py-1"><small class="text-muted">Select an icon</small></div><div class="dropdown-divider"></div><div class="kpi-icon-grid px-2">',categories={};return KPI_ICONS.forEach((function(icon){categories[icon.category]||(categories[icon.category]=[]),categories[icon.category].push(icon)})),Object.keys(categories).forEach((function(category){html+='<div class="kpi-icon-category mb-1"><small class="text-muted d-block mb-1">'+category+'</small><div class="d-flex flex-wrap">',categories[category].forEach((function(icon){var isActive=icon.id===currentIcon?" active":"";html+='<button type="button" class="btn btn-sm btn-light kpi-icon-option m-1'+isActive+'" data-icon="'+icon.id+'" title="'+icon.label+'"><i class="fa '+icon.id+'"></i></button>'})),html+="</div></div>"})),html+="</div></div></div>"},initIconPickers:function(){var self=this;this.container.find(".kpi-icon-picker .dropdown-toggle").off("click.iconpicker").on("click.iconpicker",(function(e){e.preventDefault(),e.stopPropagation();var $btn=$(this),$picker=$btn.closest(".kpi-icon-picker"),$menu=$picker.find(".dropdown-menu"),isOpen=$menu.hasClass("show");if(self.container.find(".kpi-icon-picker .dropdown-menu.show").removeClass("show"),self.container.find(".kpi-icon-picker .dropdown-toggle").attr("aria-expanded","false"),!isOpen){var pickerRect=$picker[0].getBoundingClientRect();window.innerHeight-pickerRect.bottom<320?$picker.addClass("dropup"):$picker.removeClass("dropup"),$menu.addClass("show"),$btn.attr("aria-expanded","true")}})),this.container.find(".kpi-icon-option").off("click.iconpicker").on("click.iconpicker",(function(e){e.preventDefault(),e.stopPropagation();var $btn=$(this),$picker=$btn.closest(".kpi-icon-picker"),index=parseInt($picker.data("index"),10),newIcon=$btn.data("icon");self.selectedReports[index]&&(self.selectedReports[index].icon=newIcon,self.saveSelection(),$picker.find(".dropdown-toggle i").removeClass().addClass("fa "+newIcon),$picker.find(".kpi-icon-option").removeClass("active"),$btn.addClass("active"),$picker.find(".dropdown-menu").removeClass("show"),$picker.find(".dropdown-toggle").attr("aria-expanded","false"))})),$(document).off("click.iconpicker-close").on("click.iconpicker-close",(function(e){$(e.target).closest(".kpi-icon-picker").length||(self.container.find(".kpi-icon-picker .dropdown-menu.show").removeClass("show"),self.container.find(".kpi-icon-picker .dropdown-toggle").attr("aria-expanded","false"))}))},updateListDisplay:function(){var list=this.container.find(".report-selector-list"),empty=this.container.find(".report-selector-empty");this.selectedReports.length>0?(list.show(),empty.hide()):(list.hide(),empty.show())},updateSelectedCount:function(){var count=this.selectedReports.length,text=1===count?"1 selected":count+" selected";this.container.find(".report-count").text(text)},initSortable:function(){var self=this,list=this.container.find(".report-selector-list");$.fn.sortable?list.sortable({handle:".drag-handle",update:function(){self.updateOrderFromDOM()}}):this.initManualSort()},initManualSort:function(){var self=this,list=this.container.find(".report-selector-list"),dragItem=null;list.on("dragstart","li",(function(e){dragItem=this,$(this).addClass("dragging opacity-50"),e.originalEvent.dataTransfer.effectAllowed="move"})),list.on("dragend","li",(function(){$(this).removeClass("dragging opacity-50"),self.updateOrderFromDOM()})),list.on("dragover","li",(function(e){e.preventDefault();var rect=this.getBoundingClientRect(),midY=rect.top+rect.height/2;e.originalEvent.clientY<midY?$(this).before(dragItem):$(this).after(dragItem)})),list.find("li").attr("draggable","true")},updateOrderFromDOM:function(){var self=this,newOrder=[];this.container.find(".report-selector-list li").each((function(){var slug=$(this).data("slug"),source=$(this).data("source"),existing=self.selectedReports.find((function(s){return s.slug===slug&&s.source===source}));existing&&newOrder.push(existing)})),this.selectedReports=newOrder,this.saveSelection(),this.renderSelectedList()},bindEvents:function(){var self=this,input=this.container.find(".report-search-input"),dropdown=this.container.find(".report-search-dropdown");input.on("focus",(function(){self.openDropdown()})),input.on("input",(function(){var query=$(this).val();self.openDropdown(),self.handleSearch(query)})),input.on("keydown",(function(e){var maxIndex=self.container.find(".report-search-item").length-1;switch(e.keyCode){case 40:e.preventDefault(),self.isDropdownOpen||self.openDropdown(),self.highlightedIndex=Math.min(self.highlightedIndex+1,maxIndex),self.updateHighlight();break;case 38:e.preventDefault(),self.highlightedIndex=Math.max(self.highlightedIndex-1,0),self.updateHighlight();break;case 13:e.preventDefault(),self.highlightedIndex>=0&&self.selectHighlightedItem();break;case 27:e.preventDefault(),self.closeDropdown(),input.blur();break;case 9:self.closeDropdown()}})),dropdown.on("click",".report-search-item",(function(){var slug=$(this).data("slug"),source=$(this).data("source"),report=self.reports.find((function(r){return r.slug===slug&&r.source===source}));report&&self.addReport(report)})),$(document).on("click",(function(e){$(e.target).closest(self.container).length||self.closeDropdown()})),this.container.on("click",".report-selector-remove",(function(e){e.stopPropagation();var item=$(this).closest("li"),slug=item.data("slug"),source=item.data("source");self.removeReport(slug,source)}))},removeReport:function(slug,source){if(this.selectedReports=this.selectedReports.filter((function(s){return!(s.slug===slug&&s.source===source)})),this.saveSelection(),this.updateSelectedCount(),this.filteredReports=this.getAvailableReports(),this.renderSelectedList(),this.isDropdownOpen){var query=this.container.find(".report-search-input").val();this.filteredReports=this.filterReports(query),this.renderSearchResults(query)}},saveSelection:function(){this.textarea.val(JSON.stringify(this.selectedReports)).trigger("change")},escapeHtml:function(text){if(!text)return"";var div=document.createElement("div");return div.textContent=text,div.innerHTML}};var AlertsManager=function(options){this.apiKey=options.apiKey||"",this.container=null,this.textarea=null,this.alerts=[],this.reports=[],this.filteredReports=[],this.operators={},this.intervals={},this.cooldowns={},this.roles={},this.editingIndex=-1,this.isDropdownOpen=!1,this.isUserDropdownOpen=!1,this.searchTimeout=null,this.userSearchTimeout=null,this.selectedUsers=[],this.strings={},this.init()};AlertsManager.prototype={init:function(){var self=this;this.container=$("#alerts-manager-container"),this.textarea=$("#id_config_alerts_json"),this.container.length&&this.loadStrings().then((function(){self.operators=JSON.parse(self.container.attr("data-operators")||"{}"),self.intervals=JSON.parse(self.container.attr("data-intervals")||"{}"),self.cooldowns=JSON.parse(self.container.attr("data-cooldowns")||"{}"),self.roles=JSON.parse(self.container.attr("data-roles")||"{}");var existingAlerts=JSON.parse(self.container.attr("data-existing-alerts")||"[]");self.alerts=existingAlerts,existingAlerts.length>0&&self.cleanupOrphanedAlerts(),self.populateSelectOptions(),self.fetchReports(),self.bindEvents(),self.renderAlertsList(),self.saveToTextarea(),self.handleAlertsEnabledToggle()}))},loadStrings:function(){var self=this;return Str.get_strings([{key:"edit_alert",component:"block_adeptus_insights"},{key:"delete_alert",component:"block_adeptus_insights"},{key:"alert_delete_confirm",component:"block_adeptus_insights"},{key:"add_new_alert",component:"block_adeptus_insights"},{key:"alert_disabled",component:"block_adeptus_insights"},{key:"config_add_alert",component:"block_adeptus_insights"}]).then((function(strings){self.strings={editAlert:strings[0],deleteAlert:strings[1],deleteConfirm:strings[2],addNewAlert:strings[3],disabled:strings[4],addAlert:strings[5]}}))},populateSelectOptions:function(){var operatorSelect=$("#alert-edit-operator");operatorSelect.empty(),$.each(this.operators,(function(key,value){operatorSelect.append($("<option>",{value:key,text:value}))}));var intervalSelect=$("#alert-edit-interval");intervalSelect.empty(),$.each(this.intervals,(function(key,value){intervalSelect.append($("<option>",{value:key,text:value}))}));var cooldownSelect=$("#alert-edit-cooldown");cooldownSelect.empty(),$.each(this.cooldowns,(function(key,value){cooldownSelect.append($("<option>",{value:key,text:value}))}));var roleFilter=$("#alert-edit-role-filter");roleFilter.length?(roleFilter.find("option:not(:first)").remove(),$.each(this.roles,(function(key,value){roleFilter.append($("<option>",{value:key,text:value}))}))):console.warn("Role filter element not found during init, will populate on panel open")},fetchReports:function(){var allReports=[],kpiTextarea=$('[name="config_kpi_selected_reports"]');if(kpiTextarea.length&&kpiTextarea.val())try{var kpiReports=JSON.parse(kpiTextarea.val());Array.isArray(kpiReports)&&kpiReports.forEach((function(r){r.displayName=r.name||r.title||r.display_name||r.slug,r.categoryName=r.category_info?r.category_info.name:"ai"===r.source?"AI Generated":"General",allReports.push(r)}))}catch(e){}var tabsTextarea=$('[name="config_tabs_selected_reports"]');if(tabsTextarea.length&&tabsTextarea.val())try{var tabsReports=JSON.parse(tabsTextarea.val());Array.isArray(tabsReports)&&tabsReports.forEach((function(r){allReports.some((function(existing){return existing.slug===r.slug}))||(r.displayName=r.name||r.title||r.display_name||r.slug,r.categoryName=r.category_info?r.category_info.name:"ai"===r.source?"AI Generated":"General",allReports.push(r))}))}catch(e){}allReports.sort((function(a,b){return(a.displayName||"").localeCompare(b.displayName||"")})),this.reports=allReports,this.filteredReports=allReports,0===allReports.length&&(this.container.find(".alert-report-empty-message").remove(),this.container.find(".alerts-edit-panel").prepend('<div class="alert alert-info alert-report-empty-message"><i class="fa fa-info-circle"></i> No reports configured in this block. Add reports in the KPI or Tabs settings first.</div>'))},handleAlertsEnabledToggle:function(){var self=this,checkbox=$('[name="config_alerts_enabled"]'),displayMode=$('[name="config_display_mode"]'),updateVisibility=function(){var enabled=checkbox.is(":checked"),isKpi="kpi"===displayMode.val();enabled&&isKpi?self.container.show():self.container.hide()};checkbox.on("change",updateVisibility),displayMode.on("change",updateVisibility),updateVisibility()},bindEvents:function(){var self=this;$('[name="config_kpi_selected_reports"], [name="config_tabs_selected_reports"]').on("change",(function(){self.fetchReports()})),this.container.on("click","#add-alert-btn",(function(){self.openEditPanel(-1)})),this.container.on("click",".alert-edit-btn",(function(){var index=$(this).closest(".alert-item").data("index");self.openEditPanel(index)})),this.container.on("click",".alert-delete-btn",(function(){var index=$(this).closest(".alert-item").data("index");confirm(self.strings.deleteConfirm)&&self.deleteAlert(index)})),this.container.on("change",".alert-enabled-toggle",(function(){var index=$(this).closest(".alert-item").data("index");self.alerts[index].enabled=$(this).is(":checked"),self.saveToTextarea(),self.renderAlertsList()})),this.container.on("click",".alert-panel-close, .alert-panel-cancel",(function(){self.closeEditPanel()})),this.container.on("click",".alert-panel-save",(function(){self.saveEditPanel()})),$("#alert-edit-notify-email").on("change",(function(){$(this).is(":checked")?$("#email-addresses-group").show():$("#email-addresses-group").hide()}));var searchInput=$("#alert-edit-report-search"),dropdown=$("#alert-report-dropdown");searchInput.on("focus",(function(){self.openReportDropdown()})),searchInput.on("input",(function(){var query=$(this).val();self.handleReportSearch(query)})),searchInput.on("keydown",(function(e){27===e.keyCode&&self.closeReportDropdown()})),dropdown.on("click",".report-dropdown-item",(function(){var slug=$(this).data("slug"),name=$(this).data("name");self.selectReport(slug,name)})),$(document).on("click",(function(e){$(e.target).closest("#alert-edit-report-search, #alert-report-dropdown").length||self.closeReportDropdown(),$(e.target).closest("#alert-edit-user-search, #alert-user-dropdown").length||self.closeUserDropdown()})),$("#alert-edit-role-filter").on("change",(function(){$("#alert-edit-user-search").val(""),self.loadUsers()}));var userSearchInput=$("#alert-edit-user-search"),userDropdown=$("#alert-user-dropdown");userSearchInput.on("focus",(function(){self.openUserDropdown()})),userSearchInput.on("input",(function(){var query=$(this).val();self.handleUserSearch(query)})),userSearchInput.on("keydown",(function(e){27===e.keyCode&&self.closeUserDropdown()})),userDropdown.on("click",".user-dropdown-item",(function(){var userId=$(this).data("userid"),userName=$(this).data("name"),userEmail=$(this).data("email");self.addSelectedUser(userId,userName,userEmail)})),this.container.on("click",".remove-selected-user",(function(){var userId=$(this).data("userid");self.removeSelectedUser(userId)}))},renderAlertsList:function(){var self=this,list=$("#alerts-list"),emptyState=list.find(".alerts-empty");list.find(".alert-item").remove(),0===this.alerts.length?emptyState.show():(emptyState.hide(),this.alerts.forEach((function(alert,index){var reportName=alert.report_name||alert.report_slug,alertName=alert.alert_name||reportName,operatorLabel=self.operators[alert.operator]||alert.operator,thresholds=[];null!==alert.warning_value&&""!==alert.warning_value&&thresholds.push("Warning: "+alert.warning_value),null!==alert.critical_value&&""!==alert.critical_value&&thresholds.push("Critical: "+alert.critical_value);var thresholdText=thresholds.join(", ")||"No thresholds set",intervalLabel=self.intervals[alert.check_interval]||alert.check_interval+"s",statusBadge="";"warning"===alert.current_status?statusBadge='<span class="badge badge-warning ml-2">Warning</span>':"critical"===alert.current_status?statusBadge='<span class="badge badge-danger ml-2">Critical</span>':alert.current_status&&(statusBadge='<span class="badge badge-success ml-2">OK</span>');var html='<div class="alert-item card mb-2" data-index="'+index+'"><div class="card-body py-2 px-3"><div class="d-flex justify-content-between align-items-start"><div class="flex-grow-1"><div class="d-flex align-items-center mb-1"><strong>'+self.escapeHtml(alertName)+"</strong>"+statusBadge+(alert.enabled?"":'<span class="badge badge-secondary ml-2">'+self.strings.disabled+"</span>")+'</div><small class="text-muted d-block">'+self.escapeHtml(reportName)+'</small><small class="text-muted d-block">'+self.escapeHtml(operatorLabel)+" | "+thresholdText+" | "+intervalLabel+'</small></div><div class="alert-actions d-flex align-items-center"><div class="custom-control custom-switch mr-2"><input type="checkbox" class="custom-control-input alert-enabled-toggle" id="alert-enabled-'+index+'"'+(alert.enabled?" checked":"")+'><label class="custom-control-label" for="alert-enabled-'+index+'"></label></div><button type="button" class="btn btn-sm btn-outline-primary alert-edit-btn mr-1" title="'+self.strings.editAlert+'"><i class="fa fa-pencil"></i></button><button type="button" class="btn btn-sm btn-outline-danger alert-delete-btn" title="'+self.strings.deleteAlert+'"><i class="fa fa-trash"></i></button></div></div></div></div>';list.append(html)}))),this.container.find(".alerts-count").text(this.alerts.length)},openEditPanel:function(index){var panel=$("#alert-edit-panel");this.editingIndex=index;var roleFilter=$("#alert-edit-role-filter");if(roleFilter.length&&roleFilter.find("option").length<=1&&$.each(this.roles,(function(key,value){roleFilter.append($("<option>",{value:key,text:value}))})),$("#alert-edit-report").val(""),$("#alert-edit-report-search").val(""),$("#alert-edit-report-display").text(""),$("#alert-edit-name").val(""),$("#alert-edit-operator").val("gt"),$("#alert-edit-warning").val(""),$("#alert-edit-critical").val(""),$("#alert-edit-interval").val("3600"),$("#alert-edit-cooldown").val("3600"),$("#alert-edit-notify-warning").prop("checked",!0),$("#alert-edit-notify-critical").prop("checked",!0),$("#alert-edit-notify-recovery").prop("checked",!0),$("#alert-edit-notify-email").prop("checked",!1),$("#alert-edit-email-addresses").val(""),$("#email-addresses-group").hide(),$("#alert-edit-role-filter").val(""),this.selectedUsers=[],this.renderSelectedUsers(),index>=0&&this.alerts[index]){var alert=this.alerts[index];$("#alert-edit-report").val(alert.report_slug),$("#alert-edit-report-search").val(alert.report_name||alert.report_slug),$("#alert-edit-report-display").text("Selected: "+(alert.report_name||alert.report_slug)),$("#alert-edit-name").val(alert.alert_name||""),$("#alert-edit-operator").val(alert.operator||"gt"),$("#alert-edit-warning").val(alert.warning_value||""),$("#alert-edit-critical").val(alert.critical_value||""),$("#alert-edit-interval").val(alert.check_interval||3600),$("#alert-edit-cooldown").val(alert.cooldown_seconds||3600),$("#alert-edit-notify-warning").prop("checked",!1!==alert.notify_on_warning),$("#alert-edit-notify-critical").prop("checked",!1!==alert.notify_on_critical),$("#alert-edit-notify-recovery").prop("checked",!1!==alert.notify_on_recovery),$("#alert-edit-notify-email").prop("checked",!!alert.notify_email),$("#alert-edit-email-addresses").val(alert.notify_emails||""),alert.notify_email&&$("#email-addresses-group").show(),this.selectedUsers=alert.notify_users||[],this.renderSelectedUsers(),panel.find(".alert-panel-title").text(this.strings.editAlert)}else panel.find(".alert-panel-title").text(this.strings.addNewAlert);panel.show()},closeEditPanel:function(){$("#alert-edit-panel").hide(),this.editingIndex=-1},getReportEndpoint:function(reportSlug){var report=this.reports.find((function(r){return r.slug===reportSlug}));return report&&"ai"===report.source?"/ai-reports/":"/wizard-reports/"},saveEditPanel:function(){var reportSlug=$("#alert-edit-report").val(),reportName=$("#alert-edit-report-search").val(),thresholdValue=$("#alert-edit-warning").val()||$("#alert-edit-critical").val(),operator=$("#alert-edit-operator").val();if(reportSlug)if(thresholdValue){var conditionType="threshold",backendOperator=operator;"change_pct"===operator||"increase_pct"===operator?(conditionType="change_percent",backendOperator="gte"):"decrease_pct"===operator&&(conditionType="change_percent",backendOperator="lte",thresholdValue=-Math.abs(parseFloat(thresholdValue)));var notifyEmail=$("#alert-edit-notify-email").is(":checked"),backendPayload={name:$("#alert-edit-name").val()||reportName,condition_type:conditionType,operator:backendOperator,value:parseFloat(thresholdValue)||0,cooldown_minutes:0,is_enabled:!0,notification_channels:notifyEmail?["email"]:["moodle"]},alertData={report_slug:reportSlug,report_name:reportName,alert_name:backendPayload.name,operator:operator,condition_type:conditionType,threshold_value:parseFloat(thresholdValue),warning_value:$("#alert-edit-warning").val()?parseFloat($("#alert-edit-warning").val()):null,critical_value:$("#alert-edit-critical").val()?parseFloat($("#alert-edit-critical").val()):null,check_interval:parseInt($("#alert-edit-interval").val(),10),cooldown_seconds:parseInt($("#alert-edit-cooldown").val(),10),notify_on_warning:$("#alert-edit-notify-warning").is(":checked"),notify_on_critical:$("#alert-edit-notify-critical").is(":checked"),notify_on_recovery:$("#alert-edit-notify-recovery").is(":checked"),notify_email:$("#alert-edit-notify-email").is(":checked"),notify_emails:$("#alert-edit-email-addresses").val().trim(),notify_users:this.selectedUsers,enabled:!0};if(this.editingIndex>=0&&this.alerts[this.editingIndex]&&this.alerts[this.editingIndex].backend_id){var backendId=this.alerts[this.editingIndex].backend_id;this.updateAlertOnBackend(reportSlug,backendId,backendPayload,alertData)}else this.createAlertOnBackend(reportSlug,backendPayload,alertData)}else Notification.addNotification({message:"Please enter a threshold value.",type:"error"});else Notification.addNotification({message:"Please select a report to monitor.",type:"error"})},createAlertOnBackend:function(reportSlug,payload,alertData){var self=this,endpoint=this.getReportEndpoint(reportSlug);$.ajax({url:"https://backend.adeptus360.com/api/v1"+endpoint+encodeURIComponent(reportSlug)+"/alerts",method:"POST",headers:{Authorization:"Bearer "+this.apiKey,"Content-Type":"application/json",Accept:"application/json"},data:JSON.stringify(payload),timeout:15e3}).done((function(response){response.success&&response.alert?(alertData.backend_id=response.alert.id,alertData.current_status="ok",self.editingIndex>=0?self.alerts[self.editingIndex]=alertData:self.alerts.push(alertData),self.saveToTextarea(),self.renderAlertsList(),self.closeEditPanel(),Notification.addNotification({message:"Alert created successfully.",type:"success"})):Notification.addNotification({message:response.message||"Failed to create alert.",type:"error"})})).fail((function(xhr){var message="Failed to create alert.";if(xhr.responseJSON&&(xhr.responseJSON.message&&(message=xhr.responseJSON.message),xhr.responseJSON.errors)){var errors=xhr.responseJSON.errors,errorDetails=[];for(var field in errors)errors.hasOwnProperty(field)&&errorDetails.push(field+": "+errors[field].join(", "));errorDetails.length>0&&(message+=" - "+errorDetails.join("; "))}console.error("Alert creation failed:",xhr.responseJSON),Notification.addNotification({message:message,type:"error"})}))},updateAlertOnBackend:function(reportSlug,alertId,payload,alertData){var self=this,endpoint=this.getReportEndpoint(reportSlug);$.ajax({url:"https://backend.adeptus360.com/api/v1"+endpoint+encodeURIComponent(reportSlug)+"/alerts/"+alertId,method:"PUT",headers:{Authorization:"Bearer "+this.apiKey,"Content-Type":"application/json",Accept:"application/json"},data:JSON.stringify(payload),timeout:15e3}).done((function(response){response.success?(alertData.backend_id=alertId,alertData.current_status=self.alerts[self.editingIndex].current_status,alertData.enabled=self.alerts[self.editingIndex].enabled,self.alerts[self.editingIndex]=alertData,self.saveToTextarea(),self.renderAlertsList(),self.closeEditPanel(),Notification.addNotification({message:"Alert updated successfully.",type:"success"})):Notification.addNotification({message:response.message||"Failed to update alert.",type:"error"})})).fail((function(xhr){var message="Failed to update alert.";xhr.responseJSON&&xhr.responseJSON.message&&(message=xhr.responseJSON.message),Notification.addNotification({message:message,type:"error"})}))},deleteAlert:function(index){var self=this,alert=this.alerts[index];if(alert)if(alert.backend_id&&alert.report_slug){var endpoint=this.getReportEndpoint(alert.report_slug);$.ajax({url:"https://backend.adeptus360.com/api/v1"+endpoint+encodeURIComponent(alert.report_slug)+"/alerts/"+alert.backend_id,method:"DELETE",headers:{Authorization:"Bearer "+this.apiKey,Accept:"application/json"},timeout:15e3}).done((function(response){self.alerts.splice(index,1),self.saveToTextarea(),self.renderAlertsList(),Notification.addNotification({message:"Alert deleted successfully.",type:"success"})})).fail((function(xhr){var message="Failed to delete alert from server.";xhr.responseJSON&&xhr.responseJSON.message&&(message=xhr.responseJSON.message),Notification.addNotification({message:message,type:"error"})}))}else this.alerts.splice(index,1),this.saveToTextarea(),this.renderAlertsList()},cleanupOrphanedAlerts:function(){var self=this,reportSlugs={},localBackendIds={};this.alerts.forEach((function(alert){alert.report_slug&&(reportSlugs[alert.report_slug]=!0,alert.backend_id&&(localBackendIds[alert.report_slug]||(localBackendIds[alert.report_slug]=[]),localBackendIds[alert.report_slug].push(alert.backend_id)))})),Object.keys(reportSlugs).forEach((function(reportSlug){var endpoint=self.getReportEndpoint(reportSlug),localIds=localBackendIds[reportSlug]||[];$.ajax({url:"https://backend.adeptus360.com/api/v1"+endpoint+encodeURIComponent(reportSlug)+"/alerts",method:"GET",headers:{Authorization:"Bearer "+self.apiKey,Accept:"application/json"},timeout:1e4}).done((function(response){response.success&&response.alerts&&response.alerts.forEach((function(backendAlert){-1===localIds.indexOf(backendAlert.id)&&self.deleteOrphanedAlert(reportSlug,backendAlert.id)}))})).fail((function(){console.warn("Failed to fetch backend alerts for orphan cleanup:",reportSlug)}))}))},deleteOrphanedAlert:function(reportSlug,alertId){var endpoint=this.getReportEndpoint(reportSlug);$.ajax({url:"https://backend.adeptus360.com/api/v1"+endpoint+encodeURIComponent(reportSlug)+"/alerts/"+alertId,method:"DELETE",headers:{Authorization:"Bearer "+this.apiKey,Accept:"application/json"},timeout:1e4}).done((function(){console.log("Cleaned up orphaned backend alert:",alertId,"for report:",reportSlug)})).fail((function(){console.warn("Failed to delete orphaned alert:",alertId,"for report:",reportSlug)}))},saveToTextarea:function(){this.textarea.val(JSON.stringify(this.alerts))},openReportDropdown:function(){if(!this.isDropdownOpen){this.isDropdownOpen=!0;var dropdown=$("#alert-report-dropdown"),input=$("#alert-edit-report-search");dropdown.css("width",input.outerWidth()+"px"),dropdown.show(),this.filteredReports=this.reports,this.renderReportDropdown("")}},closeReportDropdown:function(){this.isDropdownOpen=!1,$("#alert-report-dropdown").hide()},handleReportSearch:function(query){var self=this;this.searchTimeout&&clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout((function(){self.filteredReports=self.filterReports(query),self.renderReportDropdown(query)}),150)},filterReports:function(query){if(!query||query.length<1)return this.reports;var terms=(query=query.toLowerCase().trim()).split(/\s+/);return this.reports.filter((function(report){var searchText=(report.displayName+" "+report.categoryName+" "+report.source+" "+(report.slug||"")).toLowerCase();return terms.every((function(term){return-1!==searchText.indexOf(term)}))})).slice(0,30)},renderReportDropdown:function(query){var self=this,dropdown=$("#alert-report-dropdown");if(dropdown.empty(),0!==this.filteredReports.length){var byCategory={};this.filteredReports.forEach((function(report){var cat=report.categoryName||"Other";byCategory[cat]||(byCategory[cat]=[]),byCategory[cat].push(report)})),Object.keys(byCategory).sort().forEach((function(category){dropdown.append('<div class="px-3 py-1 bg-light border-bottom"><small class="text-muted font-weight-bold">'+self.escapeHtml(category)+"</small></div>"),byCategory[category].forEach((function(report){var sourceBadge="ai"===report.source?'<span class="badge badge-info ml-2">AI</span>':'<span class="badge badge-primary ml-2">Wizard</span>';dropdown.append('<div class="report-dropdown-item px-3 py-2" style="cursor:pointer;" data-slug="'+report.slug+'" data-name="'+self.escapeHtml(report.displayName)+'"><span>'+self.escapeHtml(report.displayName)+"</span>"+sourceBadge+"</div>")}))})),dropdown.find(".report-dropdown-item").hover((function(){$(this).addClass("bg-light")}),(function(){$(this).removeClass("bg-light")}))}else dropdown.append('<div class="p-3 text-muted text-center">No matching reports found</div>')},selectReport:function(slug,name){$("#alert-edit-report").val(slug),$("#alert-edit-report-search").val(name),$("#alert-edit-report-display").text("Selected: "+name),this.closeReportDropdown()},openUserDropdown:function(){this.isUserDropdownOpen||(this.isUserDropdownOpen=!0,$("#alert-user-dropdown").show(),this.loadUsers())},closeUserDropdown:function(){this.isUserDropdownOpen=!1,$("#alert-user-dropdown").hide()},loadUsers:function(){var self=this,roleId=$("#alert-edit-role-filter").val()||0,search=$("#alert-edit-user-search").val()||"",dropdown=$("#alert-user-dropdown");dropdown.html('<div class="p-3 text-center text-muted"><i class="fa fa-spinner fa-spin"></i> Loading...</div>'),require(["core/ajax"],(function(Ajax){Ajax.call([{methodname:"block_adeptus_insights_get_users_by_role",args:{roleid:parseInt(roleId,10),search:search,limit:50}}])[0].done((function(response){self.renderUserDropdown(response.users)})).fail((function(){dropdown.html('<div class="p-3 text-center text-danger">Failed to load users</div>')}))}))},handleUserSearch:function(query){var self=this;this.userSearchTimeout&&clearTimeout(this.userSearchTimeout),this.userSearchTimeout=setTimeout((function(){self.loadUsers()}),300)},renderUserDropdown:function(users){var self=this,dropdown=$("#alert-user-dropdown");dropdown.empty(),0!==users.length?(users.forEach((function(user){if(!self.selectedUsers.some((function(s){return s.id===user.id}))){var html='<div class="user-dropdown-item px-3 py-2 d-flex align-items-center" style="cursor:pointer;" data-userid="'+user.id+'" data-name="'+self.escapeHtml(user.fullname)+'" data-email="'+self.escapeHtml(user.email)+'"><img src="'+user.profileimageurl+'" class="rounded-circle mr-2" width="32" height="32" alt=""><div class="flex-grow-1 min-width-0"><div class="text-truncate font-weight-bold">'+self.escapeHtml(user.fullname)+'</div><small class="text-muted text-truncate d-block">'+self.escapeHtml(user.email)+"</small></div></div>";dropdown.append(html)}})),0===dropdown.children().length&&dropdown.html('<div class="p-3 text-center text-muted">All matching users already selected</div>'),dropdown.find(".user-dropdown-item").hover((function(){$(this).addClass("bg-light")}),(function(){$(this).removeClass("bg-light")}))):dropdown.html('<div class="p-3 text-center text-muted">No users found</div>')},addSelectedUser:function(userId,userName,userEmail){this.selectedUsers.some((function(u){return u.id===userId}))||(this.selectedUsers.push({id:userId,name:userName,email:userEmail}),this.renderSelectedUsers(),this.closeUserDropdown(),$("#alert-edit-user-search").val(""))},removeSelectedUser:function(userId){this.selectedUsers=this.selectedUsers.filter((function(u){return u.id!==userId})),this.renderSelectedUsers()},renderSelectedUsers:function(){var self=this,container=$("#alert-selected-users");container.empty(),0!==this.selectedUsers.length?(this.selectedUsers.forEach((function(user){var html='<div class="selected-user-chip d-inline-flex align-items-center bg-light border rounded px-2 py-1 mr-2 mb-2"><span class="mr-2">'+self.escapeHtml(user.name)+'</span><button type="button" class="btn btn-sm btn-link p-0 text-danger remove-selected-user" data-userid="'+user.id+'" title="Remove"><i class="fa fa-times"></i></button></div>';container.append(html)})),$("#alert-edit-notify-users-data").val(JSON.stringify(this.selectedUsers))):container.html('<div class="text-muted small py-2"><i class="fa fa-user-o mr-1"></i> No recipients selected</div>')},escapeHtml:function(text){if(!text)return"";var div=document.createElement("div");return div.textContent=text,div.innerHTML}};var moduleInitialized=!1;return{init:function(options){if(!moduleInitialized){moduleInitialized=!0;var initialized={kpi:!1,tabs:!1,alerts:!1},tryInitialize=function(){!initialized.kpi&&$("#kpi-report-selector-container").length&&(new ReportSelector({mode:"kpi",apiKey:options.apiKey,containerId:"kpi-report-selector-container",textareaName:"config_kpi_selected_reports"}),initialized.kpi=!0),!initialized.tabs&&$("#tabs-report-selector-container").length&&(new ReportSelector({mode:"tabs",apiKey:options.apiKey,containerId:"tabs-report-selector-container",textareaName:"config_tabs_selected_reports"}),initialized.tabs=!0),!initialized.alerts&&$("#alerts-manager-container").length&&(new AlertsManager({apiKey:options.apiKey}),initialized.alerts=!0);var displayModeSelect=$('[name="config_display_mode"]'),alertsNotice=$("#alerts-kpi-only-notice");if(displayModeSelect.length&&alertsNotice.length&&!displayModeSelect.data("alerts-notice-bound")){var updateAlertNoticeVisibility=function(){"kpi"===displayModeSelect.val()?alertsNotice.hide():alertsNotice.show()};displayModeSelect.on("change",updateAlertNoticeVisibility),setTimeout(updateAlertNoticeVisibility,50),displayModeSelect.data("alerts-notice-bound",!0)}};tryInitialize();var observer=new MutationObserver((function(){tryInitialize(),initialized.kpi&&initialized.tabs&&initialized.alerts&&observer.disconnect()}));observer.observe(document.body,{childList:!0,subtree:!0}),$(document).on("modal-shown",(function(){setTimeout(tryInitialize,100)}))}}}}));

//# sourceMappingURL=edit_form.min.js.map