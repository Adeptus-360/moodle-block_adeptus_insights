/**
 * JavaScript for the block edit form - report selection UI with searchable dropdown.
 *
 * @module     block_adeptus_insights/edit_form
 * @copyright  2026 Adeptus 360 <info@adeptus360.com>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["jquery","core/str","core/notification"],(function(e,t,a){"use strict";var r=[{id:"fa-users",label:"Users",category:"People"},{id:"fa-user",label:"User",category:"People"},{id:"fa-user-plus",label:"New User",category:"People"},{id:"fa-graduation-cap",label:"Education",category:"Education"},{id:"fa-book",label:"Book",category:"Education"},{id:"fa-certificate",label:"Certificate",category:"Education"},{id:"fa-clock-o",label:"Time",category:"Time"},{id:"fa-calendar",label:"Calendar",category:"Time"},{id:"fa-hourglass-half",label:"Hourglass",category:"Time"},{id:"fa-check-circle",label:"Complete",category:"Status"},{id:"fa-check",label:"Check",category:"Status"},{id:"fa-trophy",label:"Trophy",category:"Status"},{id:"fa-star",label:"Star",category:"Status"},{id:"fa-bar-chart",label:"Bar Chart",category:"Analytics"},{id:"fa-line-chart",label:"Line Chart",category:"Analytics"},{id:"fa-pie-chart",label:"Pie Chart",category:"Analytics"},{id:"fa-area-chart",label:"Area Chart",category:"Analytics"},{id:"fa-percent",label:"Percent",category:"Numbers"},{id:"fa-hashtag",label:"Number",category:"Numbers"},{id:"fa-sort-numeric-asc",label:"Ranking",category:"Numbers"},{id:"fa-dollar",label:"Dollar",category:"Financial"},{id:"fa-gbp",label:"Pound",category:"Financial"},{id:"fa-money",label:"Money",category:"Financial"},{id:"fa-tasks",label:"Tasks",category:"Progress"},{id:"fa-spinner",label:"Progress",category:"Progress"},{id:"fa-bullseye",label:"Target",category:"Progress"},{id:"fa-flag",label:"Flag",category:"Progress"},{id:"fa-envelope",label:"Email",category:"Communication"},{id:"fa-comments",label:"Comments",category:"Communication"},{id:"fa-bell",label:"Notifications",category:"Communication"},{id:"fa-exclamation-triangle",label:"Warning",category:"Alerts"},{id:"fa-info-circle",label:"Info",category:"Alerts"},{id:"fa-thumbs-up",label:"Thumbs Up",category:"Feedback"},{id:"fa-thumbs-down",label:"Thumbs Down",category:"Feedback"},{id:"fa-smile-o",label:"Satisfaction",category:"Feedback"}],i=["fa-users","fa-graduation-cap","fa-clock-o","fa-check-circle"],n=function(e){this.mode=e.mode||"kpi",this.apiKey=e.apiKey||"",this.containerId=e.containerId,this.textareaName=e.textareaName,this.container=null,this.textarea=null,this.reports=[],this.filteredReports=[],this.selectedReports=[],this.strings={},this.searchTimeout=null,this.highlightedIndex=-1,this.isDropdownOpen=!1,this.init()};n.prototype={init:function(){var t=this;this.container=e("#"+this.containerId),this.textarea=e('[name="'+this.textareaName+'"]'),this.container.length&&this.textarea.length&&(this.loadExistingSelection(),this.loadStrings().then((function(){t.render(),t.fetchReports(),t.bindEvents(),t.container.show()})))},loadStrings:function(){var e=this;return t.get_strings([{key:"addreport",component:"block_adeptus_insights"},{key:"removereport",component:"block_adeptus_insights"},{key:"noreportsselected",component:"block_adeptus_insights"},{key:"selectareport",component:"block_adeptus_insights"},{key:"loading",component:"block_adeptus_insights"},{key:"config_alert_report_placeholder",component:"block_adeptus_insights"}]).then((function(t){e.strings={addreport:t[0],removereport:t[1],noreportsselected:t[2],selectareport:t[3],loading:t[4],searchplaceholder:t[5]||"Search reports by name, category, or type..."}}))},loadExistingSelection:function(){try{var e=this.textarea.val();e&&(this.selectedReports=JSON.parse(e))}catch(e){this.selectedReports=[]}},render:function(){var e='<div class="report-selector-ui"><div class="report-selector-header d-flex justify-content-between align-items-center mb-2"><span class="font-weight-bold">'+({kpi:"KPI Reports",tabs:"Tab Reports",manual:"Selected Reports"}[this.mode]||"Reports")+'</span><span class="badge badge-secondary report-count">0 selected</span></div><div class="report-selector-search-container mb-3 position-relative"><div class="input-group"><div class="input-group-prepend"><span class="input-group-text"><i class="fa fa-search"></i></span></div><input type="text" class="form-control report-search-input" id="'+(this.mode+"-search-"+Date.now())+'" placeholder="'+this.strings.searchplaceholder+'" autocomplete="off" aria-haspopup="listbox" aria-expanded="false"><div class="input-group-append"><button type="button" class="btn btn-primary report-selector-add-btn" disabled><i class="fa fa-plus"></i> '+this.strings.addreport+'</button></div></div><div class="report-search-dropdown position-absolute w-100 bg-white border rounded shadow-sm" style="display:none; z-index:1050; max-height:350px; overflow-y:auto; top:100%; left:0;"><div class="report-search-results"></div><div class="report-search-empty text-muted text-center py-3" style="display:none;"><i class="fa fa-search"></i> No matching reports found</div><div class="report-search-loading text-center py-3" style="display:none;"><i class="fa fa-spinner fa-spin"></i> '+this.strings.loading+'</div></div></div><div class="report-selector-list-container"><ul class="list-group report-selector-list"></ul><div class="report-selector-empty text-muted text-center py-3"><i class="fa fa-inbox fa-2x mb-2"></i><br>'+this.strings.noreportsselected+"</div></div></div>";this.container.html(e),this.updateListDisplay(),this.updateSelectedCount()},fetchReports:function(){var t=this;if(!this.apiKey)return this.container.find(".report-search-loading").hide(),void this.container.find(".report-search-empty").show().html('<i class="fa fa-exclamation-triangle"></i> API key not configured');this.container.find(".report-search-loading").show();var r="https://backend.adeptus360.com/api/v1";e.when(e.ajax({url:r+"/wizard-reports",method:"GET",headers:{Authorization:"Bearer "+this.apiKey,Accept:"application/json"},timeout:15e3}),e.ajax({url:r+"/ai-reports",method:"GET",headers:{Authorization:"Bearer "+this.apiKey,Accept:"application/json"},timeout:15e3})).then((function(e,a){var r=[];(e[0].reports||e[0].data||[]).forEach((function(e){e.source="wizard",e.displayName=e.name||e.title||e.display_name||e.slug,e.categoryName=e.category_info?e.category_info.name:"General",r.push(e)})),(a[0].reports||a[0].data||[]).forEach((function(e){e.source="ai",e.displayName=e.name||e.title||e.display_name||e.slug,e.categoryName=e.category_info?e.category_info.name:"AI Generated",r.push(e)})),r.sort((function(e,t){return e.displayName.localeCompare(t.displayName)})),t.reports=r,t.filteredReports=t.getAvailableReports(),t.container.find(".report-search-loading").hide(),t.renderSelectedList()})).fail((function(){t.container.find(".report-search-loading").hide(),a.addNotification({message:"Failed to load reports",type:"error"})}))},getAvailableReports:function(){var e=this;return this.reports.filter((function(t){return!e.selectedReports.some((function(e){return e.slug===t.slug&&e.source===t.source}))}))},filterReports:function(e){var t=this.getAvailableReports();if(!e||e.length<1)return t;var a=(e=e.toLowerCase().trim()).split(/\s+/);return t.filter((function(e){var t=(e.displayName+" "+e.categoryName+" "+e.source+" "+(e.slug||"")).toLowerCase();return a.every((function(e){return-1!==t.indexOf(e)}))})).slice(0,50)},renderSearchResults:function(t){var a=this,r=this.container.find(".report-search-results"),i=this.container.find(".report-search-empty");if(r.empty(),0!==this.filteredReports.length){i.hide();var n={};this.filteredReports.forEach((function(e){var t=e.categoryName||"Other";n[t]||(n[t]=[]),n[t].push(e)}));var s=0;Object.keys(n).sort().forEach((function(e){r.append('<div class="report-search-category px-3 py-1 bg-light border-bottom"><small class="text-muted font-weight-bold">'+a.escapeHtml(e)+"</small></div>"),n[e].forEach((function(e){var i=a.highlightMatch(e.displayName,t),n="ai"===e.source?'<span class="badge badge-info ml-2">AI</span>':'<span class="badge badge-primary ml-2">Wizard</span>',o='<div class="report-search-item px-3 py-2 cursor-pointer" data-index="'+s+'" data-slug="'+e.slug+'" data-source="'+e.source+'" role="option" tabindex="-1"><div class="d-flex justify-content-between align-items-center"><span class="report-name">'+i+"</span>"+n+"</div></div>";r.append(o),s++}))})),r.find(".report-search-item").css("cursor","pointer").hover((function(){e(this).addClass("bg-light"),a.highlightedIndex=parseInt(e(this).data("index"),10),a.updateHighlight()}),(function(){e(this).removeClass("bg-light")}))}else i.show()},highlightMatch:function(e,t){if(!t||!e)return this.escapeHtml(e);var a=this.escapeHtml(e);return t.toLowerCase().trim().split(/\s+/).forEach((function(e){if(e.length>0){var t=new RegExp("("+e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+")","gi");a=a.replace(t,'<mark class="bg-warning px-0">$1</mark>')}})),a},updateHighlight:function(){var e=this.container.find(".report-search-item");if(e.removeClass("bg-primary text-white bg-light"),this.highlightedIndex>=0&&this.highlightedIndex<e.length){var t=e.eq(this.highlightedIndex);t.removeClass("bg-light").addClass("bg-primary text-white");var a=this.container.find(".report-search-dropdown"),r=t.position().top,i=t.outerHeight(),n=a.height(),s=a.scrollTop();r<0?a.scrollTop(s+r):r+i>n&&a.scrollTop(s+r+i-n)}},openDropdown:function(){if(!this.isDropdownOpen){this.isDropdownOpen=!0,this.highlightedIndex=-1;var e=this.container.find(".report-search-dropdown"),t=this.container.find(".report-search-input");e.show(),t.attr("aria-expanded","true");var a=t.val();this.filteredReports=this.filterReports(a),this.renderSearchResults(a)}},closeDropdown:function(){if(this.isDropdownOpen){this.isDropdownOpen=!1,this.highlightedIndex=-1;var e=this.container.find(".report-search-dropdown"),t=this.container.find(".report-search-input");e.hide(),t.attr("aria-expanded","false")}},handleSearch:function(e){var t=this;this.searchTimeout&&clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout((function(){t.filteredReports=t.filterReports(e),t.renderSearchResults(e),t.highlightedIndex=-1}),150)},selectHighlightedItem:function(){if(!(this.highlightedIndex<0||this.highlightedIndex>=this.filteredReports.length)){var e=this.filteredReports[this.highlightedIndex];this.addReport(e)}},addReport:function(e){var t=i[this.selectedReports.length%i.length],a={slug:e.slug,source:e.source,name:e.displayName||e.name||e.title||e.slug};"kpi"===this.mode&&(a.icon=t),this.selectedReports.push(a),this.saveSelection(),this.updateSelectedCount(),this.filteredReports=this.getAvailableReports(),this.container.find(".report-search-input").val(""),this.closeDropdown(),this.renderSelectedList()},renderSelectedList:function(){var e=this,t=this.container.find(".report-selector-list");t.empty(),this.selectedReports.forEach((function(a,r){var n=e.reports.find((function(e){return e.slug===a.slug&&e.source===a.source})),s=a.name||(n?n.displayName:a.slug),o=n?n.categoryName:"Unknown",l="";if("kpi"===e.mode){var c=a.icon||i[r%i.length];l=e.buildIconPicker(c,r)}var d='<li class="list-group-item d-flex justify-content-between align-items-center" data-index="'+r+'" data-slug="'+a.slug+'" data-source="'+a.source+'"><div class="d-flex align-items-center flex-grow-1 min-width-0"><span class="drag-handle mr-2" style="cursor: move;"><i class="fa fa-bars text-muted"></i></span>'+l+'<span class="badge badge-secondary mr-2">'+(r+1)+'</span><span class="text-truncate" title="'+e.escapeHtml(s)+'">'+e.escapeHtml(s)+'</span><small class="text-muted ml-2 d-none d-md-inline">['+e.escapeHtml(o)+']</small><span class="badge badge-'+("ai"===a.source?"info":"primary")+' ml-2">'+a.source.toUpperCase()+'</span></div><button type="button" class="btn btn-sm btn-outline-danger report-selector-remove ml-2" title="'+e.strings.removereport+'"><i class="fa fa-times"></i></button></li>';t.append(d)})),this.updateListDisplay(),this.initSortable(),this.initIconPickers()},buildIconPicker:function(e,t){var a='<div class="dropdown kpi-icon-picker mr-2" data-index="'+t+'"><button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" title="Select icon"><i class="fa '+e+'"></i></button><div class="dropdown-menu kpi-icon-dropdown"><div class="px-2 py-1"><small class="text-muted">Select an icon</small></div><div class="dropdown-divider"></div><div class="kpi-icon-grid px-2">',i={};return r.forEach((function(e){i[e.category]||(i[e.category]=[]),i[e.category].push(e)})),Object.keys(i).forEach((function(t){a+='<div class="kpi-icon-category mb-1"><small class="text-muted d-block mb-1">'+t+'</small><div class="d-flex flex-wrap">',i[t].forEach((function(t){var r=t.id===e?" active":"";a+='<button type="button" class="btn btn-sm btn-light kpi-icon-option m-1'+r+'" data-icon="'+t.id+'" title="'+t.label+'"><i class="fa '+t.id+'"></i></button>'})),a+="</div></div>"})),a+="</div></div></div>"},initIconPickers:function(){var t=this;this.container.find(".kpi-icon-picker .dropdown-toggle").off("click.iconpicker").on("click.iconpicker",(function(a){a.preventDefault(),a.stopPropagation();var r=e(this),i=r.closest(".kpi-icon-picker"),n=i.find(".dropdown-menu"),s=n.hasClass("show");if(t.container.find(".kpi-icon-picker .dropdown-menu.show").removeClass("show"),t.container.find(".kpi-icon-picker .dropdown-toggle").attr("aria-expanded","false"),!s){var o=i[0].getBoundingClientRect();window.innerHeight-o.bottom<320?i.addClass("dropup"):i.removeClass("dropup"),n.addClass("show"),r.attr("aria-expanded","true")}})),this.container.find(".kpi-icon-option").off("click.iconpicker").on("click.iconpicker",(function(a){a.preventDefault(),a.stopPropagation();var r=e(this),i=r.closest(".kpi-icon-picker"),n=parseInt(i.data("index"),10),s=r.data("icon");t.selectedReports[n]&&(t.selectedReports[n].icon=s,t.saveSelection(),i.find(".dropdown-toggle i").removeClass().addClass("fa "+s),i.find(".kpi-icon-option").removeClass("active"),r.addClass("active"),i.find(".dropdown-menu").removeClass("show"),i.find(".dropdown-toggle").attr("aria-expanded","false"))})),e(document).off("click.iconpicker-close").on("click.iconpicker-close",(function(a){e(a.target).closest(".kpi-icon-picker").length||(t.container.find(".kpi-icon-picker .dropdown-menu.show").removeClass("show"),t.container.find(".kpi-icon-picker .dropdown-toggle").attr("aria-expanded","false"))}))},updateListDisplay:function(){var e=this.container.find(".report-selector-list"),t=this.container.find(".report-selector-empty");this.selectedReports.length>0?(e.show(),t.hide()):(e.hide(),t.show())},updateSelectedCount:function(){var e=this.selectedReports.length,t=1===e?"1 selected":e+" selected";this.container.find(".report-count").text(t)},initSortable:function(){var t=this,a=this.container.find(".report-selector-list");e.fn.sortable?a.sortable({handle:".drag-handle",update:function(){t.updateOrderFromDOM()}}):this.initManualSort()},initManualSort:function(){var t=this,a=this.container.find(".report-selector-list"),r=null;a.on("dragstart","li",(function(t){r=this,e(this).addClass("dragging opacity-50"),t.originalEvent.dataTransfer.effectAllowed="move"})),a.on("dragend","li",(function(){e(this).removeClass("dragging opacity-50"),t.updateOrderFromDOM()})),a.on("dragover","li",(function(t){t.preventDefault();var a=this.getBoundingClientRect(),i=a.top+a.height/2;t.originalEvent.clientY<i?e(this).before(r):e(this).after(r)})),a.find("li").attr("draggable","true")},updateOrderFromDOM:function(){var t=this,a=[];this.container.find(".report-selector-list li").each((function(){var r=e(this).data("slug"),i=e(this).data("source"),n=t.selectedReports.find((function(e){return e.slug===r&&e.source===i}));n&&a.push(n)})),this.selectedReports=a,this.saveSelection(),this.renderSelectedList()},bindEvents:function(){var t=this,a=this.container.find(".report-search-input"),r=this.container.find(".report-search-dropdown");a.on("focus",(function(){t.openDropdown()})),a.on("input",(function(){var a=e(this).val();t.openDropdown(),t.handleSearch(a)})),a.on("keydown",(function(e){var r=t.container.find(".report-search-item").length-1;switch(e.keyCode){case 40:e.preventDefault(),t.isDropdownOpen||t.openDropdown(),t.highlightedIndex=Math.min(t.highlightedIndex+1,r),t.updateHighlight();break;case 38:e.preventDefault(),t.highlightedIndex=Math.max(t.highlightedIndex-1,0),t.updateHighlight();break;case 13:e.preventDefault(),t.highlightedIndex>=0&&t.selectHighlightedItem();break;case 27:e.preventDefault(),t.closeDropdown(),a.blur();break;case 9:t.closeDropdown()}})),r.on("click",".report-search-item",(function(){var a=e(this).data("slug"),r=e(this).data("source"),i=t.reports.find((function(e){return e.slug===a&&e.source===r}));i&&t.addReport(i)})),e(document).on("click",(function(a){e(a.target).closest(t.container).length||t.closeDropdown()})),this.container.on("click",".report-selector-remove",(function(a){a.stopPropagation();var r=e(this).closest("li"),i=r.data("slug"),n=r.data("source");t.removeReport(i,n)}))},removeReport:function(e,t){if(this.selectedReports=this.selectedReports.filter((function(a){return!(a.slug===e&&a.source===t)})),this.saveSelection(),this.updateSelectedCount(),this.filteredReports=this.getAvailableReports(),this.renderSelectedList(),this.isDropdownOpen){var a=this.container.find(".report-search-input").val();this.filteredReports=this.filterReports(a),this.renderSearchResults(a)}},saveSelection:function(){this.textarea.val(JSON.stringify(this.selectedReports)).trigger("change")},escapeHtml:function(e){if(!e)return"";var t=document.createElement("div");return t.textContent=e,t.innerHTML}};var s=function(e){this.apiKey=e.apiKey||"",this.container=null,this.textarea=null,this.alerts=[],this.reports=[],this.filteredReports=[],this.operators={},this.intervals={},this.cooldowns={},this.roles={},this.editingIndex=-1,this.isDropdownOpen=!1,this.isUserDropdownOpen=!1,this.searchTimeout=null,this.userSearchTimeout=null,this.selectedUsers=[],this.strings={},this.init()};s.prototype={init:function(){var t=this;this.container=e("#alerts-manager-container"),this.textarea=e("#id_config_alerts_json"),this.container.length&&this.loadStrings().then((function(){t.operators=JSON.parse(t.container.attr("data-operators")||"{}"),t.intervals=JSON.parse(t.container.attr("data-intervals")||"{}"),t.cooldowns=JSON.parse(t.container.attr("data-cooldowns")||"{}"),t.roles=JSON.parse(t.container.attr("data-roles")||"{}");var e=JSON.parse(t.container.attr("data-existing-alerts")||"[]");t.alerts=e,e.length>0&&t.cleanupOrphanedAlerts(),t.populateSelectOptions(),t.fetchReports(),t.bindEvents(),t.renderAlertsList(),t.saveToTextarea(),t.handleAlertsEnabledToggle()}))},loadStrings:function(){var e=this;return t.get_strings([{key:"edit_alert",component:"block_adeptus_insights"},{key:"delete_alert",component:"block_adeptus_insights"},{key:"alert_delete_confirm",component:"block_adeptus_insights"},{key:"add_new_alert",component:"block_adeptus_insights"},{key:"alert_disabled",component:"block_adeptus_insights"},{key:"config_add_alert",component:"block_adeptus_insights"}]).then((function(t){e.strings={editAlert:t[0],deleteAlert:t[1],deleteConfirm:t[2],addNewAlert:t[3],disabled:t[4],addAlert:t[5]}}))},populateSelectOptions:function(){var t=e("#alert-edit-operator");t.empty(),e.each(this.operators,(function(a,r){t.append(e("<option>",{value:a,text:r}))}));var a=e("#alert-edit-interval");a.empty(),e.each(this.intervals,(function(t,r){a.append(e("<option>",{value:t,text:r}))}));var r=e("#alert-edit-cooldown");r.empty(),e.each(this.cooldowns,(function(t,a){r.append(e("<option>",{value:t,text:a}))}));var i=e("#alert-edit-role-filter");i.length?(i.find("option:not(:first)").remove(),e.each(this.roles,(function(t,a){i.append(e("<option>",{value:t,text:a}))}))):console.warn("Role filter element not found during init, will populate on panel open")},fetchReports:function(){var t=[],a=e('[name="config_kpi_selected_reports"]');if(a.length&&a.val())try{var r=JSON.parse(a.val());Array.isArray(r)&&r.forEach((function(e){e.displayName=e.name||e.title||e.display_name||e.slug,e.categoryName=e.category_info?e.category_info.name:"ai"===e.source?"AI Generated":"General",t.push(e)}))}catch(e){}var i=e('[name="config_tabs_selected_reports"]');if(i.length&&i.val())try{var n=JSON.parse(i.val());Array.isArray(n)&&n.forEach((function(e){t.some((function(t){return t.slug===e.slug}))||(e.displayName=e.name||e.title||e.display_name||e.slug,e.categoryName=e.category_info?e.category_info.name:"ai"===e.source?"AI Generated":"General",t.push(e))}))}catch(e){}t.sort((function(e,t){return(e.displayName||"").localeCompare(t.displayName||"")})),this.reports=t,this.filteredReports=t,0===t.length&&(this.container.find(".alert-report-empty-message").remove(),this.container.find(".alerts-edit-panel").prepend('<div class="alert alert-info alert-report-empty-message"><i class="fa fa-info-circle"></i> No reports configured in this block. Add reports in the KPI or Tabs settings first.</div>'))},handleAlertsEnabledToggle:function(){var t=this,a=e('[name="config_alerts_enabled"]'),r=e('[name="config_display_mode"]'),i=function(){var e=a.is(":checked"),i="kpi"===r.val();e&&i?t.container.show():t.container.hide()};a.on("change",i),r.on("change",i),i()},bindEvents:function(){var t=this;e('[name="config_kpi_selected_reports"], [name="config_tabs_selected_reports"]').on("change",(function(){t.fetchReports()})),this.container.on("click","#add-alert-btn",(function(){t.openEditPanel(-1)})),this.container.on("click",".alert-edit-btn",(function(){var a=e(this).closest(".alert-item").data("index");t.openEditPanel(a)})),this.container.on("click",".alert-delete-btn",(function(){var a=e(this).closest(".alert-item").data("index");confirm(t.strings.deleteConfirm)&&t.deleteAlert(a)})),this.container.on("change",".alert-enabled-toggle",(function(){var a=e(this).closest(".alert-item").data("index");t.alerts[a].enabled=e(this).is(":checked"),t.saveToTextarea(),t.renderAlertsList()})),this.container.on("click",".alert-panel-close, .alert-panel-cancel",(function(){t.closeEditPanel()})),this.container.on("click",".alert-panel-save",(function(){t.saveEditPanel()})),e("#alert-edit-notify-email").on("change",(function(){e(this).is(":checked")?e("#email-addresses-group").show():e("#email-addresses-group").hide()}));var a=e("#alert-edit-report-search"),r=e("#alert-report-dropdown");a.on("focus",(function(){t.openReportDropdown()})),a.on("input",(function(){var a=e(this).val();t.handleReportSearch(a)})),a.on("keydown",(function(e){27===e.keyCode&&t.closeReportDropdown()})),r.on("click",".report-dropdown-item",(function(){var a=e(this).data("slug"),r=e(this).data("name");t.selectReport(a,r)})),e(document).on("click",(function(a){e(a.target).closest("#alert-edit-report-search, #alert-report-dropdown").length||t.closeReportDropdown(),e(a.target).closest("#alert-edit-user-search, #alert-user-dropdown").length||t.closeUserDropdown()})),e("#alert-edit-role-filter").on("change",(function(){e("#alert-edit-user-search").val(""),t.loadUsers()}));var i=e("#alert-edit-user-search"),n=e("#alert-user-dropdown");i.on("focus",(function(){t.openUserDropdown()})),i.on("input",(function(){var a=e(this).val();t.handleUserSearch(a)})),i.on("keydown",(function(e){27===e.keyCode&&t.closeUserDropdown()})),n.on("click",".user-dropdown-item",(function(){var a=e(this).data("userid"),r=e(this).data("name"),i=e(this).data("email");t.addSelectedUser(a,r,i)})),this.container.on("click",".remove-selected-user",(function(){var a=e(this).data("userid");t.removeSelectedUser(a)}))},renderAlertsList:function(){var t=this,a=e("#alerts-list"),r=a.find(".alerts-empty");a.find(".alert-item").remove(),0===this.alerts.length?r.show():(r.hide(),this.alerts.forEach((function(e,r){var i=e.report_name||e.report_slug,n=e.alert_name||i,s=t.operators[e.operator]||e.operator,o=[];null!==e.warning_value&&""!==e.warning_value&&o.push("Warning: "+e.warning_value),null!==e.critical_value&&""!==e.critical_value&&o.push("Critical: "+e.critical_value);var l=o.join(", ")||"No thresholds set",c=t.intervals[e.check_interval]||e.check_interval+"s",d="";"warning"===e.current_status?d='<span class="badge badge-warning ml-2">Warning</span>':"critical"===e.current_status?d='<span class="badge badge-danger ml-2">Critical</span>':e.current_status&&(d='<span class="badge badge-success ml-2">OK</span>');var p='<div class="alert-item card mb-2" data-index="'+r+'"><div class="card-body py-2 px-3"><div class="d-flex justify-content-between align-items-start"><div class="flex-grow-1"><div class="d-flex align-items-center mb-1"><strong>'+t.escapeHtml(n)+"</strong>"+d+(e.enabled?"":'<span class="badge badge-secondary ml-2">'+t.strings.disabled+"</span>")+'</div><small class="text-muted d-block">'+t.escapeHtml(i)+'</small><small class="text-muted d-block">'+t.escapeHtml(s)+" | "+l+" | "+c+'</small></div><div class="alert-actions d-flex align-items-center"><div class="custom-control custom-switch mr-2"><input type="checkbox" class="custom-control-input alert-enabled-toggle" id="alert-enabled-'+r+'"'+(e.enabled?" checked":"")+'><label class="custom-control-label" for="alert-enabled-'+r+'"></label></div><button type="button" class="btn btn-sm btn-outline-primary alert-edit-btn mr-1" title="'+t.strings.editAlert+'"><i class="fa fa-pencil"></i></button><button type="button" class="btn btn-sm btn-outline-danger alert-delete-btn" title="'+t.strings.deleteAlert+'"><i class="fa fa-trash"></i></button></div></div></div></div>';a.append(p)}))),this.container.find(".alerts-count").text(this.alerts.length)},openEditPanel:function(t){var a=e("#alert-edit-panel");this.editingIndex=t;var r=e("#alert-edit-role-filter");if(r.length&&r.find("option").length<=1&&e.each(this.roles,(function(t,a){r.append(e("<option>",{value:t,text:a}))})),e("#alert-edit-report").val(""),e("#alert-edit-report-search").val(""),e("#alert-edit-report-display").text(""),e("#alert-edit-name").val(""),e("#alert-edit-operator").val("gt"),e("#alert-edit-warning").val(""),e("#alert-edit-critical").val(""),e("#alert-edit-interval").val("3600"),e("#alert-edit-cooldown").val("3600"),e("#alert-edit-notify-warning").prop("checked",!0),e("#alert-edit-notify-critical").prop("checked",!0),e("#alert-edit-notify-recovery").prop("checked",!0),e("#alert-edit-notify-email").prop("checked",!1),e("#alert-edit-email-addresses").val(""),e("#email-addresses-group").hide(),e("#alert-edit-role-filter").val(""),this.selectedUsers=[],this.renderSelectedUsers(),t>=0&&this.alerts[t]){var i=this.alerts[t];e("#alert-edit-report").val(i.report_slug),e("#alert-edit-report-search").val(i.report_name||i.report_slug),e("#alert-edit-report-display").text("Selected: "+(i.report_name||i.report_slug)),e("#alert-edit-name").val(i.alert_name||""),e("#alert-edit-operator").val(i.operator||"gt"),e("#alert-edit-warning").val(i.warning_value||""),e("#alert-edit-critical").val(i.critical_value||""),e("#alert-edit-interval").val(i.check_interval||3600),e("#alert-edit-cooldown").val(i.cooldown_seconds||3600),e("#alert-edit-notify-warning").prop("checked",!1!==i.notify_on_warning),e("#alert-edit-notify-critical").prop("checked",!1!==i.notify_on_critical),e("#alert-edit-notify-recovery").prop("checked",!1!==i.notify_on_recovery),e("#alert-edit-notify-email").prop("checked",!!i.notify_email),e("#alert-edit-email-addresses").val(i.notify_emails||""),i.notify_email&&e("#email-addresses-group").show(),this.selectedUsers=i.notify_users||[],this.renderSelectedUsers(),a.find(".alert-panel-title").text(this.strings.editAlert)}else a.find(".alert-panel-title").text(this.strings.addNewAlert);a.show()},closeEditPanel:function(){e("#alert-edit-panel").hide(),this.editingIndex=-1},getReportEndpoint:function(e){var t=this.reports.find((function(t){return t.slug===e}));return t&&"ai"===t.source?"/ai-reports/":"/wizard-reports/"},saveEditPanel:function(){var t=e("#alert-edit-report").val(),r=e("#alert-edit-report-search").val(),i=e("#alert-edit-warning").val()||e("#alert-edit-critical").val(),n=e("#alert-edit-operator").val();if(t)if(i){var s="threshold",o=n;"change_pct"===n||"increase_pct"===n?(s="change_percent",o="gte"):"decrease_pct"===n&&(s="change_percent",o="lte",i=-Math.abs(parseFloat(i)));var l=e("#alert-edit-notify-email").is(":checked"),c={name:e("#alert-edit-name").val()||r,condition_type:s,operator:o,value:parseFloat(i)||0,cooldown_minutes:0,is_enabled:!0,notification_channels:l?["email"]:["moodle"]},d={report_slug:t,report_name:r,alert_name:c.name,operator:n,condition_type:s,threshold_value:parseFloat(i),warning_value:e("#alert-edit-warning").val()?parseFloat(e("#alert-edit-warning").val()):null,critical_value:e("#alert-edit-critical").val()?parseFloat(e("#alert-edit-critical").val()):null,check_interval:parseInt(e("#alert-edit-interval").val(),10),cooldown_seconds:parseInt(e("#alert-edit-cooldown").val(),10),notify_on_warning:e("#alert-edit-notify-warning").is(":checked"),notify_on_critical:e("#alert-edit-notify-critical").is(":checked"),notify_on_recovery:e("#alert-edit-notify-recovery").is(":checked"),notify_email:e("#alert-edit-notify-email").is(":checked"),notify_emails:e("#alert-edit-email-addresses").val().trim(),notify_users:this.selectedUsers,enabled:!0};if(this.editingIndex>=0&&this.alerts[this.editingIndex]&&this.alerts[this.editingIndex].backend_id){var p=this.alerts[this.editingIndex].backend_id;this.updateAlertOnBackend(t,p,c,d)}else this.createAlertOnBackend(t,c,d)}else a.addNotification({message:"Please enter a threshold value.",type:"error"});else a.addNotification({message:"Please select a report to monitor.",type:"error"})},createAlertOnBackend:function(t,r,i){var n=this,s=this.getReportEndpoint(t);e.ajax({url:"https://backend.adeptus360.com/api/v1"+s+encodeURIComponent(t)+"/alerts",method:"POST",headers:{Authorization:"Bearer "+this.apiKey,"Content-Type":"application/json",Accept:"application/json"},data:JSON.stringify(r),timeout:15e3}).done((function(e){e.success&&e.alert?(i.backend_id=e.alert.id,i.current_status="ok",n.editingIndex>=0?n.alerts[n.editingIndex]=i:n.alerts.push(i),n.saveToTextarea(),n.renderAlertsList(),n.closeEditPanel(),a.addNotification({message:"Alert created successfully.",type:"success"})):a.addNotification({message:e.message||"Failed to create alert.",type:"error"})})).fail((function(e){var t="Failed to create alert.";if(e.responseJSON&&(e.responseJSON.message&&(t=e.responseJSON.message),e.responseJSON.errors)){var r=e.responseJSON.errors,i=[];for(var n in r)r.hasOwnProperty(n)&&i.push(n+": "+r[n].join(", "));i.length>0&&(t+=" - "+i.join("; "))}console.error("Alert creation failed:",e.responseJSON),a.addNotification({message:t,type:"error"})}))},updateAlertOnBackend:function(t,r,i,n){var s=this,o=this.getReportEndpoint(t);e.ajax({url:"https://backend.adeptus360.com/api/v1"+o+encodeURIComponent(t)+"/alerts/"+r,method:"PUT",headers:{Authorization:"Bearer "+this.apiKey,"Content-Type":"application/json",Accept:"application/json"},data:JSON.stringify(i),timeout:15e3}).done((function(e){e.success?(n.backend_id=r,n.current_status=s.alerts[s.editingIndex].current_status,n.enabled=s.alerts[s.editingIndex].enabled,s.alerts[s.editingIndex]=n,s.saveToTextarea(),s.renderAlertsList(),s.closeEditPanel(),a.addNotification({message:"Alert updated successfully.",type:"success"})):a.addNotification({message:e.message||"Failed to update alert.",type:"error"})})).fail((function(e){var t="Failed to update alert.";e.responseJSON&&e.responseJSON.message&&(t=e.responseJSON.message),a.addNotification({message:t,type:"error"})}))},deleteAlert:function(t){var r=this,i=this.alerts[t];if(i)if(i.backend_id&&i.report_slug){var n=this.getReportEndpoint(i.report_slug);e.ajax({url:"https://backend.adeptus360.com/api/v1"+n+encodeURIComponent(i.report_slug)+"/alerts/"+i.backend_id,method:"DELETE",headers:{Authorization:"Bearer "+this.apiKey,Accept:"application/json"},timeout:15e3}).done((function(e){r.alerts.splice(t,1),r.saveToTextarea(),r.renderAlertsList(),a.addNotification({message:"Alert deleted successfully.",type:"success"})})).fail((function(e){var t="Failed to delete alert from server.";e.responseJSON&&e.responseJSON.message&&(t=e.responseJSON.message),a.addNotification({message:t,type:"error"})}))}else this.alerts.splice(t,1),this.saveToTextarea(),this.renderAlertsList()},cleanupOrphanedAlerts:function(){var t=this,a={},r={};this.alerts.forEach((function(e){e.report_slug&&(a[e.report_slug]=!0,e.backend_id&&(r[e.report_slug]||(r[e.report_slug]=[]),r[e.report_slug].push(e.backend_id)))})),Object.keys(a).forEach((function(a){var i=t.getReportEndpoint(a),n=r[a]||[];e.ajax({url:"https://backend.adeptus360.com/api/v1"+i+encodeURIComponent(a)+"/alerts",method:"GET",headers:{Authorization:"Bearer "+t.apiKey,Accept:"application/json"},timeout:1e4}).done((function(e){e.success&&e.alerts&&e.alerts.forEach((function(e){-1===n.indexOf(e.id)&&t.deleteOrphanedAlert(a,e.id)}))})).fail((function(){console.warn("Failed to fetch backend alerts for orphan cleanup:",a)}))}))},deleteOrphanedAlert:function(t,a){var r=this.getReportEndpoint(t);e.ajax({url:"https://backend.adeptus360.com/api/v1"+r+encodeURIComponent(t)+"/alerts/"+a,method:"DELETE",headers:{Authorization:"Bearer "+this.apiKey,Accept:"application/json"},timeout:1e4}).done((function(){console.log("Cleaned up orphaned backend alert:",a,"for report:",t)})).fail((function(){console.warn("Failed to delete orphaned alert:",a,"for report:",t)}))},saveToTextarea:function(){this.textarea.val(JSON.stringify(this.alerts))},openReportDropdown:function(){if(!this.isDropdownOpen){this.isDropdownOpen=!0;var t=e("#alert-report-dropdown"),a=e("#alert-edit-report-search");t.css("width",a.outerWidth()+"px"),t.show(),this.filteredReports=this.reports,this.renderReportDropdown("")}},closeReportDropdown:function(){this.isDropdownOpen=!1,e("#alert-report-dropdown").hide()},handleReportSearch:function(e){var t=this;this.searchTimeout&&clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout((function(){t.filteredReports=t.filterReports(e),t.renderReportDropdown(e)}),150)},filterReports:function(e){if(!e||e.length<1)return this.reports;var t=(e=e.toLowerCase().trim()).split(/\s+/);return this.reports.filter((function(e){var a=(e.displayName+" "+e.categoryName+" "+e.source+" "+(e.slug||"")).toLowerCase();return t.every((function(e){return-1!==a.indexOf(e)}))})).slice(0,30)},renderReportDropdown:function(t){var a=this,r=e("#alert-report-dropdown");if(r.empty(),0!==this.filteredReports.length){var i={};this.filteredReports.forEach((function(e){var t=e.categoryName||"Other";i[t]||(i[t]=[]),i[t].push(e)})),Object.keys(i).sort().forEach((function(e){r.append('<div class="px-3 py-1 bg-light border-bottom"><small class="text-muted font-weight-bold">'+a.escapeHtml(e)+"</small></div>"),i[e].forEach((function(e){var t="ai"===e.source?'<span class="badge badge-info ml-2">AI</span>':'<span class="badge badge-primary ml-2">Wizard</span>';r.append('<div class="report-dropdown-item px-3 py-2" style="cursor:pointer;" data-slug="'+e.slug+'" data-name="'+a.escapeHtml(e.displayName)+'"><span>'+a.escapeHtml(e.displayName)+"</span>"+t+"</div>")}))})),r.find(".report-dropdown-item").hover((function(){e(this).addClass("bg-light")}),(function(){e(this).removeClass("bg-light")}))}else r.append('<div class="p-3 text-muted text-center">No matching reports found</div>')},selectReport:function(t,a){e("#alert-edit-report").val(t),e("#alert-edit-report-search").val(a),e("#alert-edit-report-display").text("Selected: "+a),this.closeReportDropdown()},openUserDropdown:function(){this.isUserDropdownOpen||(this.isUserDropdownOpen=!0,e("#alert-user-dropdown").show(),this.loadUsers())},closeUserDropdown:function(){this.isUserDropdownOpen=!1,e("#alert-user-dropdown").hide()},loadUsers:function(){var t=this,a=e("#alert-edit-role-filter").val()||0,r=e("#alert-edit-user-search").val()||"",i=e("#alert-user-dropdown");i.html('<div class="p-3 text-center text-muted"><i class="fa fa-spinner fa-spin"></i> Loading...</div>'),require(["core/ajax"],(function(e){e.call([{methodname:"block_adeptus_insights_get_users_by_role",args:{roleid:parseInt(a,10),search:r,limit:50}}])[0].done((function(e){t.renderUserDropdown(e.users)})).fail((function(){i.html('<div class="p-3 text-center text-danger">Failed to load users</div>')}))}))},handleUserSearch:function(e){var t=this;this.userSearchTimeout&&clearTimeout(this.userSearchTimeout),this.userSearchTimeout=setTimeout((function(){t.loadUsers()}),300)},renderUserDropdown:function(t){var a=this,r=e("#alert-user-dropdown");r.empty(),0!==t.length?(t.forEach((function(e){if(!a.selectedUsers.some((function(t){return t.id===e.id}))){var t='<div class="user-dropdown-item px-3 py-2 d-flex align-items-center" style="cursor:pointer;" data-userid="'+e.id+'" data-name="'+a.escapeHtml(e.fullname)+'" data-email="'+a.escapeHtml(e.email)+'"><img src="'+e.profileimageurl+'" class="rounded-circle mr-2" width="32" height="32" alt=""><div class="flex-grow-1 min-width-0"><div class="text-truncate font-weight-bold">'+a.escapeHtml(e.fullname)+'</div><small class="text-muted text-truncate d-block">'+a.escapeHtml(e.email)+"</small></div></div>";r.append(t)}})),0===r.children().length&&r.html('<div class="p-3 text-center text-muted">All matching users already selected</div>'),r.find(".user-dropdown-item").hover((function(){e(this).addClass("bg-light")}),(function(){e(this).removeClass("bg-light")}))):r.html('<div class="p-3 text-center text-muted">No users found</div>')},addSelectedUser:function(t,a,r){this.selectedUsers.some((function(e){return e.id===t}))||(this.selectedUsers.push({id:t,name:a,email:r}),this.renderSelectedUsers(),this.closeUserDropdown(),e("#alert-edit-user-search").val(""))},removeSelectedUser:function(e){this.selectedUsers=this.selectedUsers.filter((function(t){return t.id!==e})),this.renderSelectedUsers()},renderSelectedUsers:function(){var t=this,a=e("#alert-selected-users");a.empty(),0!==this.selectedUsers.length?(this.selectedUsers.forEach((function(e){var r='<div class="selected-user-chip d-inline-flex align-items-center bg-light border rounded px-2 py-1 mr-2 mb-2"><span class="mr-2">'+t.escapeHtml(e.name)+'</span><button type="button" class="btn btn-sm btn-link p-0 text-danger remove-selected-user" data-userid="'+e.id+'" title="Remove"><i class="fa fa-times"></i></button></div>';a.append(r)})),e("#alert-edit-notify-users-data").val(JSON.stringify(this.selectedUsers))):a.html('<div class="text-muted small py-2"><i class="fa fa-user-o mr-1"></i> No recipients selected</div>')},escapeHtml:function(e){if(!e)return"";var t=document.createElement("div");return t.textContent=e,t.innerHTML}};var o=!1;return{init:function(t){if(!o){o=!0;var a={kpi:!1,tabs:!1,alerts:!1},r=function(){!a.kpi&&e("#kpi-report-selector-container").length&&(new n({mode:"kpi",apiKey:t.apiKey,containerId:"kpi-report-selector-container",textareaName:"config_kpi_selected_reports"}),a.kpi=!0),!a.tabs&&e("#tabs-report-selector-container").length&&(new n({mode:"tabs",apiKey:t.apiKey,containerId:"tabs-report-selector-container",textareaName:"config_tabs_selected_reports"}),a.tabs=!0),!a.alerts&&e("#alerts-manager-container").length&&(new s({apiKey:t.apiKey}),a.alerts=!0);var r=e('[name="config_display_mode"]'),i=e("#alerts-kpi-only-notice");if(r.length&&i.length&&!r.data("alerts-notice-bound")){var o=function(){"kpi"===r.val()?i.hide():i.show()};r.on("change",o),setTimeout(o,50),r.data("alerts-notice-bound",!0)}};r();var i=new MutationObserver((function(){r(),a.kpi&&a.tabs&&a.alerts&&i.disconnect()}));i.observe(document.body,{childList:!0,subtree:!0}),e(document).on("modal-shown",(function(){setTimeout(r,100)}))}}}}));
//# sourceMappingURL=edit_form.min.js.map