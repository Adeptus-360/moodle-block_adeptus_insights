define(["jquery","core/str","core/notification"],function(s,e,r){"use strict";function t(e){this.mode=e.mode||"kpi",this.apiKey=e.apiKey||"",this.containerId=e.containerId,this.textareaName=e.textareaName,this.container=null,this.textarea=null,this.reports=[],this.filteredReports=[],this.selectedReports=[],this.strings={},this.searchTimeout=null,this.highlightedIndex=-1,this.isDropdownOpen=!1,this.init()}function a(e){this.apiKey=e.apiKey||"",this.container=null,this.textarea=null,this.alerts=[],this.reports=[],this.filteredReports=[],this.operators={},this.intervals={},this.cooldowns={},this.roles={},this.editingIndex=-1,this.isDropdownOpen=!1,this.searchTimeout=null,this.strings={},this.init()}var n=[{id:"fa-users",label:"Users",category:"People"},{id:"fa-user",label:"User",category:"People"},{id:"fa-user-plus",label:"New User",category:"People"},{id:"fa-graduation-cap",label:"Education",category:"Education"},{id:"fa-book",label:"Book",category:"Education"},{id:"fa-certificate",label:"Certificate",category:"Education"},{id:"fa-clock-o",label:"Time",category:"Time"},{id:"fa-calendar",label:"Calendar",category:"Time"},{id:"fa-hourglass-half",label:"Hourglass",category:"Time"},{id:"fa-check-circle",label:"Complete",category:"Status"},{id:"fa-check",label:"Check",category:"Status"},{id:"fa-trophy",label:"Trophy",category:"Status"},{id:"fa-star",label:"Star",category:"Status"},{id:"fa-bar-chart",label:"Bar Chart",category:"Analytics"},{id:"fa-line-chart",label:"Line Chart",category:"Analytics"},{id:"fa-pie-chart",label:"Pie Chart",category:"Analytics"},{id:"fa-area-chart",label:"Area Chart",category:"Analytics"},{id:"fa-percent",label:"Percent",category:"Numbers"},{id:"fa-hashtag",label:"Number",category:"Numbers"},{id:"fa-sort-numeric-asc",label:"Ranking",category:"Numbers"},{id:"fa-dollar",label:"Dollar",category:"Financial"},{id:"fa-gbp",label:"Pound",category:"Financial"},{id:"fa-money",label:"Money",category:"Financial"},{id:"fa-tasks",label:"Tasks",category:"Progress"},{id:"fa-spinner",label:"Progress",category:"Progress"},{id:"fa-bullseye",label:"Target",category:"Progress"},{id:"fa-flag",label:"Flag",category:"Progress"},{id:"fa-envelope",label:"Email",category:"Communication"},{id:"fa-comments",label:"Comments",category:"Communication"},{id:"fa-bell",label:"Notifications",category:"Communication"},{id:"fa-exclamation-triangle",label:"Warning",category:"Alerts"},{id:"fa-info-circle",label:"Info",category:"Alerts"},{id:"fa-thumbs-up",label:"Thumbs Up",category:"Feedback"},{id:"fa-thumbs-down",label:"Thumbs Down",category:"Feedback"},{id:"fa-smile-o",label:"Satisfaction",category:"Feedback"}],l=["fa-users","fa-graduation-cap","fa-clock-o","fa-check-circle"];t.prototype={init:function(){var e=this;this.container=s("#"+this.containerId),this.textarea=s('[name="'+this.textareaName+'"]'),this.container.length&&this.textarea.length&&(this.loadExistingSelection(),this.loadStrings().then(function(){e.render(),e.fetchReports(),e.bindEvents(),"manual"===e.mode&&"manual"!==s('[name="config_report_source"]').val()||e.container.show()}))},loadStrings:function(){var t=this;return e.get_strings([{key:"addreport",component:"block_adeptus_insights"},{key:"removereport",component:"block_adeptus_insights"},{key:"noreportsselected",component:"block_adeptus_insights"},{key:"selectareport",component:"block_adeptus_insights"},{key:"loading",component:"block_adeptus_insights"},{key:"config_alert_report_placeholder",component:"block_adeptus_insights"}]).then(function(e){t.strings={addreport:e[0],removereport:e[1],noreportsselected:e[2],selectareport:e[3],loading:e[4],searchplaceholder:e[5]||"Search reports by name, category, or type..."}})},loadExistingSelection:function(){try{var e=this.textarea.val();e&&(this.selectedReports=JSON.parse(e))}catch(e){this.selectedReports=[]}},render:function(){var e='<div class="report-selector-ui"><div class="report-selector-header d-flex justify-content-between align-items-center mb-2"><span class="font-weight-bold">'+({kpi:"KPI Reports",tabs:"Tab Reports",manual:"Selected Reports"}[this.mode]||"Reports")+'</span><span class="badge badge-secondary report-count">0 selected</span></div><div class="report-selector-search-container mb-3 position-relative"><div class="input-group"><div class="input-group-prepend"><span class="input-group-text"><i class="fa fa-search"></i></span></div><input type="text" class="form-control report-search-input" id="'+(this.mode+"-search-"+Date.now())+'" placeholder="'+this.strings.searchplaceholder+'" autocomplete="off" aria-haspopup="listbox" aria-expanded="false"><div class="input-group-append"><button type="button" class="btn btn-primary report-selector-add-btn" disabled><i class="fa fa-plus"></i> '+this.strings.addreport+'</button></div></div><div class="report-search-dropdown position-absolute w-100 bg-white border rounded shadow-sm" style="display:none; z-index:1050; max-height:350px; overflow-y:auto; top:100%; left:0;"><div class="report-search-results"></div><div class="report-search-empty text-muted text-center py-3" style="display:none;"><i class="fa fa-search"></i> No matching reports found</div><div class="report-search-loading text-center py-3" style="display:none;"><i class="fa fa-spinner fa-spin"></i> '+this.strings.loading+'</div></div></div><div class="report-selector-list-container"><ul class="list-group report-selector-list"></ul><div class="report-selector-empty text-muted text-center py-3"><i class="fa fa-inbox fa-2x mb-2"></i><br>'+this.strings.noreportsselected+"</div></div></div>";this.container.html(e),this.updateListDisplay(),this.updateSelectedCount()},fetchReports:function(){var i=this;if(!this.apiKey)return this.container.find(".report-search-loading").hide(),void this.container.find(".report-search-empty").show().html('<i class="fa fa-exclamation-triangle"></i> API key not configured');this.container.find(".report-search-loading").show();var e="https://backend.adeptus360.com/api/v1";s.when(s.ajax({url:e+"/wizard-reports",method:"GET",headers:{Authorization:"Bearer "+this.apiKey,Accept:"application/json"},timeout:15e3}),s.ajax({url:e+"/ai-reports",method:"GET",headers:{Authorization:"Bearer "+this.apiKey,Accept:"application/json"},timeout:15e3})).then(function(e,t){var a=[];(e[0].reports||e[0].data||[]).forEach(function(e){e.source="wizard",e.displayName=e.name||e.title||e.display_name||e.slug,e.categoryName=e.category_info?e.category_info.name:"General",a.push(e)}),(t[0].reports||t[0].data||[]).forEach(function(e){e.source="ai",e.displayName=e.name||e.title||e.display_name||e.slug,e.categoryName=e.category_info?e.category_info.name:"AI Generated",a.push(e)}),a.sort(function(e,t){return e.displayName.localeCompare(t.displayName)}),i.reports=a,i.filteredReports=i.getAvailableReports(),i.container.find(".report-search-loading").hide(),i.renderSelectedList()}).fail(function(){i.container.find(".report-search-loading").hide(),r.addNotification({message:"Failed to load reports",type:"error"})})},getAvailableReports:function(){var e=this;return this.reports.filter(function(t){return!e.selectedReports.some(function(e){return e.slug===t.slug&&e.source===t.source})})},filterReports:function(e){var t=this.getAvailableReports();if(!e||e.length<1)return t;var a=(e=e.toLowerCase().trim()).split(/\s+/);return t.filter(function(e){var t=(e.displayName+" "+e.categoryName+" "+e.source+" "+(e.slug||"")).toLowerCase();return a.every(function(e){return-1!==t.indexOf(e)})}).slice(0,50)},renderSearchResults:function(i){var a,r,n=this,o=this.container.find(".report-search-results"),e=this.container.find(".report-search-empty");o.empty(),0!==this.filteredReports.length?(e.hide(),a={},this.filteredReports.forEach(function(e){var t=e.categoryName||"Other";a[t]||(a[t]=[]),a[t].push(e)}),r=0,Object.keys(a).sort().forEach(function(e){o.append('<div class="report-search-category px-3 py-1 bg-light border-bottom"><small class="text-muted font-weight-bold">'+n.escapeHtml(e)+"</small></div>"),a[e].forEach(function(e){var t=n.highlightMatch(e.displayName,i),a="ai"===e.source?'<span class="badge badge-info ml-2">AI</span>':'<span class="badge badge-primary ml-2">Wizard</span>',e='<div class="report-search-item px-3 py-2 cursor-pointer" data-index="'+r+'" data-slug="'+e.slug+'" data-source="'+e.source+'" role="option" tabindex="-1"><div class="d-flex justify-content-between align-items-center"><span class="report-name">'+t+"</span>"+a+"</div></div>";o.append(e),r++})}),o.find(".report-search-item").css("cursor","pointer").hover(function(){s(this).addClass("bg-light"),n.highlightedIndex=parseInt(s(this).data("index"),10),n.updateHighlight()},function(){s(this).removeClass("bg-light")})):e.show()},highlightMatch:function(e,t){if(!t||!e)return this.escapeHtml(e);var a=this.escapeHtml(e);return t.toLowerCase().trim().split(/\s+/).forEach(function(e){0<e.length&&(e=new RegExp("("+e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+")","gi"),a=a.replace(e,'<mark class="bg-warning px-0">$1</mark>'))}),a},updateHighlight:function(){var e,t,a,i,r=this.container.find(".report-search-item");r.removeClass("bg-primary text-white bg-light"),0<=this.highlightedIndex&&this.highlightedIndex<r.length&&((r=r.eq(this.highlightedIndex)).removeClass("bg-light").addClass("bg-primary text-white"),e=this.container.find(".report-search-dropdown"),t=r.position().top,r=r.outerHeight(),a=e.height(),i=e.scrollTop(),t<0?e.scrollTop(i+t):a<t+r&&e.scrollTop(i+t+r-a))},openDropdown:function(){var e,t;this.isDropdownOpen||(this.isDropdownOpen=!0,this.highlightedIndex=-1,t=this.container.find(".report-search-dropdown"),e=this.container.find(".report-search-input"),t.show(),e.attr("aria-expanded","true"),t=e.val(),this.filteredReports=this.filterReports(t),this.renderSearchResults(t))},closeDropdown:function(){var e,t;this.isDropdownOpen&&(this.isDropdownOpen=!1,this.highlightedIndex=-1,e=this.container.find(".report-search-dropdown"),t=this.container.find(".report-search-input"),e.hide(),t.attr("aria-expanded","false"))},handleSearch:function(e){var t=this;this.searchTimeout&&clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout(function(){t.filteredReports=t.filterReports(e),t.renderSearchResults(e),t.highlightedIndex=-1},150)},selectHighlightedItem:function(){var e;this.highlightedIndex<0||this.highlightedIndex>=this.filteredReports.length||(e=this.filteredReports[this.highlightedIndex],this.addReport(e))},addReport:function(e){var t=l[this.selectedReports.length%l.length],e={slug:e.slug,source:e.source,name:e.displayName||e.name||e.title||e.slug};"kpi"===this.mode&&(e.icon=t),this.selectedReports.push(e),this.saveSelection(),this.updateSelectedCount(),this.filteredReports=this.getAvailableReports(),this.container.find(".report-search-input").val(""),this.closeDropdown(),this.renderSelectedList()},renderSelectedList:function(){var o=this,s=this.container.find(".report-selector-list");s.empty(),this.selectedReports.forEach(function(t,e){var a=o.reports.find(function(e){return e.slug===t.slug&&e.source===t.source}),i=t.name||(a?a.displayName:t.slug),a=a?a.categoryName:"Unknown",r="",n=("kpi"===o.mode&&(n=t.icon||l[e%l.length],r=o.buildIconPicker(n,e)),'<li class="list-group-item d-flex justify-content-between align-items-center" data-index="'+e+'" data-slug="'+t.slug+'" data-source="'+t.source+'"><div class="d-flex align-items-center flex-grow-1 min-width-0"><span class="drag-handle mr-2" style="cursor: move;"><i class="fa fa-bars text-muted"></i></span>'+r+'<span class="badge badge-secondary mr-2">'+(e+1)+'</span><span class="text-truncate" title="'+o.escapeHtml(i)+'">'+o.escapeHtml(i)+'</span><small class="text-muted ml-2 d-none d-md-inline">['+o.escapeHtml(a)+']</small><span class="badge badge-'+("ai"===t.source?"info":"primary")+' ml-2">'+t.source.toUpperCase()+'</span></div><button type="button" class="btn btn-sm btn-outline-danger report-selector-remove ml-2" title="'+o.strings.removereport+'"><i class="fa fa-times"></i></button></li>');s.append(n)}),this.updateListDisplay(),this.initSortable(),this.initIconPickers()},buildIconPicker:function(a,e){var i='<div class="dropdown kpi-icon-picker mr-2" data-index="'+e+'"><button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" title="Select icon"><i class="fa '+a+'"></i></button><div class="dropdown-menu kpi-icon-dropdown"><div class="px-2 py-1"><small class="text-muted">Select an icon</small></div><div class="dropdown-divider"></div><div class="kpi-icon-grid px-2">',t={};return n.forEach(function(e){t[e.category]||(t[e.category]=[]),t[e.category].push(e)}),Object.keys(t).forEach(function(e){i+='<div class="kpi-icon-category mb-1"><small class="text-muted d-block mb-1">'+e+'</small><div class="d-flex flex-wrap">',t[e].forEach(function(e){var t=e.id===a?" active":"";i+='<button type="button" class="btn btn-sm btn-light kpi-icon-option m-1'+t+'" data-icon="'+e.id+'" title="'+e.label+'"><i class="fa '+e.id+'"></i></button>'}),i+="</div></div>"}),i+="</div></div></div>"},initIconPickers:function(){var r=this;this.container.find(".kpi-icon-picker .dropdown-toggle").off("click.iconpicker").on("click.iconpicker",function(e){e.preventDefault(),e.stopPropagation();var e=s(this),t=e.closest(".kpi-icon-picker"),a=t.find(".dropdown-menu"),i=a.hasClass("show");r.container.find(".kpi-icon-picker .dropdown-menu.show").removeClass("show"),r.container.find(".kpi-icon-picker .dropdown-toggle").attr("aria-expanded","false"),i||(i=t[0].getBoundingClientRect(),window.innerHeight-i.bottom<320?t.addClass("dropup"):t.removeClass("dropup"),a.addClass("show"),e.attr("aria-expanded","true"))}),this.container.find(".kpi-icon-option").off("click.iconpicker").on("click.iconpicker",function(e){e.preventDefault(),e.stopPropagation();var e=s(this),t=e.closest(".kpi-icon-picker"),a=parseInt(t.data("index"),10),i=e.data("icon");r.selectedReports[a]&&(r.selectedReports[a].icon=i,r.saveSelection(),t.find(".dropdown-toggle i").removeClass().addClass("fa "+i),t.find(".kpi-icon-option").removeClass("active"),e.addClass("active"),t.find(".dropdown-menu").removeClass("show"),t.find(".dropdown-toggle").attr("aria-expanded","false"))}),s(document).off("click.iconpicker-close").on("click.iconpicker-close",function(e){s(e.target).closest(".kpi-icon-picker").length||(r.container.find(".kpi-icon-picker .dropdown-menu.show").removeClass("show"),r.container.find(".kpi-icon-picker .dropdown-toggle").attr("aria-expanded","false"))})},updateListDisplay:function(){var e=this.container.find(".report-selector-list"),t=this.container.find(".report-selector-empty");0<this.selectedReports.length?(e.show(),t.hide()):(e.hide(),t.show())},updateSelectedCount:function(){var e=this.selectedReports.length,e=1===e?"1 selected":e+" selected";this.container.find(".report-count").text(e)},initSortable:function(){var e=this,t=this.container.find(".report-selector-list");s.fn.sortable?t.sortable({handle:".drag-handle",update:function(){e.updateOrderFromDOM()}}):this.initManualSort()},initManualSort:function(){var e=this,t=this.container.find(".report-selector-list"),a=null;t.on("dragstart","li",function(e){s(a=this).addClass("dragging opacity-50"),e.originalEvent.dataTransfer.effectAllowed="move"}),t.on("dragend","li",function(){s(this).removeClass("dragging opacity-50"),e.updateOrderFromDOM()}),t.on("dragover","li",function(e){e.preventDefault();var t=this.getBoundingClientRect(),t=t.top+t.height/2;e.originalEvent.clientY<t?s(this).before(a):s(this).after(a)}),t.find("li").attr("draggable","true")},updateOrderFromDOM:function(){var i=this,r=[];this.container.find(".report-selector-list li").each(function(){var t=s(this).data("slug"),a=s(this).data("source"),e=i.selectedReports.find(function(e){return e.slug===t&&e.source===a});e&&r.push(e)}),this.selectedReports=r,this.saveSelection(),this.renderSelectedList()},bindEvents:function(){var i=this,a=this.container.find(".report-search-input"),e=this.container.find(".report-search-dropdown");a.on("focus",function(){i.openDropdown()}),a.on("input",function(){var e=s(this).val();i.openDropdown(),i.handleSearch(e)}),a.on("keydown",function(e){var t=i.container.find(".report-search-item").length-1;switch(e.keyCode){case 40:e.preventDefault(),i.isDropdownOpen||i.openDropdown(),i.highlightedIndex=Math.min(i.highlightedIndex+1,t),i.updateHighlight();break;case 38:e.preventDefault(),i.highlightedIndex=Math.max(i.highlightedIndex-1,0),i.updateHighlight();break;case 13:e.preventDefault(),0<=i.highlightedIndex&&i.selectHighlightedItem();break;case 27:e.preventDefault(),i.closeDropdown(),a.blur();break;case 9:i.closeDropdown()}}),e.on("click",".report-search-item",function(){var t=s(this).data("slug"),a=s(this).data("source"),e=i.reports.find(function(e){return e.slug===t&&e.source===a});e&&i.addReport(e)}),s(document).on("click",function(e){s(e.target).closest(i.container).length||i.closeDropdown()}),this.container.on("click",".report-selector-remove",function(e){e.stopPropagation();var e=s(this).closest("li"),t=e.data("slug"),e=e.data("source");i.removeReport(t,e)}),s('[name="config_display_mode"]').on("change",function(){var e=s(this).val();"kpi"===e?(s("#kpi-report-selector-container").show(),s("#tabs-report-selector-container").hide()):"tabs"===e?(s("#kpi-report-selector-container").hide(),s("#tabs-report-selector-container").show()):(s("#kpi-report-selector-container").hide(),s("#tabs-report-selector-container").hide())}).trigger("change")},removeReport:function(t,a){var e;this.selectedReports=this.selectedReports.filter(function(e){return!(e.slug===t&&e.source===a)}),this.saveSelection(),this.updateSelectedCount(),this.filteredReports=this.getAvailableReports(),this.renderSelectedList(),this.isDropdownOpen&&(e=this.container.find(".report-search-input").val(),this.filteredReports=this.filterReports(e),this.renderSearchResults(e))},saveSelection:function(){this.textarea.val(JSON.stringify(this.selectedReports))},escapeHtml:function(e){if(!e)return"";var t=document.createElement("div");return t.textContent=e,t.innerHTML}};return a.prototype={init:function(){var t=this;this.container=s("#alerts-manager-container"),this.textarea=s("#id_config_alerts_json"),this.container.length&&this.loadStrings().then(function(){t.operators=JSON.parse(t.container.attr("data-operators")||"{}"),t.intervals=JSON.parse(t.container.attr("data-intervals")||"{}"),t.cooldowns=JSON.parse(t.container.attr("data-cooldowns")||"{}"),t.roles=JSON.parse(t.container.attr("data-roles")||"{}");var e=JSON.parse(t.container.attr("data-existing-alerts")||"[]");t.alerts=e,t.populateSelectOptions(),t.fetchReports(),t.bindEvents(),t.renderAlertsList(),t.saveToTextarea(),t.handleAlertsEnabledToggle()})},loadStrings:function(){var t=this;return e.get_strings([{key:"edit_alert",component:"block_adeptus_insights"},{key:"delete_alert",component:"block_adeptus_insights"},{key:"alert_delete_confirm",component:"block_adeptus_insights"},{key:"add_new_alert",component:"block_adeptus_insights"},{key:"alert_disabled",component:"block_adeptus_insights"},{key:"config_add_alert",component:"block_adeptus_insights"}]).then(function(e){t.strings={editAlert:e[0],deleteAlert:e[1],deleteConfirm:e[2],addNewAlert:e[3],disabled:e[4],addAlert:e[5]}})},populateSelectOptions:function(){var a=s("#alert-edit-operator"),i=(a.empty(),s.each(this.operators,function(e,t){a.append(s("<option>",{value:e,text:t}))}),s("#alert-edit-interval")),r=(i.empty(),s.each(this.intervals,function(e,t){i.append(s("<option>",{value:e,text:t}))}),s("#alert-edit-cooldown")),n=(r.empty(),s.each(this.cooldowns,function(e,t){r.append(s("<option>",{value:e,text:t}))}),s("#alert-edit-notify-roles"));n.empty(),s.each(this.roles,function(e,t){n.append(s("<option>",{value:e,text:t}))})},fetchReports:function(){var e,i=this;this.apiKey&&s.when(s.ajax({url:(e="https://backend.adeptus360.com/api/v1")+"/wizard-reports",method:"GET",headers:{Authorization:"Bearer "+this.apiKey,Accept:"application/json"},timeout:15e3}),s.ajax({url:e+"/ai-reports",method:"GET",headers:{Authorization:"Bearer "+this.apiKey,Accept:"application/json"},timeout:15e3})).then(function(e,t){var a=[];(e[0].reports||e[0].data||[]).forEach(function(e){e.source="wizard",e.displayName=e.name||e.title||e.display_name||e.slug,e.categoryName=e.category_info?e.category_info.name:"General",a.push(e)}),(t[0].reports||t[0].data||[]).forEach(function(e){e.source="ai",e.displayName=e.name||e.title||e.display_name||e.slug,e.categoryName=e.category_info?e.category_info.name:"AI Generated",a.push(e)}),a.sort(function(e,t){return e.displayName.localeCompare(t.displayName)}),i.reports=a,i.filteredReports=a}).fail(function(){r.addNotification({message:"Failed to load reports for alerts",type:"error"})})},handleAlertsEnabledToggle:function(){function e(){var e=i.is(":checked"),t="kpi"===r.val();e&&t?a.container.show():a.container.hide()}var a=this,i=s('[name="config_alerts_enabled"]'),r=s('[name="config_display_mode"]');i.on("change",e),r.on("change",e),e()},bindEvents:function(){var a=this,e=(this.container.on("click","#add-alert-btn",function(){a.openEditPanel(-1)}),this.container.on("click",".alert-edit-btn",function(){var e=s(this).closest(".alert-item").data("index");a.openEditPanel(e)}),this.container.on("click",".alert-delete-btn",function(){var e=s(this).closest(".alert-item").data("index");confirm(a.strings.deleteConfirm)&&a.deleteAlert(e)}),this.container.on("change",".alert-enabled-toggle",function(){var e=s(this).closest(".alert-item").data("index");a.alerts[e].enabled=s(this).is(":checked"),a.saveToTextarea(),a.renderAlertsList()}),this.container.on("click",".alert-panel-close, .alert-panel-cancel",function(){a.closeEditPanel()}),this.container.on("click",".alert-panel-save",function(){a.saveEditPanel()}),s("#alert-edit-notify-email").on("change",function(){s(this).is(":checked")?s("#email-addresses-group").show():s("#email-addresses-group").hide()}),s("#alert-edit-report-search")),t=s("#alert-report-dropdown");e.on("focus",function(){a.openReportDropdown()}),e.on("input",function(){var e=s(this).val();a.handleReportSearch(e)}),e.on("keydown",function(e){27===e.keyCode&&a.closeReportDropdown()}),t.on("click",".report-dropdown-item",function(){var e=s(this).data("slug"),t=s(this).data("name");a.selectReport(e,t)}),s(document).on("click",function(e){s(e.target).closest("#alert-edit-report-search, #alert-report-dropdown").length||a.closeReportDropdown()})},renderAlertsList:function(){var l=this,c=s("#alerts-list"),e=c.find(".alerts-empty");c.find(".alert-item").remove(),0===this.alerts.length?e.show():(e.hide(),this.alerts.forEach(function(e,t){var a=e.report_name||e.report_slug,i=e.alert_name||a,r=l.operators[e.operator]||e.operator,n=[],n=(null!==e.warning_value&&""!==e.warning_value&&n.push("Warning: "+e.warning_value),null!==e.critical_value&&""!==e.critical_value&&n.push("Critical: "+e.critical_value),n.join(", ")||"No thresholds set"),o=l.intervals[e.check_interval]||e.check_interval+"s",s="",i=("warning"===e.current_status?s='<span class="badge badge-warning ml-2">Warning</span>':"critical"===e.current_status?s='<span class="badge badge-danger ml-2">Critical</span>':e.current_status&&(s='<span class="badge badge-success ml-2">OK</span>'),'<div class="alert-item card mb-2" data-index="'+t+'"><div class="card-body py-2 px-3"><div class="d-flex justify-content-between align-items-start"><div class="flex-grow-1"><div class="d-flex align-items-center mb-1"><strong>'+l.escapeHtml(i)+"</strong>"+s+(e.enabled?"":'<span class="badge badge-secondary ml-2">'+l.strings.disabled+"</span>")+'</div><small class="text-muted d-block">'+l.escapeHtml(a)+'</small><small class="text-muted d-block">'+l.escapeHtml(r)+" | "+n+" | "+o+'</small></div><div class="alert-actions d-flex align-items-center"><div class="custom-control custom-switch mr-2"><input type="checkbox" class="custom-control-input alert-enabled-toggle" id="alert-enabled-'+t+'"'+(e.enabled?" checked":"")+'><label class="custom-control-label" for="alert-enabled-'+t+'"></label></div><button type="button" class="btn btn-sm btn-outline-primary alert-edit-btn mr-1" title="'+l.strings.editAlert+'"><i class="fa fa-pencil"></i></button><button type="button" class="btn btn-sm btn-outline-danger alert-delete-btn" title="'+l.strings.deleteAlert+'"><i class="fa fa-trash"></i></button></div></div></div></div>');c.append(i)})),this.container.find(".alerts-count").text(this.alerts.length)},openEditPanel:function(e){var t=s("#alert-edit-panel");this.editingIndex=e,s("#alert-edit-report").val(""),s("#alert-edit-report-search").val(""),s("#alert-edit-report-display").text(""),s("#alert-edit-name").val(""),s("#alert-edit-operator").val("gt"),s("#alert-edit-warning").val(""),s("#alert-edit-critical").val(""),s("#alert-edit-interval").val("3600"),s("#alert-edit-cooldown").val("3600"),s("#alert-edit-notify-warning").prop("checked",!0),s("#alert-edit-notify-critical").prop("checked",!0),s("#alert-edit-notify-recovery").prop("checked",!0),s("#alert-edit-notify-email").prop("checked",!1),s("#alert-edit-email-addresses").val(""),s("#email-addresses-group").hide(),s("#alert-edit-notify-roles").val([]),0<=e&&this.alerts[e]?(e=this.alerts[e],s("#alert-edit-report").val(e.report_slug),s("#alert-edit-report-search").val(e.report_name||e.report_slug),s("#alert-edit-report-display").text("Selected: "+(e.report_name||e.report_slug)),s("#alert-edit-name").val(e.alert_name||""),s("#alert-edit-operator").val(e.operator||"gt"),s("#alert-edit-warning").val(e.warning_value||""),s("#alert-edit-critical").val(e.critical_value||""),s("#alert-edit-interval").val(e.check_interval||3600),s("#alert-edit-cooldown").val(e.cooldown_seconds||3600),s("#alert-edit-notify-warning").prop("checked",!1!==e.notify_on_warning),s("#alert-edit-notify-critical").prop("checked",!1!==e.notify_on_critical),s("#alert-edit-notify-recovery").prop("checked",!1!==e.notify_on_recovery),s("#alert-edit-notify-email").prop("checked",!!e.notify_email),s("#alert-edit-email-addresses").val(e.notify_emails||""),e.notify_email&&s("#email-addresses-group").show(),s("#alert-edit-notify-roles").val(e.notify_roles||[]),t.find(".alert-panel-title").text(this.strings.editAlert)):t.find(".alert-panel-title").text(this.strings.addNewAlert),t.show()},closeEditPanel:function(){s("#alert-edit-panel").hide(),this.editingIndex=-1},saveEditPanel:function(){var e=s("#alert-edit-report").val(),t=s("#alert-edit-report-search").val(),a=s("#alert-edit-warning").val(),i=s("#alert-edit-critical").val();e?a||i?(e={report_slug:e,report_name:t,alert_name:s("#alert-edit-name").val(),operator:s("#alert-edit-operator").val(),warning_value:a?parseFloat(a):null,critical_value:i?parseFloat(i):null,check_interval:parseInt(s("#alert-edit-interval").val(),10),cooldown_seconds:parseInt(s("#alert-edit-cooldown").val(),10),notify_on_warning:s("#alert-edit-notify-warning").is(":checked"),notify_on_critical:s("#alert-edit-notify-critical").is(":checked"),notify_on_recovery:s("#alert-edit-notify-recovery").is(":checked"),notify_email:s("#alert-edit-notify-email").is(":checked"),notify_emails:s("#alert-edit-email-addresses").val().trim(),notify_roles:s("#alert-edit-notify-roles").val()||[],enabled:!0},0<=this.editingIndex?(e.id=this.alerts[this.editingIndex].id,e.current_status=this.alerts[this.editingIndex].current_status,e.enabled=this.alerts[this.editingIndex].enabled,this.alerts[this.editingIndex]=e):(e.current_status="ok",this.alerts.push(e)),this.saveToTextarea(),this.renderAlertsList(),this.closeEditPanel()):r.addNotification({message:"At least one threshold (warning or critical) is required.",type:"error"}):r.addNotification({message:"Please select a report to monitor.",type:"error"})},deleteAlert:function(e){this.alerts.splice(e,1),this.saveToTextarea(),this.renderAlertsList()},saveToTextarea:function(){this.textarea.val(JSON.stringify(this.alerts))},openReportDropdown:function(){var e,t;this.isDropdownOpen||(this.isDropdownOpen=!0,e=s("#alert-report-dropdown"),t=s("#alert-edit-report-search"),e.css("width",t.outerWidth()+"px"),e.show(),this.filteredReports=this.reports,this.renderReportDropdown(""))},closeReportDropdown:function(){this.isDropdownOpen=!1,s("#alert-report-dropdown").hide()},handleReportSearch:function(e){var t=this;this.searchTimeout&&clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout(function(){t.filteredReports=t.filterReports(e),t.renderReportDropdown(e)},150)},filterReports:function(e){if(!e||e.length<1)return this.reports;var a=(e=e.toLowerCase().trim()).split(/\s+/);return this.reports.filter(function(e){var t=(e.displayName+" "+e.categoryName+" "+e.source+" "+(e.slug||"")).toLowerCase();return a.every(function(e){return-1!==t.indexOf(e)})}).slice(0,30)},renderReportDropdown:function(e){var a,i=this,r=s("#alert-report-dropdown");r.empty(),0!==this.filteredReports.length?(a={},this.filteredReports.forEach(function(e){var t=e.categoryName||"Other";a[t]||(a[t]=[]),a[t].push(e)}),Object.keys(a).sort().forEach(function(e){r.append('<div class="px-3 py-1 bg-light border-bottom"><small class="text-muted font-weight-bold">'+i.escapeHtml(e)+"</small></div>"),a[e].forEach(function(e){var t="ai"===e.source?'<span class="badge badge-info ml-2">AI</span>':'<span class="badge badge-primary ml-2">Wizard</span>';r.append('<div class="report-dropdown-item px-3 py-2" style="cursor:pointer;" data-slug="'+e.slug+'" data-name="'+i.escapeHtml(e.displayName)+'"><span>'+i.escapeHtml(e.displayName)+"</span>"+t+"</div>")})}),r.find(".report-dropdown-item").hover(function(){s(this).addClass("bg-light")},function(){s(this).removeClass("bg-light")})):r.append('<div class="p-3 text-muted text-center">No matching reports found</div>')},selectReport:function(e,t){s("#alert-edit-report").val(e),s("#alert-edit-report-search").val(t),s("#alert-edit-report-display").text("Selected: "+t),this.closeReportDropdown()},escapeHtml:function(e){if(!e)return"";var t=document.createElement("div");return t.textContent=e,t.innerHTML}},{init:function(e){new t({mode:"kpi",apiKey:e.apiKey,containerId:"kpi-report-selector-container",textareaName:"config_kpi_selected_reports"}),new t({mode:"tabs",apiKey:e.apiKey,containerId:"tabs-report-selector-container",textareaName:"config_tabs_selected_reports"}),new t({mode:"manual",apiKey:e.apiKey,containerId:"manual-report-selector-container",textareaName:"config_selected_reports_json"}),new a({apiKey:e.apiKey}),s('[name="config_report_source"]').on("change",function(){"manual"===s(this).val()?s("#manual-report-selector-container").show():s("#manual-report-selector-container").hide()}).trigger("change")}}});