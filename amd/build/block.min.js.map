{"version":3,"file":"block.min.js","sources":["../src/block.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Main JavaScript controller for the Adeptus Insights block.\n *\n * @module     block_adeptus_insights/block\n * @copyright  2025 Adeptus Analytics\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\n    'jquery',\n    'core/ajax',\n    'core/notification',\n    'core/str',\n    'core/modal_factory',\n    'core/modal_events',\n    'core/templates',\n    'core/chartjs'\n], function($, Ajax, Notification, Str, ModalFactory, ModalEvents, Templates, Chart) {\n    'use strict';\n\n    /**\n     * Block controller class.\n     *\n     * @param {Object} options Configuration options\n     */\n    var BlockController = function(options) {\n        this.blockId = options.blockid;\n        this.contextId = options.contextid;\n        this.config = options.config || {};\n        this.apiKey = options.apiKey || '';  // API key passed directly from PHP\n        this.isAdmin = options.isAdmin || false;  // Site admin flag\n        this.container = null;\n        this.reports = [];\n        this.lastUpdated = null;\n        this.refreshTimer = null;\n        this.modal = null;\n        this.modalData = null;      // Current modal report data\n        this.modalReport = null;    // Current modal report metadata\n        this.chartInstance = null;  // Current Chart.js instance\n        this.currentView = 'table'; // Current view mode\n\n        // Pagination state for report list\n        this.listCurrentPage = 1;\n        this.listItemsPerPage = this.config.maxLinkItems || 10;\n        this.listTotalPages = 1;\n\n        // Pagination state for modal table\n        this.tableCurrentPage = 1;\n        this.tableRowsPerPage = 25;\n        this.tableTotalPages = 1;\n\n        // Category filter state\n        this.selectedCategory = '';\n        this.availableCategories = [];\n\n        // Report selector state (for embedded mode)\n        this.selectedReportSlug = this.config.defaultReport || '';\n        this.selectedReportSource = '';\n\n        // Embedded mode state (mirrors modal functionality)\n        this.embeddedCurrentView = 'table';\n        this.embeddedTablePage = 1;\n        this.embeddedTableRowsPerPage = 25;\n        this.embeddedChartType = 'bar';\n        this.embeddedXAxis = '';\n        this.embeddedYAxis = '';\n\n        // Backend API URL - use config value or fall back to default\n        this.backendUrl = this.config.backendUrl || 'https://backend.adeptus360.com/api/v1';\n\n        // Cache settings\n        this.cacheKey = 'adeptus_block_reports_' + this.blockId;\n        this.cacheTTL = 5 * 60 * 1000; // 5 minutes\n        this.reportDataCache = {}; // In-memory cache for executed report data\n        this.preloadTimeout = null;\n        this.preloadingSlug = null;\n\n        // Tabs mode state (per-pane state for view toggle, pagination, chart)\n        this.tabPaneStates = {};\n        this.tabChartInstances = {};\n\n        // KPI Modal state\n        this.kpiModal = null;\n        this.kpiModalChart = null;\n        this.kpiModalData = null;\n        this.kpiModalDateRange = '30d';\n\n        // KPI Snapshot data cache (stores responses from postSnapshotToBackend)\n        this.kpiSnapshotCache = {};\n\n        // Snapshot schedule registration tracking\n        this.registeredSnapshots = {};\n\n        this.init();\n    };\n\n    BlockController.prototype = {\n        /**\n         * Initialize the block.\n         */\n        init: function() {\n            // Find the block container.\n            this.container = $('[data-blockid=\"' + this.blockId + '\"]');\n            if (!this.container.length) {\n                return;\n            }\n\n            // Bind event handlers.\n            this.bindEvents();\n\n            // Load initial data.\n            this.loadReports();\n\n            // Setup auto-refresh if configured.\n            this.setupAutoRefresh();\n        },\n\n        /**\n         * Bind event handlers.\n         */\n        bindEvents: function() {\n            var self = this;\n\n            // Refresh button.\n            this.container.on('click', '.block-adeptus-refresh, .block-adeptus-retry', function(e) {\n                e.preventDefault();\n                self.refresh();\n            });\n\n            // Report item click.\n            this.container.on('click', '.block-adeptus-report-item', function(e) {\n                e.preventDefault();\n                var slug = $(this).data('slug');\n                var source = $(this).data('source');\n                self.handleReportClick(slug, source);\n            });\n\n            // Report item keyboard activation (Enter/Space).\n            this.container.on('keydown', '.block-adeptus-report-item', function(e) {\n                if (e.key === 'Enter' || e.key === ' ') {\n                    e.preventDefault();\n                    var slug = $(this).data('slug');\n                    var source = $(this).data('source');\n                    self.handleReportClick(slug, source);\n                }\n            });\n\n            // KPI card click.\n            this.container.on('click', '.block-adeptus-kpi-card', function(e) {\n                e.preventDefault();\n                var slug = $(this).data('slug');\n                var source = $(this).data('source');\n                self.handleReportClick(slug, source);\n            });\n\n            // Tab click.\n            this.container.on('shown.bs.tab', '.block-adeptus-tab-nav a', function(e) {\n                var tabPane = $($(e.target).attr('href'));\n                var slug = tabPane.data('slug');\n                var source = tabPane.data('source');\n                if (!tabPane.data('loaded')) {\n                    self.loadTabContent(tabPane, slug, source);\n                }\n            });\n\n            // Export buttons.\n            this.container.on('click', '.block-adeptus-export', function(e) {\n                e.preventDefault();\n                var format = $(this).data('format');\n                self.exportReport(format);\n            });\n\n            // Pagination - Previous button.\n            this.container.on('click', '.pagination-prev', function(e) {\n                e.preventDefault();\n                if (self.listCurrentPage > 1) {\n                    self.listCurrentPage--;\n                    self.renderCurrentPage();\n                    self.scrollToListTop();\n                }\n            });\n\n            // Pagination - Next button.\n            this.container.on('click', '.pagination-next', function(e) {\n                e.preventDefault();\n                if (self.listCurrentPage < self.listTotalPages) {\n                    self.listCurrentPage++;\n                    self.renderCurrentPage();\n                    self.scrollToListTop();\n                }\n            });\n\n            // Category filter change.\n            this.container.on('change', '.category-filter-select', function() {\n                self.selectedCategory = $(this).val();\n                self.listCurrentPage = 1; // Reset to first page\n                // For embedded mode, update the report selector based on new category\n                if (self.config.displayMode === 'embedded') {\n                    self.populateReportSelector();\n                } else {\n                    self.renderReports();\n                }\n            });\n\n            // Report selector change (for embedded mode) - hidden select fallback.\n            this.container.on('change', '.report-selector-select', function() {\n                var selectedValue = $(this).val();\n                if (selectedValue) {\n                    var parts = selectedValue.split('::');\n                    var slug = parts[0];\n                    var source = parts[1] || 'wizard';\n                    self.selectedReportSlug = slug;\n                    self.selectedReportSource = source;\n                    // Reset embedded state\n                    self.embeddedTablePage = 1;\n                    self.embeddedCurrentView = 'table';\n                    self.loadEmbeddedReport(slug, source);\n                }\n            });\n\n            // Searchable dropdown - Toggle open/close.\n            this.container.on('click', '.searchable-dropdown-toggle', function(e) {\n                e.preventDefault();\n                e.stopPropagation();\n                var dropdown = $(this).closest('.searchable-dropdown');\n                self.toggleSearchableDropdown(dropdown);\n            });\n\n            // Searchable dropdown - Search input.\n            this.container.on('input', '.searchable-dropdown-input', function() {\n                var dropdown = $(this).closest('.searchable-dropdown');\n                var query = $(this).val().toLowerCase().trim();\n                self.filterSearchableDropdown(dropdown, query);\n            });\n\n            // Searchable dropdown - Item selection.\n            this.container.on('click', '.searchable-dropdown-item', function(e) {\n                e.preventDefault();\n                e.stopPropagation();\n                var dropdown = $(this).closest('.searchable-dropdown');\n                var value = $(this).data('value');\n                var text = $(this).find('.dropdown-item-name').text();\n                self.selectSearchableDropdownItem(dropdown, value, text);\n            });\n\n            // Searchable dropdown - Keyboard navigation.\n            this.container.on('keydown', '.searchable-dropdown-input', function(e) {\n                var dropdown = $(this).closest('.searchable-dropdown');\n                var items = dropdown.find('.searchable-dropdown-item:visible');\n                var focused = dropdown.find('.searchable-dropdown-item.focused');\n\n                if (e.key === 'ArrowDown') {\n                    e.preventDefault();\n                    if (focused.length === 0) {\n                        items.first().addClass('focused');\n                    } else {\n                        var next = focused.nextAll('.searchable-dropdown-item:visible').first();\n                        if (next.length) {\n                            focused.removeClass('focused');\n                            next.addClass('focused');\n                            self.scrollDropdownItemIntoView(next);\n                        }\n                    }\n                } else if (e.key === 'ArrowUp') {\n                    e.preventDefault();\n                    if (focused.length) {\n                        var prev = focused.prevAll('.searchable-dropdown-item:visible').first();\n                        if (prev.length) {\n                            focused.removeClass('focused');\n                            prev.addClass('focused');\n                            self.scrollDropdownItemIntoView(prev);\n                        }\n                    }\n                } else if (e.key === 'Enter') {\n                    e.preventDefault();\n                    if (focused.length) {\n                        focused.trigger('click');\n                    } else if (items.length === 1) {\n                        items.first().trigger('click');\n                    }\n                } else if (e.key === 'Escape') {\n                    self.closeSearchableDropdown(dropdown);\n                }\n            });\n\n            // Close dropdown when clicking outside.\n            $(document).on('click', function(e) {\n                if (!$(e.target).closest('.searchable-dropdown').length) {\n                    self.container.find('.searchable-dropdown.open').each(function() {\n                        self.closeSearchableDropdown($(this));\n                    });\n                }\n            });\n\n            // Embedded mode - View toggle (Table/Chart).\n            this.container.on('click', '.embedded-view-toggle-btn', function(e) {\n                e.preventDefault();\n                var view = $(this).data('view');\n                self.switchEmbeddedView(view);\n            });\n\n            // Embedded mode - Table pagination.\n            this.container.on('click', '.embedded-pagination-prev', function(e) {\n                e.preventDefault();\n                if (self.embeddedTablePage > 1) {\n                    self.embeddedTablePage--;\n                    self.renderEmbeddedTablePage();\n                    self.scrollToEmbeddedTableTop();\n                }\n            });\n\n            this.container.on('click', '.embedded-pagination-next', function(e) {\n                e.preventDefault();\n                var totalPages = Math.ceil((self.embeddedData || []).length / self.embeddedTableRowsPerPage);\n                if (self.embeddedTablePage < totalPages) {\n                    self.embeddedTablePage++;\n                    self.renderEmbeddedTablePage();\n                    self.scrollToEmbeddedTableTop();\n                }\n            });\n\n            // Embedded mode - Chart type change.\n            this.container.on('change', '.embedded-chart-type', function() {\n                self.embeddedChartType = $(this).val();\n                self.renderEmbeddedChart();\n            });\n\n            // Embedded mode - X-Axis change.\n            this.container.on('change', '.embedded-chart-x-axis', function() {\n                self.embeddedXAxis = $(this).val();\n                self.renderEmbeddedChart();\n            });\n\n            // Embedded mode - Y-Axis change.\n            this.container.on('change', '.embedded-chart-y-axis', function() {\n                self.embeddedYAxis = $(this).val();\n                self.renderEmbeddedChart();\n            });\n\n            // Embedded mode - Export.\n            this.container.on('click', '.embedded-export', function(e) {\n                e.preventDefault();\n                var format = $(this).data('format');\n                self.exportEmbeddedReport(format);\n            });\n\n            // Tabs mode - View toggle (Table/Chart).\n            this.container.on('click', '.tab-view-toggle-btn', function(e) {\n                e.preventDefault();\n                var pane = $(this).closest('.tab-pane');\n                var view = $(this).data('view');\n                self.switchTabView(pane, view);\n            });\n\n            // Tabs mode - Table pagination.\n            this.container.on('click', '.tab-pagination-prev', function(e) {\n                e.preventDefault();\n                var pane = $(this).closest('.tab-pane');\n                var tabId = pane.attr('id');\n                var state = self.tabPaneStates[tabId];\n                if (state && state.tablePage > 1) {\n                    state.tablePage--;\n                    self.renderTabTablePage(pane, state);\n                }\n            });\n\n            this.container.on('click', '.tab-pagination-next', function(e) {\n                e.preventDefault();\n                var pane = $(this).closest('.tab-pane');\n                var tabId = pane.attr('id');\n                var state = self.tabPaneStates[tabId];\n                if (state) {\n                    var totalPages = Math.ceil(state.data.length / state.rowsPerPage);\n                    if (state.tablePage < totalPages) {\n                        state.tablePage++;\n                        self.renderTabTablePage(pane, state);\n                    }\n                }\n            });\n\n            // Tabs mode - Chart type change.\n            this.container.on('change', '.tab-chart-type', function() {\n                var pane = $(this).closest('.tab-pane');\n                var tabId = pane.attr('id');\n                var state = self.tabPaneStates[tabId];\n                if (state) {\n                    state.chartType = $(this).val();\n                    self.renderTabChart(pane, state);\n                }\n            });\n\n            // Tabs mode - X-Axis change.\n            this.container.on('change', '.tab-chart-x-axis', function() {\n                var pane = $(this).closest('.tab-pane');\n                var tabId = pane.attr('id');\n                var state = self.tabPaneStates[tabId];\n                if (state) {\n                    state.xAxis = $(this).val();\n                    self.renderTabChart(pane, state);\n                }\n            });\n\n            // Tabs mode - Y-Axis change.\n            this.container.on('change', '.tab-chart-y-axis', function() {\n                var pane = $(this).closest('.tab-pane');\n                var tabId = pane.attr('id');\n                var state = self.tabPaneStates[tabId];\n                if (state) {\n                    state.yAxis = $(this).val();\n                    self.renderTabChart(pane, state);\n                }\n            });\n\n            // Tabs mode - Export.\n            this.container.on('click', '.tab-export', function(e) {\n                e.preventDefault();\n                var pane = $(this).closest('.tab-pane');\n                var tabId = pane.attr('id');\n                var state = self.tabPaneStates[tabId];\n                var format = $(this).data('format');\n                if (state) {\n                    self.exportTabReport(state, format);\n                }\n            });\n\n            // Preload report data on hover (300ms delay to avoid unnecessary loads).\n            this.container.on('mouseenter', '.block-adeptus-report-item', function() {\n                var slug = $(this).data('slug');\n                var source = $(this).data('source');\n\n                // Clear any pending preload\n                if (self.preloadTimeout) {\n                    clearTimeout(self.preloadTimeout);\n                }\n\n                // Start preload after 300ms hover\n                self.preloadTimeout = setTimeout(function() {\n                    self.preloadReportData(slug, source);\n                }, 300);\n            });\n\n            this.container.on('mouseleave', '.block-adeptus-report-item', function() {\n                // Cancel pending preload if user moves away\n                if (self.preloadTimeout) {\n                    clearTimeout(self.preloadTimeout);\n                    self.preloadTimeout = null;\n                }\n            });\n        },\n\n        /**\n         * Load reports from the server or cache.\n         */\n        loadReports: function() {\n            var self = this;\n\n            this.showLoading();\n\n            // Try to load from cache first\n            var cachedData = this.getFromCache();\n            if (cachedData) {\n                this.reports = cachedData;\n                this.lastUpdated = new Date();\n                this.renderReports();\n                return;\n            }\n\n            // Wait for auth data to be available.\n            this.waitForAuth(function() {\n                self.fetchReports();\n            });\n        },\n\n        /**\n         * Get reports from sessionStorage cache.\n         *\n         * @return {Array|null}\n         */\n        getFromCache: function() {\n            try {\n                var cached = sessionStorage.getItem(this.cacheKey);\n                if (cached) {\n                    var data = JSON.parse(cached);\n                    if (data.timestamp && (Date.now() - data.timestamp) < this.cacheTTL) {\n                        return data.reports;\n                    }\n                    // Cache expired, remove it\n                    sessionStorage.removeItem(this.cacheKey);\n                }\n            } catch (e) {\n                // Ignore storage errors\n            }\n            return null;\n        },\n\n        /**\n         * Save reports to sessionStorage cache.\n         *\n         * @param {Array} reports\n         */\n        saveToCache: function(reports) {\n            try {\n                sessionStorage.setItem(this.cacheKey, JSON.stringify({\n                    timestamp: Date.now(),\n                    reports: reports\n                }));\n            } catch (e) {\n                // Ignore storage errors (quota exceeded, etc.)\n            }\n        },\n\n        /**\n         * Preload report data on hover for faster modal loading.\n         *\n         * @param {string} slug\n         * @param {string} source\n         */\n        preloadReportData: function(slug, source) {\n            var self = this;\n            var cacheKey = slug + '_' + source;\n\n            // Already cached or currently preloading\n            if (this.reportDataCache[cacheKey] || this.preloadingSlug === slug) {\n                return;\n            }\n\n            this.preloadingSlug = slug;\n\n            // Find the report from our cached list\n            var report = this.reports.find(function(r) {\n                return r.slug === slug;\n            });\n\n            if (!report) {\n                return;\n            }\n\n            if (source === 'wizard') {\n                // Preload wizard report\n                $.ajax({\n                    url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/generate_report.php',\n                    method: 'POST',\n                    data: {\n                        reportid: report.name || report.report_template_id,\n                        sesskey: M.cfg.sesskey\n                    },\n                    dataType: 'json',\n                    timeout: 30000\n                }).done(function(response) {\n                    if (response.success) {\n                        self.reportDataCache[cacheKey] = {\n                            report: report,\n                            results: response.results || [],\n                            chartData: response.chart_data,\n                            chartType: response.chart_type\n                        };\n                    }\n                    self.preloadingSlug = null;\n                }).fail(function() {\n                    self.preloadingSlug = null;\n                });\n            } else {\n                // Preload AI report\n                var token = this.apiKey || (window.adeptusAuthData ? window.adeptusAuthData.api_key : null);\n                if (!token) {\n                    return;\n                }\n\n                $.ajax({\n                    url: '' + this.backendUrl + '/ai-reports/' + slug,\n                    method: 'GET',\n                    headers: {\n                        'Authorization': 'Bearer ' + token,\n                        'Accept': 'application/json'\n                    },\n                    timeout: 15000\n                }).done(function(response) {\n                    if (response.success && response.report) {\n                        var reportData = response.report;\n                        var data = response.data || [];\n\n                        // Check if local execution is required (SaaS model)\n                        var sqlQuery = response.sql || (reportData && reportData.sql_query) || (reportData && reportData.sql);\n                        var needsLocalExecution = response.execution_required || ((!data || data.length === 0) && sqlQuery);\n\n                        if (needsLocalExecution && sqlQuery) {\n                            // Execute SQL locally against Moodle database\n                            self.executeReportLocally(sqlQuery, reportData.params || {})\n                                .then(function(executionResult) {\n                                    var localData = executionResult.data || [];\n                                    self.reportDataCache[cacheKey] = {\n                                        report: reportData,\n                                        results: localData,\n                                        chartData: null,\n                                        chartType: null\n                                    };\n                                    self.preloadingSlug = null;\n                                })\n                                .catch(function() {\n                                    self.preloadingSlug = null;\n                                });\n                            return;\n                        }\n\n                        self.reportDataCache[cacheKey] = {\n                            report: reportData,\n                            results: data,\n                            chartData: null,\n                            chartType: null\n                        };\n                    }\n                    self.preloadingSlug = null;\n                }).fail(function() {\n                    self.preloadingSlug = null;\n                });\n            }\n        },\n\n        /**\n         * Wait for authentication data to be available.\n         * Uses API key passed directly from PHP, or falls back to AJAX.\n         *\n         * @param {Function} callback\n         */\n        waitForAuth: function(callback) {\n            var self = this;\n\n            // Use API key passed directly from PHP (preferred - no AJAX needed)\n            if (this.apiKey) {\n                window.adeptusAuthData = window.adeptusAuthData || {};\n                window.adeptusAuthData.api_key = this.apiKey;\n                callback();\n                return;\n            }\n\n            // Fallback: Check if already authenticated via parent plugin\n            if (window.adeptusAuthData && window.adeptusAuthData.api_key) {\n                callback();\n                return;\n            }\n\n            // Last resort: Try to fetch auth via AJAX\n            $.ajax({\n                url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/get_auth_status.php',\n                method: 'GET',\n                dataType: 'json',\n                timeout: 10000\n            }).done(function(response) {\n                if (response && response.success && response.data) {\n                    window.adeptusAuthData = response.data;\n                    callback();\n                } else {\n                    self.showError('Authentication failed');\n                }\n            }).fail(function() {\n                self.showError('Could not authenticate');\n            });\n        },\n\n        /**\n         * Fetch reports from the backend API.\n         */\n        fetchReports: function() {\n            var self = this;\n            var token = this.apiKey || (window.adeptusAuthData ? window.adeptusAuthData.api_key : null);\n\n            if (!token) {\n                this.showError('No authentication token');\n                return;\n            }\n\n            var promises = [];\n            var source = this.config.reportSource || 'all';\n\n            // For 'manual' and 'category' sources, we need to fetch all reports first,\n            // then filter them in filterReports(). Same for 'all'.\n            if (source === 'all' || source === 'wizard' || source === 'manual' || source === 'category') {\n                promises.push(this.fetchFromApi('/wizard-reports', token));\n            }\n\n            if (source === 'all' || source === 'ai' || source === 'manual' || source === 'category') {\n                promises.push(this.fetchFromApi('/ai-reports', token));\n            }\n\n            $.when.apply($, promises).then(function() {\n                var allReports = [];\n\n                for (var i = 0; i < promises.length; i++) {\n                    var result;\n                    if (promises.length === 1) {\n                        result = arguments[0];\n                    } else {\n                        result = arguments[i][0];\n                    }\n\n                    var reports = result.reports || result.data || [];\n                    if (reports && reports.length) {\n                        // Determine report source: for sources that fetch both APIs (all, manual, category),\n                        // the second promise (i === 1) is AI reports.\n                        var fetchesBoth = (source === 'all' || source === 'manual' || source === 'category');\n                        var reportSource = (source === 'ai' || (i === 1 && fetchesBoth)) ? 'ai' : 'wizard';\n                        reports.forEach(function(report) {\n                            report.source = report.source || reportSource;\n                            allReports.push(report);\n                        });\n                    }\n                }\n\n                self.reports = allReports;\n                self.lastUpdated = new Date();\n                self.saveToCache(allReports);\n                self.renderReports();\n            }).fail(function() {\n                self.showError();\n            });\n        },\n\n        /**\n         * Fetch data from the backend API.\n         *\n         * @param {string} endpoint API endpoint\n         * @param {string} token Auth token\n         * @return {Promise}\n         */\n        fetchFromApi: function(endpoint, token) {\n            var baseUrl = '' + this.backendUrl + '';\n\n            return $.ajax({\n                url: baseUrl + endpoint,\n                method: 'GET',\n                headers: {\n                    'Authorization': 'Bearer ' + token,\n                    'Content-Type': 'application/json',\n                    'Accept': 'application/json'\n                },\n                timeout: 15000\n            });\n        },\n\n        /**\n         * Render reports based on display mode.\n         */\n        renderReports: function() {\n            var mode = this.config.displayMode || 'links';\n\n            if (this.reports.length === 0) {\n                this.showEmpty();\n                return;\n            }\n\n            // Extract and populate category filter (only for modes that use it)\n            if (mode === 'embedded' || mode === 'links') {\n                this.populateCategoryFilter();\n            }\n\n            // Filter reports based on selected category (for links/embedded modes)\n            var filteredReports = this.filterReports();\n\n            switch (mode) {\n                case 'embedded':\n                    this.renderEmbedded(filteredReports);\n                    break;\n                case 'kpi':\n                    // For KPI mode, use ALL reports for matching since user explicitly selected them\n                    // (category filter doesn't apply - user chose specific reports)\n                    var kpiReports = this.getSelectedReportsForMode('kpi', this.reports);\n                    this.renderKpi(kpiReports);\n                    break;\n                case 'tabs':\n                    // For Tabs mode, use ALL reports for matching since user explicitly selected them\n                    // (category filter doesn't apply - user chose specific reports)\n                    var tabsReports = this.getSelectedReportsForMode('tabs', this.reports);\n                    this.renderTabs(tabsReports);\n                    break;\n                case 'links':\n                default:\n                    this.renderLinks(filteredReports);\n                    break;\n            }\n\n            this.hideLoading();\n            this.updateTimestamp();\n        },\n\n        /**\n         * Get reports filtered by the selected reports configuration for a specific mode.\n         *\n         * @param {string} mode - 'kpi' or 'tabs'\n         * @param {Array} allReports - All available reports\n         * @return {Array} Filtered reports in configured order\n         */\n        getSelectedReportsForMode: function(mode, allReports) {\n            var selectedConfig = [];\n\n            if (mode === 'kpi' && this.config.kpiSelectedReports && this.config.kpiSelectedReports.length > 0) {\n                selectedConfig = this.config.kpiSelectedReports;\n            } else if (mode === 'tabs' && this.config.tabsSelectedReports && this.config.tabsSelectedReports.length > 0) {\n                selectedConfig = this.config.tabsSelectedReports;\n            }\n\n            // If no specific reports configured, return all reports\n            if (selectedConfig.length === 0) {\n                return allReports;\n            }\n\n            // Filter and order reports according to selection\n            var result = [];\n            selectedConfig.forEach(function(item) {\n                var slug = item.slug || item;\n                var source = item.source || 'wizard';\n                var report = allReports.find(function(r) {\n                    return r.slug === slug && (r.source === source || !item.source);\n                });\n                if (report) {\n                    // Clone report and add custom icon if configured\n                    var enrichedReport = Object.assign({}, report);\n                    if (item.icon) {\n                        enrichedReport.customIcon = item.icon;\n                    }\n                    result.push(enrichedReport);\n                }\n            });\n\n            return result;\n        },\n\n        /**\n         * Extract categories from reports and populate the filter dropdown.\n         */\n        populateCategoryFilter: function() {\n            var self = this;\n            var categoryMap = {};\n            var config = this.config;\n\n            // If category is configured in block settings, pre-select it.\n            // The category filter from config is always applied (locked).\n            var categoryLocked = !!config.reportCategory;\n            if (categoryLocked) {\n                this.selectedCategory = config.reportCategory;\n            }\n\n            // Extract unique categories from reports\n            this.reports.forEach(function(report) {\n                var catInfo = report.category_info;\n                if (catInfo && catInfo.slug) {\n                    categoryMap[catInfo.slug] = {\n                        slug: catInfo.slug,\n                        name: catInfo.name || catInfo.slug,\n                        color: catInfo.color || '#6c757d'\n                    };\n                } else if (report.category) {\n                    categoryMap[report.category] = {\n                        slug: report.category,\n                        name: report.category,\n                        color: '#6c757d'\n                    };\n                }\n            });\n\n            // If category is configured but not found in reports, add it as a fallback.\n            // This ensures the dropdown shows the configured category even if no reports match.\n            if (categoryLocked && !categoryMap[config.reportCategory]) {\n                // Format slug as display name (capitalize, replace dashes/underscores with spaces).\n                var displayName = config.reportCategory\n                    .replace(/[-_]/g, ' ')\n                    .replace(/\\b\\w/g, function(l) { return l.toUpperCase(); });\n                categoryMap[config.reportCategory] = {\n                    slug: config.reportCategory,\n                    name: displayName,\n                    color: '#6c757d'\n                };\n            }\n\n            // Convert to array and sort by name\n            this.availableCategories = Object.values(categoryMap).sort(function(a, b) {\n                return a.name.localeCompare(b.name);\n            });\n\n            // Populate hidden select\n            var select = this.container.find('.category-filter-select');\n            var dropdown = this.container.find('.category-dropdown');\n            var dropdownList = dropdown.find('.searchable-dropdown-list');\n\n            if (select.length) {\n                // Keep the first \"All Categories\" option, remove the rest\n                select.find('option:not(:first)').remove();\n\n                // Add category options to hidden select\n                this.availableCategories.forEach(function(cat) {\n                    var selected = self.selectedCategory === cat.slug ? ' selected' : '';\n                    select.append('<option value=\"' + cat.slug + '\"' + selected + '>' + cat.name + '</option>');\n                });\n            }\n\n            // Populate searchable dropdown list\n            if (dropdownList.length) {\n                dropdownList.empty();\n\n                // Add \"All Categories\" option first\n                var allSelected = !this.selectedCategory ? 'selected' : '';\n                var allItemHtml = '<li class=\"searchable-dropdown-item ' + allSelected + '\" data-value=\"\" ' +\n                    'data-search=\"all categories\" role=\"option\">' +\n                    '<span class=\"dropdown-item-name\">All Categories</span>' +\n                    '</li>';\n                dropdownList.append(allItemHtml);\n\n                // Add category options\n                this.availableCategories.forEach(function(cat) {\n                    var isSelected = self.selectedCategory === cat.slug ? 'selected' : '';\n                    var itemHtml = '<li class=\"searchable-dropdown-item ' + isSelected + '\" data-value=\"' + cat.slug + '\" ' +\n                        'data-search=\"' + cat.name.toLowerCase() + '\" role=\"option\">' +\n                        '<span class=\"dropdown-item-name\">' + self.escapeHtml(cat.name) + '</span>' +\n                        '<span class=\"dropdown-item-category\" style=\"background-color: ' + cat.color + '\">' +\n                        '<i class=\"fa fa-circle\" style=\"font-size: 0.5rem;\"></i></span>' +\n                        '</li>';\n                    dropdownList.append(itemHtml);\n                });\n\n                // Update dropdown text to show selected category\n                var selectedText = 'All Categories';\n                if (this.selectedCategory) {\n                    var selectedCat = this.availableCategories.find(function(c) {\n                        return c.slug === self.selectedCategory;\n                    });\n                    if (selectedCat) {\n                        selectedText = selectedCat.name;\n                    }\n                }\n                dropdown.find('.searchable-dropdown-text').text(selectedText);\n\n                // If category is locked via config, hide the entire category filter\n                if (categoryLocked) {\n                    this.container.find('.block-adeptus-category-filter').hide();\n                }\n            }\n        },\n\n        /**\n         * Populate the report selector dropdown (for embedded mode).\n         * Filters reports based on selected category.\n         */\n        populateReportSelector: function() {\n            var self = this;\n            var select = this.container.find('.report-selector-select');\n            var dropdown = this.container.find('.block-adeptus-report-selector .searchable-dropdown');\n            var dropdownList = dropdown.find('.searchable-dropdown-list');\n\n            if (!select.length) {\n                return;\n            }\n\n            // Get filtered reports based on category\n            var reports = this.filterReports();\n\n            // Clear existing options\n            select.find('option:not(:first)').remove();\n            dropdownList.empty();\n\n            // Add report options to both hidden select and searchable dropdown\n            reports.forEach(function(report) {\n                var reportName = report.name || report.title || report.display_name || report.slug || 'Untitled';\n                var value = report.slug + '::' + report.source;\n                var categoryInfo = report.category_info || {name: 'General', color: '#6c757d'};\n                var categoryLabel = ' [' + categoryInfo.name + ']';\n                var selected = (self.selectedReportSlug === report.slug) ? ' selected' : '';\n\n                // Hidden select option\n                select.append('<option value=\"' + value + '\"' + selected + '>' + reportName + categoryLabel + '</option>');\n\n                // Searchable dropdown item\n                var itemHtml = '<li class=\"searchable-dropdown-item\" data-value=\"' + value + '\" data-search=\"' +\n                    reportName.toLowerCase() + ' ' + categoryInfo.name.toLowerCase() + '\" role=\"option\">' +\n                    '<span class=\"dropdown-item-name\">' + self.escapeHtml(reportName) + '</span>' +\n                    '<span class=\"dropdown-item-category\" style=\"background-color: ' + categoryInfo.color + '\">' +\n                    self.escapeHtml(categoryInfo.name) + '</span>' +\n                    '</li>';\n                dropdownList.append(itemHtml);\n            });\n\n            // If we have a default report configured and it's in the list, select it\n            if (this.selectedReportSlug && !select.val()) {\n                var defaultOption = select.find('option[value^=\"' + this.selectedReportSlug + '::\"]');\n                if (defaultOption.length) {\n                    defaultOption.prop('selected', true);\n                }\n            }\n\n            // If no report selected and we have reports, auto-select the first one\n            if (!select.val() && reports.length > 0) {\n                var firstReport = reports[0];\n                var firstValue = firstReport.slug + '::' + firstReport.source;\n                var firstName = firstReport.name || firstReport.title || firstReport.display_name || firstReport.slug || 'Untitled';\n                select.val(firstValue);\n                this.selectedReportSlug = firstReport.slug;\n                this.selectedReportSource = firstReport.source;\n                // Update searchable dropdown display\n                dropdown.find('.searchable-dropdown-text').text(firstName);\n                dropdown.find('.searchable-dropdown-item').removeClass('selected');\n                dropdown.find('.searchable-dropdown-item[data-value=\"' + firstValue + '\"]').addClass('selected');\n                // Load the first report\n                this.loadEmbeddedReport(firstReport.slug, firstReport.source);\n            } else if (select.val()) {\n                // A report is selected, load it and update display\n                var parts = select.val().split('::');\n                var selectedReport = reports.find(function(r) { return r.slug === parts[0]; });\n                if (selectedReport) {\n                    var selectedName = selectedReport.name || selectedReport.title || selectedReport.display_name || selectedReport.slug || 'Untitled';\n                    dropdown.find('.searchable-dropdown-text').text(selectedName);\n                    dropdown.find('.searchable-dropdown-item').removeClass('selected');\n                    dropdown.find('.searchable-dropdown-item[data-value=\"' + select.val() + '\"]').addClass('selected');\n                }\n                this.loadEmbeddedReport(parts[0], parts[1] || 'wizard');\n            } else {\n                // No reports available\n                dropdown.find('.searchable-dropdown-text').text('-- No Reports --');\n                this.showEmpty();\n            }\n        },\n\n        /**\n         * Filter reports based on configuration and selected category.\n         *\n         * @return {Array}\n         */\n        filterReports: function() {\n            var self = this;\n            var reports = this.reports.slice();\n            var config = this.config;\n\n            // Filter by category from block config (always apply if set).\n            if (config.reportCategory) {\n                reports = reports.filter(function(r) {\n                    var catSlug = r.category_info ? r.category_info.slug : (r.category || '');\n                    return catSlug === config.reportCategory;\n                });\n            }\n\n            // Filter by selected category from dropdown (runtime selection, further filters config).\n            if (this.selectedCategory && this.selectedCategory !== config.reportCategory) {\n                reports = reports.filter(function(r) {\n                    var catSlug = r.category_info ? r.category_info.slug : (r.category || '');\n                    return catSlug === self.selectedCategory;\n                });\n            }\n\n            // Sort by name (try multiple possible name fields).\n            reports.sort(function(a, b) {\n                var nameA = a.name || a.title || a.display_name || a.report_name || a.slug || '';\n                var nameB = b.name || b.title || b.display_name || b.report_name || b.slug || '';\n                return nameA.localeCompare(nameB);\n            });\n\n            return reports;\n        },\n\n        /**\n         * Render link list mode with pagination.\n         *\n         * @param {Array} reports\n         */\n        renderLinks: function(reports) {\n            // Store filtered reports for pagination\n            this.filteredReports = reports;\n\n            // Calculate pagination\n            this.listItemsPerPage = this.config.maxLinkItems || 10;\n            this.listTotalPages = Math.ceil(reports.length / this.listItemsPerPage);\n            this.listCurrentPage = 1; // Reset to first page\n\n            // Render the first page\n            this.renderCurrentPage();\n        },\n\n        /**\n         * Render the current page of reports.\n         */\n        renderCurrentPage: function() {\n            var self = this;\n            var reports = this.filteredReports || [];\n            var listContainer = this.container.find('.block-adeptus-report-list');\n            var template = $('#block-adeptus-report-item-template-' + this.blockId);\n            var paginationContainer = this.container.find('.block-adeptus-pagination');\n\n            // Calculate page slice\n            var startIndex = (this.listCurrentPage - 1) * this.listItemsPerPage;\n            var endIndex = startIndex + this.listItemsPerPage;\n            var pageReports = reports.slice(startIndex, endIndex);\n\n            listContainer.empty();\n\n            pageReports.forEach(function(report) {\n                var item = template.html();\n                var $item = $(item);\n\n                $item.attr('data-slug', report.slug);\n                $item.attr('data-source', report.source);\n\n                // Try multiple possible name fields (API may use different field names)\n                var reportName = report.name || report.title || report.display_name || report.report_name || report.slug || 'Untitled Report';\n                $item.find('.report-item-name').text(reportName);\n\n                // Set category badge with color\n                var categoryName = report.category_info ? report.category_info.name : report.category || 'General';\n                var categoryColor = report.category_info ? report.category_info.color : '#6c757d';\n                $item.find('.report-item-category')\n                    .text(categoryName)\n                    .css('background-color', categoryColor)\n                    .css('color', '#fff');\n\n                listContainer.append($item);\n            });\n\n            listContainer.removeClass('d-none');\n\n            // Update pagination controls\n            if (this.listTotalPages > 1) {\n                // Use actual page data length for accurate count\n                var actualEnd = startIndex + pageReports.length;\n                paginationContainer.find('.pagination-showing')\n                    .text('Showing ' + (startIndex + 1) + '-' + actualEnd + ' of ' + reports.length);\n                paginationContainer.find('.pagination-pages')\n                    .text('Page ' + this.listCurrentPage + ' of ' + this.listTotalPages);\n\n                // Update button states\n                paginationContainer.find('.pagination-prev').prop('disabled', this.listCurrentPage <= 1);\n                paginationContainer.find('.pagination-next').prop('disabled', this.listCurrentPage >= this.listTotalPages);\n\n                paginationContainer.removeClass('d-none');\n            } else {\n                paginationContainer.addClass('d-none');\n            }\n        },\n\n        /**\n         * Render embedded report mode.\n         *\n         * @param {Array} reports\n         */\n        renderEmbedded: function(reports) {\n            // Initialize embedded report state\n            this.embeddedReport = null;\n            this.embeddedData = null;\n            this.embeddedChartInstance = null;\n\n            // Populate the report selector dropdown\n            // This will also auto-load the first/default report\n            this.populateReportSelector();\n\n            // Hide loading state if no reports\n            if (this.reports.length === 0) {\n                this.showEmpty();\n            }\n        },\n\n        /**\n         * Load report data for embedded display.\n         *\n         * @param {string} slug\n         * @param {string} source\n         */\n        loadEmbeddedReport: function(slug, source) {\n            var self = this;\n            var cacheKey = slug + '_' + source;\n\n            // Check cache first for instant loading (no overlay needed)\n            if (this.reportDataCache[cacheKey]) {\n                var cached = this.reportDataCache[cacheKey];\n                this.embeddedData = cached.results;\n                this.renderEmbeddedContent(cached.report, cached.results);\n                return;\n            }\n\n            // Show loading overlay for non-cached requests\n            this.showEmbeddedLoadingOverlay();\n\n            // Find the report from our cached list\n            var report = this.reports.find(function(r) {\n                return r.slug === slug;\n            });\n\n            if (!report) {\n                this.hideEmbeddedLoadingOverlay();\n                this.showError('Report not found');\n                return;\n            }\n\n            // For wizard reports, execute locally via generate_report.php\n            if (source === 'wizard') {\n                $.ajax({\n                    url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/generate_report.php',\n                    method: 'POST',\n                    data: {\n                        reportid: report.name || report.report_template_id,\n                        sesskey: M.cfg.sesskey\n                    },\n                    dataType: 'json',\n                    timeout: 30000\n                }).done(function(response) {\n                    self.hideEmbeddedLoadingOverlay();\n                    if (response.success) {\n                        // Cache the result\n                        self.reportDataCache[cacheKey] = {\n                            report: report,\n                            results: response.results || [],\n                            chartData: response.chart_data,\n                            chartType: response.chart_type\n                        };\n                        self.embeddedData = response.results || [];\n                        self.renderEmbeddedContent(report, response.results || []);\n                    } else {\n                        self.showError(response.message || 'Failed to load report');\n                    }\n                }).fail(function() {\n                    self.hideEmbeddedLoadingOverlay();\n                    self.showError('Connection error');\n                });\n            } else {\n                // AI reports - fetch from backend API\n                var token = this.apiKey || (window.adeptusAuthData ? window.adeptusAuthData.api_key : null);\n\n                if (!token) {\n                    this.hideEmbeddedLoadingOverlay();\n                    this.showError('No authentication token');\n                    return;\n                }\n\n                $.ajax({\n                    url: '' + this.backendUrl + '/ai-reports/' + slug,\n                    method: 'GET',\n                    headers: {\n                        'Authorization': 'Bearer ' + token,\n                        'Accept': 'application/json'\n                    },\n                    timeout: 15000\n                }).done(function(response) {\n                    if (response.success && response.report) {\n                        var reportData = response.report;\n                        var data = response.data || [];\n\n                        // Check if local execution is required (SaaS model)\n                        var sqlQuery = response.sql || (reportData && reportData.sql_query) || (reportData && reportData.sql);\n                        var needsLocalExecution = response.execution_required || ((!data || data.length === 0) && sqlQuery);\n\n                        if (needsLocalExecution && sqlQuery) {\n                            // Execute SQL locally against Moodle database\n                            self.executeReportLocally(sqlQuery, reportData.params || {})\n                                .then(function(executionResult) {\n                                    self.hideEmbeddedLoadingOverlay();\n                                    var localData = executionResult.data || [];\n                                    self.reportDataCache[cacheKey] = {\n                                        report: reportData,\n                                        results: localData,\n                                        chartData: null,\n                                        chartType: null\n                                    };\n                                    self.embeddedData = localData;\n                                    self.renderEmbeddedContent(reportData, localData);\n                                })\n                                .catch(function(error) {\n                                    self.hideEmbeddedLoadingOverlay();\n                                    self.showError('Failed to execute report');\n                                });\n                            return;\n                        }\n\n                        self.hideEmbeddedLoadingOverlay();\n                        // Cache the result\n                        self.reportDataCache[cacheKey] = {\n                            report: reportData,\n                            results: data,\n                            chartData: null,\n                            chartType: null\n                        };\n                        self.embeddedData = data;\n                        self.renderEmbeddedContent(reportData, data);\n                    } else {\n                        self.hideEmbeddedLoadingOverlay();\n                        self.showError('Failed to load report');\n                    }\n                }).fail(function() {\n                    self.hideEmbeddedLoadingOverlay();\n                    self.showError('Connection error');\n                });\n            }\n        },\n\n        /**\n         * Render embedded content with report data.\n         *\n         * @param {Object} report\n         * @param {Array} data\n         */\n        renderEmbeddedContent: function(report, data) {\n            var contentArea = this.container.find('.block-adeptus-content');\n\n            if (!data || data.length === 0) {\n                this.showEmpty();\n                return;\n            }\n\n            // Store data for later use\n            this.embeddedReport = report;\n            this.embeddedData = data;\n\n            // Update meta bar\n            var category = report.category_info || {name: 'General', color: '#6c757d'};\n            this.container.find('.report-category')\n                .text(category.name)\n                .css('background-color', category.color)\n                .css('color', '#fff');\n            this.container.find('.row-count-num').text(data.length);\n            this.container.find('.report-date').text('Updated: ' + new Date().toLocaleTimeString());\n\n            // Populate chart axis selectors\n            this.populateEmbeddedChartControls(data);\n\n            // Reset to table view\n            this.embeddedCurrentView = 'table';\n            this.embeddedTablePage = 1;\n            this.container.find('.embedded-view-toggle-btn').removeClass('active');\n            this.container.find('.embedded-view-toggle-btn[data-view=\"table\"]').addClass('active');\n            this.container.find('.embedded-table-view').removeClass('d-none');\n            this.container.find('.embedded-chart-view').addClass('d-none');\n\n            // Render table with pagination\n            this.renderEmbeddedTablePage();\n\n            contentArea.removeClass('d-none');\n            this.hideLoading();\n            this.updateTimestamp();\n        },\n\n        /**\n         * Switch between table and chart views in embedded mode.\n         *\n         * @param {string} view - 'table' or 'chart'\n         */\n        switchEmbeddedView: function(view) {\n            this.embeddedCurrentView = view;\n\n            // Update toggle buttons\n            this.container.find('.embedded-view-toggle-btn').removeClass('active');\n            this.container.find('.embedded-view-toggle-btn[data-view=\"' + view + '\"]').addClass('active');\n\n            // Show/hide views\n            if (view === 'table') {\n                this.container.find('.embedded-table-view').removeClass('d-none');\n                this.container.find('.embedded-chart-view').addClass('d-none');\n            } else {\n                this.container.find('.embedded-table-view').addClass('d-none');\n                this.container.find('.embedded-chart-view').removeClass('d-none');\n                // Render chart when switching to chart view\n                this.renderEmbeddedChart();\n            }\n        },\n\n        /**\n         * Populate chart control dropdowns for embedded mode.\n         *\n         * @param {Array} data\n         */\n        populateEmbeddedChartControls: function(data) {\n            if (!data || data.length === 0) return;\n\n            var headers = Object.keys(data[0]);\n            var numericCols = this.detectNumericColumns(data, headers);\n\n            var xAxisSelect = this.container.find('.embedded-chart-x-axis');\n            var yAxisSelect = this.container.find('.embedded-chart-y-axis');\n\n            xAxisSelect.empty();\n            yAxisSelect.empty();\n\n            // Populate X-axis (all columns)\n            headers.forEach(function(h) {\n                var formatted = h.replace(/_/g, ' ').replace(/\\b\\w/g, function(l) { return l.toUpperCase(); });\n                xAxisSelect.append('<option value=\"' + h + '\">' + formatted + '</option>');\n            });\n\n            // Populate Y-axis (prefer numeric columns)\n            var yOptions = numericCols.length > 0 ? numericCols : headers;\n            yOptions.forEach(function(h) {\n                var formatted = h.replace(/_/g, ' ').replace(/\\b\\w/g, function(l) { return l.toUpperCase(); });\n                yAxisSelect.append('<option value=\"' + h + '\">' + formatted + '</option>');\n            });\n\n            // Set defaults\n            this.embeddedXAxis = headers[0];\n            this.embeddedYAxis = numericCols.length > 0 ? numericCols[numericCols.length - 1] : headers[headers.length - 1];\n\n            xAxisSelect.val(this.embeddedXAxis);\n            yAxisSelect.val(this.embeddedYAxis);\n        },\n\n        /**\n         * Render current page of table in embedded mode.\n         */\n        renderEmbeddedTablePage: function() {\n            var data = this.embeddedData || [];\n            var table = this.container.find('.embedded-table');\n            var thead = table.find('thead');\n            var tbody = table.find('tbody');\n\n            thead.empty();\n            tbody.empty();\n\n            if (data.length === 0) {\n                return;\n            }\n\n            // Build headers\n            var headers = Object.keys(data[0]);\n            var headerRow = $('<tr>');\n            headers.forEach(function(h) {\n                var formatted = h.replace(/_/g, ' ').replace(/\\b\\w/g, function(l) { return l.toUpperCase(); });\n                headerRow.append($('<th>').text(formatted));\n            });\n            thead.append(headerRow);\n\n            // Calculate pagination\n            var totalPages = Math.ceil(data.length / this.embeddedTableRowsPerPage);\n            var startIndex = (this.embeddedTablePage - 1) * this.embeddedTableRowsPerPage;\n            var endIndex = Math.min(startIndex + this.embeddedTableRowsPerPage, data.length);\n            var pageData = data.slice(startIndex, endIndex);\n\n            // Build rows\n            pageData.forEach(function(row) {\n                var tr = $('<tr>');\n                headers.forEach(function(h) {\n                    var val = row[h];\n                    if (val === null || val === undefined) val = '';\n                    var displayVal = String(val);\n                    if (displayVal.length > 50) {\n                        displayVal = displayVal.substring(0, 50) + '...';\n                    }\n                    tr.append($('<td>').attr('title', val).text(displayVal));\n                });\n                tbody.append(tr);\n            });\n\n            // Update pagination info\n            this.container.find('.row-count').text('Showing ' + (startIndex + 1) + '-' + endIndex + ' of ' + data.length);\n            this.container.find('.embedded-pagination-info').text('Page ' + this.embeddedTablePage + ' of ' + totalPages);\n\n            // Update button states\n            this.container.find('.embedded-pagination-prev').prop('disabled', this.embeddedTablePage <= 1);\n            this.container.find('.embedded-pagination-next').prop('disabled', this.embeddedTablePage >= totalPages);\n        },\n\n        /**\n         * Render chart in embedded mode with current settings.\n         */\n        renderEmbeddedChart: function() {\n            var data = this.embeddedData || [];\n            var canvas = this.container.find('.embedded-chart')[0];\n\n            if (!canvas || data.length === 0) {\n                return;\n            }\n\n            // Destroy existing chart\n            if (this.embeddedChartInstance) {\n                this.embeddedChartInstance.destroy();\n                this.embeddedChartInstance = null;\n            }\n\n            var chartType = this.embeddedChartType || 'bar';\n            var xAxis = this.embeddedXAxis || Object.keys(data[0])[0];\n            var yAxis = this.embeddedYAxis || Object.keys(data[0])[1];\n\n            // Prepare chart data (limit to 30 items)\n            var chartData = data.slice(0, 30);\n            var labels = chartData.map(function(row) {\n                var label = row[xAxis];\n                if (label === null || label === undefined) return 'Unknown';\n                var labelStr = String(label);\n                return labelStr.length > 20 ? labelStr.substring(0, 20) + '...' : labelStr;\n            });\n            var values = chartData.map(function(row) {\n                return parseFloat(row[yAxis]) || 0;\n            });\n\n            // Generate colors\n            var colors = this.generateChartColors(values.length, chartType);\n\n            // Build dataset config\n            var datasetConfig = {\n                label: yAxis.replace(/_/g, ' ').replace(/\\b\\w/g, function(l) { return l.toUpperCase(); }),\n                data: values\n            };\n\n            if (chartType === 'pie' || chartType === 'doughnut') {\n                datasetConfig.backgroundColor = colors;\n                datasetConfig.borderWidth = 1;\n            } else {\n                datasetConfig.backgroundColor = colors[0];\n                datasetConfig.borderColor = colors[0].replace('0.7', '1');\n                datasetConfig.borderWidth = 1;\n            }\n\n            // Chart config\n            var config = {\n                type: chartType,\n                data: {\n                    labels: labels,\n                    datasets: [datasetConfig]\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    plugins: {\n                        legend: {\n                            display: chartType === 'pie' || chartType === 'doughnut',\n                            position: 'right'\n                        }\n                    }\n                }\n            };\n\n            // Add scales for bar/line charts\n            if (chartType === 'bar' || chartType === 'line') {\n                config.options.scales = {\n                    y: { beginAtZero: true },\n                    x: { display: data.length <= 15 }\n                };\n            }\n\n            try {\n                this.embeddedChartInstance = new Chart(canvas.getContext('2d'), config);\n            } catch (error) {\n                this.container.find('.embedded-chart-container').html(\n                    '<div class=\"alert alert-warning text-center\"><i class=\"fa fa-exclamation-circle\"></i> Could not render chart</div>'\n                );\n            }\n        },\n\n        /**\n         * Export embedded report data.\n         *\n         * @param {string} format\n         */\n        exportEmbeddedReport: function(format) {\n            var data = this.embeddedData || [];\n            var report = this.embeddedReport || {};\n\n            if (data.length === 0) {\n                return;\n            }\n\n            if (format === 'csv') {\n                var headers = Object.keys(data[0]);\n                var csvContent = headers.join(',') + '\\n';\n\n                data.forEach(function(row) {\n                    var rowValues = headers.map(function(h) {\n                        var val = row[h];\n                        if (val === null || val === undefined) return '';\n                        var strVal = String(val);\n                        // Escape quotes and wrap in quotes if contains comma\n                        if (strVal.includes(',') || strVal.includes('\"') || strVal.includes('\\n')) {\n                            strVal = '\"' + strVal.replace(/\"/g, '\"\"') + '\"';\n                        }\n                        return strVal;\n                    });\n                    csvContent += rowValues.join(',') + '\\n';\n                });\n\n                var blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});\n                var link = document.createElement('a');\n                var reportName = report.name || report.slug || 'report';\n                link.href = URL.createObjectURL(blob);\n                link.download = reportName.replace(/[^a-z0-9]/gi, '_') + '_' + new Date().toISOString().split('T')[0] + '.csv';\n                link.click();\n            }\n        },\n\n        /**\n         * Render KPI cards mode.\n         *\n         * @param {Array} reports\n         */\n        renderKpi: function(reports) {\n            var self = this;\n            var gridContainer = this.container.find('.block-adeptus-kpi-grid');\n            var template = $('#block-adeptus-kpi-card-template-' + this.blockId);\n            var maxCards = parseInt(this.config.kpiColumns, 10) || 2;\n            maxCards = Math.max(1, Math.min(4, maxCards)); // Clamp between 1-4\n\n            gridContainer.empty();\n\n            var kpiReports = reports.slice(0, maxCards);\n            var cardMap = {}; // Map slug to card element\n            var wizardReports = [];\n            var aiReports = [];\n\n            // Create all cards first\n            kpiReports.forEach(function(report, index) {\n                var card = template.html();\n                var $card = $(card);\n\n                var reportName = report.name || report.title || report.display_name || report.slug || 'Metric';\n                $card.attr('data-slug', report.slug);\n                $card.attr('data-source', report.source);\n                $card.find('.kpi-card-label').text(reportName);\n                $card.find('.kpi-card-value').html('<i class=\"fa fa-spinner fa-spin\"></i>');\n                $card.find('.kpi-card-trend').addClass('d-none');\n                $card.find('.kpi-card-sparkline').addClass('d-none');\n\n                // Set icon - use custom icon if configured, otherwise default based on index\n                var defaultIcons = ['fa-users', 'fa-graduation-cap', 'fa-clock-o', 'fa-check-circle'];\n                var iconClass = report.customIcon || defaultIcons[index % defaultIcons.length];\n                $card.find('.kpi-card-icon i').removeClass('fa-bar-chart').addClass(iconClass);\n\n                gridContainer.append($card);\n\n                // Store reference for batch update\n                cardMap[report.slug] = {\n                    $card: $card,\n                    report: report,\n                    index: index\n                };\n\n                // Separate wizard and AI reports\n                if (report.source === 'wizard') {\n                    wizardReports.push(report);\n                } else {\n                    aiReports.push(report);\n                }\n            });\n\n            gridContainer.removeClass('d-none');\n\n            // Use batch loading for wizard reports (single request for all)\n            if (wizardReports.length > 0) {\n                this.loadKpiBatch(wizardReports, cardMap);\n            }\n\n            // Load AI reports individually (they use external API)\n            aiReports.forEach(function(report, index) {\n                var cardInfo = cardMap[report.slug];\n                setTimeout(function() {\n                    self.loadKpiData(report, cardInfo.$card, cardInfo.index);\n                }, index * 100);\n            });\n        },\n\n        /**\n         * Load multiple KPI cards in a single batch request.\n         *\n         * @param {Array} reports Wizard reports to load\n         * @param {Object} cardMap Map of slug to card info\n         */\n        loadKpiBatch: function(reports, cardMap) {\n            var self = this;\n            var startTime = performance.now();\n\n            // Get report IDs (names) for batch request\n            var reportIds = reports.map(function(r) {\n                return r.report_template_id || r.id || r.name || r.slug;\n            });\n\n            $.ajax({\n                url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/batch_kpi_data.php',\n                method: 'POST',\n                data: {\n                    reportids: JSON.stringify(reportIds),\n                    sesskey: M.cfg.sesskey\n                },\n                dataType: 'json',\n                timeout: 30000\n            }).done(function(response) {\n                if (response.success && response.reports) {\n                    // Update each card with its data\n                    reports.forEach(function(report) {\n                        var reportId = report.report_template_id || report.id || report.name || report.slug;\n                        var reportData = response.reports[reportId];\n                        var cardInfo = cardMap[report.slug];\n\n                        if (!cardInfo) {\n                            return;\n                        }\n\n                        var $card = cardInfo.$card;\n                        var cacheKey = report.slug + '_' + report.source;\n\n                        if (reportData && reportData.success) {\n                            // Cache the results\n                            self.reportDataCache[cacheKey] = {\n                                report: report,\n                                results: reportData.results || []\n                            };\n\n                            // Render the KPI value\n                            self.renderKpiValue($card, reportData.results || []);\n                        } else {\n                            $card.find('.kpi-card-value').text('--');\n                            $card.find('.kpi-card-trend').addClass('d-none');\n                        }\n                    });\n                } else {\n                    // Batch failed, fall back to individual loading\n                    reports.forEach(function(report, index) {\n                        var cardInfo = cardMap[report.slug];\n                        setTimeout(function() {\n                            self.loadKpiData(report, cardInfo.$card, cardInfo.index);\n                        }, index * 100);\n                    });\n                }\n            }).fail(function() {\n                // Fall back to individual loading\n                reports.forEach(function(report, index) {\n                    var cardInfo = cardMap[report.slug];\n                    setTimeout(function() {\n                        self.loadKpiData(report, cardInfo.$card, cardInfo.index);\n                    }, index * 100);\n                });\n            });\n        },\n\n        /**\n         * Load KPI data for a single card.\n         *\n         * @param {Object} report\n         * @param {jQuery} $card\n         * @param {number} cardIndex Card index for logging\n         * @param {number} retryCount Current retry attempt (optional)\n         */\n        loadKpiData: function(report, $card, cardIndex, retryCount) {\n            var self = this;\n            var cacheKey = report.slug + '_' + report.source;\n            retryCount = retryCount || 0;\n            var maxRetries = 2;\n            var startTime = performance.now();\n\n            // Check cache first\n            if (this.reportDataCache[cacheKey]) {\n                var cached = this.reportDataCache[cacheKey];\n                this.renderKpiValue($card, cached.results);\n                return;\n            }\n\n            // Get the report ID - try multiple possible fields\n            var reportId = report.report_template_id || report.id || report.name || report.slug;\n\n            // Load data based on source\n            if (report.source === 'wizard') {\n                $.ajax({\n                    url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/generate_report.php',\n                    method: 'POST',\n                    data: {\n                        reportid: reportId,\n                        sesskey: M.cfg.sesskey\n                    },\n                    dataType: 'json',\n                    timeout: 30000\n                }).done(function(response) {\n                    if (response.success) {\n                        self.reportDataCache[cacheKey] = {\n                            report: report,\n                            results: response.results || []\n                        };\n                        self.renderKpiValue($card, response.results || []);\n                    } else {\n                        $card.find('.kpi-card-value').text('--');\n                        $card.find('.kpi-card-trend').addClass('d-none');\n                    }\n                }).fail(function(jqXHR, textStatus) {\n                    // Retry on timeout or server error\n                    if (retryCount < maxRetries && (textStatus === 'timeout' || jqXHR.status >= 500)) {\n                        setTimeout(function() {\n                            self.loadKpiData(report, $card, cardIndex, retryCount + 1);\n                        }, 1000 * (retryCount + 1));\n                    } else {\n                        $card.find('.kpi-card-value').text('--');\n                        $card.find('.kpi-card-trend').addClass('d-none');\n                    }\n                });\n            } else {\n                // AI reports\n                var token = this.apiKey || (window.adeptusAuthData ? window.adeptusAuthData.api_key : null);\n                if (!token) {\n                    $card.find('.kpi-card-value').text('--');\n                    $card.find('.kpi-card-trend').addClass('d-none');\n                    return;\n                }\n\n                $.ajax({\n                    url: '' + this.backendUrl + '/ai-reports/' + report.slug,\n                    method: 'GET',\n                    headers: {\n                        'Authorization': 'Bearer ' + token,\n                        'Accept': 'application/json'\n                    },\n                    timeout: 30000\n                }).done(function(response) {\n                    if (response.success) {\n                        var reportData = response.report || report;\n                        var data = response.data || [];\n\n                        // Check if local execution is required (SaaS model)\n                        var sqlQuery = response.sql || (reportData && reportData.sql_query) || (reportData && reportData.sql);\n                        var needsLocalExecution = response.execution_required || ((!data || data.length === 0) && sqlQuery);\n\n                        if (needsLocalExecution && sqlQuery) {\n                            // Execute SQL locally against Moodle database\n                            self.executeReportLocally(sqlQuery, reportData.params || {})\n                                .then(function(executionResult) {\n                                    var localData = executionResult.data || [];\n                                    self.reportDataCache[cacheKey] = {\n                                        report: reportData,\n                                        results: localData\n                                    };\n                                    self.renderKpiValue($card, localData);\n                                })\n                                .catch(function(error) {\n                                    $card.find('.kpi-card-value').text('--');\n                                    $card.find('.kpi-card-trend').addClass('d-none');\n                                });\n                            return;\n                        }\n\n                        if (data && data.length > 0) {\n                            self.reportDataCache[cacheKey] = {\n                                report: reportData,\n                                results: data\n                            };\n                            self.renderKpiValue($card, data);\n                        } else {\n                            $card.find('.kpi-card-value').text('--');\n                            $card.find('.kpi-card-trend').addClass('d-none');\n                        }\n                    } else {\n                        $card.find('.kpi-card-value').text('--');\n                        $card.find('.kpi-card-trend').addClass('d-none');\n                    }\n                }).fail(function(jqXHR, textStatus) {\n                    // Retry on timeout or server error\n                    if (retryCount < maxRetries && (textStatus === 'timeout' || jqXHR.status >= 500)) {\n                        setTimeout(function() {\n                            self.loadKpiData(report, $card, cardIndex, retryCount + 1);\n                        }, 1000 * (retryCount + 1));\n                    } else {\n                        $card.find('.kpi-card-value').text('--');\n                        $card.find('.kpi-card-trend').addClass('d-none');\n                    }\n                });\n            }\n        },\n\n        /**\n         * Render KPI value on card with trend and sparkline.\n         *\n         * @param {jQuery} $card\n         * @param {Array} data\n         */\n        renderKpiValue: function($card, data) {\n            var slug = $card.data('slug');\n            var source = $card.data('source') || 'wizard';\n            var label = $card.find('.kpi-card-label').text() || '';\n\n            if (!data || data.length === 0) {\n                $card.find('.kpi-card-value').text('0');\n                // Save zero value and update trend from server\n                this.saveKpiHistoryToServer($card, slug, 0, source, label, 0);\n                return;\n            }\n\n            // Find numeric column for KPI value\n            var headers = Object.keys(data[0]);\n            var numericCols = this.detectNumericColumns(data, headers);\n\n            var value;\n            var formattedValue;\n\n            if (numericCols.length > 0) {\n                // Use sum or count of the last numeric column\n                var valueCol = numericCols[numericCols.length - 1];\n\n                // If it's a count/total column, sum all values\n                if (valueCol.toLowerCase().includes('count') ||\n                    valueCol.toLowerCase().includes('total') ||\n                    data.length === 1) {\n                    value = data.reduce(function(sum, row) {\n                        return sum + (parseFloat(row[valueCol]) || 0);\n                    }, 0);\n                } else {\n                    // Otherwise show row count\n                    value = data.length;\n                }\n            } else {\n                // No numeric columns, show row count\n                value = data.length;\n            }\n\n            // Format the value nicely\n            formattedValue = this.formatKpiValue(value);\n\n            $card.find('.kpi-card-value').text(formattedValue);\n\n            // Save to server and update trend/sparkline from response\n            this.saveKpiHistoryToServer($card, slug, value, source, label, data.length);\n        },\n\n        /**\n         * Format a KPI value for display.\n         *\n         * @param {number} value\n         * @return {string}\n         */\n        formatKpiValue: function(value) {\n            if (value >= 1000000) {\n                return (value / 1000000).toFixed(1) + 'M';\n            } else if (value >= 1000) {\n                return (value / 1000).toFixed(1) + 'K';\n            } else if (Number.isInteger(value)) {\n                return value.toLocaleString();\n            } else {\n                return value.toFixed(1);\n            }\n        },\n\n        /**\n         * Save KPI snapshot to backend and update trend/sparkline.\n         * This is an enterprise feature - requires snapshots permission.\n         *\n         * @param {jQuery} $card\n         * @param {string} slug\n         * @param {number} value\n         * @param {string} source Report source (wizard/ai)\n         * @param {string} label Metric label\n         * @param {number} rowCount Number of data rows\n         * @param {number} executionTimeMs Execution time in milliseconds (optional)\n         */\n        saveKpiHistoryToServer: function($card, slug, value, source, label, rowCount, executionTimeMs) {\n            var self = this;\n\n            // Check if snapshots feature is enabled (enterprise feature)\n            if (!this.config.snapshotsEnabled) {\n                // Feature not enabled - hide trend and sparkline\n                $card.find('.kpi-card-trend').addClass('d-none');\n                $card.find('.kpi-card-sparkline').addClass('d-none');\n                return;\n            }\n\n            // For AI reports, use the backend snapshots API\n            if (source === 'ai') {\n                this.postSnapshotToBackend($card, slug, value, executionTimeMs || 0);\n                return;\n            }\n\n            // For wizard reports, also use backend API\n            this.postSnapshotToBackend($card, slug, value, executionTimeMs || 0);\n        },\n\n        /**\n         * Post snapshot to backend API and update trend/sparkline from response.\n         *\n         * @param {jQuery} $card\n         * @param {string} slug Report slug\n         * @param {number} metricValue The actual metric value (e.g., 122 users)\n         * @param {number} executionTimeMs Execution time in milliseconds\n         */\n        postSnapshotToBackend: function($card, slug, metricValue, executionTimeMs) {\n            var self = this;\n            var token = this.apiKey;\n            var source = $card.data('source') || 'wizard';\n\n            if (!token) {\n                $card.find('.kpi-card-trend').addClass('d-none');\n                $card.find('.kpi-card-sparkline').addClass('d-none');\n                return;\n            }\n\n            // Use correct endpoint based on report source\n            var endpoint = (source === 'ai') ? '/ai-reports/' : '/wizard-reports/';\n\n            // Get baseline period from config (default: all_time)\n            var baselinePeriod = this.config.baselinePeriod || 'all_time';\n\n            // Determine history limit based on baseline period for sparkline display\n            var historyLimit = this.getHistoryLimitForBaseline(baselinePeriod);\n\n            $.ajax({\n                url: this.backendUrl + endpoint + encodeURIComponent(slug) +\n                    '/snapshots?baseline_period=' + baselinePeriod + '&history_limit=' + historyLimit,\n                method: 'POST',\n                headers: {\n                    'Authorization': 'Bearer ' + token,\n                    'Content-Type': 'application/json',\n                    'Accept': 'application/json'\n                },\n                data: JSON.stringify({\n                    row_count: metricValue,\n                    execution_time_ms: executionTimeMs,\n                    evaluate_alerts: true,\n                    baseline_period: baselinePeriod\n                }),\n                timeout: 15000\n            }).done(function(response) {\n                if (response.success) {\n                    // Cache the snapshot response for KPI modal use\n                    self.kpiSnapshotCache[slug] = {\n                        history: response.history || [],\n                        trend: response.trend || {},\n                        currentValue: metricValue,\n                        timestamp: Date.now()\n                    };\n\n                    // Register snapshot schedule for cron-based execution on first run\n                    self.registerSnapshotSchedule(slug, source, metricValue);\n\n                    // Update trend from response - now supports dual trends (vs_previous and vs_baseline)\n                    self.updateKpiTrendFromBackend($card, response.trend);\n\n\n                    // Update sparkline from history\n                    if (response.history && response.history.length >= 2) {\n                        self.renderKpiSparklineFromBackend($card, slug, response.history);\n                    } else {\n                        $card.find('.kpi-card-sparkline').addClass('d-none');\n                    }\n\n                    // Handle any triggered alerts - pass context we have here.\n                    if (response.alerts && response.alerts.triggered_count > 0) {\n                        var reportName = $card.find('.kpi-card-label').text() || slug;\n                        self.handleTriggeredAlerts(response.alerts.triggered, slug, metricValue, response.trend, reportName);\n                    }\n                }\n            }).fail(function() {\n                // Silent fail - trend won't update but KPI value is still shown\n                $card.find('.kpi-card-trend').addClass('d-none');\n                $card.find('.kpi-card-sparkline').addClass('d-none');\n            });\n        },\n\n        /**\n         * Register a report for cron-based snapshot scheduling.\n         *\n         * Called on first successful snapshot POST to ensure subsequent\n         * snapshots are taken automatically by cron at the configured interval.\n         *\n         * @param {string} slug Report slug\n         * @param {string} source Report source (wizard or ai)\n         * @param {number} metricValue Initial metric value\n         */\n        registerSnapshotSchedule: function(slug, source, metricValue) {\n            var self = this;\n            var scheduleKey = this.blockId + '_' + slug;\n\n            // Only register once per session per report\n            if (this.registeredSnapshots[scheduleKey]) {\n                return;\n            }\n\n            // Get the history interval from config (in seconds)\n            var intervalSeconds = this.config.kpiHistoryInterval || 3600; // Default 1 hour\n\n            // Call Moodle AJAX to register the schedule\n            Ajax.call([{\n                methodname: 'block_adeptus_insights_register_snapshot_schedule',\n                args: {\n                    blockinstanceid: this.blockId,\n                    reportslug: slug,\n                    reportsource: source,\n                    intervalseconds: intervalSeconds,\n                    rowcount: metricValue\n                }\n            }])[0].done(function(response) {\n                if (response.success) {\n                    // Mark as registered for this session\n                    self.registeredSnapshots[scheduleKey] = true;\n                }\n            }).fail(function() {\n                // Silent fail - schedule registration is not critical for UI\n            });\n        },\n\n        /**\n         * Update KPI trend indicator from backend response.\n         *\n         * @param {jQuery} $card\n         * @param {Object} trend Trend data from backend\n         */\n        updateKpiTrendFromBackend: function($card, trend) {\n            var trendContainer = $card.find('.kpi-card-trend');\n            trendContainer.removeClass('d-none trend-up trend-down trend-neutral');\n\n            // Handle new dual trend structure (vs_baseline and vs_previous)\n            if (trend && (trend.vs_baseline || trend.vs_previous)) {\n                this.updateKpiDualTrend($card, trend);\n                return;\n            }\n\n            // Legacy single trend handling (backward compatibility)\n            if (!trend || !trend.has_previous) {\n                trendContainer.addClass('d-none');\n                return;\n            }\n\n            var direction = trend.direction;\n            var percentage = Math.abs(trend.change_percent || 0);\n            var changeText = this.formatPercentage(percentage);\n\n            if (direction === 'increase') {\n                trendContainer.addClass('trend-up');\n                trendContainer.find('.trend-icon').html('<i class=\"fa fa-arrow-up\"></i>');\n                trendContainer.find('.trend-value').text('+' + changeText + ' vs previous');\n            } else if (direction === 'decrease') {\n                trendContainer.addClass('trend-down');\n                trendContainer.find('.trend-icon').html('<i class=\"fa fa-arrow-down\"></i>');\n                trendContainer.find('.trend-value').text('-' + changeText + ' vs previous');\n            } else {\n                trendContainer.addClass('trend-neutral');\n                trendContainer.find('.trend-icon').html('<i class=\"fa fa-minus\"></i>');\n                trendContainer.find('.trend-value').text('No change');\n            }\n        },\n\n        /**\n         * Update KPI card with dual trend metrics (overall vs baseline, and vs previous).\n         *\n         * @param {jQuery} $card The KPI card element\n         * @param {Object} trend Trend object with vs_baseline and vs_previous\n         */\n        updateKpiDualTrend: function($card, trend) {\n            var trendContainer = $card.find('.kpi-card-trend');\n            trendContainer.removeClass('d-none trend-up trend-down trend-neutral');\n\n            var vsBaseline = trend.vs_baseline || {};\n            var vsPrevious = trend.vs_previous || {};\n            var hasBaseline = vsBaseline.has_baseline;\n            var hasPrevious = vsPrevious.has_previous;\n\n            // If no trend data at all, hide the container\n            if (!hasBaseline && !hasPrevious) {\n                trendContainer.addClass('d-none');\n                return;\n            }\n\n            // Build the dual trend display: \" 25% overall |  8% since last\"\n            var parts = [];\n\n            // Overall trend (vs baseline)\n            if (hasBaseline) {\n                var baselinePct = this.formatPercentage(Math.abs(vsBaseline.change_percent || 0));\n                var baselineIcon = this.getTrendIcon(vsBaseline.direction);\n                var baselineSign = vsBaseline.direction === 'increase' ? '+' : (vsBaseline.direction === 'decrease' ? '-' : '');\n                parts.push(baselineIcon + ' ' + baselineSign + baselinePct + ' overall');\n            }\n\n            // Interval trend (vs previous)\n            if (hasPrevious) {\n                var previousPct = this.formatPercentage(Math.abs(vsPrevious.change_percent || 0));\n                var previousIcon = this.getTrendIcon(vsPrevious.direction);\n                var previousSign = vsPrevious.direction === 'increase' ? '+' : (vsPrevious.direction === 'decrease' ? '-' : '');\n                parts.push(previousIcon + ' ' + previousSign + previousPct + ' since last');\n            }\n\n            // Determine overall trend direction for styling (use baseline as primary)\n            var primaryDirection = hasBaseline ? vsBaseline.direction : vsPrevious.direction;\n            if (primaryDirection === 'increase') {\n                trendContainer.addClass('trend-up');\n            } else if (primaryDirection === 'decrease') {\n                trendContainer.addClass('trend-down');\n            } else {\n                trendContainer.addClass('trend-neutral');\n            }\n\n            // Update the display - hide the icon span and use trend-value for full display\n            trendContainer.find('.trend-icon').html('');\n            trendContainer.find('.trend-value').html(parts.join(' <span class=\"trend-separator\">|</span> '));\n        },\n\n        /**\n         * Get trend icon HTML based on direction.\n         *\n         * @param {string} direction 'increase', 'decrease', or 'stable'\n         * @return {string} HTML for the icon\n         */\n        getTrendIcon: function(direction) {\n            if (direction === 'increase') {\n                return '<i class=\"fa fa-arrow-up trend-icon-up\"></i>';\n            } else if (direction === 'decrease') {\n                return '<i class=\"fa fa-arrow-down trend-icon-down\"></i>';\n            }\n            return '<i class=\"fa fa-minus trend-icon-neutral\"></i>';\n        },\n\n        /**\n         * Format percentage for display.\n         *\n         * @param {number} percentage The percentage value\n         * @return {string} Formatted percentage string\n         */\n        formatPercentage: function(percentage) {\n            if (percentage >= 100) {\n                return Math.round(percentage) + '%';\n            } else if (percentage >= 10) {\n                return percentage.toFixed(0) + '%';\n            }\n            return percentage.toFixed(1) + '%';\n        },\n\n        /**\n         * Format a number with thousands separator.\n         *\n         * @param {number|string} value The value to format\n         * @return {string} Formatted number string\n         */\n        formatNumber: function(value) {\n            if (value === null || value === undefined || value === '--') {\n                return '--';\n            }\n            var num = parseFloat(value);\n            if (isNaN(num)) {\n                return value.toString();\n            }\n            // For large numbers, add thousands separator\n            if (Math.abs(num) >= 1000) {\n                return num.toLocaleString();\n            }\n            // For decimals, limit to 2 decimal places\n            if (num % 1 !== 0) {\n                return num.toFixed(2);\n            }\n            return num.toString();\n        },\n\n        /**\n         * Format a timestamp to a readable date/time string.\n         *\n         * @param {string} timestamp The timestamp to format\n         * @return {string} Formatted date/time string\n         */\n        formatTimestamp: function(timestamp) {\n            if (!timestamp) {\n                return '';\n            }\n            var date = new Date(timestamp);\n            var now = new Date();\n            var diffMs = now - date;\n            var diffMins = Math.floor(diffMs / 60000);\n            var diffHours = Math.floor(diffMins / 60);\n            var diffDays = Math.floor(diffHours / 24);\n\n            if (diffMins < 1) {\n                return 'just now';\n            } else if (diffMins < 60) {\n                return diffMins + ' min ago';\n            } else if (diffHours < 24) {\n                return diffHours + ' hour' + (diffHours > 1 ? 's' : '') + ' ago';\n            } else if (diffDays < 7) {\n                return diffDays + ' day' + (diffDays > 1 ? 's' : '') + ' ago';\n            }\n            // For older dates, show full date\n            var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',\n                          'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];\n            return months[date.getMonth()] + ' ' + date.getDate() + ', ' + date.getFullYear();\n        },\n\n        /**\n         * Get appropriate history limit based on baseline period.\n         *\n         * Returns a reasonable number of data points for the sparkline\n         * based on the selected baseline period.\n         *\n         * @param {string} baselinePeriod The baseline period setting\n         * @return {number} Number of history entries to request\n         */\n        getHistoryLimitForBaseline: function(baselinePeriod) {\n            switch (baselinePeriod) {\n                case 'all_time':\n                    return 100; // Get all available history\n                case 'rolling_30d':\n                    return 60; // ~2 per day for 30 days\n                case 'month_start':\n                    return 62; // ~2 per day for a month\n                case 'rolling_7d':\n                    return 14; // ~2 per day for 7 days\n                case 'week_start':\n                    return 14; // ~2 per day for a week\n                default:\n                    return 30; // Default reasonable limit\n            }\n        },\n\n        /**\n         * Render sparkline from backend history data.\n         *\n         * @param {jQuery} $card\n         * @param {string} slug\n         * @param {Array} history History data from backend\n         */\n        renderKpiSparklineFromBackend: function($card, slug, history) {\n            // Convert backend history format to sparkline data\n            var sparklineData = history.map(function(point) {\n                return point.row_count;\n            }).reverse(); // Oldest first for chart\n\n            this.renderKpiSparklineFromData($card, slug, sparklineData, sparklineData[sparklineData.length - 1]);\n        },\n\n        /**\n         * Handle triggered alerts from snapshot response.\n         *\n         * Sends notifications via Moodle's messaging system to configured recipients.\n         * Notifications appear in the bell icon notification area.\n         *\n         * @param {Array} triggeredAlerts Array of triggered alert objects\n         * @param {string} reportSlug Report slug from snapshot context\n         * @param {number} currentValue Current metric value from snapshot context\n         * @param {Object} trend Trend data from snapshot response (optional)\n         * @param {string} reportName Human-readable report name (optional)\n         */\n        handleTriggeredAlerts: function(triggeredAlerts, reportSlug, currentValue, trend, reportName) {\n            var self = this;\n\n            if (!triggeredAlerts || triggeredAlerts.length === 0) {\n                return;\n            }\n\n            // Prepare alerts data for the Moodle notification API.\n            // Alerts fire once and are archived - no cooldown period needed.\n            // Use context values (reportSlug, currentValue) as fallbacks since backend may not include them.\n            var alertsConfig = self.config.alertsConfig || [];\n\n            var alertsToSend = triggeredAlerts.map(function(alert) {\n                var alertName = alert.alert_name || alert.name || 'Alert';\n                var value = parseFloat(alert.current_value || alert.actual_value || alert.value || currentValue || 0);\n                var displayReportName = reportName || alert.report_name || reportSlug || 'Report';\n                var alertId = alert.id || alert.alert_id || 0;\n\n                // Look up local config to determine correct severity based on thresholds.\n                var localConfig = null;\n                for (var i = 0; i < alertsConfig.length; i++) {\n                    if (alertsConfig[i].backend_id === alertId) {\n                        localConfig = alertsConfig[i];\n                        break;\n                    }\n                }\n\n                // Determine severity by comparing value against warning and critical thresholds.\n                var severity = 'warning';\n                var thresholdValue = alert.threshold || alert.threshold_value || '';\n                if (localConfig) {\n                    var warningThreshold = parseFloat(localConfig.warning_value) || 0;\n                    var criticalThreshold = parseFloat(localConfig.critical_value) || 0;\n\n                    // Check which threshold was exceeded (critical takes priority).\n                    if (criticalThreshold > 0 && value >= criticalThreshold) {\n                        severity = 'critical';\n                        thresholdValue = criticalThreshold;\n                    } else if (warningThreshold > 0 && value >= warningThreshold) {\n                        severity = 'warning';\n                        thresholdValue = warningThreshold;\n                    }\n                } else {\n                    // Fall back to backend-provided severity if no local config.\n                    severity = alert.severity || (alert.is_critical ? 'critical' : 'warning');\n                }\n\n                // Build a meaningful message with context and trend info.\n                // Format: \"Your {report_name} has reached {value}, exceeding your {severity} threshold ({threshold}).\n                //          {alert_name} increased/decreased by X (Y%) since last measurement.\"\n                var message = 'Your ' + displayReportName + ' has reached ' + value +\n                    ', exceeding your ' + severity + ' threshold (' + thresholdValue + ').';\n\n                // Add trend information if available.\n                if (trend && trend.has_previous) {\n                    var direction = trend.direction || 'change';\n                    var changeAbs = Math.abs(trend.change_absolute || 0);\n                    var changePct = Math.abs(trend.change_percent || 0).toFixed(1);\n\n                    if (direction === 'increase') {\n                        message += ' ' + alertName + ' increased by ' + changeAbs + ' (' + changePct + '%) since last measurement.';\n                    } else if (direction === 'decrease') {\n                        message += ' ' + alertName + ' decreased by ' + changeAbs + ' (' + changePct + '%) since last measurement.';\n                    } else {\n                        message += ' ' + alertName + ' has remained stable since last measurement.';\n                    }\n                }\n\n                return {\n                    alert_id: alertId,\n                    alert_name: alertName,\n                    message: message,\n                    severity: severity,\n                    report_name: displayReportName,\n                    report_slug: alert.report_slug || alert.slug || reportSlug || '',\n                    current_value: String(value),\n                    threshold: String(thresholdValue),\n                    notify_users: JSON.stringify(alert.notify_users || [])\n                };\n            });\n\n            // Send notifications via Moodle's messaging system (silent - no on-page alerts).\n            require(['core/ajax'], function(Ajax) {\n                Ajax.call([{\n                    methodname: 'block_adeptus_insights_send_alert_notification',\n                    args: {\n                        blockinstanceid: self.blockId,\n                        alerts: alertsToSend\n                    }\n                }])[0].done(function(response) {\n                    if (response.success && response.sent_count > 0) {\n                        // Trigger notification area refresh so bell icon updates.\n                        // Small delay to ensure notification is fully committed to database.\n                        setTimeout(function() {\n                            self.refreshNotificationArea();\n                        }, 500);\n                    }\n                }).fail(function() {\n                    // Silent fail - notifications will appear on next poll.\n                });\n            });\n        },\n\n        /**\n         * Refresh the Moodle notification area to show new notifications.\n         * Calls the Moodle API to get the unread count and updates the badge.\n         */\n        refreshNotificationArea: function() {\n            require(['jquery', 'core/ajax'], function($, Ajax) {\n                try {\n                    // Find the notification popover container and get user ID.\n                    var $popover = $('#nav-notification-popover-container');\n                    if (!$popover.length) {\n                        return;\n                    }\n\n                    var userId = $popover.attr('data-userid');\n                    if (!userId) {\n                        return;\n                    }\n\n                    // Call Moodle API to get unread notification count.\n                    Ajax.call([{\n                        methodname: 'message_popup_get_unread_popup_notification_count',\n                        args: {\n                            useridto: parseInt(userId, 10)\n                        }\n                    }])[0].done(function(count) {\n                        // Update the notification badge in the DOM.\n                        var $countContainer = $popover.find('[data-region=\"count-container\"]');\n                        if ($countContainer.length) {\n                            if (count > 0) {\n                                $countContainer.text(count);\n                                $countContainer.removeClass('hidden');\n                            } else {\n                                $countContainer.addClass('hidden');\n                            }\n                        }\n                    }).fail(function() {\n                        // Silent fail - notifications will appear on next page load.\n                    });\n                } catch (e) {\n                    // Silent fail.\n                }\n            });\n        },\n\n        /**\n         * Load KPI history from server for sparkline (legacy - kept for backward compatibility).\n         *\n         * @param {jQuery} $card\n         * @param {string} slug\n         * @param {number} currentValue\n         * @deprecated Use postSnapshotToBackend instead which returns history in response\n         */\n        loadKpiSparklineFromServer: function($card, slug, currentValue) {\n            // This is now handled by postSnapshotToBackend which returns history in response\n            // Keeping this method for any legacy code paths\n            if (!this.config.snapshotsEnabled) {\n                $card.find('.kpi-card-sparkline').addClass('d-none');\n                return;\n            }\n            // Sparkline is now loaded from snapshot response, no separate call needed\n        },\n\n        /**\n         * Update KPI trend indicator from server response.\n         *\n         * @param {jQuery} $card\n         * @param {string} direction Trend direction (up/down/neutral)\n         * @param {number} percentage Trend percentage\n         */\n        updateKpiTrendFromServer: function($card, direction, percentage) {\n            var trendContainer = $card.find('.kpi-card-trend');\n            trendContainer.removeClass('d-none trend-up trend-down trend-neutral');\n\n            var absChange = Math.abs(percentage);\n            var changeText;\n            if (absChange >= 100) {\n                changeText = Math.round(absChange) + '%';\n            } else if (absChange >= 10) {\n                changeText = absChange.toFixed(0) + '%';\n            } else {\n                changeText = absChange.toFixed(1) + '%';\n            }\n\n            if (direction === 'up') {\n                trendContainer.addClass('trend-up');\n                trendContainer.find('.trend-icon').html('<i class=\"fa fa-arrow-up\"></i>');\n                trendContainer.find('.trend-value').text(changeText + ' vs previous');\n            } else if (direction === 'down') {\n                trendContainer.addClass('trend-down');\n                trendContainer.find('.trend-icon').html('<i class=\"fa fa-arrow-down\"></i>');\n                trendContainer.find('.trend-value').text(changeText + ' vs previous');\n            } else {\n                trendContainer.addClass('trend-neutral');\n                trendContainer.find('.trend-icon').html('<i class=\"fa fa-minus\"></i>');\n                trendContainer.find('.trend-value').text('No change');\n            }\n        },\n\n        /**\n         * Legacy method for backwards compatibility.\n         *\n         * @param {jQuery} $card\n         * @param {string} slug\n         * @param {number} currentValue\n         */\n        updateKpiTrend: function($card, slug, currentValue) {\n            // Show neutral trend initially, server call will update\n            var trendContainer = $card.find('.kpi-card-trend');\n            trendContainer.removeClass('d-none');\n            trendContainer.addClass('trend-neutral');\n            trendContainer.find('.trend-icon').html('<i class=\"fa fa-spinner fa-spin\"></i>');\n            trendContainer.find('.trend-value').text('Loading...');\n        },\n\n        /**\n         * Render sparkline chart from server data.\n         *\n         * @param {jQuery} $card\n         * @param {string} slug\n         * @param {Array} sparklineData Array of values\n         * @param {number} currentValue Current value to append\n         */\n        renderKpiSparklineFromData: function($card, slug, sparklineData, currentValue) {\n            var sparklineContainer = $card.find('.kpi-card-sparkline');\n            var canvas = sparklineContainer.find('.sparkline-chart')[0];\n\n            if (!canvas) {\n                return;\n            }\n\n            // Build data points array\n            var dataPoints = sparklineData.slice();\n            // Add current value if different from last\n            if (dataPoints.length === 0 || dataPoints[dataPoints.length - 1] !== currentValue) {\n                dataPoints.push(currentValue);\n            }\n\n            // Need at least 2 points for a meaningful sparkline\n            if (dataPoints.length < 2) {\n                sparklineContainer.addClass('d-none');\n                return;\n            }\n\n            sparklineContainer.removeClass('d-none');\n\n            // Determine sparkline color based on overall trend\n            var firstValue = dataPoints[0];\n            var lastValue = dataPoints[dataPoints.length - 1];\n            var trendColor = lastValue >= firstValue ? 'rgba(40, 167, 69, 0.8)' : 'rgba(220, 53, 69, 0.8)';\n            var trendBgColor = lastValue >= firstValue ? 'rgba(40, 167, 69, 0.1)' : 'rgba(220, 53, 69, 0.1)';\n\n            // Destroy existing chart if any\n            var chartKey = 'sparkline_' + this.blockId + '_' + slug;\n            if (this.kpiSparklineCharts && this.kpiSparklineCharts[chartKey]) {\n                this.kpiSparklineCharts[chartKey].destroy();\n            }\n\n            // Initialize chart storage\n            if (!this.kpiSparklineCharts) {\n                this.kpiSparklineCharts = {};\n            }\n\n            // Create sparkline chart\n            try {\n                this.kpiSparklineCharts[chartKey] = new Chart(canvas.getContext('2d'), {\n                    type: 'line',\n                    data: {\n                        labels: dataPoints.map(function() { return ''; }),\n                        datasets: [{\n                            data: dataPoints,\n                            borderColor: trendColor,\n                            backgroundColor: trendBgColor,\n                            borderWidth: 2,\n                            fill: true,\n                            tension: 0.4,\n                            pointRadius: 0,\n                            pointHoverRadius: 0\n                        }]\n                    },\n                    options: {\n                        responsive: true,\n                        maintainAspectRatio: false,\n                        plugins: {\n                            legend: { display: false },\n                            tooltip: { enabled: false }\n                        },\n                        scales: {\n                            x: { display: false },\n                            y: { display: false }\n                        },\n                        elements: {\n                            line: { borderCapStyle: 'round' }\n                        },\n                        animation: { duration: 500 }\n                    }\n                });\n            } catch (e) {\n                // Chart.js not available or error\n                sparklineContainer.addClass('d-none');\n            }\n        },\n\n        /**\n         * Legacy method for backwards compatibility.\n         *\n         * @param {jQuery} $card\n         * @param {string} slug\n         * @param {number} currentValue\n         */\n        renderKpiSparkline: function($card, slug, currentValue) {\n            // Sparkline is loaded via loadKpiSparklineFromServer\n            // This is a no-op for backwards compatibility\n        },\n\n        /**\n         * Render tabbed reports mode.\n         *\n         * @param {Array} reports\n         */\n        renderTabs: function(reports) {\n            var self = this;\n            var tabNav = this.container.find('.block-adeptus-tab-nav');\n            var tabContent = this.container.find('.block-adeptus-tab-content');\n            var tabTemplate = $('#block-adeptus-tab-template-' + this.blockId);\n            var paneTemplate = $('#block-adeptus-tab-pane-template-' + this.blockId);\n            var maxTabs = 5;\n\n            tabNav.empty();\n            tabContent.empty();\n\n            // Store tab chart instances\n            this.tabChartInstances = {};\n\n            reports.slice(0, maxTabs).forEach(function(report, index) {\n                var tabId = 'tab-' + self.blockId + '-' + index;\n                var reportName = report.name || report.title || report.display_name || report.slug || 'Report';\n\n                // Create tab\n                var tab = $(tabTemplate.html());\n                tab.find('a')\n                    .attr('href', '#' + tabId)\n                    .attr('aria-controls', tabId);\n                tab.find('.tab-name').text(reportName);\n\n                if (index === 0) {\n                    tab.find('a').addClass('active').attr('aria-selected', 'true');\n                }\n\n                tabNav.append(tab);\n\n                // Create pane\n                var pane = $(paneTemplate.html());\n                pane.attr('id', tabId);\n                pane.attr('data-slug', report.slug);\n                pane.attr('data-source', report.source);\n\n                if (index === 0) {\n                    pane.addClass('show active');\n                }\n\n                tabContent.append(pane);\n            });\n\n            // Load first tab content\n            if (reports.length > 0) {\n                var firstPane = tabContent.find('.tab-pane').first();\n                this.loadTabContent(firstPane, reports[0].slug, reports[0].source);\n            }\n\n            this.container.find('.block-adeptus-tabs-container').removeClass('d-none');\n        },\n\n        /**\n         * Load content for a tab.\n         *\n         * @param {jQuery} pane\n         * @param {string} slug\n         * @param {string} source\n         */\n        loadTabContent: function(pane, slug, source) {\n            var self = this;\n            var cacheKey = slug + '_' + source;\n            pane.data('loaded', true);\n\n            // Check cache first\n            if (this.reportDataCache[cacheKey]) {\n                var cached = this.reportDataCache[cacheKey];\n                this.renderTabContent(pane, cached.report, cached.results);\n                return;\n            }\n\n            // Find the report from our cached list\n            var report = this.reports.find(function(r) {\n                return r.slug === slug;\n            });\n\n            if (!report) {\n                pane.find('.tab-pane-loading').addClass('d-none');\n                pane.find('.tab-pane-content')\n                    .removeClass('d-none')\n                    .html('<div class=\"text-center text-muted py-4\"><i class=\"fa fa-exclamation-circle\"></i><p class=\"mt-2\">Report not found</p></div>');\n                return;\n            }\n\n            // Load data based on source\n            if (source === 'wizard') {\n                $.ajax({\n                    url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/generate_report.php',\n                    method: 'POST',\n                    data: {\n                        reportid: report.name || report.report_template_id,\n                        sesskey: M.cfg.sesskey\n                    },\n                    dataType: 'json',\n                    timeout: 30000\n                }).done(function(response) {\n                    if (response.success) {\n                        self.reportDataCache[cacheKey] = {\n                            report: report,\n                            results: response.results || []\n                        };\n                        self.renderTabContent(pane, report, response.results || []);\n                    } else {\n                        pane.find('.tab-pane-loading').addClass('d-none');\n                        pane.find('.tab-pane-content')\n                            .removeClass('d-none')\n                            .html('<div class=\"text-center text-muted py-4\"><i class=\"fa fa-exclamation-circle\"></i><p class=\"mt-2\">' + (response.message || 'Failed to load') + '</p></div>');\n                    }\n                }).fail(function() {\n                    pane.find('.tab-pane-loading').addClass('d-none');\n                    pane.find('.tab-pane-content')\n                        .removeClass('d-none')\n                        .html('<div class=\"text-center text-muted py-4\"><i class=\"fa fa-exclamation-circle\"></i><p class=\"mt-2\">Connection error</p></div>');\n                });\n            } else {\n                // AI reports\n                var token = this.apiKey || (window.adeptusAuthData ? window.adeptusAuthData.api_key : null);\n                if (!token) {\n                    pane.find('.tab-pane-loading').addClass('d-none');\n                    pane.find('.tab-pane-content')\n                        .removeClass('d-none')\n                        .html('<div class=\"text-center text-muted py-4\"><i class=\"fa fa-exclamation-circle\"></i><p class=\"mt-2\">Authentication required</p></div>');\n                    return;\n                }\n\n                $.ajax({\n                    url: '' + this.backendUrl + '/ai-reports/' + slug,\n                    method: 'GET',\n                    headers: {\n                        'Authorization': 'Bearer ' + token,\n                        'Accept': 'application/json'\n                    },\n                    timeout: 15000\n                }).done(function(response) {\n                    if (response.success) {\n                        var reportData = response.report || report;\n                        var data = response.data || [];\n\n                        // Check if local execution is required (SaaS model)\n                        var sqlQuery = response.sql || (reportData && reportData.sql_query) || (reportData && reportData.sql);\n                        var needsLocalExecution = response.execution_required || ((!data || data.length === 0) && sqlQuery);\n\n                        if (needsLocalExecution && sqlQuery) {\n                            // Execute SQL locally against Moodle database\n                            self.executeReportLocally(sqlQuery, reportData.params || {})\n                                .then(function(executionResult) {\n                                    var localData = executionResult.data || [];\n                                    self.reportDataCache[cacheKey] = {\n                                        report: reportData,\n                                        results: localData\n                                    };\n                                    self.renderTabContent(pane, reportData, localData);\n                                })\n                                .catch(function(error) {\n                                    pane.find('.tab-pane-loading').addClass('d-none');\n                                    pane.find('.tab-pane-content')\n                                        .removeClass('d-none')\n                                        .html('<div class=\"text-center text-muted py-4\"><i class=\"fa fa-exclamation-circle\"></i><p class=\"mt-2\">Failed to execute report</p></div>');\n                                });\n                            return;\n                        }\n\n                        self.reportDataCache[cacheKey] = {\n                            report: reportData,\n                            results: data\n                        };\n                        self.renderTabContent(pane, reportData, data);\n                    } else {\n                        pane.find('.tab-pane-loading').addClass('d-none');\n                        pane.find('.tab-pane-content')\n                            .removeClass('d-none')\n                            .html('<div class=\"text-center text-muted py-4\"><i class=\"fa fa-exclamation-circle\"></i><p class=\"mt-2\">Failed to load report</p></div>');\n                    }\n                }).fail(function() {\n                    pane.find('.tab-pane-loading').addClass('d-none');\n                    pane.find('.tab-pane-content')\n                        .removeClass('d-none')\n                        .html('<div class=\"text-center text-muted py-4\"><i class=\"fa fa-exclamation-circle\"></i><p class=\"mt-2\">Connection error</p></div>');\n                });\n            }\n        },\n\n        /**\n         * Render tab content with report data - consistent with embedded/modal design.\n         *\n         * @param {jQuery} pane\n         * @param {Object} report\n         * @param {Array} data\n         */\n        renderTabContent: function(pane, report, data) {\n            var tabId = pane.attr('id');\n            pane.find('.tab-pane-loading').addClass('d-none');\n            var contentArea = pane.find('.tab-pane-content');\n\n            if (!data || data.length === 0) {\n                contentArea.removeClass('d-none')\n                    .html('<div class=\"text-center text-muted py-4\"><i class=\"fa fa-inbox\"></i><p class=\"mt-2\">No data available</p></div>');\n                return;\n            }\n\n            // Detect headers and numeric columns\n            var headers = Object.keys(data[0]);\n            var numericCols = this.detectNumericColumns(data, headers);\n\n            // Initialize state for this tab pane\n            var state = {\n                data: data,\n                report: report,\n                headers: headers,\n                numericCols: numericCols,\n                currentView: 'table',\n                tablePage: 1,\n                rowsPerPage: 25,\n                chartType: 'bar',\n                xAxis: headers[0],\n                yAxis: numericCols.length > 0 ? numericCols[numericCols.length - 1] : headers[headers.length - 1]\n            };\n            this.tabPaneStates[tabId] = state;\n\n            // Show content area\n            contentArea.removeClass('d-none');\n\n            // Update meta bar\n            this.updateTabMetaBar(pane, report, data);\n\n            // Populate chart axis selectors\n            this.populateTabChartControls(pane, state);\n\n            // Render table (default view)\n            this.renderTabTablePage(pane, state);\n\n            // Reset view toggle to table\n            pane.find('.tab-view-toggle-btn').removeClass('active');\n            pane.find('.tab-view-toggle-btn[data-view=\"table\"]').addClass('active');\n            pane.find('.tab-table-view').removeClass('d-none');\n            pane.find('.tab-chart-view').addClass('d-none');\n        },\n\n        /**\n         * Update tab meta bar with report info.\n         *\n         * @param {jQuery} pane\n         * @param {Object} report\n         * @param {Array} data\n         */\n        updateTabMetaBar: function(pane, report, data) {\n            // Category badge\n            var category = report.category || report.category_name || '';\n            var categoryBadge = pane.find('.report-category');\n            if (category) {\n                categoryBadge.text(category).removeClass('d-none');\n                // Add category color if available\n                if (report.category_color) {\n                    categoryBadge.css('background-color', report.category_color);\n                } else {\n                    categoryBadge.addClass('bg-primary');\n                }\n            } else {\n                categoryBadge.addClass('d-none');\n            }\n\n            // Row count\n            pane.find('.row-count-num').text(data.length);\n\n            // Report date\n            var dateStr = report.updated_at || report.created_at || '';\n            if (dateStr) {\n                var date = new Date(dateStr);\n                pane.find('.report-date').text(date.toLocaleDateString());\n            }\n        },\n\n        /**\n         * Populate chart control selectors for a tab.\n         *\n         * @param {jQuery} pane\n         * @param {Object} state\n         */\n        populateTabChartControls: function(pane, state) {\n            var xAxisSelect = pane.find('.tab-chart-x-axis');\n            var yAxisSelect = pane.find('.tab-chart-y-axis');\n\n            xAxisSelect.empty();\n            yAxisSelect.empty();\n\n            state.headers.forEach(function(header) {\n                var formatted = header.replace(/_/g, ' ').replace(/\\b\\w/g, function(l) { return l.toUpperCase(); });\n                xAxisSelect.append($('<option>').val(header).text(formatted));\n                yAxisSelect.append($('<option>').val(header).text(formatted));\n            });\n\n            // Set default selections\n            xAxisSelect.val(state.xAxis);\n            yAxisSelect.val(state.yAxis);\n        },\n\n        /**\n         * Switch view in a tab pane (table/chart).\n         *\n         * @param {jQuery} pane\n         * @param {string} view - 'table' or 'chart'\n         */\n        switchTabView: function(pane, view) {\n            var tabId = pane.attr('id');\n            var state = this.tabPaneStates[tabId];\n            if (!state) return;\n\n            state.currentView = view;\n\n            // Update toggle buttons\n            pane.find('.tab-view-toggle-btn').removeClass('active');\n            pane.find('.tab-view-toggle-btn[data-view=\"' + view + '\"]').addClass('active');\n\n            // Show/hide views\n            if (view === 'table') {\n                pane.find('.tab-table-view').removeClass('d-none');\n                pane.find('.tab-chart-view').addClass('d-none');\n            } else {\n                pane.find('.tab-table-view').addClass('d-none');\n                pane.find('.tab-chart-view').removeClass('d-none');\n                // Render chart if not already rendered\n                this.renderTabChart(pane, state);\n            }\n        },\n\n        /**\n         * Render table page in tab pane with pagination.\n         *\n         * @param {jQuery} pane\n         * @param {Object} state\n         */\n        renderTabTablePage: function(pane, state) {\n            var table = pane.find('.tab-table');\n            var thead = table.find('thead');\n            var tbody = table.find('tbody');\n            var data = state.data;\n            var headers = state.headers;\n\n            thead.empty();\n            tbody.empty();\n\n            // Build header row\n            var headerRow = $('<tr>');\n            headers.forEach(function(h) {\n                var formatted = h.replace(/_/g, ' ').replace(/\\b\\w/g, function(l) { return l.toUpperCase(); });\n                headerRow.append($('<th>').text(formatted));\n            });\n            thead.append(headerRow);\n\n            // Calculate pagination\n            var totalRows = data.length;\n            var totalPages = Math.ceil(totalRows / state.rowsPerPage);\n            var startIndex = (state.tablePage - 1) * state.rowsPerPage;\n            var endIndex = Math.min(startIndex + state.rowsPerPage, totalRows);\n            var pageData = data.slice(startIndex, endIndex);\n\n            // Render rows\n            pageData.forEach(function(row) {\n                var tr = $('<tr>');\n                headers.forEach(function(h) {\n                    var val = row[h];\n                    if (val === null || val === undefined) val = '';\n                    var displayVal = String(val);\n                    if (displayVal.length > 50) {\n                        displayVal = displayVal.substring(0, 50) + '...';\n                    }\n                    tr.append($('<td>').attr('title', val).text(displayVal));\n                });\n                tbody.append(tr);\n            });\n\n            // Update pagination info\n            var showingText = 'Showing ' + (startIndex + 1) + '-' + endIndex + ' of ' + totalRows;\n            pane.find('.row-count').text(showingText);\n            pane.find('.tab-pagination-info').text('Page ' + state.tablePage + ' of ' + totalPages);\n\n            // Update pagination buttons\n            pane.find('.tab-pagination-prev').prop('disabled', state.tablePage <= 1);\n            pane.find('.tab-pagination-next').prop('disabled', state.tablePage >= totalPages);\n\n            // Show/hide pagination\n            if (totalPages > 1) {\n                pane.find('.tab-table-pagination').removeClass('d-none');\n            } else {\n                pane.find('.tab-table-pagination').addClass('d-none');\n            }\n        },\n\n        /**\n         * Render chart in tab pane with current settings.\n         *\n         * @param {jQuery} pane\n         * @param {Object} state\n         */\n        renderTabChart: function(pane, state) {\n            var tabId = pane.attr('id');\n            var canvas = pane.find('.tab-chart')[0];\n\n            if (!canvas || !state.data || state.data.length === 0) {\n                return;\n            }\n\n            // Destroy existing chart for this tab\n            if (this.tabChartInstances && this.tabChartInstances[tabId]) {\n                this.tabChartInstances[tabId].destroy();\n            }\n\n            var chartType = state.chartType;\n            var xAxis = state.xAxis;\n            var yAxis = state.yAxis;\n            var data = state.data;\n\n            // Limit data for chart\n            var chartData = data.slice(0, 20);\n            var labels = chartData.map(function(row) {\n                var label = row[xAxis];\n                if (label === null || label === undefined) return 'Unknown';\n                var labelStr = String(label);\n                return labelStr.length > 20 ? labelStr.substring(0, 20) + '...' : labelStr;\n            });\n            var values = chartData.map(function(row) {\n                return parseFloat(row[yAxis]) || 0;\n            });\n\n            var colors = this.generateChartColors(values.length, chartType);\n            var yAxisFormatted = yAxis.replace(/_/g, ' ').replace(/\\b\\w/g, function(l) { return l.toUpperCase(); });\n\n            var config = {\n                type: chartType,\n                data: {\n                    labels: labels,\n                    datasets: [{\n                        label: yAxisFormatted,\n                        data: values,\n                        backgroundColor: chartType === 'pie' || chartType === 'doughnut' ? colors : colors[0],\n                        borderColor: chartType === 'line' ? colors[0] : (chartType === 'pie' || chartType === 'doughnut' ? '#fff' : colors[0]),\n                        borderWidth: chartType === 'pie' || chartType === 'doughnut' ? 2 : 1,\n                        fill: chartType === 'line' ? false : undefined,\n                        tension: chartType === 'line' ? 0.1 : undefined\n                    }]\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    plugins: {\n                        legend: {\n                            display: chartType === 'pie' || chartType === 'doughnut',\n                            position: 'right'\n                        }\n                    },\n                    scales: chartType === 'pie' || chartType === 'doughnut' ? {} : {\n                        y: { beginAtZero: true },\n                        x: { display: data.length <= 10 }\n                    }\n                }\n            };\n\n            try {\n                this.tabChartInstances = this.tabChartInstances || {};\n                this.tabChartInstances[tabId] = new Chart(canvas.getContext('2d'), config);\n            } catch (error) {\n                pane.find('.tab-chart-container').html(\n                    '<div class=\"alert alert-warning text-center\"><i class=\"fa fa-exclamation-circle\"></i> Could not render chart</div>'\n                );\n            }\n        },\n\n        /**\n         * Export report data from a tab.\n         *\n         * @param {Object} state - Tab pane state\n         * @param {string} format - Export format (csv)\n         */\n        exportTabReport: function(state, format) {\n            if (!state || !state.data || state.data.length === 0) {\n                return;\n            }\n\n            if (format === 'csv') {\n                var headers = state.headers;\n                var csvRows = [];\n\n                // Header row\n                csvRows.push(headers.map(function(h) {\n                    return '\"' + h.replace(/\"/g, '\"\"') + '\"';\n                }).join(','));\n\n                // Data rows\n                state.data.forEach(function(row) {\n                    var rowData = headers.map(function(h) {\n                        var val = row[h];\n                        if (val === null || val === undefined) val = '';\n                        return '\"' + String(val).replace(/\"/g, '\"\"') + '\"';\n                    });\n                    csvRows.push(rowData.join(','));\n                });\n\n                var csvContent = csvRows.join('\\n');\n                var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });\n                var url = URL.createObjectURL(blob);\n                var link = document.createElement('a');\n                var reportName = state.report.name || state.report.slug || 'report';\n                link.href = url;\n                link.download = reportName.replace(/[^a-z0-9]/gi, '_') + '.csv';\n                document.body.appendChild(link);\n                link.click();\n                document.body.removeChild(link);\n                URL.revokeObjectURL(url);\n            }\n        },\n\n        /**\n         * Render table in tab pane (legacy fallback).\n         *\n         * @param {jQuery} pane\n         * @param {Array} data\n         */\n        renderTabTable: function(pane, data) {\n            var table = pane.find('table');\n            var thead = table.find('thead');\n            var tbody = table.find('tbody');\n            var maxRows = this.config.tableMaxRows || 10;\n\n            thead.empty();\n            tbody.empty();\n\n            if (!data || data.length === 0) {\n                return;\n            }\n\n            var headers = Object.keys(data[0]);\n            var headerRow = $('<tr>');\n            headers.forEach(function(h) {\n                var formatted = h.replace(/_/g, ' ').replace(/\\b\\w/g, function(l) { return l.toUpperCase(); });\n                headerRow.append($('<th>').text(formatted));\n            });\n            thead.append(headerRow);\n\n            data.slice(0, maxRows).forEach(function(row) {\n                var tr = $('<tr>');\n                headers.forEach(function(h) {\n                    var val = row[h];\n                    if (val === null || val === undefined) val = '';\n                    var displayVal = String(val);\n                    if (displayVal.length > 40) {\n                        displayVal = displayVal.substring(0, 40) + '...';\n                    }\n                    tr.append($('<td>').attr('title', val).text(displayVal));\n                });\n                tbody.append(tr);\n            });\n        },\n\n        /**\n         * Handle report click.\n         *\n         * @param {string} slug\n         * @param {string} source\n         */\n        handleReportClick: function(slug, source) {\n            var action = this.config.clickAction || 'modal';\n\n            // Check if we should open the enhanced KPI modal\n            // Only for KPI display mode with alerts feature enabled (enterprise gate)\n            if (this.config.displayMode === 'kpi' && this.config.alertsFeatureEnabled && action === 'modal') {\n                this.openKpiModal(slug, source);\n                return;\n            }\n\n            switch (action) {\n                case 'modal':\n                    this.openReportModal(slug, source);\n                    break;\n                case 'newtab':\n                    this.openReportNewTab(slug, source);\n                    break;\n                case 'expand':\n                    this.expandReportInline(slug, source);\n                    break;\n            }\n        },\n\n        /**\n         * Open report in modal.\n         *\n         * @param {string} slug\n         * @param {string} source\n         */\n        openReportModal: function(slug, source) {\n            var self = this;\n\n            // Find report data.\n            var report = this.reports.find(function(r) {\n                return r.slug === slug;\n            });\n\n            if (!report) {\n                return;\n            }\n\n            // Reset state\n            this.modalData = null;\n            this.modalReport = null;\n            this.currentView = 'table';\n            if (this.chartInstance) {\n                this.chartInstance.destroy();\n                this.chartInstance = null;\n            }\n\n            // First render the template, then create the modal with the rendered body\n            Templates.render('block_adeptus_insights/report_modal', {blockid: this.blockId})\n                .then(function(html) {\n                    return ModalFactory.create({\n                        type: ModalFactory.types.DEFAULT,\n                        title: report.name,\n                        body: html,\n                        large: true\n                    });\n                })\n                .then(function(modal) {\n                    self.modal = modal;\n\n                    // Bind modal event handlers\n                    self.bindModalEvents(modal);\n\n                    // Load report data after modal is shown.\n                    modal.getRoot().on(ModalEvents.shown, function() {\n                        self.loadModalReport(slug, source);\n                    });\n\n                    // Cleanup on close.\n                    modal.getRoot().on(ModalEvents.hidden, function() {\n                        if (self.chartInstance) {\n                            self.chartInstance.destroy();\n                            self.chartInstance = null;\n                        }\n                        modal.destroy();\n                        self.modal = null;\n                        self.modalData = null;\n                        self.modalReport = null;\n                    });\n\n                    modal.show();\n                    return modal;\n                }).catch(Notification.exception);\n        },\n\n        /**\n         * Open enhanced KPI modal with interactive chart and date range filter.\n         * This is used when displayMode is 'kpi' and alertsFeatureEnabled is true.\n         *\n         * @param {string} slug\n         * @param {string} source\n         */\n        openKpiModal: function(slug, source) {\n            var self = this;\n\n            // Find report data.\n            var report = this.reports.find(function(r) {\n                return r.slug === slug;\n            });\n\n            if (!report) {\n                return;\n            }\n\n            // Reset state\n            this.kpiModalData = null;\n            this.kpiModalDateRange = '30d';\n            if (this.kpiModalChart) {\n                this.kpiModalChart.destroy();\n                this.kpiModalChart = null;\n            }\n\n            // First render the template, then create the modal with the rendered body\n            Templates.render('block_adeptus_insights/kpi_modal', {blockid: this.blockId})\n                .then(function(html) {\n                    return ModalFactory.create({\n                        type: ModalFactory.types.DEFAULT,\n                        title: report.name,\n                        body: html,\n                        large: true\n                    });\n                })\n                .then(function(modal) {\n                    self.kpiModal = modal;\n\n                    // Bind KPI modal event handlers\n                    self.bindKpiModalEvents(modal, slug, source);\n\n                    // Load KPI data after modal is shown.\n                    modal.getRoot().on(ModalEvents.shown, function() {\n                        self.loadKpiModalData(slug, source, self.kpiModalDateRange);\n                    });\n\n                    // Cleanup on close.\n                    modal.getRoot().on(ModalEvents.hidden, function() {\n                        if (self.kpiModalChart) {\n                            self.kpiModalChart.destroy();\n                            self.kpiModalChart = null;\n                        }\n                        modal.destroy();\n                        self.kpiModal = null;\n                        self.kpiModalData = null;\n                    });\n\n                    modal.show();\n                    return modal;\n                }).catch(Notification.exception);\n        },\n\n        /**\n         * Bind event handlers for KPI modal UI elements.\n         *\n         * @param {Object} modal\n         * @param {string} slug\n         * @param {string} source\n         */\n        bindKpiModalEvents: function(modal, slug, source) {\n            var self = this;\n            var modalRoot = modal.getRoot();\n\n            // Date range selector change\n            modalRoot.on('change', '.kpi-date-range-select', function() {\n                var dateRange = $(this).val();\n                self.kpiModalDateRange = dateRange;\n                self.loadKpiModalData(slug, source, dateRange);\n            });\n\n            // Retry button\n            modalRoot.on('click', '.kpi-modal-retry', function(e) {\n                e.preventDefault();\n                self.loadKpiModalData(slug, source, self.kpiModalDateRange);\n            });\n        },\n\n        /**\n         * Load KPI modal data based on date range.\n         *\n         * @param {string} slug\n         * @param {string} source\n         * @param {string} dateRange - '7d', '30d', '90d', or 'all'\n         */\n        loadKpiModalData: function(slug, source, dateRange) {\n            var self = this;\n            var modalContent = this.kpiModal.getRoot().find('.block-adeptus-kpi-modal-content');\n\n            // Show loading\n            modalContent.find('.kpi-modal-loading').removeClass('d-none');\n            modalContent.find('.kpi-modal-content-area').addClass('d-none');\n            modalContent.find('.kpi-modal-error').addClass('d-none');\n\n            // Check cache first - use cached data if available and fresh (under 5 minutes old)\n            var cached = this.kpiSnapshotCache[slug];\n            var cacheMaxAge = 5 * 60 * 1000; // 5 minutes\n\n            if (cached && cached.history && (Date.now() - cached.timestamp) < cacheMaxAge) {\n                // Use cached data\n                self.kpiModalData = cached;\n                self.renderKpiModal(modalContent, cached, dateRange);\n                return;\n            }\n\n            // Fetch fresh data from backend via POST (same as KPI card refresh)\n            var token = this.apiKey;\n            if (!token) {\n                self.showKpiModalError(modalContent);\n                return;\n            }\n\n            var endpoint = source === 'ai' ? '/ai-reports/' : '/reports/';\n            var baselinePeriod = this.config.baselinePeriod || 'all_time';\n            var historyLimit = this.getKpiModalHistoryLimit(dateRange);\n\n            // Get current value from cache or use 0 (backend will return history regardless)\n            var currentValue = cached ? cached.currentValue : 0;\n\n            $.ajax({\n                url: this.backendUrl + endpoint + encodeURIComponent(slug) +\n                    '/snapshots?baseline_period=' + baselinePeriod + '&history_limit=' + historyLimit,\n                method: 'POST',\n                headers: {\n                    'Authorization': 'Bearer ' + token,\n                    'Content-Type': 'application/json',\n                    'Accept': 'application/json'\n                },\n                data: JSON.stringify({\n                    row_count: currentValue,\n                    execution_time_ms: 0,\n                    evaluate_alerts: false, // Don't trigger alerts from modal refresh\n                    baseline_period: baselinePeriod\n                }),\n                timeout: 15000,\n                success: function(response) {\n                    if (response && response.success && response.history) {\n                        // Update cache\n                        self.kpiSnapshotCache[slug] = {\n                            history: response.history || [],\n                            trend: response.trend || {},\n                            currentValue: currentValue,\n                            timestamp: Date.now()\n                        };\n\n                        self.kpiModalData = response;\n                        self.renderKpiModal(modalContent, response, dateRange);\n                    } else {\n                        self.showKpiModalError(modalContent);\n                    }\n                },\n                error: function() {\n                    self.showKpiModalError(modalContent);\n                }\n            });\n        },\n\n        /**\n         * Get history limit based on date range selection.\n         *\n         * @param {string} dateRange\n         * @return {number}\n         */\n        getKpiModalHistoryLimit: function(dateRange) {\n            switch (dateRange) {\n                case '7d':\n                    return 14;\n                case '30d':\n                    return 60;\n                case '90d':\n                    return 180;\n                case 'all':\n                    return 500;\n                default:\n                    return 60;\n            }\n        },\n\n        /**\n         * Render KPI modal with data.\n         *\n         * @param {jQuery} modalContent\n         * @param {Object} data\n         * @param {string} dateRange\n         */\n        renderKpiModal: function(modalContent, data, dateRange) {\n            // Hide loading, show content\n            modalContent.find('.kpi-modal-loading').addClass('d-none');\n            modalContent.find('.kpi-modal-content-area').removeClass('d-none');\n            modalContent.find('.kpi-modal-error').addClass('d-none');\n\n            // Get history data and sort chronologically (oldest first)\n            var history = (data.history || []).slice(); // Clone to avoid mutating original\n            history.sort(function(a, b) {\n                var dateA = new Date(a.recorded_at || a.created_at);\n                var dateB = new Date(b.recorded_at || b.created_at);\n                return dateA - dateB; // Ascending order (oldest first)\n            });\n\n            // Get trend data from response\n            var trend = data.trend || {};\n            var vsBaseline = trend.vs_baseline || {};\n            var vsPrevious = trend.vs_previous || {};\n\n            // Filter history by date range\n            var filteredHistory = this.filterKpiHistoryByDateRange(history, dateRange);\n\n            // Current value: use the cached currentValue (from KPI card) or latest history entry\n            var currentValue = data.currentValue;\n            if (!currentValue && filteredHistory.length > 0) {\n                currentValue = filteredHistory[filteredHistory.length - 1].row_count;\n            }\n            currentValue = currentValue || '--';\n\n            // Update metric value\n            modalContent.find('.kpi-modal-value').text(this.formatNumber(currentValue));\n\n            // Update dual trend display\n            this.renderKpiModalTrends(modalContent, vsBaseline, vsPrevious);\n\n            // Calculate stats\n            var stats = this.calculateKpiStats(filteredHistory);\n            modalContent.find('.kpi-stat-min').text(this.formatNumber(stats.min));\n            modalContent.find('.kpi-stat-max').text(this.formatNumber(stats.max));\n            modalContent.find('.kpi-stat-avg').text(this.formatNumber(stats.avg));\n\n            // Update data points count\n            modalContent.find('.datapoints-count').text(filteredHistory.length);\n\n            // Update last updated\n            if (filteredHistory.length > 0) {\n                var lastEntry = filteredHistory[filteredHistory.length - 1];\n                var lastUpdated = lastEntry.recorded_at || lastEntry.created_at;\n                if (lastUpdated) {\n                    modalContent.find('.kpi-modal-last-updated').text(\n                        'Last updated: ' + this.formatTimestamp(lastUpdated)\n                    );\n                }\n            }\n\n            // Render interactive chart\n            this.renderKpiModalChart(modalContent, filteredHistory);\n        },\n\n        /**\n         * Filter KPI history by date range.\n         *\n         * @param {Array} history\n         * @param {string} dateRange\n         * @return {Array}\n         */\n        filterKpiHistoryByDateRange: function(history, dateRange) {\n            if (dateRange === 'all' || !history || history.length === 0) {\n                return history;\n            }\n\n            var now = new Date();\n            var cutoffDate;\n\n            switch (dateRange) {\n                case '7d':\n                    cutoffDate = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000));\n                    break;\n                case '30d':\n                    cutoffDate = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));\n                    break;\n                case '90d':\n                    cutoffDate = new Date(now.getTime() - (90 * 24 * 60 * 60 * 1000));\n                    break;\n                default:\n                    return history;\n            }\n\n            return history.filter(function(entry) {\n                var entryDate = new Date(entry.recorded_at || entry.created_at);\n                return entryDate >= cutoffDate;\n            });\n        },\n\n        /**\n         * Render dual trend metrics in KPI modal.\n         *\n         * @param {jQuery} modalContent\n         * @param {Object} vsBaseline\n         * @param {Object} vsPrevious\n         */\n        renderKpiModalTrends: function(modalContent, vsBaseline, vsPrevious) {\n            // Format baseline trend (vs overall baseline)\n            var baselineHtml = '--';\n            if (vsBaseline && vsBaseline.has_baseline) {\n                var baselinePct = this.formatPercentage(Math.abs(vsBaseline.change_percent || 0));\n                var baselineIcon = this.getTrendIcon(vsBaseline.direction);\n                var baselineClass = 'trend-' + (vsBaseline.direction || 'neutral');\n                var baselineSign = vsBaseline.direction === 'increase' ? '+' :\n                    (vsBaseline.direction === 'decrease' ? '-' : '');\n                baselineHtml = '<span class=\"' + baselineClass + '\">' +\n                    baselineIcon + ' ' + baselineSign + baselinePct + ' overall</span>';\n            }\n            modalContent.find('.kpi-modal-trend-baseline').html(baselineHtml);\n\n            // Format previous trend (vs previous snapshot)\n            var previousHtml = '--';\n            if (vsPrevious && vsPrevious.has_previous) {\n                var previousPct = this.formatPercentage(Math.abs(vsPrevious.change_percent || 0));\n                var previousIcon = this.getTrendIcon(vsPrevious.direction);\n                var previousClass = 'trend-' + (vsPrevious.direction || 'neutral');\n                var previousSign = vsPrevious.direction === 'increase' ? '+' :\n                    (vsPrevious.direction === 'decrease' ? '-' : '');\n                previousHtml = '<span class=\"' + previousClass + '\">' +\n                    previousIcon + ' ' + previousSign + previousPct + ' since last</span>';\n            }\n            modalContent.find('.kpi-modal-trend-previous').html(previousHtml);\n        },\n\n        /**\n         * Calculate statistics from KPI history.\n         *\n         * @param {Array} history\n         * @return {Object}\n         */\n        calculateKpiStats: function(history) {\n            if (!history || history.length === 0) {\n                return {min: '--', max: '--', avg: '--'};\n            }\n\n            var values = history.map(function(entry) {\n                return parseFloat(entry.row_count) || 0;\n            });\n\n            var min = Math.min.apply(null, values);\n            var max = Math.max.apply(null, values);\n            var sum = values.reduce(function(a, b) { return a + b; }, 0);\n            var avg = Math.round(sum / values.length);\n\n            return {min: min, max: max, avg: avg};\n        },\n\n        /**\n         * Render interactive chart in KPI modal.\n         *\n         * @param {jQuery} modalContent\n         * @param {Array} history\n         */\n        renderKpiModalChart: function(modalContent, history) {\n            var self = this;\n            var canvas = modalContent.find('.kpi-modal-chart')[0];\n\n            if (!canvas) {\n                return;\n            }\n\n            // Destroy existing chart\n            if (this.kpiModalChart) {\n                this.kpiModalChart.destroy();\n            }\n\n            // Prepare chart data - filter out consecutive duplicates where value hasn't changed\n            var labels = [];\n            var data = [];\n            var lastValue = null;\n\n            history.forEach(function(entry) {\n                var value = parseFloat(entry.row_count) || 0;\n\n                // Only add data point if the value has changed from the previous entry\n                if (lastValue === null || value !== lastValue) {\n                    var date = new Date(entry.recorded_at || entry.created_at);\n                    labels.push(self.formatChartDate(date));\n                    data.push(value);\n                    lastValue = value;\n                }\n            });\n\n            // Create chart\n            var ctx = canvas.getContext('2d');\n            this.kpiModalChart = new Chart(ctx, {\n                type: 'line',\n                data: {\n                    labels: labels,\n                    datasets: [{\n                        label: 'Value',\n                        data: data,\n                        borderColor: '#0066cc',\n                        backgroundColor: 'rgba(0, 102, 204, 0.1)',\n                        borderWidth: 2,\n                        fill: true,\n                        tension: 0.3,\n                        pointRadius: 4,\n                        pointHoverRadius: 6,\n                        pointBackgroundColor: '#0066cc',\n                        pointBorderColor: '#fff',\n                        pointBorderWidth: 2\n                    }]\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    interaction: {\n                        mode: 'index',\n                        intersect: false\n                    },\n                    plugins: {\n                        legend: {\n                            display: false\n                        },\n                        tooltip: {\n                            enabled: true,\n                            backgroundColor: 'rgba(0, 0, 0, 0.8)',\n                            titleColor: '#fff',\n                            bodyColor: '#fff',\n                            padding: 12,\n                            displayColors: false,\n                            callbacks: {\n                                title: function(tooltipItems) {\n                                    return tooltipItems[0].label;\n                                },\n                                label: function(context) {\n                                    return 'Value: ' + self.formatNumber(context.parsed.y);\n                                }\n                            }\n                        }\n                    },\n                    scales: {\n                        x: {\n                            display: true,\n                            grid: {\n                                display: false\n                            },\n                            ticks: {\n                                maxRotation: 45,\n                                minRotation: 0,\n                                autoSkip: true,\n                                maxTicksLimit: 10\n                            }\n                        },\n                        y: {\n                            display: true,\n                            beginAtZero: false,\n                            grid: {\n                                color: 'rgba(0, 0, 0, 0.05)'\n                            },\n                            ticks: {\n                                callback: function(value) {\n                                    return self.formatNumber(value);\n                                }\n                            }\n                        }\n                    }\n                }\n            });\n        },\n\n        /**\n         * Format date for chart X-axis labels.\n         *\n         * @param {Date} date\n         * @return {string}\n         */\n        formatChartDate: function(date) {\n            var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',\n                          'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];\n            return months[date.getMonth()] + ' ' + date.getDate();\n        },\n\n        /**\n         * Show error state in KPI modal.\n         *\n         * @param {jQuery} modalContent\n         */\n        showKpiModalError: function(modalContent) {\n            modalContent.find('.kpi-modal-loading').addClass('d-none');\n            modalContent.find('.kpi-modal-content-area').addClass('d-none');\n            modalContent.find('.kpi-modal-error').removeClass('d-none');\n        },\n\n        /**\n         * Bind event handlers for modal UI elements.\n         *\n         * @param {Object} modal\n         */\n        bindModalEvents: function(modal) {\n            var self = this;\n            var modalRoot = modal.getRoot();\n\n            // View toggle buttons\n            modalRoot.on('click', '.view-toggle-btn', function(e) {\n                e.preventDefault();\n                var view = $(this).data('view');\n                self.switchModalView(view);\n            });\n\n            // Chart control changes\n            modalRoot.on('change', '#modal-chart-type, #modal-chart-x-axis, #modal-chart-y-axis', function() {\n                if (self.currentView === 'chart') {\n                    self.renderModalChart();\n                }\n            });\n\n            // Retry button\n            modalRoot.on('click', '.modal-retry', function(e) {\n                e.preventDefault();\n                if (self.modalReport) {\n                    self.loadModalReport(self.modalReport.slug, self.modalReport.source);\n                }\n            });\n\n            // Export CSV\n            modalRoot.on('click', '.modal-export[data-format=\"csv\"]', function(e) {\n                e.preventDefault();\n                self.exportModalData('csv');\n            });\n\n            // Table pagination - Previous\n            modalRoot.on('click', '.table-pagination-prev', function(e) {\n                e.preventDefault();\n                if (self.tableCurrentPage > 1) {\n                    self.tableCurrentPage--;\n                    self.renderModalTablePage();\n                }\n            });\n\n            // Table pagination - Next\n            modalRoot.on('click', '.table-pagination-next', function(e) {\n                e.preventDefault();\n                if (self.tableCurrentPage < self.tableTotalPages) {\n                    self.tableCurrentPage++;\n                    self.renderModalTablePage();\n                }\n            });\n        },\n\n        /**\n         * Switch between table and chart views in modal.\n         *\n         * @param {string} view - 'table' or 'chart'\n         */\n        switchModalView: function(view) {\n            var modalBody = this.modal.getBody();\n\n            // Update toggle buttons\n            modalBody.find('.view-toggle-btn').removeClass('active');\n            modalBody.find('.view-toggle-btn[data-view=\"' + view + '\"]').addClass('active');\n\n            // Switch views\n            if (view === 'table') {\n                modalBody.find('#modal-table-view').removeClass('d-none');\n                modalBody.find('#modal-chart-view').addClass('d-none');\n            } else {\n                modalBody.find('#modal-table-view').addClass('d-none');\n                modalBody.find('#modal-chart-view').removeClass('d-none');\n                // Render chart when switching to chart view\n                this.renderModalChart();\n            }\n\n            this.currentView = view;\n        },\n\n        /**\n         * Load report data into modal.\n         *\n         * @param {string} slug\n         * @param {string} source\n         */\n        loadModalReport: function(slug, source) {\n            var self = this;\n            var modalBody = this.modal.getBody();\n            var cacheKey = slug + '_' + source;\n\n            // Check cache first for instant loading\n            if (this.reportDataCache[cacheKey]) {\n                var cached = this.reportDataCache[cacheKey];\n                modalBody.find('.modal-loading').addClass('d-none');\n                this.renderModalContent(modalBody, cached.report, cached.results, cached.chartData, cached.chartType);\n                return;\n            }\n\n            // Find the report from our cached list\n            var report = this.reports.find(function(r) {\n                return r.slug === slug;\n            });\n\n            if (!report) {\n                modalBody.find('.modal-loading').addClass('d-none');\n                modalBody.find('.modal-error').removeClass('d-none');\n                return;\n            }\n\n            // For wizard reports, execute locally via generate_report.php\n            // For AI reports, we need to fetch from backend\n            if (source === 'wizard') {\n                // Execute report via local Moodle AJAX endpoint\n                $.ajax({\n                    url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/generate_report.php',\n                    method: 'POST',\n                    data: {\n                        reportid: report.name || report.report_template_id,\n                        sesskey: M.cfg.sesskey\n                    },\n                    dataType: 'json',\n                    timeout: 30000\n                }).done(function(response) {\n                    modalBody.find('.modal-loading').addClass('d-none');\n\n                    if (response.success) {\n                        // Cache the result for future use\n                        self.reportDataCache[cacheKey] = {\n                            report: report,\n                            results: response.results || [],\n                            chartData: response.chart_data,\n                            chartType: response.chart_type\n                        };\n                        self.renderModalContent(modalBody, report, response.results || [], response.chart_data, response.chart_type);\n                    } else {\n                        modalBody.find('.modal-error').removeClass('d-none');\n                        modalBody.find('.modal-error p').text(response.message || 'Failed to load report');\n                    }\n                }).fail(function() {\n                    modalBody.find('.modal-loading').addClass('d-none');\n                    modalBody.find('.modal-error').removeClass('d-none');\n                });\n            } else {\n                // AI reports - fetch from backend API\n                var token = this.apiKey || (window.adeptusAuthData ? window.adeptusAuthData.api_key : null);\n\n                if (!token) {\n                    modalBody.find('.modal-loading').addClass('d-none');\n                    modalBody.find('.modal-error').removeClass('d-none');\n                    return;\n                }\n\n                $.ajax({\n                    url: '' + this.backendUrl + '/ai-reports/' + slug,\n                    method: 'GET',\n                    headers: {\n                        'Authorization': 'Bearer ' + token,\n                        'Accept': 'application/json'\n                    },\n                    timeout: 15000\n                }).done(function(response) {\n                    if (response.success && response.report) {\n                        var reportData = response.report;\n                        var data = response.data || [];\n\n                        // Check if local execution is required (SaaS model)\n                        var sqlQuery = response.sql || (reportData && reportData.sql_query) || (reportData && reportData.sql);\n                        var needsLocalExecution = response.execution_required || ((!data || data.length === 0) && sqlQuery);\n\n                        if (needsLocalExecution && sqlQuery) {\n                            // Execute SQL locally against Moodle database\n                            self.executeReportLocally(sqlQuery, reportData.params || {})\n                                .then(function(executionResult) {\n                                    modalBody.find('.modal-loading').addClass('d-none');\n                                    var localData = executionResult.data || [];\n                                    self.reportDataCache[cacheKey] = {\n                                        report: reportData,\n                                        results: localData,\n                                        chartData: null,\n                                        chartType: null\n                                    };\n                                    self.renderModalContent(modalBody, reportData, localData, null, null);\n                                })\n                                .catch(function(error) {\n                                    modalBody.find('.modal-loading').addClass('d-none');\n                                    modalBody.find('.modal-error').removeClass('d-none');\n                                });\n                            return;\n                        }\n\n                        modalBody.find('.modal-loading').addClass('d-none');\n                        // Cache the result for future use\n                        self.reportDataCache[cacheKey] = {\n                            report: reportData,\n                            results: data,\n                            chartData: null,\n                            chartType: null\n                        };\n                        self.renderModalContent(modalBody, reportData, data, null, null);\n                    } else {\n                        modalBody.find('.modal-loading').addClass('d-none');\n                        modalBody.find('.modal-error').removeClass('d-none');\n                    }\n                }).fail(function() {\n                    modalBody.find('.modal-loading').addClass('d-none');\n                    modalBody.find('.modal-error').removeClass('d-none');\n                });\n            }\n        },\n\n        /**\n         * Render modal content with report data.\n         *\n         * @param {jQuery} modalBody\n         * @param {Object} report\n         * @param {Array} data\n         * @param {Object} chartData - Pre-configured chart data from backend (unused, we use controls)\n         * @param {string} chartType - Chart type from backend (unused, we use controls)\n         */\n        renderModalContent: function(modalBody, report, data, chartData, chartType) {\n            var self = this;\n\n            // Store data for chart re-rendering\n            this.modalData = data || [];\n            this.modalReport = report;\n\n            var contentArea = modalBody.find('.modal-content-area');\n            contentArea.removeClass('d-none');\n\n            // Set report metadata\n            var category = report.category_info || {name: 'General', color: '#6c757d'};\n            modalBody.find('.report-category')\n                .text(category.name)\n                .css('background-color', category.color);\n            modalBody.find('.row-count-num').text(this.modalData.length);\n            modalBody.find('.report-date')\n                .text(report.last_executed_at ? 'Last run: ' + new Date(report.last_executed_at).toLocaleDateString() : '');\n\n            // Populate axis selectors\n            this.populateAxisSelectors(modalBody);\n\n            // Render table\n            this.renderModalTable(modalBody, this.modalData);\n\n            // Set up view full report link (admin only)\n            if (this.isAdmin) {\n                var reportUrl = M.cfg.wwwroot + '/report/adeptus_insights/generated_reports.php?slug=' + encodeURIComponent(report.slug);\n                modalBody.find('.view-full-report').attr('href', reportUrl);\n                modalBody.find('.modal-footer-link').removeClass('d-none');\n            } else {\n                modalBody.find('.modal-footer-link').addClass('d-none');\n            }\n\n            // Reset to table view\n            this.currentView = 'table';\n            modalBody.find('.view-toggle-btn').removeClass('active');\n            modalBody.find('.view-toggle-btn[data-view=\"table\"]').addClass('active');\n            modalBody.find('#modal-table-view').removeClass('d-none');\n            modalBody.find('#modal-chart-view').addClass('d-none');\n        },\n\n        /**\n         * Populate X-axis and Y-axis dropdown selectors.\n         *\n         * @param {jQuery} modalBody\n         */\n        populateAxisSelectors: function(modalBody) {\n            var data = this.modalData;\n            if (!data || data.length === 0) {\n                return;\n            }\n\n            var headers = Object.keys(data[0]);\n            var xAxisSelect = modalBody.find('#modal-chart-x-axis');\n            var yAxisSelect = modalBody.find('#modal-chart-y-axis');\n\n            // Clear existing options\n            xAxisSelect.empty();\n            yAxisSelect.empty();\n\n            // Detect numeric columns for Y-axis\n            var numericCols = this.detectNumericColumns(data, headers);\n\n            // Populate X-axis with all columns\n            headers.forEach(function(header, idx) {\n                var formattedHeader = header.replace(/_/g, ' ').replace(/\\b\\w/g, function(l) { return l.toUpperCase(); });\n                var selected = idx === 0 ? ' selected' : '';\n                xAxisSelect.append('<option value=\"' + header + '\"' + selected + '>' + formattedHeader + '</option>');\n            });\n\n            // Populate Y-axis with numeric columns (or all if none detected)\n            var yAxisOptions = numericCols.length > 0 ? numericCols : headers;\n            yAxisOptions.forEach(function(col, idx) {\n                var formattedHeader = col.replace(/_/g, ' ').replace(/\\b\\w/g, function(l) { return l.toUpperCase(); });\n                // Select the last numeric column by default (usually the main value)\n                var selected = idx === yAxisOptions.length - 1 ? ' selected' : '';\n                yAxisSelect.append('<option value=\"' + col + '\"' + selected + '>' + formattedHeader + '</option>');\n            });\n        },\n\n        /**\n         * Detect numeric columns in data.\n         *\n         * @param {Array} data\n         * @param {Array} headers\n         * @return {Array}\n         */\n        detectNumericColumns: function(data, headers) {\n            var numericCols = [];\n\n            headers.forEach(function(header) {\n                var isNumeric = data.every(function(row) {\n                    var val = row[header];\n                    if (val === null || val === undefined || val === '') {\n                        return true; // Allow nulls\n                    }\n                    return !isNaN(parseFloat(val)) && isFinite(val);\n                });\n\n                // Also check if at least some values are actually numbers\n                var hasNumbers = data.some(function(row) {\n                    var val = row[header];\n                    return val !== null && val !== undefined && val !== '' && !isNaN(parseFloat(val));\n                });\n\n                if (isNumeric && hasNumbers) {\n                    numericCols.push(header);\n                }\n            });\n\n            return numericCols;\n        },\n\n        /**\n         * Execute AI report SQL locally against Moodle database.\n         * Used when backend returns SQL query but no data (SaaS model).\n         *\n         * @param {string} sql - The SQL query to execute\n         * @param {Object} params - Query parameters\n         * @return {Promise}\n         */\n        executeReportLocally: function(sql, params) {\n            params = params || {};\n\n            return new Promise(function(resolve, reject) {\n                $.ajax({\n                    url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/execute_ai_report.php',\n                    method: 'POST',\n                    contentType: 'application/json',\n                    data: JSON.stringify({\n                        sql: sql,\n                        params: params,\n                        sesskey: M.cfg.sesskey\n                    }),\n                    timeout: 60000,\n                    success: function(response) {\n                        if (response.success) {\n                            resolve({\n                                data: response.data || [],\n                                headers: response.headers || [],\n                                row_count: response.row_count || 0,\n                                error: null\n                            });\n                        } else {\n                            resolve({\n                                data: [],\n                                headers: [],\n                                row_count: 0,\n                                error: response.message || 'Query execution failed'\n                            });\n                        }\n                    },\n                    error: function(xhr, status, error) {\n                        reject(new Error('Failed to execute report: ' + error));\n                    }\n                });\n            });\n        },\n\n        /**\n         * Render chart in modal using current control values.\n         */\n        renderModalChart: function() {\n            var self = this;\n            var modalBody = this.modal.getBody();\n            var data = this.modalData;\n\n            if (!data || data.length === 0) {\n                modalBody.find('.chart-container').html(\n                    '<div class=\"alert alert-warning text-center\"><i class=\"fa fa-info-circle\"></i> No data available for chart</div>'\n                );\n                return;\n            }\n\n            var canvas = modalBody.find('.modal-chart')[0];\n            if (!canvas) {\n                return;\n            }\n\n            // Destroy existing chart\n            if (this.chartInstance) {\n                this.chartInstance.destroy();\n                this.chartInstance = null;\n            }\n\n            // Get control values\n            var chartType = modalBody.find('#modal-chart-type').val() || 'bar';\n            var labelKey = modalBody.find('#modal-chart-x-axis').val();\n            var valueKey = modalBody.find('#modal-chart-y-axis').val();\n\n            // Fallback if not set\n            if (!labelKey || !valueKey) {\n                var headers = Object.keys(data[0]);\n                labelKey = labelKey || headers[0];\n                valueKey = valueKey || headers[headers.length - 1];\n            }\n\n            // Format value key for display\n            var valueKeyFormatted = valueKey.replace(/_/g, ' ').replace(/\\b\\w/g, function(l) { return l.toUpperCase(); });\n\n            // Limit data for chart readability (max 50 items)\n            var chartData = data.slice(0, 50);\n            var labels = chartData.map(function(row) {\n                var label = row[labelKey];\n                if (label === null || label === undefined) return 'Unknown';\n                var labelStr = String(label);\n                return labelStr.length > 30 ? labelStr.substring(0, 30) + '...' : labelStr;\n            });\n            var values = chartData.map(function(row) {\n                return parseFloat(row[valueKey]) || 0;\n            });\n\n            // Generate colors\n            var colors = this.generateChartColors(values.length, chartType);\n\n            // Create chart config\n            var config = this.createChartConfig(chartType, labels, values, valueKeyFormatted, colors);\n\n            try {\n                this.chartInstance = new Chart(canvas.getContext('2d'), config);\n            } catch (error) {\n                modalBody.find('.chart-container').html(\n                    '<div class=\"alert alert-danger\"><i class=\"fa fa-exclamation-triangle\"></i> Error rendering chart</div>'\n                );\n            }\n        },\n\n        /**\n         * Create Chart.js configuration.\n         *\n         * @param {string} chartType\n         * @param {Array} labels\n         * @param {Array} values\n         * @param {string} valueKey\n         * @param {Array} colors\n         * @return {Object}\n         */\n        createChartConfig: function(chartType, labels, values, valueKey, colors) {\n            var reportName = this.modalReport ? this.modalReport.name : 'Report';\n\n            var baseOptions = {\n                responsive: true,\n                maintainAspectRatio: false,\n                plugins: {\n                    title: {\n                        display: true,\n                        text: reportName,\n                        font: { size: 14, weight: 'bold' },\n                        padding: { top: 10, bottom: 20 }\n                    },\n                    legend: {\n                        display: chartType === 'pie' || chartType === 'doughnut',\n                        position: 'right'\n                    }\n                }\n            };\n\n            if (chartType === 'pie' || chartType === 'doughnut') {\n                return {\n                    type: chartType,\n                    data: {\n                        labels: labels,\n                        datasets: [{\n                            data: values,\n                            backgroundColor: colors,\n                            borderWidth: 2\n                        }]\n                    },\n                    options: baseOptions\n                };\n            } else {\n                // Bar or Line chart\n                baseOptions.scales = {\n                    y: {\n                        beginAtZero: true,\n                        title: {\n                            display: true,\n                            text: valueKey\n                        }\n                    },\n                    x: {\n                        title: {\n                            display: false\n                        }\n                    }\n                };\n\n                return {\n                    type: chartType,\n                    data: {\n                        labels: labels,\n                        datasets: [{\n                            label: valueKey,\n                            data: values,\n                            backgroundColor: chartType === 'line' ? 'transparent' : colors[0],\n                            borderColor: colors[0].replace('0.7', '1'),\n                            borderWidth: 2,\n                            fill: chartType === 'line' ? false : true,\n                            tension: 0.1\n                        }]\n                    },\n                    options: baseOptions\n                };\n            }\n        },\n\n        /**\n         * Generate chart colors.\n         *\n         * @param {number} count\n         * @param {string} chartType\n         * @return {Array}\n         */\n        generateChartColors: function(count, chartType) {\n            var baseColors = [\n                'rgba(37, 99, 235, 0.7)',   // Blue\n                'rgba(16, 185, 129, 0.7)',  // Green\n                'rgba(245, 158, 11, 0.7)',  // Amber\n                'rgba(239, 68, 68, 0.7)',   // Red\n                'rgba(139, 92, 246, 0.7)',  // Purple\n                'rgba(6, 182, 212, 0.7)',   // Cyan\n                'rgba(236, 72, 153, 0.7)',  // Pink\n                'rgba(132, 204, 22, 0.7)',  // Lime\n                'rgba(249, 115, 22, 0.7)',  // Orange\n                'rgba(99, 102, 241, 0.7)'   // Indigo\n            ];\n\n            var colors = [];\n            for (var i = 0; i < count; i++) {\n                colors.push(baseColors[i % baseColors.length]);\n            }\n            return colors;\n        },\n\n        /**\n         * Export modal data as CSV.\n         *\n         * @param {string} format\n         */\n        exportModalData: function(format) {\n            var data = this.modalData;\n            var report = this.modalReport;\n\n            if (!data || data.length === 0) {\n                Notification.addNotification({\n                    message: 'No data to export',\n                    type: 'warning'\n                });\n                return;\n            }\n\n            if (format === 'csv') {\n                var headers = Object.keys(data[0]);\n                var csvContent = headers.join(',') + '\\n';\n\n                data.forEach(function(row) {\n                    var values = headers.map(function(h) {\n                        var val = row[h];\n                        if (val === null || val === undefined) val = '';\n                        // Escape quotes and wrap in quotes if contains comma\n                        val = String(val).replace(/\"/g, '\"\"');\n                        if (val.indexOf(',') !== -1 || val.indexOf('\"') !== -1 || val.indexOf('\\n') !== -1) {\n                            val = '\"' + val + '\"';\n                        }\n                        return val;\n                    });\n                    csvContent += values.join(',') + '\\n';\n                });\n\n                // Download\n                var blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});\n                var link = document.createElement('a');\n                link.href = URL.createObjectURL(blob);\n                link.download = (report ? report.name.replace(/[^a-z0-9]/gi, '_') : 'report') + '.csv';\n                link.click();\n            }\n        },\n\n        /**\n         * Render table in modal with pagination.\n         *\n         * @param {jQuery} modalBody\n         * @param {Array} data\n         */\n        renderModalTable: function(modalBody, data) {\n            // Reset pagination\n            this.tableCurrentPage = 1;\n            this.tableTotalPages = Math.ceil((data ? data.length : 0) / this.tableRowsPerPage);\n\n            // Build table headers once\n            var table = modalBody.find('.modal-table');\n            var thead = table.find('thead');\n\n            thead.empty();\n\n            if (!data || data.length === 0) {\n                modalBody.find('.modal-table-container').addClass('d-none');\n                return;\n            }\n\n            // Build headers from first row\n            var headers = Object.keys(data[0]);\n            var headerRow = $('<tr>');\n            headers.forEach(function(h) {\n                // Format header nicely\n                var formatted = h.replace(/_/g, ' ').replace(/\\b\\w/g, function(l) { return l.toUpperCase(); });\n                headerRow.append($('<th>').text(formatted));\n            });\n            thead.append(headerRow);\n\n            // Render first page\n            this.renderModalTablePage();\n        },\n\n        /**\n         * Render current page of table data.\n         */\n        renderModalTablePage: function() {\n            var modalBody = this.modal.getBody();\n            var data = this.modalData || [];\n            var table = modalBody.find('.modal-table');\n            var tbody = table.find('tbody');\n\n            tbody.empty();\n\n            if (!data || data.length === 0) {\n                return;\n            }\n\n            var headers = Object.keys(data[0]);\n\n            // Calculate page slice\n            var startIndex = (this.tableCurrentPage - 1) * this.tableRowsPerPage;\n            var endIndex = startIndex + this.tableRowsPerPage;\n            var pageData = data.slice(startIndex, endIndex);\n\n            // Build rows\n            pageData.forEach(function(row) {\n                var tr = $('<tr>');\n                headers.forEach(function(h) {\n                    var val = row[h];\n                    if (val === null || val === undefined) val = '';\n                    // Truncate long values\n                    var displayVal = String(val);\n                    if (displayVal.length > 100) {\n                        displayVal = displayVal.substring(0, 100) + '...';\n                    }\n                    tr.append($('<td>').attr('title', val).text(displayVal));\n                });\n                tbody.append(tr);\n            });\n\n            // Update pagination info and controls\n            var actualEnd = Math.min(endIndex, data.length);\n            modalBody.find('.row-count').text(data.length + ' total rows');\n\n            var paginationInfo = modalBody.find('.table-pagination-info');\n            paginationInfo.text((startIndex + 1) + '-' + actualEnd + ' of ' + data.length);\n\n            // Update button states\n            modalBody.find('.table-pagination-prev').prop('disabled', this.tableCurrentPage <= 1);\n            modalBody.find('.table-pagination-next').prop('disabled', this.tableCurrentPage >= this.tableTotalPages);\n\n            // Show/hide pagination based on total pages\n            if (this.tableTotalPages > 1) {\n                modalBody.find('.table-pagination').removeClass('d-none');\n            } else {\n                modalBody.find('.table-pagination').addClass('d-none');\n            }\n        },\n\n        /**\n         * Open report in new tab.\n         *\n         * @param {string} slug\n         * @param {string} source\n         */\n        openReportNewTab: function(slug, source) {\n            var url = M.cfg.wwwroot + '/report/adeptus_insights/generated_reports.php?slug=' + encodeURIComponent(slug);\n            window.open(url, '_blank');\n        },\n\n        /**\n         * Expand report inline.\n         *\n         * @param {string} slug\n         * @param {string} source\n         */\n        expandReportInline: function(slug, source) {\n            // TODO: Implement inline expansion.\n        },\n\n        /**\n         * Export report.\n         *\n         * @param {string} format\n         */\n        exportReport: function(format) {\n            // TODO: Implement export functionality.\n            Notification.addNotification({\n                message: 'Export to ' + format.toUpperCase() + ' coming soon',\n                type: 'info'\n            });\n        },\n\n        /**\n         * Refresh the block (clears cache and reloads).\n         */\n        refresh: function() {\n            var refreshBtn = this.container.find('.block-adeptus-refresh i');\n            refreshBtn.addClass('fa-spin');\n\n            // Clear all caches for fresh data\n            this.clearAllCaches();\n\n            // Force reload from server\n            this.showLoading();\n            var self = this;\n            this.waitForAuth(function() {\n                self.fetchReports();\n            });\n\n            setTimeout(function() {\n                refreshBtn.removeClass('fa-spin');\n            }, 1000);\n        },\n\n        /**\n         * Clear all caches.\n         */\n        clearAllCaches: function() {\n            // Clear sessionStorage cache\n            try {\n                sessionStorage.removeItem(this.cacheKey);\n            } catch (e) {\n                // Ignore\n            }\n            // Clear in-memory report data cache\n            this.reportDataCache = {};\n        },\n\n        /**\n         * Setup auto-refresh timer.\n         */\n        setupAutoRefresh: function() {\n            var interval = this.config.autoRefresh;\n            if (!interval || interval === 'never') {\n                return;\n            }\n\n            var ms;\n            switch (interval) {\n                case '5m':\n                    ms = 5 * 60 * 1000;\n                    break;\n                case '15m':\n                    ms = 15 * 60 * 1000;\n                    break;\n                case '30m':\n                    ms = 30 * 60 * 1000;\n                    break;\n                case '1h':\n                    ms = 60 * 60 * 1000;\n                    break;\n                default:\n                    return;\n            }\n\n            var self = this;\n            this.refreshTimer = setInterval(function() {\n                // Only refresh if page is visible.\n                if (!document.hidden) {\n                    self.refresh();\n                }\n            }, ms);\n        },\n\n        /**\n         * Show loading state.\n         */\n        showLoading: function() {\n            this.container.find('.block-adeptus-loading').removeClass('d-none');\n            this.container.find('.block-adeptus-report-list, .block-adeptus-kpi-grid, .block-adeptus-tabs-container, .block-adeptus-content').addClass('d-none');\n            this.container.find('.block-adeptus-empty, .block-adeptus-error').addClass('d-none');\n        },\n\n        /**\n         * Hide loading state.\n         */\n        hideLoading: function() {\n            this.container.find('.block-adeptus-loading').addClass('d-none');\n        },\n\n        /**\n         * Show empty state.\n         */\n        showEmpty: function() {\n            this.hideLoading();\n            this.container.find('.block-adeptus-empty').removeClass('d-none');\n        },\n\n        /**\n         * Show error state.\n         *\n         * @param {string} message\n         */\n        showError: function(message) {\n            this.hideLoading();\n            this.container.find('.block-adeptus-error').removeClass('d-none');\n        },\n\n        /**\n         * Update the timestamp display.\n         */\n        updateTimestamp: function() {\n            if (!this.lastUpdated) {\n                return;\n            }\n\n            var text = this.formatTimeAgo(this.lastUpdated);\n\n            // Handle KPI mode footer (contains both timestamp and refresh)\n            var kpiFooter = this.container.find('.block-adeptus-kpi-footer');\n            if (kpiFooter.length) {\n                kpiFooter.find('.timestamp-text').text(text);\n                kpiFooter.removeClass('d-none');\n                return;\n            }\n\n            // Handle standard timestamp element\n            if (this.config.showTimestamp) {\n                var timestampEl = this.container.find('.block-adeptus-timestamp');\n                timestampEl.find('.timestamp-text').text(text);\n                timestampEl.removeClass('d-none');\n            }\n        },\n\n        /**\n         * Scroll to the top of the report list.\n         */\n        scrollToListTop: function() {\n            var listContainer = this.container.find('.block-adeptus-report-list');\n            if (listContainer.length) {\n                listContainer[0].scrollIntoView({behavior: 'smooth', block: 'start'});\n            }\n        },\n\n        /**\n         * Scroll to the top of the embedded table.\n         */\n        scrollToEmbeddedTableTop: function() {\n            var tableContainer = this.container.find('.embedded-table-view');\n            if (tableContainer.length) {\n                tableContainer[0].scrollIntoView({behavior: 'smooth', block: 'start'});\n            }\n        },\n\n        /**\n         * Show the embedded loading overlay.\n         */\n        showEmbeddedLoadingOverlay: function() {\n            var overlay = this.container.find('.embedded-loading-overlay');\n            var content = this.container.find('.block-adeptus-content');\n\n            // Show content area if hidden (to show overlay over it)\n            content.removeClass('d-none');\n\n            // Show overlay with fade\n            overlay.removeClass('d-none').css('opacity', 0).animate({opacity: 1}, 150);\n        },\n\n        /**\n         * Hide the embedded loading overlay.\n         */\n        hideEmbeddedLoadingOverlay: function() {\n            var overlay = this.container.find('.embedded-loading-overlay');\n            overlay.animate({opacity: 0}, 150, function() {\n                $(this).addClass('d-none');\n            });\n        },\n\n        /**\n         * Toggle searchable dropdown open/closed.\n         *\n         * @param {jQuery} dropdown\n         */\n        toggleSearchableDropdown: function(dropdown) {\n            if (dropdown.hasClass('open')) {\n                this.closeSearchableDropdown(dropdown);\n            } else {\n                this.openSearchableDropdown(dropdown);\n            }\n        },\n\n        /**\n         * Open searchable dropdown.\n         *\n         * @param {jQuery} dropdown\n         */\n        openSearchableDropdown: function(dropdown) {\n            // Close any other open dropdowns first\n            var self = this;\n            this.container.find('.searchable-dropdown.open').each(function() {\n                if (!$(this).is(dropdown)) {\n                    self.closeSearchableDropdown($(this));\n                }\n            });\n\n            dropdown.addClass('open');\n            dropdown.find('.searchable-dropdown-toggle').attr('aria-expanded', 'true');\n\n            // Clear search and show all items\n            var input = dropdown.find('.searchable-dropdown-input');\n            input.val('');\n            dropdown.find('.searchable-dropdown-item').show().removeClass('focused');\n            dropdown.find('.searchable-dropdown-empty').addClass('d-none');\n\n            // Focus search input\n            setTimeout(function() {\n                input.focus();\n            }, 50);\n        },\n\n        /**\n         * Close searchable dropdown.\n         *\n         * @param {jQuery} dropdown\n         */\n        closeSearchableDropdown: function(dropdown) {\n            dropdown.removeClass('open');\n            dropdown.find('.searchable-dropdown-toggle').attr('aria-expanded', 'false');\n            dropdown.find('.searchable-dropdown-item').removeClass('focused');\n        },\n\n        /**\n         * Filter searchable dropdown items based on search query.\n         *\n         * @param {jQuery} dropdown\n         * @param {string} query\n         */\n        filterSearchableDropdown: function(dropdown, query) {\n            var items = dropdown.find('.searchable-dropdown-item');\n            var emptyState = dropdown.find('.searchable-dropdown-empty');\n            var visibleCount = 0;\n\n            items.each(function() {\n                var searchText = $(this).data('search') || '';\n                if (query === '' || searchText.indexOf(query) !== -1) {\n                    $(this).show();\n                    visibleCount++;\n                } else {\n                    $(this).hide();\n                }\n            });\n\n            // Remove focus from hidden items\n            items.filter(':hidden').removeClass('focused');\n\n            // Show/hide empty state\n            if (visibleCount === 0) {\n                emptyState.removeClass('d-none');\n            } else {\n                emptyState.addClass('d-none');\n            }\n        },\n\n        /**\n         * Select an item from the searchable dropdown.\n         *\n         * @param {jQuery} dropdown\n         * @param {string} value\n         * @param {string} text\n         */\n        selectSearchableDropdownItem: function(dropdown, value, text) {\n            // Update display text\n            dropdown.find('.searchable-dropdown-text').text(text);\n\n            // Mark item as selected\n            dropdown.find('.searchable-dropdown-item').removeClass('selected');\n            dropdown.find('.searchable-dropdown-item[data-value=\"' + value + '\"]').addClass('selected');\n\n            // Find the hidden select sibling and trigger change\n            // Works for both category-filter-select and report-selector-select\n            var select = dropdown.siblings('select');\n            if (select.length) {\n                select.val(value).trigger('change');\n            }\n\n            // Close dropdown\n            this.closeSearchableDropdown(dropdown);\n        },\n\n        /**\n         * Scroll a dropdown item into view.\n         *\n         * @param {jQuery} item\n         */\n        scrollDropdownItemIntoView: function(item) {\n            var list = item.closest('.searchable-dropdown-list');\n            var listHeight = list.height();\n            var itemTop = item.position().top;\n            var itemHeight = item.outerHeight();\n\n            if (itemTop < 0) {\n                list.scrollTop(list.scrollTop() + itemTop);\n            } else if (itemTop + itemHeight > listHeight) {\n                list.scrollTop(list.scrollTop() + (itemTop + itemHeight - listHeight));\n            }\n        },\n\n        /**\n         * Escape HTML special characters.\n         *\n         * @param {string} text\n         * @return {string}\n         */\n        escapeHtml: function(text) {\n            var div = document.createElement('div');\n            div.textContent = text;\n            return div.innerHTML;\n        },\n\n        /**\n         * Format a date as \"X ago\".\n         *\n         * @param {Date} date\n         * @return {string}\n         */\n        formatTimeAgo: function(date) {\n            var seconds = Math.floor((new Date() - date) / 1000);\n\n            if (seconds < 60) {\n                return 'Just now';\n            }\n\n            var minutes = Math.floor(seconds / 60);\n            if (minutes < 60) {\n                return minutes + ' minute' + (minutes !== 1 ? 's' : '') + ' ago';\n            }\n\n            var hours = Math.floor(minutes / 60);\n            if (hours < 24) {\n                return hours + ' hour' + (hours !== 1 ? 's' : '') + ' ago';\n            }\n\n            var days = Math.floor(hours / 24);\n            return days + ' day' + (days !== 1 ? 's' : '') + ' ago';\n        }\n    };\n\n    return {\n        /**\n         * Initialize the block.\n         *\n         * @param {Object} options\n         */\n        init: function(options) {\n            return new BlockController(options);\n        }\n    };\n});\n"],"names":["define","$","Ajax","Notification","Str","ModalFactory","ModalEvents","Templates","Chart","BlockController","options","blockId","blockid","contextId","contextid","config","apiKey","isAdmin","container","reports","lastUpdated","refreshTimer","modal","modalData","modalReport","chartInstance","currentView","listCurrentPage","listItemsPerPage","this","maxLinkItems","listTotalPages","tableCurrentPage","tableRowsPerPage","tableTotalPages","selectedCategory","availableCategories","selectedReportSlug","defaultReport","selectedReportSource","embeddedCurrentView","embeddedTablePage","embeddedTableRowsPerPage","embeddedChartType","embeddedXAxis","embeddedYAxis","backendUrl","cacheKey","cacheTTL","reportDataCache","preloadTimeout","preloadingSlug","tabPaneStates","tabChartInstances","kpiModal","kpiModalChart","kpiModalData","kpiModalDateRange","kpiSnapshotCache","registeredSnapshots","init","prototype","length","bindEvents","loadReports","setupAutoRefresh","self","on","e","preventDefault","refresh","slug","data","source","handleReportClick","key","tabPane","target","attr","loadTabContent","format","exportReport","renderCurrentPage","scrollToListTop","val","displayMode","populateReportSelector","renderReports","selectedValue","parts","split","loadEmbeddedReport","stopPropagation","dropdown","closest","toggleSearchableDropdown","query","toLowerCase","trim","filterSearchableDropdown","value","text","find","selectSearchableDropdownItem","items","focused","first","addClass","next","nextAll","removeClass","scrollDropdownItemIntoView","prev","prevAll","trigger","closeSearchableDropdown","document","each","view","switchEmbeddedView","renderEmbeddedTablePage","scrollToEmbeddedTableTop","totalPages","Math","ceil","embeddedData","renderEmbeddedChart","exportEmbeddedReport","pane","switchTabView","tabId","state","tablePage","renderTabTablePage","rowsPerPage","chartType","renderTabChart","xAxis","yAxis","exportTabReport","clearTimeout","setTimeout","preloadReportData","showLoading","cachedData","getFromCache","Date","waitForAuth","fetchReports","cached","sessionStorage","getItem","JSON","parse","timestamp","now","removeItem","saveToCache","setItem","stringify","report","r","ajax","url","M","cfg","wwwroot","method","reportid","name","report_template_id","sesskey","dataType","timeout","done","response","success","results","chartData","chart_data","chart_type","fail","token","window","adeptusAuthData","api_key","headers","reportData","sqlQuery","sql","sql_query","execution_required","executeReportLocally","params","then","executionResult","localData","catch","callback","showError","promises","reportSource","push","fetchFromApi","when","apply","allReports","i","result","arguments","fetchesBoth","forEach","endpoint","baseUrl","mode","populateCategoryFilter","filteredReports","filterReports","renderEmbedded","kpiReports","getSelectedReportsForMode","renderKpi","tabsReports","renderTabs","renderLinks","hideLoading","updateTimestamp","showEmpty","selectedConfig","kpiSelectedReports","tabsSelectedReports","item","enrichedReport","Object","assign","icon","customIcon","categoryMap","categoryLocked","reportCategory","catInfo","category_info","color","category","displayName","replace","l","toUpperCase","values","sort","a","b","localeCompare","select","dropdownList","remove","cat","selected","append","empty","allItemHtml","itemHtml","escapeHtml","selectedText","selectedCat","c","hide","reportName","title","display_name","categoryInfo","categoryLabel","defaultOption","prop","firstReport","firstValue","firstName","selectedReport","selectedName","slice","filter","nameA","report_name","nameB","listContainer","template","paginationContainer","startIndex","endIndex","pageReports","html","$item","categoryName","categoryColor","css","actualEnd","embeddedReport","embeddedChartInstance","renderEmbeddedContent","showEmbeddedLoadingOverlay","hideEmbeddedLoadingOverlay","message","error","contentArea","toLocaleTimeString","populateEmbeddedChartControls","keys","numericCols","detectNumericColumns","xAxisSelect","yAxisSelect","h","formatted","table","thead","tbody","headerRow","min","row","tr","displayVal","String","substring","canvas","destroy","labels","map","label","labelStr","parseFloat","colors","generateChartColors","datasetConfig","backgroundColor","borderWidth","borderColor","type","datasets","responsive","maintainAspectRatio","plugins","legend","display","position","scales","y","beginAtZero","x","getContext","csvContent","join","rowValues","strVal","includes","blob","Blob","link","createElement","href","URL","createObjectURL","download","toISOString","click","gridContainer","maxCards","parseInt","kpiColumns","max","cardMap","wizardReports","aiReports","index","card","$card","defaultIcons","iconClass","loadKpiBatch","cardInfo","loadKpiData","reportIds","performance","id","reportids","reportId","renderKpiValue","cardIndex","retryCount","jqXHR","textStatus","status","saveKpiHistoryToServer","formattedValue","valueCol","reduce","sum","formatKpiValue","toFixed","Number","isInteger","toLocaleString","rowCount","executionTimeMs","snapshotsEnabled","postSnapshotToBackend","metricValue","baselinePeriod","historyLimit","getHistoryLimitForBaseline","encodeURIComponent","row_count","execution_time_ms","evaluate_alerts","baseline_period","history","trend","currentValue","registerSnapshotSchedule","updateKpiTrendFromBackend","renderKpiSparklineFromBackend","alerts","triggered_count","handleTriggeredAlerts","triggered","scheduleKey","intervalSeconds","kpiHistoryInterval","call","methodname","args","blockinstanceid","reportslug","reportsource","intervalseconds","rowcount","trendContainer","vs_baseline","vs_previous","updateKpiDualTrend","has_previous","direction","percentage","abs","change_percent","changeText","formatPercentage","vsBaseline","vsPrevious","hasBaseline","has_baseline","hasPrevious","baselinePct","baselineIcon","getTrendIcon","baselineSign","previousPct","previousIcon","previousSign","primaryDirection","round","formatNumber","num","isNaN","toString","formatTimestamp","date","diffMs","diffMins","floor","diffHours","diffDays","getMonth","getDate","getFullYear","sparklineData","point","reverse","renderKpiSparklineFromData","triggeredAlerts","reportSlug","alertsConfig","alertsToSend","alert","alertName","alert_name","current_value","actual_value","displayReportName","alertId","alert_id","localConfig","backend_id","severity","thresholdValue","threshold","threshold_value","warningThreshold","warning_value","criticalThreshold","critical_value","is_critical","changeAbs","change_absolute","changePct","report_slug","notify_users","require","sent_count","refreshNotificationArea","$popover","userId","useridto","count","$countContainer","loadKpiSparklineFromServer","updateKpiTrendFromServer","absChange","updateKpiTrend","sparklineContainer","dataPoints","lastValue","trendColor","trendBgColor","chartKey","kpiSparklineCharts","fill","tension","pointRadius","pointHoverRadius","tooltip","enabled","elements","line","borderCapStyle","animation","duration","renderKpiSparkline","tabNav","tabContent","tabTemplate","paneTemplate","tab","firstPane","renderTabContent","updateTabMetaBar","populateTabChartControls","category_name","categoryBadge","category_color","dateStr","updated_at","created_at","toLocaleDateString","header","totalRows","showingText","undefined","csvRows","rowData","body","appendChild","removeChild","revokeObjectURL","renderTabTable","maxRows","tableMaxRows","action","clickAction","alertsFeatureEnabled","openKpiModal","openReportModal","openReportNewTab","expandReportInline","render","create","types","DEFAULT","large","bindModalEvents","getRoot","shown","loadModalReport","hidden","show","exception","bindKpiModalEvents","loadKpiModalData","modalRoot","dateRange","modalContent","renderKpiModal","getKpiModalHistoryLimit","showKpiModalError","recorded_at","filteredHistory","filterKpiHistoryByDateRange","renderKpiModalTrends","stats","calculateKpiStats","avg","lastEntry","renderKpiModalChart","cutoffDate","getTime","entry","baselineHtml","previousHtml","formatChartDate","ctx","pointBackgroundColor","pointBorderColor","pointBorderWidth","interaction","intersect","titleColor","bodyColor","padding","displayColors","callbacks","tooltipItems","context","parsed","grid","ticks","maxRotation","minRotation","autoSkip","maxTicksLimit","switchModalView","renderModalChart","exportModalData","renderModalTablePage","modalBody","getBody","renderModalContent","last_executed_at","populateAxisSelectors","renderModalTable","reportUrl","idx","formattedHeader","yAxisOptions","col","isNumeric","every","isFinite","hasNumbers","some","Promise","resolve","reject","contentType","xhr","Error","labelKey","valueKey","valueKeyFormatted","createChartConfig","baseOptions","font","size","weight","top","bottom","baseColors","indexOf","addNotification","open","refreshBtn","clearAllCaches","interval","autoRefresh","ms","setInterval","formatTimeAgo","kpiFooter","showTimestamp","timestampEl","scrollIntoView","behavior","block","tableContainer","overlay","animate","opacity","hasClass","openSearchableDropdown","is","input","focus","emptyState","visibleCount","searchText","siblings","list","listHeight","height","itemTop","itemHeight","outerHeight","scrollTop","div","textContent","innerHTML","seconds","minutes","hours","days"],"mappings":"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"}