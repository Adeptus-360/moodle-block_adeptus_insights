{"version":3,"file":"block.min.js","sources":["../src/block.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Main JavaScript controller for the Adeptus Insights block.\n *\n * @module     block_adeptus_insights/block\n * @copyright  2026 Adeptus 360 <info@adeptus360.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\n    'jquery',\n    'core/ajax',\n    'core/notification',\n    'core/str',\n    'core/modal_factory',\n    'core/modal_events',\n    'core/templates',\n    'core/chartjs'\n], function($, Ajax, Notification, Str, ModalFactory, ModalEvents, Templates, Chart) {\n    'use strict';\n\n    /**\n     * Block controller class.\n     *\n     * @param {Object} options Configuration options\n     */\n    var BlockController = function(options) {\n        this.blockId = options.blockid;\n        this.contextId = options.contextid;\n        this.config = options.config || {};\n        this.apiKey = options.apiKey || ''; // API key passed directly from PHP.\n        this.isAdmin = options.isAdmin || false; // Site admin flag.\n        this.container = null;\n        this.reports = [];\n        this.lastUpdated = null;\n        this.refreshTimer = null;\n        this.modal = null;\n        this.modalData = null; // Current modal report data.\n        this.modalReport = null; // Current modal report metadata.\n        this.chartInstance = null; // Current Chart.js instance.\n        this.currentView = 'table'; // Current view mode.\n\n        // Pagination state for report list\n        this.listCurrentPage = 1;\n        this.listItemsPerPage = this.config.maxLinkItems || 10;\n        this.listTotalPages = 1;\n\n        // Pagination state for modal table\n        this.tableCurrentPage = 1;\n        this.tableRowsPerPage = 25;\n        this.tableTotalPages = 1;\n\n        // Category filter state\n        this.selectedCategory = '';\n        this.availableCategories = [];\n\n        // Report selector state (for embedded mode)\n        this.selectedReportSlug = this.config.defaultReport || '';\n        this.selectedReportSource = '';\n\n        // Embedded mode state (mirrors modal functionality)\n        this.embeddedCurrentView = 'table';\n        this.embeddedTablePage = 1;\n        this.embeddedTableRowsPerPage = 25;\n        this.embeddedChartType = 'bar';\n        this.embeddedXAxis = '';\n        this.embeddedYAxis = '';\n\n        // Backend API URL - use config value or fall back to default\n        this.backendUrl = this.config.backendUrl || 'https://backend.adeptus360.com/api/v1';\n\n        // Cache settings\n        this.cacheKey = 'adeptus_block_reports_' + this.blockId;\n        this.cacheTTL = 5 * 60 * 1000; // 5 minutes\n        this.reportDataCache = {}; // In-memory cache for executed report data\n        this.preloadTimeout = null;\n        this.preloadingSlug = null;\n\n        // Tabs mode state (per-pane state for view toggle, pagination, chart)\n        this.tabPaneStates = {};\n        this.tabChartInstances = {};\n\n        // KPI Modal state\n        this.kpiModal = null;\n        this.kpiModalChart = null;\n        this.kpiModalData = null;\n        this.kpiModalDateRange = '30d';\n\n        // KPI Snapshot data cache (stores responses from postSnapshotToBackend)\n        this.kpiSnapshotCache = {};\n\n        // Snapshot schedule registration tracking\n        this.registeredSnapshots = {};\n\n        // Language strings (loaded asynchronously)\n        this.strings = {};\n\n        this.init();\n    };\n\n    BlockController.prototype = {\n        /**\n         * Capitalize each word in a string (replace underscores/dashes with spaces first).\n         *\n         * @param {string} str The string to capitalize\n         * @return {string} The capitalized string\n         */\n        capitalizeWords: function(str) {\n            return str\n                .replace(/[-_]/g, ' ')\n                .replace(/\\b\\w/g, function(letter) {\n                    return letter.toUpperCase();\n                });\n        },\n\n        /**\n         * Initialize the block.\n         */\n        init: function() {\n            var self = this;\n\n            // Find the block container.\n            this.container = $('[data-blockid=\"' + this.blockId + '\"]');\n            if (!this.container.length) {\n                return;\n            }\n\n            // Load language strings first, then continue initialization.\n            this.loadStrings().then(function() {\n                // Bind event handlers.\n                self.bindEvents();\n\n                // Load initial data.\n                self.loadReports();\n\n                // Setup auto-refresh if configured.\n                self.setupAutoRefresh();\n                return true;\n            }).catch(function() {\n                // String loading handled in loadStrings, continue anyway.\n                return false;\n            });\n        },\n\n        /**\n         * Load language strings for use in JavaScript.\n         *\n         * @return {Promise} Promise that resolves when strings are loaded\n         */\n        loadStrings: function() {\n            var self = this;\n            var stringKeys = [\n                {key: 'js_error_auth_failed', component: 'block_adeptus_insights'},\n                {key: 'js_error_could_not_auth', component: 'block_adeptus_insights'},\n                {key: 'js_error_no_auth_token', component: 'block_adeptus_insights'},\n                {key: 'js_error_report_not_found', component: 'block_adeptus_insights'},\n                {key: 'js_error_connection', component: 'block_adeptus_insights'},\n                {key: 'js_error_failed_load_report', component: 'block_adeptus_insights'},\n                {key: 'js_error_failed_execute_report', component: 'block_adeptus_insights'},\n                {key: 'js_error_failed_to_load', component: 'block_adeptus_insights'},\n                {key: 'js_error_query_failed', component: 'block_adeptus_insights'},\n                {key: 'js_export_no_data', component: 'block_adeptus_insights'},\n                {key: 'js_export_not_available', component: 'block_adeptus_insights'},\n                {key: 'js_export_verify_error', component: 'block_adeptus_insights'},\n                {key: 'js_no_reports', component: 'block_adeptus_insights'},\n                {key: 'js_no_change', component: 'block_adeptus_insights'},\n                {key: 'js_unknown', component: 'block_adeptus_insights'},\n                {key: 'js_just_now', component: 'block_adeptus_insights'},\n                {key: 'loading', component: 'block_adeptus_insights'},\n                {key: 'showingxofy', component: 'block_adeptus_insights'},\n                {key: 'page', component: 'block_adeptus_insights'},\n                {key: 'of', component: 'block_adeptus_insights'},\n                {key: 'lastupdated', component: 'block_adeptus_insights'},\n                {key: 'js_vs_previous', component: 'block_adeptus_insights'},\n                {key: 'js_min_ago', component: 'block_adeptus_insights'},\n                {key: 'js_hour_ago', component: 'block_adeptus_insights'},\n                {key: 'js_hours_ago', component: 'block_adeptus_insights'},\n                {key: 'js_day_ago', component: 'block_adeptus_insights'},\n                {key: 'js_days_ago', component: 'block_adeptus_insights'},\n                {key: 'js_last_run', component: 'block_adeptus_insights'},\n                {key: 'js_export_title', component: 'block_adeptus_insights'},\n                {key: 'js_export_not_on_plan', component: 'block_adeptus_insights'},\n                {key: 'js_ok', component: 'block_adeptus_insights'}\n            ];\n\n            return Str.get_strings(stringKeys).then(function(strings) {\n                self.strings = {\n                    errorAuthFailed: strings[0],\n                    errorCouldNotAuth: strings[1],\n                    errorNoAuthToken: strings[2],\n                    errorReportNotFound: strings[3],\n                    errorConnection: strings[4],\n                    errorFailedLoadReport: strings[5],\n                    errorFailedExecuteReport: strings[6],\n                    errorFailedToLoad: strings[7],\n                    errorQueryFailed: strings[8],\n                    exportNoData: strings[9],\n                    exportNotAvailable: strings[10],\n                    exportVerifyError: strings[11],\n                    noReports: strings[12],\n                    noChange: strings[13],\n                    unknown: strings[14],\n                    justNow: strings[15],\n                    loading: strings[16],\n                    showingXOfY: strings[17],\n                    page: strings[18],\n                    of: strings[19],\n                    lastUpdated: strings[20],\n                    vsPrevious: strings[21],\n                    minAgo: strings[22],\n                    hourAgo: strings[23],\n                    hoursAgo: strings[24],\n                    dayAgo: strings[25],\n                    daysAgo: strings[26],\n                    lastRun: strings[27],\n                    exportTitle: strings[28],\n                    exportNotOnPlan: strings[29],\n                    ok: strings[30]\n                };\n                return self.strings;\n            }).catch(function() {\n                // Fallback to English if string loading fails.\n                self.strings = {\n                    errorAuthFailed: 'Authentication failed',\n                    errorCouldNotAuth: 'Could not authenticate',\n                    errorNoAuthToken: 'No authentication token',\n                    errorReportNotFound: 'Report not found',\n                    errorConnection: 'Connection error',\n                    errorFailedLoadReport: 'Failed to load report',\n                    errorFailedExecuteReport: 'Failed to execute report',\n                    errorFailedToLoad: 'Failed to load',\n                    errorQueryFailed: 'Query execution failed',\n                    exportNoData: 'No data to export',\n                    exportNotAvailable: 'Export not available',\n                    exportVerifyError: 'Unable to verify export eligibility. Please try again.',\n                    noReports: '-- No Reports --',\n                    noChange: 'No change',\n                    unknown: 'Unknown',\n                    justNow: 'Just now',\n                    loading: 'Loading...',\n                    showingXOfY: 'Showing {$a->start}-{$a->end} of {$a->total}',\n                    page: 'Page',\n                    of: 'of',\n                    lastUpdated: 'Last updated',\n                    vsPrevious: '{$a} vs previous',\n                    minAgo: '{$a} min ago',\n                    hourAgo: '{$a} hour ago',\n                    hoursAgo: '{$a} hours ago',\n                    dayAgo: '{$a} day ago',\n                    daysAgo: '{$a} days ago',\n                    lastRun: 'Last run: {$a}',\n                    exportTitle: '{$a} Export',\n                    exportNotOnPlan: '{$a} export is not available on your current plan.',\n                    ok: 'OK'\n                };\n                return self.strings;\n            });\n        },\n\n        /**\n         * Bind event handlers.\n         */\n        bindEvents: function() {\n            var self = this;\n\n            // Refresh button.\n            this.container.on('click', '.block-adeptus-refresh, .block-adeptus-retry', function(e) {\n                e.preventDefault();\n                self.refresh();\n            });\n\n            // Report item click.\n            this.container.on('click', '.block-adeptus-report-item', function(e) {\n                e.preventDefault();\n                var slug = $(this).data('slug');\n                var source = $(this).data('source');\n                self.handleReportClick(slug, source);\n            });\n\n            // Report item keyboard activation (Enter/Space).\n            this.container.on('keydown', '.block-adeptus-report-item', function(e) {\n                if (e.key === 'Enter' || e.key === ' ') {\n                    e.preventDefault();\n                    var slug = $(this).data('slug');\n                    var source = $(this).data('source');\n                    self.handleReportClick(slug, source);\n                }\n            });\n\n            // KPI card click.\n            this.container.on('click', '.block-adeptus-kpi-card', function(e) {\n                e.preventDefault();\n                var slug = $(this).data('slug');\n                var source = $(this).data('source');\n                self.handleReportClick(slug, source);\n            });\n\n            // Tab click.\n            this.container.on('shown.bs.tab', '.block-adeptus-tab-nav a', function(e) {\n                var tabPane = $($(e.target).attr('href'));\n                var slug = tabPane.data('slug');\n                var source = tabPane.data('source');\n                if (!tabPane.data('loaded')) {\n                    self.loadTabContent(tabPane, slug, source);\n                }\n            });\n\n            // Export buttons.\n            this.container.on('click', '.block-adeptus-export', function(e) {\n                e.preventDefault();\n                var format = $(this).data('format');\n                self.exportReport(format);\n            });\n\n            // Pagination - Previous button.\n            this.container.on('click', '.pagination-prev', function(e) {\n                e.preventDefault();\n                if (self.listCurrentPage > 1) {\n                    self.listCurrentPage--;\n                    self.renderCurrentPage();\n                    self.scrollToListTop();\n                }\n            });\n\n            // Pagination - Next button.\n            this.container.on('click', '.pagination-next', function(e) {\n                e.preventDefault();\n                if (self.listCurrentPage < self.listTotalPages) {\n                    self.listCurrentPage++;\n                    self.renderCurrentPage();\n                    self.scrollToListTop();\n                }\n            });\n\n            // Category filter change.\n            this.container.on('change', '.block-adeptus-category-filter-select', function() {\n                self.selectedCategory = $(this).val();\n                self.listCurrentPage = 1; // Reset to first page\n                // For embedded mode, update the report selector based on new category\n                if (self.config.displayMode === 'embedded') {\n                    self.populateReportSelector();\n                } else {\n                    self.renderReports();\n                }\n            });\n\n            // Report selector change (for embedded mode) - hidden select fallback.\n            this.container.on('change', '.block-adeptus-report-selector-select', function() {\n                var selectedValue = $(this).val();\n                if (selectedValue) {\n                    var parts = selectedValue.split('::');\n                    var slug = parts[0];\n                    var source = parts[1] || 'wizard';\n                    self.selectedReportSlug = slug;\n                    self.selectedReportSource = source;\n                    // Reset embedded state\n                    self.embeddedTablePage = 1;\n                    self.embeddedCurrentView = 'table';\n                    self.loadEmbeddedReport(slug, source);\n                }\n            });\n\n            // Searchable dropdown - Toggle open/close.\n            this.container.on('click', '.block-adeptus-searchable-dropdown-toggle', function(e) {\n                e.preventDefault();\n                e.stopPropagation();\n                var dropdown = $(this).closest('.block-adeptus-searchable-dropdown');\n                self.toggleSearchableDropdown(dropdown);\n            });\n\n            // Searchable dropdown - Search input.\n            this.container.on('input', '.block-adeptus-searchable-dropdown-input', function() {\n                var dropdown = $(this).closest('.block-adeptus-searchable-dropdown');\n                var query = $(this).val().toLowerCase().trim();\n                self.filterSearchableDropdown(dropdown, query);\n            });\n\n            // Searchable dropdown - Item selection.\n            this.container.on('click', '.block-adeptus-searchable-dropdown-item', function(e) {\n                e.preventDefault();\n                e.stopPropagation();\n                var dropdown = $(this).closest('.block-adeptus-searchable-dropdown');\n                var value = $(this).data('value');\n                var text = $(this).find('.block-adeptus-dropdown-item-name').text();\n                self.selectSearchableDropdownItem(dropdown, value, text);\n            });\n\n            // Searchable dropdown - Keyboard navigation.\n            this.container.on('keydown', '.block-adeptus-searchable-dropdown-input', function(e) {\n                var dropdown = $(this).closest('.block-adeptus-searchable-dropdown');\n                var items = dropdown.find('.block-adeptus-searchable-dropdown-item:visible');\n                var focused = dropdown.find('.block-adeptus-searchable-dropdown-item.focused');\n\n                if (e.key === 'ArrowDown') {\n                    e.preventDefault();\n                    if (focused.length === 0) {\n                        items.first().addClass('focused');\n                    } else {\n                        var next = focused.nextAll('.block-adeptus-searchable-dropdown-item:visible').first();\n                        if (next.length) {\n                            focused.removeClass('focused');\n                            next.addClass('focused');\n                            self.scrollDropdownItemIntoView(next);\n                        }\n                    }\n                } else if (e.key === 'ArrowUp') {\n                    e.preventDefault();\n                    if (focused.length) {\n                        var prev = focused.prevAll('.block-adeptus-searchable-dropdown-item:visible').first();\n                        if (prev.length) {\n                            focused.removeClass('focused');\n                            prev.addClass('focused');\n                            self.scrollDropdownItemIntoView(prev);\n                        }\n                    }\n                } else if (e.key === 'Enter') {\n                    e.preventDefault();\n                    if (focused.length) {\n                        focused.trigger('click');\n                    } else if (items.length === 1) {\n                        items.first().trigger('click');\n                    }\n                } else if (e.key === 'Escape') {\n                    self.closeSearchableDropdown(dropdown);\n                }\n            });\n\n            // Close dropdown when clicking outside.\n            $(document).on('click', function(e) {\n                if (!$(e.target).closest('.block-adeptus-searchable-dropdown').length) {\n                    self.container.find('.block-adeptus-searchable-dropdown.open').each(function() {\n                        self.closeSearchableDropdown($(this));\n                    });\n                }\n            });\n\n            // Embedded mode - View toggle (Table/Chart).\n            this.container.on('click', '.block-adeptus-embedded-view-toggle-btn', function(e) {\n                e.preventDefault();\n                var view = $(this).data('view');\n                self.switchEmbeddedView(view);\n            });\n\n            // Embedded mode - Table pagination.\n            this.container.on('click', '.block-adeptus-embedded-pagination-prev', function(e) {\n                e.preventDefault();\n                if (self.embeddedTablePage > 1) {\n                    self.embeddedTablePage--;\n                    self.renderEmbeddedTablePage();\n                    self.scrollToEmbeddedTableTop();\n                }\n            });\n\n            this.container.on('click', '.block-adeptus-embedded-pagination-next', function(e) {\n                e.preventDefault();\n                var totalPages = Math.ceil((self.embeddedData || []).length / self.embeddedTableRowsPerPage);\n                if (self.embeddedTablePage < totalPages) {\n                    self.embeddedTablePage++;\n                    self.renderEmbeddedTablePage();\n                    self.scrollToEmbeddedTableTop();\n                }\n            });\n\n            // Embedded mode - Chart type change.\n            this.container.on('change', '.block-adeptus-embedded-chart-type', function() {\n                self.embeddedChartType = $(this).val();\n                self.renderEmbeddedChart();\n            });\n\n            // Embedded mode - X-Axis change.\n            this.container.on('change', '.block-adeptus-embedded-chart-x-axis', function() {\n                self.embeddedXAxis = $(this).val();\n                self.renderEmbeddedChart();\n            });\n\n            // Embedded mode - Y-Axis change.\n            this.container.on('change', '.block-adeptus-embedded-chart-y-axis', function() {\n                self.embeddedYAxis = $(this).val();\n                self.renderEmbeddedChart();\n            });\n\n            // Embedded mode - Export.\n            this.container.on('click', '.block-adeptus-embedded-export', function(e) {\n                e.preventDefault();\n                var format = $(this).data('format');\n                self.exportEmbeddedReport(format);\n            });\n\n            // Tabs mode - View toggle (Table/Chart).\n            this.container.on('click', '.block-adeptus-tab-view-toggle-btn', function(e) {\n                e.preventDefault();\n                var pane = $(this).closest('.block-adeptus-tab-pane');\n                var view = $(this).data('view');\n                self.switchTabView(pane, view);\n            });\n\n            // Tabs mode - Table pagination.\n            this.container.on('click', '.block-adeptus-tab-pagination-prev', function(e) {\n                e.preventDefault();\n                var pane = $(this).closest('.block-adeptus-tab-pane');\n                var tabId = pane.attr('id');\n                var state = self.tabPaneStates[tabId];\n                if (state && state.tablePage > 1) {\n                    state.tablePage--;\n                    self.renderTabTablePage(pane, state);\n                }\n            });\n\n            this.container.on('click', '.block-adeptus-tab-pagination-next', function(e) {\n                e.preventDefault();\n                var pane = $(this).closest('.block-adeptus-tab-pane');\n                var tabId = pane.attr('id');\n                var state = self.tabPaneStates[tabId];\n                if (state) {\n                    var totalPages = Math.ceil(state.data.length / state.rowsPerPage);\n                    if (state.tablePage < totalPages) {\n                        state.tablePage++;\n                        self.renderTabTablePage(pane, state);\n                    }\n                }\n            });\n\n            // Tabs mode - Chart type change.\n            this.container.on('change', '.block-adeptus-tab-chart-type', function() {\n                var pane = $(this).closest('.block-adeptus-tab-pane');\n                var tabId = pane.attr('id');\n                var state = self.tabPaneStates[tabId];\n                if (state) {\n                    state.chartType = $(this).val();\n                    self.renderTabChart(pane, state);\n                }\n            });\n\n            // Tabs mode - X-Axis change.\n            this.container.on('change', '.block-adeptus-tab-chart-x-axis', function() {\n                var pane = $(this).closest('.block-adeptus-tab-pane');\n                var tabId = pane.attr('id');\n                var state = self.tabPaneStates[tabId];\n                if (state) {\n                    state.xAxis = $(this).val();\n                    self.renderTabChart(pane, state);\n                }\n            });\n\n            // Tabs mode - Y-Axis change.\n            this.container.on('change', '.block-adeptus-tab-chart-y-axis', function() {\n                var pane = $(this).closest('.block-adeptus-tab-pane');\n                var tabId = pane.attr('id');\n                var state = self.tabPaneStates[tabId];\n                if (state) {\n                    state.yAxis = $(this).val();\n                    self.renderTabChart(pane, state);\n                }\n            });\n\n            // Tabs mode - Export.\n            this.container.on('click', '.block-adeptus-tab-export', function(e) {\n                e.preventDefault();\n                var pane = $(this).closest('.block-adeptus-tab-pane');\n                var tabId = pane.attr('id');\n                var state = self.tabPaneStates[tabId];\n                var format = $(this).data('format');\n                if (state) {\n                    self.exportTabReport(state, format);\n                }\n            });\n\n            // Preload report data on hover (300ms delay to avoid unnecessary loads).\n            this.container.on('mouseenter', '.block-adeptus-report-item', function() {\n                var slug = $(this).data('slug');\n                var source = $(this).data('source');\n\n                // Clear any pending preload\n                if (self.preloadTimeout) {\n                    clearTimeout(self.preloadTimeout);\n                }\n\n                // Start preload after 300ms hover\n                self.preloadTimeout = setTimeout(function() {\n                    self.preloadReportData(slug, source);\n                }, 300);\n            });\n\n            this.container.on('mouseleave', '.block-adeptus-report-item', function() {\n                // Cancel pending preload if user moves away\n                if (self.preloadTimeout) {\n                    clearTimeout(self.preloadTimeout);\n                    self.preloadTimeout = null;\n                }\n            });\n        },\n\n        /**\n         * Load reports from the server or cache.\n         */\n        loadReports: function() {\n            var self = this;\n\n            this.showLoading();\n\n            // Try to load from cache first\n            var cachedData = this.getFromCache();\n            if (cachedData) {\n                this.reports = cachedData;\n                this.lastUpdated = new Date();\n                this.renderReports();\n                return;\n            }\n\n            // Wait for auth data to be available.\n            this.waitForAuth(function() {\n                self.fetchReports();\n            });\n        },\n\n        /**\n         * Get reports from sessionStorage cache.\n         *\n         * @return {Array|null}\n         */\n        getFromCache: function() {\n            try {\n                var cached = sessionStorage.getItem(this.cacheKey);\n                if (cached) {\n                    var data = JSON.parse(cached);\n                    if (data.timestamp && (Date.now() - data.timestamp) < this.cacheTTL) {\n                        return data.reports;\n                    }\n                    // Cache expired, remove it\n                    sessionStorage.removeItem(this.cacheKey);\n                }\n            } catch (_e) {\n                // Ignore storage errors\n            }\n            return null;\n        },\n\n        /**\n         * Save reports to sessionStorage cache.\n         *\n         * @param {Array} reports\n         */\n        saveToCache: function(reports) {\n            try {\n                sessionStorage.setItem(this.cacheKey, JSON.stringify({\n                    timestamp: Date.now(),\n                    reports: reports\n                }));\n            } catch (_e) {\n                // Ignore storage errors (quota exceeded, etc.)\n            }\n        },\n\n        /**\n         * Preload report data on hover for faster modal loading.\n         *\n         * @param {string} slug\n         * @param {string} source\n         */\n        preloadReportData: function(slug, source) {\n            var self = this;\n            var cacheKey = slug + '_' + source;\n\n            // Already cached or currently preloading\n            if (this.reportDataCache[cacheKey] || this.preloadingSlug === slug) {\n                return;\n            }\n\n            this.preloadingSlug = slug;\n\n            // Find the report from our cached list\n            var report = this.reports.find(function(r) {\n                return r.slug === slug;\n            });\n\n            if (!report) {\n                return;\n            }\n\n            if (source === 'wizard') {\n                // Preload wizard report\n                $.ajax({\n                    url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/generate_report.php',\n                    method: 'POST',\n                    data: {\n                        reportid: report.name || report.report_template_id,\n                        sesskey: M.cfg.sesskey\n                    },\n                    dataType: 'json',\n                    timeout: 30000\n                }).done(function(response) {\n                    if (response.success) {\n                        self.reportDataCache[cacheKey] = {\n                            report: report,\n                            results: response.results || [],\n                            chartData: response.chart_data,\n                            chartType: response.chart_type\n                        };\n                    }\n                    self.preloadingSlug = null;\n                    return response;\n                }).fail(function() {\n                    self.preloadingSlug = null;\n                    return null;\n                });\n            } else {\n                // Preload AI report\n                var token = this.apiKey || (window.adeptusAuthData ? window.adeptusAuthData.api_key : null);\n                if (!token) {\n                    return;\n                }\n\n                $.ajax({\n                    url: '' + this.backendUrl + '/ai-reports/' + slug,\n                    method: 'GET',\n                    headers: {\n                        'Authorization': 'Bearer ' + token,\n                        'Accept': 'application/json'\n                    },\n                    timeout: 15000\n                }).done(function(response) {\n                    if (response.success && response.report) {\n                        var reportData = response.report;\n                        var data = response.data || [];\n\n                        // Check if local execution is required (SaaS model)\n                        var sqlQuery = response.sql || (reportData && reportData.sql_query) || (reportData && reportData.sql);\n                        var needsLocalExecution = response.execution_required || ((!data || data.length === 0) && sqlQuery);\n\n                        if (needsLocalExecution && sqlQuery) {\n                            // Execute SQL locally against Moodle database\n                            self.executeReportLocally(sqlQuery, reportData.params || {})\n                                .then(function(executionResult) {\n                                    var localData = executionResult.data || [];\n                                    self.reportDataCache[cacheKey] = {\n                                        report: reportData,\n                                        results: localData,\n                                        chartData: null,\n                                        chartType: null\n                                    };\n                                    self.preloadingSlug = null;\n                                    return localData;\n                                })\n                                .catch(function() {\n                                    self.preloadingSlug = null;\n                                    return null;\n                                });\n                            return;\n                        }\n\n                        self.reportDataCache[cacheKey] = {\n                            report: reportData,\n                            results: data,\n                            chartData: null,\n                            chartType: null\n                        };\n                    }\n                    self.preloadingSlug = null;\n                }).fail(function() {\n                    self.preloadingSlug = null;\n                });\n            }\n        },\n\n        /**\n         * Wait for authentication data to be available.\n         * Uses API key passed directly from PHP, or falls back to AJAX.\n         *\n         * @param {Function} callback\n         */\n        waitForAuth: function(callback) {\n            var self = this;\n\n            // Use API key passed directly from PHP (preferred - no AJAX needed)\n            if (this.apiKey) {\n                window.adeptusAuthData = window.adeptusAuthData || {};\n                // eslint-disable-next-line camelcase\n                window.adeptusAuthData.api_key = this.apiKey;\n                callback();\n                return;\n            }\n\n            // Fallback: Check if already authenticated via parent plugin\n            if (window.adeptusAuthData && window.adeptusAuthData.api_key) {\n                callback();\n                return;\n            }\n\n            // Last resort: Try to fetch auth via AJAX\n            $.ajax({\n                url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/get_auth_status.php',\n                method: 'GET',\n                dataType: 'json',\n                timeout: 10000\n            }).done(function(response) {\n                if (response && response.success && response.data) {\n                    window.adeptusAuthData = response.data;\n                    callback();\n                } else {\n                    self.showError(self.strings.errorAuthFailed);\n                }\n                return response;\n            }).fail(function() {\n                self.showError(self.strings.errorCouldNotAuth);\n                return null;\n            });\n        },\n\n        /**\n         * Fetch reports from the backend API.\n         */\n        fetchReports: function() {\n            var self = this;\n            var token = this.apiKey || (window.adeptusAuthData ? window.adeptusAuthData.api_key : null);\n\n            if (!token) {\n                this.showError(this.strings.errorNoAuthToken);\n                return;\n            }\n\n            var promises = [];\n            var source = this.config.reportSource || 'all';\n\n            // For 'manual' and 'category' sources, we need to fetch all reports first,\n            // then filter them in filterReports(). Same for 'all'.\n            if (source === 'all' || source === 'wizard' || source === 'manual' || source === 'category') {\n                promises.push(this.fetchFromApi('/wizard-reports', token));\n            }\n\n            if (source === 'all' || source === 'ai' || source === 'manual' || source === 'category') {\n                promises.push(this.fetchFromApi('/ai-reports', token));\n            }\n\n            $.when.apply($, promises).then(function() {\n                var allReports = [];\n\n                for (var i = 0; i < promises.length; i++) {\n                    var result;\n                    if (promises.length === 1) {\n                        result = arguments[0];\n                    } else {\n                        result = arguments[i][0];\n                    }\n\n                    var reports = result.reports || result.data || [];\n                    if (reports && reports.length) {\n                        // Determine report source: for sources that fetch both APIs (all, manual, category),\n                        // the second promise (i === 1) is AI reports.\n                        var fetchesBoth = (source === 'all' || source === 'manual' || source === 'category');\n                        var currentSource = (source === 'ai' || (i === 1 && fetchesBoth)) ? 'ai' : 'wizard';\n                        // Use IIFE with bound variables to avoid loop-func issue.\n                        (function(reportSource, reportsArr) {\n                            reportsArr.forEach(function(report) {\n                                report.source = report.source || reportSource;\n                                allReports.push(report);\n                            });\n                        }(currentSource, reports));\n                    }\n                }\n\n                self.reports = allReports;\n                self.lastUpdated = new Date();\n                self.saveToCache(allReports);\n                self.renderReports();\n                return allReports;\n            }).fail(function() {\n                self.showError();\n                return null;\n            });\n        },\n\n        /**\n         * Fetch data from the backend API.\n         *\n         * @param {string} endpoint API endpoint\n         * @param {string} token Auth token\n         * @return {Promise}\n         */\n        fetchFromApi: function(endpoint, token) {\n            var baseUrl = '' + this.backendUrl + '';\n\n            return $.ajax({\n                url: baseUrl + endpoint,\n                method: 'GET',\n                headers: {\n                    'Authorization': 'Bearer ' + token,\n                    'Content-Type': 'application/json',\n                    'Accept': 'application/json'\n                },\n                timeout: 15000\n            });\n        },\n\n        /**\n         * Render reports based on display mode.\n         */\n        renderReports: function() {\n            var mode = this.config.displayMode || 'links';\n\n            if (this.reports.length === 0) {\n                this.showEmpty();\n                return;\n            }\n\n            // Extract and populate category filter (only for modes that use it)\n            if (mode === 'embedded' || mode === 'links') {\n                this.populateCategoryFilter();\n            }\n\n            // Filter reports based on selected category (for links/embedded modes)\n            var filteredReports = this.filterReports();\n\n            switch (mode) {\n                case 'embedded':\n                    this.renderEmbedded();\n                    break;\n                case 'kpi':\n                    // For KPI mode, use ALL reports for matching since user explicitly selected them\n                    // (category filter doesn't apply - user chose specific reports)\n                    var kpiReports = this.getSelectedReportsForMode('kpi', this.reports);\n                    this.renderKpi(kpiReports);\n                    break;\n                case 'tabs':\n                    // For Tabs mode, use ALL reports for matching since user explicitly selected them\n                    // (category filter doesn't apply - user chose specific reports)\n                    var tabsReports = this.getSelectedReportsForMode('tabs', this.reports);\n                    this.renderTabs(tabsReports);\n                    break;\n                case 'links':\n                default:\n                    this.renderLinks(filteredReports);\n                    break;\n            }\n\n            this.hideLoading();\n            this.updateTimestamp();\n        },\n\n        /**\n         * Get reports filtered by the selected reports configuration for a specific mode.\n         *\n         * @param {string} mode - 'kpi' or 'tabs'\n         * @param {Array} allReports - All available reports\n         * @return {Array} Filtered reports in configured order\n         */\n        getSelectedReportsForMode: function(mode, allReports) {\n            var selectedConfig = [];\n\n            if (mode === 'kpi' && this.config.kpiSelectedReports && this.config.kpiSelectedReports.length > 0) {\n                selectedConfig = this.config.kpiSelectedReports;\n            } else if (mode === 'tabs' && this.config.tabsSelectedReports && this.config.tabsSelectedReports.length > 0) {\n                selectedConfig = this.config.tabsSelectedReports;\n            }\n\n            // If no specific reports configured, return all reports\n            if (selectedConfig.length === 0) {\n                return allReports;\n            }\n\n            // Filter and order reports according to selection\n            var result = [];\n            selectedConfig.forEach(function(item) {\n                var slug = item.slug || item;\n                var source = item.source || 'wizard';\n                var report = allReports.find(function(r) {\n                    return r.slug === slug && (r.source === source || !item.source);\n                });\n                if (report) {\n                    // Clone report and add custom icon if configured\n                    var enrichedReport = Object.assign({}, report);\n                    if (item.icon) {\n                        enrichedReport.customIcon = item.icon;\n                    }\n                    result.push(enrichedReport);\n                }\n            });\n\n            return result;\n        },\n\n        /**\n         * Extract categories from reports and populate the filter dropdown.\n         */\n        populateCategoryFilter: function() {\n            var self = this;\n            var categoryMap = {};\n            var config = this.config;\n\n            // If category is configured in block settings, pre-select it.\n            // The category filter from config is always applied (locked).\n            var categoryLocked = !!config.reportCategory;\n            if (categoryLocked) {\n                this.selectedCategory = config.reportCategory;\n            }\n\n            // Extract unique categories from reports\n            this.reports.forEach(function(report) {\n                var catInfo = report.category_info;\n                if (catInfo && catInfo.slug) {\n                    categoryMap[catInfo.slug] = {\n                        slug: catInfo.slug,\n                        name: catInfo.name || catInfo.slug,\n                        color: catInfo.color || '#6c757d'\n                    };\n                } else if (report.category) {\n                    categoryMap[report.category] = {\n                        slug: report.category,\n                        name: report.category,\n                        color: '#6c757d'\n                    };\n                }\n            });\n\n            // If category is configured but not found in reports, add it as a fallback.\n            // This ensures the dropdown shows the configured category even if no reports match.\n            if (categoryLocked && !categoryMap[config.reportCategory]) {\n                // Format slug as display name (capitalize, replace dashes/underscores with spaces).\n                var displayName = config.reportCategory\n                    .replace(/[-_]/g, ' ')\n                    .replace(/\\b\\w/g, function(letter) {\n                        return letter.toUpperCase();\n                    });\n                categoryMap[config.reportCategory] = {\n                    slug: config.reportCategory,\n                    name: displayName,\n                    color: '#6c757d'\n                };\n            }\n\n            // Convert to array and sort by name\n            this.availableCategories = Object.values(categoryMap).sort(function(a, b) {\n                return a.name.localeCompare(b.name);\n            });\n\n            // Populate hidden select\n            var select = this.container.find('.block-adeptus-category-filter-select');\n            var dropdown = this.container.find('.block-adeptus-category-dropdown');\n            var dropdownList = dropdown.find('.block-adeptus-searchable-dropdown-list');\n\n            if (select.length) {\n                // Keep the first \"All Categories\" option, remove the rest\n                select.find('option:not(:first)').remove();\n\n                // Add category options to hidden select\n                this.availableCategories.forEach(function(cat) {\n                    var selected = self.selectedCategory === cat.slug ? ' selected' : '';\n                    select.append('<option value=\"' + cat.slug + '\"' + selected + '>' + cat.name + '</option>');\n                });\n            }\n\n            // Populate searchable dropdown list\n            if (dropdownList.length) {\n                dropdownList.empty();\n\n                // Add \"All Categories\" option first\n                var allSelected = !this.selectedCategory ? 'selected' : '';\n                var allItemHtml = '<li class=\"block-adeptus-searchable-dropdown-item ' + allSelected + '\" data-value=\"\" ' +\n                    'data-search=\"all categories\" role=\"option\">' +\n                    '<span class=\"block-adeptus-dropdown-item-name\">All Categories</span>' +\n                    '</li>';\n                dropdownList.append(allItemHtml);\n\n                // Add category options\n                this.availableCategories.forEach(function(cat) {\n                    var isSelected = self.selectedCategory === cat.slug ? 'selected' : '';\n                    var itemHtml = '<li class=\"block-adeptus-searchable-dropdown-item ' +\n                        isSelected + '\" data-value=\"' + cat.slug + '\" ' +\n                        'data-search=\"' + cat.name.toLowerCase() + '\" role=\"option\">' +\n                        '<span class=\"block-adeptus-dropdown-item-name\">' + self.escapeHtml(cat.name) + '</span>' +\n                        '<span class=\"block-adeptus-dropdown-item-category\" style=\"background-color: ' + cat.color + '\">' +\n                        '<i class=\"fa fa-circle\" style=\"font-size: 0.5rem;\"></i></span>' +\n                        '</li>';\n                    dropdownList.append(itemHtml);\n                });\n\n                // Update dropdown text to show selected category\n                var selectedText = 'All Categories';\n                if (this.selectedCategory) {\n                    var selectedCat = this.availableCategories.find(function(c) {\n                        return c.slug === self.selectedCategory;\n                    });\n                    if (selectedCat) {\n                        selectedText = selectedCat.name;\n                    }\n                }\n                dropdown.find('.block-adeptus-searchable-dropdown-text').text(selectedText);\n\n                // If category is locked via config, hide the entire category filter\n                if (categoryLocked) {\n                    this.container.find('.block-adeptus-category-filter').hide();\n                }\n            }\n        },\n\n        /**\n         * Populate the report selector dropdown (for embedded mode).\n         * Filters reports based on selected category.\n         */\n        populateReportSelector: function() {\n            var self = this;\n            var select = this.container.find('.block-adeptus-report-selector-select');\n            var dropdown = this.container.find('.block-adeptus-report-selector .block-adeptus-searchable-dropdown');\n            var dropdownList = dropdown.find('.block-adeptus-searchable-dropdown-list');\n\n            if (!select.length) {\n                return;\n            }\n\n            // Get filtered reports based on category\n            var reports = this.filterReports();\n\n            // Clear existing options\n            select.find('option:not(:first)').remove();\n            dropdownList.empty();\n\n            // Add report options to both hidden select and searchable dropdown\n            reports.forEach(function(report) {\n                var reportName = report.name || report.title || report.display_name || report.slug || 'Untitled';\n                var value = report.slug + '::' + report.source;\n                var categoryInfo = report.category_info || {name: 'General', color: '#6c757d'};\n                var categoryLabel = ' [' + categoryInfo.name + ']';\n                var selected = (self.selectedReportSlug === report.slug) ? ' selected' : '';\n\n                // Hidden select option\n                select.append('<option value=\"' + value + '\"' + selected + '>' + reportName + categoryLabel + '</option>');\n\n                // Searchable dropdown item\n                var itemHtml = '<li class=\"block-adeptus-searchable-dropdown-item\" data-value=\"' + value + '\" data-search=\"' +\n                    reportName.toLowerCase() + ' ' + categoryInfo.name.toLowerCase() + '\" role=\"option\">' +\n                    '<span class=\"block-adeptus-dropdown-item-name\">' + self.escapeHtml(reportName) + '</span>' +\n                    '<span class=\"block-adeptus-dropdown-item-category\" style=\"background-color: ' + categoryInfo.color + '\">' +\n                    self.escapeHtml(categoryInfo.name) + '</span>' +\n                    '</li>';\n                dropdownList.append(itemHtml);\n            });\n\n            // If we have a default report configured and it's in the list, select it\n            if (this.selectedReportSlug && !select.val()) {\n                var defaultOption = select.find('option[value^=\"' + this.selectedReportSlug + '::\"]');\n                if (defaultOption.length) {\n                    defaultOption.prop('selected', true);\n                }\n            }\n\n            // If no report selected and we have reports, auto-select the first one\n            if (!select.val() && reports.length > 0) {\n                var firstReport = reports[0];\n                var firstValue = firstReport.slug + '::' + firstReport.source;\n                var firstName = firstReport.name || firstReport.title || firstReport.display_name || firstReport.slug || 'Untitled';\n                select.val(firstValue);\n                this.selectedReportSlug = firstReport.slug;\n                this.selectedReportSource = firstReport.source;\n                // Update searchable dropdown display\n                dropdown.find('.block-adeptus-searchable-dropdown-text').text(firstName);\n                dropdown.find('.block-adeptus-searchable-dropdown-item').removeClass('selected');\n                dropdown.find('.block-adeptus-searchable-dropdown-item[data-value=\"' + firstValue + '\"]').addClass('selected');\n                // Load the first report\n                this.loadEmbeddedReport(firstReport.slug, firstReport.source);\n            } else if (select.val()) {\n                // A report is selected, load it and update display\n                var parts = select.val().split('::');\n                var selectedReport = reports.find(function(r) {\n                    return r.slug === parts[0];\n                });\n                if (selectedReport) {\n                    var selectedName = selectedReport.name || selectedReport.title ||\n                        selectedReport.display_name || selectedReport.slug || 'Untitled';\n                    dropdown.find('.block-adeptus-searchable-dropdown-text').text(selectedName);\n                    dropdown.find('.block-adeptus-searchable-dropdown-item').removeClass('selected');\n                    dropdown.find('.block-adeptus-searchable-dropdown-item[data-value=\"' +\n                        select.val() + '\"]').addClass('selected');\n                }\n                this.loadEmbeddedReport(parts[0], parts[1] || 'wizard');\n            } else {\n                // No reports available\n                dropdown.find('.block-adeptus-searchable-dropdown-text').text(this.strings.noReports);\n                this.showEmpty();\n            }\n        },\n\n        /**\n         * Filter reports based on configuration and selected category.\n         *\n         * @return {Array}\n         */\n        filterReports: function() {\n            var self = this;\n            var reports = this.reports.slice();\n            var config = this.config;\n\n            // Filter by category from block config (always apply if set).\n            if (config.reportCategory) {\n                reports = reports.filter(function(r) {\n                    var catSlug = r.category_info ? r.category_info.slug : (r.category || '');\n                    return catSlug === config.reportCategory;\n                });\n            }\n\n            // Filter by selected category from dropdown (runtime selection, further filters config).\n            if (this.selectedCategory && this.selectedCategory !== config.reportCategory) {\n                reports = reports.filter(function(r) {\n                    var catSlug = r.category_info ? r.category_info.slug : (r.category || '');\n                    return catSlug === self.selectedCategory;\n                });\n            }\n\n            // Sort by name (try multiple possible name fields).\n            reports.sort(function(a, b) {\n                var nameA = a.name || a.title || a.display_name || a.report_name || a.slug || '';\n                var nameB = b.name || b.title || b.display_name || b.report_name || b.slug || '';\n                return nameA.localeCompare(nameB);\n            });\n\n            return reports;\n        },\n\n        /**\n         * Render link list mode with pagination.\n         *\n         * @param {Array} reports\n         */\n        renderLinks: function(reports) {\n            // Store filtered reports for pagination\n            this.filteredReports = reports;\n\n            // Calculate pagination\n            this.listItemsPerPage = this.config.maxLinkItems || 10;\n            this.listTotalPages = Math.ceil(reports.length / this.listItemsPerPage);\n            this.listCurrentPage = 1; // Reset to first page\n\n            // Render the first page\n            this.renderCurrentPage();\n        },\n\n        /**\n         * Render the current page of reports.\n         */\n        renderCurrentPage: function() {\n            var reports = this.filteredReports || [];\n            var listContainer = this.container.find('.block-adeptus-report-list');\n            var template = $('#block-adeptus-report-item-template-' + this.blockId);\n            var paginationContainer = this.container.find('.block-adeptus-pagination');\n\n            // Calculate page slice\n            var startIndex = (this.listCurrentPage - 1) * this.listItemsPerPage;\n            var endIndex = startIndex + this.listItemsPerPage;\n            var pageReports = reports.slice(startIndex, endIndex);\n\n            listContainer.empty();\n\n            pageReports.forEach(function(report) {\n                var item = template.html();\n                var $item = $(item);\n\n                $item.attr('data-slug', report.slug);\n                $item.attr('data-source', report.source);\n\n                // Try multiple possible name fields (API may use different field names).\n                var reportName = report.name || report.title || report.display_name ||\n                    report.report_name || report.slug || 'Untitled Report';\n                $item.find('.block-adeptus-report-item-name').text(reportName);\n\n                // Set category badge with color\n                var categoryName = report.category_info ? report.category_info.name : report.category || 'General';\n                var categoryColor = report.category_info ? report.category_info.color : '#6c757d';\n                $item.find('.block-adeptus-report-item-category')\n                    .text(categoryName)\n                    .css('background-color', categoryColor)\n                    .css('color', '#fff');\n\n                listContainer.append($item);\n            });\n\n            listContainer.removeClass('d-none');\n\n            // Update pagination controls\n            if (this.listTotalPages > 1) {\n                // Use actual page data length for accurate count\n                var actualEnd = startIndex + pageReports.length;\n                paginationContainer.find('.pagination-showing')\n                    .text(this.formatShowingText(startIndex + 1, actualEnd, reports.length));\n                paginationContainer.find('.pagination-pages')\n                    .text(this.formatPageText(this.listCurrentPage, this.listTotalPages));\n\n                // Update button states\n                paginationContainer.find('.pagination-prev').prop('disabled', this.listCurrentPage <= 1);\n                paginationContainer.find('.pagination-next').prop('disabled', this.listCurrentPage >= this.listTotalPages);\n\n                paginationContainer.removeClass('d-none');\n            } else {\n                paginationContainer.addClass('d-none');\n            }\n        },\n\n        /**\n         * Render embedded report mode.\n         */\n        renderEmbedded: function() {\n            // Initialize embedded report state\n            this.embeddedReport = null;\n            this.embeddedData = null;\n            this.embeddedChartInstance = null;\n\n            // Populate the report selector dropdown\n            // This will also auto-load the first/default report\n            this.populateReportSelector();\n\n            // Hide loading state if no reports\n            if (this.reports.length === 0) {\n                this.showEmpty();\n            }\n        },\n\n        /**\n         * Load report data for embedded display.\n         *\n         * @param {string} slug\n         * @param {string} source\n         */\n        loadEmbeddedReport: function(slug, source) {\n            var self = this;\n            var cacheKey = slug + '_' + source;\n\n            // Check cache first for instant loading (no overlay needed)\n            if (this.reportDataCache[cacheKey]) {\n                var cached = this.reportDataCache[cacheKey];\n                this.embeddedData = cached.results;\n                this.renderEmbeddedContent(cached.report, cached.results);\n                return;\n            }\n\n            // Show loading overlay for non-cached requests\n            this.showEmbeddedLoadingOverlay();\n\n            // Find the report from our cached list\n            var report = this.reports.find(function(r) {\n                return r.slug === slug;\n            });\n\n            if (!report) {\n                this.hideEmbeddedLoadingOverlay();\n                this.showError(this.strings.errorReportNotFound);\n                return;\n            }\n\n            // For wizard reports, execute locally via generate_report.php\n            if (source === 'wizard') {\n                $.ajax({\n                    url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/generate_report.php',\n                    method: 'POST',\n                    data: {\n                        reportid: report.name || report.report_template_id,\n                        sesskey: M.cfg.sesskey\n                    },\n                    dataType: 'json',\n                    timeout: 30000\n                }).done(function(response) {\n                    self.hideEmbeddedLoadingOverlay();\n                    if (response.success) {\n                        // Cache the result\n                        self.reportDataCache[cacheKey] = {\n                            report: report,\n                            results: response.results || [],\n                            chartData: response.chart_data,\n                            chartType: response.chart_type\n                        };\n                        self.embeddedData = response.results || [];\n                        self.renderEmbeddedContent(report, response.results || []);\n                    } else {\n                        self.showError(response.message || self.strings.errorFailedLoadReport);\n                    }\n                }).fail(function() {\n                    self.hideEmbeddedLoadingOverlay();\n                    self.showError(self.strings.errorConnection);\n                });\n            } else {\n                // AI reports - fetch from backend API\n                var token = this.apiKey || (window.adeptusAuthData ? window.adeptusAuthData.api_key : null);\n\n                if (!token) {\n                    this.hideEmbeddedLoadingOverlay();\n                    this.showError(this.strings.errorNoAuthToken);\n                    return;\n                }\n\n                $.ajax({\n                    url: '' + this.backendUrl + '/ai-reports/' + slug,\n                    method: 'GET',\n                    headers: {\n                        'Authorization': 'Bearer ' + token,\n                        'Accept': 'application/json'\n                    },\n                    timeout: 15000\n                }).done(function(response) {\n                    if (response.success && response.report) {\n                        var reportData = response.report;\n                        var data = response.data || [];\n\n                        // Check if local execution is required (SaaS model)\n                        var sqlQuery = response.sql || (reportData && reportData.sql_query) || (reportData && reportData.sql);\n                        var needsLocalExecution = response.execution_required || ((!data || data.length === 0) && sqlQuery);\n\n                        if (needsLocalExecution && sqlQuery) {\n                            // Execute SQL locally against Moodle database\n                            self.executeReportLocally(sqlQuery, reportData.params || {})\n                                .then(function(executionResult) {\n                                    self.hideEmbeddedLoadingOverlay();\n                                    var localData = executionResult.data || [];\n                                    self.reportDataCache[cacheKey] = {\n                                        report: reportData,\n                                        results: localData,\n                                        chartData: null,\n                                        chartType: null\n                                    };\n                                    self.embeddedData = localData;\n                                    self.renderEmbeddedContent(reportData, localData);\n                                    return localData;\n                                })\n                                .catch(function() {\n                                    self.hideEmbeddedLoadingOverlay();\n                                    self.showError(self.strings.errorFailedExecuteReport);\n                                    return null;\n                                });\n                            return;\n                        }\n\n                        self.hideEmbeddedLoadingOverlay();\n                        // Cache the result\n                        self.reportDataCache[cacheKey] = {\n                            report: reportData,\n                            results: data,\n                            chartData: null,\n                            chartType: null\n                        };\n                        self.embeddedData = data;\n                        self.renderEmbeddedContent(reportData, data);\n                    } else {\n                        self.hideEmbeddedLoadingOverlay();\n                        self.showError(self.strings.errorFailedLoadReport);\n                    }\n                }).fail(function() {\n                    self.hideEmbeddedLoadingOverlay();\n                    self.showError(self.strings.errorConnection);\n                });\n            }\n        },\n\n        /**\n         * Render embedded content with report data.\n         *\n         * @param {Object} report\n         * @param {Array} data\n         */\n        renderEmbeddedContent: function(report, data) {\n            var contentArea = this.container.find('.block-adeptus-content');\n\n            if (!data || data.length === 0) {\n                this.showEmpty();\n                return;\n            }\n\n            // Store data for later use\n            this.embeddedReport = report;\n            this.embeddedData = data;\n\n            // Update meta bar\n            var category = report.category_info || {name: 'General', color: '#6c757d'};\n            this.container.find('.block-adeptus-report-category')\n                .text(category.name)\n                .css('background-color', category.color)\n                .css('color', '#fff');\n            this.container.find('.block-adeptus-row-count-num').text(data.length);\n            this.container.find('.report-date').text(this.strings.lastUpdated + ': ' + new Date().toLocaleTimeString());\n\n            // Populate chart axis selectors\n            this.populateEmbeddedChartControls(data);\n\n            // Reset to table view\n            this.embeddedCurrentView = 'table';\n            this.embeddedTablePage = 1;\n            this.container.find('.block-adeptus-embedded-view-toggle-btn').removeClass('active');\n            this.container.find('.block-adeptus-embedded-view-toggle-btn[data-view=\"table\"]').addClass('active');\n            this.container.find('.block-adeptus-embedded-table-view').removeClass('d-none');\n            this.container.find('.block-adeptus-embedded-chart-view').addClass('d-none');\n\n            // Render table with pagination\n            this.renderEmbeddedTablePage();\n\n            contentArea.removeClass('d-none');\n            this.hideLoading();\n            this.updateTimestamp();\n        },\n\n        /**\n         * Switch between table and chart views in embedded mode.\n         *\n         * @param {string} view - 'table' or 'chart'\n         */\n        switchEmbeddedView: function(view) {\n            this.embeddedCurrentView = view;\n\n            // Update toggle buttons\n            this.container.find('.block-adeptus-embedded-view-toggle-btn').removeClass('active');\n            this.container.find('.block-adeptus-embedded-view-toggle-btn[data-view=\"' + view + '\"]').addClass('active');\n\n            // Show/hide views\n            if (view === 'table') {\n                this.container.find('.block-adeptus-embedded-table-view').removeClass('d-none');\n                this.container.find('.block-adeptus-embedded-chart-view').addClass('d-none');\n            } else {\n                this.container.find('.block-adeptus-embedded-table-view').addClass('d-none');\n                this.container.find('.block-adeptus-embedded-chart-view').removeClass('d-none');\n                // Render chart when switching to chart view\n                this.renderEmbeddedChart();\n            }\n        },\n\n        /**\n         * Populate chart control dropdowns for embedded mode.\n         *\n         * @param {Array} data\n         */\n        populateEmbeddedChartControls: function(data) {\n            if (!data || data.length === 0) {\n                return;\n            }\n\n            var headers = Object.keys(data[0]);\n            var numericCols = this.detectNumericColumns(data, headers);\n\n            var xAxisSelect = this.container.find('.block-adeptus-embedded-chart-x-axis');\n            var yAxisSelect = this.container.find('.block-adeptus-embedded-chart-y-axis');\n\n            xAxisSelect.empty();\n            yAxisSelect.empty();\n\n            // Populate X-axis (all columns)\n            headers.forEach(function(h) {\n                var formatted = h.replace(/_/g, ' ').replace(/\\b\\w/g, function(letter) {\n                    return letter.toUpperCase();\n                });\n                xAxisSelect.append('<option value=\"' + h + '\">' + formatted + '</option>');\n            });\n\n            // Populate Y-axis (prefer numeric columns)\n            var yOptions = numericCols.length > 0 ? numericCols : headers;\n            yOptions.forEach(function(h) {\n                var formatted = h.replace(/_/g, ' ').replace(/\\b\\w/g, function(letter) {\n                    return letter.toUpperCase();\n                });\n                yAxisSelect.append('<option value=\"' + h + '\">' + formatted + '</option>');\n            });\n\n            // Set defaults\n            this.embeddedXAxis = headers[0];\n            this.embeddedYAxis = numericCols.length > 0 ? numericCols[numericCols.length - 1] : headers[headers.length - 1];\n\n            xAxisSelect.val(this.embeddedXAxis);\n            yAxisSelect.val(this.embeddedYAxis);\n        },\n\n        /**\n         * Render current page of table in embedded mode.\n         */\n        renderEmbeddedTablePage: function() {\n            var data = this.embeddedData || [];\n            var table = this.container.find('.block-adeptus-embedded-table');\n            var thead = table.find('thead');\n            var tbody = table.find('tbody');\n\n            thead.empty();\n            tbody.empty();\n\n            if (data.length === 0) {\n                return;\n            }\n\n            // Build headers\n            var headers = Object.keys(data[0]);\n            var headerRow = $('<tr>');\n            headers.forEach(function(h) {\n                var formatted = h.replace(/_/g, ' ').replace(/\\b\\w/g, function(letter) {\n                    return letter.toUpperCase();\n                });\n                headerRow.append($('<th>').text(formatted));\n            });\n            thead.append(headerRow);\n\n            // Calculate pagination\n            var totalPages = Math.ceil(data.length / this.embeddedTableRowsPerPage);\n            var startIndex = (this.embeddedTablePage - 1) * this.embeddedTableRowsPerPage;\n            var endIndex = Math.min(startIndex + this.embeddedTableRowsPerPage, data.length);\n            var pageData = data.slice(startIndex, endIndex);\n\n            // Build rows\n            pageData.forEach(function(row) {\n                var tr = $('<tr>');\n                headers.forEach(function(h) {\n                    var val = row[h];\n                    if (val === null || val === undefined) {\n                        val = '';\n                    }\n                    var displayVal = String(val);\n                    if (displayVal.length > 50) {\n                        displayVal = displayVal.substring(0, 50) + '...';\n                    }\n                    tr.append($('<td>').attr('title', val).text(displayVal));\n                });\n                tbody.append(tr);\n            });\n\n            // Update pagination info\n            var showingText = this.formatShowingText(startIndex + 1, endIndex, data.length);\n            this.container.find('.block-adeptus-row-count').text(showingText);\n            var pageText = this.formatPageText(this.embeddedTablePage, totalPages);\n            this.container.find('.block-adeptus-embedded-pagination-info').text(pageText);\n\n            // Update button states\n            this.container.find('.block-adeptus-embedded-pagination-prev').prop('disabled', this.embeddedTablePage <= 1);\n            this.container.find('.block-adeptus-embedded-pagination-next').prop('disabled', this.embeddedTablePage >= totalPages);\n        },\n\n        /**\n         * Render chart in embedded mode with current settings.\n         */\n        renderEmbeddedChart: function() {\n            var data = this.embeddedData || [];\n            var canvas = this.container.find('.block-adeptus-embedded-chart')[0];\n\n            if (!canvas || data.length === 0) {\n                return;\n            }\n\n            // Destroy existing chart\n            if (this.embeddedChartInstance) {\n                this.embeddedChartInstance.destroy();\n                this.embeddedChartInstance = null;\n            }\n\n            var chartType = this.embeddedChartType || 'bar';\n            var xAxis = this.embeddedXAxis || Object.keys(data[0])[0];\n            var yAxis = this.embeddedYAxis || Object.keys(data[0])[1];\n\n            // Prepare chart data (limit to 30 items)\n            var chartData = data.slice(0, 30);\n            var labels = chartData.map(function(row) {\n                var label = row[xAxis];\n                if (label === null || label === undefined) {\n                    return this.strings.unknown;\n                }\n                var labelStr = String(label);\n                return labelStr.length > 20 ? labelStr.substring(0, 20) + '...' : labelStr;\n            });\n            var values = chartData.map(function(row) {\n                return parseFloat(row[yAxis]) || 0;\n            });\n\n            // Generate colors\n            var colors = this.generateChartColors(values.length);\n\n            // Build dataset config\n            var datasetConfig = {\n                label: yAxis.replace(/_/g, ' ').replace(/\\b\\w/g, function(letter) {\n                    return letter.toUpperCase();\n                }),\n                data: values\n            };\n\n            if (chartType === 'pie' || chartType === 'doughnut') {\n                datasetConfig.backgroundColor = colors;\n                datasetConfig.borderWidth = 1;\n            } else {\n                datasetConfig.backgroundColor = colors[0];\n                datasetConfig.borderColor = colors[0].replace('0.7', '1');\n                datasetConfig.borderWidth = 1;\n            }\n\n            // Chart config\n            var config = {\n                type: chartType,\n                data: {\n                    labels: labels,\n                    datasets: [datasetConfig]\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    plugins: {\n                        legend: {\n                            display: chartType === 'pie' || chartType === 'doughnut',\n                            position: 'right'\n                        }\n                    }\n                }\n            };\n\n            // Add scales for bar/line charts\n            if (chartType === 'bar' || chartType === 'line') {\n                config.options.scales = {\n                    y: {beginAtZero: true},\n                    x: {display: data.length <= 15}\n                };\n            }\n\n            try {\n                this.embeddedChartInstance = new Chart(canvas.getContext('2d'), config);\n            } catch (_error) {\n                this.container.find('.block-adeptus-embedded-chart-container').html(\n                    '<div class=\"alert alert-warning text-center\">' +\n                    '<i class=\"fa fa-exclamation-circle\"></i> Could not render chart</div>'\n                );\n            }\n        },\n\n        /**\n         * Export embedded report data using the main plugin's export system.\n         *\n         * @param {string} format - Export format (pdf, csv, json)\n         */\n        exportEmbeddedReport: function(format) {\n            var self = this;\n            var data = this.embeddedData || [];\n            var report = this.embeddedReport || {};\n\n            if (data.length === 0) {\n                Notification.addNotification({\n                    message: self.strings.exportNoData,\n                    type: 'warning'\n                });\n                return;\n            }\n\n            // Check export eligibility via main plugin's AJAX endpoint\n            $.ajax({\n                url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/check_export_eligibility.php',\n                method: 'POST',\n                data: {\n                    format: format,\n                    sesskey: M.cfg.sesskey\n                },\n                dataType: 'json'\n            }).done(function(response) {\n                if (!response.success || !response.eligible) {\n                    self.showExportUpgradePrompt(format, response.message || self.strings.exportNotAvailable);\n                    return;\n                }\n\n                // Eligible - proceed with export\n                self.performExport(format, report, data);\n            }).fail(function() {\n                Notification.addNotification({\n                    message: self.strings.exportVerifyError,\n                    type: 'error'\n                });\n            });\n        },\n\n        /**\n         * Render KPI cards mode.\n         *\n         * @param {Array} reports\n         */\n        renderKpi: function(reports) {\n            var self = this;\n            var gridContainer = this.container.find('.block-adeptus-kpi-grid');\n            var template = $('#block-adeptus-kpi-card-template-' + this.blockId);\n            var maxCards = parseInt(this.config.kpiColumns, 10) || 2;\n            maxCards = Math.max(1, Math.min(4, maxCards)); // Clamp between 1-4\n\n            gridContainer.empty();\n\n            var kpiReports = reports.slice(0, maxCards);\n            var cardMap = {}; // Map slug to card element\n            var wizardReports = [];\n            var aiReports = [];\n\n            // Create all cards first\n            kpiReports.forEach(function(report, index) {\n                var card = template.html();\n                var $card = $(card);\n\n                var reportName = report.name || report.title || report.display_name || report.slug || 'Metric';\n                $card.attr('data-slug', report.slug);\n                $card.attr('data-source', report.source);\n                $card.find('.block-adeptus-kpi-card-label').text(reportName);\n                $card.find('.block-adeptus-kpi-card-value').html('<i class=\"fa fa-spinner fa-spin\"></i>');\n                $card.find('.block-adeptus-kpi-card-trend').addClass('d-none');\n                $card.find('.block-adeptus-kpi-card-sparkline').addClass('d-none');\n\n                // Set icon - use custom icon if configured, otherwise default based on index\n                var defaultIcons = ['fa-users', 'fa-graduation-cap', 'fa-clock-o', 'fa-check-circle'];\n                var iconClass = report.customIcon || defaultIcons[index % defaultIcons.length];\n                $card.find('.block-adeptus-kpi-card-icon i').removeClass('fa-bar-chart').addClass(iconClass);\n\n                gridContainer.append($card);\n\n                // Store reference for batch update\n                cardMap[report.slug] = {\n                    $card: $card,\n                    report: report,\n                    index: index\n                };\n\n                // Separate wizard and AI reports\n                if (report.source === 'wizard') {\n                    wizardReports.push(report);\n                } else {\n                    aiReports.push(report);\n                }\n            });\n\n            gridContainer.removeClass('d-none');\n\n            // Use batch loading for wizard reports (single request for all)\n            if (wizardReports.length > 0) {\n                this.loadKpiBatch(wizardReports, cardMap);\n            }\n\n            // Load AI reports individually (they use external API)\n            aiReports.forEach(function(report, index) {\n                var cardInfo = cardMap[report.slug];\n                setTimeout(function() {\n                    self.loadKpiData(report, cardInfo.$card, cardInfo.index);\n                }, index * 100);\n            });\n        },\n\n        /**\n         * Load multiple KPI cards in a single batch request.\n         *\n         * @param {Array} reports Wizard reports to load\n         * @param {Object} cardMap Map of slug to card info\n         */\n        loadKpiBatch: function(reports, cardMap) {\n            var self = this;\n\n            // Get report IDs (names) for batch request\n            var reportIds = reports.map(function(r) {\n                return r.report_template_id || r.id || r.name || r.slug;\n            });\n\n            $.ajax({\n                url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/batch_kpi_data.php',\n                method: 'POST',\n                data: {\n                    reportids: JSON.stringify(reportIds),\n                    sesskey: M.cfg.sesskey\n                },\n                dataType: 'json',\n                timeout: 30000\n            }).done(function(response) {\n                if (response.success && response.reports) {\n                    // Update each card with its data\n                    reports.forEach(function(report) {\n                        var reportId = report.report_template_id || report.id || report.name || report.slug;\n                        var reportData = response.reports[reportId];\n                        var cardInfo = cardMap[report.slug];\n\n                        if (!cardInfo) {\n                            return;\n                        }\n\n                        var $card = cardInfo.$card;\n                        var cacheKey = report.slug + '_' + report.source;\n\n                        if (reportData && reportData.success) {\n                            // Cache the results\n                            self.reportDataCache[cacheKey] = {\n                                report: report,\n                                results: reportData.results || []\n                            };\n\n                            // Render the KPI value\n                            self.renderKpiValue($card, reportData.results || []);\n                        } else {\n                            $card.find('.block-adeptus-kpi-card-value').text('--');\n                            $card.find('.block-adeptus-kpi-card-trend').addClass('d-none');\n                        }\n                    });\n                } else {\n                    // Batch failed, fall back to individual loading\n                    reports.forEach(function(report, index) {\n                        var cardInfo = cardMap[report.slug];\n                        setTimeout(function() {\n                            self.loadKpiData(report, cardInfo.$card, cardInfo.index);\n                        }, index * 100);\n                    });\n                }\n            }).fail(function() {\n                // Fall back to individual loading\n                reports.forEach(function(report, index) {\n                    var cardInfo = cardMap[report.slug];\n                    setTimeout(function() {\n                        self.loadKpiData(report, cardInfo.$card, cardInfo.index);\n                    }, index * 100);\n                });\n            });\n        },\n\n        /**\n         * Load KPI data for a single card.\n         *\n         * @param {Object} report\n         * @param {jQuery} $card\n         * @param {number} cardIndex Card index for logging\n         * @param {number} retryCount Current retry attempt (optional)\n         */\n        loadKpiData: function(report, $card, cardIndex, retryCount) {\n            var self = this;\n            var cacheKey = report.slug + '_' + report.source;\n            retryCount = retryCount || 0;\n            var maxRetries = 2;\n\n            // Check cache first\n            if (this.reportDataCache[cacheKey]) {\n                var cached = this.reportDataCache[cacheKey];\n                this.renderKpiValue($card, cached.results);\n                return;\n            }\n\n            // Get the report ID - try multiple possible fields\n            var reportId = report.report_template_id || report.id || report.name || report.slug;\n\n            // Load data based on source\n            if (report.source === 'wizard') {\n                $.ajax({\n                    url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/generate_report.php',\n                    method: 'POST',\n                    data: {\n                        reportid: reportId,\n                        sesskey: M.cfg.sesskey\n                    },\n                    dataType: 'json',\n                    timeout: 30000\n                }).done(function(response) {\n                    if (response.success) {\n                        self.reportDataCache[cacheKey] = {\n                            report: report,\n                            results: response.results || []\n                        };\n                        self.renderKpiValue($card, response.results || []);\n                    } else {\n                        $card.find('.block-adeptus-kpi-card-value').text('--');\n                        $card.find('.block-adeptus-kpi-card-trend').addClass('d-none');\n                    }\n                }).fail(function(jqXHR, textStatus) {\n                    // Retry on timeout or server error\n                    if (retryCount < maxRetries && (textStatus === 'timeout' || jqXHR.status >= 500)) {\n                        setTimeout(function() {\n                            self.loadKpiData(report, $card, cardIndex, retryCount + 1);\n                        }, 1000 * (retryCount + 1));\n                    } else {\n                        $card.find('.block-adeptus-kpi-card-value').text('--');\n                        $card.find('.block-adeptus-kpi-card-trend').addClass('d-none');\n                    }\n                });\n            } else {\n                // AI reports\n                var token = this.apiKey || (window.adeptusAuthData ? window.adeptusAuthData.api_key : null);\n                if (!token) {\n                    $card.find('.block-adeptus-kpi-card-value').text('--');\n                    $card.find('.block-adeptus-kpi-card-trend').addClass('d-none');\n                    return;\n                }\n\n                $.ajax({\n                    url: '' + this.backendUrl + '/ai-reports/' + report.slug,\n                    method: 'GET',\n                    headers: {\n                        'Authorization': 'Bearer ' + token,\n                        'Accept': 'application/json'\n                    },\n                    timeout: 30000\n                }).done(function(response) {\n                    if (response.success) {\n                        var reportData = response.report || report;\n                        var data = response.data || [];\n\n                        // Check if local execution is required (SaaS model)\n                        var sqlQuery = response.sql || (reportData && reportData.sql_query) || (reportData && reportData.sql);\n                        var needsLocalExecution = response.execution_required || ((!data || data.length === 0) && sqlQuery);\n\n                        if (needsLocalExecution && sqlQuery) {\n                            // Execute SQL locally against Moodle database\n                            self.executeReportLocally(sqlQuery, reportData.params || {})\n                                .then(function(executionResult) {\n                                    var localData = executionResult.data || [];\n                                    self.reportDataCache[cacheKey] = {\n                                        report: reportData,\n                                        results: localData\n                                    };\n                                    self.renderKpiValue($card, localData);\n                                    return localData;\n                                })\n                                .catch(function() {\n                                    $card.find('.block-adeptus-kpi-card-value').text('--');\n                                    $card.find('.block-adeptus-kpi-card-trend').addClass('d-none');\n                                    return null;\n                                });\n                            return;\n                        }\n\n                        if (data && data.length > 0) {\n                            self.reportDataCache[cacheKey] = {\n                                report: reportData,\n                                results: data\n                            };\n                            self.renderKpiValue($card, data);\n                        } else {\n                            $card.find('.block-adeptus-kpi-card-value').text('--');\n                            $card.find('.block-adeptus-kpi-card-trend').addClass('d-none');\n                        }\n                    } else {\n                        $card.find('.block-adeptus-kpi-card-value').text('--');\n                        $card.find('.block-adeptus-kpi-card-trend').addClass('d-none');\n                    }\n                }).fail(function(jqXHR, textStatus) {\n                    // Retry on timeout or server error\n                    if (retryCount < maxRetries && (textStatus === 'timeout' || jqXHR.status >= 500)) {\n                        setTimeout(function() {\n                            self.loadKpiData(report, $card, cardIndex, retryCount + 1);\n                        }, 1000 * (retryCount + 1));\n                    } else {\n                        $card.find('.block-adeptus-kpi-card-value').text('--');\n                        $card.find('.block-adeptus-kpi-card-trend').addClass('d-none');\n                    }\n                });\n            }\n        },\n\n        /**\n         * Render KPI value on card with trend and sparkline.\n         *\n         * @param {jQuery} $card\n         * @param {Array} data\n         */\n        renderKpiValue: function($card, data) {\n            var slug = $card.data('slug');\n            var source = $card.data('source') || 'wizard';\n            var label = $card.find('.block-adeptus-kpi-card-label').text() || '';\n\n            if (!data || data.length === 0) {\n                $card.find('.block-adeptus-kpi-card-value').text('0');\n                // Save zero value and update trend from server\n                this.saveKpiHistoryToServer($card, slug, 0, source, label, 0);\n                return;\n            }\n\n            // Find numeric column for KPI value\n            var headers = Object.keys(data[0]);\n            var numericCols = this.detectNumericColumns(data, headers);\n\n            var value;\n            var formattedValue;\n\n            if (numericCols.length > 0) {\n                // Use sum or count of the last numeric column\n                var valueCol = numericCols[numericCols.length - 1];\n\n                // If it's a count/total column, sum all values\n                if (valueCol.toLowerCase().includes('count') ||\n                    valueCol.toLowerCase().includes('total') ||\n                    data.length === 1) {\n                    value = data.reduce(function(sum, row) {\n                        return sum + (parseFloat(row[valueCol]) || 0);\n                    }, 0);\n                } else {\n                    // Otherwise show row count\n                    value = data.length;\n                }\n            } else {\n                // No numeric columns, show row count\n                value = data.length;\n            }\n\n            // Format the value nicely\n            formattedValue = this.formatKpiValue(value);\n\n            $card.find('.block-adeptus-kpi-card-value').text(formattedValue);\n\n            // Save to server and update trend/sparkline from response\n            this.saveKpiHistoryToServer($card, slug, value, source, label, data.length);\n        },\n\n        /**\n         * Format a KPI value for display.\n         *\n         * @param {number} value\n         * @return {string}\n         */\n        formatKpiValue: function(value) {\n            if (value >= 1000000) {\n                return (value / 1000000).toFixed(1) + 'M';\n            } else if (value >= 1000) {\n                return (value / 1000).toFixed(1) + 'K';\n            } else if (Number.isInteger(value)) {\n                return value.toLocaleString();\n            } else {\n                return value.toFixed(1);\n            }\n        },\n\n        /**\n         * Save KPI snapshot to backend and update trend/sparkline.\n         * This is an enterprise feature - requires snapshots permission.\n         *\n         * @param {jQuery} $card\n         * @param {string} slug\n         * @param {number} value\n         * @param {string} source Report source (wizard/ai)\n         * @param {string} _label Metric label (unused, for API compatibility)\n         * @param {number} _rowCount Number of data rows (unused, for API compatibility)\n         * @param {number} executionTimeMs Execution time in milliseconds (optional)\n         */\n        saveKpiHistoryToServer: function($card, slug, value, source, _label, _rowCount, executionTimeMs) {\n            // Check if snapshots feature is enabled (enterprise feature)\n            if (!this.config.snapshotsEnabled) {\n                // Feature not enabled - hide trend and sparkline\n                $card.find('.block-adeptus-kpi-card-trend').addClass('d-none');\n                $card.find('.block-adeptus-kpi-card-sparkline').addClass('d-none');\n                return;\n            }\n\n            // For AI reports, use the backend snapshots API\n            if (source === 'ai') {\n                this.postSnapshotToBackend($card, slug, value, executionTimeMs || 0);\n                return;\n            }\n\n            // For wizard reports, also use backend API\n            this.postSnapshotToBackend($card, slug, value, executionTimeMs || 0);\n        },\n\n        /**\n         * Post snapshot to backend API and update trend/sparkline from response.\n         *\n         * @param {jQuery} $card\n         * @param {string} slug Report slug\n         * @param {number} metricValue The actual metric value (e.g., 122 users)\n         * @param {number} executionTimeMs Execution time in milliseconds\n         */\n        postSnapshotToBackend: function($card, slug, metricValue, executionTimeMs) {\n            var self = this;\n            var token = this.apiKey;\n            var source = $card.data('source') || 'wizard';\n\n            if (!token) {\n                $card.find('.block-adeptus-kpi-card-trend').addClass('d-none');\n                $card.find('.block-adeptus-kpi-card-sparkline').addClass('d-none');\n                return;\n            }\n\n            // Use correct endpoint based on report source\n            var endpoint = (source === 'ai') ? '/ai-reports/' : '/wizard-reports/';\n\n            // Get baseline period from config (default: all_time)\n            var baselinePeriod = this.config.baselinePeriod || 'all_time';\n\n            // Determine history limit based on baseline period for sparkline display\n            var historyLimit = this.getHistoryLimitForBaseline(baselinePeriod);\n\n            $.ajax({\n                url: this.backendUrl + endpoint + encodeURIComponent(slug) +\n                    '/snapshots?baseline_period=' + baselinePeriod + '&history_limit=' + historyLimit,\n                method: 'POST',\n                headers: {\n                    'Authorization': 'Bearer ' + token,\n                    'Content-Type': 'application/json',\n                    'Accept': 'application/json'\n                },\n                /* eslint-disable camelcase */\n                data: JSON.stringify({\n                    row_count: metricValue,\n                    execution_time_ms: executionTimeMs,\n                    evaluate_alerts: true,\n                    baseline_period: baselinePeriod\n                }),\n                /* eslint-enable camelcase */\n                timeout: 15000\n            }).done(function(response) {\n                if (response.success) {\n                    // Cache the snapshot response for KPI modal use\n                    self.kpiSnapshotCache[slug] = {\n                        history: response.history || [],\n                        trend: response.trend || {},\n                        currentValue: metricValue,\n                        timestamp: Date.now()\n                    };\n\n                    // Register snapshot schedule for cron-based execution on first run\n                    self.registerSnapshotSchedule(slug, source, metricValue);\n\n                    // Update trend from response - now supports dual trends (vs_previous and vs_baseline)\n                    self.updateKpiTrendFromBackend($card, response.trend);\n\n\n                    // Update sparkline from history\n                    if (response.history && response.history.length >= 2) {\n                        self.renderKpiSparklineFromBackend($card, slug, response.history);\n                    } else {\n                        $card.find('.block-adeptus-kpi-card-sparkline').addClass('d-none');\n                    }\n\n                    // Handle any triggered alerts - pass context we have here.\n                    if (response.alerts && response.alerts.triggered_count > 0) {\n                        var reportName = $card.find('.block-adeptus-kpi-card-label').text() || slug;\n                        self.handleTriggeredAlerts(response.alerts.triggered, slug, metricValue, response.trend, reportName);\n                    }\n                }\n            }).fail(function() {\n                // Silent fail - trend won't update but KPI value is still shown\n                $card.find('.block-adeptus-kpi-card-trend').addClass('d-none');\n                $card.find('.block-adeptus-kpi-card-sparkline').addClass('d-none');\n            });\n        },\n\n        /**\n         * Register a report for cron-based snapshot scheduling.\n         *\n         * Called on first successful snapshot POST to ensure subsequent\n         * snapshots are taken automatically by cron at the configured interval.\n         *\n         * @param {string} slug Report slug\n         * @param {string} source Report source (wizard or ai)\n         * @param {number} metricValue Initial metric value\n         */\n        registerSnapshotSchedule: function(slug, source, metricValue) {\n            var self = this;\n            var scheduleKey = this.blockId + '_' + slug;\n\n            // Only register once per session per report\n            if (this.registeredSnapshots[scheduleKey]) {\n                return;\n            }\n\n            // Get the history interval from config (in seconds)\n            var intervalSeconds = this.config.kpiHistoryInterval || 3600; // Default 1 hour\n\n            // Call Moodle AJAX to register the schedule\n            Ajax.call([{\n                methodname: 'block_adeptus_insights_register_snapshot_schedule',\n                args: {\n                    blockinstanceid: this.blockId,\n                    reportslug: slug,\n                    reportsource: source,\n                    intervalseconds: intervalSeconds,\n                    rowcount: metricValue\n                }\n            }])[0].done(function(response) {\n                if (response.success) {\n                    // Mark as registered for this session\n                    self.registeredSnapshots[scheduleKey] = true;\n                }\n            }).fail(function() {\n                // Silent fail - schedule registration is not critical for UI\n            });\n        },\n\n        /**\n         * Update KPI trend indicator from backend response.\n         *\n         * @param {jQuery} $card\n         * @param {Object} trend Trend data from backend\n         */\n        updateKpiTrendFromBackend: function($card, trend) {\n            var trendContainer = $card.find('.block-adeptus-kpi-card-trend');\n            trendContainer.removeClass('d-none trend-up trend-down trend-neutral');\n\n            // Handle new dual trend structure (vs_baseline and vs_previous)\n            if (trend && (trend.vs_baseline || trend.vs_previous)) {\n                this.updateKpiDualTrend($card, trend);\n                return;\n            }\n\n            // Legacy single trend handling (backward compatibility)\n            if (!trend || !trend.has_previous) {\n                trendContainer.addClass('d-none');\n                return;\n            }\n\n            var direction = trend.direction;\n            var percentage = Math.abs(trend.change_percent || 0);\n            var changeText = this.formatPercentage(percentage);\n\n            if (direction === 'increase') {\n                trendContainer.addClass('trend-up');\n                trendContainer.find('.trend-icon').html('<i class=\"fa fa-arrow-up\"></i>');\n                trendContainer.find('.trend-value').text(this.strings.vsPrevious.replace('{$a}', '+' + changeText));\n            } else if (direction === 'decrease') {\n                trendContainer.addClass('trend-down');\n                trendContainer.find('.trend-icon').html('<i class=\"fa fa-arrow-down\"></i>');\n                trendContainer.find('.trend-value').text(this.strings.vsPrevious.replace('{$a}', '-' + changeText));\n            } else {\n                trendContainer.addClass('trend-neutral');\n                trendContainer.find('.trend-icon').html('<i class=\"fa fa-minus\"></i>');\n                trendContainer.find('.trend-value').text(this.strings.noChange);\n            }\n        },\n\n        /**\n         * Update KPI card with dual trend metrics (overall vs baseline, and vs previous).\n         *\n         * @param {jQuery} $card The KPI card element\n         * @param {Object} trend Trend object with vs_baseline and vs_previous\n         */\n        updateKpiDualTrend: function($card, trend) {\n            var trendContainer = $card.find('.block-adeptus-kpi-card-trend');\n            trendContainer.removeClass('d-none trend-up trend-down trend-neutral');\n\n            var vsBaseline = trend.vs_baseline || {};\n            var vsPrevious = trend.vs_previous || {};\n            var hasBaseline = vsBaseline.has_baseline;\n            var hasPrevious = vsPrevious.has_previous;\n\n            // If no trend data at all, hide the container\n            if (!hasBaseline && !hasPrevious) {\n                trendContainer.addClass('d-none');\n                return;\n            }\n\n            // Build the dual trend display: \" 25% overall |  8% since last\"\n            var parts = [];\n\n            // Helper for direction sign.\n            var directionSigns = {increase: '+', decrease: '-'};\n\n            // Overall trend (vs baseline)\n            if (hasBaseline) {\n                var baselinePct = this.formatPercentage(Math.abs(vsBaseline.change_percent || 0));\n                var baselineIcon = this.getTrendIcon(vsBaseline.direction);\n                var baselineSign = directionSigns[vsBaseline.direction] || '';\n                parts.push(baselineIcon + ' ' + baselineSign + baselinePct + ' overall');\n            }\n\n            // Interval trend (vs previous)\n            if (hasPrevious) {\n                var previousPct = this.formatPercentage(Math.abs(vsPrevious.change_percent || 0));\n                var previousIcon = this.getTrendIcon(vsPrevious.direction);\n                var previousSign = directionSigns[vsPrevious.direction] || '';\n                parts.push(previousIcon + ' ' + previousSign + previousPct + ' since last');\n            }\n\n            // Determine overall trend direction for styling (use baseline as primary)\n            var primaryDirection = hasBaseline ? vsBaseline.direction : vsPrevious.direction;\n            if (primaryDirection === 'increase') {\n                trendContainer.addClass('trend-up');\n            } else if (primaryDirection === 'decrease') {\n                trendContainer.addClass('trend-down');\n            } else {\n                trendContainer.addClass('trend-neutral');\n            }\n\n            // Update the display - hide the icon span and use trend-value for full display\n            trendContainer.find('.trend-icon').html('');\n            trendContainer.find('.trend-value').html(parts.join(' <span class=\"trend-separator\">|</span> '));\n        },\n\n        /**\n         * Get trend icon HTML based on direction.\n         *\n         * @param {string} direction 'increase', 'decrease', or 'stable'\n         * @return {string} HTML for the icon\n         */\n        getTrendIcon: function(direction) {\n            if (direction === 'increase') {\n                return '<i class=\"fa fa-arrow-up trend-icon-up\"></i>';\n            } else if (direction === 'decrease') {\n                return '<i class=\"fa fa-arrow-down trend-icon-down\"></i>';\n            }\n            return '<i class=\"fa fa-minus trend-icon-neutral\"></i>';\n        },\n\n        /**\n         * Format percentage for display.\n         *\n         * @param {number} percentage The percentage value\n         * @return {string} Formatted percentage string\n         */\n        formatPercentage: function(percentage) {\n            if (percentage >= 100) {\n                return Math.round(percentage) + '%';\n            } else if (percentage >= 10) {\n                return percentage.toFixed(0) + '%';\n            }\n            return percentage.toFixed(1) + '%';\n        },\n\n        /**\n         * Format a number with thousands separator.\n         *\n         * @param {number|string} value The value to format\n         * @return {string} Formatted number string\n         */\n        formatNumber: function(value) {\n            if (value === null || value === undefined || value === '--') {\n                return '--';\n            }\n            var num = parseFloat(value);\n            if (isNaN(num)) {\n                return value.toString();\n            }\n            // For large numbers, add thousands separator\n            if (Math.abs(num) >= 1000) {\n                return num.toLocaleString();\n            }\n            // For decimals, limit to 2 decimal places\n            if (num % 1 !== 0) {\n                return num.toFixed(2);\n            }\n            return num.toString();\n        },\n\n        /**\n         * Format a timestamp to a readable date/time string.\n         *\n         * @param {string} timestamp The timestamp to format\n         * @return {string} Formatted date/time string\n         */\n        formatTimestamp: function(timestamp) {\n            if (!timestamp) {\n                return '';\n            }\n            var date = new Date(timestamp);\n            var now = new Date();\n            var diffMs = now - date;\n            var diffMins = Math.floor(diffMs / 60000);\n            var diffHours = Math.floor(diffMins / 60);\n            var diffDays = Math.floor(diffHours / 24);\n\n            if (diffMins < 1) {\n                return this.strings.justNow;\n            } else if (diffMins < 60) {\n                return this.strings.minAgo.replace('{$a}', diffMins);\n            } else if (diffHours < 24) {\n                var hourStr = diffHours > 1 ? this.strings.hoursAgo : this.strings.hourAgo;\n                return hourStr.replace('{$a}', diffHours);\n            } else if (diffDays < 7) {\n                var dayStr = diffDays > 1 ? this.strings.daysAgo : this.strings.dayAgo;\n                return dayStr.replace('{$a}', diffDays);\n            }\n            // For older dates, show full date\n            var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',\n                          'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];\n            return months[date.getMonth()] + ' ' + date.getDate() + ', ' + date.getFullYear();\n        },\n\n        /**\n         * Format \"Showing X-Y of Z\" pagination text.\n         *\n         * @param {number} start Start index\n         * @param {number} end End index\n         * @param {number} total Total items\n         * @return {string} Formatted text\n         */\n        formatShowingText: function(start, end, total) {\n            // Use showingxofy string if available, otherwise construct manually\n            if (this.strings.showingXOfY && this.strings.showingXOfY.indexOf('{$a') !== -1) {\n                return this.strings.showingXOfY\n                    .replace('{$a->start}', start)\n                    .replace('{$a->end}', end)\n                    .replace('{$a->total}', total);\n            }\n            return 'Showing ' + start + '-' + end + ' of ' + total;\n        },\n\n        /**\n         * Format \"Page X of Y\" pagination text.\n         *\n         * @param {number} current Current page\n         * @param {number} total Total pages\n         * @return {string} Formatted text\n         */\n        formatPageText: function(current, total) {\n            return this.strings.page + ' ' + current + ' ' + this.strings.of + ' ' + total;\n        },\n\n        /**\n         * Get appropriate history limit based on baseline period.\n         *\n         * Returns a reasonable number of data points for the sparkline\n         * based on the selected baseline period.\n         *\n         * @param {string} baselinePeriod The baseline period setting\n         * @return {number} Number of history entries to request\n         */\n        getHistoryLimitForBaseline: function(baselinePeriod) {\n            switch (baselinePeriod) {\n                case 'all_time':\n                    return 100; // Get all available history\n                case 'rolling_30d':\n                    return 60; // ~2 per day for 30 days\n                case 'month_start':\n                    return 62; // ~2 per day for a month\n                case 'rolling_7d':\n                    return 14; // ~2 per day for 7 days\n                case 'week_start':\n                    return 14; // ~2 per day for a week\n                default:\n                    return 30; // Default reasonable limit\n            }\n        },\n\n        /**\n         * Render sparkline from backend history data.\n         *\n         * @param {jQuery} $card\n         * @param {string} slug\n         * @param {Array} history History data from backend\n         */\n        renderKpiSparklineFromBackend: function($card, slug, history) {\n            // Convert backend history format to sparkline data\n            var sparklineData = history.map(function(point) {\n                return point.row_count;\n            }).reverse(); // Oldest first for chart\n\n            this.renderKpiSparklineFromData($card, slug, sparklineData, sparklineData[sparklineData.length - 1]);\n        },\n\n        /**\n         * Handle triggered alerts from snapshot response.\n         *\n         * Sends notifications via Moodle's messaging system to configured recipients.\n         * Notifications appear in the bell icon notification area.\n         *\n         * @param {Array} triggeredAlerts Array of triggered alert objects\n         * @param {string} reportSlug Report slug from snapshot context\n         * @param {number} currentValue Current metric value from snapshot context\n         * @param {Object} trend Trend data from snapshot response (optional)\n         * @param {string} reportName Human-readable report name (optional)\n         */\n        handleTriggeredAlerts: function(triggeredAlerts, reportSlug, currentValue, trend, reportName) {\n            var self = this;\n\n            if (!triggeredAlerts || triggeredAlerts.length === 0) {\n                return;\n            }\n\n            // Prepare alerts data for the Moodle notification API.\n            // Alerts fire once and are archived - no cooldown period needed.\n            // Use context values (reportSlug, currentValue) as fallbacks since backend may not include them.\n            var alertsConfig = self.config.alertsConfig || [];\n\n            // eslint-disable-next-line complexity\n            var alertsToSend = triggeredAlerts.map(function(alert) {\n                var alertName = alert.alert_name || alert.name || 'Alert';\n                var value = parseFloat(alert.current_value || alert.actual_value || alert.value || currentValue || 0);\n                var displayReportName = reportName || alert.report_name || reportSlug || 'Report';\n                var alertId = alert.id || alert.alert_id || 0;\n\n                // Look up local config to determine correct severity based on thresholds.\n                var localConfig = null;\n                for (var i = 0; i < alertsConfig.length; i++) {\n                    if (alertsConfig[i].backend_id === alertId) {\n                        localConfig = alertsConfig[i];\n                        break;\n                    }\n                }\n\n                // Determine severity by comparing value against warning and critical thresholds.\n                var severity = 'warning';\n                var thresholdValue = alert.threshold || alert.threshold_value || '';\n                if (localConfig) {\n                    var warningThreshold = parseFloat(localConfig.warning_value) || 0;\n                    var criticalThreshold = parseFloat(localConfig.critical_value) || 0;\n\n                    // Check which threshold was exceeded (critical takes priority).\n                    if (criticalThreshold > 0 && value >= criticalThreshold) {\n                        severity = 'critical';\n                        thresholdValue = criticalThreshold;\n                    } else if (warningThreshold > 0 && value >= warningThreshold) {\n                        severity = 'warning';\n                        thresholdValue = warningThreshold;\n                    }\n                } else {\n                    // Fall back to backend-provided severity if no local config.\n                    severity = alert.severity || (alert.is_critical ? 'critical' : 'warning');\n                }\n\n                // Build a meaningful message with context and trend info.\n                // Format: \"Your {report_name} has reached {value}, exceeding your {severity} threshold ({threshold}).\n                //          {alert_name} increased/decreased by X (Y%) since last measurement.\"\n                var message = 'Your ' + displayReportName + ' has reached ' + value +\n                    ', exceeding your ' + severity + ' threshold (' + thresholdValue + ').';\n\n                // Add trend information if available.\n                if (trend && trend.has_previous) {\n                    var direction = trend.direction || 'change';\n                    var changeAbs = Math.abs(trend.change_absolute || 0);\n                    var changePct = Math.abs(trend.change_percent || 0).toFixed(1);\n\n                    if (direction === 'increase') {\n                        message += ' ' + alertName + ' increased by ' + changeAbs + ' (' + changePct + '%) since last measurement.';\n                    } else if (direction === 'decrease') {\n                        message += ' ' + alertName + ' decreased by ' + changeAbs + ' (' + changePct + '%) since last measurement.';\n                    } else {\n                        message += ' ' + alertName + ' has remained stable since last measurement.';\n                    }\n                }\n\n                /* eslint-disable camelcase */\n                return {\n                    alert_id: alertId,\n                    alert_name: alertName,\n                    message: message,\n                    severity: severity,\n                    report_name: displayReportName,\n                    report_slug: alert.report_slug || alert.slug || reportSlug || '',\n                    current_value: String(value),\n                    threshold: String(thresholdValue),\n                    notify_users: JSON.stringify(alert.notify_users || [])\n                };\n                /* eslint-enable camelcase */\n            });\n\n            // Send notifications via Moodle's messaging system (silent - no on-page alerts).\n            require(['core/ajax'], function(Ajax) {\n                Ajax.call([{\n                    methodname: 'block_adeptus_insights_send_alert_notification',\n                    args: {\n                        blockinstanceid: self.blockId,\n                        alerts: alertsToSend\n                    }\n                }])[0].done(function(response) {\n                    if (response.success && response.sent_count > 0) {\n                        // Trigger notification area refresh so bell icon updates.\n                        // Small delay to ensure notification is fully committed to database.\n                        setTimeout(function() {\n                            self.refreshNotificationArea();\n                        }, 500);\n                    }\n                }).fail(function() {\n                    // Silent fail - notifications will appear on next poll.\n                });\n            });\n        },\n\n        /**\n         * Refresh the Moodle notification area to show new notifications.\n         * Calls the Moodle API to get the unread count and updates the badge.\n         */\n        refreshNotificationArea: function() {\n            require(['jquery', 'core/ajax'], function($, Ajax) {\n                try {\n                    // Find the notification popover container and get user ID.\n                    var $popover = $('#nav-notification-popover-container');\n                    if (!$popover.length) {\n                        return;\n                    }\n\n                    var userId = $popover.attr('data-userid');\n                    if (!userId) {\n                        return;\n                    }\n\n                    // Call Moodle API to get unread notification count.\n                    Ajax.call([{\n                        methodname: 'message_popup_get_unread_popup_notification_count',\n                        args: {\n                            useridto: parseInt(userId, 10)\n                        }\n                    }])[0].done(function(count) {\n                        // Update the notification badge in the DOM.\n                        var $countContainer = $popover.find('[data-region=\"count-container\"]');\n                        if ($countContainer.length) {\n                            if (count > 0) {\n                                $countContainer.text(count);\n                                $countContainer.removeClass('hidden');\n                            } else {\n                                $countContainer.addClass('hidden');\n                            }\n                        }\n                    }).fail(function() {\n                        // Silent fail - notifications will appear on next page load.\n                    });\n                } catch (_e) {\n                    // Silent fail.\n                }\n            });\n        },\n\n        /**\n         * Load KPI history from server for sparkline (legacy - kept for backward compatibility).\n         *\n         * @param {jQuery} $card The KPI card element\n         * @deprecated Use postSnapshotToBackend instead which returns history in response\n         */\n        loadKpiSparklineFromServer: function($card) {\n            // This is now handled by postSnapshotToBackend which returns history in response\n            // Keeping this method for any legacy code paths\n            if (!this.config.snapshotsEnabled) {\n                $card.find('.block-adeptus-kpi-card-sparkline').addClass('d-none');\n                return;\n            }\n            // Sparkline is now loaded from snapshot response, no separate call needed\n        },\n\n        /**\n         * Update KPI trend indicator from server response.\n         *\n         * @param {jQuery} $card\n         * @param {string} direction Trend direction (up/down/neutral)\n         * @param {number} percentage Trend percentage\n         */\n        updateKpiTrendFromServer: function($card, direction, percentage) {\n            var trendContainer = $card.find('.block-adeptus-kpi-card-trend');\n            trendContainer.removeClass('d-none trend-up trend-down trend-neutral');\n\n            var absChange = Math.abs(percentage);\n            var changeText;\n            if (absChange >= 100) {\n                changeText = Math.round(absChange) + '%';\n            } else if (absChange >= 10) {\n                changeText = absChange.toFixed(0) + '%';\n            } else {\n                changeText = absChange.toFixed(1) + '%';\n            }\n\n            if (direction === 'up') {\n                trendContainer.addClass('trend-up');\n                trendContainer.find('.trend-icon').html('<i class=\"fa fa-arrow-up\"></i>');\n                trendContainer.find('.trend-value').text(this.strings.vsPrevious.replace('{$a}', changeText));\n            } else if (direction === 'down') {\n                trendContainer.addClass('trend-down');\n                trendContainer.find('.trend-icon').html('<i class=\"fa fa-arrow-down\"></i>');\n                trendContainer.find('.trend-value').text(this.strings.vsPrevious.replace('{$a}', changeText));\n            } else {\n                trendContainer.addClass('trend-neutral');\n                trendContainer.find('.trend-icon').html('<i class=\"fa fa-minus\"></i>');\n                trendContainer.find('.trend-value').text(this.strings.noChange);\n            }\n        },\n\n        /**\n         * Legacy method for backwards compatibility.\n         *\n         * @param {jQuery} $card The KPI card element\n         */\n        updateKpiTrend: function($card) {\n            // Show neutral trend initially, server call will update\n            var trendContainer = $card.find('.block-adeptus-kpi-card-trend');\n            trendContainer.removeClass('d-none');\n            trendContainer.addClass('trend-neutral');\n            trendContainer.find('.trend-icon').html('<i class=\"fa fa-spinner fa-spin\"></i>');\n            trendContainer.find('.trend-value').text(this.strings.loading);\n        },\n\n        /**\n         * Render sparkline chart from server data.\n         *\n         * @param {jQuery} $card\n         * @param {string} slug\n         * @param {Array} sparklineData Array of values\n         * @param {number} currentValue Current value to append\n         */\n        renderKpiSparklineFromData: function($card, slug, sparklineData, currentValue) {\n            var sparklineContainer = $card.find('.block-adeptus-kpi-card-sparkline');\n            var canvas = sparklineContainer.find('.block-adeptus-sparkline-chart')[0];\n\n            if (!canvas) {\n                return;\n            }\n\n            // Build data points array\n            var dataPoints = sparklineData.slice();\n            // Add current value if different from last\n            if (dataPoints.length === 0 || dataPoints[dataPoints.length - 1] !== currentValue) {\n                dataPoints.push(currentValue);\n            }\n\n            // Need at least 2 points for a meaningful sparkline\n            if (dataPoints.length < 2) {\n                sparklineContainer.addClass('d-none');\n                return;\n            }\n\n            sparklineContainer.removeClass('d-none');\n\n            // Determine sparkline color based on overall trend\n            var firstValue = dataPoints[0];\n            var lastValue = dataPoints[dataPoints.length - 1];\n            var trendColor = lastValue >= firstValue ? 'rgba(40, 167, 69, 0.8)' : 'rgba(220, 53, 69, 0.8)';\n            var trendBgColor = lastValue >= firstValue ? 'rgba(40, 167, 69, 0.1)' : 'rgba(220, 53, 69, 0.1)';\n\n            // Destroy existing chart if any\n            var chartKey = 'sparkline_' + this.blockId + '_' + slug;\n            if (this.kpiSparklineCharts && this.kpiSparklineCharts[chartKey]) {\n                this.kpiSparklineCharts[chartKey].destroy();\n            }\n\n            // Initialize chart storage\n            if (!this.kpiSparklineCharts) {\n                this.kpiSparklineCharts = {};\n            }\n\n            // Create sparkline chart\n            try {\n                this.kpiSparklineCharts[chartKey] = new Chart(canvas.getContext('2d'), {\n                    type: 'line',\n                    data: {\n                        labels: dataPoints.map(function() {\n                            return '';\n                        }),\n                        datasets: [{\n                            data: dataPoints,\n                            borderColor: trendColor,\n                            backgroundColor: trendBgColor,\n                            borderWidth: 2,\n                            fill: true,\n                            tension: 0.4,\n                            pointRadius: 0,\n                            pointHoverRadius: 0\n                        }]\n                    },\n                    options: {\n                        responsive: true,\n                        maintainAspectRatio: false,\n                        plugins: {\n                            legend: {display: false},\n                            tooltip: {enabled: false}\n                        },\n                        scales: {\n                            x: {display: false},\n                            y: {display: false}\n                        },\n                        elements: {\n                            line: {borderCapStyle: 'round'}\n                        },\n                        animation: {duration: 500}\n                    }\n                });\n            } catch (_e) {\n                // Chart.js not available or error\n                sparklineContainer.addClass('d-none');\n            }\n        },\n\n        /**\n         * Legacy method for backwards compatibility - no longer used.\n         */\n        renderKpiSparkline: function() {\n            // Sparkline is loaded via loadKpiSparklineFromServer\n            // This is a no-op for backwards compatibility\n        },\n\n        /**\n         * Render tabbed reports mode.\n         *\n         * @param {Array} reports\n         */\n        renderTabs: function(reports) {\n            var self = this;\n            var tabNav = this.container.find('.block-adeptus-tab-nav');\n            var tabContent = this.container.find('.block-adeptus-tab-content');\n            var tabTemplate = $('#block-adeptus-tab-template-' + this.blockId);\n            var paneTemplate = $('#block-adeptus-tab-pane-template-' + this.blockId);\n            var maxTabs = 5;\n\n            tabNav.empty();\n            tabContent.empty();\n\n            // Store tab chart instances\n            this.tabChartInstances = {};\n\n            reports.slice(0, maxTabs).forEach(function(report, index) {\n                var tabId = 'tab-' + self.blockId + '-' + index;\n                var reportName = report.name || report.title || report.display_name || report.slug || 'Report';\n\n                // Create tab\n                var tab = $(tabTemplate.html());\n                tab.find('a')\n                    .attr('href', '#' + tabId)\n                    .attr('aria-controls', tabId);\n                tab.find('.block-adeptus-tab-name').text(reportName);\n\n                if (index === 0) {\n                    tab.find('a').addClass('active').attr('aria-selected', 'true');\n                }\n\n                tabNav.append(tab);\n\n                // Create pane\n                var pane = $(paneTemplate.html());\n                pane.attr('id', tabId);\n                pane.attr('data-slug', report.slug);\n                pane.attr('data-source', report.source);\n\n                if (index === 0) {\n                    pane.addClass('show active');\n                }\n\n                tabContent.append(pane);\n            });\n\n            // Load first tab content\n            if (reports.length > 0) {\n                var firstPane = tabContent.find('.block-adeptus-tab-pane').first();\n                this.loadTabContent(firstPane, reports[0].slug, reports[0].source);\n            }\n\n            this.container.find('.block-adeptus-tabs-container').removeClass('d-none');\n        },\n\n        /**\n         * Load content for a tab.\n         *\n         * @param {jQuery} pane\n         * @param {string} slug\n         * @param {string} source\n         */\n        loadTabContent: function(pane, slug, source) {\n            var self = this;\n            var cacheKey = slug + '_' + source;\n            pane.data('loaded', true);\n\n            // Check cache first\n            if (this.reportDataCache[cacheKey]) {\n                var cached = this.reportDataCache[cacheKey];\n                this.renderTabContent(pane, cached.report, cached.results);\n                return;\n            }\n\n            // Find the report from our cached list\n            var report = this.reports.find(function(r) {\n                return r.slug === slug;\n            });\n\n            if (!report) {\n                pane.find('.block-adeptus-tab-pane-loading').addClass('d-none');\n                pane.find('.block-adeptus-tab-pane-content')\n                    .removeClass('d-none')\n                    .html('<div class=\"text-center text-muted py-4\">' +\n                        '<i class=\"fa fa-exclamation-circle\"></i>' +\n                        '<p class=\"mt-2\">Report not found</p></div>');\n                return;\n            }\n\n            // Load data based on source\n            if (source === 'wizard') {\n                $.ajax({\n                    url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/generate_report.php',\n                    method: 'POST',\n                    data: {\n                        reportid: report.name || report.report_template_id,\n                        sesskey: M.cfg.sesskey\n                    },\n                    dataType: 'json',\n                    timeout: 30000\n                }).done(function(response) {\n                    if (response.success) {\n                        self.reportDataCache[cacheKey] = {\n                            report: report,\n                            results: response.results || []\n                        };\n                        self.renderTabContent(pane, report, response.results || []);\n                    } else {\n                        pane.find('.block-adeptus-tab-pane-loading').addClass('d-none');\n                        pane.find('.block-adeptus-tab-pane-content')\n                            .removeClass('d-none')\n                            .html('<div class=\"text-center text-muted py-4\">' +\n                                '<i class=\"fa fa-exclamation-circle\"></i>' +\n                                '<p class=\"mt-2\">' + (response.message || 'Failed to load') +\n                                '</p></div>');\n                    }\n                }).fail(function() {\n                    pane.find('.block-adeptus-tab-pane-loading').addClass('d-none');\n                    pane.find('.block-adeptus-tab-pane-content')\n                        .removeClass('d-none')\n                        .html('<div class=\"text-center text-muted py-4\">' +\n                            '<i class=\"fa fa-exclamation-circle\"></i>' +\n                            '<p class=\"mt-2\">Connection error</p></div>');\n                });\n            } else {\n                // AI reports\n                var token = this.apiKey || (window.adeptusAuthData ? window.adeptusAuthData.api_key : null);\n                if (!token) {\n                    pane.find('.block-adeptus-tab-pane-loading').addClass('d-none');\n                    pane.find('.block-adeptus-tab-pane-content')\n                        .removeClass('d-none')\n                        .html('<div class=\"text-center text-muted py-4\">' +\n                            '<i class=\"fa fa-exclamation-circle\"></i>' +\n                            '<p class=\"mt-2\">Authentication required</p></div>');\n                    return;\n                }\n\n                $.ajax({\n                    url: '' + this.backendUrl + '/ai-reports/' + slug,\n                    method: 'GET',\n                    headers: {\n                        'Authorization': 'Bearer ' + token,\n                        'Accept': 'application/json'\n                    },\n                    timeout: 15000\n                }).done(function(response) {\n                    if (response.success) {\n                        var reportData = response.report || report;\n                        var data = response.data || [];\n\n                        // Check if local execution is required (SaaS model)\n                        var sqlQuery = response.sql || (reportData && reportData.sql_query) || (reportData && reportData.sql);\n                        var needsLocalExecution = response.execution_required || ((!data || data.length === 0) && sqlQuery);\n\n                        if (needsLocalExecution && sqlQuery) {\n                            // Execute SQL locally against Moodle database\n                            self.executeReportLocally(sqlQuery, reportData.params || {})\n                                .then(function(executionResult) {\n                                    var localData = executionResult.data || [];\n                                    self.reportDataCache[cacheKey] = {\n                                        report: reportData,\n                                        results: localData\n                                    };\n                                    self.renderTabContent(pane, reportData, localData);\n                                    return localData;\n                                })\n                                .catch(function() {\n                                    pane.find('.block-adeptus-tab-pane-loading').addClass('d-none');\n                                    pane.find('.block-adeptus-tab-pane-content')\n                                        .removeClass('d-none')\n                                        .html('<div class=\"text-center text-muted py-4\">' +\n                                            '<i class=\"fa fa-exclamation-circle\"></i>' +\n                                            '<p class=\"mt-2\">Failed to execute report</p></div>');\n                                    return null;\n                                });\n                            return;\n                        }\n\n                        self.reportDataCache[cacheKey] = {\n                            report: reportData,\n                            results: data\n                        };\n                        self.renderTabContent(pane, reportData, data);\n                    } else {\n                        pane.find('.block-adeptus-tab-pane-loading').addClass('d-none');\n                        pane.find('.block-adeptus-tab-pane-content')\n                            .removeClass('d-none')\n                            .html('<div class=\"text-center text-muted py-4\">' +\n                                '<i class=\"fa fa-exclamation-circle\"></i>' +\n                                '<p class=\"mt-2\">Failed to load report</p></div>');\n                    }\n                }).fail(function() {\n                    pane.find('.block-adeptus-tab-pane-loading').addClass('d-none');\n                    pane.find('.block-adeptus-tab-pane-content')\n                        .removeClass('d-none')\n                        .html('<div class=\"text-center text-muted py-4\">' +\n                            '<i class=\"fa fa-exclamation-circle\"></i>' +\n                            '<p class=\"mt-2\">Connection error</p></div>');\n                });\n            }\n        },\n\n        /**\n         * Render tab content with report data - consistent with embedded/modal design.\n         *\n         * @param {jQuery} pane\n         * @param {Object} report\n         * @param {Array} data\n         */\n        renderTabContent: function(pane, report, data) {\n            var tabId = pane.attr('id');\n            pane.find('.block-adeptus-tab-pane-loading').addClass('d-none');\n            var contentArea = pane.find('.block-adeptus-tab-pane-content');\n\n            if (!data || data.length === 0) {\n                contentArea.removeClass('d-none')\n                    .html('<div class=\"text-center text-muted py-4\">' +\n                        '<i class=\"fa fa-inbox\"></i>' +\n                        '<p class=\"mt-2\">No data available</p></div>');\n                return;\n            }\n\n            // Detect headers and numeric columns\n            var headers = Object.keys(data[0]);\n            var numericCols = this.detectNumericColumns(data, headers);\n\n            // Initialize state for this tab pane\n            var state = {\n                data: data,\n                report: report,\n                headers: headers,\n                numericCols: numericCols,\n                currentView: 'table',\n                tablePage: 1,\n                rowsPerPage: 25,\n                chartType: 'bar',\n                xAxis: headers[0],\n                yAxis: numericCols.length > 0 ? numericCols[numericCols.length - 1] : headers[headers.length - 1]\n            };\n            this.tabPaneStates[tabId] = state;\n\n            // Show content area\n            contentArea.removeClass('d-none');\n\n            // Update meta bar\n            this.updateTabMetaBar(pane, report, data);\n\n            // Populate chart axis selectors\n            this.populateTabChartControls(pane, state);\n\n            // Render table (default view)\n            this.renderTabTablePage(pane, state);\n\n            // Reset view toggle to table\n            pane.find('.block-adeptus-tab-view-toggle-btn').removeClass('active');\n            pane.find('.block-adeptus-tab-view-toggle-btn[data-view=\"table\"]').addClass('active');\n            pane.find('.tab-table-view').removeClass('d-none');\n            pane.find('.block-adeptus-tab-chart-view').addClass('d-none');\n        },\n\n        /**\n         * Update tab meta bar with report info.\n         *\n         * @param {jQuery} pane\n         * @param {Object} report\n         * @param {Array} data\n         */\n        updateTabMetaBar: function(pane, report, data) {\n            // Category badge\n            var category = report.category || report.category_name || '';\n            var categoryBadge = pane.find('.block-adeptus-report-category');\n            if (category) {\n                categoryBadge.text(category).removeClass('d-none');\n                // Add category color if available\n                if (report.category_color) {\n                    categoryBadge.css('background-color', report.category_color);\n                } else {\n                    categoryBadge.addClass('bg-primary');\n                }\n            } else {\n                categoryBadge.addClass('d-none');\n            }\n\n            // Row count\n            pane.find('.block-adeptus-row-count-num').text(data.length);\n\n            // Report date\n            var dateStr = report.updated_at || report.created_at || '';\n            if (dateStr) {\n                var date = new Date(dateStr);\n                pane.find('.report-date').text(date.toLocaleDateString());\n            }\n        },\n\n        /**\n         * Populate chart control selectors for a tab.\n         *\n         * @param {jQuery} pane\n         * @param {Object} state\n         */\n        populateTabChartControls: function(pane, state) {\n            var xAxisSelect = pane.find('.block-adeptus-tab-chart-x-axis');\n            var yAxisSelect = pane.find('.block-adeptus-tab-chart-y-axis');\n\n            xAxisSelect.empty();\n            yAxisSelect.empty();\n\n            state.headers.forEach(function(header) {\n                var formatted = header.replace(/_/g, ' ').replace(/\\b\\w/g, function(letter) {\n                    return letter.toUpperCase();\n                });\n                xAxisSelect.append($('<option>').val(header).text(formatted));\n                yAxisSelect.append($('<option>').val(header).text(formatted));\n            });\n\n            // Set default selections\n            xAxisSelect.val(state.xAxis);\n            yAxisSelect.val(state.yAxis);\n        },\n\n        /**\n         * Switch view in a tab pane (table/chart).\n         *\n         * @param {jQuery} pane\n         * @param {string} view - 'table' or 'chart'\n         */\n        switchTabView: function(pane, view) {\n            var tabId = pane.attr('id');\n            var state = this.tabPaneStates[tabId];\n            if (!state) {\n                return;\n            }\n\n            state.currentView = view;\n\n            // Update toggle buttons\n            pane.find('.block-adeptus-tab-view-toggle-btn').removeClass('active');\n            pane.find('.block-adeptus-tab-view-toggle-btn[data-view=\"' + view + '\"]').addClass('active');\n\n            // Show/hide views\n            if (view === 'table') {\n                pane.find('.tab-table-view').removeClass('d-none');\n                pane.find('.block-adeptus-tab-chart-view').addClass('d-none');\n            } else {\n                pane.find('.tab-table-view').addClass('d-none');\n                pane.find('.block-adeptus-tab-chart-view').removeClass('d-none');\n                // Render chart if not already rendered\n                this.renderTabChart(pane, state);\n            }\n        },\n\n        /**\n         * Render table page in tab pane with pagination.\n         *\n         * @param {jQuery} pane\n         * @param {Object} state\n         */\n        renderTabTablePage: function(pane, state) {\n            var table = pane.find('.tab-table');\n            var thead = table.find('thead');\n            var tbody = table.find('tbody');\n            var data = state.data;\n            var headers = state.headers;\n\n            thead.empty();\n            tbody.empty();\n\n            // Build header row\n            var headerRow = $('<tr>');\n            headers.forEach(function(h) {\n                var formatted = h.replace(/_/g, ' ').replace(/\\b\\w/g, function(letter) {\n                    return letter.toUpperCase();\n                });\n                headerRow.append($('<th>').text(formatted));\n            });\n            thead.append(headerRow);\n\n            // Calculate pagination\n            var totalRows = data.length;\n            var totalPages = Math.ceil(totalRows / state.rowsPerPage);\n            var startIndex = (state.tablePage - 1) * state.rowsPerPage;\n            var endIndex = Math.min(startIndex + state.rowsPerPage, totalRows);\n            var pageData = data.slice(startIndex, endIndex);\n\n            // Render rows\n            pageData.forEach(function(row) {\n                var tr = $('<tr>');\n                headers.forEach(function(h) {\n                    var val = row[h];\n                    if (val === null || val === undefined) {\n                        val = '';\n                    }\n                    var displayVal = String(val);\n                    if (displayVal.length > 50) {\n                        displayVal = displayVal.substring(0, 50) + '...';\n                    }\n                    tr.append($('<td>').attr('title', val).text(displayVal));\n                });\n                tbody.append(tr);\n            });\n\n            // Update pagination info\n            var showingText = this.formatShowingText(startIndex + 1, endIndex, totalRows);\n            pane.find('.block-adeptus-row-count').text(showingText);\n            pane.find('.block-adeptus-tab-pagination-info').text(this.formatPageText(state.tablePage, totalPages));\n\n            // Update pagination buttons\n            pane.find('.block-adeptus-tab-pagination-prev').prop('disabled', state.tablePage <= 1);\n            pane.find('.block-adeptus-tab-pagination-next').prop('disabled', state.tablePage >= totalPages);\n\n            // Show/hide pagination\n            if (totalPages > 1) {\n                pane.find('.tab-table-pagination').removeClass('d-none');\n            } else {\n                pane.find('.tab-table-pagination').addClass('d-none');\n            }\n        },\n\n        /**\n         * Render chart in tab pane with current settings.\n         *\n         * @param {jQuery} pane\n         * @param {Object} state\n         */\n        renderTabChart: function(pane, state) {\n            var tabId = pane.attr('id');\n            var canvas = pane.find('.block-adeptus-tab-chart')[0];\n\n            if (!canvas || !state.data || state.data.length === 0) {\n                return;\n            }\n\n            // Destroy existing chart for this tab\n            if (this.tabChartInstances && this.tabChartInstances[tabId]) {\n                this.tabChartInstances[tabId].destroy();\n            }\n\n            var chartType = state.chartType;\n            var xAxis = state.xAxis;\n            var yAxis = state.yAxis;\n            var data = state.data;\n\n            // Limit data for chart\n            var chartData = data.slice(0, 20);\n            var labels = chartData.map(function(row) {\n                var label = row[xAxis];\n                if (label === null || label === undefined) {\n                    return this.strings.unknown;\n                }\n                var labelStr = String(label);\n                return labelStr.length > 20 ? labelStr.substring(0, 20) + '...' : labelStr;\n            });\n            var values = chartData.map(function(row) {\n                return parseFloat(row[yAxis]) || 0;\n            });\n\n            var colors = this.generateChartColors(values.length);\n            var yAxisFormatted = yAxis.replace(/_/g, ' ').replace(/\\b\\w/g, function(letter) {\n                    return letter.toUpperCase();\n                });\n\n            var config = {\n                type: chartType,\n                data: {\n                    labels: labels,\n                    datasets: [{\n                        label: yAxisFormatted,\n                        data: values,\n                        backgroundColor: chartType === 'pie' || chartType === 'doughnut'\n                            ? colors : colors[0],\n                        borderColor: (function() {\n                            if (chartType === 'line') {\n                                return colors[0];\n                            }\n                            if (chartType === 'pie' || chartType === 'doughnut') {\n                                return '#fff';\n                            }\n                            return colors[0];\n                        }()),\n                        borderWidth: chartType === 'pie' || chartType === 'doughnut' ? 2 : 1,\n                        fill: chartType === 'line' ? false : undefined,\n                        tension: chartType === 'line' ? 0.1 : undefined\n                    }]\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    plugins: {\n                        legend: {\n                            display: chartType === 'pie' || chartType === 'doughnut',\n                            position: 'right'\n                        }\n                    },\n                    scales: chartType === 'pie' || chartType === 'doughnut' ? {} : {\n                        y: {beginAtZero: true},\n                        x: {display: data.length <= 10}\n                    }\n                }\n            };\n\n            try {\n                this.tabChartInstances = this.tabChartInstances || {};\n                this.tabChartInstances[tabId] = new Chart(canvas.getContext('2d'), config);\n            } catch (_error) {\n                pane.find('.block-adeptus-tab-chart-container').html(\n                    '<div class=\"alert alert-warning text-center\">' +\n                    '<i class=\"fa fa-exclamation-circle\"></i> Could not render chart</div>'\n                );\n            }\n        },\n\n        /**\n         * Export report data from a tab using the main plugin's export system.\n         *\n         * @param {Object} state - Tab pane state\n         * @param {string} format - Export format (pdf, csv, json)\n         */\n        exportTabReport: function(state, format) {\n            var self = this;\n\n            if (!state || !state.data || state.data.length === 0) {\n                Notification.addNotification({\n                    message: self.strings.exportNoData,\n                    type: 'warning'\n                });\n                return;\n            }\n\n            // Check export eligibility via main plugin's AJAX endpoint\n            $.ajax({\n                url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/check_export_eligibility.php',\n                method: 'POST',\n                data: {\n                    format: format,\n                    sesskey: M.cfg.sesskey\n                },\n                dataType: 'json'\n            }).done(function(response) {\n                if (!response.success || !response.eligible) {\n                    self.showExportUpgradePrompt(format, response.message || self.strings.exportNotAvailable);\n                    return;\n                }\n\n                // Eligible - proceed with export\n                self.performExport(format, state.report, state.data);\n            }).fail(function() {\n                Notification.addNotification({\n                    message: self.strings.exportVerifyError,\n                    type: 'error'\n                });\n            });\n        },\n\n        /**\n         * Render table in tab pane (legacy fallback).\n         *\n         * @param {jQuery} pane\n         * @param {Array} data\n         */\n        renderTabTable: function(pane, data) {\n            var table = pane.find('table');\n            var thead = table.find('thead');\n            var tbody = table.find('tbody');\n            var maxRows = this.config.tableMaxRows || 10;\n\n            thead.empty();\n            tbody.empty();\n\n            if (!data || data.length === 0) {\n                return;\n            }\n\n            var headers = Object.keys(data[0]);\n            var headerRow = $('<tr>');\n            headers.forEach(function(h) {\n                var formatted = h.replace(/_/g, ' ').replace(/\\b\\w/g, function(letter) {\n                    return letter.toUpperCase();\n                });\n                headerRow.append($('<th>').text(formatted));\n            });\n            thead.append(headerRow);\n\n            data.slice(0, maxRows).forEach(function(row) {\n                var tr = $('<tr>');\n                headers.forEach(function(h) {\n                    var val = row[h];\n                    if (val === null || val === undefined) {\n                        val = '';\n                    }\n                    var displayVal = String(val);\n                    if (displayVal.length > 40) {\n                        displayVal = displayVal.substring(0, 40) + '...';\n                    }\n                    tr.append($('<td>').attr('title', val).text(displayVal));\n                });\n                tbody.append(tr);\n            });\n        },\n\n        /**\n         * Handle report click.\n         *\n         * @param {string} slug\n         * @param {string} source\n         */\n        handleReportClick: function(slug, source) {\n            var action = this.config.clickAction || 'modal';\n\n            // Check if we should open the enhanced KPI modal\n            // Only for KPI display mode with alerts feature enabled (enterprise gate)\n            if (this.config.displayMode === 'kpi' && this.config.alertsFeatureEnabled && action === 'modal') {\n                this.openKpiModal(slug, source);\n                return;\n            }\n\n            switch (action) {\n                case 'modal':\n                    this.openReportModal(slug, source);\n                    break;\n                case 'newtab':\n                    this.openReportNewTab(slug);\n                    break;\n            }\n        },\n\n        /**\n         * Open report in modal.\n         *\n         * @param {string} slug\n         * @param {string} source\n         */\n        openReportModal: function(slug, source) {\n            var self = this;\n\n            // Find report data.\n            var report = this.reports.find(function(r) {\n                return r.slug === slug;\n            });\n\n            if (!report) {\n                return;\n            }\n\n            // Reset state\n            this.modalData = null;\n            this.modalReport = null;\n            this.currentView = 'table';\n            if (this.chartInstance) {\n                this.chartInstance.destroy();\n                this.chartInstance = null;\n            }\n\n            // First render the template, then create the modal with the rendered body\n            Templates.render('block_adeptus_insights/report_modal', {blockid: this.blockId})\n                .then(function(html) {\n                    return ModalFactory.create({\n                        type: ModalFactory.types.DEFAULT,\n                        title: report.name,\n                        body: html,\n                        large: true\n                    });\n                })\n                .then(function(modal) {\n                    self.modal = modal;\n\n                    // Bind modal event handlers\n                    self.bindModalEvents(modal);\n\n                    // Load report data after modal is shown.\n                    modal.getRoot().on(ModalEvents.shown, function() {\n                        self.loadModalReport(slug, source);\n                    });\n\n                    // Cleanup on close.\n                    modal.getRoot().on(ModalEvents.hidden, function() {\n                        if (self.chartInstance) {\n                            self.chartInstance.destroy();\n                            self.chartInstance = null;\n                        }\n                        modal.destroy();\n                        self.modal = null;\n                        self.modalData = null;\n                        self.modalReport = null;\n                    });\n\n                    modal.show();\n                    return modal;\n                }).catch(Notification.exception);\n        },\n\n        /**\n         * Open enhanced KPI modal with interactive chart and date range filter.\n         * This is used when displayMode is 'kpi' and alertsFeatureEnabled is true.\n         *\n         * @param {string} slug\n         * @param {string} source\n         */\n        openKpiModal: function(slug, source) {\n            var self = this;\n\n            // Find report data.\n            var report = this.reports.find(function(r) {\n                return r.slug === slug;\n            });\n\n            if (!report) {\n                return;\n            }\n\n            // Reset state\n            this.kpiModalData = null;\n            this.kpiModalDateRange = '30d';\n            if (this.kpiModalChart) {\n                this.kpiModalChart.destroy();\n                this.kpiModalChart = null;\n            }\n\n            // First render the template, then create the modal with the rendered body\n            Templates.render('block_adeptus_insights/kpi_modal', {blockid: this.blockId})\n                .then(function(html) {\n                    return ModalFactory.create({\n                        type: ModalFactory.types.DEFAULT,\n                        title: report.name,\n                        body: html,\n                        large: true\n                    });\n                })\n                .then(function(modal) {\n                    self.kpiModal = modal;\n\n                    // Bind KPI modal event handlers\n                    self.bindKpiModalEvents(modal, slug, source);\n\n                    // Load KPI data after modal is shown.\n                    modal.getRoot().on(ModalEvents.shown, function() {\n                        self.loadKpiModalData(slug, source, self.kpiModalDateRange);\n                    });\n\n                    // Cleanup on close.\n                    modal.getRoot().on(ModalEvents.hidden, function() {\n                        if (self.kpiModalChart) {\n                            self.kpiModalChart.destroy();\n                            self.kpiModalChart = null;\n                        }\n                        modal.destroy();\n                        self.kpiModal = null;\n                        self.kpiModalData = null;\n                    });\n\n                    modal.show();\n                    return modal;\n                }).catch(Notification.exception);\n        },\n\n        /**\n         * Bind event handlers for KPI modal UI elements.\n         *\n         * @param {Object} modal\n         * @param {string} slug\n         * @param {string} source\n         */\n        bindKpiModalEvents: function(modal, slug, source) {\n            var self = this;\n            var modalRoot = modal.getRoot();\n\n            // Date range selector change\n            modalRoot.on('change', '.block-adeptus-kpi-date-range-select', function() {\n                var dateRange = $(this).val();\n                self.kpiModalDateRange = dateRange;\n                self.loadKpiModalData(slug, source, dateRange);\n            });\n\n            // Retry button\n            modalRoot.on('click', '.block-adeptus-kpi-modal-retry', function(e) {\n                e.preventDefault();\n                self.loadKpiModalData(slug, source, self.kpiModalDateRange);\n            });\n        },\n\n        /**\n         * Load KPI modal data based on date range.\n         *\n         * @param {string} slug\n         * @param {string} source\n         * @param {string} dateRange - '7d', '30d', '90d', or 'all'\n         */\n        loadKpiModalData: function(slug, source, dateRange) {\n            var self = this;\n            var modalContent = this.kpiModal.getRoot().find('.block-adeptus-kpi-modal-content');\n\n            // Show loading\n            modalContent.find('.block-adeptus-kpi-modal-loading').removeClass('d-none');\n            modalContent.find('.block-adeptus-kpi-modal-content-area').addClass('d-none');\n            modalContent.find('.block-adeptus-kpi-modal-error').addClass('d-none');\n\n            // Check cache first - use cached data if available and fresh (under 5 minutes old)\n            var cached = this.kpiSnapshotCache[slug];\n            var cacheMaxAge = 5 * 60 * 1000; // 5 minutes\n\n            if (cached && cached.history && (Date.now() - cached.timestamp) < cacheMaxAge) {\n                // Use cached data\n                self.kpiModalData = cached;\n                self.renderKpiModal(modalContent, cached, dateRange);\n                return;\n            }\n\n            // Fetch fresh data from backend via POST (same as KPI card refresh)\n            var token = this.apiKey;\n            if (!token) {\n                self.showKpiModalError(modalContent);\n                return;\n            }\n\n            var endpoint = source === 'ai' ? '/ai-reports/' : '/reports/';\n            var baselinePeriod = this.config.baselinePeriod || 'all_time';\n            var historyLimit = this.getKpiModalHistoryLimit(dateRange);\n\n            // Get current value from cache or use 0 (backend will return history regardless)\n            var currentValue = cached ? cached.currentValue : 0;\n\n            $.ajax({\n                url: this.backendUrl + endpoint + encodeURIComponent(slug) +\n                    '/snapshots?baseline_period=' + baselinePeriod + '&history_limit=' + historyLimit,\n                method: 'POST',\n                headers: {\n                    'Authorization': 'Bearer ' + token,\n                    'Content-Type': 'application/json',\n                    'Accept': 'application/json'\n                },\n                /* eslint-disable camelcase */\n                data: JSON.stringify({\n                    row_count: currentValue,\n                    execution_time_ms: 0,\n                    evaluate_alerts: false, // Don't trigger alerts from modal refresh\n                    baseline_period: baselinePeriod\n                }),\n                /* eslint-enable camelcase */\n                timeout: 15000,\n                success: function(response) {\n                    if (response && response.success && response.history) {\n                        // Update cache\n                        self.kpiSnapshotCache[slug] = {\n                            history: response.history || [],\n                            trend: response.trend || {},\n                            currentValue: currentValue,\n                            timestamp: Date.now()\n                        };\n\n                        self.kpiModalData = response;\n                        self.renderKpiModal(modalContent, response, dateRange);\n                    } else {\n                        self.showKpiModalError(modalContent);\n                    }\n                },\n                error: function() {\n                    self.showKpiModalError(modalContent);\n                }\n            });\n        },\n\n        /**\n         * Get history limit based on date range selection.\n         *\n         * @param {string} dateRange\n         * @return {number}\n         */\n        getKpiModalHistoryLimit: function(dateRange) {\n            switch (dateRange) {\n                case '7d':\n                    return 14;\n                case '30d':\n                    return 60;\n                case '90d':\n                    return 180;\n                case 'all':\n                    return 500;\n                default:\n                    return 60;\n            }\n        },\n\n        /**\n         * Render KPI modal with data.\n         *\n         * @param {jQuery} modalContent\n         * @param {Object} data\n         * @param {string} dateRange\n         */\n        renderKpiModal: function(modalContent, data, dateRange) {\n            // Hide loading, show content\n            modalContent.find('.block-adeptus-kpi-modal-loading').addClass('d-none');\n            modalContent.find('.block-adeptus-kpi-modal-content-area').removeClass('d-none');\n            modalContent.find('.block-adeptus-kpi-modal-error').addClass('d-none');\n\n            // Get history data and sort chronologically (oldest first)\n            var history = (data.history || []).slice(); // Clone to avoid mutating original\n            history.sort(function(a, b) {\n                var dateA = new Date(a.recorded_at || a.created_at);\n                var dateB = new Date(b.recorded_at || b.created_at);\n                return dateA - dateB; // Ascending order (oldest first)\n            });\n\n            // Get trend data from response\n            var trend = data.trend || {};\n            var vsBaseline = trend.vs_baseline || {};\n            var vsPrevious = trend.vs_previous || {};\n\n            // Filter history by date range\n            var filteredHistory = this.filterKpiHistoryByDateRange(history, dateRange);\n\n            // Current value: use the cached currentValue (from KPI card) or latest history entry\n            var currentValue = data.currentValue;\n            if (!currentValue && filteredHistory.length > 0) {\n                currentValue = filteredHistory[filteredHistory.length - 1].row_count;\n            }\n            currentValue = currentValue || '--';\n\n            // Update metric value\n            modalContent.find('.block-adeptus-kpi-modal-value').text(this.formatNumber(currentValue));\n\n            // Update dual trend display\n            this.renderKpiModalTrends(modalContent, vsBaseline, vsPrevious);\n\n            // Calculate stats\n            var stats = this.calculateKpiStats(filteredHistory);\n            modalContent.find('.block-adeptus-kpi-stat-min').text(this.formatNumber(stats.min));\n            modalContent.find('.block-adeptus-kpi-stat-max').text(this.formatNumber(stats.max));\n            modalContent.find('.block-adeptus-kpi-stat-avg').text(this.formatNumber(stats.avg));\n\n            // Update data points count\n            modalContent.find('.datapoints-count').text(filteredHistory.length);\n\n            // Update last updated\n            if (filteredHistory.length > 0) {\n                var lastEntry = filteredHistory[filteredHistory.length - 1];\n                var lastUpdated = lastEntry.recorded_at || lastEntry.created_at;\n                if (lastUpdated) {\n                    modalContent.find('.block-adeptus-kpi-modal-last-updated').text(\n                        this.strings.lastUpdated + ': ' + this.formatTimestamp(lastUpdated)\n                    );\n                }\n            }\n\n            // Render interactive chart\n            this.renderKpiModalChart(modalContent, filteredHistory);\n        },\n\n        /**\n         * Filter KPI history by date range.\n         *\n         * @param {Array} history\n         * @param {string} dateRange\n         * @return {Array}\n         */\n        filterKpiHistoryByDateRange: function(history, dateRange) {\n            if (dateRange === 'all' || !history || history.length === 0) {\n                return history;\n            }\n\n            var now = new Date();\n            var cutoffDate;\n\n            switch (dateRange) {\n                case '7d':\n                    cutoffDate = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000));\n                    break;\n                case '30d':\n                    cutoffDate = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));\n                    break;\n                case '90d':\n                    cutoffDate = new Date(now.getTime() - (90 * 24 * 60 * 60 * 1000));\n                    break;\n                default:\n                    return history;\n            }\n\n            return history.filter(function(entry) {\n                var entryDate = new Date(entry.recorded_at || entry.created_at);\n                return entryDate >= cutoffDate;\n            });\n        },\n\n        /**\n         * Render dual trend metrics in KPI modal.\n         *\n         * @param {jQuery} modalContent\n         * @param {Object} vsBaseline\n         * @param {Object} vsPrevious\n         */\n        renderKpiModalTrends: function(modalContent, vsBaseline, vsPrevious) {\n            // Format baseline trend (vs overall baseline)\n            // Helper for direction sign lookup.\n            var directionSigns = {increase: '+', decrease: '-'};\n\n            var baselineHtml = '--';\n            if (vsBaseline && vsBaseline.has_baseline) {\n                var baselinePct = this.formatPercentage(Math.abs(vsBaseline.change_percent || 0));\n                var baselineIcon = this.getTrendIcon(vsBaseline.direction);\n                var baselineClass = 'trend-' + (vsBaseline.direction || 'neutral');\n                var baselineSign = directionSigns[vsBaseline.direction] || '';\n                baselineHtml = '<span class=\"' + baselineClass + '\">' +\n                    baselineIcon + ' ' + baselineSign + baselinePct + ' overall</span>';\n            }\n            modalContent.find('.block-adeptus-kpi-modal-trend-baseline').html(baselineHtml);\n\n            // Format previous trend (vs previous snapshot)\n            var previousHtml = '--';\n            if (vsPrevious && vsPrevious.has_previous) {\n                var previousPct = this.formatPercentage(Math.abs(vsPrevious.change_percent || 0));\n                var previousIcon = this.getTrendIcon(vsPrevious.direction);\n                var previousClass = 'trend-' + (vsPrevious.direction || 'neutral');\n                var previousSign = directionSigns[vsPrevious.direction] || '';\n                previousHtml = '<span class=\"' + previousClass + '\">' +\n                    previousIcon + ' ' + previousSign + previousPct + ' since last</span>';\n            }\n            modalContent.find('.block-adeptus-kpi-modal-trend-previous').html(previousHtml);\n        },\n\n        /**\n         * Calculate statistics from KPI history.\n         *\n         * @param {Array} history\n         * @return {Object}\n         */\n        calculateKpiStats: function(history) {\n            if (!history || history.length === 0) {\n                return {min: '--', max: '--', avg: '--'};\n            }\n\n            var values = history.map(function(entry) {\n                return parseFloat(entry.row_count) || 0;\n            });\n\n            var min = Math.min.apply(null, values);\n            var max = Math.max.apply(null, values);\n            var sum = values.reduce(function(a, b) {\n                return a + b;\n            }, 0);\n            var avg = Math.round(sum / values.length);\n\n            return {min: min, max: max, avg: avg};\n        },\n\n        /**\n         * Render interactive chart in KPI modal.\n         *\n         * @param {jQuery} modalContent\n         * @param {Array} history\n         */\n        renderKpiModalChart: function(modalContent, history) {\n            var self = this;\n            var canvas = modalContent.find('.block-adeptus-kpi-modal-chart')[0];\n\n            if (!canvas) {\n                return;\n            }\n\n            // Destroy existing chart\n            if (this.kpiModalChart) {\n                this.kpiModalChart.destroy();\n            }\n\n            // Prepare chart data - filter out consecutive duplicates where value hasn't changed\n            var labels = [];\n            var data = [];\n            var lastValue = null;\n\n            history.forEach(function(entry) {\n                var value = parseFloat(entry.row_count) || 0;\n\n                // Only add data point if the value has changed from the previous entry\n                if (lastValue === null || value !== lastValue) {\n                    var date = new Date(entry.recorded_at || entry.created_at);\n                    labels.push(self.formatChartDate(date));\n                    data.push(value);\n                    lastValue = value;\n                }\n            });\n\n            // Create chart\n            var ctx = canvas.getContext('2d');\n            this.kpiModalChart = new Chart(ctx, {\n                type: 'line',\n                data: {\n                    labels: labels,\n                    datasets: [{\n                        label: 'Value',\n                        data: data,\n                        borderColor: '#0066cc',\n                        backgroundColor: 'rgba(0, 102, 204, 0.1)',\n                        borderWidth: 2,\n                        fill: true,\n                        tension: 0.3,\n                        pointRadius: 4,\n                        pointHoverRadius: 6,\n                        pointBackgroundColor: '#0066cc',\n                        pointBorderColor: '#fff',\n                        pointBorderWidth: 2\n                    }]\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    interaction: {\n                        mode: 'index',\n                        intersect: false\n                    },\n                    plugins: {\n                        legend: {\n                            display: false\n                        },\n                        tooltip: {\n                            enabled: true,\n                            backgroundColor: 'rgba(0, 0, 0, 0.8)',\n                            titleColor: '#fff',\n                            bodyColor: '#fff',\n                            padding: 12,\n                            displayColors: false,\n                            callbacks: {\n                                title: function(tooltipItems) {\n                                    return tooltipItems[0].label;\n                                },\n                                label: function(context) {\n                                    return 'Value: ' + self.formatNumber(context.parsed.y);\n                                }\n                            }\n                        }\n                    },\n                    scales: {\n                        x: {\n                            display: true,\n                            grid: {\n                                display: false\n                            },\n                            ticks: {\n                                maxRotation: 45,\n                                minRotation: 0,\n                                autoSkip: true,\n                                maxTicksLimit: 10\n                            }\n                        },\n                        y: {\n                            display: true,\n                            beginAtZero: false,\n                            grid: {\n                                color: 'rgba(0, 0, 0, 0.05)'\n                            },\n                            ticks: {\n                                callback: function(value) {\n                                    return self.formatNumber(value);\n                                }\n                            }\n                        }\n                    }\n                }\n            });\n        },\n\n        /**\n         * Format date for chart X-axis labels.\n         *\n         * @param {Date} date\n         * @return {string}\n         */\n        formatChartDate: function(date) {\n            var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',\n                          'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];\n            return months[date.getMonth()] + ' ' + date.getDate();\n        },\n\n        /**\n         * Show error state in KPI modal.\n         *\n         * @param {jQuery} modalContent\n         */\n        showKpiModalError: function(modalContent) {\n            modalContent.find('.block-adeptus-kpi-modal-loading').addClass('d-none');\n            modalContent.find('.block-adeptus-kpi-modal-content-area').addClass('d-none');\n            modalContent.find('.block-adeptus-kpi-modal-error').removeClass('d-none');\n        },\n\n        /**\n         * Bind event handlers for modal UI elements.\n         *\n         * @param {Object} modal\n         */\n        bindModalEvents: function(modal) {\n            var self = this;\n            var modalRoot = modal.getRoot();\n\n            // View toggle buttons\n            modalRoot.on('click', '.block-adeptus-view-toggle-btn', function(e) {\n                e.preventDefault();\n                var view = $(this).data('view');\n                self.switchModalView(view);\n            });\n\n            // Chart control changes\n            modalRoot.on('change', '#modal-chart-type, #modal-chart-x-axis, #modal-chart-y-axis', function() {\n                if (self.currentView === 'chart') {\n                    self.renderModalChart();\n                }\n            });\n\n            // Retry button\n            modalRoot.on('click', '.block-adeptus-modal-retry', function(e) {\n                e.preventDefault();\n                if (self.modalReport) {\n                    self.loadModalReport(self.modalReport.slug, self.modalReport.source);\n                }\n            });\n\n            // Export buttons (PDF, CSV, JSON)\n            modalRoot.on('click', '.block-adeptus-modal-export', function(e) {\n                e.preventDefault();\n                var format = $(this).data('format');\n                self.exportModalData(format);\n            });\n\n            // Table pagination - Previous\n            modalRoot.on('click', '.table-pagination-prev', function(e) {\n                e.preventDefault();\n                if (self.tableCurrentPage > 1) {\n                    self.tableCurrentPage--;\n                    self.renderModalTablePage();\n                }\n            });\n\n            // Table pagination - Next\n            modalRoot.on('click', '.table-pagination-next', function(e) {\n                e.preventDefault();\n                if (self.tableCurrentPage < self.tableTotalPages) {\n                    self.tableCurrentPage++;\n                    self.renderModalTablePage();\n                }\n            });\n        },\n\n        /**\n         * Switch between table and chart views in modal.\n         *\n         * @param {string} view - 'table' or 'chart'\n         */\n        switchModalView: function(view) {\n            var modalBody = this.modal.getBody();\n\n            // Update toggle buttons\n            modalBody.find('.block-adeptus-view-toggle-btn').removeClass('active');\n            modalBody.find('.block-adeptus-view-toggle-btn[data-view=\"' + view + '\"]').addClass('active');\n\n            // Switch views\n            if (view === 'table') {\n                modalBody.find('#modal-table-view').removeClass('d-none');\n                modalBody.find('#modal-chart-view').addClass('d-none');\n            } else {\n                modalBody.find('#modal-table-view').addClass('d-none');\n                modalBody.find('#modal-chart-view').removeClass('d-none');\n                // Render chart when switching to chart view\n                this.renderModalChart();\n            }\n\n            this.currentView = view;\n        },\n\n        /**\n         * Load report data into modal.\n         *\n         * @param {string} slug\n         * @param {string} source\n         */\n        loadModalReport: function(slug, source) {\n            var self = this;\n            var modalBody = this.modal.getBody();\n            var cacheKey = slug + '_' + source;\n\n            // Check cache first for instant loading\n            if (this.reportDataCache[cacheKey]) {\n                var cached = this.reportDataCache[cacheKey];\n                modalBody.find('.block-adeptus-modal-loading').addClass('d-none');\n                this.renderModalContent(modalBody, cached.report, cached.results);\n                return;\n            }\n\n            // Find the report from our cached list\n            var report = this.reports.find(function(r) {\n                return r.slug === slug;\n            });\n\n            if (!report) {\n                modalBody.find('.block-adeptus-modal-loading').addClass('d-none');\n                modalBody.find('.block-adeptus-modal-error').removeClass('d-none');\n                return;\n            }\n\n            // For wizard reports, execute locally via generate_report.php\n            // For AI reports, we need to fetch from backend\n            if (source === 'wizard') {\n                // Execute report via local Moodle AJAX endpoint\n                $.ajax({\n                    url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/generate_report.php',\n                    method: 'POST',\n                    data: {\n                        reportid: report.name || report.report_template_id,\n                        sesskey: M.cfg.sesskey\n                    },\n                    dataType: 'json',\n                    timeout: 30000\n                }).done(function(response) {\n                    modalBody.find('.block-adeptus-modal-loading').addClass('d-none');\n\n                    if (response.success) {\n                        // Cache the result for future use\n                        self.reportDataCache[cacheKey] = {\n                            report: report,\n                            results: response.results || [],\n                            chartData: response.chart_data,\n                            chartType: response.chart_type\n                        };\n                        self.renderModalContent(modalBody, report, response.results || []);\n                    } else {\n                        modalBody.find('.block-adeptus-modal-error').removeClass('d-none');\n                        modalBody.find('.block-adeptus-modal-error p').text(response.message || self.strings.errorFailedLoadReport);\n                    }\n                }).fail(function() {\n                    modalBody.find('.block-adeptus-modal-loading').addClass('d-none');\n                    modalBody.find('.block-adeptus-modal-error').removeClass('d-none');\n                });\n            } else {\n                // AI reports - fetch from backend API\n                var token = this.apiKey || (window.adeptusAuthData ? window.adeptusAuthData.api_key : null);\n\n                if (!token) {\n                    modalBody.find('.block-adeptus-modal-loading').addClass('d-none');\n                    modalBody.find('.block-adeptus-modal-error').removeClass('d-none');\n                    return;\n                }\n\n                $.ajax({\n                    url: '' + this.backendUrl + '/ai-reports/' + slug,\n                    method: 'GET',\n                    headers: {\n                        'Authorization': 'Bearer ' + token,\n                        'Accept': 'application/json'\n                    },\n                    timeout: 15000\n                }).done(function(response) {\n                    if (response.success && response.report) {\n                        var reportData = response.report;\n                        var data = response.data || [];\n\n                        // Check if local execution is required (SaaS model)\n                        var sqlQuery = response.sql || (reportData && reportData.sql_query) || (reportData && reportData.sql);\n                        var needsLocalExecution = response.execution_required || ((!data || data.length === 0) && sqlQuery);\n\n                        if (needsLocalExecution && sqlQuery) {\n                            // Execute SQL locally against Moodle database\n                            self.executeReportLocally(sqlQuery, reportData.params || {})\n                                .then(function(executionResult) {\n                                    modalBody.find('.block-adeptus-modal-loading').addClass('d-none');\n                                    var localData = executionResult.data || [];\n                                    self.reportDataCache[cacheKey] = {\n                                        report: reportData,\n                                        results: localData,\n                                        chartData: null,\n                                        chartType: null\n                                    };\n                                    self.renderModalContent(modalBody, reportData, localData);\n                                    return localData;\n                                })\n                                .catch(function() {\n                                    modalBody.find('.block-adeptus-modal-loading').addClass('d-none');\n                                    modalBody.find('.block-adeptus-modal-error').removeClass('d-none');\n                                    return null;\n                                });\n                            return;\n                        }\n\n                        modalBody.find('.block-adeptus-modal-loading').addClass('d-none');\n                        // Cache the result for future use\n                        self.reportDataCache[cacheKey] = {\n                            report: reportData,\n                            results: data,\n                            chartData: null,\n                            chartType: null\n                        };\n                        self.renderModalContent(modalBody, reportData, data);\n                    } else {\n                        modalBody.find('.block-adeptus-modal-loading').addClass('d-none');\n                        modalBody.find('.block-adeptus-modal-error').removeClass('d-none');\n                    }\n                }).fail(function() {\n                    modalBody.find('.block-adeptus-modal-loading').addClass('d-none');\n                    modalBody.find('.block-adeptus-modal-error').removeClass('d-none');\n                });\n            }\n        },\n\n        /**\n         * Render modal content with report data.\n         *\n         * @param {jQuery} modalBody The modal body element\n         * @param {Object} report The report metadata\n         * @param {Array} data The report data rows\n         */\n        renderModalContent: function(modalBody, report, data) {\n            // Store data for chart re-rendering\n            this.modalData = data || [];\n            this.modalReport = report;\n\n            var contentArea = modalBody.find('.block-adeptus-modal-content-area');\n            contentArea.removeClass('d-none');\n\n            // Set report metadata\n            var category = report.category_info || {name: 'General', color: '#6c757d'};\n            modalBody.find('.block-adeptus-report-category')\n                .text(category.name)\n                .css('background-color', category.color);\n            modalBody.find('.block-adeptus-row-count-num').text(this.modalData.length);\n            modalBody.find('.report-date')\n                .text(report.last_executed_at ?\n                    this.strings.lastRun.replace('{$a}', new Date(report.last_executed_at).toLocaleDateString()) : '');\n\n            // Populate axis selectors\n            this.populateAxisSelectors(modalBody);\n\n            // Render table\n            this.renderModalTable(modalBody, this.modalData);\n\n            // Reset to table view\n            this.currentView = 'table';\n            modalBody.find('.block-adeptus-view-toggle-btn').removeClass('active');\n            modalBody.find('.block-adeptus-view-toggle-btn[data-view=\"table\"]').addClass('active');\n            modalBody.find('#modal-table-view').removeClass('d-none');\n            modalBody.find('#modal-chart-view').addClass('d-none');\n        },\n\n        /**\n         * Populate X-axis and Y-axis dropdown selectors.\n         *\n         * @param {jQuery} modalBody\n         */\n        populateAxisSelectors: function(modalBody) {\n            var data = this.modalData;\n            if (!data || data.length === 0) {\n                return;\n            }\n\n            var headers = Object.keys(data[0]);\n            var xAxisSelect = modalBody.find('#modal-chart-x-axis');\n            var yAxisSelect = modalBody.find('#modal-chart-y-axis');\n\n            // Clear existing options\n            xAxisSelect.empty();\n            yAxisSelect.empty();\n\n            // Detect numeric columns for Y-axis\n            var numericCols = this.detectNumericColumns(data, headers);\n\n            // Populate X-axis with all columns\n            headers.forEach(function(header, idx) {\n                var formattedHeader = header.replace(/_/g, ' ').replace(/\\b\\w/g, function(letter) {\n                    return letter.toUpperCase();\n                });\n                var selected = idx === 0 ? ' selected' : '';\n                xAxisSelect.append('<option value=\"' + header + '\"' + selected + '>' + formattedHeader + '</option>');\n            });\n\n            // Populate Y-axis with numeric columns (or all if none detected)\n            var yAxisOptions = numericCols.length > 0 ? numericCols : headers;\n            yAxisOptions.forEach(function(col, idx) {\n                var formattedHeader = col.replace(/_/g, ' ').replace(/\\b\\w/g, function(letter) {\n                    return letter.toUpperCase();\n                });\n                // Select the last numeric column by default (usually the main value)\n                var selected = idx === yAxisOptions.length - 1 ? ' selected' : '';\n                yAxisSelect.append('<option value=\"' + col + '\"' + selected + '>' + formattedHeader + '</option>');\n            });\n        },\n\n        /**\n         * Detect numeric columns in data.\n         *\n         * @param {Array} data\n         * @param {Array} headers\n         * @return {Array}\n         */\n        detectNumericColumns: function(data, headers) {\n            var numericCols = [];\n\n            headers.forEach(function(header) {\n                var isNumeric = data.every(function(row) {\n                    var val = row[header];\n                    if (val === null || val === undefined || val === '') {\n                        return true; // Allow nulls\n                    }\n                    return !isNaN(parseFloat(val)) && isFinite(val);\n                });\n\n                // Also check if at least some values are actually numbers\n                var hasNumbers = data.some(function(row) {\n                    var val = row[header];\n                    return val !== null && val !== undefined && val !== '' && !isNaN(parseFloat(val));\n                });\n\n                if (isNumeric && hasNumbers) {\n                    numericCols.push(header);\n                }\n            });\n\n            return numericCols;\n        },\n\n        /**\n         * Execute AI report SQL locally against Moodle database.\n         * Used when backend returns SQL query but no data (SaaS model).\n         *\n         * @param {string} sql - The SQL query to execute\n         * @param {Object} params - Query parameters\n         * @return {Promise}\n         */\n        executeReportLocally: function(sql, params) {\n            params = params || {};\n\n            return new Promise(function(resolve, reject) {\n                $.ajax({\n                    url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/execute_ai_report.php',\n                    method: 'POST',\n                    contentType: 'application/json',\n                    data: JSON.stringify({\n                        sql: sql,\n                        params: params,\n                        sesskey: M.cfg.sesskey\n                    }),\n                    timeout: 60000,\n                    success: function(response) {\n                        /* eslint-disable camelcase */\n                        if (response.success) {\n                            resolve({\n                                data: response.data || [],\n                                headers: response.headers || [],\n                                row_count: response.row_count || 0,\n                                error: null\n                            });\n                        } else {\n                            resolve({\n                                data: [],\n                                headers: [],\n                                row_count: 0,\n                                error: response.message || 'Query execution failed'\n                            });\n                        }\n                        /* eslint-enable camelcase */\n                    },\n                    error: function(_jqXhr, _textStatus, errorThrown) {\n                        reject(new Error('Failed to execute report: ' + errorThrown));\n                    }\n                });\n            });\n        },\n\n        /**\n         * Render chart in modal using current control values.\n         */\n        renderModalChart: function() {\n            var self = this;\n            var modalBody = this.modal.getBody();\n            var data = this.modalData;\n\n            if (!data || data.length === 0) {\n                modalBody.find('.block-adeptus-chart-container').html(\n                    '<div class=\"alert alert-warning text-center\">' +\n                    '<i class=\"fa fa-info-circle\"></i> No data available for chart</div>'\n                );\n                return;\n            }\n\n            var canvas = modalBody.find('.block-adeptus-modal-chart')[0];\n            if (!canvas) {\n                return;\n            }\n\n            // Destroy existing chart\n            if (this.chartInstance) {\n                this.chartInstance.destroy();\n                this.chartInstance = null;\n            }\n\n            // Get control values\n            var chartType = modalBody.find('#modal-chart-type').val() || 'bar';\n            var labelKey = modalBody.find('#modal-chart-x-axis').val();\n            var valueKey = modalBody.find('#modal-chart-y-axis').val();\n\n            // Fallback if not set\n            if (!labelKey || !valueKey) {\n                var headers = Object.keys(data[0]);\n                labelKey = labelKey || headers[0];\n                valueKey = valueKey || headers[headers.length - 1];\n            }\n\n            // Format value key for display\n            var valueKeyFormatted = valueKey.replace(/_/g, ' ').replace(/\\b\\w/g, function(letter) {\n                    return letter.toUpperCase();\n                });\n\n            // Limit data for chart readability (max 50 items)\n            var chartData = data.slice(0, 50);\n            var labels = chartData.map(function(row) {\n                var label = row[labelKey];\n                if (label === null || label === undefined) {\n                    return self.strings.unknown;\n                }\n                var labelStr = String(label);\n                return labelStr.length > 30 ? labelStr.substring(0, 30) + '...' : labelStr;\n            });\n            var values = chartData.map(function(row) {\n                return parseFloat(row[valueKey]) || 0;\n            });\n\n            // Generate colors\n            var colors = this.generateChartColors(values.length);\n\n            // Create chart config\n            var config = this.createChartConfig(chartType, labels, values, valueKeyFormatted, colors);\n\n            try {\n                this.chartInstance = new Chart(canvas.getContext('2d'), config);\n            } catch (_error) {\n                modalBody.find('.block-adeptus-chart-container').html(\n                    '<div class=\"alert alert-danger\">' +\n                    '<i class=\"fa fa-exclamation-triangle\"></i> Error rendering chart</div>'\n                );\n            }\n        },\n\n        /**\n         * Create Chart.js configuration.\n         *\n         * @param {string} chartType\n         * @param {Array} labels\n         * @param {Array} values\n         * @param {string} valueKey\n         * @param {Array} colors\n         * @return {Object}\n         */\n        createChartConfig: function(chartType, labels, values, valueKey, colors) {\n            var reportName = this.modalReport ? this.modalReport.name : 'Report';\n\n            var baseOptions = {\n                responsive: true,\n                maintainAspectRatio: false,\n                plugins: {\n                    title: {\n                        display: true,\n                        text: reportName,\n                        font: {size: 14, weight: 'bold'},\n                        padding: {top: 10, bottom: 20}\n                    },\n                    legend: {\n                        display: chartType === 'pie' || chartType === 'doughnut',\n                        position: 'right'\n                    }\n                }\n            };\n\n            if (chartType === 'pie' || chartType === 'doughnut') {\n                return {\n                    type: chartType,\n                    data: {\n                        labels: labels,\n                        datasets: [{\n                            data: values,\n                            backgroundColor: colors,\n                            borderWidth: 2\n                        }]\n                    },\n                    options: baseOptions\n                };\n            } else {\n                // Bar or Line chart\n                baseOptions.scales = {\n                    y: {\n                        beginAtZero: true,\n                        title: {\n                            display: true,\n                            text: valueKey\n                        }\n                    },\n                    x: {\n                        title: {\n                            display: false\n                        }\n                    }\n                };\n\n                return {\n                    type: chartType,\n                    data: {\n                        labels: labels,\n                        datasets: [{\n                            label: valueKey,\n                            data: values,\n                            backgroundColor: chartType === 'line' ? 'transparent' : colors[0],\n                            borderColor: colors[0].replace('0.7', '1'),\n                            borderWidth: 2,\n                            fill: chartType === 'line' ? false : true,\n                            tension: 0.1\n                        }]\n                    },\n                    options: baseOptions\n                };\n            }\n        },\n\n        /**\n         * Generate chart colors.\n         *\n         * @param {number} count Number of colors needed\n         * @return {Array} Array of color strings\n         */\n        generateChartColors: function(count) {\n            var baseColors = [\n                'rgba(37, 99, 235, 0.7)', // Blue.\n                'rgba(16, 185, 129, 0.7)', // Green.\n                'rgba(245, 158, 11, 0.7)', // Amber.\n                'rgba(239, 68, 68, 0.7)', // Red.\n                'rgba(139, 92, 246, 0.7)', // Purple.\n                'rgba(6, 182, 212, 0.7)', // Cyan.\n                'rgba(236, 72, 153, 0.7)', // Pink.\n                'rgba(132, 204, 22, 0.7)', // Lime.\n                'rgba(249, 115, 22, 0.7)', // Orange.\n                'rgba(99, 102, 241, 0.7)' // Indigo.\n            ];\n\n            var colors = [];\n            for (var i = 0; i < count; i++) {\n                colors.push(baseColors[i % baseColors.length]);\n            }\n            return colors;\n        },\n\n        /**\n         * Export modal data using the main plugin's export system.\n         * Checks eligibility and respects subscription-level permissions.\n         *\n         * @param {string} format - Export format (pdf, csv, json)\n         */\n        exportModalData: function(format) {\n            var self = this;\n            var data = this.modalData;\n            var report = this.modalReport;\n\n            if (!data || data.length === 0) {\n                Notification.addNotification({\n                    message: self.strings.exportNoData,\n                    type: 'warning'\n                });\n                return;\n            }\n\n            // Check export eligibility via main plugin's AJAX endpoint\n            $.ajax({\n                url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/check_export_eligibility.php',\n                method: 'POST',\n                data: {\n                    format: format,\n                    sesskey: M.cfg.sesskey\n                },\n                dataType: 'json'\n            }).done(function(response) {\n                if (!response.success || !response.eligible) {\n                    // Show upgrade prompt for premium features\n                    self.showExportUpgradePrompt(format, response.message || self.strings.exportNotAvailable);\n                    return;\n                }\n\n                // Eligible - proceed with export via main plugin\n                self.performExport(format, report, data);\n            }).fail(function() {\n                Notification.addNotification({\n                    message: self.strings.exportVerifyError,\n                    type: 'error'\n                });\n            });\n        },\n\n        /**\n         * Show upgrade prompt when export format is not available on current plan.\n         *\n         * @param {string} format - The requested format\n         * @param {string} message - Message from eligibility check\n         */\n        showExportUpgradePrompt: function(format, message) {\n            var formatNames = {\n                'pdf': 'PDF',\n                'csv': 'CSV',\n                'json': 'JSON'\n            };\n            var formatName = formatNames[format] || format.toUpperCase();\n\n            Notification.alert(\n                this.strings.exportTitle.replace('{$a}', formatName),\n                message || this.strings.exportNotOnPlan.replace('{$a}', formatName),\n                this.strings.ok\n            );\n        },\n\n        /**\n         * Capture chart image from modal for PDF export.\n         * Returns base64 encoded PNG image data.\n         *\n         * @returns {Promise<string|null>} Base64 image data or null if capture fails\n         */\n        captureChartImage: function() {\n            var self = this;\n            return new Promise(function(resolve) {\n                // Wait for any chart animations to complete\n                setTimeout(function() {\n                    var canvas = null;\n\n                    // Try to find chart canvas in order of priority\n                    // 1. Modal chart (report links modal)\n                    var modalChart = document.querySelector('.modal.show .block-adeptus-modal-chart');\n                    if (modalChart) {\n                        canvas = modalChart;\n                    }\n\n                    // 2. Embedded chart\n                    if (!canvas) {\n                        var embeddedChart = self.container ? self.container.find('.block-adeptus-embedded-chart')[0] : null;\n                        if (embeddedChart) {\n                            canvas = embeddedChart;\n                        }\n                    }\n\n                    // 3. Tab chart (active tab)\n                    if (!canvas) {\n                        var tabChart = self.container ? self.container.find('.tab-pane.active .block-adeptus-tab-chart')[0] : null;\n                        if (tabChart) {\n                            canvas = tabChart;\n                        }\n                    }\n\n                    // 4. Fallback - any visible chart\n                    if (!canvas) {\n                        canvas = document.querySelector(\n                            '.block-adeptus-modal-chart, ' +\n                            '.block-adeptus-embedded-chart, ' +\n                            '.block-adeptus-tab-chart'\n                        );\n                    }\n\n                    if (!canvas) {\n                        resolve(null);\n                        return;\n                    }\n\n                    try {\n                        var dataUrl = canvas.toDataURL('image/png', 0.8);\n                        if (dataUrl && dataUrl.length > 100 && dataUrl.length < 2000000) {\n                            resolve(dataUrl);\n                        } else {\n                            resolve(null);\n                        }\n                    } catch (_e) {\n                        resolve(null);\n                    }\n                }, 300);\n            });\n        },\n\n        /**\n         * Perform the actual export via the main plugin's export endpoint.\n         *\n         * @param {string} format - Export format\n         * @param {Object} report - Report metadata\n         * @param {Array} data - Report data\n         */\n        performExport: function(format, report, data) {\n            var self = this;\n\n            // Prepare report data for export endpoint\n            var headers = data.length > 0 ? Object.keys(data[0]) : [];\n            /* eslint-disable camelcase */\n            var reportData = {\n                results: data,\n                headers: headers,\n                report_name: report ? report.name : 'Report',\n                report_category: report ? (report.category || '') : ''\n            };\n            /* eslint-enable camelcase */\n\n            // For PDF in chart view, capture chart image first\n            var chartPromise = Promise.resolve(null);\n            if (format === 'pdf' && self.currentView === 'chart') {\n                chartPromise = self.captureChartImage();\n            }\n\n            chartPromise.then(function(chartImage) {\n                // Create form and submit to export endpoint (reliable method)\n                var form = document.createElement('form');\n                form.method = 'POST';\n                form.action = M.cfg.wwwroot + '/report/adeptus_insights/ajax/export_report.php';\n                form.target = '_blank';\n\n                // Add form fields\n                var fields = {\n                    'reportid': report ? report.slug : 'block_export',\n                    'format': format,\n                    'sesskey': M.cfg.sesskey,\n                    'view': self.currentView || 'table',\n                    'report_data': JSON.stringify(reportData),\n                    'chart_image': (chartImage && chartImage.length > 100) ? chartImage : ''\n                };\n\n                for (var key in fields) {\n                    if (fields.hasOwnProperty(key)) {\n                        var input = document.createElement('input');\n                        input.type = 'hidden';\n                        input.name = key;\n                        input.value = fields[key];\n                        form.appendChild(input);\n                    }\n                }\n\n                document.body.appendChild(form);\n                form.submit();\n                document.body.removeChild(form);\n\n                // Track export (soft-fail, don't disrupt user experience)\n                $.ajax({\n                    url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/track_export.php',\n                    method: 'POST',\n                    /* eslint-disable camelcase */\n                    data: {\n                        format: format,\n                        report_name: report ? report.name : 'Block Export',\n                        sesskey: M.cfg.sesskey\n                    }\n                    /* eslint-enable camelcase */\n                });\n                return true;\n            }).catch(function() {\n                // Export capture failed, continue anyway.\n                return false;\n            });\n        },\n\n        /**\n         * Render table in modal with pagination.\n         *\n         * @param {jQuery} modalBody\n         * @param {Array} data\n         */\n        renderModalTable: function(modalBody, data) {\n            // Reset pagination\n            this.tableCurrentPage = 1;\n            this.tableTotalPages = Math.ceil((data ? data.length : 0) / this.tableRowsPerPage);\n\n            // Build table headers once\n            var table = modalBody.find('.block-adeptus-modal-table');\n            var thead = table.find('thead');\n\n            thead.empty();\n\n            if (!data || data.length === 0) {\n                modalBody.find('.block-adeptus-modal-table-container').addClass('d-none');\n                return;\n            }\n\n            // Build headers from first row\n            var headers = Object.keys(data[0]);\n            var headerRow = $('<tr>');\n            headers.forEach(function(h) {\n                // Format header nicely\n                var formatted = h.replace(/_/g, ' ').replace(/\\b\\w/g, function(letter) {\n                    return letter.toUpperCase();\n                });\n                headerRow.append($('<th>').text(formatted));\n            });\n            thead.append(headerRow);\n\n            // Render first page\n            this.renderModalTablePage();\n        },\n\n        /**\n         * Render current page of table data.\n         */\n        renderModalTablePage: function() {\n            var modalBody = this.modal.getBody();\n            var data = this.modalData || [];\n            var table = modalBody.find('.block-adeptus-modal-table');\n            var tbody = table.find('tbody');\n\n            tbody.empty();\n\n            if (!data || data.length === 0) {\n                return;\n            }\n\n            var headers = Object.keys(data[0]);\n\n            // Calculate page slice\n            var startIndex = (this.tableCurrentPage - 1) * this.tableRowsPerPage;\n            var endIndex = startIndex + this.tableRowsPerPage;\n            var pageData = data.slice(startIndex, endIndex);\n\n            // Build rows\n            pageData.forEach(function(row) {\n                var tr = $('<tr>');\n                headers.forEach(function(h) {\n                    var val = row[h];\n                    if (val === null || val === undefined) {\n                        val = '';\n                    }\n                    // Truncate long values\n                    var displayVal = String(val);\n                    if (displayVal.length > 100) {\n                        displayVal = displayVal.substring(0, 100) + '...';\n                    }\n                    tr.append($('<td>').attr('title', val).text(displayVal));\n                });\n                tbody.append(tr);\n            });\n\n            // Update pagination info and controls\n            var actualEnd = Math.min(endIndex, data.length);\n            modalBody.find('.block-adeptus-row-count').text(data.length + ' total rows');\n\n            var paginationInfo = modalBody.find('.table-pagination-info');\n            paginationInfo.text((startIndex + 1) + '-' + actualEnd + ' of ' + data.length);\n\n            // Update button states\n            modalBody.find('.table-pagination-prev').prop('disabled', this.tableCurrentPage <= 1);\n            modalBody.find('.table-pagination-next').prop('disabled', this.tableCurrentPage >= this.tableTotalPages);\n\n            // Show/hide pagination based on total pages\n            if (this.tableTotalPages > 1) {\n                modalBody.find('.table-pagination').removeClass('d-none');\n            } else {\n                modalBody.find('.table-pagination').addClass('d-none');\n            }\n        },\n\n        /**\n         * Open report in new tab.\n         *\n         * @param {string} slug The report slug\n         */\n        openReportNewTab: function(slug) {\n            var url = M.cfg.wwwroot + '/report/adeptus_insights/generated_reports.php?slug=' +\n                encodeURIComponent(slug);\n            window.open(url, '_blank');\n        },\n\n\n        /**\n         * Export report.\n         *\n         * @param {string} format\n         */\n        exportReport: function(format) {\n            // TODO: Implement export functionality.\n            Notification.addNotification({\n                message: 'Export to ' + format.toUpperCase() + ' coming soon',\n                type: 'info'\n            });\n        },\n\n        /**\n         * Refresh the block (clears cache and reloads).\n         */\n        refresh: function() {\n            var refreshBtn = this.container.find('.block-adeptus-refresh i');\n            refreshBtn.addClass('fa-spin');\n\n            // Clear all caches for fresh data\n            this.clearAllCaches();\n\n            // Force reload from server\n            this.showLoading();\n            var self = this;\n            this.waitForAuth(function() {\n                self.fetchReports();\n            });\n\n            setTimeout(function() {\n                refreshBtn.removeClass('fa-spin');\n            }, 1000);\n        },\n\n        /**\n         * Clear all caches.\n         */\n        clearAllCaches: function() {\n            // Clear sessionStorage cache\n            try {\n                sessionStorage.removeItem(this.cacheKey);\n            } catch (_e) {\n                // Ignore\n            }\n            // Clear in-memory report data cache\n            this.reportDataCache = {};\n        },\n\n        /**\n         * Setup auto-refresh timer.\n         */\n        setupAutoRefresh: function() {\n            var interval = this.config.autoRefresh;\n            if (!interval || interval === 'never') {\n                return;\n            }\n\n            var ms;\n            switch (interval) {\n                case '5m':\n                    ms = 5 * 60 * 1000;\n                    break;\n                case '15m':\n                    ms = 15 * 60 * 1000;\n                    break;\n                case '30m':\n                    ms = 30 * 60 * 1000;\n                    break;\n                case '1h':\n                    ms = 60 * 60 * 1000;\n                    break;\n                default:\n                    return;\n            }\n\n            var self = this;\n            this.refreshTimer = setInterval(function() {\n                // Only refresh if page is visible.\n                if (!document.hidden) {\n                    self.refresh();\n                }\n            }, ms);\n        },\n\n        /**\n         * Show loading state.\n         */\n        showLoading: function() {\n            this.container.find('.block-adeptus-loading').removeClass('d-none');\n            this.container.find(\n                '.block-adeptus-report-list, .block-adeptus-kpi-grid, ' +\n                '.block-adeptus-tabs-container, .block-adeptus-content'\n            ).addClass('d-none');\n            this.container.find('.block-adeptus-empty, .block-adeptus-error').addClass('d-none');\n        },\n\n        /**\n         * Hide loading state.\n         */\n        hideLoading: function() {\n            this.container.find('.block-adeptus-loading').addClass('d-none');\n        },\n\n        /**\n         * Show empty state.\n         */\n        showEmpty: function() {\n            this.hideLoading();\n            this.container.find('.block-adeptus-empty').removeClass('d-none');\n        },\n\n        /**\n         * Show error state.\n         *\n         * @param {string} message Error message to display\n         */\n        showError: function(message) {\n            this.hideLoading();\n            var errorDiv = this.container.find('.block-adeptus-error');\n            if (message) {\n                errorDiv.find('p').text(message);\n            }\n            errorDiv.removeClass('d-none');\n        },\n\n        /**\n         * Update the timestamp display.\n         */\n        updateTimestamp: function() {\n            if (!this.lastUpdated) {\n                return;\n            }\n\n            var text = this.formatTimeAgo(this.lastUpdated);\n\n            // Handle KPI mode footer (contains both timestamp and refresh)\n            var kpiFooter = this.container.find('.block-adeptus-kpi-footer');\n            if (kpiFooter.length) {\n                kpiFooter.find('.timestamp-text').text(text);\n                kpiFooter.removeClass('d-none');\n                return;\n            }\n\n            // Handle standard timestamp element\n            if (this.config.showTimestamp) {\n                var timestampEl = this.container.find('.block-adeptus-timestamp');\n                timestampEl.find('.timestamp-text').text(text);\n                timestampEl.removeClass('d-none');\n            }\n        },\n\n        /**\n         * Scroll to the top of the report list.\n         */\n        scrollToListTop: function() {\n            var listContainer = this.container.find('.block-adeptus-report-list');\n            if (listContainer.length) {\n                listContainer[0].scrollIntoView({behavior: 'smooth', block: 'start'});\n            }\n        },\n\n        /**\n         * Scroll to the top of the embedded table.\n         */\n        scrollToEmbeddedTableTop: function() {\n            var tableContainer = this.container.find('.block-adeptus-embedded-table-view');\n            if (tableContainer.length) {\n                tableContainer[0].scrollIntoView({behavior: 'smooth', block: 'start'});\n            }\n        },\n\n        /**\n         * Show the embedded loading overlay.\n         */\n        showEmbeddedLoadingOverlay: function() {\n            var overlay = this.container.find('.block-adeptus-embedded-loading-overlay');\n            var content = this.container.find('.block-adeptus-content');\n\n            // Show content area if hidden (to show overlay over it)\n            content.removeClass('d-none');\n\n            // Show overlay with fade\n            overlay.removeClass('d-none').css('opacity', 0).animate({opacity: 1}, 150);\n        },\n\n        /**\n         * Hide the embedded loading overlay.\n         */\n        hideEmbeddedLoadingOverlay: function() {\n            var overlay = this.container.find('.block-adeptus-embedded-loading-overlay');\n            overlay.animate({opacity: 0}, 150, function() {\n                $(this).addClass('d-none');\n            });\n        },\n\n        /**\n         * Toggle searchable dropdown open/closed.\n         *\n         * @param {jQuery} dropdown\n         */\n        toggleSearchableDropdown: function(dropdown) {\n            if (dropdown.hasClass('open')) {\n                this.closeSearchableDropdown(dropdown);\n            } else {\n                this.openSearchableDropdown(dropdown);\n            }\n        },\n\n        /**\n         * Open searchable dropdown.\n         *\n         * @param {jQuery} dropdown\n         */\n        openSearchableDropdown: function(dropdown) {\n            // Close any other open dropdowns first\n            var self = this;\n            this.container.find('.block-adeptus-searchable-dropdown.open').each(function() {\n                if (!$(this).is(dropdown)) {\n                    self.closeSearchableDropdown($(this));\n                }\n            });\n\n            dropdown.addClass('open');\n            dropdown.find('.block-adeptus-searchable-dropdown-toggle').attr('aria-expanded', 'true');\n\n            // Clear search and show all items\n            var input = dropdown.find('.block-adeptus-searchable-dropdown-input');\n            input.val('');\n            dropdown.find('.block-adeptus-searchable-dropdown-item').show().removeClass('focused');\n            dropdown.find('.block-adeptus-searchable-dropdown-empty').addClass('d-none');\n\n            // Focus search input\n            setTimeout(function() {\n                input.focus();\n            }, 50);\n        },\n\n        /**\n         * Close searchable dropdown.\n         *\n         * @param {jQuery} dropdown\n         */\n        closeSearchableDropdown: function(dropdown) {\n            dropdown.removeClass('open');\n            dropdown.find('.block-adeptus-searchable-dropdown-toggle').attr('aria-expanded', 'false');\n            dropdown.find('.block-adeptus-searchable-dropdown-item').removeClass('focused');\n        },\n\n        /**\n         * Filter searchable dropdown items based on search query.\n         *\n         * @param {jQuery} dropdown\n         * @param {string} query\n         */\n        filterSearchableDropdown: function(dropdown, query) {\n            var items = dropdown.find('.block-adeptus-searchable-dropdown-item');\n            var emptyState = dropdown.find('.block-adeptus-searchable-dropdown-empty');\n            var visibleCount = 0;\n\n            items.each(function() {\n                var searchText = $(this).data('search') || '';\n                if (query === '' || searchText.indexOf(query) !== -1) {\n                    $(this).show();\n                    visibleCount++;\n                } else {\n                    $(this).hide();\n                }\n            });\n\n            // Remove focus from hidden items\n            items.filter(':hidden').removeClass('focused');\n\n            // Show/hide empty state\n            if (visibleCount === 0) {\n                emptyState.removeClass('d-none');\n            } else {\n                emptyState.addClass('d-none');\n            }\n        },\n\n        /**\n         * Select an item from the searchable dropdown.\n         *\n         * @param {jQuery} dropdown\n         * @param {string} value\n         * @param {string} text\n         */\n        selectSearchableDropdownItem: function(dropdown, value, text) {\n            // Update display text\n            dropdown.find('.block-adeptus-searchable-dropdown-text').text(text);\n\n            // Mark item as selected\n            dropdown.find('.block-adeptus-searchable-dropdown-item').removeClass('selected');\n            dropdown.find('.block-adeptus-searchable-dropdown-item[data-value=\"' + value + '\"]').addClass('selected');\n\n            // Find the hidden select sibling and trigger change\n            // Works for both category-filter-select and report-selector-select\n            var select = dropdown.siblings('select');\n            if (select.length) {\n                select.val(value).trigger('change');\n            }\n\n            // Close dropdown\n            this.closeSearchableDropdown(dropdown);\n        },\n\n        /**\n         * Scroll a dropdown item into view.\n         *\n         * @param {jQuery} item\n         */\n        scrollDropdownItemIntoView: function(item) {\n            var list = item.closest('.block-adeptus-searchable-dropdown-list');\n            var listHeight = list.height();\n            var itemTop = item.position().top;\n            var itemHeight = item.outerHeight();\n\n            if (itemTop < 0) {\n                list.scrollTop(list.scrollTop() + itemTop);\n            } else if (itemTop + itemHeight > listHeight) {\n                list.scrollTop(list.scrollTop() + (itemTop + itemHeight - listHeight));\n            }\n        },\n\n        /**\n         * Escape HTML special characters.\n         *\n         * @param {string} text\n         * @return {string}\n         */\n        escapeHtml: function(text) {\n            var div = document.createElement('div');\n            div.textContent = text;\n            return div.innerHTML;\n        },\n\n        /**\n         * Format a date as \"X ago\".\n         *\n         * @param {Date} date\n         * @return {string}\n         */\n        formatTimeAgo: function(date) {\n            var seconds = Math.floor((new Date() - date) / 1000);\n\n            if (seconds < 60) {\n                return this.strings.justNow;\n            }\n\n            var minutes = Math.floor(seconds / 60);\n            if (minutes < 60) {\n                return minutes + ' minute' + (minutes !== 1 ? 's' : '') + ' ago';\n            }\n\n            var hours = Math.floor(minutes / 60);\n            if (hours < 24) {\n                return hours + ' hour' + (hours !== 1 ? 's' : '') + ' ago';\n            }\n\n            var days = Math.floor(hours / 24);\n            return days + ' day' + (days !== 1 ? 's' : '') + ' ago';\n        }\n    };\n\n    return {\n        /**\n         * Initialize the block.\n         *\n         * @param {Object} options\n         */\n        init: function(options) {\n            return new BlockController(options);\n        }\n    };\n});\n"],"names":["define","$","Ajax","Notification","Str","ModalFactory","ModalEvents","Templates","Chart","BlockController","options","blockId","blockid","contextId","contextid","config","apiKey","isAdmin","container","reports","lastUpdated","refreshTimer","modal","modalData","modalReport","chartInstance","currentView","listCurrentPage","listItemsPerPage","this","maxLinkItems","listTotalPages","tableCurrentPage","tableRowsPerPage","tableTotalPages","selectedCategory","availableCategories","selectedReportSlug","defaultReport","selectedReportSource","embeddedCurrentView","embeddedTablePage","embeddedTableRowsPerPage","embeddedChartType","embeddedXAxis","embeddedYAxis","backendUrl","cacheKey","cacheTTL","reportDataCache","preloadTimeout","preloadingSlug","tabPaneStates","tabChartInstances","kpiModal","kpiModalChart","kpiModalData","kpiModalDateRange","kpiSnapshotCache","registeredSnapshots","strings","init","prototype","capitalizeWords","str","replace","letter","toUpperCase","self","length","loadStrings","then","bindEvents","loadReports","setupAutoRefresh","catch","get_strings","key","component","errorAuthFailed","errorCouldNotAuth","errorNoAuthToken","errorReportNotFound","errorConnection","errorFailedLoadReport","errorFailedExecuteReport","errorFailedToLoad","errorQueryFailed","exportNoData","exportNotAvailable","exportVerifyError","noReports","noChange","unknown","justNow","loading","showingXOfY","page","of","vsPrevious","minAgo","hourAgo","hoursAgo","dayAgo","daysAgo","lastRun","exportTitle","exportNotOnPlan","ok","on","e","preventDefault","refresh","slug","data","source","handleReportClick","tabPane","target","attr","loadTabContent","format","exportReport","renderCurrentPage","scrollToListTop","val","displayMode","populateReportSelector","renderReports","selectedValue","parts","split","loadEmbeddedReport","stopPropagation","dropdown","closest","toggleSearchableDropdown","query","toLowerCase","trim","filterSearchableDropdown","value","text","find","selectSearchableDropdownItem","items","focused","first","addClass","next","nextAll","removeClass","scrollDropdownItemIntoView","prev","prevAll","trigger","closeSearchableDropdown","document","each","view","switchEmbeddedView","renderEmbeddedTablePage","scrollToEmbeddedTableTop","totalPages","Math","ceil","embeddedData","renderEmbeddedChart","exportEmbeddedReport","pane","switchTabView","tabId","state","tablePage","renderTabTablePage","rowsPerPage","chartType","renderTabChart","xAxis","yAxis","exportTabReport","clearTimeout","setTimeout","preloadReportData","showLoading","cachedData","getFromCache","Date","waitForAuth","fetchReports","cached","sessionStorage","getItem","JSON","parse","timestamp","now","removeItem","_e","saveToCache","setItem","stringify","report","r","ajax","url","M","cfg","wwwroot","method","reportid","name","report_template_id","sesskey","dataType","timeout","done","response","success","results","chartData","chart_data","chart_type","fail","token","window","adeptusAuthData","api_key","headers","reportData","sqlQuery","sql","sql_query","execution_required","executeReportLocally","params","executionResult","localData","callback","showError","promises","reportSource","push","fetchFromApi","when","apply","allReports","i","result","arguments","fetchesBoth","currentSource","reportsArr","forEach","endpoint","baseUrl","mode","populateCategoryFilter","filteredReports","filterReports","renderEmbedded","kpiReports","getSelectedReportsForMode","renderKpi","tabsReports","renderTabs","renderLinks","hideLoading","updateTimestamp","showEmpty","selectedConfig","kpiSelectedReports","tabsSelectedReports","item","enrichedReport","Object","assign","icon","customIcon","categoryMap","categoryLocked","reportCategory","catInfo","category_info","color","category","displayName","values","sort","a","b","localeCompare","select","dropdownList","remove","cat","selected","append","empty","allItemHtml","itemHtml","escapeHtml","selectedText","selectedCat","c","hide","reportName","title","display_name","categoryInfo","categoryLabel","defaultOption","prop","firstReport","firstValue","firstName","selectedReport","selectedName","slice","filter","nameA","report_name","nameB","listContainer","template","paginationContainer","startIndex","endIndex","pageReports","html","$item","categoryName","categoryColor","css","actualEnd","formatShowingText","formatPageText","embeddedReport","embeddedChartInstance","renderEmbeddedContent","showEmbeddedLoadingOverlay","hideEmbeddedLoadingOverlay","message","contentArea","toLocaleTimeString","populateEmbeddedChartControls","keys","numericCols","detectNumericColumns","xAxisSelect","yAxisSelect","h","formatted","table","thead","tbody","headerRow","min","row","tr","displayVal","String","substring","showingText","pageText","canvas","destroy","labels","map","label","labelStr","parseFloat","colors","generateChartColors","datasetConfig","backgroundColor","borderWidth","borderColor","type","datasets","responsive","maintainAspectRatio","plugins","legend","display","position","scales","y","beginAtZero","x","getContext","_error","eligible","performExport","showExportUpgradePrompt","addNotification","gridContainer","maxCards","parseInt","kpiColumns","max","cardMap","wizardReports","aiReports","index","card","$card","defaultIcons","iconClass","loadKpiBatch","cardInfo","loadKpiData","reportIds","id","reportids","reportId","renderKpiValue","cardIndex","retryCount","jqXHR","textStatus","status","saveKpiHistoryToServer","formattedValue","valueCol","includes","reduce","sum","formatKpiValue","toFixed","Number","isInteger","toLocaleString","_label","_rowCount","executionTimeMs","snapshotsEnabled","postSnapshotToBackend","metricValue","baselinePeriod","historyLimit","getHistoryLimitForBaseline","encodeURIComponent","row_count","execution_time_ms","evaluate_alerts","baseline_period","history","trend","currentValue","registerSnapshotSchedule","updateKpiTrendFromBackend","renderKpiSparklineFromBackend","alerts","triggered_count","handleTriggeredAlerts","triggered","scheduleKey","intervalSeconds","kpiHistoryInterval","call","methodname","args","blockinstanceid","reportslug","reportsource","intervalseconds","rowcount","trendContainer","vs_baseline","vs_previous","updateKpiDualTrend","has_previous","direction","percentage","abs","change_percent","changeText","formatPercentage","vsBaseline","hasBaseline","has_baseline","hasPrevious","directionSigns","increase","decrease","baselinePct","baselineIcon","getTrendIcon","baselineSign","previousPct","previousIcon","previousSign","primaryDirection","join","round","formatNumber","num","isNaN","toString","formatTimestamp","date","diffMs","diffMins","floor","diffHours","diffDays","getMonth","getDate","getFullYear","start","end","total","indexOf","current","sparklineData","point","reverse","renderKpiSparklineFromData","triggeredAlerts","reportSlug","alertsConfig","alertsToSend","alert","alertName","alert_name","current_value","actual_value","displayReportName","alertId","alert_id","localConfig","backend_id","severity","thresholdValue","threshold","threshold_value","warningThreshold","warning_value","criticalThreshold","critical_value","is_critical","changeAbs","change_absolute","changePct","report_slug","notify_users","require","sent_count","refreshNotificationArea","$popover","userId","useridto","count","$countContainer","loadKpiSparklineFromServer","updateKpiTrendFromServer","absChange","updateKpiTrend","sparklineContainer","dataPoints","lastValue","trendColor","trendBgColor","chartKey","kpiSparklineCharts","fill","tension","pointRadius","pointHoverRadius","tooltip","enabled","elements","line","borderCapStyle","animation","duration","renderKpiSparkline","tabNav","tabContent","tabTemplate","paneTemplate","tab","firstPane","renderTabContent","updateTabMetaBar","populateTabChartControls","category_name","categoryBadge","category_color","dateStr","updated_at","created_at","toLocaleDateString","header","totalRows","yAxisFormatted","undefined","renderTabTable","maxRows","tableMaxRows","action","clickAction","alertsFeatureEnabled","openKpiModal","openReportModal","openReportNewTab","render","create","types","DEFAULT","body","large","bindModalEvents","getRoot","shown","loadModalReport","hidden","show","exception","bindKpiModalEvents","loadKpiModalData","modalRoot","dateRange","modalContent","renderKpiModal","getKpiModalHistoryLimit","showKpiModalError","error","recorded_at","filteredHistory","filterKpiHistoryByDateRange","renderKpiModalTrends","stats","calculateKpiStats","avg","lastEntry","renderKpiModalChart","cutoffDate","getTime","entry","baselineHtml","previousHtml","formatChartDate","ctx","pointBackgroundColor","pointBorderColor","pointBorderWidth","interaction","intersect","titleColor","bodyColor","padding","displayColors","callbacks","tooltipItems","context","parsed","grid","ticks","maxRotation","minRotation","autoSkip","maxTicksLimit","switchModalView","renderModalChart","exportModalData","renderModalTablePage","modalBody","getBody","renderModalContent","last_executed_at","populateAxisSelectors","renderModalTable","idx","formattedHeader","yAxisOptions","col","isNumeric","every","isFinite","hasNumbers","some","Promise","resolve","reject","contentType","_jqXhr","_textStatus","errorThrown","Error","labelKey","valueKey","valueKeyFormatted","createChartConfig","baseOptions","font","size","weight","top","bottom","baseColors","formatName","captureChartImage","modalChart","querySelector","embeddedChart","tabChart","dataUrl","toDataURL","report_category","chartPromise","chartImage","form","createElement","fields","hasOwnProperty","input","appendChild","submit","removeChild","open","refreshBtn","clearAllCaches","interval","autoRefresh","ms","setInterval","errorDiv","formatTimeAgo","kpiFooter","showTimestamp","timestampEl","scrollIntoView","behavior","block","tableContainer","overlay","animate","opacity","hasClass","openSearchableDropdown","is","focus","emptyState","visibleCount","searchText","siblings","list","listHeight","height","itemTop","itemHeight","outerHeight","scrollTop","div","textContent","innerHTML","seconds","minutes","hours","days"],"mappings":"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"}