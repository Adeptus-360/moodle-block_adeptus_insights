{"version":3,"file":"block.min.js","sources":["../src/block.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Main JavaScript controller for the Adeptus Insights block.\n *\n * @module     block_adeptus_insights/block\n * @copyright  2026 Adeptus 360 <info@adeptus360.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\n    'jquery',\n    'core/ajax',\n    'core/notification',\n    'core/str',\n    'core/modal_factory',\n    'core/modal_events',\n    'core/templates',\n    'core/chartjs'\n], function($, Ajax, Notification, Str, ModalFactory, ModalEvents, Templates, Chart) {\n    'use strict';\n\n    /**\n     * Block controller class.\n     *\n     * @param {Object} options Configuration options\n     */\n    var BlockController = function(options) {\n        this.blockId = options.blockid;\n        this.contextId = options.contextid;\n        this.config = options.config || {};\n        this.apiKey = options.apiKey || '';  // API key passed directly from PHP\n        this.isAdmin = options.isAdmin || false;  // Site admin flag\n        this.container = null;\n        this.reports = [];\n        this.lastUpdated = null;\n        this.refreshTimer = null;\n        this.modal = null;\n        this.modalData = null;      // Current modal report data\n        this.modalReport = null;    // Current modal report metadata\n        this.chartInstance = null;  // Current Chart.js instance\n        this.currentView = 'table'; // Current view mode\n\n        // Pagination state for report list\n        this.listCurrentPage = 1;\n        this.listItemsPerPage = this.config.maxLinkItems || 10;\n        this.listTotalPages = 1;\n\n        // Pagination state for modal table\n        this.tableCurrentPage = 1;\n        this.tableRowsPerPage = 25;\n        this.tableTotalPages = 1;\n\n        // Category filter state\n        this.selectedCategory = '';\n        this.availableCategories = [];\n\n        // Report selector state (for embedded mode)\n        this.selectedReportSlug = this.config.defaultReport || '';\n        this.selectedReportSource = '';\n\n        // Embedded mode state (mirrors modal functionality)\n        this.embeddedCurrentView = 'table';\n        this.embeddedTablePage = 1;\n        this.embeddedTableRowsPerPage = 25;\n        this.embeddedChartType = 'bar';\n        this.embeddedXAxis = '';\n        this.embeddedYAxis = '';\n\n        // Backend API URL - use config value or fall back to default\n        this.backendUrl = this.config.backendUrl || 'https://backend.adeptus360.com/api/v1';\n\n        // Cache settings\n        this.cacheKey = 'adeptus_block_reports_' + this.blockId;\n        this.cacheTTL = 5 * 60 * 1000; // 5 minutes\n        this.reportDataCache = {}; // In-memory cache for executed report data\n        this.preloadTimeout = null;\n        this.preloadingSlug = null;\n\n        // Tabs mode state (per-pane state for view toggle, pagination, chart)\n        this.tabPaneStates = {};\n        this.tabChartInstances = {};\n\n        // KPI Modal state\n        this.kpiModal = null;\n        this.kpiModalChart = null;\n        this.kpiModalData = null;\n        this.kpiModalDateRange = '30d';\n\n        // KPI Snapshot data cache (stores responses from postSnapshotToBackend)\n        this.kpiSnapshotCache = {};\n\n        // Snapshot schedule registration tracking\n        this.registeredSnapshots = {};\n\n        // Language strings (loaded asynchronously)\n        this.strings = {};\n\n        this.init();\n    };\n\n    BlockController.prototype = {\n        /**\n         * Initialize the block.\n         */\n        init: function() {\n            var self = this;\n\n            // Find the block container.\n            this.container = $('[data-blockid=\"' + this.blockId + '\"]');\n            if (!this.container.length) {\n                return;\n            }\n\n            // Load language strings first, then continue initialization.\n            this.loadStrings().then(function() {\n                // Bind event handlers.\n                self.bindEvents();\n\n                // Load initial data.\n                self.loadReports();\n\n                // Setup auto-refresh if configured.\n                self.setupAutoRefresh();\n            });\n        },\n\n        /**\n         * Load language strings for use in JavaScript.\n         *\n         * @return {Promise} Promise that resolves when strings are loaded\n         */\n        loadStrings: function() {\n            var self = this;\n            var stringKeys = [\n                {key: 'js_error_auth_failed', component: 'block_adeptus_insights'},\n                {key: 'js_error_could_not_auth', component: 'block_adeptus_insights'},\n                {key: 'js_error_no_auth_token', component: 'block_adeptus_insights'},\n                {key: 'js_error_report_not_found', component: 'block_adeptus_insights'},\n                {key: 'js_error_connection', component: 'block_adeptus_insights'},\n                {key: 'js_error_failed_load_report', component: 'block_adeptus_insights'},\n                {key: 'js_error_failed_execute_report', component: 'block_adeptus_insights'},\n                {key: 'js_error_failed_to_load', component: 'block_adeptus_insights'},\n                {key: 'js_error_query_failed', component: 'block_adeptus_insights'},\n                {key: 'js_export_no_data', component: 'block_adeptus_insights'},\n                {key: 'js_export_not_available', component: 'block_adeptus_insights'},\n                {key: 'js_export_verify_error', component: 'block_adeptus_insights'},\n                {key: 'js_no_reports', component: 'block_adeptus_insights'},\n                {key: 'js_no_change', component: 'block_adeptus_insights'},\n                {key: 'js_unknown', component: 'block_adeptus_insights'},\n                {key: 'js_just_now', component: 'block_adeptus_insights'},\n                {key: 'loading', component: 'block_adeptus_insights'},\n                {key: 'showingxofy', component: 'block_adeptus_insights'},\n                {key: 'page', component: 'block_adeptus_insights'},\n                {key: 'of', component: 'block_adeptus_insights'},\n                {key: 'lastupdated', component: 'block_adeptus_insights'},\n                {key: 'js_vs_previous', component: 'block_adeptus_insights'},\n                {key: 'js_min_ago', component: 'block_adeptus_insights'},\n                {key: 'js_hour_ago', component: 'block_adeptus_insights'},\n                {key: 'js_hours_ago', component: 'block_adeptus_insights'},\n                {key: 'js_day_ago', component: 'block_adeptus_insights'},\n                {key: 'js_days_ago', component: 'block_adeptus_insights'},\n                {key: 'js_last_run', component: 'block_adeptus_insights'},\n                {key: 'js_export_title', component: 'block_adeptus_insights'},\n                {key: 'js_export_not_on_plan', component: 'block_adeptus_insights'},\n                {key: 'js_ok', component: 'block_adeptus_insights'}\n            ];\n\n            return Str.get_strings(stringKeys).then(function(strings) {\n                self.strings = {\n                    errorAuthFailed: strings[0],\n                    errorCouldNotAuth: strings[1],\n                    errorNoAuthToken: strings[2],\n                    errorReportNotFound: strings[3],\n                    errorConnection: strings[4],\n                    errorFailedLoadReport: strings[5],\n                    errorFailedExecuteReport: strings[6],\n                    errorFailedToLoad: strings[7],\n                    errorQueryFailed: strings[8],\n                    exportNoData: strings[9],\n                    exportNotAvailable: strings[10],\n                    exportVerifyError: strings[11],\n                    noReports: strings[12],\n                    noChange: strings[13],\n                    unknown: strings[14],\n                    justNow: strings[15],\n                    loading: strings[16],\n                    showingXOfY: strings[17],\n                    page: strings[18],\n                    of: strings[19],\n                    lastUpdated: strings[20],\n                    vsPrevious: strings[21],\n                    minAgo: strings[22],\n                    hourAgo: strings[23],\n                    hoursAgo: strings[24],\n                    dayAgo: strings[25],\n                    daysAgo: strings[26],\n                    lastRun: strings[27],\n                    exportTitle: strings[28],\n                    exportNotOnPlan: strings[29],\n                    ok: strings[30]\n                };\n            }).catch(function() {\n                // Fallback to English if string loading fails.\n                self.strings = {\n                    errorAuthFailed: 'Authentication failed',\n                    errorCouldNotAuth: 'Could not authenticate',\n                    errorNoAuthToken: 'No authentication token',\n                    errorReportNotFound: 'Report not found',\n                    errorConnection: 'Connection error',\n                    errorFailedLoadReport: 'Failed to load report',\n                    errorFailedExecuteReport: 'Failed to execute report',\n                    errorFailedToLoad: 'Failed to load',\n                    errorQueryFailed: 'Query execution failed',\n                    exportNoData: 'No data to export',\n                    exportNotAvailable: 'Export not available',\n                    exportVerifyError: 'Unable to verify export eligibility. Please try again.',\n                    noReports: '-- No Reports --',\n                    noChange: 'No change',\n                    unknown: 'Unknown',\n                    justNow: 'Just now',\n                    loading: 'Loading...',\n                    showingXOfY: 'Showing {$a->start}-{$a->end} of {$a->total}',\n                    page: 'Page',\n                    of: 'of',\n                    lastUpdated: 'Last updated',\n                    vsPrevious: '{$a} vs previous',\n                    minAgo: '{$a} min ago',\n                    hourAgo: '{$a} hour ago',\n                    hoursAgo: '{$a} hours ago',\n                    dayAgo: '{$a} day ago',\n                    daysAgo: '{$a} days ago',\n                    lastRun: 'Last run: {$a}',\n                    exportTitle: '{$a} Export',\n                    exportNotOnPlan: '{$a} export is not available on your current plan.',\n                    ok: 'OK'\n                };\n            });\n        },\n\n        /**\n         * Bind event handlers.\n         */\n        bindEvents: function() {\n            var self = this;\n\n            // Refresh button.\n            this.container.on('click', '.block-adeptus-refresh, .block-adeptus-retry', function(e) {\n                e.preventDefault();\n                self.refresh();\n            });\n\n            // Report item click.\n            this.container.on('click', '.block-adeptus-report-item', function(e) {\n                e.preventDefault();\n                var slug = $(this).data('slug');\n                var source = $(this).data('source');\n                self.handleReportClick(slug, source);\n            });\n\n            // Report item keyboard activation (Enter/Space).\n            this.container.on('keydown', '.block-adeptus-report-item', function(e) {\n                if (e.key === 'Enter' || e.key === ' ') {\n                    e.preventDefault();\n                    var slug = $(this).data('slug');\n                    var source = $(this).data('source');\n                    self.handleReportClick(slug, source);\n                }\n            });\n\n            // KPI card click.\n            this.container.on('click', '.block-adeptus-kpi-card', function(e) {\n                e.preventDefault();\n                var slug = $(this).data('slug');\n                var source = $(this).data('source');\n                self.handleReportClick(slug, source);\n            });\n\n            // Tab click.\n            this.container.on('shown.bs.tab', '.block-adeptus-tab-nav a', function(e) {\n                var tabPane = $($(e.target).attr('href'));\n                var slug = tabPane.data('slug');\n                var source = tabPane.data('source');\n                if (!tabPane.data('loaded')) {\n                    self.loadTabContent(tabPane, slug, source);\n                }\n            });\n\n            // Export buttons.\n            this.container.on('click', '.block-adeptus-export', function(e) {\n                e.preventDefault();\n                var format = $(this).data('format');\n                self.exportReport(format);\n            });\n\n            // Pagination - Previous button.\n            this.container.on('click', '.pagination-prev', function(e) {\n                e.preventDefault();\n                if (self.listCurrentPage > 1) {\n                    self.listCurrentPage--;\n                    self.renderCurrentPage();\n                    self.scrollToListTop();\n                }\n            });\n\n            // Pagination - Next button.\n            this.container.on('click', '.pagination-next', function(e) {\n                e.preventDefault();\n                if (self.listCurrentPage < self.listTotalPages) {\n                    self.listCurrentPage++;\n                    self.renderCurrentPage();\n                    self.scrollToListTop();\n                }\n            });\n\n            // Category filter change.\n            this.container.on('change', '.block-adeptus-category-filter-select', function() {\n                self.selectedCategory = $(this).val();\n                self.listCurrentPage = 1; // Reset to first page\n                // For embedded mode, update the report selector based on new category\n                if (self.config.displayMode === 'embedded') {\n                    self.populateReportSelector();\n                } else {\n                    self.renderReports();\n                }\n            });\n\n            // Report selector change (for embedded mode) - hidden select fallback.\n            this.container.on('change', '.block-adeptus-report-selector-select', function() {\n                var selectedValue = $(this).val();\n                if (selectedValue) {\n                    var parts = selectedValue.split('::');\n                    var slug = parts[0];\n                    var source = parts[1] || 'wizard';\n                    self.selectedReportSlug = slug;\n                    self.selectedReportSource = source;\n                    // Reset embedded state\n                    self.embeddedTablePage = 1;\n                    self.embeddedCurrentView = 'table';\n                    self.loadEmbeddedReport(slug, source);\n                }\n            });\n\n            // Searchable dropdown - Toggle open/close.\n            this.container.on('click', '.block-adeptus-searchable-dropdown-toggle', function(e) {\n                e.preventDefault();\n                e.stopPropagation();\n                var dropdown = $(this).closest('.block-adeptus-searchable-dropdown');\n                self.toggleSearchableDropdown(dropdown);\n            });\n\n            // Searchable dropdown - Search input.\n            this.container.on('input', '.block-adeptus-searchable-dropdown-input', function() {\n                var dropdown = $(this).closest('.block-adeptus-searchable-dropdown');\n                var query = $(this).val().toLowerCase().trim();\n                self.filterSearchableDropdown(dropdown, query);\n            });\n\n            // Searchable dropdown - Item selection.\n            this.container.on('click', '.block-adeptus-searchable-dropdown-item', function(e) {\n                e.preventDefault();\n                e.stopPropagation();\n                var dropdown = $(this).closest('.block-adeptus-searchable-dropdown');\n                var value = $(this).data('value');\n                var text = $(this).find('.block-adeptus-dropdown-item-name').text();\n                self.selectSearchableDropdownItem(dropdown, value, text);\n            });\n\n            // Searchable dropdown - Keyboard navigation.\n            this.container.on('keydown', '.block-adeptus-searchable-dropdown-input', function(e) {\n                var dropdown = $(this).closest('.block-adeptus-searchable-dropdown');\n                var items = dropdown.find('.block-adeptus-searchable-dropdown-item:visible');\n                var focused = dropdown.find('.block-adeptus-searchable-dropdown-item.focused');\n\n                if (e.key === 'ArrowDown') {\n                    e.preventDefault();\n                    if (focused.length === 0) {\n                        items.first().addClass('focused');\n                    } else {\n                        var next = focused.nextAll('.block-adeptus-searchable-dropdown-item:visible').first();\n                        if (next.length) {\n                            focused.removeClass('focused');\n                            next.addClass('focused');\n                            self.scrollDropdownItemIntoView(next);\n                        }\n                    }\n                } else if (e.key === 'ArrowUp') {\n                    e.preventDefault();\n                    if (focused.length) {\n                        var prev = focused.prevAll('.block-adeptus-searchable-dropdown-item:visible').first();\n                        if (prev.length) {\n                            focused.removeClass('focused');\n                            prev.addClass('focused');\n                            self.scrollDropdownItemIntoView(prev);\n                        }\n                    }\n                } else if (e.key === 'Enter') {\n                    e.preventDefault();\n                    if (focused.length) {\n                        focused.trigger('click');\n                    } else if (items.length === 1) {\n                        items.first().trigger('click');\n                    }\n                } else if (e.key === 'Escape') {\n                    self.closeSearchableDropdown(dropdown);\n                }\n            });\n\n            // Close dropdown when clicking outside.\n            $(document).on('click', function(e) {\n                if (!$(e.target).closest('.block-adeptus-searchable-dropdown').length) {\n                    self.container.find('.block-adeptus-searchable-dropdown.open').each(function() {\n                        self.closeSearchableDropdown($(this));\n                    });\n                }\n            });\n\n            // Embedded mode - View toggle (Table/Chart).\n            this.container.on('click', '.block-adeptus-embedded-view-toggle-btn', function(e) {\n                e.preventDefault();\n                var view = $(this).data('view');\n                self.switchEmbeddedView(view);\n            });\n\n            // Embedded mode - Table pagination.\n            this.container.on('click', '.block-adeptus-embedded-pagination-prev', function(e) {\n                e.preventDefault();\n                if (self.embeddedTablePage > 1) {\n                    self.embeddedTablePage--;\n                    self.renderEmbeddedTablePage();\n                    self.scrollToEmbeddedTableTop();\n                }\n            });\n\n            this.container.on('click', '.block-adeptus-embedded-pagination-next', function(e) {\n                e.preventDefault();\n                var totalPages = Math.ceil((self.embeddedData || []).length / self.embeddedTableRowsPerPage);\n                if (self.embeddedTablePage < totalPages) {\n                    self.embeddedTablePage++;\n                    self.renderEmbeddedTablePage();\n                    self.scrollToEmbeddedTableTop();\n                }\n            });\n\n            // Embedded mode - Chart type change.\n            this.container.on('change', '.block-adeptus-embedded-chart-type', function() {\n                self.embeddedChartType = $(this).val();\n                self.renderEmbeddedChart();\n            });\n\n            // Embedded mode - X-Axis change.\n            this.container.on('change', '.block-adeptus-embedded-chart-x-axis', function() {\n                self.embeddedXAxis = $(this).val();\n                self.renderEmbeddedChart();\n            });\n\n            // Embedded mode - Y-Axis change.\n            this.container.on('change', '.block-adeptus-embedded-chart-y-axis', function() {\n                self.embeddedYAxis = $(this).val();\n                self.renderEmbeddedChart();\n            });\n\n            // Embedded mode - Export.\n            this.container.on('click', '.block-adeptus-embedded-export', function(e) {\n                e.preventDefault();\n                var format = $(this).data('format');\n                self.exportEmbeddedReport(format);\n            });\n\n            // Tabs mode - View toggle (Table/Chart).\n            this.container.on('click', '.block-adeptus-tab-view-toggle-btn', function(e) {\n                e.preventDefault();\n                var pane = $(this).closest('.block-adeptus-tab-pane');\n                var view = $(this).data('view');\n                self.switchTabView(pane, view);\n            });\n\n            // Tabs mode - Table pagination.\n            this.container.on('click', '.block-adeptus-tab-pagination-prev', function(e) {\n                e.preventDefault();\n                var pane = $(this).closest('.block-adeptus-tab-pane');\n                var tabId = pane.attr('id');\n                var state = self.tabPaneStates[tabId];\n                if (state && state.tablePage > 1) {\n                    state.tablePage--;\n                    self.renderTabTablePage(pane, state);\n                }\n            });\n\n            this.container.on('click', '.block-adeptus-tab-pagination-next', function(e) {\n                e.preventDefault();\n                var pane = $(this).closest('.block-adeptus-tab-pane');\n                var tabId = pane.attr('id');\n                var state = self.tabPaneStates[tabId];\n                if (state) {\n                    var totalPages = Math.ceil(state.data.length / state.rowsPerPage);\n                    if (state.tablePage < totalPages) {\n                        state.tablePage++;\n                        self.renderTabTablePage(pane, state);\n                    }\n                }\n            });\n\n            // Tabs mode - Chart type change.\n            this.container.on('change', '.block-adeptus-tab-chart-type', function() {\n                var pane = $(this).closest('.block-adeptus-tab-pane');\n                var tabId = pane.attr('id');\n                var state = self.tabPaneStates[tabId];\n                if (state) {\n                    state.chartType = $(this).val();\n                    self.renderTabChart(pane, state);\n                }\n            });\n\n            // Tabs mode - X-Axis change.\n            this.container.on('change', '.block-adeptus-tab-chart-x-axis', function() {\n                var pane = $(this).closest('.block-adeptus-tab-pane');\n                var tabId = pane.attr('id');\n                var state = self.tabPaneStates[tabId];\n                if (state) {\n                    state.xAxis = $(this).val();\n                    self.renderTabChart(pane, state);\n                }\n            });\n\n            // Tabs mode - Y-Axis change.\n            this.container.on('change', '.block-adeptus-tab-chart-y-axis', function() {\n                var pane = $(this).closest('.block-adeptus-tab-pane');\n                var tabId = pane.attr('id');\n                var state = self.tabPaneStates[tabId];\n                if (state) {\n                    state.yAxis = $(this).val();\n                    self.renderTabChart(pane, state);\n                }\n            });\n\n            // Tabs mode - Export.\n            this.container.on('click', '.block-adeptus-tab-export', function(e) {\n                e.preventDefault();\n                var pane = $(this).closest('.block-adeptus-tab-pane');\n                var tabId = pane.attr('id');\n                var state = self.tabPaneStates[tabId];\n                var format = $(this).data('format');\n                if (state) {\n                    self.exportTabReport(state, format);\n                }\n            });\n\n            // Preload report data on hover (300ms delay to avoid unnecessary loads).\n            this.container.on('mouseenter', '.block-adeptus-report-item', function() {\n                var slug = $(this).data('slug');\n                var source = $(this).data('source');\n\n                // Clear any pending preload\n                if (self.preloadTimeout) {\n                    clearTimeout(self.preloadTimeout);\n                }\n\n                // Start preload after 300ms hover\n                self.preloadTimeout = setTimeout(function() {\n                    self.preloadReportData(slug, source);\n                }, 300);\n            });\n\n            this.container.on('mouseleave', '.block-adeptus-report-item', function() {\n                // Cancel pending preload if user moves away\n                if (self.preloadTimeout) {\n                    clearTimeout(self.preloadTimeout);\n                    self.preloadTimeout = null;\n                }\n            });\n        },\n\n        /**\n         * Load reports from the server or cache.\n         */\n        loadReports: function() {\n            var self = this;\n\n            this.showLoading();\n\n            // Try to load from cache first\n            var cachedData = this.getFromCache();\n            if (cachedData) {\n                this.reports = cachedData;\n                this.lastUpdated = new Date();\n                this.renderReports();\n                return;\n            }\n\n            // Wait for auth data to be available.\n            this.waitForAuth(function() {\n                self.fetchReports();\n            });\n        },\n\n        /**\n         * Get reports from sessionStorage cache.\n         *\n         * @return {Array|null}\n         */\n        getFromCache: function() {\n            try {\n                var cached = sessionStorage.getItem(this.cacheKey);\n                if (cached) {\n                    var data = JSON.parse(cached);\n                    if (data.timestamp && (Date.now() - data.timestamp) < this.cacheTTL) {\n                        return data.reports;\n                    }\n                    // Cache expired, remove it\n                    sessionStorage.removeItem(this.cacheKey);\n                }\n            } catch (e) {\n                // Ignore storage errors\n            }\n            return null;\n        },\n\n        /**\n         * Save reports to sessionStorage cache.\n         *\n         * @param {Array} reports\n         */\n        saveToCache: function(reports) {\n            try {\n                sessionStorage.setItem(this.cacheKey, JSON.stringify({\n                    timestamp: Date.now(),\n                    reports: reports\n                }));\n            } catch (e) {\n                // Ignore storage errors (quota exceeded, etc.)\n            }\n        },\n\n        /**\n         * Preload report data on hover for faster modal loading.\n         *\n         * @param {string} slug\n         * @param {string} source\n         */\n        preloadReportData: function(slug, source) {\n            var self = this;\n            var cacheKey = slug + '_' + source;\n\n            // Already cached or currently preloading\n            if (this.reportDataCache[cacheKey] || this.preloadingSlug === slug) {\n                return;\n            }\n\n            this.preloadingSlug = slug;\n\n            // Find the report from our cached list\n            var report = this.reports.find(function(r) {\n                return r.slug === slug;\n            });\n\n            if (!report) {\n                return;\n            }\n\n            if (source === 'wizard') {\n                // Preload wizard report\n                $.ajax({\n                    url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/generate_report.php',\n                    method: 'POST',\n                    data: {\n                        reportid: report.name || report.report_template_id,\n                        sesskey: M.cfg.sesskey\n                    },\n                    dataType: 'json',\n                    timeout: 30000\n                }).done(function(response) {\n                    if (response.success) {\n                        self.reportDataCache[cacheKey] = {\n                            report: report,\n                            results: response.results || [],\n                            chartData: response.chart_data,\n                            chartType: response.chart_type\n                        };\n                    }\n                    self.preloadingSlug = null;\n                }).fail(function() {\n                    self.preloadingSlug = null;\n                });\n            } else {\n                // Preload AI report\n                var token = this.apiKey || (window.adeptusAuthData ? window.adeptusAuthData.api_key : null);\n                if (!token) {\n                    return;\n                }\n\n                $.ajax({\n                    url: '' + this.backendUrl + '/ai-reports/' + slug,\n                    method: 'GET',\n                    headers: {\n                        'Authorization': 'Bearer ' + token,\n                        'Accept': 'application/json'\n                    },\n                    timeout: 15000\n                }).done(function(response) {\n                    if (response.success && response.report) {\n                        var reportData = response.report;\n                        var data = response.data || [];\n\n                        // Check if local execution is required (SaaS model)\n                        var sqlQuery = response.sql || (reportData && reportData.sql_query) || (reportData && reportData.sql);\n                        var needsLocalExecution = response.execution_required || ((!data || data.length === 0) && sqlQuery);\n\n                        if (needsLocalExecution && sqlQuery) {\n                            // Execute SQL locally against Moodle database\n                            self.executeReportLocally(sqlQuery, reportData.params || {})\n                                .then(function(executionResult) {\n                                    var localData = executionResult.data || [];\n                                    self.reportDataCache[cacheKey] = {\n                                        report: reportData,\n                                        results: localData,\n                                        chartData: null,\n                                        chartType: null\n                                    };\n                                    self.preloadingSlug = null;\n                                })\n                                .catch(function() {\n                                    self.preloadingSlug = null;\n                                });\n                            return;\n                        }\n\n                        self.reportDataCache[cacheKey] = {\n                            report: reportData,\n                            results: data,\n                            chartData: null,\n                            chartType: null\n                        };\n                    }\n                    self.preloadingSlug = null;\n                }).fail(function() {\n                    self.preloadingSlug = null;\n                });\n            }\n        },\n\n        /**\n         * Wait for authentication data to be available.\n         * Uses API key passed directly from PHP, or falls back to AJAX.\n         *\n         * @param {Function} callback\n         */\n        waitForAuth: function(callback) {\n            var self = this;\n\n            // Use API key passed directly from PHP (preferred - no AJAX needed)\n            if (this.apiKey) {\n                window.adeptusAuthData = window.adeptusAuthData || {};\n                window.adeptusAuthData.api_key = this.apiKey;\n                callback();\n                return;\n            }\n\n            // Fallback: Check if already authenticated via parent plugin\n            if (window.adeptusAuthData && window.adeptusAuthData.api_key) {\n                callback();\n                return;\n            }\n\n            // Last resort: Try to fetch auth via AJAX\n            $.ajax({\n                url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/get_auth_status.php',\n                method: 'GET',\n                dataType: 'json',\n                timeout: 10000\n            }).done(function(response) {\n                if (response && response.success && response.data) {\n                    window.adeptusAuthData = response.data;\n                    callback();\n                } else {\n                    self.showError(self.strings.errorAuthFailed);\n                }\n            }).fail(function() {\n                self.showError(self.strings.errorCouldNotAuth);\n            });\n        },\n\n        /**\n         * Fetch reports from the backend API.\n         */\n        fetchReports: function() {\n            var self = this;\n            var token = this.apiKey || (window.adeptusAuthData ? window.adeptusAuthData.api_key : null);\n\n            if (!token) {\n                this.showError(this.strings.errorNoAuthToken);\n                return;\n            }\n\n            var promises = [];\n            var source = this.config.reportSource || 'all';\n\n            // For 'manual' and 'category' sources, we need to fetch all reports first,\n            // then filter them in filterReports(). Same for 'all'.\n            if (source === 'all' || source === 'wizard' || source === 'manual' || source === 'category') {\n                promises.push(this.fetchFromApi('/wizard-reports', token));\n            }\n\n            if (source === 'all' || source === 'ai' || source === 'manual' || source === 'category') {\n                promises.push(this.fetchFromApi('/ai-reports', token));\n            }\n\n            $.when.apply($, promises).then(function() {\n                var allReports = [];\n\n                for (var i = 0; i < promises.length; i++) {\n                    var result;\n                    if (promises.length === 1) {\n                        result = arguments[0];\n                    } else {\n                        result = arguments[i][0];\n                    }\n\n                    var reports = result.reports || result.data || [];\n                    if (reports && reports.length) {\n                        // Determine report source: for sources that fetch both APIs (all, manual, category),\n                        // the second promise (i === 1) is AI reports.\n                        var fetchesBoth = (source === 'all' || source === 'manual' || source === 'category');\n                        var reportSource = (source === 'ai' || (i === 1 && fetchesBoth)) ? 'ai' : 'wizard';\n                        reports.forEach(function(report) {\n                            report.source = report.source || reportSource;\n                            allReports.push(report);\n                        });\n                    }\n                }\n\n                self.reports = allReports;\n                self.lastUpdated = new Date();\n                self.saveToCache(allReports);\n                self.renderReports();\n            }).fail(function() {\n                self.showError();\n            });\n        },\n\n        /**\n         * Fetch data from the backend API.\n         *\n         * @param {string} endpoint API endpoint\n         * @param {string} token Auth token\n         * @return {Promise}\n         */\n        fetchFromApi: function(endpoint, token) {\n            var baseUrl = '' + this.backendUrl + '';\n\n            return $.ajax({\n                url: baseUrl + endpoint,\n                method: 'GET',\n                headers: {\n                    'Authorization': 'Bearer ' + token,\n                    'Content-Type': 'application/json',\n                    'Accept': 'application/json'\n                },\n                timeout: 15000\n            });\n        },\n\n        /**\n         * Render reports based on display mode.\n         */\n        renderReports: function() {\n            var mode = this.config.displayMode || 'links';\n\n            if (this.reports.length === 0) {\n                this.showEmpty();\n                return;\n            }\n\n            // Extract and populate category filter (only for modes that use it)\n            if (mode === 'embedded' || mode === 'links') {\n                this.populateCategoryFilter();\n            }\n\n            // Filter reports based on selected category (for links/embedded modes)\n            var filteredReports = this.filterReports();\n\n            switch (mode) {\n                case 'embedded':\n                    this.renderEmbedded(filteredReports);\n                    break;\n                case 'kpi':\n                    // For KPI mode, use ALL reports for matching since user explicitly selected them\n                    // (category filter doesn't apply - user chose specific reports)\n                    var kpiReports = this.getSelectedReportsForMode('kpi', this.reports);\n                    this.renderKpi(kpiReports);\n                    break;\n                case 'tabs':\n                    // For Tabs mode, use ALL reports for matching since user explicitly selected them\n                    // (category filter doesn't apply - user chose specific reports)\n                    var tabsReports = this.getSelectedReportsForMode('tabs', this.reports);\n                    this.renderTabs(tabsReports);\n                    break;\n                case 'links':\n                default:\n                    this.renderLinks(filteredReports);\n                    break;\n            }\n\n            this.hideLoading();\n            this.updateTimestamp();\n        },\n\n        /**\n         * Get reports filtered by the selected reports configuration for a specific mode.\n         *\n         * @param {string} mode - 'kpi' or 'tabs'\n         * @param {Array} allReports - All available reports\n         * @return {Array} Filtered reports in configured order\n         */\n        getSelectedReportsForMode: function(mode, allReports) {\n            var selectedConfig = [];\n\n            if (mode === 'kpi' && this.config.kpiSelectedReports && this.config.kpiSelectedReports.length > 0) {\n                selectedConfig = this.config.kpiSelectedReports;\n            } else if (mode === 'tabs' && this.config.tabsSelectedReports && this.config.tabsSelectedReports.length > 0) {\n                selectedConfig = this.config.tabsSelectedReports;\n            }\n\n            // If no specific reports configured, return all reports\n            if (selectedConfig.length === 0) {\n                return allReports;\n            }\n\n            // Filter and order reports according to selection\n            var result = [];\n            selectedConfig.forEach(function(item) {\n                var slug = item.slug || item;\n                var source = item.source || 'wizard';\n                var report = allReports.find(function(r) {\n                    return r.slug === slug && (r.source === source || !item.source);\n                });\n                if (report) {\n                    // Clone report and add custom icon if configured\n                    var enrichedReport = Object.assign({}, report);\n                    if (item.icon) {\n                        enrichedReport.customIcon = item.icon;\n                    }\n                    result.push(enrichedReport);\n                }\n            });\n\n            return result;\n        },\n\n        /**\n         * Extract categories from reports and populate the filter dropdown.\n         */\n        populateCategoryFilter: function() {\n            var self = this;\n            var categoryMap = {};\n            var config = this.config;\n\n            // If category is configured in block settings, pre-select it.\n            // The category filter from config is always applied (locked).\n            var categoryLocked = !!config.reportCategory;\n            if (categoryLocked) {\n                this.selectedCategory = config.reportCategory;\n            }\n\n            // Extract unique categories from reports\n            this.reports.forEach(function(report) {\n                var catInfo = report.category_info;\n                if (catInfo && catInfo.slug) {\n                    categoryMap[catInfo.slug] = {\n                        slug: catInfo.slug,\n                        name: catInfo.name || catInfo.slug,\n                        color: catInfo.color || '#6c757d'\n                    };\n                } else if (report.category) {\n                    categoryMap[report.category] = {\n                        slug: report.category,\n                        name: report.category,\n                        color: '#6c757d'\n                    };\n                }\n            });\n\n            // If category is configured but not found in reports, add it as a fallback.\n            // This ensures the dropdown shows the configured category even if no reports match.\n            if (categoryLocked && !categoryMap[config.reportCategory]) {\n                // Format slug as display name (capitalize, replace dashes/underscores with spaces).\n                var displayName = config.reportCategory\n                    .replace(/[-_]/g, ' ')\n                    .replace(/\\b\\w/g, function(l) { return l.toUpperCase(); });\n                categoryMap[config.reportCategory] = {\n                    slug: config.reportCategory,\n                    name: displayName,\n                    color: '#6c757d'\n                };\n            }\n\n            // Convert to array and sort by name\n            this.availableCategories = Object.values(categoryMap).sort(function(a, b) {\n                return a.name.localeCompare(b.name);\n            });\n\n            // Populate hidden select\n            var select = this.container.find('.block-adeptus-category-filter-select');\n            var dropdown = this.container.find('.block-adeptus-category-dropdown');\n            var dropdownList = dropdown.find('.block-adeptus-searchable-dropdown-list');\n\n            if (select.length) {\n                // Keep the first \"All Categories\" option, remove the rest\n                select.find('option:not(:first)').remove();\n\n                // Add category options to hidden select\n                this.availableCategories.forEach(function(cat) {\n                    var selected = self.selectedCategory === cat.slug ? ' selected' : '';\n                    select.append('<option value=\"' + cat.slug + '\"' + selected + '>' + cat.name + '</option>');\n                });\n            }\n\n            // Populate searchable dropdown list\n            if (dropdownList.length) {\n                dropdownList.empty();\n\n                // Add \"All Categories\" option first\n                var allSelected = !this.selectedCategory ? 'selected' : '';\n                var allItemHtml = '<li class=\"block-adeptus-searchable-dropdown-item ' + allSelected + '\" data-value=\"\" ' +\n                    'data-search=\"all categories\" role=\"option\">' +\n                    '<span class=\"block-adeptus-dropdown-item-name\">All Categories</span>' +\n                    '</li>';\n                dropdownList.append(allItemHtml);\n\n                // Add category options\n                this.availableCategories.forEach(function(cat) {\n                    var isSelected = self.selectedCategory === cat.slug ? 'selected' : '';\n                    var itemHtml = '<li class=\"block-adeptus-searchable-dropdown-item ' + isSelected + '\" data-value=\"' + cat.slug + '\" ' +\n                        'data-search=\"' + cat.name.toLowerCase() + '\" role=\"option\">' +\n                        '<span class=\"block-adeptus-dropdown-item-name\">' + self.escapeHtml(cat.name) + '</span>' +\n                        '<span class=\"block-adeptus-dropdown-item-category\" style=\"background-color: ' + cat.color + '\">' +\n                        '<i class=\"fa fa-circle\" style=\"font-size: 0.5rem;\"></i></span>' +\n                        '</li>';\n                    dropdownList.append(itemHtml);\n                });\n\n                // Update dropdown text to show selected category\n                var selectedText = 'All Categories';\n                if (this.selectedCategory) {\n                    var selectedCat = this.availableCategories.find(function(c) {\n                        return c.slug === self.selectedCategory;\n                    });\n                    if (selectedCat) {\n                        selectedText = selectedCat.name;\n                    }\n                }\n                dropdown.find('.block-adeptus-searchable-dropdown-text').text(selectedText);\n\n                // If category is locked via config, hide the entire category filter\n                if (categoryLocked) {\n                    this.container.find('.block-adeptus-category-filter').hide();\n                }\n            }\n        },\n\n        /**\n         * Populate the report selector dropdown (for embedded mode).\n         * Filters reports based on selected category.\n         */\n        populateReportSelector: function() {\n            var self = this;\n            var select = this.container.find('.block-adeptus-report-selector-select');\n            var dropdown = this.container.find('.block-adeptus-report-selector .block-adeptus-searchable-dropdown');\n            var dropdownList = dropdown.find('.block-adeptus-searchable-dropdown-list');\n\n            if (!select.length) {\n                return;\n            }\n\n            // Get filtered reports based on category\n            var reports = this.filterReports();\n\n            // Clear existing options\n            select.find('option:not(:first)').remove();\n            dropdownList.empty();\n\n            // Add report options to both hidden select and searchable dropdown\n            reports.forEach(function(report) {\n                var reportName = report.name || report.title || report.display_name || report.slug || 'Untitled';\n                var value = report.slug + '::' + report.source;\n                var categoryInfo = report.category_info || {name: 'General', color: '#6c757d'};\n                var categoryLabel = ' [' + categoryInfo.name + ']';\n                var selected = (self.selectedReportSlug === report.slug) ? ' selected' : '';\n\n                // Hidden select option\n                select.append('<option value=\"' + value + '\"' + selected + '>' + reportName + categoryLabel + '</option>');\n\n                // Searchable dropdown item\n                var itemHtml = '<li class=\"block-adeptus-searchable-dropdown-item\" data-value=\"' + value + '\" data-search=\"' +\n                    reportName.toLowerCase() + ' ' + categoryInfo.name.toLowerCase() + '\" role=\"option\">' +\n                    '<span class=\"block-adeptus-dropdown-item-name\">' + self.escapeHtml(reportName) + '</span>' +\n                    '<span class=\"block-adeptus-dropdown-item-category\" style=\"background-color: ' + categoryInfo.color + '\">' +\n                    self.escapeHtml(categoryInfo.name) + '</span>' +\n                    '</li>';\n                dropdownList.append(itemHtml);\n            });\n\n            // If we have a default report configured and it's in the list, select it\n            if (this.selectedReportSlug && !select.val()) {\n                var defaultOption = select.find('option[value^=\"' + this.selectedReportSlug + '::\"]');\n                if (defaultOption.length) {\n                    defaultOption.prop('selected', true);\n                }\n            }\n\n            // If no report selected and we have reports, auto-select the first one\n            if (!select.val() && reports.length > 0) {\n                var firstReport = reports[0];\n                var firstValue = firstReport.slug + '::' + firstReport.source;\n                var firstName = firstReport.name || firstReport.title || firstReport.display_name || firstReport.slug || 'Untitled';\n                select.val(firstValue);\n                this.selectedReportSlug = firstReport.slug;\n                this.selectedReportSource = firstReport.source;\n                // Update searchable dropdown display\n                dropdown.find('.block-adeptus-searchable-dropdown-text').text(firstName);\n                dropdown.find('.block-adeptus-searchable-dropdown-item').removeClass('selected');\n                dropdown.find('.block-adeptus-searchable-dropdown-item[data-value=\"' + firstValue + '\"]').addClass('selected');\n                // Load the first report\n                this.loadEmbeddedReport(firstReport.slug, firstReport.source);\n            } else if (select.val()) {\n                // A report is selected, load it and update display\n                var parts = select.val().split('::');\n                var selectedReport = reports.find(function(r) { return r.slug === parts[0]; });\n                if (selectedReport) {\n                    var selectedName = selectedReport.name || selectedReport.title || selectedReport.display_name || selectedReport.slug || 'Untitled';\n                    dropdown.find('.block-adeptus-searchable-dropdown-text').text(selectedName);\n                    dropdown.find('.block-adeptus-searchable-dropdown-item').removeClass('selected');\n                    dropdown.find('.block-adeptus-searchable-dropdown-item[data-value=\"' + select.val() + '\"]').addClass('selected');\n                }\n                this.loadEmbeddedReport(parts[0], parts[1] || 'wizard');\n            } else {\n                // No reports available\n                dropdown.find('.block-adeptus-searchable-dropdown-text').text(this.strings.noReports);\n                this.showEmpty();\n            }\n        },\n\n        /**\n         * Filter reports based on configuration and selected category.\n         *\n         * @return {Array}\n         */\n        filterReports: function() {\n            var self = this;\n            var reports = this.reports.slice();\n            var config = this.config;\n\n            // Filter by category from block config (always apply if set).\n            if (config.reportCategory) {\n                reports = reports.filter(function(r) {\n                    var catSlug = r.category_info ? r.category_info.slug : (r.category || '');\n                    return catSlug === config.reportCategory;\n                });\n            }\n\n            // Filter by selected category from dropdown (runtime selection, further filters config).\n            if (this.selectedCategory && this.selectedCategory !== config.reportCategory) {\n                reports = reports.filter(function(r) {\n                    var catSlug = r.category_info ? r.category_info.slug : (r.category || '');\n                    return catSlug === self.selectedCategory;\n                });\n            }\n\n            // Sort by name (try multiple possible name fields).\n            reports.sort(function(a, b) {\n                var nameA = a.name || a.title || a.display_name || a.report_name || a.slug || '';\n                var nameB = b.name || b.title || b.display_name || b.report_name || b.slug || '';\n                return nameA.localeCompare(nameB);\n            });\n\n            return reports;\n        },\n\n        /**\n         * Render link list mode with pagination.\n         *\n         * @param {Array} reports\n         */\n        renderLinks: function(reports) {\n            // Store filtered reports for pagination\n            this.filteredReports = reports;\n\n            // Calculate pagination\n            this.listItemsPerPage = this.config.maxLinkItems || 10;\n            this.listTotalPages = Math.ceil(reports.length / this.listItemsPerPage);\n            this.listCurrentPage = 1; // Reset to first page\n\n            // Render the first page\n            this.renderCurrentPage();\n        },\n\n        /**\n         * Render the current page of reports.\n         */\n        renderCurrentPage: function() {\n            var self = this;\n            var reports = this.filteredReports || [];\n            var listContainer = this.container.find('.block-adeptus-report-list');\n            var template = $('#block-adeptus-report-item-template-' + this.blockId);\n            var paginationContainer = this.container.find('.block-adeptus-pagination');\n\n            // Calculate page slice\n            var startIndex = (this.listCurrentPage - 1) * this.listItemsPerPage;\n            var endIndex = startIndex + this.listItemsPerPage;\n            var pageReports = reports.slice(startIndex, endIndex);\n\n            listContainer.empty();\n\n            pageReports.forEach(function(report) {\n                var item = template.html();\n                var $item = $(item);\n\n                $item.attr('data-slug', report.slug);\n                $item.attr('data-source', report.source);\n\n                // Try multiple possible name fields (API may use different field names)\n                var reportName = report.name || report.title || report.display_name || report.report_name || report.slug || 'Untitled Report';\n                $item.find('.block-adeptus-report-item-name').text(reportName);\n\n                // Set category badge with color\n                var categoryName = report.category_info ? report.category_info.name : report.category || 'General';\n                var categoryColor = report.category_info ? report.category_info.color : '#6c757d';\n                $item.find('.block-adeptus-report-item-category')\n                    .text(categoryName)\n                    .css('background-color', categoryColor)\n                    .css('color', '#fff');\n\n                listContainer.append($item);\n            });\n\n            listContainer.removeClass('d-none');\n\n            // Update pagination controls\n            if (this.listTotalPages > 1) {\n                // Use actual page data length for accurate count\n                var actualEnd = startIndex + pageReports.length;\n                paginationContainer.find('.pagination-showing')\n                    .text(this.formatShowingText(startIndex + 1, actualEnd, reports.length));\n                paginationContainer.find('.pagination-pages')\n                    .text(this.formatPageText(this.listCurrentPage, this.listTotalPages));\n\n                // Update button states\n                paginationContainer.find('.pagination-prev').prop('disabled', this.listCurrentPage <= 1);\n                paginationContainer.find('.pagination-next').prop('disabled', this.listCurrentPage >= this.listTotalPages);\n\n                paginationContainer.removeClass('d-none');\n            } else {\n                paginationContainer.addClass('d-none');\n            }\n        },\n\n        /**\n         * Render embedded report mode.\n         *\n         * @param {Array} reports\n         */\n        renderEmbedded: function(reports) {\n            // Initialize embedded report state\n            this.embeddedReport = null;\n            this.embeddedData = null;\n            this.embeddedChartInstance = null;\n\n            // Populate the report selector dropdown\n            // This will also auto-load the first/default report\n            this.populateReportSelector();\n\n            // Hide loading state if no reports\n            if (this.reports.length === 0) {\n                this.showEmpty();\n            }\n        },\n\n        /**\n         * Load report data for embedded display.\n         *\n         * @param {string} slug\n         * @param {string} source\n         */\n        loadEmbeddedReport: function(slug, source) {\n            var self = this;\n            var cacheKey = slug + '_' + source;\n\n            // Check cache first for instant loading (no overlay needed)\n            if (this.reportDataCache[cacheKey]) {\n                var cached = this.reportDataCache[cacheKey];\n                this.embeddedData = cached.results;\n                this.renderEmbeddedContent(cached.report, cached.results);\n                return;\n            }\n\n            // Show loading overlay for non-cached requests\n            this.showEmbeddedLoadingOverlay();\n\n            // Find the report from our cached list\n            var report = this.reports.find(function(r) {\n                return r.slug === slug;\n            });\n\n            if (!report) {\n                this.hideEmbeddedLoadingOverlay();\n                this.showError(this.strings.errorReportNotFound);\n                return;\n            }\n\n            // For wizard reports, execute locally via generate_report.php\n            if (source === 'wizard') {\n                $.ajax({\n                    url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/generate_report.php',\n                    method: 'POST',\n                    data: {\n                        reportid: report.name || report.report_template_id,\n                        sesskey: M.cfg.sesskey\n                    },\n                    dataType: 'json',\n                    timeout: 30000\n                }).done(function(response) {\n                    self.hideEmbeddedLoadingOverlay();\n                    if (response.success) {\n                        // Cache the result\n                        self.reportDataCache[cacheKey] = {\n                            report: report,\n                            results: response.results || [],\n                            chartData: response.chart_data,\n                            chartType: response.chart_type\n                        };\n                        self.embeddedData = response.results || [];\n                        self.renderEmbeddedContent(report, response.results || []);\n                    } else {\n                        self.showError(response.message || self.strings.errorFailedLoadReport);\n                    }\n                }).fail(function() {\n                    self.hideEmbeddedLoadingOverlay();\n                    self.showError(self.strings.errorConnection);\n                });\n            } else {\n                // AI reports - fetch from backend API\n                var token = this.apiKey || (window.adeptusAuthData ? window.adeptusAuthData.api_key : null);\n\n                if (!token) {\n                    this.hideEmbeddedLoadingOverlay();\n                    this.showError(this.strings.errorNoAuthToken);\n                    return;\n                }\n\n                $.ajax({\n                    url: '' + this.backendUrl + '/ai-reports/' + slug,\n                    method: 'GET',\n                    headers: {\n                        'Authorization': 'Bearer ' + token,\n                        'Accept': 'application/json'\n                    },\n                    timeout: 15000\n                }).done(function(response) {\n                    if (response.success && response.report) {\n                        var reportData = response.report;\n                        var data = response.data || [];\n\n                        // Check if local execution is required (SaaS model)\n                        var sqlQuery = response.sql || (reportData && reportData.sql_query) || (reportData && reportData.sql);\n                        var needsLocalExecution = response.execution_required || ((!data || data.length === 0) && sqlQuery);\n\n                        if (needsLocalExecution && sqlQuery) {\n                            // Execute SQL locally against Moodle database\n                            self.executeReportLocally(sqlQuery, reportData.params || {})\n                                .then(function(executionResult) {\n                                    self.hideEmbeddedLoadingOverlay();\n                                    var localData = executionResult.data || [];\n                                    self.reportDataCache[cacheKey] = {\n                                        report: reportData,\n                                        results: localData,\n                                        chartData: null,\n                                        chartType: null\n                                    };\n                                    self.embeddedData = localData;\n                                    self.renderEmbeddedContent(reportData, localData);\n                                })\n                                .catch(function(error) {\n                                    self.hideEmbeddedLoadingOverlay();\n                                    self.showError(self.strings.errorFailedExecuteReport);\n                                });\n                            return;\n                        }\n\n                        self.hideEmbeddedLoadingOverlay();\n                        // Cache the result\n                        self.reportDataCache[cacheKey] = {\n                            report: reportData,\n                            results: data,\n                            chartData: null,\n                            chartType: null\n                        };\n                        self.embeddedData = data;\n                        self.renderEmbeddedContent(reportData, data);\n                    } else {\n                        self.hideEmbeddedLoadingOverlay();\n                        self.showError(self.strings.errorFailedLoadReport);\n                    }\n                }).fail(function() {\n                    self.hideEmbeddedLoadingOverlay();\n                    self.showError(self.strings.errorConnection);\n                });\n            }\n        },\n\n        /**\n         * Render embedded content with report data.\n         *\n         * @param {Object} report\n         * @param {Array} data\n         */\n        renderEmbeddedContent: function(report, data) {\n            var contentArea = this.container.find('.block-adeptus-content');\n\n            if (!data || data.length === 0) {\n                this.showEmpty();\n                return;\n            }\n\n            // Store data for later use\n            this.embeddedReport = report;\n            this.embeddedData = data;\n\n            // Update meta bar\n            var category = report.category_info || {name: 'General', color: '#6c757d'};\n            this.container.find('.block-adeptus-report-category')\n                .text(category.name)\n                .css('background-color', category.color)\n                .css('color', '#fff');\n            this.container.find('.block-adeptus-row-count-num').text(data.length);\n            this.container.find('.report-date').text(this.strings.lastUpdated + ': ' + new Date().toLocaleTimeString());\n\n            // Populate chart axis selectors\n            this.populateEmbeddedChartControls(data);\n\n            // Reset to table view\n            this.embeddedCurrentView = 'table';\n            this.embeddedTablePage = 1;\n            this.container.find('.block-adeptus-embedded-view-toggle-btn').removeClass('active');\n            this.container.find('.block-adeptus-embedded-view-toggle-btn[data-view=\"table\"]').addClass('active');\n            this.container.find('.block-adeptus-embedded-table-view').removeClass('d-none');\n            this.container.find('.block-adeptus-embedded-chart-view').addClass('d-none');\n\n            // Render table with pagination\n            this.renderEmbeddedTablePage();\n\n            contentArea.removeClass('d-none');\n            this.hideLoading();\n            this.updateTimestamp();\n        },\n\n        /**\n         * Switch between table and chart views in embedded mode.\n         *\n         * @param {string} view - 'table' or 'chart'\n         */\n        switchEmbeddedView: function(view) {\n            this.embeddedCurrentView = view;\n\n            // Update toggle buttons\n            this.container.find('.block-adeptus-embedded-view-toggle-btn').removeClass('active');\n            this.container.find('.block-adeptus-embedded-view-toggle-btn[data-view=\"' + view + '\"]').addClass('active');\n\n            // Show/hide views\n            if (view === 'table') {\n                this.container.find('.block-adeptus-embedded-table-view').removeClass('d-none');\n                this.container.find('.block-adeptus-embedded-chart-view').addClass('d-none');\n            } else {\n                this.container.find('.block-adeptus-embedded-table-view').addClass('d-none');\n                this.container.find('.block-adeptus-embedded-chart-view').removeClass('d-none');\n                // Render chart when switching to chart view\n                this.renderEmbeddedChart();\n            }\n        },\n\n        /**\n         * Populate chart control dropdowns for embedded mode.\n         *\n         * @param {Array} data\n         */\n        populateEmbeddedChartControls: function(data) {\n            if (!data || data.length === 0) return;\n\n            var headers = Object.keys(data[0]);\n            var numericCols = this.detectNumericColumns(data, headers);\n\n            var xAxisSelect = this.container.find('.block-adeptus-embedded-chart-x-axis');\n            var yAxisSelect = this.container.find('.block-adeptus-embedded-chart-y-axis');\n\n            xAxisSelect.empty();\n            yAxisSelect.empty();\n\n            // Populate X-axis (all columns)\n            headers.forEach(function(h) {\n                var formatted = h.replace(/_/g, ' ').replace(/\\b\\w/g, function(l) { return l.toUpperCase(); });\n                xAxisSelect.append('<option value=\"' + h + '\">' + formatted + '</option>');\n            });\n\n            // Populate Y-axis (prefer numeric columns)\n            var yOptions = numericCols.length > 0 ? numericCols : headers;\n            yOptions.forEach(function(h) {\n                var formatted = h.replace(/_/g, ' ').replace(/\\b\\w/g, function(l) { return l.toUpperCase(); });\n                yAxisSelect.append('<option value=\"' + h + '\">' + formatted + '</option>');\n            });\n\n            // Set defaults\n            this.embeddedXAxis = headers[0];\n            this.embeddedYAxis = numericCols.length > 0 ? numericCols[numericCols.length - 1] : headers[headers.length - 1];\n\n            xAxisSelect.val(this.embeddedXAxis);\n            yAxisSelect.val(this.embeddedYAxis);\n        },\n\n        /**\n         * Render current page of table in embedded mode.\n         */\n        renderEmbeddedTablePage: function() {\n            var data = this.embeddedData || [];\n            var table = this.container.find('.block-adeptus-embedded-table');\n            var thead = table.find('thead');\n            var tbody = table.find('tbody');\n\n            thead.empty();\n            tbody.empty();\n\n            if (data.length === 0) {\n                return;\n            }\n\n            // Build headers\n            var headers = Object.keys(data[0]);\n            var headerRow = $('<tr>');\n            headers.forEach(function(h) {\n                var formatted = h.replace(/_/g, ' ').replace(/\\b\\w/g, function(l) { return l.toUpperCase(); });\n                headerRow.append($('<th>').text(formatted));\n            });\n            thead.append(headerRow);\n\n            // Calculate pagination\n            var totalPages = Math.ceil(data.length / this.embeddedTableRowsPerPage);\n            var startIndex = (this.embeddedTablePage - 1) * this.embeddedTableRowsPerPage;\n            var endIndex = Math.min(startIndex + this.embeddedTableRowsPerPage, data.length);\n            var pageData = data.slice(startIndex, endIndex);\n\n            // Build rows\n            pageData.forEach(function(row) {\n                var tr = $('<tr>');\n                headers.forEach(function(h) {\n                    var val = row[h];\n                    if (val === null || val === undefined) val = '';\n                    var displayVal = String(val);\n                    if (displayVal.length > 50) {\n                        displayVal = displayVal.substring(0, 50) + '...';\n                    }\n                    tr.append($('<td>').attr('title', val).text(displayVal));\n                });\n                tbody.append(tr);\n            });\n\n            // Update pagination info\n            this.container.find('.block-adeptus-row-count').text(this.formatShowingText(startIndex + 1, endIndex, data.length));\n            this.container.find('.block-adeptus-embedded-pagination-info').text(this.formatPageText(this.embeddedTablePage, totalPages));\n\n            // Update button states\n            this.container.find('.block-adeptus-embedded-pagination-prev').prop('disabled', this.embeddedTablePage <= 1);\n            this.container.find('.block-adeptus-embedded-pagination-next').prop('disabled', this.embeddedTablePage >= totalPages);\n        },\n\n        /**\n         * Render chart in embedded mode with current settings.\n         */\n        renderEmbeddedChart: function() {\n            var data = this.embeddedData || [];\n            var canvas = this.container.find('.block-adeptus-embedded-chart')[0];\n\n            if (!canvas || data.length === 0) {\n                return;\n            }\n\n            // Destroy existing chart\n            if (this.embeddedChartInstance) {\n                this.embeddedChartInstance.destroy();\n                this.embeddedChartInstance = null;\n            }\n\n            var chartType = this.embeddedChartType || 'bar';\n            var xAxis = this.embeddedXAxis || Object.keys(data[0])[0];\n            var yAxis = this.embeddedYAxis || Object.keys(data[0])[1];\n\n            // Prepare chart data (limit to 30 items)\n            var chartData = data.slice(0, 30);\n            var labels = chartData.map(function(row) {\n                var label = row[xAxis];\n                if (label === null || label === undefined) return this.strings.unknown;\n                var labelStr = String(label);\n                return labelStr.length > 20 ? labelStr.substring(0, 20) + '...' : labelStr;\n            });\n            var values = chartData.map(function(row) {\n                return parseFloat(row[yAxis]) || 0;\n            });\n\n            // Generate colors\n            var colors = this.generateChartColors(values.length, chartType);\n\n            // Build dataset config\n            var datasetConfig = {\n                label: yAxis.replace(/_/g, ' ').replace(/\\b\\w/g, function(l) { return l.toUpperCase(); }),\n                data: values\n            };\n\n            if (chartType === 'pie' || chartType === 'doughnut') {\n                datasetConfig.backgroundColor = colors;\n                datasetConfig.borderWidth = 1;\n            } else {\n                datasetConfig.backgroundColor = colors[0];\n                datasetConfig.borderColor = colors[0].replace('0.7', '1');\n                datasetConfig.borderWidth = 1;\n            }\n\n            // Chart config\n            var config = {\n                type: chartType,\n                data: {\n                    labels: labels,\n                    datasets: [datasetConfig]\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    plugins: {\n                        legend: {\n                            display: chartType === 'pie' || chartType === 'doughnut',\n                            position: 'right'\n                        }\n                    }\n                }\n            };\n\n            // Add scales for bar/line charts\n            if (chartType === 'bar' || chartType === 'line') {\n                config.options.scales = {\n                    y: { beginAtZero: true },\n                    x: { display: data.length <= 15 }\n                };\n            }\n\n            try {\n                this.embeddedChartInstance = new Chart(canvas.getContext('2d'), config);\n            } catch (error) {\n                this.container.find('.block-adeptus-embedded-chart-container').html(\n                    '<div class=\"alert alert-warning text-center\"><i class=\"fa fa-exclamation-circle\"></i> Could not render chart</div>'\n                );\n            }\n        },\n\n        /**\n         * Export embedded report data using the main plugin's export system.\n         *\n         * @param {string} format - Export format (pdf, csv, json)\n         */\n        exportEmbeddedReport: function(format) {\n            var self = this;\n            var data = this.embeddedData || [];\n            var report = this.embeddedReport || {};\n\n            if (data.length === 0) {\n                Notification.addNotification({\n                    message: self.strings.exportNoData,\n                    type: 'warning'\n                });\n                return;\n            }\n\n            // Check export eligibility via main plugin's AJAX endpoint\n            $.ajax({\n                url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/check_export_eligibility.php',\n                method: 'POST',\n                data: {\n                    format: format,\n                    sesskey: M.cfg.sesskey\n                },\n                dataType: 'json'\n            }).done(function(response) {\n                if (!response.success || !response.eligible) {\n                    self.showExportUpgradePrompt(format, response.message || self.strings.exportNotAvailable);\n                    return;\n                }\n\n                // Eligible - proceed with export\n                self.performExport(format, report, data);\n            }).fail(function() {\n                Notification.addNotification({\n                    message: self.strings.exportVerifyError,\n                    type: 'error'\n                });\n            });\n        },\n\n        /**\n         * Render KPI cards mode.\n         *\n         * @param {Array} reports\n         */\n        renderKpi: function(reports) {\n            var self = this;\n            var gridContainer = this.container.find('.block-adeptus-kpi-grid');\n            var template = $('#block-adeptus-kpi-card-template-' + this.blockId);\n            var maxCards = parseInt(this.config.kpiColumns, 10) || 2;\n            maxCards = Math.max(1, Math.min(4, maxCards)); // Clamp between 1-4\n\n            gridContainer.empty();\n\n            var kpiReports = reports.slice(0, maxCards);\n            var cardMap = {}; // Map slug to card element\n            var wizardReports = [];\n            var aiReports = [];\n\n            // Create all cards first\n            kpiReports.forEach(function(report, index) {\n                var card = template.html();\n                var $card = $(card);\n\n                var reportName = report.name || report.title || report.display_name || report.slug || 'Metric';\n                $card.attr('data-slug', report.slug);\n                $card.attr('data-source', report.source);\n                $card.find('.block-adeptus-kpi-card-label').text(reportName);\n                $card.find('.block-adeptus-kpi-card-value').html('<i class=\"fa fa-spinner fa-spin\"></i>');\n                $card.find('.block-adeptus-kpi-card-trend').addClass('d-none');\n                $card.find('.block-adeptus-kpi-card-sparkline').addClass('d-none');\n\n                // Set icon - use custom icon if configured, otherwise default based on index\n                var defaultIcons = ['fa-users', 'fa-graduation-cap', 'fa-clock-o', 'fa-check-circle'];\n                var iconClass = report.customIcon || defaultIcons[index % defaultIcons.length];\n                $card.find('.block-adeptus-kpi-card-icon i').removeClass('fa-bar-chart').addClass(iconClass);\n\n                gridContainer.append($card);\n\n                // Store reference for batch update\n                cardMap[report.slug] = {\n                    $card: $card,\n                    report: report,\n                    index: index\n                };\n\n                // Separate wizard and AI reports\n                if (report.source === 'wizard') {\n                    wizardReports.push(report);\n                } else {\n                    aiReports.push(report);\n                }\n            });\n\n            gridContainer.removeClass('d-none');\n\n            // Use batch loading for wizard reports (single request for all)\n            if (wizardReports.length > 0) {\n                this.loadKpiBatch(wizardReports, cardMap);\n            }\n\n            // Load AI reports individually (they use external API)\n            aiReports.forEach(function(report, index) {\n                var cardInfo = cardMap[report.slug];\n                setTimeout(function() {\n                    self.loadKpiData(report, cardInfo.$card, cardInfo.index);\n                }, index * 100);\n            });\n        },\n\n        /**\n         * Load multiple KPI cards in a single batch request.\n         *\n         * @param {Array} reports Wizard reports to load\n         * @param {Object} cardMap Map of slug to card info\n         */\n        loadKpiBatch: function(reports, cardMap) {\n            var self = this;\n            var startTime = performance.now();\n\n            // Get report IDs (names) for batch request\n            var reportIds = reports.map(function(r) {\n                return r.report_template_id || r.id || r.name || r.slug;\n            });\n\n            $.ajax({\n                url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/batch_kpi_data.php',\n                method: 'POST',\n                data: {\n                    reportids: JSON.stringify(reportIds),\n                    sesskey: M.cfg.sesskey\n                },\n                dataType: 'json',\n                timeout: 30000\n            }).done(function(response) {\n                if (response.success && response.reports) {\n                    // Update each card with its data\n                    reports.forEach(function(report) {\n                        var reportId = report.report_template_id || report.id || report.name || report.slug;\n                        var reportData = response.reports[reportId];\n                        var cardInfo = cardMap[report.slug];\n\n                        if (!cardInfo) {\n                            return;\n                        }\n\n                        var $card = cardInfo.$card;\n                        var cacheKey = report.slug + '_' + report.source;\n\n                        if (reportData && reportData.success) {\n                            // Cache the results\n                            self.reportDataCache[cacheKey] = {\n                                report: report,\n                                results: reportData.results || []\n                            };\n\n                            // Render the KPI value\n                            self.renderKpiValue($card, reportData.results || []);\n                        } else {\n                            $card.find('.block-adeptus-kpi-card-value').text('--');\n                            $card.find('.block-adeptus-kpi-card-trend').addClass('d-none');\n                        }\n                    });\n                } else {\n                    // Batch failed, fall back to individual loading\n                    reports.forEach(function(report, index) {\n                        var cardInfo = cardMap[report.slug];\n                        setTimeout(function() {\n                            self.loadKpiData(report, cardInfo.$card, cardInfo.index);\n                        }, index * 100);\n                    });\n                }\n            }).fail(function() {\n                // Fall back to individual loading\n                reports.forEach(function(report, index) {\n                    var cardInfo = cardMap[report.slug];\n                    setTimeout(function() {\n                        self.loadKpiData(report, cardInfo.$card, cardInfo.index);\n                    }, index * 100);\n                });\n            });\n        },\n\n        /**\n         * Load KPI data for a single card.\n         *\n         * @param {Object} report\n         * @param {jQuery} $card\n         * @param {number} cardIndex Card index for logging\n         * @param {number} retryCount Current retry attempt (optional)\n         */\n        loadKpiData: function(report, $card, cardIndex, retryCount) {\n            var self = this;\n            var cacheKey = report.slug + '_' + report.source;\n            retryCount = retryCount || 0;\n            var maxRetries = 2;\n            var startTime = performance.now();\n\n            // Check cache first\n            if (this.reportDataCache[cacheKey]) {\n                var cached = this.reportDataCache[cacheKey];\n                this.renderKpiValue($card, cached.results);\n                return;\n            }\n\n            // Get the report ID - try multiple possible fields\n            var reportId = report.report_template_id || report.id || report.name || report.slug;\n\n            // Load data based on source\n            if (report.source === 'wizard') {\n                $.ajax({\n                    url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/generate_report.php',\n                    method: 'POST',\n                    data: {\n                        reportid: reportId,\n                        sesskey: M.cfg.sesskey\n                    },\n                    dataType: 'json',\n                    timeout: 30000\n                }).done(function(response) {\n                    if (response.success) {\n                        self.reportDataCache[cacheKey] = {\n                            report: report,\n                            results: response.results || []\n                        };\n                        self.renderKpiValue($card, response.results || []);\n                    } else {\n                        $card.find('.block-adeptus-kpi-card-value').text('--');\n                        $card.find('.block-adeptus-kpi-card-trend').addClass('d-none');\n                    }\n                }).fail(function(jqXHR, textStatus) {\n                    // Retry on timeout or server error\n                    if (retryCount < maxRetries && (textStatus === 'timeout' || jqXHR.status >= 500)) {\n                        setTimeout(function() {\n                            self.loadKpiData(report, $card, cardIndex, retryCount + 1);\n                        }, 1000 * (retryCount + 1));\n                    } else {\n                        $card.find('.block-adeptus-kpi-card-value').text('--');\n                        $card.find('.block-adeptus-kpi-card-trend').addClass('d-none');\n                    }\n                });\n            } else {\n                // AI reports\n                var token = this.apiKey || (window.adeptusAuthData ? window.adeptusAuthData.api_key : null);\n                if (!token) {\n                    $card.find('.block-adeptus-kpi-card-value').text('--');\n                    $card.find('.block-adeptus-kpi-card-trend').addClass('d-none');\n                    return;\n                }\n\n                $.ajax({\n                    url: '' + this.backendUrl + '/ai-reports/' + report.slug,\n                    method: 'GET',\n                    headers: {\n                        'Authorization': 'Bearer ' + token,\n                        'Accept': 'application/json'\n                    },\n                    timeout: 30000\n                }).done(function(response) {\n                    if (response.success) {\n                        var reportData = response.report || report;\n                        var data = response.data || [];\n\n                        // Check if local execution is required (SaaS model)\n                        var sqlQuery = response.sql || (reportData && reportData.sql_query) || (reportData && reportData.sql);\n                        var needsLocalExecution = response.execution_required || ((!data || data.length === 0) && sqlQuery);\n\n                        if (needsLocalExecution && sqlQuery) {\n                            // Execute SQL locally against Moodle database\n                            self.executeReportLocally(sqlQuery, reportData.params || {})\n                                .then(function(executionResult) {\n                                    var localData = executionResult.data || [];\n                                    self.reportDataCache[cacheKey] = {\n                                        report: reportData,\n                                        results: localData\n                                    };\n                                    self.renderKpiValue($card, localData);\n                                })\n                                .catch(function(error) {\n                                    $card.find('.block-adeptus-kpi-card-value').text('--');\n                                    $card.find('.block-adeptus-kpi-card-trend').addClass('d-none');\n                                });\n                            return;\n                        }\n\n                        if (data && data.length > 0) {\n                            self.reportDataCache[cacheKey] = {\n                                report: reportData,\n                                results: data\n                            };\n                            self.renderKpiValue($card, data);\n                        } else {\n                            $card.find('.block-adeptus-kpi-card-value').text('--');\n                            $card.find('.block-adeptus-kpi-card-trend').addClass('d-none');\n                        }\n                    } else {\n                        $card.find('.block-adeptus-kpi-card-value').text('--');\n                        $card.find('.block-adeptus-kpi-card-trend').addClass('d-none');\n                    }\n                }).fail(function(jqXHR, textStatus) {\n                    // Retry on timeout or server error\n                    if (retryCount < maxRetries && (textStatus === 'timeout' || jqXHR.status >= 500)) {\n                        setTimeout(function() {\n                            self.loadKpiData(report, $card, cardIndex, retryCount + 1);\n                        }, 1000 * (retryCount + 1));\n                    } else {\n                        $card.find('.block-adeptus-kpi-card-value').text('--');\n                        $card.find('.block-adeptus-kpi-card-trend').addClass('d-none');\n                    }\n                });\n            }\n        },\n\n        /**\n         * Render KPI value on card with trend and sparkline.\n         *\n         * @param {jQuery} $card\n         * @param {Array} data\n         */\n        renderKpiValue: function($card, data) {\n            var slug = $card.data('slug');\n            var source = $card.data('source') || 'wizard';\n            var label = $card.find('.block-adeptus-kpi-card-label').text() || '';\n\n            if (!data || data.length === 0) {\n                $card.find('.block-adeptus-kpi-card-value').text('0');\n                // Save zero value and update trend from server\n                this.saveKpiHistoryToServer($card, slug, 0, source, label, 0);\n                return;\n            }\n\n            // Find numeric column for KPI value\n            var headers = Object.keys(data[0]);\n            var numericCols = this.detectNumericColumns(data, headers);\n\n            var value;\n            var formattedValue;\n\n            if (numericCols.length > 0) {\n                // Use sum or count of the last numeric column\n                var valueCol = numericCols[numericCols.length - 1];\n\n                // If it's a count/total column, sum all values\n                if (valueCol.toLowerCase().includes('count') ||\n                    valueCol.toLowerCase().includes('total') ||\n                    data.length === 1) {\n                    value = data.reduce(function(sum, row) {\n                        return sum + (parseFloat(row[valueCol]) || 0);\n                    }, 0);\n                } else {\n                    // Otherwise show row count\n                    value = data.length;\n                }\n            } else {\n                // No numeric columns, show row count\n                value = data.length;\n            }\n\n            // Format the value nicely\n            formattedValue = this.formatKpiValue(value);\n\n            $card.find('.block-adeptus-kpi-card-value').text(formattedValue);\n\n            // Save to server and update trend/sparkline from response\n            this.saveKpiHistoryToServer($card, slug, value, source, label, data.length);\n        },\n\n        /**\n         * Format a KPI value for display.\n         *\n         * @param {number} value\n         * @return {string}\n         */\n        formatKpiValue: function(value) {\n            if (value >= 1000000) {\n                return (value / 1000000).toFixed(1) + 'M';\n            } else if (value >= 1000) {\n                return (value / 1000).toFixed(1) + 'K';\n            } else if (Number.isInteger(value)) {\n                return value.toLocaleString();\n            } else {\n                return value.toFixed(1);\n            }\n        },\n\n        /**\n         * Save KPI snapshot to backend and update trend/sparkline.\n         * This is an enterprise feature - requires snapshots permission.\n         *\n         * @param {jQuery} $card\n         * @param {string} slug\n         * @param {number} value\n         * @param {string} source Report source (wizard/ai)\n         * @param {string} label Metric label\n         * @param {number} rowCount Number of data rows\n         * @param {number} executionTimeMs Execution time in milliseconds (optional)\n         */\n        saveKpiHistoryToServer: function($card, slug, value, source, label, rowCount, executionTimeMs) {\n            var self = this;\n\n            // Check if snapshots feature is enabled (enterprise feature)\n            if (!this.config.snapshotsEnabled) {\n                // Feature not enabled - hide trend and sparkline\n                $card.find('.block-adeptus-kpi-card-trend').addClass('d-none');\n                $card.find('.block-adeptus-kpi-card-sparkline').addClass('d-none');\n                return;\n            }\n\n            // For AI reports, use the backend snapshots API\n            if (source === 'ai') {\n                this.postSnapshotToBackend($card, slug, value, executionTimeMs || 0);\n                return;\n            }\n\n            // For wizard reports, also use backend API\n            this.postSnapshotToBackend($card, slug, value, executionTimeMs || 0);\n        },\n\n        /**\n         * Post snapshot to backend API and update trend/sparkline from response.\n         *\n         * @param {jQuery} $card\n         * @param {string} slug Report slug\n         * @param {number} metricValue The actual metric value (e.g., 122 users)\n         * @param {number} executionTimeMs Execution time in milliseconds\n         */\n        postSnapshotToBackend: function($card, slug, metricValue, executionTimeMs) {\n            var self = this;\n            var token = this.apiKey;\n            var source = $card.data('source') || 'wizard';\n\n            if (!token) {\n                $card.find('.block-adeptus-kpi-card-trend').addClass('d-none');\n                $card.find('.block-adeptus-kpi-card-sparkline').addClass('d-none');\n                return;\n            }\n\n            // Use correct endpoint based on report source\n            var endpoint = (source === 'ai') ? '/ai-reports/' : '/wizard-reports/';\n\n            // Get baseline period from config (default: all_time)\n            var baselinePeriod = this.config.baselinePeriod || 'all_time';\n\n            // Determine history limit based on baseline period for sparkline display\n            var historyLimit = this.getHistoryLimitForBaseline(baselinePeriod);\n\n            $.ajax({\n                url: this.backendUrl + endpoint + encodeURIComponent(slug) +\n                    '/snapshots?baseline_period=' + baselinePeriod + '&history_limit=' + historyLimit,\n                method: 'POST',\n                headers: {\n                    'Authorization': 'Bearer ' + token,\n                    'Content-Type': 'application/json',\n                    'Accept': 'application/json'\n                },\n                data: JSON.stringify({\n                    row_count: metricValue,\n                    execution_time_ms: executionTimeMs,\n                    evaluate_alerts: true,\n                    baseline_period: baselinePeriod\n                }),\n                timeout: 15000\n            }).done(function(response) {\n                if (response.success) {\n                    // Cache the snapshot response for KPI modal use\n                    self.kpiSnapshotCache[slug] = {\n                        history: response.history || [],\n                        trend: response.trend || {},\n                        currentValue: metricValue,\n                        timestamp: Date.now()\n                    };\n\n                    // Register snapshot schedule for cron-based execution on first run\n                    self.registerSnapshotSchedule(slug, source, metricValue);\n\n                    // Update trend from response - now supports dual trends (vs_previous and vs_baseline)\n                    self.updateKpiTrendFromBackend($card, response.trend);\n\n\n                    // Update sparkline from history\n                    if (response.history && response.history.length >= 2) {\n                        self.renderKpiSparklineFromBackend($card, slug, response.history);\n                    } else {\n                        $card.find('.block-adeptus-kpi-card-sparkline').addClass('d-none');\n                    }\n\n                    // Handle any triggered alerts - pass context we have here.\n                    if (response.alerts && response.alerts.triggered_count > 0) {\n                        var reportName = $card.find('.block-adeptus-kpi-card-label').text() || slug;\n                        self.handleTriggeredAlerts(response.alerts.triggered, slug, metricValue, response.trend, reportName);\n                    }\n                }\n            }).fail(function() {\n                // Silent fail - trend won't update but KPI value is still shown\n                $card.find('.block-adeptus-kpi-card-trend').addClass('d-none');\n                $card.find('.block-adeptus-kpi-card-sparkline').addClass('d-none');\n            });\n        },\n\n        /**\n         * Register a report for cron-based snapshot scheduling.\n         *\n         * Called on first successful snapshot POST to ensure subsequent\n         * snapshots are taken automatically by cron at the configured interval.\n         *\n         * @param {string} slug Report slug\n         * @param {string} source Report source (wizard or ai)\n         * @param {number} metricValue Initial metric value\n         */\n        registerSnapshotSchedule: function(slug, source, metricValue) {\n            var self = this;\n            var scheduleKey = this.blockId + '_' + slug;\n\n            // Only register once per session per report\n            if (this.registeredSnapshots[scheduleKey]) {\n                return;\n            }\n\n            // Get the history interval from config (in seconds)\n            var intervalSeconds = this.config.kpiHistoryInterval || 3600; // Default 1 hour\n\n            // Call Moodle AJAX to register the schedule\n            Ajax.call([{\n                methodname: 'block_adeptus_insights_register_snapshot_schedule',\n                args: {\n                    blockinstanceid: this.blockId,\n                    reportslug: slug,\n                    reportsource: source,\n                    intervalseconds: intervalSeconds,\n                    rowcount: metricValue\n                }\n            }])[0].done(function(response) {\n                if (response.success) {\n                    // Mark as registered for this session\n                    self.registeredSnapshots[scheduleKey] = true;\n                }\n            }).fail(function() {\n                // Silent fail - schedule registration is not critical for UI\n            });\n        },\n\n        /**\n         * Update KPI trend indicator from backend response.\n         *\n         * @param {jQuery} $card\n         * @param {Object} trend Trend data from backend\n         */\n        updateKpiTrendFromBackend: function($card, trend) {\n            var trendContainer = $card.find('.block-adeptus-kpi-card-trend');\n            trendContainer.removeClass('d-none trend-up trend-down trend-neutral');\n\n            // Handle new dual trend structure (vs_baseline and vs_previous)\n            if (trend && (trend.vs_baseline || trend.vs_previous)) {\n                this.updateKpiDualTrend($card, trend);\n                return;\n            }\n\n            // Legacy single trend handling (backward compatibility)\n            if (!trend || !trend.has_previous) {\n                trendContainer.addClass('d-none');\n                return;\n            }\n\n            var direction = trend.direction;\n            var percentage = Math.abs(trend.change_percent || 0);\n            var changeText = this.formatPercentage(percentage);\n\n            if (direction === 'increase') {\n                trendContainer.addClass('trend-up');\n                trendContainer.find('.trend-icon').html('<i class=\"fa fa-arrow-up\"></i>');\n                trendContainer.find('.trend-value').text(this.strings.vsPrevious.replace('{$a}', '+' + changeText));\n            } else if (direction === 'decrease') {\n                trendContainer.addClass('trend-down');\n                trendContainer.find('.trend-icon').html('<i class=\"fa fa-arrow-down\"></i>');\n                trendContainer.find('.trend-value').text(this.strings.vsPrevious.replace('{$a}', '-' + changeText));\n            } else {\n                trendContainer.addClass('trend-neutral');\n                trendContainer.find('.trend-icon').html('<i class=\"fa fa-minus\"></i>');\n                trendContainer.find('.trend-value').text(this.strings.noChange);\n            }\n        },\n\n        /**\n         * Update KPI card with dual trend metrics (overall vs baseline, and vs previous).\n         *\n         * @param {jQuery} $card The KPI card element\n         * @param {Object} trend Trend object with vs_baseline and vs_previous\n         */\n        updateKpiDualTrend: function($card, trend) {\n            var trendContainer = $card.find('.block-adeptus-kpi-card-trend');\n            trendContainer.removeClass('d-none trend-up trend-down trend-neutral');\n\n            var vsBaseline = trend.vs_baseline || {};\n            var vsPrevious = trend.vs_previous || {};\n            var hasBaseline = vsBaseline.has_baseline;\n            var hasPrevious = vsPrevious.has_previous;\n\n            // If no trend data at all, hide the container\n            if (!hasBaseline && !hasPrevious) {\n                trendContainer.addClass('d-none');\n                return;\n            }\n\n            // Build the dual trend display: \" 25% overall |  8% since last\"\n            var parts = [];\n\n            // Overall trend (vs baseline)\n            if (hasBaseline) {\n                var baselinePct = this.formatPercentage(Math.abs(vsBaseline.change_percent || 0));\n                var baselineIcon = this.getTrendIcon(vsBaseline.direction);\n                var baselineSign = vsBaseline.direction === 'increase' ? '+' : (vsBaseline.direction === 'decrease' ? '-' : '');\n                parts.push(baselineIcon + ' ' + baselineSign + baselinePct + ' overall');\n            }\n\n            // Interval trend (vs previous)\n            if (hasPrevious) {\n                var previousPct = this.formatPercentage(Math.abs(vsPrevious.change_percent || 0));\n                var previousIcon = this.getTrendIcon(vsPrevious.direction);\n                var previousSign = vsPrevious.direction === 'increase' ? '+' : (vsPrevious.direction === 'decrease' ? '-' : '');\n                parts.push(previousIcon + ' ' + previousSign + previousPct + ' since last');\n            }\n\n            // Determine overall trend direction for styling (use baseline as primary)\n            var primaryDirection = hasBaseline ? vsBaseline.direction : vsPrevious.direction;\n            if (primaryDirection === 'increase') {\n                trendContainer.addClass('trend-up');\n            } else if (primaryDirection === 'decrease') {\n                trendContainer.addClass('trend-down');\n            } else {\n                trendContainer.addClass('trend-neutral');\n            }\n\n            // Update the display - hide the icon span and use trend-value for full display\n            trendContainer.find('.trend-icon').html('');\n            trendContainer.find('.trend-value').html(parts.join(' <span class=\"trend-separator\">|</span> '));\n        },\n\n        /**\n         * Get trend icon HTML based on direction.\n         *\n         * @param {string} direction 'increase', 'decrease', or 'stable'\n         * @return {string} HTML for the icon\n         */\n        getTrendIcon: function(direction) {\n            if (direction === 'increase') {\n                return '<i class=\"fa fa-arrow-up trend-icon-up\"></i>';\n            } else if (direction === 'decrease') {\n                return '<i class=\"fa fa-arrow-down trend-icon-down\"></i>';\n            }\n            return '<i class=\"fa fa-minus trend-icon-neutral\"></i>';\n        },\n\n        /**\n         * Format percentage for display.\n         *\n         * @param {number} percentage The percentage value\n         * @return {string} Formatted percentage string\n         */\n        formatPercentage: function(percentage) {\n            if (percentage >= 100) {\n                return Math.round(percentage) + '%';\n            } else if (percentage >= 10) {\n                return percentage.toFixed(0) + '%';\n            }\n            return percentage.toFixed(1) + '%';\n        },\n\n        /**\n         * Format a number with thousands separator.\n         *\n         * @param {number|string} value The value to format\n         * @return {string} Formatted number string\n         */\n        formatNumber: function(value) {\n            if (value === null || value === undefined || value === '--') {\n                return '--';\n            }\n            var num = parseFloat(value);\n            if (isNaN(num)) {\n                return value.toString();\n            }\n            // For large numbers, add thousands separator\n            if (Math.abs(num) >= 1000) {\n                return num.toLocaleString();\n            }\n            // For decimals, limit to 2 decimal places\n            if (num % 1 !== 0) {\n                return num.toFixed(2);\n            }\n            return num.toString();\n        },\n\n        /**\n         * Format a timestamp to a readable date/time string.\n         *\n         * @param {string} timestamp The timestamp to format\n         * @return {string} Formatted date/time string\n         */\n        formatTimestamp: function(timestamp) {\n            if (!timestamp) {\n                return '';\n            }\n            var date = new Date(timestamp);\n            var now = new Date();\n            var diffMs = now - date;\n            var diffMins = Math.floor(diffMs / 60000);\n            var diffHours = Math.floor(diffMins / 60);\n            var diffDays = Math.floor(diffHours / 24);\n\n            if (diffMins < 1) {\n                return this.strings.justNow;\n            } else if (diffMins < 60) {\n                return this.strings.minAgo.replace('{$a}', diffMins);\n            } else if (diffHours < 24) {\n                var hourStr = diffHours > 1 ? this.strings.hoursAgo : this.strings.hourAgo;\n                return hourStr.replace('{$a}', diffHours);\n            } else if (diffDays < 7) {\n                var dayStr = diffDays > 1 ? this.strings.daysAgo : this.strings.dayAgo;\n                return dayStr.replace('{$a}', diffDays);\n            }\n            // For older dates, show full date\n            var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',\n                          'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];\n            return months[date.getMonth()] + ' ' + date.getDate() + ', ' + date.getFullYear();\n        },\n\n        /**\n         * Format \"Showing X-Y of Z\" pagination text.\n         *\n         * @param {number} start Start index\n         * @param {number} end End index\n         * @param {number} total Total items\n         * @return {string} Formatted text\n         */\n        formatShowingText: function(start, end, total) {\n            // Use showingxofy string if available, otherwise construct manually\n            if (this.strings.showingXOfY && this.strings.showingXOfY.indexOf('{$a') !== -1) {\n                return this.strings.showingXOfY\n                    .replace('{$a->start}', start)\n                    .replace('{$a->end}', end)\n                    .replace('{$a->total}', total);\n            }\n            return 'Showing ' + start + '-' + end + ' of ' + total;\n        },\n\n        /**\n         * Format \"Page X of Y\" pagination text.\n         *\n         * @param {number} current Current page\n         * @param {number} total Total pages\n         * @return {string} Formatted text\n         */\n        formatPageText: function(current, total) {\n            return this.strings.page + ' ' + current + ' ' + this.strings.of + ' ' + total;\n        },\n\n        /**\n         * Get appropriate history limit based on baseline period.\n         *\n         * Returns a reasonable number of data points for the sparkline\n         * based on the selected baseline period.\n         *\n         * @param {string} baselinePeriod The baseline period setting\n         * @return {number} Number of history entries to request\n         */\n        getHistoryLimitForBaseline: function(baselinePeriod) {\n            switch (baselinePeriod) {\n                case 'all_time':\n                    return 100; // Get all available history\n                case 'rolling_30d':\n                    return 60; // ~2 per day for 30 days\n                case 'month_start':\n                    return 62; // ~2 per day for a month\n                case 'rolling_7d':\n                    return 14; // ~2 per day for 7 days\n                case 'week_start':\n                    return 14; // ~2 per day for a week\n                default:\n                    return 30; // Default reasonable limit\n            }\n        },\n\n        /**\n         * Render sparkline from backend history data.\n         *\n         * @param {jQuery} $card\n         * @param {string} slug\n         * @param {Array} history History data from backend\n         */\n        renderKpiSparklineFromBackend: function($card, slug, history) {\n            // Convert backend history format to sparkline data\n            var sparklineData = history.map(function(point) {\n                return point.row_count;\n            }).reverse(); // Oldest first for chart\n\n            this.renderKpiSparklineFromData($card, slug, sparklineData, sparklineData[sparklineData.length - 1]);\n        },\n\n        /**\n         * Handle triggered alerts from snapshot response.\n         *\n         * Sends notifications via Moodle's messaging system to configured recipients.\n         * Notifications appear in the bell icon notification area.\n         *\n         * @param {Array} triggeredAlerts Array of triggered alert objects\n         * @param {string} reportSlug Report slug from snapshot context\n         * @param {number} currentValue Current metric value from snapshot context\n         * @param {Object} trend Trend data from snapshot response (optional)\n         * @param {string} reportName Human-readable report name (optional)\n         */\n        handleTriggeredAlerts: function(triggeredAlerts, reportSlug, currentValue, trend, reportName) {\n            var self = this;\n\n            if (!triggeredAlerts || triggeredAlerts.length === 0) {\n                return;\n            }\n\n            // Prepare alerts data for the Moodle notification API.\n            // Alerts fire once and are archived - no cooldown period needed.\n            // Use context values (reportSlug, currentValue) as fallbacks since backend may not include them.\n            var alertsConfig = self.config.alertsConfig || [];\n\n            var alertsToSend = triggeredAlerts.map(function(alert) {\n                var alertName = alert.alert_name || alert.name || 'Alert';\n                var value = parseFloat(alert.current_value || alert.actual_value || alert.value || currentValue || 0);\n                var displayReportName = reportName || alert.report_name || reportSlug || 'Report';\n                var alertId = alert.id || alert.alert_id || 0;\n\n                // Look up local config to determine correct severity based on thresholds.\n                var localConfig = null;\n                for (var i = 0; i < alertsConfig.length; i++) {\n                    if (alertsConfig[i].backend_id === alertId) {\n                        localConfig = alertsConfig[i];\n                        break;\n                    }\n                }\n\n                // Determine severity by comparing value against warning and critical thresholds.\n                var severity = 'warning';\n                var thresholdValue = alert.threshold || alert.threshold_value || '';\n                if (localConfig) {\n                    var warningThreshold = parseFloat(localConfig.warning_value) || 0;\n                    var criticalThreshold = parseFloat(localConfig.critical_value) || 0;\n\n                    // Check which threshold was exceeded (critical takes priority).\n                    if (criticalThreshold > 0 && value >= criticalThreshold) {\n                        severity = 'critical';\n                        thresholdValue = criticalThreshold;\n                    } else if (warningThreshold > 0 && value >= warningThreshold) {\n                        severity = 'warning';\n                        thresholdValue = warningThreshold;\n                    }\n                } else {\n                    // Fall back to backend-provided severity if no local config.\n                    severity = alert.severity || (alert.is_critical ? 'critical' : 'warning');\n                }\n\n                // Build a meaningful message with context and trend info.\n                // Format: \"Your {report_name} has reached {value}, exceeding your {severity} threshold ({threshold}).\n                //          {alert_name} increased/decreased by X (Y%) since last measurement.\"\n                var message = 'Your ' + displayReportName + ' has reached ' + value +\n                    ', exceeding your ' + severity + ' threshold (' + thresholdValue + ').';\n\n                // Add trend information if available.\n                if (trend && trend.has_previous) {\n                    var direction = trend.direction || 'change';\n                    var changeAbs = Math.abs(trend.change_absolute || 0);\n                    var changePct = Math.abs(trend.change_percent || 0).toFixed(1);\n\n                    if (direction === 'increase') {\n                        message += ' ' + alertName + ' increased by ' + changeAbs + ' (' + changePct + '%) since last measurement.';\n                    } else if (direction === 'decrease') {\n                        message += ' ' + alertName + ' decreased by ' + changeAbs + ' (' + changePct + '%) since last measurement.';\n                    } else {\n                        message += ' ' + alertName + ' has remained stable since last measurement.';\n                    }\n                }\n\n                return {\n                    alert_id: alertId,\n                    alert_name: alertName,\n                    message: message,\n                    severity: severity,\n                    report_name: displayReportName,\n                    report_slug: alert.report_slug || alert.slug || reportSlug || '',\n                    current_value: String(value),\n                    threshold: String(thresholdValue),\n                    notify_users: JSON.stringify(alert.notify_users || [])\n                };\n            });\n\n            // Send notifications via Moodle's messaging system (silent - no on-page alerts).\n            require(['core/ajax'], function(Ajax) {\n                Ajax.call([{\n                    methodname: 'block_adeptus_insights_send_alert_notification',\n                    args: {\n                        blockinstanceid: self.blockId,\n                        alerts: alertsToSend\n                    }\n                }])[0].done(function(response) {\n                    if (response.success && response.sent_count > 0) {\n                        // Trigger notification area refresh so bell icon updates.\n                        // Small delay to ensure notification is fully committed to database.\n                        setTimeout(function() {\n                            self.refreshNotificationArea();\n                        }, 500);\n                    }\n                }).fail(function() {\n                    // Silent fail - notifications will appear on next poll.\n                });\n            });\n        },\n\n        /**\n         * Refresh the Moodle notification area to show new notifications.\n         * Calls the Moodle API to get the unread count and updates the badge.\n         */\n        refreshNotificationArea: function() {\n            require(['jquery', 'core/ajax'], function($, Ajax) {\n                try {\n                    // Find the notification popover container and get user ID.\n                    var $popover = $('#nav-notification-popover-container');\n                    if (!$popover.length) {\n                        return;\n                    }\n\n                    var userId = $popover.attr('data-userid');\n                    if (!userId) {\n                        return;\n                    }\n\n                    // Call Moodle API to get unread notification count.\n                    Ajax.call([{\n                        methodname: 'message_popup_get_unread_popup_notification_count',\n                        args: {\n                            useridto: parseInt(userId, 10)\n                        }\n                    }])[0].done(function(count) {\n                        // Update the notification badge in the DOM.\n                        var $countContainer = $popover.find('[data-region=\"count-container\"]');\n                        if ($countContainer.length) {\n                            if (count > 0) {\n                                $countContainer.text(count);\n                                $countContainer.removeClass('hidden');\n                            } else {\n                                $countContainer.addClass('hidden');\n                            }\n                        }\n                    }).fail(function() {\n                        // Silent fail - notifications will appear on next page load.\n                    });\n                } catch (e) {\n                    // Silent fail.\n                }\n            });\n        },\n\n        /**\n         * Load KPI history from server for sparkline (legacy - kept for backward compatibility).\n         *\n         * @param {jQuery} $card\n         * @param {string} slug\n         * @param {number} currentValue\n         * @deprecated Use postSnapshotToBackend instead which returns history in response\n         */\n        loadKpiSparklineFromServer: function($card, slug, currentValue) {\n            // This is now handled by postSnapshotToBackend which returns history in response\n            // Keeping this method for any legacy code paths\n            if (!this.config.snapshotsEnabled) {\n                $card.find('.block-adeptus-kpi-card-sparkline').addClass('d-none');\n                return;\n            }\n            // Sparkline is now loaded from snapshot response, no separate call needed\n        },\n\n        /**\n         * Update KPI trend indicator from server response.\n         *\n         * @param {jQuery} $card\n         * @param {string} direction Trend direction (up/down/neutral)\n         * @param {number} percentage Trend percentage\n         */\n        updateKpiTrendFromServer: function($card, direction, percentage) {\n            var trendContainer = $card.find('.block-adeptus-kpi-card-trend');\n            trendContainer.removeClass('d-none trend-up trend-down trend-neutral');\n\n            var absChange = Math.abs(percentage);\n            var changeText;\n            if (absChange >= 100) {\n                changeText = Math.round(absChange) + '%';\n            } else if (absChange >= 10) {\n                changeText = absChange.toFixed(0) + '%';\n            } else {\n                changeText = absChange.toFixed(1) + '%';\n            }\n\n            if (direction === 'up') {\n                trendContainer.addClass('trend-up');\n                trendContainer.find('.trend-icon').html('<i class=\"fa fa-arrow-up\"></i>');\n                trendContainer.find('.trend-value').text(this.strings.vsPrevious.replace('{$a}', changeText));\n            } else if (direction === 'down') {\n                trendContainer.addClass('trend-down');\n                trendContainer.find('.trend-icon').html('<i class=\"fa fa-arrow-down\"></i>');\n                trendContainer.find('.trend-value').text(this.strings.vsPrevious.replace('{$a}', changeText));\n            } else {\n                trendContainer.addClass('trend-neutral');\n                trendContainer.find('.trend-icon').html('<i class=\"fa fa-minus\"></i>');\n                trendContainer.find('.trend-value').text(this.strings.noChange);\n            }\n        },\n\n        /**\n         * Legacy method for backwards compatibility.\n         *\n         * @param {jQuery} $card\n         * @param {string} slug\n         * @param {number} currentValue\n         */\n        updateKpiTrend: function($card, slug, currentValue) {\n            // Show neutral trend initially, server call will update\n            var trendContainer = $card.find('.block-adeptus-kpi-card-trend');\n            trendContainer.removeClass('d-none');\n            trendContainer.addClass('trend-neutral');\n            trendContainer.find('.trend-icon').html('<i class=\"fa fa-spinner fa-spin\"></i>');\n            trendContainer.find('.trend-value').text(this.strings.loading);\n        },\n\n        /**\n         * Render sparkline chart from server data.\n         *\n         * @param {jQuery} $card\n         * @param {string} slug\n         * @param {Array} sparklineData Array of values\n         * @param {number} currentValue Current value to append\n         */\n        renderKpiSparklineFromData: function($card, slug, sparklineData, currentValue) {\n            var sparklineContainer = $card.find('.block-adeptus-kpi-card-sparkline');\n            var canvas = sparklineContainer.find('.block-adeptus-sparkline-chart')[0];\n\n            if (!canvas) {\n                return;\n            }\n\n            // Build data points array\n            var dataPoints = sparklineData.slice();\n            // Add current value if different from last\n            if (dataPoints.length === 0 || dataPoints[dataPoints.length - 1] !== currentValue) {\n                dataPoints.push(currentValue);\n            }\n\n            // Need at least 2 points for a meaningful sparkline\n            if (dataPoints.length < 2) {\n                sparklineContainer.addClass('d-none');\n                return;\n            }\n\n            sparklineContainer.removeClass('d-none');\n\n            // Determine sparkline color based on overall trend\n            var firstValue = dataPoints[0];\n            var lastValue = dataPoints[dataPoints.length - 1];\n            var trendColor = lastValue >= firstValue ? 'rgba(40, 167, 69, 0.8)' : 'rgba(220, 53, 69, 0.8)';\n            var trendBgColor = lastValue >= firstValue ? 'rgba(40, 167, 69, 0.1)' : 'rgba(220, 53, 69, 0.1)';\n\n            // Destroy existing chart if any\n            var chartKey = 'sparkline_' + this.blockId + '_' + slug;\n            if (this.kpiSparklineCharts && this.kpiSparklineCharts[chartKey]) {\n                this.kpiSparklineCharts[chartKey].destroy();\n            }\n\n            // Initialize chart storage\n            if (!this.kpiSparklineCharts) {\n                this.kpiSparklineCharts = {};\n            }\n\n            // Create sparkline chart\n            try {\n                this.kpiSparklineCharts[chartKey] = new Chart(canvas.getContext('2d'), {\n                    type: 'line',\n                    data: {\n                        labels: dataPoints.map(function() { return ''; }),\n                        datasets: [{\n                            data: dataPoints,\n                            borderColor: trendColor,\n                            backgroundColor: trendBgColor,\n                            borderWidth: 2,\n                            fill: true,\n                            tension: 0.4,\n                            pointRadius: 0,\n                            pointHoverRadius: 0\n                        }]\n                    },\n                    options: {\n                        responsive: true,\n                        maintainAspectRatio: false,\n                        plugins: {\n                            legend: { display: false },\n                            tooltip: { enabled: false }\n                        },\n                        scales: {\n                            x: { display: false },\n                            y: { display: false }\n                        },\n                        elements: {\n                            line: { borderCapStyle: 'round' }\n                        },\n                        animation: { duration: 500 }\n                    }\n                });\n            } catch (e) {\n                // Chart.js not available or error\n                sparklineContainer.addClass('d-none');\n            }\n        },\n\n        /**\n         * Legacy method for backwards compatibility.\n         *\n         * @param {jQuery} $card\n         * @param {string} slug\n         * @param {number} currentValue\n         */\n        renderKpiSparkline: function($card, slug, currentValue) {\n            // Sparkline is loaded via loadKpiSparklineFromServer\n            // This is a no-op for backwards compatibility\n        },\n\n        /**\n         * Render tabbed reports mode.\n         *\n         * @param {Array} reports\n         */\n        renderTabs: function(reports) {\n            var self = this;\n            var tabNav = this.container.find('.block-adeptus-tab-nav');\n            var tabContent = this.container.find('.block-adeptus-tab-content');\n            var tabTemplate = $('#block-adeptus-tab-template-' + this.blockId);\n            var paneTemplate = $('#block-adeptus-tab-pane-template-' + this.blockId);\n            var maxTabs = 5;\n\n            tabNav.empty();\n            tabContent.empty();\n\n            // Store tab chart instances\n            this.tabChartInstances = {};\n\n            reports.slice(0, maxTabs).forEach(function(report, index) {\n                var tabId = 'tab-' + self.blockId + '-' + index;\n                var reportName = report.name || report.title || report.display_name || report.slug || 'Report';\n\n                // Create tab\n                var tab = $(tabTemplate.html());\n                tab.find('a')\n                    .attr('href', '#' + tabId)\n                    .attr('aria-controls', tabId);\n                tab.find('.block-adeptus-tab-name').text(reportName);\n\n                if (index === 0) {\n                    tab.find('a').addClass('active').attr('aria-selected', 'true');\n                }\n\n                tabNav.append(tab);\n\n                // Create pane\n                var pane = $(paneTemplate.html());\n                pane.attr('id', tabId);\n                pane.attr('data-slug', report.slug);\n                pane.attr('data-source', report.source);\n\n                if (index === 0) {\n                    pane.addClass('show active');\n                }\n\n                tabContent.append(pane);\n            });\n\n            // Load first tab content\n            if (reports.length > 0) {\n                var firstPane = tabContent.find('.block-adeptus-tab-pane').first();\n                this.loadTabContent(firstPane, reports[0].slug, reports[0].source);\n            }\n\n            this.container.find('.block-adeptus-tabs-container').removeClass('d-none');\n        },\n\n        /**\n         * Load content for a tab.\n         *\n         * @param {jQuery} pane\n         * @param {string} slug\n         * @param {string} source\n         */\n        loadTabContent: function(pane, slug, source) {\n            var self = this;\n            var cacheKey = slug + '_' + source;\n            pane.data('loaded', true);\n\n            // Check cache first\n            if (this.reportDataCache[cacheKey]) {\n                var cached = this.reportDataCache[cacheKey];\n                this.renderTabContent(pane, cached.report, cached.results);\n                return;\n            }\n\n            // Find the report from our cached list\n            var report = this.reports.find(function(r) {\n                return r.slug === slug;\n            });\n\n            if (!report) {\n                pane.find('.block-adeptus-tab-pane-loading').addClass('d-none');\n                pane.find('.block-adeptus-tab-pane-content')\n                    .removeClass('d-none')\n                    .html('<div class=\"text-center text-muted py-4\"><i class=\"fa fa-exclamation-circle\"></i><p class=\"mt-2\">Report not found</p></div>');\n                return;\n            }\n\n            // Load data based on source\n            if (source === 'wizard') {\n                $.ajax({\n                    url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/generate_report.php',\n                    method: 'POST',\n                    data: {\n                        reportid: report.name || report.report_template_id,\n                        sesskey: M.cfg.sesskey\n                    },\n                    dataType: 'json',\n                    timeout: 30000\n                }).done(function(response) {\n                    if (response.success) {\n                        self.reportDataCache[cacheKey] = {\n                            report: report,\n                            results: response.results || []\n                        };\n                        self.renderTabContent(pane, report, response.results || []);\n                    } else {\n                        pane.find('.block-adeptus-tab-pane-loading').addClass('d-none');\n                        pane.find('.block-adeptus-tab-pane-content')\n                            .removeClass('d-none')\n                            .html('<div class=\"text-center text-muted py-4\"><i class=\"fa fa-exclamation-circle\"></i><p class=\"mt-2\">' + (response.message || 'Failed to load') + '</p></div>');\n                    }\n                }).fail(function() {\n                    pane.find('.block-adeptus-tab-pane-loading').addClass('d-none');\n                    pane.find('.block-adeptus-tab-pane-content')\n                        .removeClass('d-none')\n                        .html('<div class=\"text-center text-muted py-4\"><i class=\"fa fa-exclamation-circle\"></i><p class=\"mt-2\">Connection error</p></div>');\n                });\n            } else {\n                // AI reports\n                var token = this.apiKey || (window.adeptusAuthData ? window.adeptusAuthData.api_key : null);\n                if (!token) {\n                    pane.find('.block-adeptus-tab-pane-loading').addClass('d-none');\n                    pane.find('.block-adeptus-tab-pane-content')\n                        .removeClass('d-none')\n                        .html('<div class=\"text-center text-muted py-4\"><i class=\"fa fa-exclamation-circle\"></i><p class=\"mt-2\">Authentication required</p></div>');\n                    return;\n                }\n\n                $.ajax({\n                    url: '' + this.backendUrl + '/ai-reports/' + slug,\n                    method: 'GET',\n                    headers: {\n                        'Authorization': 'Bearer ' + token,\n                        'Accept': 'application/json'\n                    },\n                    timeout: 15000\n                }).done(function(response) {\n                    if (response.success) {\n                        var reportData = response.report || report;\n                        var data = response.data || [];\n\n                        // Check if local execution is required (SaaS model)\n                        var sqlQuery = response.sql || (reportData && reportData.sql_query) || (reportData && reportData.sql);\n                        var needsLocalExecution = response.execution_required || ((!data || data.length === 0) && sqlQuery);\n\n                        if (needsLocalExecution && sqlQuery) {\n                            // Execute SQL locally against Moodle database\n                            self.executeReportLocally(sqlQuery, reportData.params || {})\n                                .then(function(executionResult) {\n                                    var localData = executionResult.data || [];\n                                    self.reportDataCache[cacheKey] = {\n                                        report: reportData,\n                                        results: localData\n                                    };\n                                    self.renderTabContent(pane, reportData, localData);\n                                })\n                                .catch(function(error) {\n                                    pane.find('.block-adeptus-tab-pane-loading').addClass('d-none');\n                                    pane.find('.block-adeptus-tab-pane-content')\n                                        .removeClass('d-none')\n                                        .html('<div class=\"text-center text-muted py-4\"><i class=\"fa fa-exclamation-circle\"></i><p class=\"mt-2\">Failed to execute report</p></div>');\n                                });\n                            return;\n                        }\n\n                        self.reportDataCache[cacheKey] = {\n                            report: reportData,\n                            results: data\n                        };\n                        self.renderTabContent(pane, reportData, data);\n                    } else {\n                        pane.find('.block-adeptus-tab-pane-loading').addClass('d-none');\n                        pane.find('.block-adeptus-tab-pane-content')\n                            .removeClass('d-none')\n                            .html('<div class=\"text-center text-muted py-4\"><i class=\"fa fa-exclamation-circle\"></i><p class=\"mt-2\">Failed to load report</p></div>');\n                    }\n                }).fail(function() {\n                    pane.find('.block-adeptus-tab-pane-loading').addClass('d-none');\n                    pane.find('.block-adeptus-tab-pane-content')\n                        .removeClass('d-none')\n                        .html('<div class=\"text-center text-muted py-4\"><i class=\"fa fa-exclamation-circle\"></i><p class=\"mt-2\">Connection error</p></div>');\n                });\n            }\n        },\n\n        /**\n         * Render tab content with report data - consistent with embedded/modal design.\n         *\n         * @param {jQuery} pane\n         * @param {Object} report\n         * @param {Array} data\n         */\n        renderTabContent: function(pane, report, data) {\n            var tabId = pane.attr('id');\n            pane.find('.block-adeptus-tab-pane-loading').addClass('d-none');\n            var contentArea = pane.find('.block-adeptus-tab-pane-content');\n\n            if (!data || data.length === 0) {\n                contentArea.removeClass('d-none')\n                    .html('<div class=\"text-center text-muted py-4\"><i class=\"fa fa-inbox\"></i><p class=\"mt-2\">No data available</p></div>');\n                return;\n            }\n\n            // Detect headers and numeric columns\n            var headers = Object.keys(data[0]);\n            var numericCols = this.detectNumericColumns(data, headers);\n\n            // Initialize state for this tab pane\n            var state = {\n                data: data,\n                report: report,\n                headers: headers,\n                numericCols: numericCols,\n                currentView: 'table',\n                tablePage: 1,\n                rowsPerPage: 25,\n                chartType: 'bar',\n                xAxis: headers[0],\n                yAxis: numericCols.length > 0 ? numericCols[numericCols.length - 1] : headers[headers.length - 1]\n            };\n            this.tabPaneStates[tabId] = state;\n\n            // Show content area\n            contentArea.removeClass('d-none');\n\n            // Update meta bar\n            this.updateTabMetaBar(pane, report, data);\n\n            // Populate chart axis selectors\n            this.populateTabChartControls(pane, state);\n\n            // Render table (default view)\n            this.renderTabTablePage(pane, state);\n\n            // Reset view toggle to table\n            pane.find('.block-adeptus-tab-view-toggle-btn').removeClass('active');\n            pane.find('.block-adeptus-tab-view-toggle-btn[data-view=\"table\"]').addClass('active');\n            pane.find('.tab-table-view').removeClass('d-none');\n            pane.find('.block-adeptus-tab-chart-view').addClass('d-none');\n        },\n\n        /**\n         * Update tab meta bar with report info.\n         *\n         * @param {jQuery} pane\n         * @param {Object} report\n         * @param {Array} data\n         */\n        updateTabMetaBar: function(pane, report, data) {\n            // Category badge\n            var category = report.category || report.category_name || '';\n            var categoryBadge = pane.find('.block-adeptus-report-category');\n            if (category) {\n                categoryBadge.text(category).removeClass('d-none');\n                // Add category color if available\n                if (report.category_color) {\n                    categoryBadge.css('background-color', report.category_color);\n                } else {\n                    categoryBadge.addClass('bg-primary');\n                }\n            } else {\n                categoryBadge.addClass('d-none');\n            }\n\n            // Row count\n            pane.find('.block-adeptus-row-count-num').text(data.length);\n\n            // Report date\n            var dateStr = report.updated_at || report.created_at || '';\n            if (dateStr) {\n                var date = new Date(dateStr);\n                pane.find('.report-date').text(date.toLocaleDateString());\n            }\n        },\n\n        /**\n         * Populate chart control selectors for a tab.\n         *\n         * @param {jQuery} pane\n         * @param {Object} state\n         */\n        populateTabChartControls: function(pane, state) {\n            var xAxisSelect = pane.find('.block-adeptus-tab-chart-x-axis');\n            var yAxisSelect = pane.find('.block-adeptus-tab-chart-y-axis');\n\n            xAxisSelect.empty();\n            yAxisSelect.empty();\n\n            state.headers.forEach(function(header) {\n                var formatted = header.replace(/_/g, ' ').replace(/\\b\\w/g, function(l) { return l.toUpperCase(); });\n                xAxisSelect.append($('<option>').val(header).text(formatted));\n                yAxisSelect.append($('<option>').val(header).text(formatted));\n            });\n\n            // Set default selections\n            xAxisSelect.val(state.xAxis);\n            yAxisSelect.val(state.yAxis);\n        },\n\n        /**\n         * Switch view in a tab pane (table/chart).\n         *\n         * @param {jQuery} pane\n         * @param {string} view - 'table' or 'chart'\n         */\n        switchTabView: function(pane, view) {\n            var tabId = pane.attr('id');\n            var state = this.tabPaneStates[tabId];\n            if (!state) return;\n\n            state.currentView = view;\n\n            // Update toggle buttons\n            pane.find('.block-adeptus-tab-view-toggle-btn').removeClass('active');\n            pane.find('.block-adeptus-tab-view-toggle-btn[data-view=\"' + view + '\"]').addClass('active');\n\n            // Show/hide views\n            if (view === 'table') {\n                pane.find('.tab-table-view').removeClass('d-none');\n                pane.find('.block-adeptus-tab-chart-view').addClass('d-none');\n            } else {\n                pane.find('.tab-table-view').addClass('d-none');\n                pane.find('.block-adeptus-tab-chart-view').removeClass('d-none');\n                // Render chart if not already rendered\n                this.renderTabChart(pane, state);\n            }\n        },\n\n        /**\n         * Render table page in tab pane with pagination.\n         *\n         * @param {jQuery} pane\n         * @param {Object} state\n         */\n        renderTabTablePage: function(pane, state) {\n            var table = pane.find('.tab-table');\n            var thead = table.find('thead');\n            var tbody = table.find('tbody');\n            var data = state.data;\n            var headers = state.headers;\n\n            thead.empty();\n            tbody.empty();\n\n            // Build header row\n            var headerRow = $('<tr>');\n            headers.forEach(function(h) {\n                var formatted = h.replace(/_/g, ' ').replace(/\\b\\w/g, function(l) { return l.toUpperCase(); });\n                headerRow.append($('<th>').text(formatted));\n            });\n            thead.append(headerRow);\n\n            // Calculate pagination\n            var totalRows = data.length;\n            var totalPages = Math.ceil(totalRows / state.rowsPerPage);\n            var startIndex = (state.tablePage - 1) * state.rowsPerPage;\n            var endIndex = Math.min(startIndex + state.rowsPerPage, totalRows);\n            var pageData = data.slice(startIndex, endIndex);\n\n            // Render rows\n            pageData.forEach(function(row) {\n                var tr = $('<tr>');\n                headers.forEach(function(h) {\n                    var val = row[h];\n                    if (val === null || val === undefined) val = '';\n                    var displayVal = String(val);\n                    if (displayVal.length > 50) {\n                        displayVal = displayVal.substring(0, 50) + '...';\n                    }\n                    tr.append($('<td>').attr('title', val).text(displayVal));\n                });\n                tbody.append(tr);\n            });\n\n            // Update pagination info\n            var showingText = this.formatShowingText(startIndex + 1, endIndex, totalRows);\n            pane.find('.block-adeptus-row-count').text(showingText);\n            pane.find('.block-adeptus-tab-pagination-info').text(this.formatPageText(state.tablePage, totalPages));\n\n            // Update pagination buttons\n            pane.find('.block-adeptus-tab-pagination-prev').prop('disabled', state.tablePage <= 1);\n            pane.find('.block-adeptus-tab-pagination-next').prop('disabled', state.tablePage >= totalPages);\n\n            // Show/hide pagination\n            if (totalPages > 1) {\n                pane.find('.tab-table-pagination').removeClass('d-none');\n            } else {\n                pane.find('.tab-table-pagination').addClass('d-none');\n            }\n        },\n\n        /**\n         * Render chart in tab pane with current settings.\n         *\n         * @param {jQuery} pane\n         * @param {Object} state\n         */\n        renderTabChart: function(pane, state) {\n            var tabId = pane.attr('id');\n            var canvas = pane.find('.block-adeptus-tab-chart')[0];\n\n            if (!canvas || !state.data || state.data.length === 0) {\n                return;\n            }\n\n            // Destroy existing chart for this tab\n            if (this.tabChartInstances && this.tabChartInstances[tabId]) {\n                this.tabChartInstances[tabId].destroy();\n            }\n\n            var chartType = state.chartType;\n            var xAxis = state.xAxis;\n            var yAxis = state.yAxis;\n            var data = state.data;\n\n            // Limit data for chart\n            var chartData = data.slice(0, 20);\n            var labels = chartData.map(function(row) {\n                var label = row[xAxis];\n                if (label === null || label === undefined) return this.strings.unknown;\n                var labelStr = String(label);\n                return labelStr.length > 20 ? labelStr.substring(0, 20) + '...' : labelStr;\n            });\n            var values = chartData.map(function(row) {\n                return parseFloat(row[yAxis]) || 0;\n            });\n\n            var colors = this.generateChartColors(values.length, chartType);\n            var yAxisFormatted = yAxis.replace(/_/g, ' ').replace(/\\b\\w/g, function(l) { return l.toUpperCase(); });\n\n            var config = {\n                type: chartType,\n                data: {\n                    labels: labels,\n                    datasets: [{\n                        label: yAxisFormatted,\n                        data: values,\n                        backgroundColor: chartType === 'pie' || chartType === 'doughnut' ? colors : colors[0],\n                        borderColor: chartType === 'line' ? colors[0] : (chartType === 'pie' || chartType === 'doughnut' ? '#fff' : colors[0]),\n                        borderWidth: chartType === 'pie' || chartType === 'doughnut' ? 2 : 1,\n                        fill: chartType === 'line' ? false : undefined,\n                        tension: chartType === 'line' ? 0.1 : undefined\n                    }]\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    plugins: {\n                        legend: {\n                            display: chartType === 'pie' || chartType === 'doughnut',\n                            position: 'right'\n                        }\n                    },\n                    scales: chartType === 'pie' || chartType === 'doughnut' ? {} : {\n                        y: { beginAtZero: true },\n                        x: { display: data.length <= 10 }\n                    }\n                }\n            };\n\n            try {\n                this.tabChartInstances = this.tabChartInstances || {};\n                this.tabChartInstances[tabId] = new Chart(canvas.getContext('2d'), config);\n            } catch (error) {\n                pane.find('.block-adeptus-tab-chart-container').html(\n                    '<div class=\"alert alert-warning text-center\"><i class=\"fa fa-exclamation-circle\"></i> Could not render chart</div>'\n                );\n            }\n        },\n\n        /**\n         * Export report data from a tab using the main plugin's export system.\n         *\n         * @param {Object} state - Tab pane state\n         * @param {string} format - Export format (pdf, csv, json)\n         */\n        exportTabReport: function(state, format) {\n            var self = this;\n\n            if (!state || !state.data || state.data.length === 0) {\n                Notification.addNotification({\n                    message: self.strings.exportNoData,\n                    type: 'warning'\n                });\n                return;\n            }\n\n            // Check export eligibility via main plugin's AJAX endpoint\n            $.ajax({\n                url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/check_export_eligibility.php',\n                method: 'POST',\n                data: {\n                    format: format,\n                    sesskey: M.cfg.sesskey\n                },\n                dataType: 'json'\n            }).done(function(response) {\n                if (!response.success || !response.eligible) {\n                    self.showExportUpgradePrompt(format, response.message || self.strings.exportNotAvailable);\n                    return;\n                }\n\n                // Eligible - proceed with export\n                self.performExport(format, state.report, state.data);\n            }).fail(function() {\n                Notification.addNotification({\n                    message: self.strings.exportVerifyError,\n                    type: 'error'\n                });\n            });\n        },\n\n        /**\n         * Render table in tab pane (legacy fallback).\n         *\n         * @param {jQuery} pane\n         * @param {Array} data\n         */\n        renderTabTable: function(pane, data) {\n            var table = pane.find('table');\n            var thead = table.find('thead');\n            var tbody = table.find('tbody');\n            var maxRows = this.config.tableMaxRows || 10;\n\n            thead.empty();\n            tbody.empty();\n\n            if (!data || data.length === 0) {\n                return;\n            }\n\n            var headers = Object.keys(data[0]);\n            var headerRow = $('<tr>');\n            headers.forEach(function(h) {\n                var formatted = h.replace(/_/g, ' ').replace(/\\b\\w/g, function(l) { return l.toUpperCase(); });\n                headerRow.append($('<th>').text(formatted));\n            });\n            thead.append(headerRow);\n\n            data.slice(0, maxRows).forEach(function(row) {\n                var tr = $('<tr>');\n                headers.forEach(function(h) {\n                    var val = row[h];\n                    if (val === null || val === undefined) val = '';\n                    var displayVal = String(val);\n                    if (displayVal.length > 40) {\n                        displayVal = displayVal.substring(0, 40) + '...';\n                    }\n                    tr.append($('<td>').attr('title', val).text(displayVal));\n                });\n                tbody.append(tr);\n            });\n        },\n\n        /**\n         * Handle report click.\n         *\n         * @param {string} slug\n         * @param {string} source\n         */\n        handleReportClick: function(slug, source) {\n            var action = this.config.clickAction || 'modal';\n\n            // Check if we should open the enhanced KPI modal\n            // Only for KPI display mode with alerts feature enabled (enterprise gate)\n            if (this.config.displayMode === 'kpi' && this.config.alertsFeatureEnabled && action === 'modal') {\n                this.openKpiModal(slug, source);\n                return;\n            }\n\n            switch (action) {\n                case 'modal':\n                    this.openReportModal(slug, source);\n                    break;\n                case 'newtab':\n                    this.openReportNewTab(slug, source);\n                    break;\n                case 'expand':\n                    this.expandReportInline(slug, source);\n                    break;\n            }\n        },\n\n        /**\n         * Open report in modal.\n         *\n         * @param {string} slug\n         * @param {string} source\n         */\n        openReportModal: function(slug, source) {\n            var self = this;\n\n            // Find report data.\n            var report = this.reports.find(function(r) {\n                return r.slug === slug;\n            });\n\n            if (!report) {\n                return;\n            }\n\n            // Reset state\n            this.modalData = null;\n            this.modalReport = null;\n            this.currentView = 'table';\n            if (this.chartInstance) {\n                this.chartInstance.destroy();\n                this.chartInstance = null;\n            }\n\n            // First render the template, then create the modal with the rendered body\n            Templates.render('block_adeptus_insights/report_modal', {blockid: this.blockId})\n                .then(function(html) {\n                    return ModalFactory.create({\n                        type: ModalFactory.types.DEFAULT,\n                        title: report.name,\n                        body: html,\n                        large: true\n                    });\n                })\n                .then(function(modal) {\n                    self.modal = modal;\n\n                    // Bind modal event handlers\n                    self.bindModalEvents(modal);\n\n                    // Load report data after modal is shown.\n                    modal.getRoot().on(ModalEvents.shown, function() {\n                        self.loadModalReport(slug, source);\n                    });\n\n                    // Cleanup on close.\n                    modal.getRoot().on(ModalEvents.hidden, function() {\n                        if (self.chartInstance) {\n                            self.chartInstance.destroy();\n                            self.chartInstance = null;\n                        }\n                        modal.destroy();\n                        self.modal = null;\n                        self.modalData = null;\n                        self.modalReport = null;\n                    });\n\n                    modal.show();\n                    return modal;\n                }).catch(Notification.exception);\n        },\n\n        /**\n         * Open enhanced KPI modal with interactive chart and date range filter.\n         * This is used when displayMode is 'kpi' and alertsFeatureEnabled is true.\n         *\n         * @param {string} slug\n         * @param {string} source\n         */\n        openKpiModal: function(slug, source) {\n            var self = this;\n\n            // Find report data.\n            var report = this.reports.find(function(r) {\n                return r.slug === slug;\n            });\n\n            if (!report) {\n                return;\n            }\n\n            // Reset state\n            this.kpiModalData = null;\n            this.kpiModalDateRange = '30d';\n            if (this.kpiModalChart) {\n                this.kpiModalChart.destroy();\n                this.kpiModalChart = null;\n            }\n\n            // First render the template, then create the modal with the rendered body\n            Templates.render('block_adeptus_insights/kpi_modal', {blockid: this.blockId})\n                .then(function(html) {\n                    return ModalFactory.create({\n                        type: ModalFactory.types.DEFAULT,\n                        title: report.name,\n                        body: html,\n                        large: true\n                    });\n                })\n                .then(function(modal) {\n                    self.kpiModal = modal;\n\n                    // Bind KPI modal event handlers\n                    self.bindKpiModalEvents(modal, slug, source);\n\n                    // Load KPI data after modal is shown.\n                    modal.getRoot().on(ModalEvents.shown, function() {\n                        self.loadKpiModalData(slug, source, self.kpiModalDateRange);\n                    });\n\n                    // Cleanup on close.\n                    modal.getRoot().on(ModalEvents.hidden, function() {\n                        if (self.kpiModalChart) {\n                            self.kpiModalChart.destroy();\n                            self.kpiModalChart = null;\n                        }\n                        modal.destroy();\n                        self.kpiModal = null;\n                        self.kpiModalData = null;\n                    });\n\n                    modal.show();\n                    return modal;\n                }).catch(Notification.exception);\n        },\n\n        /**\n         * Bind event handlers for KPI modal UI elements.\n         *\n         * @param {Object} modal\n         * @param {string} slug\n         * @param {string} source\n         */\n        bindKpiModalEvents: function(modal, slug, source) {\n            var self = this;\n            var modalRoot = modal.getRoot();\n\n            // Date range selector change\n            modalRoot.on('change', '.block-adeptus-kpi-date-range-select', function() {\n                var dateRange = $(this).val();\n                self.kpiModalDateRange = dateRange;\n                self.loadKpiModalData(slug, source, dateRange);\n            });\n\n            // Retry button\n            modalRoot.on('click', '.block-adeptus-kpi-modal-retry', function(e) {\n                e.preventDefault();\n                self.loadKpiModalData(slug, source, self.kpiModalDateRange);\n            });\n        },\n\n        /**\n         * Load KPI modal data based on date range.\n         *\n         * @param {string} slug\n         * @param {string} source\n         * @param {string} dateRange - '7d', '30d', '90d', or 'all'\n         */\n        loadKpiModalData: function(slug, source, dateRange) {\n            var self = this;\n            var modalContent = this.kpiModal.getRoot().find('.block-adeptus-kpi-modal-content');\n\n            // Show loading\n            modalContent.find('.block-adeptus-kpi-modal-loading').removeClass('d-none');\n            modalContent.find('.block-adeptus-kpi-modal-content-area').addClass('d-none');\n            modalContent.find('.block-adeptus-kpi-modal-error').addClass('d-none');\n\n            // Check cache first - use cached data if available and fresh (under 5 minutes old)\n            var cached = this.kpiSnapshotCache[slug];\n            var cacheMaxAge = 5 * 60 * 1000; // 5 minutes\n\n            if (cached && cached.history && (Date.now() - cached.timestamp) < cacheMaxAge) {\n                // Use cached data\n                self.kpiModalData = cached;\n                self.renderKpiModal(modalContent, cached, dateRange);\n                return;\n            }\n\n            // Fetch fresh data from backend via POST (same as KPI card refresh)\n            var token = this.apiKey;\n            if (!token) {\n                self.showKpiModalError(modalContent);\n                return;\n            }\n\n            var endpoint = source === 'ai' ? '/ai-reports/' : '/reports/';\n            var baselinePeriod = this.config.baselinePeriod || 'all_time';\n            var historyLimit = this.getKpiModalHistoryLimit(dateRange);\n\n            // Get current value from cache or use 0 (backend will return history regardless)\n            var currentValue = cached ? cached.currentValue : 0;\n\n            $.ajax({\n                url: this.backendUrl + endpoint + encodeURIComponent(slug) +\n                    '/snapshots?baseline_period=' + baselinePeriod + '&history_limit=' + historyLimit,\n                method: 'POST',\n                headers: {\n                    'Authorization': 'Bearer ' + token,\n                    'Content-Type': 'application/json',\n                    'Accept': 'application/json'\n                },\n                data: JSON.stringify({\n                    row_count: currentValue,\n                    execution_time_ms: 0,\n                    evaluate_alerts: false, // Don't trigger alerts from modal refresh\n                    baseline_period: baselinePeriod\n                }),\n                timeout: 15000,\n                success: function(response) {\n                    if (response && response.success && response.history) {\n                        // Update cache\n                        self.kpiSnapshotCache[slug] = {\n                            history: response.history || [],\n                            trend: response.trend || {},\n                            currentValue: currentValue,\n                            timestamp: Date.now()\n                        };\n\n                        self.kpiModalData = response;\n                        self.renderKpiModal(modalContent, response, dateRange);\n                    } else {\n                        self.showKpiModalError(modalContent);\n                    }\n                },\n                error: function() {\n                    self.showKpiModalError(modalContent);\n                }\n            });\n        },\n\n        /**\n         * Get history limit based on date range selection.\n         *\n         * @param {string} dateRange\n         * @return {number}\n         */\n        getKpiModalHistoryLimit: function(dateRange) {\n            switch (dateRange) {\n                case '7d':\n                    return 14;\n                case '30d':\n                    return 60;\n                case '90d':\n                    return 180;\n                case 'all':\n                    return 500;\n                default:\n                    return 60;\n            }\n        },\n\n        /**\n         * Render KPI modal with data.\n         *\n         * @param {jQuery} modalContent\n         * @param {Object} data\n         * @param {string} dateRange\n         */\n        renderKpiModal: function(modalContent, data, dateRange) {\n            // Hide loading, show content\n            modalContent.find('.block-adeptus-kpi-modal-loading').addClass('d-none');\n            modalContent.find('.block-adeptus-kpi-modal-content-area').removeClass('d-none');\n            modalContent.find('.block-adeptus-kpi-modal-error').addClass('d-none');\n\n            // Get history data and sort chronologically (oldest first)\n            var history = (data.history || []).slice(); // Clone to avoid mutating original\n            history.sort(function(a, b) {\n                var dateA = new Date(a.recorded_at || a.created_at);\n                var dateB = new Date(b.recorded_at || b.created_at);\n                return dateA - dateB; // Ascending order (oldest first)\n            });\n\n            // Get trend data from response\n            var trend = data.trend || {};\n            var vsBaseline = trend.vs_baseline || {};\n            var vsPrevious = trend.vs_previous || {};\n\n            // Filter history by date range\n            var filteredHistory = this.filterKpiHistoryByDateRange(history, dateRange);\n\n            // Current value: use the cached currentValue (from KPI card) or latest history entry\n            var currentValue = data.currentValue;\n            if (!currentValue && filteredHistory.length > 0) {\n                currentValue = filteredHistory[filteredHistory.length - 1].row_count;\n            }\n            currentValue = currentValue || '--';\n\n            // Update metric value\n            modalContent.find('.block-adeptus-kpi-modal-value').text(this.formatNumber(currentValue));\n\n            // Update dual trend display\n            this.renderKpiModalTrends(modalContent, vsBaseline, vsPrevious);\n\n            // Calculate stats\n            var stats = this.calculateKpiStats(filteredHistory);\n            modalContent.find('.block-adeptus-kpi-stat-min').text(this.formatNumber(stats.min));\n            modalContent.find('.block-adeptus-kpi-stat-max').text(this.formatNumber(stats.max));\n            modalContent.find('.block-adeptus-kpi-stat-avg').text(this.formatNumber(stats.avg));\n\n            // Update data points count\n            modalContent.find('.datapoints-count').text(filteredHistory.length);\n\n            // Update last updated\n            if (filteredHistory.length > 0) {\n                var lastEntry = filteredHistory[filteredHistory.length - 1];\n                var lastUpdated = lastEntry.recorded_at || lastEntry.created_at;\n                if (lastUpdated) {\n                    modalContent.find('.block-adeptus-kpi-modal-last-updated').text(\n                        this.strings.lastUpdated + ': ' + this.formatTimestamp(lastUpdated)\n                    );\n                }\n            }\n\n            // Render interactive chart\n            this.renderKpiModalChart(modalContent, filteredHistory);\n        },\n\n        /**\n         * Filter KPI history by date range.\n         *\n         * @param {Array} history\n         * @param {string} dateRange\n         * @return {Array}\n         */\n        filterKpiHistoryByDateRange: function(history, dateRange) {\n            if (dateRange === 'all' || !history || history.length === 0) {\n                return history;\n            }\n\n            var now = new Date();\n            var cutoffDate;\n\n            switch (dateRange) {\n                case '7d':\n                    cutoffDate = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000));\n                    break;\n                case '30d':\n                    cutoffDate = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));\n                    break;\n                case '90d':\n                    cutoffDate = new Date(now.getTime() - (90 * 24 * 60 * 60 * 1000));\n                    break;\n                default:\n                    return history;\n            }\n\n            return history.filter(function(entry) {\n                var entryDate = new Date(entry.recorded_at || entry.created_at);\n                return entryDate >= cutoffDate;\n            });\n        },\n\n        /**\n         * Render dual trend metrics in KPI modal.\n         *\n         * @param {jQuery} modalContent\n         * @param {Object} vsBaseline\n         * @param {Object} vsPrevious\n         */\n        renderKpiModalTrends: function(modalContent, vsBaseline, vsPrevious) {\n            // Format baseline trend (vs overall baseline)\n            var baselineHtml = '--';\n            if (vsBaseline && vsBaseline.has_baseline) {\n                var baselinePct = this.formatPercentage(Math.abs(vsBaseline.change_percent || 0));\n                var baselineIcon = this.getTrendIcon(vsBaseline.direction);\n                var baselineClass = 'trend-' + (vsBaseline.direction || 'neutral');\n                var baselineSign = vsBaseline.direction === 'increase' ? '+' :\n                    (vsBaseline.direction === 'decrease' ? '-' : '');\n                baselineHtml = '<span class=\"' + baselineClass + '\">' +\n                    baselineIcon + ' ' + baselineSign + baselinePct + ' overall</span>';\n            }\n            modalContent.find('.block-adeptus-kpi-modal-trend-baseline').html(baselineHtml);\n\n            // Format previous trend (vs previous snapshot)\n            var previousHtml = '--';\n            if (vsPrevious && vsPrevious.has_previous) {\n                var previousPct = this.formatPercentage(Math.abs(vsPrevious.change_percent || 0));\n                var previousIcon = this.getTrendIcon(vsPrevious.direction);\n                var previousClass = 'trend-' + (vsPrevious.direction || 'neutral');\n                var previousSign = vsPrevious.direction === 'increase' ? '+' :\n                    (vsPrevious.direction === 'decrease' ? '-' : '');\n                previousHtml = '<span class=\"' + previousClass + '\">' +\n                    previousIcon + ' ' + previousSign + previousPct + ' since last</span>';\n            }\n            modalContent.find('.block-adeptus-kpi-modal-trend-previous').html(previousHtml);\n        },\n\n        /**\n         * Calculate statistics from KPI history.\n         *\n         * @param {Array} history\n         * @return {Object}\n         */\n        calculateKpiStats: function(history) {\n            if (!history || history.length === 0) {\n                return {min: '--', max: '--', avg: '--'};\n            }\n\n            var values = history.map(function(entry) {\n                return parseFloat(entry.row_count) || 0;\n            });\n\n            var min = Math.min.apply(null, values);\n            var max = Math.max.apply(null, values);\n            var sum = values.reduce(function(a, b) { return a + b; }, 0);\n            var avg = Math.round(sum / values.length);\n\n            return {min: min, max: max, avg: avg};\n        },\n\n        /**\n         * Render interactive chart in KPI modal.\n         *\n         * @param {jQuery} modalContent\n         * @param {Array} history\n         */\n        renderKpiModalChart: function(modalContent, history) {\n            var self = this;\n            var canvas = modalContent.find('.block-adeptus-kpi-modal-chart')[0];\n\n            if (!canvas) {\n                return;\n            }\n\n            // Destroy existing chart\n            if (this.kpiModalChart) {\n                this.kpiModalChart.destroy();\n            }\n\n            // Prepare chart data - filter out consecutive duplicates where value hasn't changed\n            var labels = [];\n            var data = [];\n            var lastValue = null;\n\n            history.forEach(function(entry) {\n                var value = parseFloat(entry.row_count) || 0;\n\n                // Only add data point if the value has changed from the previous entry\n                if (lastValue === null || value !== lastValue) {\n                    var date = new Date(entry.recorded_at || entry.created_at);\n                    labels.push(self.formatChartDate(date));\n                    data.push(value);\n                    lastValue = value;\n                }\n            });\n\n            // Create chart\n            var ctx = canvas.getContext('2d');\n            this.kpiModalChart = new Chart(ctx, {\n                type: 'line',\n                data: {\n                    labels: labels,\n                    datasets: [{\n                        label: 'Value',\n                        data: data,\n                        borderColor: '#0066cc',\n                        backgroundColor: 'rgba(0, 102, 204, 0.1)',\n                        borderWidth: 2,\n                        fill: true,\n                        tension: 0.3,\n                        pointRadius: 4,\n                        pointHoverRadius: 6,\n                        pointBackgroundColor: '#0066cc',\n                        pointBorderColor: '#fff',\n                        pointBorderWidth: 2\n                    }]\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    interaction: {\n                        mode: 'index',\n                        intersect: false\n                    },\n                    plugins: {\n                        legend: {\n                            display: false\n                        },\n                        tooltip: {\n                            enabled: true,\n                            backgroundColor: 'rgba(0, 0, 0, 0.8)',\n                            titleColor: '#fff',\n                            bodyColor: '#fff',\n                            padding: 12,\n                            displayColors: false,\n                            callbacks: {\n                                title: function(tooltipItems) {\n                                    return tooltipItems[0].label;\n                                },\n                                label: function(context) {\n                                    return 'Value: ' + self.formatNumber(context.parsed.y);\n                                }\n                            }\n                        }\n                    },\n                    scales: {\n                        x: {\n                            display: true,\n                            grid: {\n                                display: false\n                            },\n                            ticks: {\n                                maxRotation: 45,\n                                minRotation: 0,\n                                autoSkip: true,\n                                maxTicksLimit: 10\n                            }\n                        },\n                        y: {\n                            display: true,\n                            beginAtZero: false,\n                            grid: {\n                                color: 'rgba(0, 0, 0, 0.05)'\n                            },\n                            ticks: {\n                                callback: function(value) {\n                                    return self.formatNumber(value);\n                                }\n                            }\n                        }\n                    }\n                }\n            });\n        },\n\n        /**\n         * Format date for chart X-axis labels.\n         *\n         * @param {Date} date\n         * @return {string}\n         */\n        formatChartDate: function(date) {\n            var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',\n                          'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];\n            return months[date.getMonth()] + ' ' + date.getDate();\n        },\n\n        /**\n         * Show error state in KPI modal.\n         *\n         * @param {jQuery} modalContent\n         */\n        showKpiModalError: function(modalContent) {\n            modalContent.find('.block-adeptus-kpi-modal-loading').addClass('d-none');\n            modalContent.find('.block-adeptus-kpi-modal-content-area').addClass('d-none');\n            modalContent.find('.block-adeptus-kpi-modal-error').removeClass('d-none');\n        },\n\n        /**\n         * Bind event handlers for modal UI elements.\n         *\n         * @param {Object} modal\n         */\n        bindModalEvents: function(modal) {\n            var self = this;\n            var modalRoot = modal.getRoot();\n\n            // View toggle buttons\n            modalRoot.on('click', '.block-adeptus-view-toggle-btn', function(e) {\n                e.preventDefault();\n                var view = $(this).data('view');\n                self.switchModalView(view);\n            });\n\n            // Chart control changes\n            modalRoot.on('change', '#modal-chart-type, #modal-chart-x-axis, #modal-chart-y-axis', function() {\n                if (self.currentView === 'chart') {\n                    self.renderModalChart();\n                }\n            });\n\n            // Retry button\n            modalRoot.on('click', '.block-adeptus-modal-retry', function(e) {\n                e.preventDefault();\n                if (self.modalReport) {\n                    self.loadModalReport(self.modalReport.slug, self.modalReport.source);\n                }\n            });\n\n            // Export buttons (PDF, CSV, JSON)\n            modalRoot.on('click', '.block-adeptus-modal-export', function(e) {\n                e.preventDefault();\n                var format = $(this).data('format');\n                self.exportModalData(format);\n            });\n\n            // Table pagination - Previous\n            modalRoot.on('click', '.table-pagination-prev', function(e) {\n                e.preventDefault();\n                if (self.tableCurrentPage > 1) {\n                    self.tableCurrentPage--;\n                    self.renderModalTablePage();\n                }\n            });\n\n            // Table pagination - Next\n            modalRoot.on('click', '.table-pagination-next', function(e) {\n                e.preventDefault();\n                if (self.tableCurrentPage < self.tableTotalPages) {\n                    self.tableCurrentPage++;\n                    self.renderModalTablePage();\n                }\n            });\n        },\n\n        /**\n         * Switch between table and chart views in modal.\n         *\n         * @param {string} view - 'table' or 'chart'\n         */\n        switchModalView: function(view) {\n            var modalBody = this.modal.getBody();\n\n            // Update toggle buttons\n            modalBody.find('.block-adeptus-view-toggle-btn').removeClass('active');\n            modalBody.find('.block-adeptus-view-toggle-btn[data-view=\"' + view + '\"]').addClass('active');\n\n            // Switch views\n            if (view === 'table') {\n                modalBody.find('#modal-table-view').removeClass('d-none');\n                modalBody.find('#modal-chart-view').addClass('d-none');\n            } else {\n                modalBody.find('#modal-table-view').addClass('d-none');\n                modalBody.find('#modal-chart-view').removeClass('d-none');\n                // Render chart when switching to chart view\n                this.renderModalChart();\n            }\n\n            this.currentView = view;\n        },\n\n        /**\n         * Load report data into modal.\n         *\n         * @param {string} slug\n         * @param {string} source\n         */\n        loadModalReport: function(slug, source) {\n            var self = this;\n            var modalBody = this.modal.getBody();\n            var cacheKey = slug + '_' + source;\n\n            // Check cache first for instant loading\n            if (this.reportDataCache[cacheKey]) {\n                var cached = this.reportDataCache[cacheKey];\n                modalBody.find('.block-adeptus-modal-loading').addClass('d-none');\n                this.renderModalContent(modalBody, cached.report, cached.results, cached.chartData, cached.chartType);\n                return;\n            }\n\n            // Find the report from our cached list\n            var report = this.reports.find(function(r) {\n                return r.slug === slug;\n            });\n\n            if (!report) {\n                modalBody.find('.block-adeptus-modal-loading').addClass('d-none');\n                modalBody.find('.block-adeptus-modal-error').removeClass('d-none');\n                return;\n            }\n\n            // For wizard reports, execute locally via generate_report.php\n            // For AI reports, we need to fetch from backend\n            if (source === 'wizard') {\n                // Execute report via local Moodle AJAX endpoint\n                $.ajax({\n                    url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/generate_report.php',\n                    method: 'POST',\n                    data: {\n                        reportid: report.name || report.report_template_id,\n                        sesskey: M.cfg.sesskey\n                    },\n                    dataType: 'json',\n                    timeout: 30000\n                }).done(function(response) {\n                    modalBody.find('.block-adeptus-modal-loading').addClass('d-none');\n\n                    if (response.success) {\n                        // Cache the result for future use\n                        self.reportDataCache[cacheKey] = {\n                            report: report,\n                            results: response.results || [],\n                            chartData: response.chart_data,\n                            chartType: response.chart_type\n                        };\n                        self.renderModalContent(modalBody, report, response.results || [], response.chart_data, response.chart_type);\n                    } else {\n                        modalBody.find('.block-adeptus-modal-error').removeClass('d-none');\n                        modalBody.find('.block-adeptus-modal-error p').text(response.message || self.strings.errorFailedLoadReport);\n                    }\n                }).fail(function() {\n                    modalBody.find('.block-adeptus-modal-loading').addClass('d-none');\n                    modalBody.find('.block-adeptus-modal-error').removeClass('d-none');\n                });\n            } else {\n                // AI reports - fetch from backend API\n                var token = this.apiKey || (window.adeptusAuthData ? window.adeptusAuthData.api_key : null);\n\n                if (!token) {\n                    modalBody.find('.block-adeptus-modal-loading').addClass('d-none');\n                    modalBody.find('.block-adeptus-modal-error').removeClass('d-none');\n                    return;\n                }\n\n                $.ajax({\n                    url: '' + this.backendUrl + '/ai-reports/' + slug,\n                    method: 'GET',\n                    headers: {\n                        'Authorization': 'Bearer ' + token,\n                        'Accept': 'application/json'\n                    },\n                    timeout: 15000\n                }).done(function(response) {\n                    if (response.success && response.report) {\n                        var reportData = response.report;\n                        var data = response.data || [];\n\n                        // Check if local execution is required (SaaS model)\n                        var sqlQuery = response.sql || (reportData && reportData.sql_query) || (reportData && reportData.sql);\n                        var needsLocalExecution = response.execution_required || ((!data || data.length === 0) && sqlQuery);\n\n                        if (needsLocalExecution && sqlQuery) {\n                            // Execute SQL locally against Moodle database\n                            self.executeReportLocally(sqlQuery, reportData.params || {})\n                                .then(function(executionResult) {\n                                    modalBody.find('.block-adeptus-modal-loading').addClass('d-none');\n                                    var localData = executionResult.data || [];\n                                    self.reportDataCache[cacheKey] = {\n                                        report: reportData,\n                                        results: localData,\n                                        chartData: null,\n                                        chartType: null\n                                    };\n                                    self.renderModalContent(modalBody, reportData, localData, null, null);\n                                })\n                                .catch(function(error) {\n                                    modalBody.find('.block-adeptus-modal-loading').addClass('d-none');\n                                    modalBody.find('.block-adeptus-modal-error').removeClass('d-none');\n                                });\n                            return;\n                        }\n\n                        modalBody.find('.block-adeptus-modal-loading').addClass('d-none');\n                        // Cache the result for future use\n                        self.reportDataCache[cacheKey] = {\n                            report: reportData,\n                            results: data,\n                            chartData: null,\n                            chartType: null\n                        };\n                        self.renderModalContent(modalBody, reportData, data, null, null);\n                    } else {\n                        modalBody.find('.block-adeptus-modal-loading').addClass('d-none');\n                        modalBody.find('.block-adeptus-modal-error').removeClass('d-none');\n                    }\n                }).fail(function() {\n                    modalBody.find('.block-adeptus-modal-loading').addClass('d-none');\n                    modalBody.find('.block-adeptus-modal-error').removeClass('d-none');\n                });\n            }\n        },\n\n        /**\n         * Render modal content with report data.\n         *\n         * @param {jQuery} modalBody\n         * @param {Object} report\n         * @param {Array} data\n         * @param {Object} chartData - Pre-configured chart data from backend (unused, we use controls)\n         * @param {string} chartType - Chart type from backend (unused, we use controls)\n         */\n        renderModalContent: function(modalBody, report, data, chartData, chartType) {\n            var self = this;\n\n            // Store data for chart re-rendering\n            this.modalData = data || [];\n            this.modalReport = report;\n\n            var contentArea = modalBody.find('.block-adeptus-modal-content-area');\n            contentArea.removeClass('d-none');\n\n            // Set report metadata\n            var category = report.category_info || {name: 'General', color: '#6c757d'};\n            modalBody.find('.block-adeptus-report-category')\n                .text(category.name)\n                .css('background-color', category.color);\n            modalBody.find('.block-adeptus-row-count-num').text(this.modalData.length);\n            modalBody.find('.report-date')\n                .text(report.last_executed_at ?\n                    this.strings.lastRun.replace('{$a}', new Date(report.last_executed_at).toLocaleDateString()) : '');\n\n            // Populate axis selectors\n            this.populateAxisSelectors(modalBody);\n\n            // Render table\n            this.renderModalTable(modalBody, this.modalData);\n\n            // Reset to table view\n            this.currentView = 'table';\n            modalBody.find('.block-adeptus-view-toggle-btn').removeClass('active');\n            modalBody.find('.block-adeptus-view-toggle-btn[data-view=\"table\"]').addClass('active');\n            modalBody.find('#modal-table-view').removeClass('d-none');\n            modalBody.find('#modal-chart-view').addClass('d-none');\n        },\n\n        /**\n         * Populate X-axis and Y-axis dropdown selectors.\n         *\n         * @param {jQuery} modalBody\n         */\n        populateAxisSelectors: function(modalBody) {\n            var data = this.modalData;\n            if (!data || data.length === 0) {\n                return;\n            }\n\n            var headers = Object.keys(data[0]);\n            var xAxisSelect = modalBody.find('#modal-chart-x-axis');\n            var yAxisSelect = modalBody.find('#modal-chart-y-axis');\n\n            // Clear existing options\n            xAxisSelect.empty();\n            yAxisSelect.empty();\n\n            // Detect numeric columns for Y-axis\n            var numericCols = this.detectNumericColumns(data, headers);\n\n            // Populate X-axis with all columns\n            headers.forEach(function(header, idx) {\n                var formattedHeader = header.replace(/_/g, ' ').replace(/\\b\\w/g, function(l) { return l.toUpperCase(); });\n                var selected = idx === 0 ? ' selected' : '';\n                xAxisSelect.append('<option value=\"' + header + '\"' + selected + '>' + formattedHeader + '</option>');\n            });\n\n            // Populate Y-axis with numeric columns (or all if none detected)\n            var yAxisOptions = numericCols.length > 0 ? numericCols : headers;\n            yAxisOptions.forEach(function(col, idx) {\n                var formattedHeader = col.replace(/_/g, ' ').replace(/\\b\\w/g, function(l) { return l.toUpperCase(); });\n                // Select the last numeric column by default (usually the main value)\n                var selected = idx === yAxisOptions.length - 1 ? ' selected' : '';\n                yAxisSelect.append('<option value=\"' + col + '\"' + selected + '>' + formattedHeader + '</option>');\n            });\n        },\n\n        /**\n         * Detect numeric columns in data.\n         *\n         * @param {Array} data\n         * @param {Array} headers\n         * @return {Array}\n         */\n        detectNumericColumns: function(data, headers) {\n            var numericCols = [];\n\n            headers.forEach(function(header) {\n                var isNumeric = data.every(function(row) {\n                    var val = row[header];\n                    if (val === null || val === undefined || val === '') {\n                        return true; // Allow nulls\n                    }\n                    return !isNaN(parseFloat(val)) && isFinite(val);\n                });\n\n                // Also check if at least some values are actually numbers\n                var hasNumbers = data.some(function(row) {\n                    var val = row[header];\n                    return val !== null && val !== undefined && val !== '' && !isNaN(parseFloat(val));\n                });\n\n                if (isNumeric && hasNumbers) {\n                    numericCols.push(header);\n                }\n            });\n\n            return numericCols;\n        },\n\n        /**\n         * Execute AI report SQL locally against Moodle database.\n         * Used when backend returns SQL query but no data (SaaS model).\n         *\n         * @param {string} sql - The SQL query to execute\n         * @param {Object} params - Query parameters\n         * @return {Promise}\n         */\n        executeReportLocally: function(sql, params) {\n            params = params || {};\n\n            return new Promise(function(resolve, reject) {\n                $.ajax({\n                    url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/execute_ai_report.php',\n                    method: 'POST',\n                    contentType: 'application/json',\n                    data: JSON.stringify({\n                        sql: sql,\n                        params: params,\n                        sesskey: M.cfg.sesskey\n                    }),\n                    timeout: 60000,\n                    success: function(response) {\n                        if (response.success) {\n                            resolve({\n                                data: response.data || [],\n                                headers: response.headers || [],\n                                row_count: response.row_count || 0,\n                                error: null\n                            });\n                        } else {\n                            resolve({\n                                data: [],\n                                headers: [],\n                                row_count: 0,\n                                error: response.message || 'Query execution failed'\n                            });\n                        }\n                    },\n                    error: function(xhr, status, error) {\n                        reject(new Error('Failed to execute report: ' + error));\n                    }\n                });\n            });\n        },\n\n        /**\n         * Render chart in modal using current control values.\n         */\n        renderModalChart: function() {\n            var self = this;\n            var modalBody = this.modal.getBody();\n            var data = this.modalData;\n\n            if (!data || data.length === 0) {\n                modalBody.find('.block-adeptus-chart-container').html(\n                    '<div class=\"alert alert-warning text-center\"><i class=\"fa fa-info-circle\"></i> No data available for chart</div>'\n                );\n                return;\n            }\n\n            var canvas = modalBody.find('.block-adeptus-modal-chart')[0];\n            if (!canvas) {\n                return;\n            }\n\n            // Destroy existing chart\n            if (this.chartInstance) {\n                this.chartInstance.destroy();\n                this.chartInstance = null;\n            }\n\n            // Get control values\n            var chartType = modalBody.find('#modal-chart-type').val() || 'bar';\n            var labelKey = modalBody.find('#modal-chart-x-axis').val();\n            var valueKey = modalBody.find('#modal-chart-y-axis').val();\n\n            // Fallback if not set\n            if (!labelKey || !valueKey) {\n                var headers = Object.keys(data[0]);\n                labelKey = labelKey || headers[0];\n                valueKey = valueKey || headers[headers.length - 1];\n            }\n\n            // Format value key for display\n            var valueKeyFormatted = valueKey.replace(/_/g, ' ').replace(/\\b\\w/g, function(l) { return l.toUpperCase(); });\n\n            // Limit data for chart readability (max 50 items)\n            var chartData = data.slice(0, 50);\n            var labels = chartData.map(function(row) {\n                var label = row[labelKey];\n                if (label === null || label === undefined) return this.strings.unknown;\n                var labelStr = String(label);\n                return labelStr.length > 30 ? labelStr.substring(0, 30) + '...' : labelStr;\n            });\n            var values = chartData.map(function(row) {\n                return parseFloat(row[valueKey]) || 0;\n            });\n\n            // Generate colors\n            var colors = this.generateChartColors(values.length, chartType);\n\n            // Create chart config\n            var config = this.createChartConfig(chartType, labels, values, valueKeyFormatted, colors);\n\n            try {\n                this.chartInstance = new Chart(canvas.getContext('2d'), config);\n            } catch (error) {\n                modalBody.find('.block-adeptus-chart-container').html(\n                    '<div class=\"alert alert-danger\"><i class=\"fa fa-exclamation-triangle\"></i> Error rendering chart</div>'\n                );\n            }\n        },\n\n        /**\n         * Create Chart.js configuration.\n         *\n         * @param {string} chartType\n         * @param {Array} labels\n         * @param {Array} values\n         * @param {string} valueKey\n         * @param {Array} colors\n         * @return {Object}\n         */\n        createChartConfig: function(chartType, labels, values, valueKey, colors) {\n            var reportName = this.modalReport ? this.modalReport.name : 'Report';\n\n            var baseOptions = {\n                responsive: true,\n                maintainAspectRatio: false,\n                plugins: {\n                    title: {\n                        display: true,\n                        text: reportName,\n                        font: { size: 14, weight: 'bold' },\n                        padding: { top: 10, bottom: 20 }\n                    },\n                    legend: {\n                        display: chartType === 'pie' || chartType === 'doughnut',\n                        position: 'right'\n                    }\n                }\n            };\n\n            if (chartType === 'pie' || chartType === 'doughnut') {\n                return {\n                    type: chartType,\n                    data: {\n                        labels: labels,\n                        datasets: [{\n                            data: values,\n                            backgroundColor: colors,\n                            borderWidth: 2\n                        }]\n                    },\n                    options: baseOptions\n                };\n            } else {\n                // Bar or Line chart\n                baseOptions.scales = {\n                    y: {\n                        beginAtZero: true,\n                        title: {\n                            display: true,\n                            text: valueKey\n                        }\n                    },\n                    x: {\n                        title: {\n                            display: false\n                        }\n                    }\n                };\n\n                return {\n                    type: chartType,\n                    data: {\n                        labels: labels,\n                        datasets: [{\n                            label: valueKey,\n                            data: values,\n                            backgroundColor: chartType === 'line' ? 'transparent' : colors[0],\n                            borderColor: colors[0].replace('0.7', '1'),\n                            borderWidth: 2,\n                            fill: chartType === 'line' ? false : true,\n                            tension: 0.1\n                        }]\n                    },\n                    options: baseOptions\n                };\n            }\n        },\n\n        /**\n         * Generate chart colors.\n         *\n         * @param {number} count\n         * @param {string} chartType\n         * @return {Array}\n         */\n        generateChartColors: function(count, chartType) {\n            var baseColors = [\n                'rgba(37, 99, 235, 0.7)',   // Blue\n                'rgba(16, 185, 129, 0.7)',  // Green\n                'rgba(245, 158, 11, 0.7)',  // Amber\n                'rgba(239, 68, 68, 0.7)',   // Red\n                'rgba(139, 92, 246, 0.7)',  // Purple\n                'rgba(6, 182, 212, 0.7)',   // Cyan\n                'rgba(236, 72, 153, 0.7)',  // Pink\n                'rgba(132, 204, 22, 0.7)',  // Lime\n                'rgba(249, 115, 22, 0.7)',  // Orange\n                'rgba(99, 102, 241, 0.7)'   // Indigo\n            ];\n\n            var colors = [];\n            for (var i = 0; i < count; i++) {\n                colors.push(baseColors[i % baseColors.length]);\n            }\n            return colors;\n        },\n\n        /**\n         * Export modal data using the main plugin's export system.\n         * Checks eligibility and respects subscription-level permissions.\n         *\n         * @param {string} format - Export format (pdf, csv, json)\n         */\n        exportModalData: function(format) {\n            var self = this;\n            var data = this.modalData;\n            var report = this.modalReport;\n\n            if (!data || data.length === 0) {\n                Notification.addNotification({\n                    message: self.strings.exportNoData,\n                    type: 'warning'\n                });\n                return;\n            }\n\n            // Check export eligibility via main plugin's AJAX endpoint\n            $.ajax({\n                url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/check_export_eligibility.php',\n                method: 'POST',\n                data: {\n                    format: format,\n                    sesskey: M.cfg.sesskey\n                },\n                dataType: 'json'\n            }).done(function(response) {\n                if (!response.success || !response.eligible) {\n                    // Show upgrade prompt for premium features\n                    self.showExportUpgradePrompt(format, response.message || self.strings.exportNotAvailable);\n                    return;\n                }\n\n                // Eligible - proceed with export via main plugin\n                self.performExport(format, report, data);\n            }).fail(function() {\n                Notification.addNotification({\n                    message: self.strings.exportVerifyError,\n                    type: 'error'\n                });\n            });\n        },\n\n        /**\n         * Show upgrade prompt when export format is not available on current plan.\n         *\n         * @param {string} format - The requested format\n         * @param {string} message - Message from eligibility check\n         */\n        showExportUpgradePrompt: function(format, message) {\n            var formatNames = {\n                'pdf': 'PDF',\n                'csv': 'CSV',\n                'json': 'JSON'\n            };\n            var formatName = formatNames[format] || format.toUpperCase();\n\n            Notification.alert(\n                this.strings.exportTitle.replace('{$a}', formatName),\n                message || this.strings.exportNotOnPlan.replace('{$a}', formatName),\n                this.strings.ok\n            );\n        },\n\n        /**\n         * Capture chart image from modal for PDF export.\n         * Returns base64 encoded PNG image data.\n         *\n         * @returns {Promise<string|null>} Base64 image data or null if capture fails\n         */\n        captureChartImage: function() {\n            var self = this;\n            return new Promise(function(resolve) {\n                // Wait for any chart animations to complete\n                setTimeout(function() {\n                    var canvas = null;\n\n                    // Try to find chart canvas in order of priority\n                    // 1. Modal chart (report links modal)\n                    var modalChart = document.querySelector('.modal.show .block-adeptus-modal-chart');\n                    if (modalChart) {\n                        canvas = modalChart;\n                    }\n\n                    // 2. Embedded chart\n                    if (!canvas) {\n                        var embeddedChart = self.container ? self.container.find('.block-adeptus-embedded-chart')[0] : null;\n                        if (embeddedChart) {\n                            canvas = embeddedChart;\n                        }\n                    }\n\n                    // 3. Tab chart (active tab)\n                    if (!canvas) {\n                        var tabChart = self.container ? self.container.find('.tab-pane.active .block-adeptus-tab-chart')[0] : null;\n                        if (tabChart) {\n                            canvas = tabChart;\n                        }\n                    }\n\n                    // 4. Fallback - any visible chart\n                    if (!canvas) {\n                        canvas = document.querySelector('.block-adeptus-modal-chart, .block-adeptus-embedded-chart, .block-adeptus-tab-chart');\n                    }\n\n                    if (!canvas) {\n                        resolve(null);\n                        return;\n                    }\n\n                    try {\n                        var dataUrl = canvas.toDataURL('image/png', 0.8);\n                        if (dataUrl && dataUrl.length > 100 && dataUrl.length < 2000000) {\n                            resolve(dataUrl);\n                        } else {\n                            resolve(null);\n                        }\n                    } catch (e) {\n                        resolve(null);\n                    }\n                }, 300);\n            });\n        },\n\n        /**\n         * Perform the actual export via the main plugin's export endpoint.\n         *\n         * @param {string} format - Export format\n         * @param {Object} report - Report metadata\n         * @param {Array} data - Report data\n         */\n        performExport: function(format, report, data) {\n            var self = this;\n\n            // Prepare report data for export endpoint\n            var headers = data.length > 0 ? Object.keys(data[0]) : [];\n            var reportData = {\n                results: data,\n                headers: headers,\n                report_name: report ? report.name : 'Report',\n                report_category: report ? (report.category || '') : ''\n            };\n\n            // For PDF in chart view, capture chart image first\n            var chartPromise = Promise.resolve(null);\n            if (format === 'pdf' && self.currentView === 'chart') {\n                chartPromise = self.captureChartImage();\n            }\n\n            chartPromise.then(function(chartImage) {\n                // Create form and submit to export endpoint (reliable method)\n                var form = document.createElement('form');\n                form.method = 'POST';\n                form.action = M.cfg.wwwroot + '/report/adeptus_insights/ajax/export_report.php';\n                form.target = '_blank';\n\n                // Add form fields\n                var fields = {\n                    'reportid': report ? report.slug : 'block_export',\n                    'format': format,\n                    'sesskey': M.cfg.sesskey,\n                    'view': self.currentView || 'table',\n                    'report_data': JSON.stringify(reportData),\n                    'chart_image': (chartImage && chartImage.length > 100) ? chartImage : ''\n                };\n\n                for (var key in fields) {\n                    if (fields.hasOwnProperty(key)) {\n                        var input = document.createElement('input');\n                        input.type = 'hidden';\n                        input.name = key;\n                        input.value = fields[key];\n                        form.appendChild(input);\n                    }\n                }\n\n                document.body.appendChild(form);\n                form.submit();\n                document.body.removeChild(form);\n\n                // Track export (soft-fail, don't disrupt user experience)\n                $.ajax({\n                    url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/track_export.php',\n                    method: 'POST',\n                    data: {\n                        format: format,\n                        report_name: report ? report.name : 'Block Export',\n                        sesskey: M.cfg.sesskey\n                    }\n                });\n            });\n        },\n\n        /**\n         * Render table in modal with pagination.\n         *\n         * @param {jQuery} modalBody\n         * @param {Array} data\n         */\n        renderModalTable: function(modalBody, data) {\n            // Reset pagination\n            this.tableCurrentPage = 1;\n            this.tableTotalPages = Math.ceil((data ? data.length : 0) / this.tableRowsPerPage);\n\n            // Build table headers once\n            var table = modalBody.find('.block-adeptus-modal-table');\n            var thead = table.find('thead');\n\n            thead.empty();\n\n            if (!data || data.length === 0) {\n                modalBody.find('.block-adeptus-modal-table-container').addClass('d-none');\n                return;\n            }\n\n            // Build headers from first row\n            var headers = Object.keys(data[0]);\n            var headerRow = $('<tr>');\n            headers.forEach(function(h) {\n                // Format header nicely\n                var formatted = h.replace(/_/g, ' ').replace(/\\b\\w/g, function(l) { return l.toUpperCase(); });\n                headerRow.append($('<th>').text(formatted));\n            });\n            thead.append(headerRow);\n\n            // Render first page\n            this.renderModalTablePage();\n        },\n\n        /**\n         * Render current page of table data.\n         */\n        renderModalTablePage: function() {\n            var modalBody = this.modal.getBody();\n            var data = this.modalData || [];\n            var table = modalBody.find('.block-adeptus-modal-table');\n            var tbody = table.find('tbody');\n\n            tbody.empty();\n\n            if (!data || data.length === 0) {\n                return;\n            }\n\n            var headers = Object.keys(data[0]);\n\n            // Calculate page slice\n            var startIndex = (this.tableCurrentPage - 1) * this.tableRowsPerPage;\n            var endIndex = startIndex + this.tableRowsPerPage;\n            var pageData = data.slice(startIndex, endIndex);\n\n            // Build rows\n            pageData.forEach(function(row) {\n                var tr = $('<tr>');\n                headers.forEach(function(h) {\n                    var val = row[h];\n                    if (val === null || val === undefined) val = '';\n                    // Truncate long values\n                    var displayVal = String(val);\n                    if (displayVal.length > 100) {\n                        displayVal = displayVal.substring(0, 100) + '...';\n                    }\n                    tr.append($('<td>').attr('title', val).text(displayVal));\n                });\n                tbody.append(tr);\n            });\n\n            // Update pagination info and controls\n            var actualEnd = Math.min(endIndex, data.length);\n            modalBody.find('.block-adeptus-row-count').text(data.length + ' total rows');\n\n            var paginationInfo = modalBody.find('.table-pagination-info');\n            paginationInfo.text((startIndex + 1) + '-' + actualEnd + ' of ' + data.length);\n\n            // Update button states\n            modalBody.find('.table-pagination-prev').prop('disabled', this.tableCurrentPage <= 1);\n            modalBody.find('.table-pagination-next').prop('disabled', this.tableCurrentPage >= this.tableTotalPages);\n\n            // Show/hide pagination based on total pages\n            if (this.tableTotalPages > 1) {\n                modalBody.find('.table-pagination').removeClass('d-none');\n            } else {\n                modalBody.find('.table-pagination').addClass('d-none');\n            }\n        },\n\n        /**\n         * Open report in new tab.\n         *\n         * @param {string} slug\n         * @param {string} source\n         */\n        openReportNewTab: function(slug, source) {\n            var url = M.cfg.wwwroot + '/report/adeptus_insights/generated_reports.php?slug=' + encodeURIComponent(slug);\n            window.open(url, '_blank');\n        },\n\n        /**\n         * Expand report inline.\n         *\n         * @param {string} slug\n         * @param {string} source\n         */\n        expandReportInline: function(slug, source) {\n            // TODO: Implement inline expansion.\n        },\n\n        /**\n         * Export report.\n         *\n         * @param {string} format\n         */\n        exportReport: function(format) {\n            // TODO: Implement export functionality.\n            Notification.addNotification({\n                message: 'Export to ' + format.toUpperCase() + ' coming soon',\n                type: 'info'\n            });\n        },\n\n        /**\n         * Refresh the block (clears cache and reloads).\n         */\n        refresh: function() {\n            var refreshBtn = this.container.find('.block-adeptus-refresh i');\n            refreshBtn.addClass('fa-spin');\n\n            // Clear all caches for fresh data\n            this.clearAllCaches();\n\n            // Force reload from server\n            this.showLoading();\n            var self = this;\n            this.waitForAuth(function() {\n                self.fetchReports();\n            });\n\n            setTimeout(function() {\n                refreshBtn.removeClass('fa-spin');\n            }, 1000);\n        },\n\n        /**\n         * Clear all caches.\n         */\n        clearAllCaches: function() {\n            // Clear sessionStorage cache\n            try {\n                sessionStorage.removeItem(this.cacheKey);\n            } catch (e) {\n                // Ignore\n            }\n            // Clear in-memory report data cache\n            this.reportDataCache = {};\n        },\n\n        /**\n         * Setup auto-refresh timer.\n         */\n        setupAutoRefresh: function() {\n            var interval = this.config.autoRefresh;\n            if (!interval || interval === 'never') {\n                return;\n            }\n\n            var ms;\n            switch (interval) {\n                case '5m':\n                    ms = 5 * 60 * 1000;\n                    break;\n                case '15m':\n                    ms = 15 * 60 * 1000;\n                    break;\n                case '30m':\n                    ms = 30 * 60 * 1000;\n                    break;\n                case '1h':\n                    ms = 60 * 60 * 1000;\n                    break;\n                default:\n                    return;\n            }\n\n            var self = this;\n            this.refreshTimer = setInterval(function() {\n                // Only refresh if page is visible.\n                if (!document.hidden) {\n                    self.refresh();\n                }\n            }, ms);\n        },\n\n        /**\n         * Show loading state.\n         */\n        showLoading: function() {\n            this.container.find('.block-adeptus-loading').removeClass('d-none');\n            this.container.find('.block-adeptus-report-list, .block-adeptus-kpi-grid, .block-adeptus-tabs-container, .block-adeptus-content').addClass('d-none');\n            this.container.find('.block-adeptus-empty, .block-adeptus-error').addClass('d-none');\n        },\n\n        /**\n         * Hide loading state.\n         */\n        hideLoading: function() {\n            this.container.find('.block-adeptus-loading').addClass('d-none');\n        },\n\n        /**\n         * Show empty state.\n         */\n        showEmpty: function() {\n            this.hideLoading();\n            this.container.find('.block-adeptus-empty').removeClass('d-none');\n        },\n\n        /**\n         * Show error state.\n         *\n         * @param {string} message\n         */\n        showError: function(message) {\n            this.hideLoading();\n            this.container.find('.block-adeptus-error').removeClass('d-none');\n        },\n\n        /**\n         * Update the timestamp display.\n         */\n        updateTimestamp: function() {\n            if (!this.lastUpdated) {\n                return;\n            }\n\n            var text = this.formatTimeAgo(this.lastUpdated);\n\n            // Handle KPI mode footer (contains both timestamp and refresh)\n            var kpiFooter = this.container.find('.block-adeptus-kpi-footer');\n            if (kpiFooter.length) {\n                kpiFooter.find('.timestamp-text').text(text);\n                kpiFooter.removeClass('d-none');\n                return;\n            }\n\n            // Handle standard timestamp element\n            if (this.config.showTimestamp) {\n                var timestampEl = this.container.find('.block-adeptus-timestamp');\n                timestampEl.find('.timestamp-text').text(text);\n                timestampEl.removeClass('d-none');\n            }\n        },\n\n        /**\n         * Scroll to the top of the report list.\n         */\n        scrollToListTop: function() {\n            var listContainer = this.container.find('.block-adeptus-report-list');\n            if (listContainer.length) {\n                listContainer[0].scrollIntoView({behavior: 'smooth', block: 'start'});\n            }\n        },\n\n        /**\n         * Scroll to the top of the embedded table.\n         */\n        scrollToEmbeddedTableTop: function() {\n            var tableContainer = this.container.find('.block-adeptus-embedded-table-view');\n            if (tableContainer.length) {\n                tableContainer[0].scrollIntoView({behavior: 'smooth', block: 'start'});\n            }\n        },\n\n        /**\n         * Show the embedded loading overlay.\n         */\n        showEmbeddedLoadingOverlay: function() {\n            var overlay = this.container.find('.block-adeptus-embedded-loading-overlay');\n            var content = this.container.find('.block-adeptus-content');\n\n            // Show content area if hidden (to show overlay over it)\n            content.removeClass('d-none');\n\n            // Show overlay with fade\n            overlay.removeClass('d-none').css('opacity', 0).animate({opacity: 1}, 150);\n        },\n\n        /**\n         * Hide the embedded loading overlay.\n         */\n        hideEmbeddedLoadingOverlay: function() {\n            var overlay = this.container.find('.block-adeptus-embedded-loading-overlay');\n            overlay.animate({opacity: 0}, 150, function() {\n                $(this).addClass('d-none');\n            });\n        },\n\n        /**\n         * Toggle searchable dropdown open/closed.\n         *\n         * @param {jQuery} dropdown\n         */\n        toggleSearchableDropdown: function(dropdown) {\n            if (dropdown.hasClass('open')) {\n                this.closeSearchableDropdown(dropdown);\n            } else {\n                this.openSearchableDropdown(dropdown);\n            }\n        },\n\n        /**\n         * Open searchable dropdown.\n         *\n         * @param {jQuery} dropdown\n         */\n        openSearchableDropdown: function(dropdown) {\n            // Close any other open dropdowns first\n            var self = this;\n            this.container.find('.block-adeptus-searchable-dropdown.open').each(function() {\n                if (!$(this).is(dropdown)) {\n                    self.closeSearchableDropdown($(this));\n                }\n            });\n\n            dropdown.addClass('open');\n            dropdown.find('.block-adeptus-searchable-dropdown-toggle').attr('aria-expanded', 'true');\n\n            // Clear search and show all items\n            var input = dropdown.find('.block-adeptus-searchable-dropdown-input');\n            input.val('');\n            dropdown.find('.block-adeptus-searchable-dropdown-item').show().removeClass('focused');\n            dropdown.find('.block-adeptus-searchable-dropdown-empty').addClass('d-none');\n\n            // Focus search input\n            setTimeout(function() {\n                input.focus();\n            }, 50);\n        },\n\n        /**\n         * Close searchable dropdown.\n         *\n         * @param {jQuery} dropdown\n         */\n        closeSearchableDropdown: function(dropdown) {\n            dropdown.removeClass('open');\n            dropdown.find('.block-adeptus-searchable-dropdown-toggle').attr('aria-expanded', 'false');\n            dropdown.find('.block-adeptus-searchable-dropdown-item').removeClass('focused');\n        },\n\n        /**\n         * Filter searchable dropdown items based on search query.\n         *\n         * @param {jQuery} dropdown\n         * @param {string} query\n         */\n        filterSearchableDropdown: function(dropdown, query) {\n            var items = dropdown.find('.block-adeptus-searchable-dropdown-item');\n            var emptyState = dropdown.find('.block-adeptus-searchable-dropdown-empty');\n            var visibleCount = 0;\n\n            items.each(function() {\n                var searchText = $(this).data('search') || '';\n                if (query === '' || searchText.indexOf(query) !== -1) {\n                    $(this).show();\n                    visibleCount++;\n                } else {\n                    $(this).hide();\n                }\n            });\n\n            // Remove focus from hidden items\n            items.filter(':hidden').removeClass('focused');\n\n            // Show/hide empty state\n            if (visibleCount === 0) {\n                emptyState.removeClass('d-none');\n            } else {\n                emptyState.addClass('d-none');\n            }\n        },\n\n        /**\n         * Select an item from the searchable dropdown.\n         *\n         * @param {jQuery} dropdown\n         * @param {string} value\n         * @param {string} text\n         */\n        selectSearchableDropdownItem: function(dropdown, value, text) {\n            // Update display text\n            dropdown.find('.block-adeptus-searchable-dropdown-text').text(text);\n\n            // Mark item as selected\n            dropdown.find('.block-adeptus-searchable-dropdown-item').removeClass('selected');\n            dropdown.find('.block-adeptus-searchable-dropdown-item[data-value=\"' + value + '\"]').addClass('selected');\n\n            // Find the hidden select sibling and trigger change\n            // Works for both category-filter-select and report-selector-select\n            var select = dropdown.siblings('select');\n            if (select.length) {\n                select.val(value).trigger('change');\n            }\n\n            // Close dropdown\n            this.closeSearchableDropdown(dropdown);\n        },\n\n        /**\n         * Scroll a dropdown item into view.\n         *\n         * @param {jQuery} item\n         */\n        scrollDropdownItemIntoView: function(item) {\n            var list = item.closest('.block-adeptus-searchable-dropdown-list');\n            var listHeight = list.height();\n            var itemTop = item.position().top;\n            var itemHeight = item.outerHeight();\n\n            if (itemTop < 0) {\n                list.scrollTop(list.scrollTop() + itemTop);\n            } else if (itemTop + itemHeight > listHeight) {\n                list.scrollTop(list.scrollTop() + (itemTop + itemHeight - listHeight));\n            }\n        },\n\n        /**\n         * Escape HTML special characters.\n         *\n         * @param {string} text\n         * @return {string}\n         */\n        escapeHtml: function(text) {\n            var div = document.createElement('div');\n            div.textContent = text;\n            return div.innerHTML;\n        },\n\n        /**\n         * Format a date as \"X ago\".\n         *\n         * @param {Date} date\n         * @return {string}\n         */\n        formatTimeAgo: function(date) {\n            var seconds = Math.floor((new Date() - date) / 1000);\n\n            if (seconds < 60) {\n                return this.strings.justNow;\n            }\n\n            var minutes = Math.floor(seconds / 60);\n            if (minutes < 60) {\n                return minutes + ' minute' + (minutes !== 1 ? 's' : '') + ' ago';\n            }\n\n            var hours = Math.floor(minutes / 60);\n            if (hours < 24) {\n                return hours + ' hour' + (hours !== 1 ? 's' : '') + ' ago';\n            }\n\n            var days = Math.floor(hours / 24);\n            return days + ' day' + (days !== 1 ? 's' : '') + ' ago';\n        }\n    };\n\n    return {\n        /**\n         * Initialize the block.\n         *\n         * @param {Object} options\n         */\n        init: function(options) {\n            return new BlockController(options);\n        }\n    };\n});\n"],"names":["define","$","Ajax","Notification","Str","ModalFactory","ModalEvents","Templates","Chart","BlockController","options","blockId","blockid","contextId","contextid","config","apiKey","isAdmin","container","reports","lastUpdated","refreshTimer","modal","modalData","modalReport","chartInstance","currentView","listCurrentPage","listItemsPerPage","this","maxLinkItems","listTotalPages","tableCurrentPage","tableRowsPerPage","tableTotalPages","selectedCategory","availableCategories","selectedReportSlug","defaultReport","selectedReportSource","embeddedCurrentView","embeddedTablePage","embeddedTableRowsPerPage","embeddedChartType","embeddedXAxis","embeddedYAxis","backendUrl","cacheKey","cacheTTL","reportDataCache","preloadTimeout","preloadingSlug","tabPaneStates","tabChartInstances","kpiModal","kpiModalChart","kpiModalData","kpiModalDateRange","kpiSnapshotCache","registeredSnapshots","strings","init","prototype","self","length","loadStrings","then","bindEvents","loadReports","setupAutoRefresh","get_strings","key","component","errorAuthFailed","errorCouldNotAuth","errorNoAuthToken","errorReportNotFound","errorConnection","errorFailedLoadReport","errorFailedExecuteReport","errorFailedToLoad","errorQueryFailed","exportNoData","exportNotAvailable","exportVerifyError","noReports","noChange","unknown","justNow","loading","showingXOfY","page","of","vsPrevious","minAgo","hourAgo","hoursAgo","dayAgo","daysAgo","lastRun","exportTitle","exportNotOnPlan","ok","catch","on","e","preventDefault","refresh","slug","data","source","handleReportClick","tabPane","target","attr","loadTabContent","format","exportReport","renderCurrentPage","scrollToListTop","val","displayMode","populateReportSelector","renderReports","selectedValue","parts","split","loadEmbeddedReport","stopPropagation","dropdown","closest","toggleSearchableDropdown","query","toLowerCase","trim","filterSearchableDropdown","value","text","find","selectSearchableDropdownItem","items","focused","first","addClass","next","nextAll","removeClass","scrollDropdownItemIntoView","prev","prevAll","trigger","closeSearchableDropdown","document","each","view","switchEmbeddedView","renderEmbeddedTablePage","scrollToEmbeddedTableTop","totalPages","Math","ceil","embeddedData","renderEmbeddedChart","exportEmbeddedReport","pane","switchTabView","tabId","state","tablePage","renderTabTablePage","rowsPerPage","chartType","renderTabChart","xAxis","yAxis","exportTabReport","clearTimeout","setTimeout","preloadReportData","showLoading","cachedData","getFromCache","Date","waitForAuth","fetchReports","cached","sessionStorage","getItem","JSON","parse","timestamp","now","removeItem","saveToCache","setItem","stringify","report","r","ajax","url","M","cfg","wwwroot","method","reportid","name","report_template_id","sesskey","dataType","timeout","done","response","success","results","chartData","chart_data","chart_type","fail","token","window","adeptusAuthData","api_key","headers","reportData","sqlQuery","sql","sql_query","execution_required","executeReportLocally","params","executionResult","localData","callback","showError","promises","reportSource","push","fetchFromApi","when","apply","allReports","i","result","arguments","fetchesBoth","forEach","endpoint","baseUrl","mode","populateCategoryFilter","filteredReports","filterReports","renderEmbedded","kpiReports","getSelectedReportsForMode","renderKpi","tabsReports","renderTabs","renderLinks","hideLoading","updateTimestamp","showEmpty","selectedConfig","kpiSelectedReports","tabsSelectedReports","item","enrichedReport","Object","assign","icon","customIcon","categoryMap","categoryLocked","reportCategory","catInfo","category_info","color","category","displayName","replace","l","toUpperCase","values","sort","a","b","localeCompare","select","dropdownList","remove","cat","selected","append","empty","allItemHtml","itemHtml","escapeHtml","selectedText","selectedCat","c","hide","reportName","title","display_name","categoryInfo","categoryLabel","defaultOption","prop","firstReport","firstValue","firstName","selectedReport","selectedName","slice","filter","nameA","report_name","nameB","listContainer","template","paginationContainer","startIndex","endIndex","pageReports","html","$item","categoryName","categoryColor","css","actualEnd","formatShowingText","formatPageText","embeddedReport","embeddedChartInstance","renderEmbeddedContent","showEmbeddedLoadingOverlay","hideEmbeddedLoadingOverlay","message","error","contentArea","toLocaleTimeString","populateEmbeddedChartControls","keys","numericCols","detectNumericColumns","xAxisSelect","yAxisSelect","h","formatted","table","thead","tbody","headerRow","min","row","tr","displayVal","String","substring","canvas","destroy","labels","map","label","labelStr","parseFloat","colors","generateChartColors","datasetConfig","backgroundColor","borderWidth","borderColor","type","datasets","responsive","maintainAspectRatio","plugins","legend","display","position","scales","y","beginAtZero","x","getContext","eligible","performExport","showExportUpgradePrompt","addNotification","gridContainer","maxCards","parseInt","kpiColumns","max","cardMap","wizardReports","aiReports","index","card","$card","defaultIcons","iconClass","loadKpiBatch","cardInfo","loadKpiData","reportIds","performance","id","reportids","reportId","renderKpiValue","cardIndex","retryCount","jqXHR","textStatus","status","saveKpiHistoryToServer","formattedValue","valueCol","includes","reduce","sum","formatKpiValue","toFixed","Number","isInteger","toLocaleString","rowCount","executionTimeMs","snapshotsEnabled","postSnapshotToBackend","metricValue","baselinePeriod","historyLimit","getHistoryLimitForBaseline","encodeURIComponent","row_count","execution_time_ms","evaluate_alerts","baseline_period","history","trend","currentValue","registerSnapshotSchedule","updateKpiTrendFromBackend","renderKpiSparklineFromBackend","alerts","triggered_count","handleTriggeredAlerts","triggered","scheduleKey","intervalSeconds","kpiHistoryInterval","call","methodname","args","blockinstanceid","reportslug","reportsource","intervalseconds","rowcount","trendContainer","vs_baseline","vs_previous","updateKpiDualTrend","has_previous","direction","percentage","abs","change_percent","changeText","formatPercentage","vsBaseline","hasBaseline","has_baseline","hasPrevious","baselinePct","baselineIcon","getTrendIcon","baselineSign","previousPct","previousIcon","previousSign","primaryDirection","join","round","formatNumber","num","isNaN","toString","formatTimestamp","date","diffMs","diffMins","floor","diffHours","diffDays","getMonth","getDate","getFullYear","start","end","total","indexOf","current","sparklineData","point","reverse","renderKpiSparklineFromData","triggeredAlerts","reportSlug","alertsConfig","alertsToSend","alert","alertName","alert_name","current_value","actual_value","displayReportName","alertId","alert_id","localConfig","backend_id","severity","thresholdValue","threshold","threshold_value","warningThreshold","warning_value","criticalThreshold","critical_value","is_critical","changeAbs","change_absolute","changePct","report_slug","notify_users","require","sent_count","refreshNotificationArea","$popover","userId","useridto","count","$countContainer","loadKpiSparklineFromServer","updateKpiTrendFromServer","absChange","updateKpiTrend","sparklineContainer","dataPoints","lastValue","trendColor","trendBgColor","chartKey","kpiSparklineCharts","fill","tension","pointRadius","pointHoverRadius","tooltip","enabled","elements","line","borderCapStyle","animation","duration","renderKpiSparkline","tabNav","tabContent","tabTemplate","paneTemplate","tab","firstPane","renderTabContent","updateTabMetaBar","populateTabChartControls","category_name","categoryBadge","category_color","dateStr","updated_at","created_at","toLocaleDateString","header","totalRows","showingText","undefined","renderTabTable","maxRows","tableMaxRows","action","clickAction","alertsFeatureEnabled","openKpiModal","openReportModal","openReportNewTab","expandReportInline","render","create","types","DEFAULT","body","large","bindModalEvents","getRoot","shown","loadModalReport","hidden","show","exception","bindKpiModalEvents","loadKpiModalData","modalRoot","dateRange","modalContent","renderKpiModal","getKpiModalHistoryLimit","showKpiModalError","recorded_at","filteredHistory","filterKpiHistoryByDateRange","renderKpiModalTrends","stats","calculateKpiStats","avg","lastEntry","renderKpiModalChart","cutoffDate","getTime","entry","baselineHtml","previousHtml","formatChartDate","ctx","pointBackgroundColor","pointBorderColor","pointBorderWidth","interaction","intersect","titleColor","bodyColor","padding","displayColors","callbacks","tooltipItems","context","parsed","grid","ticks","maxRotation","minRotation","autoSkip","maxTicksLimit","switchModalView","renderModalChart","exportModalData","renderModalTablePage","modalBody","getBody","renderModalContent","last_executed_at","populateAxisSelectors","renderModalTable","idx","formattedHeader","yAxisOptions","col","isNumeric","every","isFinite","hasNumbers","some","Promise","resolve","reject","contentType","xhr","Error","labelKey","valueKey","valueKeyFormatted","createChartConfig","baseOptions","font","size","weight","top","bottom","baseColors","formatName","captureChartImage","modalChart","querySelector","embeddedChart","tabChart","dataUrl","toDataURL","report_category","chartPromise","chartImage","form","createElement","fields","hasOwnProperty","input","appendChild","submit","removeChild","open","refreshBtn","clearAllCaches","interval","autoRefresh","ms","setInterval","formatTimeAgo","kpiFooter","showTimestamp","timestampEl","scrollIntoView","behavior","block","tableContainer","overlay","animate","opacity","hasClass","openSearchableDropdown","is","focus","emptyState","visibleCount","searchText","siblings","list","listHeight","height","itemTop","itemHeight","outerHeight","scrollTop","div","textContent","innerHTML","seconds","minutes","hours","days"],"mappings":"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"}