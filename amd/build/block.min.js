/**
 * Main JavaScript controller for the Adeptus Insights block.
 *
 * @module     block_adeptus_insights/block
 * @copyright  2025 Adeptus Analytics
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("block_adeptus_insights/block",["jquery","core/ajax","core/notification","core/str","core/modal_factory","core/modal_events","core/templates","core/chartjs"],(function($,Ajax,Notification,Str,ModalFactory,ModalEvents,Templates,Chart){var BlockController=function(options){this.blockId=options.blockid,this.contextId=options.contextid,this.config=options.config||{},this.apiKey=options.apiKey||"",this.isAdmin=options.isAdmin||!1,this.container=null,this.reports=[],this.lastUpdated=null,this.refreshTimer=null,this.modal=null,this.modalData=null,this.modalReport=null,this.chartInstance=null,this.currentView="table",this.listCurrentPage=1,this.listItemsPerPage=this.config.maxLinkItems||10,this.listTotalPages=1,this.tableCurrentPage=1,this.tableRowsPerPage=25,this.tableTotalPages=1,this.selectedCategory="",this.availableCategories=[],this.selectedReportSlug=this.config.defaultReport||"",this.selectedReportSource="",this.cacheKey="adeptus_block_reports_"+this.blockId,this.cacheTTL=3e5,this.reportDataCache={},this.preloadTimeout=null,this.preloadingSlug=null,this.init()};return BlockController.prototype={init:function(){this.container=$('[data-blockid="'+this.blockId+'"]'),this.container.length&&(this.bindEvents(),this.loadReports(),this.setupAutoRefresh())},bindEvents:function(){var self=this;this.container.on("click",".block-adeptus-refresh, .block-adeptus-retry",(function(e){e.preventDefault(),self.refresh()})),this.container.on("click",".block-adeptus-report-item",(function(e){e.preventDefault();var slug=$(this).data("slug"),source=$(this).data("source");self.handleReportClick(slug,source)})),this.container.on("keydown",".block-adeptus-report-item",(function(e){if("Enter"===e.key||" "===e.key){e.preventDefault();var slug=$(this).data("slug"),source=$(this).data("source");self.handleReportClick(slug,source)}})),this.container.on("click",".block-adeptus-kpi-card",(function(e){e.preventDefault();var slug=$(this).data("slug"),source=$(this).data("source");self.handleReportClick(slug,source)})),this.container.on("shown.bs.tab",".block-adeptus-tab-nav a",(function(e){var tabPane=$($(e.target).attr("href")),slug=tabPane.data("slug"),source=tabPane.data("source");tabPane.data("loaded")||self.loadTabContent(tabPane,slug,source)})),this.container.on("click",".block-adeptus-export",(function(e){e.preventDefault();var format=$(this).data("format");self.exportReport(format)})),this.container.on("click",".pagination-prev",(function(e){e.preventDefault(),self.listCurrentPage>1&&(self.listCurrentPage--,self.renderCurrentPage(),self.scrollToListTop())})),this.container.on("click",".pagination-next",(function(e){e.preventDefault(),self.listCurrentPage<self.listTotalPages&&(self.listCurrentPage++,self.renderCurrentPage(),self.scrollToListTop())})),this.container.on("change",".category-filter-select",(function(){self.selectedCategory=$(this).val(),self.listCurrentPage=1,"embedded"===self.config.displayMode?self.populateReportSelector():self.renderReports()})),this.container.on("change",".report-selector-select",(function(){var selectedValue=$(this).val();if(selectedValue){var parts=selectedValue.split("::"),slug=parts[0],source=parts[1]||"wizard";self.selectedReportSlug=slug,self.selectedReportSource=source,self.loadEmbeddedReport(slug,source)}})),this.container.on("mouseenter",".block-adeptus-report-item",(function(){var slug=$(this).data("slug"),source=$(this).data("source");self.preloadTimeout&&clearTimeout(self.preloadTimeout),self.preloadTimeout=setTimeout((function(){self.preloadReportData(slug,source)}),300)})),this.container.on("mouseleave",".block-adeptus-report-item",(function(){self.preloadTimeout&&(clearTimeout(self.preloadTimeout),self.preloadTimeout=null)}))},loadReports:function(){var self=this;this.showLoading();var cachedData=this.getFromCache();if(cachedData)return this.reports=cachedData,this.lastUpdated=new Date,void this.renderReports();this.waitForAuth((function(){self.fetchReports()}))},getFromCache:function(){try{var cached=sessionStorage.getItem(this.cacheKey);if(cached){var data=JSON.parse(cached);if(data.timestamp&&Date.now()-data.timestamp<this.cacheTTL)return data.reports;sessionStorage.removeItem(this.cacheKey)}}catch(e){}return null},saveToCache:function(reports){try{sessionStorage.setItem(this.cacheKey,JSON.stringify({timestamp:Date.now(),reports:reports}))}catch(e){}},preloadReportData:function(slug,source){var self=this,cacheKey=slug+"_"+source;if(!this.reportDataCache[cacheKey]&&this.preloadingSlug!==slug){this.preloadingSlug=slug;var report=this.reports.find((function(r){return r.slug===slug}));if(report)if("wizard"===source)$.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/generate_report.php",method:"POST",data:{reportid:report.name||report.report_template_id,sesskey:M.cfg.sesskey},dataType:"json",timeout:3e4}).done((function(response){response.success&&(self.reportDataCache[cacheKey]={report:report,results:response.results||[],chartData:response.chart_data,chartType:response.chart_type}),self.preloadingSlug=null})).fail((function(){self.preloadingSlug=null}));else{var token=this.apiKey||(window.adeptusAuthData?window.adeptusAuthData.api_key:null);if(!token)return;$.ajax({url:"https://a360backend.stagingwithswift.com/api/v1/ai-reports/"+slug,method:"GET",headers:{Authorization:"Bearer "+token,Accept:"application/json"},timeout:15e3}).done((function(response){response.success&&response.report&&(self.reportDataCache[cacheKey]={report:response.report,results:response.data||[],chartData:null,chartType:null}),self.preloadingSlug=null})).fail((function(){self.preloadingSlug=null}))}}},waitForAuth:function(callback){var self=this;if(this.apiKey)return window.adeptusAuthData=window.adeptusAuthData||{},window.adeptusAuthData.api_key=this.apiKey,void callback();window.adeptusAuthData&&window.adeptusAuthData.api_key?callback():$.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/get_auth_status.php",method:"GET",dataType:"json",timeout:1e4}).done((function(response){response&&response.success&&response.data?(window.adeptusAuthData=response.data,callback()):self.showError("Authentication failed")})).fail((function(){self.showError("Could not authenticate")}))},fetchReports:function(){var self=this,token=this.apiKey||(window.adeptusAuthData?window.adeptusAuthData.api_key:null);if(token){var promises=[],source=this.config.reportSource||"all";"all"!==source&&"wizard"!==source||promises.push(this.fetchFromApi("/wizard-reports",token)),"all"!==source&&"ai"!==source||promises.push(this.fetchFromApi("/ai-reports",token)),$.when.apply($,promises).then((function(){for(var allReports=[],i=0;i<promises.length;i++){var result,reports=(result=1===promises.length?arguments[0]:arguments[i][0]).reports||result.data||[];if(reports&&reports.length){var reportSource="ai"===source||1===i&&"all"===source?"ai":"wizard";reports.forEach((function(report){report.source=report.source||reportSource,allReports.push(report)}))}}self.reports=allReports,self.lastUpdated=new Date,self.saveToCache(allReports),self.renderReports()})).fail((function(){self.showError()}))}else this.showError("No authentication token")},fetchFromApi:function(endpoint,token){return $.ajax({url:"https://a360backend.stagingwithswift.com/api/v1"+endpoint,method:"GET",headers:{Authorization:"Bearer "+token,"Content-Type":"application/json",Accept:"application/json"},timeout:15e3})},renderReports:function(){var mode=this.config.displayMode||"links";if(0!==this.reports.length){this.populateCategoryFilter();var reports=this.filterReports();switch(mode){case"embedded":this.renderEmbedded(reports);break;case"kpi":this.renderKpi(reports);break;case"tabs":this.renderTabs(reports);break;default:this.renderLinks(reports)}this.hideLoading(),this.updateTimestamp()}else this.showEmpty()},populateCategoryFilter:function(){var self=this,categoryMap={};this.reports.forEach((function(report){var catInfo=report.category_info;catInfo&&catInfo.slug?categoryMap[catInfo.slug]={slug:catInfo.slug,name:catInfo.name||catInfo.slug,color:catInfo.color||"#6c757d"}:report.category&&(categoryMap[report.category]={slug:report.category,name:report.category,color:"#6c757d"})})),this.availableCategories=Object.values(categoryMap).sort((function(a,b){return a.name.localeCompare(b.name)}));var select=this.container.find(".category-filter-select");select.length&&(select.find("option:not(:first)").remove(),this.availableCategories.forEach((function(cat){var selected=self.selectedCategory===cat.slug?" selected":"";select.append('<option value="'+cat.slug+'"'+selected+">"+cat.name+"</option>")})))},populateReportSelector:function(){var self=this,select=this.container.find(".report-selector-select");if(select.length){var reports=this.filterReports();if(select.find("option:not(:first)").remove(),reports.forEach((function(report){var reportName=report.name||report.title||report.display_name||report.slug||"Untitled",value=report.slug+"::"+report.source,categoryLabel=report.category_info?" ["+report.category_info.name+"]":"",selected=self.selectedReportSlug===report.slug?" selected":"";select.append('<option value="'+value+'"'+selected+">"+reportName+categoryLabel+"</option>")})),this.selectedReportSlug&&!select.val()){var defaultOption=select.find('option[value^="'+this.selectedReportSlug+'::"]');defaultOption.length&&defaultOption.prop("selected",!0)}if(!select.val()&&reports.length>0){var firstReport=reports[0],firstValue=firstReport.slug+"::"+firstReport.source;select.val(firstValue),this.selectedReportSlug=firstReport.slug,this.selectedReportSource=firstReport.source,this.loadEmbeddedReport(firstReport.slug,firstReport.source)}else if(select.val()){var parts=select.val().split("::");this.loadEmbeddedReport(parts[0],parts[1]||"wizard")}else this.showEmpty()}},filterReports:function(){var self=this,reports=this.reports.slice(),config=this.config;if(this.selectedCategory&&(reports=reports.filter((function(r){return(r.category_info?r.category_info.slug:r.category||"")===self.selectedCategory}))),"manual"===config.reportSource&&config.selectedReports&&config.selectedReports.length){var selected=config.selectedReports;reports=reports.filter((function(r){return-1!==selected.indexOf(r.slug)}))}return reports.sort((function(a,b){var nameA=a.name||a.title||a.display_name||a.report_name||a.slug||"",nameB=b.name||b.title||b.display_name||b.report_name||b.slug||"";return nameA.localeCompare(nameB)})),reports},renderLinks:function(reports){this.filteredReports=reports,this.listItemsPerPage=this.config.maxLinkItems||10,this.listTotalPages=Math.ceil(reports.length/this.listItemsPerPage),this.listCurrentPage=1,this.renderCurrentPage()},renderCurrentPage:function(){var reports=this.filteredReports||[],listContainer=this.container.find(".block-adeptus-report-list"),template=$("#block-adeptus-report-item-template-"+this.blockId),paginationContainer=this.container.find(".block-adeptus-pagination"),startIndex=(this.listCurrentPage-1)*this.listItemsPerPage,endIndex=startIndex+this.listItemsPerPage,pageReports=reports.slice(startIndex,endIndex);if(listContainer.empty(),pageReports.forEach((function(report){var item=template.html(),$item=$(item);$item.attr("data-slug",report.slug),$item.attr("data-source",report.source);var reportName=report.name||report.title||report.display_name||report.report_name||report.slug||"Untitled Report";$item.find(".report-item-name").text(reportName);var categoryName=report.category_info?report.category_info.name:report.category||"General",categoryColor=report.category_info?report.category_info.color:"#6c757d";$item.find(".report-item-category").text(categoryName).css("background-color",categoryColor).css("color","#fff"),listContainer.append($item)})),listContainer.removeClass("d-none"),this.listTotalPages>1){var actualEnd=startIndex+pageReports.length;paginationContainer.find(".pagination-showing").text("Showing "+(startIndex+1)+"-"+actualEnd+" of "+reports.length),paginationContainer.find(".pagination-pages").text("Page "+this.listCurrentPage+" of "+this.listTotalPages),paginationContainer.find(".pagination-prev").prop("disabled",this.listCurrentPage<=1),paginationContainer.find(".pagination-next").prop("disabled",this.listCurrentPage>=this.listTotalPages),paginationContainer.removeClass("d-none")}else paginationContainer.addClass("d-none")},renderEmbedded:function(reports){this.embeddedReport=null,this.embeddedData=null,this.embeddedChartInstance=null,this.populateReportSelector(),0===this.reports.length&&this.showEmpty()},loadEmbeddedReport:function(slug,source){var self=this,cacheKey=slug+"_"+source;if(this.reportDataCache[cacheKey]){var cached=this.reportDataCache[cacheKey];return this.embeddedData=cached.results,void this.renderEmbeddedContent(cached.report,cached.results)}var report=this.reports.find((function(r){return r.slug===slug}));if(report)if("wizard"===source)$.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/generate_report.php",method:"POST",data:{reportid:report.name||report.report_template_id,sesskey:M.cfg.sesskey},dataType:"json",timeout:3e4}).done((function(response){response.success?(self.reportDataCache[cacheKey]={report:report,results:response.results||[],chartData:response.chart_data,chartType:response.chart_type},self.embeddedData=response.results||[],self.renderEmbeddedContent(report,response.results||[])):self.showError(response.message||"Failed to load report")})).fail((function(){self.showError("Connection error")}));else{var token=this.apiKey||(window.adeptusAuthData?window.adeptusAuthData.api_key:null);if(!token)return void this.showError("No authentication token");$.ajax({url:"https://a360backend.stagingwithswift.com/api/v1/ai-reports/"+slug,method:"GET",headers:{Authorization:"Bearer "+token,Accept:"application/json"},timeout:15e3}).done((function(response){response.success&&response.report?(self.reportDataCache[cacheKey]={report:response.report,results:response.data||[],chartData:null,chartType:null},self.embeddedData=response.data||[],self.renderEmbeddedContent(response.report,response.data||[])):self.showError("Failed to load report")})).fail((function(){self.showError("Connection error")}))}else this.showError("Report not found")},renderEmbeddedContent:function(report,data){var contentArea=this.container.find(".block-adeptus-content");if(data&&0!==data.length){var reportName=report.name||report.title||report.display_name||report.slug||"Report";this.container.find(".report-name").text(reportName);var category=report.category_info||{name:"General",color:"#6c757d"};this.container.find(".report-category").text(category.name).css("background-color",category.color).css("color","#fff").removeClass("d-none"),this.config.showChart?(this.renderEmbeddedChart(report,data),this.container.find(".block-adeptus-chart-container").removeClass("d-none")):this.container.find(".block-adeptus-chart-container").addClass("d-none"),this.config.showTable?(this.renderEmbeddedTable(data),this.container.find(".block-adeptus-table-container").removeClass("d-none")):this.container.find(".block-adeptus-table-container").addClass("d-none"),contentArea.removeClass("d-none"),this.hideLoading(),this.updateTimestamp()}else this.showEmpty()},renderEmbeddedChart:function(report,data){var chartContainer=this.container.find(".block-adeptus-chart-container"),canvas=chartContainer.find(".block-adeptus-chart")[0];if(canvas&&data&&0!==data.length){this.embeddedChartInstance&&(this.embeddedChartInstance.destroy(),this.embeddedChartInstance=null);var headers=Object.keys(data[0]),numericCols=this.detectNumericColumns(data,headers),labelKey=headers[0],valueKey=numericCols.length>0?numericCols[numericCols.length-1]:headers[headers.length-1],valueKeyFormatted=valueKey.replace(/_/g," ").replace(/\b\w/g,(function(l){return l.toUpperCase()})),chartData=data.slice(0,20),labels=chartData.map((function(row){var label=row[labelKey];if(null==label)return"Unknown";var labelStr=String(label);return labelStr.length>20?labelStr.substring(0,20)+"...":labelStr})),values=chartData.map((function(row){return parseFloat(row[valueKey])||0})),colors=this.generateChartColors(values.length,"bar"),config={type:"bar",data:{labels:labels,datasets:[{label:valueKeyFormatted,data:values,backgroundColor:colors[0],borderColor:colors[0].replace("0.7","1"),borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0},x:{display:data.length<=10}}}};try{this.embeddedChartInstance=new Chart(canvas.getContext("2d"),config),chartContainer.removeClass("d-none")}catch(error){chartContainer.html('<div class="alert alert-warning text-center"><i class="fa fa-exclamation-circle"></i> Could not render chart</div>')}}else chartContainer.addClass("d-none")},renderEmbeddedTable:function(data){var table=this.container.find(".block-adeptus-table"),thead=table.find("thead"),tbody=table.find("tbody"),maxRows=this.config.tableMaxRows||10;if(thead.empty(),tbody.empty(),data&&0!==data.length){var headers=Object.keys(data[0]),headerRow=$("<tr>");headers.forEach((function(h){var formatted=h.replace(/_/g," ").replace(/\b\w/g,(function(l){return l.toUpperCase()}));headerRow.append($("<th>").text(formatted))})),thead.append(headerRow),data.slice(0,maxRows).forEach((function(row){var tr=$("<tr>");headers.forEach((function(h){var val=row[h];null==val&&(val="");var displayVal=String(val);displayVal.length>50&&(displayVal=displayVal.substring(0,50)+"..."),tr.append($("<td>").attr("title",val).text(displayVal))})),tbody.append(tr)}));var countText="Showing "+Math.min(data.length,maxRows)+" of "+data.length+" rows";this.container.find(".block-adeptus-row-count").text(countText),this.container.find(".block-adeptus-table-container").removeClass("d-none")}else this.container.find(".block-adeptus-table-container").addClass("d-none")},renderKpi:function(reports){var self=this,gridContainer=this.container.find(".block-adeptus-kpi-grid"),template=$("#block-adeptus-kpi-card-template-"+this.blockId),maxCards=parseInt(this.config.kpiColumns,10)||2;maxCards=Math.min(2*maxCards,4),gridContainer.empty(),reports.slice(0,maxCards).forEach((function(report,index){var card=template.html(),$card=$(card),reportName=report.name||report.title||report.display_name||report.slug||"Metric";$card.attr("data-slug",report.slug),$card.attr("data-source",report.source),$card.find(".kpi-card-label").text(reportName),$card.find(".kpi-card-value").html('<i class="fa fa-spinner fa-spin"></i>'),$card.find(".kpi-card-trend").addClass("d-none"),$card.find(".kpi-card-sparkline").addClass("d-none");var icons=["fa-users","fa-graduation-cap","fa-clock","fa-check-circle"];$card.find(".kpi-card-icon i").removeClass("fa-chart-line").addClass(icons[index%icons.length]),gridContainer.append($card),self.loadKpiData(report,$card)})),gridContainer.removeClass("d-none")},loadKpiData:function(report,$card){var self=this,cacheKey=report.slug+"_"+report.source;if(this.reportDataCache[cacheKey]){var cached=this.reportDataCache[cacheKey];this.renderKpiValue($card,cached.results)}else if("wizard"===report.source)$.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/generate_report.php",method:"POST",data:{reportid:report.name||report.report_template_id,sesskey:M.cfg.sesskey},dataType:"json",timeout:15e3}).done((function(response){response.success?(self.reportDataCache[cacheKey]={report:report,results:response.results||[]},self.renderKpiValue($card,response.results||[])):$card.find(".kpi-card-value").text("--")})).fail((function(){$card.find(".kpi-card-value").text("--")}));else{var token=this.apiKey||(window.adeptusAuthData?window.adeptusAuthData.api_key:null);if(!token)return void $card.find(".kpi-card-value").text("--");$.ajax({url:"https://a360backend.stagingwithswift.com/api/v1/ai-reports/"+report.slug,method:"GET",headers:{Authorization:"Bearer "+token,Accept:"application/json"},timeout:15e3}).done((function(response){response.success&&response.data?(self.reportDataCache[cacheKey]={report:response.report||report,results:response.data||[]},self.renderKpiValue($card,response.data||[])):$card.find(".kpi-card-value").text("--")})).fail((function(){$card.find(".kpi-card-value").text("--")}))}},renderKpiValue:function($card,data){if(data&&0!==data.length){var value,formattedValue,headers=Object.keys(data[0]),numericCols=this.detectNumericColumns(data,headers);if(numericCols.length>0){var valueCol=numericCols[numericCols.length-1];value=valueCol.toLowerCase().includes("count")||valueCol.toLowerCase().includes("total")||1===data.length?data.reduce((function(sum,row){return sum+(parseFloat(row[valueCol])||0)}),0):data.length}else value=data.length;formattedValue=value>=1e6?(value/1e6).toFixed(1)+"M":value>=1e3?(value/1e3).toFixed(1)+"K":Number.isInteger(value)?value.toLocaleString():value.toFixed(1),$card.find(".kpi-card-value").text(formattedValue);var trendContainer=$card.find(".kpi-card-trend");trendContainer.removeClass("d-none trend-up trend-down trend-neutral"),trendContainer.addClass("trend-neutral"),trendContainer.find(".trend-icon").html('<i class="fa fa-minus"></i>'),trendContainer.find(".trend-value").text("vs previous")}else $card.find(".kpi-card-value").text("0")},renderTabs:function(reports){var self=this,tabNav=this.container.find(".block-adeptus-tab-nav"),tabContent=this.container.find(".block-adeptus-tab-content"),tabTemplate=$("#block-adeptus-tab-template-"+this.blockId),paneTemplate=$("#block-adeptus-tab-pane-template-"+this.blockId);if(tabNav.empty(),tabContent.empty(),this.tabChartInstances={},reports.slice(0,5).forEach((function(report,index){var tabId="tab-"+self.blockId+"-"+index,reportName=report.name||report.title||report.display_name||report.slug||"Report",tab=$(tabTemplate.html());tab.find("a").attr("href","#"+tabId).attr("aria-controls",tabId),tab.find(".tab-name").text(reportName),0===index&&tab.find("a").addClass("active").attr("aria-selected","true"),tabNav.append(tab);var pane=$(paneTemplate.html());pane.attr("id",tabId),pane.attr("data-slug",report.slug),pane.attr("data-source",report.source),0===index&&pane.addClass("show active"),tabContent.append(pane)})),reports.length>0){var firstPane=tabContent.find(".tab-pane").first();this.loadTabContent(firstPane,reports[0].slug,reports[0].source)}this.container.find(".block-adeptus-tabs-container").removeClass("d-none")},loadTabContent:function(pane,slug,source){var self=this,cacheKey=slug+"_"+source;if(pane.data("loaded",!0),this.reportDataCache[cacheKey]){var cached=this.reportDataCache[cacheKey];this.renderTabContent(pane,cached.report,cached.results)}else{var report=this.reports.find((function(r){return r.slug===slug}));if(!report)return pane.find(".tab-pane-loading").addClass("d-none"),void pane.find(".tab-pane-content").removeClass("d-none").html('<div class="text-center text-muted py-4"><i class="fa fa-exclamation-circle"></i><p class="mt-2">Report not found</p></div>');if("wizard"===source)$.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/generate_report.php",method:"POST",data:{reportid:report.name||report.report_template_id,sesskey:M.cfg.sesskey},dataType:"json",timeout:3e4}).done((function(response){response.success?(self.reportDataCache[cacheKey]={report:report,results:response.results||[]},self.renderTabContent(pane,report,response.results||[])):(pane.find(".tab-pane-loading").addClass("d-none"),pane.find(".tab-pane-content").removeClass("d-none").html('<div class="text-center text-muted py-4"><i class="fa fa-exclamation-circle"></i><p class="mt-2">'+(response.message||"Failed to load")+"</p></div>"))})).fail((function(){pane.find(".tab-pane-loading").addClass("d-none"),pane.find(".tab-pane-content").removeClass("d-none").html('<div class="text-center text-muted py-4"><i class="fa fa-exclamation-circle"></i><p class="mt-2">Connection error</p></div>')}));else{var token=this.apiKey||(window.adeptusAuthData?window.adeptusAuthData.api_key:null);if(!token)return pane.find(".tab-pane-loading").addClass("d-none"),void pane.find(".tab-pane-content").removeClass("d-none").html('<div class="text-center text-muted py-4"><i class="fa fa-exclamation-circle"></i><p class="mt-2">Authentication required</p></div>');$.ajax({url:"https://a360backend.stagingwithswift.com/api/v1/ai-reports/"+slug,method:"GET",headers:{Authorization:"Bearer "+token,Accept:"application/json"},timeout:15e3}).done((function(response){response.success?(self.reportDataCache[cacheKey]={report:response.report||report,results:response.data||[]},self.renderTabContent(pane,response.report||report,response.data||[])):(pane.find(".tab-pane-loading").addClass("d-none"),pane.find(".tab-pane-content").removeClass("d-none").html('<div class="text-center text-muted py-4"><i class="fa fa-exclamation-circle"></i><p class="mt-2">Failed to load report</p></div>'))})).fail((function(){pane.find(".tab-pane-loading").addClass("d-none"),pane.find(".tab-pane-content").removeClass("d-none").html('<div class="text-center text-muted py-4"><i class="fa fa-exclamation-circle"></i><p class="mt-2">Connection error</p></div>')}))}}},renderTabContent:function(pane,report,data){pane.find(".tab-pane-loading").addClass("d-none");var contentArea=pane.find(".tab-pane-content");if(data&&0!==data.length){var html="";this.config.showChart&&(html+='<div class="tab-chart-container" style="height: '+(this.config.chartHeight||200)+'px;"><canvas class="tab-chart"></canvas></div>'),this.config.showTable&&(html+='<div class="tab-table-container mt-2"><div class="table-responsive"><table class="table table-sm table-striped"><thead></thead><tbody></tbody></table></div></div>'),contentArea.html(html).removeClass("d-none"),this.config.showChart&&this.renderTabChart(pane,report,data),this.config.showTable&&this.renderTabTable(pane,data)}else contentArea.removeClass("d-none").html('<div class="text-center text-muted py-4"><i class="fa fa-inbox"></i><p class="mt-2">No data available</p></div>')},renderTabChart:function(pane,report,data){var tabId=pane.attr("id"),canvas=pane.find(".tab-chart")[0];if(canvas&&data&&0!==data.length){this.tabChartInstances&&this.tabChartInstances[tabId]&&this.tabChartInstances[tabId].destroy();var headers=Object.keys(data[0]),numericCols=this.detectNumericColumns(data,headers),labelKey=headers[0],valueKey=numericCols.length>0?numericCols[numericCols.length-1]:headers[headers.length-1],valueKeyFormatted=valueKey.replace(/_/g," ").replace(/\b\w/g,(function(l){return l.toUpperCase()})),chartData=data.slice(0,15),labels=chartData.map((function(row){var label=row[labelKey];if(null==label)return"Unknown";var labelStr=String(label);return labelStr.length>15?labelStr.substring(0,15)+"...":labelStr})),values=chartData.map((function(row){return parseFloat(row[valueKey])||0})),colors=this.generateChartColors(values.length,"bar"),config={type:"bar",data:{labels:labels,datasets:[{label:valueKeyFormatted,data:values,backgroundColor:colors[0],borderColor:colors[0].replace("0.7","1"),borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0},x:{display:data.length<=8}}}};try{this.tabChartInstances=this.tabChartInstances||{},this.tabChartInstances[tabId]=new Chart(canvas.getContext("2d"),config)}catch(error){pane.find(".tab-chart-container").html('<div class="alert alert-warning text-center"><i class="fa fa-exclamation-circle"></i> Could not render chart</div>')}}},renderTabTable:function(pane,data){var table=pane.find("table"),thead=table.find("thead"),tbody=table.find("tbody"),maxRows=this.config.tableMaxRows||10;if(thead.empty(),tbody.empty(),data&&0!==data.length){var headers=Object.keys(data[0]),headerRow=$("<tr>");headers.forEach((function(h){var formatted=h.replace(/_/g," ").replace(/\b\w/g,(function(l){return l.toUpperCase()}));headerRow.append($("<th>").text(formatted))})),thead.append(headerRow),data.slice(0,maxRows).forEach((function(row){var tr=$("<tr>");headers.forEach((function(h){var val=row[h];null==val&&(val="");var displayVal=String(val);displayVal.length>40&&(displayVal=displayVal.substring(0,40)+"..."),tr.append($("<td>").attr("title",val).text(displayVal))})),tbody.append(tr)}))}},handleReportClick:function(slug,source){switch(this.config.clickAction||"modal"){case"modal":this.openReportModal(slug,source);break;case"newtab":this.openReportNewTab(slug,source);break;case"expand":this.expandReportInline(slug,source)}},openReportModal:function(slug,source){var self=this,report=this.reports.find((function(r){return r.slug===slug}));report&&(this.modalData=null,this.modalReport=null,this.currentView="table",this.chartInstance&&(this.chartInstance.destroy(),this.chartInstance=null),Templates.render("block_adeptus_insights/report_modal",{blockid:this.blockId}).then((function(html){return ModalFactory.create({type:ModalFactory.types.DEFAULT,title:report.name,body:html,large:!0})})).then((function(modal){return self.modal=modal,self.bindModalEvents(modal),modal.getRoot().on(ModalEvents.shown,(function(){self.loadModalReport(slug,source)})),modal.getRoot().on(ModalEvents.hidden,(function(){self.chartInstance&&(self.chartInstance.destroy(),self.chartInstance=null),modal.destroy(),self.modal=null,self.modalData=null,self.modalReport=null})),modal.show(),modal})).catch(Notification.exception))},bindModalEvents:function(modal){var self=this,modalRoot=modal.getRoot();modalRoot.on("click",".view-toggle-btn",(function(e){e.preventDefault();var view=$(this).data("view");self.switchModalView(view)})),modalRoot.on("change","#modal-chart-type, #modal-chart-x-axis, #modal-chart-y-axis",(function(){"chart"===self.currentView&&self.renderModalChart()})),modalRoot.on("click",".modal-retry",(function(e){e.preventDefault(),self.modalReport&&self.loadModalReport(self.modalReport.slug,self.modalReport.source)})),modalRoot.on("click",'.modal-export[data-format="csv"]',(function(e){e.preventDefault(),self.exportModalData("csv")})),modalRoot.on("click",".table-pagination-prev",(function(e){e.preventDefault(),self.tableCurrentPage>1&&(self.tableCurrentPage--,self.renderModalTablePage())})),modalRoot.on("click",".table-pagination-next",(function(e){e.preventDefault(),self.tableCurrentPage<self.tableTotalPages&&(self.tableCurrentPage++,self.renderModalTablePage())}))},switchModalView:function(view){var modalBody=this.modal.getBody();modalBody.find(".view-toggle-btn").removeClass("active"),modalBody.find('.view-toggle-btn[data-view="'+view+'"]').addClass("active"),"table"===view?(modalBody.find("#modal-table-view").removeClass("d-none"),modalBody.find("#modal-chart-view").addClass("d-none")):(modalBody.find("#modal-table-view").addClass("d-none"),modalBody.find("#modal-chart-view").removeClass("d-none"),this.renderModalChart()),this.currentView=view},loadModalReport:function(slug,source){var self=this,modalBody=this.modal.getBody(),cacheKey=slug+"_"+source;if(this.reportDataCache[cacheKey]){var cached=this.reportDataCache[cacheKey];return modalBody.find(".modal-loading").addClass("d-none"),void this.renderModalContent(modalBody,cached.report,cached.results,cached.chartData,cached.chartType)}var report=this.reports.find((function(r){return r.slug===slug}));if(!report)return modalBody.find(".modal-loading").addClass("d-none"),void modalBody.find(".modal-error").removeClass("d-none");if("wizard"===source)$.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/generate_report.php",method:"POST",data:{reportid:report.name||report.report_template_id,sesskey:M.cfg.sesskey},dataType:"json",timeout:3e4}).done((function(response){modalBody.find(".modal-loading").addClass("d-none"),response.success?(self.reportDataCache[cacheKey]={report:report,results:response.results||[],chartData:response.chart_data,chartType:response.chart_type},self.renderModalContent(modalBody,report,response.results||[],response.chart_data,response.chart_type)):(modalBody.find(".modal-error").removeClass("d-none"),modalBody.find(".modal-error p").text(response.message||"Failed to load report"))})).fail((function(){modalBody.find(".modal-loading").addClass("d-none"),modalBody.find(".modal-error").removeClass("d-none")}));else{var token=this.apiKey||(window.adeptusAuthData?window.adeptusAuthData.api_key:null);if(!token)return modalBody.find(".modal-loading").addClass("d-none"),void modalBody.find(".modal-error").removeClass("d-none");$.ajax({url:"https://a360backend.stagingwithswift.com/api/v1/ai-reports/"+slug,method:"GET",headers:{Authorization:"Bearer "+token,Accept:"application/json"},timeout:15e3}).done((function(response){modalBody.find(".modal-loading").addClass("d-none"),response.success&&response.report?(self.reportDataCache[cacheKey]={report:response.report,results:response.data||[],chartData:null,chartType:null},self.renderModalContent(modalBody,response.report,response.data||[],null,null)):modalBody.find(".modal-error").removeClass("d-none")})).fail((function(){modalBody.find(".modal-loading").addClass("d-none"),modalBody.find(".modal-error").removeClass("d-none")}))}},renderModalContent:function(modalBody,report,data,chartData,chartType){this.modalData=data||[],this.modalReport=report,modalBody.find(".modal-content-area").removeClass("d-none");var category=report.category_info||{name:"General",color:"#6c757d"};if(modalBody.find(".report-category").text(category.name).css("background-color",category.color),modalBody.find(".row-count-num").text(this.modalData.length),modalBody.find(".report-date").text(report.last_executed_at?"Last run: "+new Date(report.last_executed_at).toLocaleDateString():""),this.populateAxisSelectors(modalBody),this.renderModalTable(modalBody,this.modalData),this.isAdmin){var reportUrl=M.cfg.wwwroot+"/report/adeptus_insights/generated_reports.php?slug="+encodeURIComponent(report.slug);modalBody.find(".view-full-report").attr("href",reportUrl),modalBody.find(".modal-footer-link").removeClass("d-none")}else modalBody.find(".modal-footer-link").addClass("d-none");this.currentView="table",modalBody.find(".view-toggle-btn").removeClass("active"),modalBody.find('.view-toggle-btn[data-view="table"]').addClass("active"),modalBody.find("#modal-table-view").removeClass("d-none"),modalBody.find("#modal-chart-view").addClass("d-none")},populateAxisSelectors:function(modalBody){var data=this.modalData;if(data&&0!==data.length){var headers=Object.keys(data[0]),xAxisSelect=modalBody.find("#modal-chart-x-axis"),yAxisSelect=modalBody.find("#modal-chart-y-axis");xAxisSelect.empty(),yAxisSelect.empty();var numericCols=this.detectNumericColumns(data,headers);headers.forEach((function(header,idx){var formattedHeader=header.replace(/_/g," ").replace(/\b\w/g,(function(l){return l.toUpperCase()})),selected=0===idx?" selected":"";xAxisSelect.append('<option value="'+header+'"'+selected+">"+formattedHeader+"</option>")}));var yAxisOptions=numericCols.length>0?numericCols:headers;yAxisOptions.forEach((function(col,idx){var formattedHeader=col.replace(/_/g," ").replace(/\b\w/g,(function(l){return l.toUpperCase()})),selected=idx===yAxisOptions.length-1?" selected":"";yAxisSelect.append('<option value="'+col+'"'+selected+">"+formattedHeader+"</option>")}))}},detectNumericColumns:function(data,headers){var numericCols=[];return headers.forEach((function(header){var isNumeric=data.every((function(row){var val=row[header];return null==val||""===val||!isNaN(parseFloat(val))&&isFinite(val)})),hasNumbers=data.some((function(row){var val=row[header];return null!=val&&""!==val&&!isNaN(parseFloat(val))}));isNumeric&&hasNumbers&&numericCols.push(header)})),numericCols},renderModalChart:function(){var modalBody=this.modal.getBody(),data=this.modalData;if(data&&0!==data.length){var canvas=modalBody.find(".modal-chart")[0];if(canvas){this.chartInstance&&(this.chartInstance.destroy(),this.chartInstance=null);var chartType=modalBody.find("#modal-chart-type").val()||"bar",labelKey=modalBody.find("#modal-chart-x-axis").val(),valueKey=modalBody.find("#modal-chart-y-axis").val();if(!labelKey||!valueKey){var headers=Object.keys(data[0]);labelKey=labelKey||headers[0],valueKey=valueKey||headers[headers.length-1]}var valueKeyFormatted=valueKey.replace(/_/g," ").replace(/\b\w/g,(function(l){return l.toUpperCase()})),chartData=data.slice(0,50),labels=chartData.map((function(row){var label=row[labelKey];if(null==label)return"Unknown";var labelStr=String(label);return labelStr.length>30?labelStr.substring(0,30)+"...":labelStr})),values=chartData.map((function(row){return parseFloat(row[valueKey])||0})),colors=this.generateChartColors(values.length,chartType),config=this.createChartConfig(chartType,labels,values,valueKeyFormatted,colors);try{this.chartInstance=new Chart(canvas.getContext("2d"),config)}catch(error){modalBody.find(".chart-container").html('<div class="alert alert-danger"><i class="fa fa-exclamation-triangle"></i> Error rendering chart</div>')}}}else modalBody.find(".chart-container").html('<div class="alert alert-warning text-center"><i class="fa fa-info-circle"></i> No data available for chart</div>')},createChartConfig:function(chartType,labels,values,valueKey,colors){var baseOptions={responsive:!0,maintainAspectRatio:!1,plugins:{title:{display:!0,text:this.modalReport?this.modalReport.name:"Report",font:{size:14,weight:"bold"},padding:{top:10,bottom:20}},legend:{display:"pie"===chartType||"doughnut"===chartType,position:"right"}}};return"pie"===chartType||"doughnut"===chartType?{type:chartType,data:{labels:labels,datasets:[{data:values,backgroundColor:colors,borderWidth:2}]},options:baseOptions}:(baseOptions.scales={y:{beginAtZero:!0,title:{display:!0,text:valueKey}},x:{title:{display:!1}}},{type:chartType,data:{labels:labels,datasets:[{label:valueKey,data:values,backgroundColor:"line"===chartType?"transparent":colors[0],borderColor:colors[0].replace("0.7","1"),borderWidth:2,fill:"line"!==chartType,tension:.1}]},options:baseOptions})},generateChartColors:function(count,chartType){for(var baseColors=["rgba(37, 99, 235, 0.7)","rgba(16, 185, 129, 0.7)","rgba(245, 158, 11, 0.7)","rgba(239, 68, 68, 0.7)","rgba(139, 92, 246, 0.7)","rgba(6, 182, 212, 0.7)","rgba(236, 72, 153, 0.7)","rgba(132, 204, 22, 0.7)","rgba(249, 115, 22, 0.7)","rgba(99, 102, 241, 0.7)"],colors=[],i=0;i<count;i++)colors.push(baseColors[i%baseColors.length]);return colors},exportModalData:function(format){var data=this.modalData,report=this.modalReport;if(data&&0!==data.length){if("csv"===format){var headers=Object.keys(data[0]),csvContent=headers.join(",")+"\n";data.forEach((function(row){var values=headers.map((function(h){var val=row[h];return null==val&&(val=""),-1===(val=String(val).replace(/"/g,'""')).indexOf(",")&&-1===val.indexOf('"')&&-1===val.indexOf("\n")||(val='"'+val+'"'),val}));csvContent+=values.join(",")+"\n"}));var blob=new Blob([csvContent],{type:"text/csv;charset=utf-8;"}),link=document.createElement("a");link.href=URL.createObjectURL(blob),link.download=(report?report.name.replace(/[^a-z0-9]/gi,"_"):"report")+".csv",link.click()}}else Notification.addNotification({message:"No data to export",type:"warning"})},renderModalTable:function(modalBody,data){this.tableCurrentPage=1,this.tableTotalPages=Math.ceil((data?data.length:0)/this.tableRowsPerPage);var thead=modalBody.find(".modal-table").find("thead");if(thead.empty(),data&&0!==data.length){var headers=Object.keys(data[0]),headerRow=$("<tr>");headers.forEach((function(h){var formatted=h.replace(/_/g," ").replace(/\b\w/g,(function(l){return l.toUpperCase()}));headerRow.append($("<th>").text(formatted))})),thead.append(headerRow),this.renderModalTablePage()}else modalBody.find(".modal-table-container").addClass("d-none")},renderModalTablePage:function(){var modalBody=this.modal.getBody(),data=this.modalData||[],tbody=modalBody.find(".modal-table").find("tbody");if(tbody.empty(),data&&0!==data.length){var headers=Object.keys(data[0]),startIndex=(this.tableCurrentPage-1)*this.tableRowsPerPage,endIndex=startIndex+this.tableRowsPerPage;data.slice(startIndex,endIndex).forEach((function(row){var tr=$("<tr>");headers.forEach((function(h){var val=row[h];null==val&&(val="");var displayVal=String(val);displayVal.length>100&&(displayVal=displayVal.substring(0,100)+"..."),tr.append($("<td>").attr("title",val).text(displayVal))})),tbody.append(tr)}));var actualEnd=Math.min(endIndex,data.length);modalBody.find(".row-count").text(data.length+" total rows"),modalBody.find(".table-pagination-info").text(startIndex+1+"-"+actualEnd+" of "+data.length),modalBody.find(".table-pagination-prev").prop("disabled",this.tableCurrentPage<=1),modalBody.find(".table-pagination-next").prop("disabled",this.tableCurrentPage>=this.tableTotalPages),this.tableTotalPages>1?modalBody.find(".table-pagination").removeClass("d-none"):modalBody.find(".table-pagination").addClass("d-none")}},openReportNewTab:function(slug,source){var url=M.cfg.wwwroot+"/report/adeptus_insights/generated_reports.php?slug="+encodeURIComponent(slug);window.open(url,"_blank")},expandReportInline:function(slug,source){},exportReport:function(format){Notification.addNotification({message:"Export to "+format.toUpperCase()+" coming soon",type:"info"})},refresh:function(){var refreshBtn=this.container.find(".block-adeptus-refresh i");refreshBtn.addClass("fa-spin"),this.clearAllCaches(),this.showLoading();var self=this;this.waitForAuth((function(){self.fetchReports()})),setTimeout((function(){refreshBtn.removeClass("fa-spin")}),1e3)},clearAllCaches:function(){try{sessionStorage.removeItem(this.cacheKey)}catch(e){}this.reportDataCache={}},setupAutoRefresh:function(){var interval=this.config.autoRefresh;if(interval&&"never"!==interval){var ms;switch(interval){case"5m":ms=3e5;break;case"15m":ms=9e5;break;case"30m":ms=18e5;break;case"1h":ms=36e5;break;default:return}var self=this;this.refreshTimer=setInterval((function(){document.hidden||self.refresh()}),ms)}},showLoading:function(){this.container.find(".block-adeptus-loading").removeClass("d-none"),this.container.find(".block-adeptus-report-list, .block-adeptus-kpi-grid, .block-adeptus-tabs-container, .block-adeptus-content").addClass("d-none"),this.container.find(".block-adeptus-empty, .block-adeptus-error").addClass("d-none")},hideLoading:function(){this.container.find(".block-adeptus-loading").addClass("d-none")},showEmpty:function(){this.hideLoading(),this.container.find(".block-adeptus-empty").removeClass("d-none")},showError:function(message){this.hideLoading(),this.container.find(".block-adeptus-error").removeClass("d-none")},updateTimestamp:function(){if(this.config.showTimestamp&&this.lastUpdated){var timestampEl=this.container.find(".block-adeptus-timestamp"),text=this.formatTimeAgo(this.lastUpdated);timestampEl.find(".timestamp-text").text(text),timestampEl.removeClass("d-none")}},scrollToListTop:function(){var listContainer=this.container.find(".block-adeptus-report-list");listContainer.length&&listContainer[0].scrollIntoView({behavior:"smooth",block:"start"})},formatTimeAgo:function(date){var seconds=Math.floor((new Date-date)/1e3);if(seconds<60)return"Just now";var minutes=Math.floor(seconds/60);if(minutes<60)return minutes+" minute"+(1!==minutes?"s":"")+" ago";var hours=Math.floor(minutes/60);if(hours<24)return hours+" hour"+(1!==hours?"s":"")+" ago";var days=Math.floor(hours/24);return days+" day"+(1!==days?"s":"")+" ago"}},{init:function(options){return new BlockController(options)}}}));

//# sourceMappingURL=block.min.js.map