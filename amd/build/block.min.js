/**
 * Main JavaScript controller for the Adeptus Insights block.
 *
 * @module     block_adeptus_insights/block
 * @copyright  2025 Adeptus Analytics
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["jquery","core/ajax","core/notification","core/str","core/modal_factory","core/modal_events","core/templates","core/chartjs"],(function(e,t,a,n,r,i,o,s){"use strict";var d=function(e){this.blockId=e.blockid,this.contextId=e.contextid,this.config=e.config||{},this.apiKey=e.apiKey||"",this.isAdmin=e.isAdmin||!1,this.container=null,this.reports=[],this.lastUpdated=null,this.refreshTimer=null,this.modal=null,this.modalData=null,this.modalReport=null,this.chartInstance=null,this.currentView="table",this.listCurrentPage=1,this.listItemsPerPage=this.config.maxLinkItems||10,this.listTotalPages=1,this.tableCurrentPage=1,this.tableRowsPerPage=25,this.tableTotalPages=1,this.selectedCategory="",this.availableCategories=[],this.selectedReportSlug=this.config.defaultReport||"",this.selectedReportSource="",this.embeddedCurrentView="table",this.embeddedTablePage=1,this.embeddedTableRowsPerPage=25,this.embeddedChartType="bar",this.embeddedXAxis="",this.embeddedYAxis="",this.backendUrl=this.config.backendUrl||"https://backend.adeptus360.com/api/v1",this.cacheKey="adeptus_block_reports_"+this.blockId,this.cacheTTL=3e5,this.reportDataCache={},this.preloadTimeout=null,this.preloadingSlug=null,this.tabPaneStates={},this.tabChartInstances={},this.kpiModal=null,this.kpiModalChart=null,this.kpiModalData=null,this.kpiModalDateRange="30d",this.kpiSnapshotCache={},this.registeredSnapshots={},this.init()};return d.prototype={init:function(){this.container=e('[data-blockid="'+this.blockId+'"]'),this.container.length&&(this.bindEvents(),this.loadReports(),this.setupAutoRefresh())},bindEvents:function(){var t=this;this.container.on("click",".block-adeptus-refresh, .block-adeptus-retry",(function(e){e.preventDefault(),t.refresh()})),this.container.on("click",".block-adeptus-report-item",(function(a){a.preventDefault();var n=e(this).data("slug"),r=e(this).data("source");t.handleReportClick(n,r)})),this.container.on("keydown",".block-adeptus-report-item",(function(a){if("Enter"===a.key||" "===a.key){a.preventDefault();var n=e(this).data("slug"),r=e(this).data("source");t.handleReportClick(n,r)}})),this.container.on("click",".block-adeptus-kpi-card",(function(a){a.preventDefault();var n=e(this).data("slug"),r=e(this).data("source");t.handleReportClick(n,r)})),this.container.on("shown.bs.tab",".block-adeptus-tab-nav a",(function(a){var n=e(e(a.target).attr("href")),r=n.data("slug"),i=n.data("source");n.data("loaded")||t.loadTabContent(n,r,i)})),this.container.on("click",".block-adeptus-export",(function(a){a.preventDefault();var n=e(this).data("format");t.exportReport(n)})),this.container.on("click",".pagination-prev",(function(e){e.preventDefault(),t.listCurrentPage>1&&(t.listCurrentPage--,t.renderCurrentPage(),t.scrollToListTop())})),this.container.on("click",".pagination-next",(function(e){e.preventDefault(),t.listCurrentPage<t.listTotalPages&&(t.listCurrentPage++,t.renderCurrentPage(),t.scrollToListTop())})),this.container.on("change",".category-filter-select",(function(){t.selectedCategory=e(this).val(),t.listCurrentPage=1,"embedded"===t.config.displayMode?t.populateReportSelector():t.renderReports()})),this.container.on("change",".report-selector-select",(function(){var a=e(this).val();if(a){var n=a.split("::"),r=n[0],i=n[1]||"wizard";t.selectedReportSlug=r,t.selectedReportSource=i,t.embeddedTablePage=1,t.embeddedCurrentView="table",t.loadEmbeddedReport(r,i)}})),this.container.on("click",".searchable-dropdown-toggle",(function(a){a.preventDefault(),a.stopPropagation();var n=e(this).closest(".searchable-dropdown");t.toggleSearchableDropdown(n)})),this.container.on("input",".searchable-dropdown-input",(function(){var a=e(this).closest(".searchable-dropdown"),n=e(this).val().toLowerCase().trim();t.filterSearchableDropdown(a,n)})),this.container.on("click",".searchable-dropdown-item",(function(a){a.preventDefault(),a.stopPropagation();var n=e(this).closest(".searchable-dropdown"),r=e(this).data("value"),i=e(this).find(".dropdown-item-name").text();t.selectSearchableDropdownItem(n,r,i)})),this.container.on("keydown",".searchable-dropdown-input",(function(a){var n=e(this).closest(".searchable-dropdown"),r=n.find(".searchable-dropdown-item:visible"),i=n.find(".searchable-dropdown-item.focused");if("ArrowDown"===a.key)if(a.preventDefault(),0===i.length)r.first().addClass("focused");else{var o=i.nextAll(".searchable-dropdown-item:visible").first();o.length&&(i.removeClass("focused"),o.addClass("focused"),t.scrollDropdownItemIntoView(o))}else if("ArrowUp"===a.key){if(a.preventDefault(),i.length){var s=i.prevAll(".searchable-dropdown-item:visible").first();s.length&&(i.removeClass("focused"),s.addClass("focused"),t.scrollDropdownItemIntoView(s))}}else"Enter"===a.key?(a.preventDefault(),i.length?i.trigger("click"):1===r.length&&r.first().trigger("click")):"Escape"===a.key&&t.closeSearchableDropdown(n)})),e(document).on("click",(function(a){e(a.target).closest(".searchable-dropdown").length||t.container.find(".searchable-dropdown.open").each((function(){t.closeSearchableDropdown(e(this))}))})),this.container.on("click",".embedded-view-toggle-btn",(function(a){a.preventDefault();var n=e(this).data("view");t.switchEmbeddedView(n)})),this.container.on("click",".embedded-pagination-prev",(function(e){e.preventDefault(),t.embeddedTablePage>1&&(t.embeddedTablePage--,t.renderEmbeddedTablePage(),t.scrollToEmbeddedTableTop())})),this.container.on("click",".embedded-pagination-next",(function(e){e.preventDefault();var a=Math.ceil((t.embeddedData||[]).length/t.embeddedTableRowsPerPage);t.embeddedTablePage<a&&(t.embeddedTablePage++,t.renderEmbeddedTablePage(),t.scrollToEmbeddedTableTop())})),this.container.on("change",".embedded-chart-type",(function(){t.embeddedChartType=e(this).val(),t.renderEmbeddedChart()})),this.container.on("change",".embedded-chart-x-axis",(function(){t.embeddedXAxis=e(this).val(),t.renderEmbeddedChart()})),this.container.on("change",".embedded-chart-y-axis",(function(){t.embeddedYAxis=e(this).val(),t.renderEmbeddedChart()})),this.container.on("click",".embedded-export",(function(a){a.preventDefault();var n=e(this).data("format");t.exportEmbeddedReport(n)})),this.container.on("click",".tab-view-toggle-btn",(function(a){a.preventDefault();var n=e(this).closest(".tab-pane"),r=e(this).data("view");t.switchTabView(n,r)})),this.container.on("click",".tab-pagination-prev",(function(a){a.preventDefault();var n=e(this).closest(".tab-pane"),r=n.attr("id"),i=t.tabPaneStates[r];i&&i.tablePage>1&&(i.tablePage--,t.renderTabTablePage(n,i))})),this.container.on("click",".tab-pagination-next",(function(a){a.preventDefault();var n=e(this).closest(".tab-pane"),r=n.attr("id"),i=t.tabPaneStates[r];if(i){var o=Math.ceil(i.data.length/i.rowsPerPage);i.tablePage<o&&(i.tablePage++,t.renderTabTablePage(n,i))}})),this.container.on("change",".tab-chart-type",(function(){var a=e(this).closest(".tab-pane"),n=a.attr("id"),r=t.tabPaneStates[n];r&&(r.chartType=e(this).val(),t.renderTabChart(a,r))})),this.container.on("change",".tab-chart-x-axis",(function(){var a=e(this).closest(".tab-pane"),n=a.attr("id"),r=t.tabPaneStates[n];r&&(r.xAxis=e(this).val(),t.renderTabChart(a,r))})),this.container.on("change",".tab-chart-y-axis",(function(){var a=e(this).closest(".tab-pane"),n=a.attr("id"),r=t.tabPaneStates[n];r&&(r.yAxis=e(this).val(),t.renderTabChart(a,r))})),this.container.on("click",".tab-export",(function(a){a.preventDefault();var n=e(this).closest(".tab-pane").attr("id"),r=t.tabPaneStates[n],i=e(this).data("format");r&&t.exportTabReport(r,i)})),this.container.on("mouseenter",".block-adeptus-report-item",(function(){var a=e(this).data("slug"),n=e(this).data("source");t.preloadTimeout&&clearTimeout(t.preloadTimeout),t.preloadTimeout=setTimeout((function(){t.preloadReportData(a,n)}),300)})),this.container.on("mouseleave",".block-adeptus-report-item",(function(){t.preloadTimeout&&(clearTimeout(t.preloadTimeout),t.preloadTimeout=null)}))},loadReports:function(){var e=this;this.showLoading();var t=this.getFromCache();if(t)return this.reports=t,this.lastUpdated=new Date,void this.renderReports();this.waitForAuth((function(){e.fetchReports()}))},getFromCache:function(){try{var e=sessionStorage.getItem(this.cacheKey);if(e){var t=JSON.parse(e);if(t.timestamp&&Date.now()-t.timestamp<this.cacheTTL)return t.reports;sessionStorage.removeItem(this.cacheKey)}}catch(e){}return null},saveToCache:function(e){try{sessionStorage.setItem(this.cacheKey,JSON.stringify({timestamp:Date.now(),reports:e}))}catch(e){}},preloadReportData:function(t,a){var n=this,r=t+"_"+a;if(!this.reportDataCache[r]&&this.preloadingSlug!==t){this.preloadingSlug=t;var i=this.reports.find((function(e){return e.slug===t}));if(i)if("wizard"===a)e.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/generate_report.php",method:"POST",data:{reportid:i.name||i.report_template_id,sesskey:M.cfg.sesskey},dataType:"json",timeout:3e4}).done((function(e){e.success&&(n.reportDataCache[r]={report:i,results:e.results||[],chartData:e.chart_data,chartType:e.chart_type}),n.preloadingSlug=null})).fail((function(){n.preloadingSlug=null}));else{var o=this.apiKey||(window.adeptusAuthData?window.adeptusAuthData.api_key:null);if(!o)return;e.ajax({url:this.backendUrl+"/ai-reports/"+t,method:"GET",headers:{Authorization:"Bearer "+o,Accept:"application/json"},timeout:15e3}).done((function(e){if(e.success&&e.report){var t=e.report,a=e.data||[],i=e.sql||t&&t.sql_query||t&&t.sql;if((e.execution_required||(!a||0===a.length)&&i)&&i)return void n.executeReportLocally(i,t.params||{}).then((function(e){var a=e.data||[];n.reportDataCache[r]={report:t,results:a,chartData:null,chartType:null},n.preloadingSlug=null})).catch((function(){n.preloadingSlug=null}));n.reportDataCache[r]={report:t,results:a,chartData:null,chartType:null}}n.preloadingSlug=null})).fail((function(){n.preloadingSlug=null}))}}},waitForAuth:function(t){var a=this;if(this.apiKey)return window.adeptusAuthData=window.adeptusAuthData||{},window.adeptusAuthData.api_key=this.apiKey,void t();window.adeptusAuthData&&window.adeptusAuthData.api_key?t():e.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/get_auth_status.php",method:"GET",dataType:"json",timeout:1e4}).done((function(e){e&&e.success&&e.data?(window.adeptusAuthData=e.data,t()):a.showError("Authentication failed")})).fail((function(){a.showError("Could not authenticate")}))},fetchReports:function(){var t=this,a=this.apiKey||(window.adeptusAuthData?window.adeptusAuthData.api_key:null);if(a){var n=[],r=this.config.reportSource||"all";"all"!==r&&"wizard"!==r&&"manual"!==r&&"category"!==r||n.push(this.fetchFromApi("/wizard-reports",a)),"all"!==r&&"ai"!==r&&"manual"!==r&&"category"!==r||n.push(this.fetchFromApi("/ai-reports",a)),e.when.apply(e,n).then((function(){for(var e=[],a=0;a<n.length;a++){var i,o=(i=1===n.length?arguments[0]:arguments[a][0]).reports||i.data||[];if(o&&o.length){var s="all"===r||"manual"===r||"category"===r,d="ai"===r||1===a&&s?"ai":"wizard";o.forEach((function(t){t.source=t.source||d,e.push(t)}))}}t.reports=e,t.lastUpdated=new Date,t.saveToCache(e),t.renderReports()})).fail((function(){t.showError()}))}else this.showError("No authentication token")},fetchFromApi:function(t,a){var n=""+this.backendUrl;return e.ajax({url:n+t,method:"GET",headers:{Authorization:"Bearer "+a,"Content-Type":"application/json",Accept:"application/json"},timeout:15e3})},renderReports:function(){var e=this.config.displayMode||"links";if(0!==this.reports.length){"embedded"!==e&&"links"!==e||this.populateCategoryFilter();var t=this.filterReports();switch(e){case"embedded":this.renderEmbedded(t);break;case"kpi":var a=this.getSelectedReportsForMode("kpi",this.reports);this.renderKpi(a);break;case"tabs":var n=this.getSelectedReportsForMode("tabs",this.reports);this.renderTabs(n);break;default:this.renderLinks(t)}this.hideLoading(),this.updateTimestamp()}else this.showEmpty()},getSelectedReportsForMode:function(e,t){var a=[];if("kpi"===e&&this.config.kpiSelectedReports&&this.config.kpiSelectedReports.length>0?a=this.config.kpiSelectedReports:"tabs"===e&&this.config.tabsSelectedReports&&this.config.tabsSelectedReports.length>0&&(a=this.config.tabsSelectedReports),0===a.length)return t;var n=[];return a.forEach((function(e){var a=e.slug||e,r=e.source||"wizard",i=t.find((function(t){return t.slug===a&&(t.source===r||!e.source)}));if(i){var o=Object.assign({},i);e.icon&&(o.customIcon=e.icon),n.push(o)}})),n},populateCategoryFilter:function(){var e=this,t={},a=this.config,n=!!a.reportCategory;if(n&&(this.selectedCategory=a.reportCategory),this.reports.forEach((function(e){var a=e.category_info;a&&a.slug?t[a.slug]={slug:a.slug,name:a.name||a.slug,color:a.color||"#6c757d"}:e.category&&(t[e.category]={slug:e.category,name:e.category,color:"#6c757d"})})),n&&!t[a.reportCategory]){var r=a.reportCategory.replace(/[-_]/g," ").replace(/\b\w/g,(function(e){return e.toUpperCase()}));t[a.reportCategory]={slug:a.reportCategory,name:r,color:"#6c757d"}}this.availableCategories=Object.values(t).sort((function(e,t){return e.name.localeCompare(t.name)}));var i=this.container.find(".category-filter-select"),o=this.container.find(".category-dropdown"),s=o.find(".searchable-dropdown-list");if(i.length&&(i.find("option:not(:first)").remove(),this.availableCategories.forEach((function(t){var a=e.selectedCategory===t.slug?" selected":"";i.append('<option value="'+t.slug+'"'+a+">"+t.name+"</option>")}))),s.length){s.empty();var d='<li class="searchable-dropdown-item '+(this.selectedCategory?"":"selected")+'" data-value="" data-search="all categories" role="option"><span class="dropdown-item-name">All Categories</span></li>';s.append(d),this.availableCategories.forEach((function(t){var a='<li class="searchable-dropdown-item '+(e.selectedCategory===t.slug?"selected":"")+'" data-value="'+t.slug+'" data-search="'+t.name.toLowerCase()+'" role="option"><span class="dropdown-item-name">'+e.escapeHtml(t.name)+'</span><span class="dropdown-item-category" style="background-color: '+t.color+'"><i class="fa fa-circle" style="font-size: 0.5rem;"></i></span></li>';s.append(a)}));var l="All Categories";if(this.selectedCategory){var c=this.availableCategories.find((function(t){return t.slug===e.selectedCategory}));c&&(l=c.name)}o.find(".searchable-dropdown-text").text(l),n&&this.container.find(".block-adeptus-category-filter").hide()}},populateReportSelector:function(){var e=this,t=this.container.find(".report-selector-select"),a=this.container.find(".block-adeptus-report-selector .searchable-dropdown"),n=a.find(".searchable-dropdown-list");if(t.length){var r=this.filterReports();if(t.find("option:not(:first)").remove(),n.empty(),r.forEach((function(a){var r=a.name||a.title||a.display_name||a.slug||"Untitled",i=a.slug+"::"+a.source,o=a.category_info||{name:"General",color:"#6c757d"},s=" ["+o.name+"]",d=e.selectedReportSlug===a.slug?" selected":"";t.append('<option value="'+i+'"'+d+">"+r+s+"</option>");var l='<li class="searchable-dropdown-item" data-value="'+i+'" data-search="'+r.toLowerCase()+" "+o.name.toLowerCase()+'" role="option"><span class="dropdown-item-name">'+e.escapeHtml(r)+'</span><span class="dropdown-item-category" style="background-color: '+o.color+'">'+e.escapeHtml(o.name)+"</span></li>";n.append(l)})),this.selectedReportSlug&&!t.val()){var i=t.find('option[value^="'+this.selectedReportSlug+'::"]');i.length&&i.prop("selected",!0)}if(!t.val()&&r.length>0){var o=r[0],s=o.slug+"::"+o.source,d=o.name||o.title||o.display_name||o.slug||"Untitled";t.val(s),this.selectedReportSlug=o.slug,this.selectedReportSource=o.source,a.find(".searchable-dropdown-text").text(d),a.find(".searchable-dropdown-item").removeClass("selected"),a.find('.searchable-dropdown-item[data-value="'+s+'"]').addClass("selected"),this.loadEmbeddedReport(o.slug,o.source)}else if(t.val()){var l=t.val().split("::"),c=r.find((function(e){return e.slug===l[0]}));if(c){var p=c.name||c.title||c.display_name||c.slug||"Untitled";a.find(".searchable-dropdown-text").text(p),a.find(".searchable-dropdown-item").removeClass("selected"),a.find('.searchable-dropdown-item[data-value="'+t.val()+'"]').addClass("selected")}this.loadEmbeddedReport(l[0],l[1]||"wizard")}else a.find(".searchable-dropdown-text").text("-- No Reports --"),this.showEmpty()}},filterReports:function(){var e=this,t=this.reports.slice(),a=this.config;return a.reportCategory&&(t=t.filter((function(e){return(e.category_info?e.category_info.slug:e.category||"")===a.reportCategory}))),this.selectedCategory&&this.selectedCategory!==a.reportCategory&&(t=t.filter((function(t){return(t.category_info?t.category_info.slug:t.category||"")===e.selectedCategory}))),t.sort((function(e,t){var a=e.name||e.title||e.display_name||e.report_name||e.slug||"",n=t.name||t.title||t.display_name||t.report_name||t.slug||"";return a.localeCompare(n)})),t},renderLinks:function(e){this.filteredReports=e,this.listItemsPerPage=this.config.maxLinkItems||10,this.listTotalPages=Math.ceil(e.length/this.listItemsPerPage),this.listCurrentPage=1,this.renderCurrentPage()},renderCurrentPage:function(){var t=this.filteredReports||[],a=this.container.find(".block-adeptus-report-list"),n=e("#block-adeptus-report-item-template-"+this.blockId),r=this.container.find(".block-adeptus-pagination"),i=(this.listCurrentPage-1)*this.listItemsPerPage,o=i+this.listItemsPerPage,s=t.slice(i,o);if(a.empty(),s.forEach((function(t){var r=n.html(),i=e(r);i.attr("data-slug",t.slug),i.attr("data-source",t.source);var o=t.name||t.title||t.display_name||t.report_name||t.slug||"Untitled Report";i.find(".report-item-name").text(o);var s=t.category_info?t.category_info.name:t.category||"General",d=t.category_info?t.category_info.color:"#6c757d";i.find(".report-item-category").text(s).css("background-color",d).css("color","#fff"),a.append(i)})),a.removeClass("d-none"),this.listTotalPages>1){var d=i+s.length;r.find(".pagination-showing").text("Showing "+(i+1)+"-"+d+" of "+t.length),r.find(".pagination-pages").text("Page "+this.listCurrentPage+" of "+this.listTotalPages),r.find(".pagination-prev").prop("disabled",this.listCurrentPage<=1),r.find(".pagination-next").prop("disabled",this.listCurrentPage>=this.listTotalPages),r.removeClass("d-none")}else r.addClass("d-none")},renderEmbedded:function(e){this.embeddedReport=null,this.embeddedData=null,this.embeddedChartInstance=null,this.populateReportSelector(),0===this.reports.length&&this.showEmpty()},loadEmbeddedReport:function(t,a){var n=this,r=t+"_"+a;if(this.reportDataCache[r]){var i=this.reportDataCache[r];return this.embeddedData=i.results,void this.renderEmbeddedContent(i.report,i.results)}this.showEmbeddedLoadingOverlay();var o=this.reports.find((function(e){return e.slug===t}));if(!o)return this.hideEmbeddedLoadingOverlay(),void this.showError("Report not found");if("wizard"===a)e.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/generate_report.php",method:"POST",data:{reportid:o.name||o.report_template_id,sesskey:M.cfg.sesskey},dataType:"json",timeout:3e4}).done((function(e){n.hideEmbeddedLoadingOverlay(),e.success?(n.reportDataCache[r]={report:o,results:e.results||[],chartData:e.chart_data,chartType:e.chart_type},n.embeddedData=e.results||[],n.renderEmbeddedContent(o,e.results||[])):n.showError(e.message||"Failed to load report")})).fail((function(){n.hideEmbeddedLoadingOverlay(),n.showError("Connection error")}));else{var s=this.apiKey||(window.adeptusAuthData?window.adeptusAuthData.api_key:null);if(!s)return this.hideEmbeddedLoadingOverlay(),void this.showError("No authentication token");e.ajax({url:this.backendUrl+"/ai-reports/"+t,method:"GET",headers:{Authorization:"Bearer "+s,Accept:"application/json"},timeout:15e3}).done((function(e){if(e.success&&e.report){var t=e.report,a=e.data||[],i=e.sql||t&&t.sql_query||t&&t.sql;if((e.execution_required||(!a||0===a.length)&&i)&&i)return void n.executeReportLocally(i,t.params||{}).then((function(e){n.hideEmbeddedLoadingOverlay();var a=e.data||[];n.reportDataCache[r]={report:t,results:a,chartData:null,chartType:null},n.embeddedData=a,n.renderEmbeddedContent(t,a)})).catch((function(e){n.hideEmbeddedLoadingOverlay(),n.showError("Failed to execute report")}));n.hideEmbeddedLoadingOverlay(),n.reportDataCache[r]={report:t,results:a,chartData:null,chartType:null},n.embeddedData=a,n.renderEmbeddedContent(t,a)}else n.hideEmbeddedLoadingOverlay(),n.showError("Failed to load report")})).fail((function(){n.hideEmbeddedLoadingOverlay(),n.showError("Connection error")}))}},renderEmbeddedContent:function(e,t){var a=this.container.find(".block-adeptus-content");if(t&&0!==t.length){this.embeddedReport=e,this.embeddedData=t;var n=e.category_info||{name:"General",color:"#6c757d"};this.container.find(".report-category").text(n.name).css("background-color",n.color).css("color","#fff"),this.container.find(".row-count-num").text(t.length),this.container.find(".report-date").text("Updated: "+(new Date).toLocaleTimeString()),this.populateEmbeddedChartControls(t),this.embeddedCurrentView="table",this.embeddedTablePage=1,this.container.find(".embedded-view-toggle-btn").removeClass("active"),this.container.find('.embedded-view-toggle-btn[data-view="table"]').addClass("active"),this.container.find(".embedded-table-view").removeClass("d-none"),this.container.find(".embedded-chart-view").addClass("d-none"),this.renderEmbeddedTablePage(),a.removeClass("d-none"),this.hideLoading(),this.updateTimestamp()}else this.showEmpty()},switchEmbeddedView:function(e){this.embeddedCurrentView=e,this.container.find(".embedded-view-toggle-btn").removeClass("active"),this.container.find('.embedded-view-toggle-btn[data-view="'+e+'"]').addClass("active"),"table"===e?(this.container.find(".embedded-table-view").removeClass("d-none"),this.container.find(".embedded-chart-view").addClass("d-none")):(this.container.find(".embedded-table-view").addClass("d-none"),this.container.find(".embedded-chart-view").removeClass("d-none"),this.renderEmbeddedChart())},populateEmbeddedChartControls:function(e){if(e&&0!==e.length){var t=Object.keys(e[0]),a=this.detectNumericColumns(e,t),n=this.container.find(".embedded-chart-x-axis"),r=this.container.find(".embedded-chart-y-axis");n.empty(),r.empty(),t.forEach((function(e){var t=e.replace(/_/g," ").replace(/\b\w/g,(function(e){return e.toUpperCase()}));n.append('<option value="'+e+'">'+t+"</option>")})),(a.length>0?a:t).forEach((function(e){var t=e.replace(/_/g," ").replace(/\b\w/g,(function(e){return e.toUpperCase()}));r.append('<option value="'+e+'">'+t+"</option>")})),this.embeddedXAxis=t[0],this.embeddedYAxis=a.length>0?a[a.length-1]:t[t.length-1],n.val(this.embeddedXAxis),r.val(this.embeddedYAxis)}},renderEmbeddedTablePage:function(){var t=this.embeddedData||[],a=this.container.find(".embedded-table"),n=a.find("thead"),r=a.find("tbody");if(n.empty(),r.empty(),0!==t.length){var i=Object.keys(t[0]),o=e("<tr>");i.forEach((function(t){var a=t.replace(/_/g," ").replace(/\b\w/g,(function(e){return e.toUpperCase()}));o.append(e("<th>").text(a))})),n.append(o);var s=Math.ceil(t.length/this.embeddedTableRowsPerPage),d=(this.embeddedTablePage-1)*this.embeddedTableRowsPerPage,l=Math.min(d+this.embeddedTableRowsPerPage,t.length);t.slice(d,l).forEach((function(t){var a=e("<tr>");i.forEach((function(n){var r=t[n];null==r&&(r="");var i=String(r);i.length>50&&(i=i.substring(0,50)+"..."),a.append(e("<td>").attr("title",r).text(i))})),r.append(a)})),this.container.find(".row-count").text("Showing "+(d+1)+"-"+l+" of "+t.length),this.container.find(".embedded-pagination-info").text("Page "+this.embeddedTablePage+" of "+s),this.container.find(".embedded-pagination-prev").prop("disabled",this.embeddedTablePage<=1),this.container.find(".embedded-pagination-next").prop("disabled",this.embeddedTablePage>=s)}},renderEmbeddedChart:function(){var e=this.embeddedData||[],t=this.container.find(".embedded-chart")[0];if(t&&0!==e.length){this.embeddedChartInstance&&(this.embeddedChartInstance.destroy(),this.embeddedChartInstance=null);var a=this.embeddedChartType||"bar",n=this.embeddedXAxis||Object.keys(e[0])[0],r=this.embeddedYAxis||Object.keys(e[0])[1],i=e.slice(0,30),o=i.map((function(e){var t=e[n];if(null==t)return"Unknown";var a=String(t);return a.length>20?a.substring(0,20)+"...":a})),d=i.map((function(e){return parseFloat(e[r])||0})),l=this.generateChartColors(d.length,a),c={label:r.replace(/_/g," ").replace(/\b\w/g,(function(e){return e.toUpperCase()})),data:d};"pie"===a||"doughnut"===a?(c.backgroundColor=l,c.borderWidth=1):(c.backgroundColor=l[0],c.borderColor=l[0].replace("0.7","1"),c.borderWidth=1);var p={type:a,data:{labels:o,datasets:[c]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:"pie"===a||"doughnut"===a,position:"right"}}}};"bar"!==a&&"line"!==a||(p.options.scales={y:{beginAtZero:!0},x:{display:e.length<=15}});try{this.embeddedChartInstance=new s(t.getContext("2d"),p)}catch(e){this.container.find(".embedded-chart-container").html('<div class="alert alert-warning text-center"><i class="fa fa-exclamation-circle"></i> Could not render chart</div>')}}},exportEmbeddedReport:function(t){var n=this,r=this.embeddedData||[],i=this.embeddedReport||{};0!==r.length?e.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/check_export_eligibility.php",method:"POST",data:{format:t,sesskey:M.cfg.sesskey},dataType:"json"}).done((function(e){e.success&&e.eligible?n.performExport(t,i,r):n.showExportUpgradePrompt(t,e.message||"Export not available")})).fail((function(){a.addNotification({message:"Unable to verify export eligibility. Please try again.",type:"error"})})):a.addNotification({message:"No data to export",type:"warning"})},renderKpi:function(t){var a=this,n=this.container.find(".block-adeptus-kpi-grid"),r=e("#block-adeptus-kpi-card-template-"+this.blockId),i=parseInt(this.config.kpiColumns,10)||2;i=Math.max(1,Math.min(4,i)),n.empty();var o=t.slice(0,i),s={},d=[],l=[];o.forEach((function(t,a){var i=r.html(),o=e(i),c=t.name||t.title||t.display_name||t.slug||"Metric";o.attr("data-slug",t.slug),o.attr("data-source",t.source),o.find(".kpi-card-label").text(c),o.find(".kpi-card-value").html('<i class="fa fa-spinner fa-spin"></i>'),o.find(".kpi-card-trend").addClass("d-none"),o.find(".kpi-card-sparkline").addClass("d-none");var p=["fa-users","fa-graduation-cap","fa-clock-o","fa-check-circle"],h=t.customIcon||p[a%p.length];o.find(".kpi-card-icon i").removeClass("fa-bar-chart").addClass(h),n.append(o),s[t.slug]={$card:o,report:t,index:a},"wizard"===t.source?d.push(t):l.push(t)})),n.removeClass("d-none"),d.length>0&&this.loadKpiBatch(d,s),l.forEach((function(e,t){var n=s[e.slug];setTimeout((function(){a.loadKpiData(e,n.$card,n.index)}),100*t)}))},loadKpiBatch:function(t,a){var n=this,r=(performance.now(),t.map((function(e){return e.report_template_id||e.id||e.name||e.slug})));e.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/batch_kpi_data.php",method:"POST",data:{reportids:JSON.stringify(r),sesskey:M.cfg.sesskey},dataType:"json",timeout:3e4}).done((function(e){e.success&&e.reports?t.forEach((function(t){var r=t.report_template_id||t.id||t.name||t.slug,i=e.reports[r],o=a[t.slug];if(o){var s=o.$card,d=t.slug+"_"+t.source;i&&i.success?(n.reportDataCache[d]={report:t,results:i.results||[]},n.renderKpiValue(s,i.results||[])):(s.find(".kpi-card-value").text("--"),s.find(".kpi-card-trend").addClass("d-none"))}})):t.forEach((function(e,t){var r=a[e.slug];setTimeout((function(){n.loadKpiData(e,r.$card,r.index)}),100*t)}))})).fail((function(){t.forEach((function(e,t){var r=a[e.slug];setTimeout((function(){n.loadKpiData(e,r.$card,r.index)}),100*t)}))}))},loadKpiData:function(t,a,n,r){var i=this,o=t.slug+"_"+t.source;r=r||0;performance.now();if(this.reportDataCache[o]){var s=this.reportDataCache[o];this.renderKpiValue(a,s.results)}else{var d=t.report_template_id||t.id||t.name||t.slug;if("wizard"===t.source)e.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/generate_report.php",method:"POST",data:{reportid:d,sesskey:M.cfg.sesskey},dataType:"json",timeout:3e4}).done((function(e){e.success?(i.reportDataCache[o]={report:t,results:e.results||[]},i.renderKpiValue(a,e.results||[])):(a.find(".kpi-card-value").text("--"),a.find(".kpi-card-trend").addClass("d-none"))})).fail((function(e,o){r<2&&("timeout"===o||e.status>=500)?setTimeout((function(){i.loadKpiData(t,a,n,r+1)}),1e3*(r+1)):(a.find(".kpi-card-value").text("--"),a.find(".kpi-card-trend").addClass("d-none"))}));else{var l=this.apiKey||(window.adeptusAuthData?window.adeptusAuthData.api_key:null);if(!l)return a.find(".kpi-card-value").text("--"),void a.find(".kpi-card-trend").addClass("d-none");e.ajax({url:this.backendUrl+"/ai-reports/"+t.slug,method:"GET",headers:{Authorization:"Bearer "+l,Accept:"application/json"},timeout:3e4}).done((function(e){if(e.success){var n=e.report||t,r=e.data||[],s=e.sql||n&&n.sql_query||n&&n.sql;if((e.execution_required||(!r||0===r.length)&&s)&&s)return void i.executeReportLocally(s,n.params||{}).then((function(e){var t=e.data||[];i.reportDataCache[o]={report:n,results:t},i.renderKpiValue(a,t)})).catch((function(e){a.find(".kpi-card-value").text("--"),a.find(".kpi-card-trend").addClass("d-none")}));r&&r.length>0?(i.reportDataCache[o]={report:n,results:r},i.renderKpiValue(a,r)):(a.find(".kpi-card-value").text("--"),a.find(".kpi-card-trend").addClass("d-none"))}else a.find(".kpi-card-value").text("--"),a.find(".kpi-card-trend").addClass("d-none")})).fail((function(e,o){r<2&&("timeout"===o||e.status>=500)?setTimeout((function(){i.loadKpiData(t,a,n,r+1)}),1e3*(r+1)):(a.find(".kpi-card-value").text("--"),a.find(".kpi-card-trend").addClass("d-none"))}))}}},renderKpiValue:function(e,t){var a=e.data("slug"),n=e.data("source")||"wizard",r=e.find(".kpi-card-label").text()||"";if(!t||0===t.length)return e.find(".kpi-card-value").text("0"),void this.saveKpiHistoryToServer(e,a,0,n,r,0);var i,o,s=Object.keys(t[0]),d=this.detectNumericColumns(t,s);if(d.length>0){var l=d[d.length-1];i=l.toLowerCase().includes("count")||l.toLowerCase().includes("total")||1===t.length?t.reduce((function(e,t){return e+(parseFloat(t[l])||0)}),0):t.length}else i=t.length;o=this.formatKpiValue(i),e.find(".kpi-card-value").text(o),this.saveKpiHistoryToServer(e,a,i,n,r,t.length)},formatKpiValue:function(e){return e>=1e6?(e/1e6).toFixed(1)+"M":e>=1e3?(e/1e3).toFixed(1)+"K":Number.isInteger(e)?e.toLocaleString():e.toFixed(1)},saveKpiHistoryToServer:function(e,t,a,n,r,i,o){if(!this.config.snapshotsEnabled)return e.find(".kpi-card-trend").addClass("d-none"),void e.find(".kpi-card-sparkline").addClass("d-none");this.postSnapshotToBackend(e,t,a,o||0)},postSnapshotToBackend:function(t,a,n,r){var i=this,o=this.apiKey,s=t.data("source")||"wizard";if(!o)return t.find(".kpi-card-trend").addClass("d-none"),void t.find(".kpi-card-sparkline").addClass("d-none");var d="ai"===s?"/ai-reports/":"/wizard-reports/",l=this.config.baselinePeriod||"all_time",c=this.getHistoryLimitForBaseline(l);e.ajax({url:this.backendUrl+d+encodeURIComponent(a)+"/snapshots?baseline_period="+l+"&history_limit="+c,method:"POST",headers:{Authorization:"Bearer "+o,"Content-Type":"application/json",Accept:"application/json"},data:JSON.stringify({row_count:n,execution_time_ms:r,evaluate_alerts:!0,baseline_period:l}),timeout:15e3}).done((function(e){if(e.success&&(i.kpiSnapshotCache[a]={history:e.history||[],trend:e.trend||{},currentValue:n,timestamp:Date.now()},i.registerSnapshotSchedule(a,s,n),i.updateKpiTrendFromBackend(t,e.trend),e.history&&e.history.length>=2?i.renderKpiSparklineFromBackend(t,a,e.history):t.find(".kpi-card-sparkline").addClass("d-none"),e.alerts&&e.alerts.triggered_count>0)){var r=t.find(".kpi-card-label").text()||a;i.handleTriggeredAlerts(e.alerts.triggered,a,n,e.trend,r)}})).fail((function(){t.find(".kpi-card-trend").addClass("d-none"),t.find(".kpi-card-sparkline").addClass("d-none")}))},registerSnapshotSchedule:function(e,a,n){var r=this,i=this.blockId+"_"+e;if(!this.registeredSnapshots[i]){var o=this.config.kpiHistoryInterval||3600;t.call([{methodname:"block_adeptus_insights_register_snapshot_schedule",args:{blockinstanceid:this.blockId,reportslug:e,reportsource:a,intervalseconds:o,rowcount:n}}])[0].done((function(e){e.success&&(r.registeredSnapshots[i]=!0)})).fail((function(){}))}},updateKpiTrendFromBackend:function(e,t){var a=e.find(".kpi-card-trend");if(a.removeClass("d-none trend-up trend-down trend-neutral"),t&&(t.vs_baseline||t.vs_previous))this.updateKpiDualTrend(e,t);else if(t&&t.has_previous){var n=t.direction,r=Math.abs(t.change_percent||0),i=this.formatPercentage(r);"increase"===n?(a.addClass("trend-up"),a.find(".trend-icon").html('<i class="fa fa-arrow-up"></i>'),a.find(".trend-value").text("+"+i+" vs previous")):"decrease"===n?(a.addClass("trend-down"),a.find(".trend-icon").html('<i class="fa fa-arrow-down"></i>'),a.find(".trend-value").text("-"+i+" vs previous")):(a.addClass("trend-neutral"),a.find(".trend-icon").html('<i class="fa fa-minus"></i>'),a.find(".trend-value").text("No change"))}else a.addClass("d-none")},updateKpiDualTrend:function(e,t){var a=e.find(".kpi-card-trend");a.removeClass("d-none trend-up trend-down trend-neutral");var n=t.vs_baseline||{},r=t.vs_previous||{},i=n.has_baseline,o=r.has_previous;if(i||o){var s=[];if(i){var d=this.formatPercentage(Math.abs(n.change_percent||0)),l=this.getTrendIcon(n.direction),c="increase"===n.direction?"+":"decrease"===n.direction?"-":"";s.push(l+" "+c+d+" overall")}if(o){var p=this.formatPercentage(Math.abs(r.change_percent||0)),h=this.getTrendIcon(r.direction),u="increase"===r.direction?"+":"decrease"===r.direction?"-":"";s.push(h+" "+u+p+" since last")}var f=i?n.direction:r.direction;"increase"===f?a.addClass("trend-up"):"decrease"===f?a.addClass("trend-down"):a.addClass("trend-neutral"),a.find(".trend-icon").html(""),a.find(".trend-value").html(s.join(' <span class="trend-separator">|</span> '))}else a.addClass("d-none")},getTrendIcon:function(e){return"increase"===e?'<i class="fa fa-arrow-up trend-icon-up"></i>':"decrease"===e?'<i class="fa fa-arrow-down trend-icon-down"></i>':'<i class="fa fa-minus trend-icon-neutral"></i>'},formatPercentage:function(e){return e>=100?Math.round(e)+"%":e>=10?e.toFixed(0)+"%":e.toFixed(1)+"%"},formatNumber:function(e){if(null==e||"--"===e)return"--";var t=parseFloat(e);return isNaN(t)?e.toString():Math.abs(t)>=1e3?t.toLocaleString():t%1!=0?t.toFixed(2):t.toString()},formatTimestamp:function(e){if(!e)return"";var t=new Date(e),a=new Date-t,n=Math.floor(a/6e4),r=Math.floor(n/60),i=Math.floor(r/24);if(n<1)return"just now";if(n<60)return n+" min ago";if(r<24)return r+" hour"+(r>1?"s":"")+" ago";if(i<7)return i+" day"+(i>1?"s":"")+" ago";return["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][t.getMonth()]+" "+t.getDate()+", "+t.getFullYear()},getHistoryLimitForBaseline:function(e){switch(e){case"all_time":return 100;case"rolling_30d":return 60;case"month_start":return 62;case"rolling_7d":case"week_start":return 14;default:return 30}},renderKpiSparklineFromBackend:function(e,t,a){var n=a.map((function(e){return e.row_count})).reverse();this.renderKpiSparklineFromData(e,t,n,n[n.length-1])},handleTriggeredAlerts:function(e,t,a,n,r){var i=this;if(e&&0!==e.length){var o=i.config.alertsConfig||[],s=e.map((function(e){for(var i=e.alert_name||e.name||"Alert",s=parseFloat(e.current_value||e.actual_value||e.value||a||0),d=r||e.report_name||t||"Report",l=e.id||e.alert_id||0,c=null,p=0;p<o.length;p++)if(o[p].backend_id===l){c=o[p];break}var h="warning",u=e.threshold||e.threshold_value||"";if(c){var f=parseFloat(c.warning_value)||0,g=parseFloat(c.critical_value)||0;g>0&&s>=g?(h="critical",u=g):f>0&&s>=f&&(h="warning",u=f)}else h=e.severity||(e.is_critical?"critical":"warning");var m="Your "+d+" has reached "+s+", exceeding your "+h+" threshold ("+u+").";if(n&&n.has_previous){var b=n.direction||"change",v=Math.abs(n.change_absolute||0),C=Math.abs(n.change_percent||0).toFixed(1);m+="increase"===b?" "+i+" increased by "+v+" ("+C+"%) since last measurement.":"decrease"===b?" "+i+" decreased by "+v+" ("+C+"%) since last measurement.":" "+i+" has remained stable since last measurement."}return{alert_id:l,alert_name:i,message:m,severity:h,report_name:d,report_slug:e.report_slug||e.slug||t||"",current_value:String(s),threshold:String(u),notify_users:JSON.stringify(e.notify_users||[])}}));require(["core/ajax"],(function(e){e.call([{methodname:"block_adeptus_insights_send_alert_notification",args:{blockinstanceid:i.blockId,alerts:s}}])[0].done((function(e){e.success&&e.sent_count>0&&setTimeout((function(){i.refreshNotificationArea()}),500)})).fail((function(){}))}))}},refreshNotificationArea:function(){require(["jquery","core/ajax"],(function(e,t){try{var a=e("#nav-notification-popover-container");if(!a.length)return;var n=a.attr("data-userid");if(!n)return;t.call([{methodname:"message_popup_get_unread_popup_notification_count",args:{useridto:parseInt(n,10)}}])[0].done((function(e){var t=a.find('[data-region="count-container"]');t.length&&(e>0?(t.text(e),t.removeClass("hidden")):t.addClass("hidden"))})).fail((function(){}))}catch(e){}}))},loadKpiSparklineFromServer:function(e,t,a){this.config.snapshotsEnabled||e.find(".kpi-card-sparkline").addClass("d-none")},updateKpiTrendFromServer:function(e,t,a){var n=e.find(".kpi-card-trend");n.removeClass("d-none trend-up trend-down trend-neutral");var r,i=Math.abs(a);r=i>=100?Math.round(i)+"%":i>=10?i.toFixed(0)+"%":i.toFixed(1)+"%","up"===t?(n.addClass("trend-up"),n.find(".trend-icon").html('<i class="fa fa-arrow-up"></i>'),n.find(".trend-value").text(r+" vs previous")):"down"===t?(n.addClass("trend-down"),n.find(".trend-icon").html('<i class="fa fa-arrow-down"></i>'),n.find(".trend-value").text(r+" vs previous")):(n.addClass("trend-neutral"),n.find(".trend-icon").html('<i class="fa fa-minus"></i>'),n.find(".trend-value").text("No change"))},updateKpiTrend:function(e,t,a){var n=e.find(".kpi-card-trend");n.removeClass("d-none"),n.addClass("trend-neutral"),n.find(".trend-icon").html('<i class="fa fa-spinner fa-spin"></i>'),n.find(".trend-value").text("Loading...")},renderKpiSparklineFromData:function(e,t,a,n){var r=e.find(".kpi-card-sparkline"),i=r.find(".sparkline-chart")[0];if(i){var o=a.slice();if(0!==o.length&&o[o.length-1]===n||o.push(n),o.length<2)r.addClass("d-none");else{r.removeClass("d-none");var d=o[0],l=o[o.length-1],c=l>=d?"rgba(40, 167, 69, 0.8)":"rgba(220, 53, 69, 0.8)",p=l>=d?"rgba(40, 167, 69, 0.1)":"rgba(220, 53, 69, 0.1)",h="sparkline_"+this.blockId+"_"+t;this.kpiSparklineCharts&&this.kpiSparklineCharts[h]&&this.kpiSparklineCharts[h].destroy(),this.kpiSparklineCharts||(this.kpiSparklineCharts={});try{this.kpiSparklineCharts[h]=new s(i.getContext("2d"),{type:"line",data:{labels:o.map((function(){return""})),datasets:[{data:o,borderColor:c,backgroundColor:p,borderWidth:2,fill:!0,tension:.4,pointRadius:0,pointHoverRadius:0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{enabled:!1}},scales:{x:{display:!1},y:{display:!1}},elements:{line:{borderCapStyle:"round"}},animation:{duration:500}}})}catch(e){r.addClass("d-none")}}}},renderKpiSparkline:function(e,t,a){},renderTabs:function(t){var a=this,n=this.container.find(".block-adeptus-tab-nav"),r=this.container.find(".block-adeptus-tab-content"),i=e("#block-adeptus-tab-template-"+this.blockId),o=e("#block-adeptus-tab-pane-template-"+this.blockId);if(n.empty(),r.empty(),this.tabChartInstances={},t.slice(0,5).forEach((function(t,s){var d="tab-"+a.blockId+"-"+s,l=t.name||t.title||t.display_name||t.slug||"Report",c=e(i.html());c.find("a").attr("href","#"+d).attr("aria-controls",d),c.find(".tab-name").text(l),0===s&&c.find("a").addClass("active").attr("aria-selected","true"),n.append(c);var p=e(o.html());p.attr("id",d),p.attr("data-slug",t.slug),p.attr("data-source",t.source),0===s&&p.addClass("show active"),r.append(p)})),t.length>0){var s=r.find(".tab-pane").first();this.loadTabContent(s,t[0].slug,t[0].source)}this.container.find(".block-adeptus-tabs-container").removeClass("d-none")},loadTabContent:function(t,a,n){var r=this,i=a+"_"+n;if(t.data("loaded",!0),this.reportDataCache[i]){var o=this.reportDataCache[i];this.renderTabContent(t,o.report,o.results)}else{var s=this.reports.find((function(e){return e.slug===a}));if(!s)return t.find(".tab-pane-loading").addClass("d-none"),void t.find(".tab-pane-content").removeClass("d-none").html('<div class="text-center text-muted py-4"><i class="fa fa-exclamation-circle"></i><p class="mt-2">Report not found</p></div>');if("wizard"===n)e.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/generate_report.php",method:"POST",data:{reportid:s.name||s.report_template_id,sesskey:M.cfg.sesskey},dataType:"json",timeout:3e4}).done((function(e){e.success?(r.reportDataCache[i]={report:s,results:e.results||[]},r.renderTabContent(t,s,e.results||[])):(t.find(".tab-pane-loading").addClass("d-none"),t.find(".tab-pane-content").removeClass("d-none").html('<div class="text-center text-muted py-4"><i class="fa fa-exclamation-circle"></i><p class="mt-2">'+(e.message||"Failed to load")+"</p></div>"))})).fail((function(){t.find(".tab-pane-loading").addClass("d-none"),t.find(".tab-pane-content").removeClass("d-none").html('<div class="text-center text-muted py-4"><i class="fa fa-exclamation-circle"></i><p class="mt-2">Connection error</p></div>')}));else{var d=this.apiKey||(window.adeptusAuthData?window.adeptusAuthData.api_key:null);if(!d)return t.find(".tab-pane-loading").addClass("d-none"),void t.find(".tab-pane-content").removeClass("d-none").html('<div class="text-center text-muted py-4"><i class="fa fa-exclamation-circle"></i><p class="mt-2">Authentication required</p></div>');e.ajax({url:this.backendUrl+"/ai-reports/"+a,method:"GET",headers:{Authorization:"Bearer "+d,Accept:"application/json"},timeout:15e3}).done((function(e){if(e.success){var a=e.report||s,n=e.data||[],o=e.sql||a&&a.sql_query||a&&a.sql;if((e.execution_required||(!n||0===n.length)&&o)&&o)return void r.executeReportLocally(o,a.params||{}).then((function(e){var n=e.data||[];r.reportDataCache[i]={report:a,results:n},r.renderTabContent(t,a,n)})).catch((function(e){t.find(".tab-pane-loading").addClass("d-none"),t.find(".tab-pane-content").removeClass("d-none").html('<div class="text-center text-muted py-4"><i class="fa fa-exclamation-circle"></i><p class="mt-2">Failed to execute report</p></div>')}));r.reportDataCache[i]={report:a,results:n},r.renderTabContent(t,a,n)}else t.find(".tab-pane-loading").addClass("d-none"),t.find(".tab-pane-content").removeClass("d-none").html('<div class="text-center text-muted py-4"><i class="fa fa-exclamation-circle"></i><p class="mt-2">Failed to load report</p></div>')})).fail((function(){t.find(".tab-pane-loading").addClass("d-none"),t.find(".tab-pane-content").removeClass("d-none").html('<div class="text-center text-muted py-4"><i class="fa fa-exclamation-circle"></i><p class="mt-2">Connection error</p></div>')}))}}},renderTabContent:function(e,t,a){var n=e.attr("id");e.find(".tab-pane-loading").addClass("d-none");var r=e.find(".tab-pane-content");if(a&&0!==a.length){var i=Object.keys(a[0]),o=this.detectNumericColumns(a,i),s={data:a,report:t,headers:i,numericCols:o,currentView:"table",tablePage:1,rowsPerPage:25,chartType:"bar",xAxis:i[0],yAxis:o.length>0?o[o.length-1]:i[i.length-1]};this.tabPaneStates[n]=s,r.removeClass("d-none"),this.updateTabMetaBar(e,t,a),this.populateTabChartControls(e,s),this.renderTabTablePage(e,s),e.find(".tab-view-toggle-btn").removeClass("active"),e.find('.tab-view-toggle-btn[data-view="table"]').addClass("active"),e.find(".tab-table-view").removeClass("d-none"),e.find(".tab-chart-view").addClass("d-none")}else r.removeClass("d-none").html('<div class="text-center text-muted py-4"><i class="fa fa-inbox"></i><p class="mt-2">No data available</p></div>')},updateTabMetaBar:function(e,t,a){var n=t.category||t.category_name||"",r=e.find(".report-category");n?(r.text(n).removeClass("d-none"),t.category_color?r.css("background-color",t.category_color):r.addClass("bg-primary")):r.addClass("d-none"),e.find(".row-count-num").text(a.length);var i=t.updated_at||t.created_at||"";if(i){var o=new Date(i);e.find(".report-date").text(o.toLocaleDateString())}},populateTabChartControls:function(t,a){var n=t.find(".tab-chart-x-axis"),r=t.find(".tab-chart-y-axis");n.empty(),r.empty(),a.headers.forEach((function(t){var a=t.replace(/_/g," ").replace(/\b\w/g,(function(e){return e.toUpperCase()}));n.append(e("<option>").val(t).text(a)),r.append(e("<option>").val(t).text(a))})),n.val(a.xAxis),r.val(a.yAxis)},switchTabView:function(e,t){var a=e.attr("id"),n=this.tabPaneStates[a];n&&(n.currentView=t,e.find(".tab-view-toggle-btn").removeClass("active"),e.find('.tab-view-toggle-btn[data-view="'+t+'"]').addClass("active"),"table"===t?(e.find(".tab-table-view").removeClass("d-none"),e.find(".tab-chart-view").addClass("d-none")):(e.find(".tab-table-view").addClass("d-none"),e.find(".tab-chart-view").removeClass("d-none"),this.renderTabChart(e,n)))},renderTabTablePage:function(t,a){var n=t.find(".tab-table"),r=n.find("thead"),i=n.find("tbody"),o=a.data,s=a.headers;r.empty(),i.empty();var d=e("<tr>");s.forEach((function(t){var a=t.replace(/_/g," ").replace(/\b\w/g,(function(e){return e.toUpperCase()}));d.append(e("<th>").text(a))})),r.append(d);var l=o.length,c=Math.ceil(l/a.rowsPerPage),p=(a.tablePage-1)*a.rowsPerPage,h=Math.min(p+a.rowsPerPage,l);o.slice(p,h).forEach((function(t){var a=e("<tr>");s.forEach((function(n){var r=t[n];null==r&&(r="");var i=String(r);i.length>50&&(i=i.substring(0,50)+"..."),a.append(e("<td>").attr("title",r).text(i))})),i.append(a)}));var u="Showing "+(p+1)+"-"+h+" of "+l;t.find(".row-count").text(u),t.find(".tab-pagination-info").text("Page "+a.tablePage+" of "+c),t.find(".tab-pagination-prev").prop("disabled",a.tablePage<=1),t.find(".tab-pagination-next").prop("disabled",a.tablePage>=c),c>1?t.find(".tab-table-pagination").removeClass("d-none"):t.find(".tab-table-pagination").addClass("d-none")},renderTabChart:function(e,t){var a=e.attr("id"),n=e.find(".tab-chart")[0];if(n&&t.data&&0!==t.data.length){this.tabChartInstances&&this.tabChartInstances[a]&&this.tabChartInstances[a].destroy();var r=t.chartType,i=t.xAxis,o=t.yAxis,d=t.data,l=d.slice(0,20),c=l.map((function(e){var t=e[i];if(null==t)return"Unknown";var a=String(t);return a.length>20?a.substring(0,20)+"...":a})),p=l.map((function(e){return parseFloat(e[o])||0})),h=this.generateChartColors(p.length,r),u={type:r,data:{labels:c,datasets:[{label:o.replace(/_/g," ").replace(/\b\w/g,(function(e){return e.toUpperCase()})),data:p,backgroundColor:"pie"===r||"doughnut"===r?h:h[0],borderColor:"line"===r?h[0]:"pie"===r||"doughnut"===r?"#fff":h[0],borderWidth:"pie"===r||"doughnut"===r?2:1,fill:"line"!==r&&void 0,tension:"line"===r?.1:void 0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:"pie"===r||"doughnut"===r,position:"right"}},scales:"pie"===r||"doughnut"===r?{}:{y:{beginAtZero:!0},x:{display:d.length<=10}}}};try{this.tabChartInstances=this.tabChartInstances||{},this.tabChartInstances[a]=new s(n.getContext("2d"),u)}catch(t){e.find(".tab-chart-container").html('<div class="alert alert-warning text-center"><i class="fa fa-exclamation-circle"></i> Could not render chart</div>')}}},exportTabReport:function(t,n){var r=this;t&&t.data&&0!==t.data.length?e.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/check_export_eligibility.php",method:"POST",data:{format:n,sesskey:M.cfg.sesskey},dataType:"json"}).done((function(e){e.success&&e.eligible?r.performExport(n,t.report,t.data):r.showExportUpgradePrompt(n,e.message||"Export not available")})).fail((function(){a.addNotification({message:"Unable to verify export eligibility. Please try again.",type:"error"})})):a.addNotification({message:"No data to export",type:"warning"})},renderTabTable:function(t,a){var n=t.find("table"),r=n.find("thead"),i=n.find("tbody"),o=this.config.tableMaxRows||10;if(r.empty(),i.empty(),a&&0!==a.length){var s=Object.keys(a[0]),d=e("<tr>");s.forEach((function(t){var a=t.replace(/_/g," ").replace(/\b\w/g,(function(e){return e.toUpperCase()}));d.append(e("<th>").text(a))})),r.append(d),a.slice(0,o).forEach((function(t){var a=e("<tr>");s.forEach((function(n){var r=t[n];null==r&&(r="");var i=String(r);i.length>40&&(i=i.substring(0,40)+"..."),a.append(e("<td>").attr("title",r).text(i))})),i.append(a)}))}},handleReportClick:function(e,t){var a=this.config.clickAction||"modal";if("kpi"===this.config.displayMode&&this.config.alertsFeatureEnabled&&"modal"===a)this.openKpiModal(e,t);else switch(a){case"modal":this.openReportModal(e,t);break;case"newtab":this.openReportNewTab(e,t);break;case"expand":this.expandReportInline(e,t)}},openReportModal:function(e,t){var n=this,s=this.reports.find((function(t){return t.slug===e}));s&&(this.modalData=null,this.modalReport=null,this.currentView="table",this.chartInstance&&(this.chartInstance.destroy(),this.chartInstance=null),o.render("block_adeptus_insights/report_modal",{blockid:this.blockId}).then((function(e){return r.create({type:r.types.DEFAULT,title:s.name,body:e,large:!0})})).then((function(a){return n.modal=a,n.bindModalEvents(a),a.getRoot().on(i.shown,(function(){n.loadModalReport(e,t)})),a.getRoot().on(i.hidden,(function(){n.chartInstance&&(n.chartInstance.destroy(),n.chartInstance=null),a.destroy(),n.modal=null,n.modalData=null,n.modalReport=null})),a.show(),a})).catch(a.exception))},openKpiModal:function(e,t){var n=this,s=this.reports.find((function(t){return t.slug===e}));s&&(this.kpiModalData=null,this.kpiModalDateRange="30d",this.kpiModalChart&&(this.kpiModalChart.destroy(),this.kpiModalChart=null),o.render("block_adeptus_insights/kpi_modal",{blockid:this.blockId}).then((function(e){return r.create({type:r.types.DEFAULT,title:s.name,body:e,large:!0})})).then((function(a){return n.kpiModal=a,n.bindKpiModalEvents(a,e,t),a.getRoot().on(i.shown,(function(){n.loadKpiModalData(e,t,n.kpiModalDateRange)})),a.getRoot().on(i.hidden,(function(){n.kpiModalChart&&(n.kpiModalChart.destroy(),n.kpiModalChart=null),a.destroy(),n.kpiModal=null,n.kpiModalData=null})),a.show(),a})).catch(a.exception))},bindKpiModalEvents:function(t,a,n){var r=this,i=t.getRoot();i.on("change",".kpi-date-range-select",(function(){var t=e(this).val();r.kpiModalDateRange=t,r.loadKpiModalData(a,n,t)})),i.on("click",".kpi-modal-retry",(function(e){e.preventDefault(),r.loadKpiModalData(a,n,r.kpiModalDateRange)}))},loadKpiModalData:function(t,a,n){var r=this,i=this.kpiModal.getRoot().find(".block-adeptus-kpi-modal-content");i.find(".kpi-modal-loading").removeClass("d-none"),i.find(".kpi-modal-content-area").addClass("d-none"),i.find(".kpi-modal-error").addClass("d-none");var o=this.kpiSnapshotCache[t];if(o&&o.history&&Date.now()-o.timestamp<3e5)return r.kpiModalData=o,void r.renderKpiModal(i,o,n);var s=this.apiKey;if(s){var d="ai"===a?"/ai-reports/":"/reports/",l=this.config.baselinePeriod||"all_time",c=this.getKpiModalHistoryLimit(n),p=o?o.currentValue:0;e.ajax({url:this.backendUrl+d+encodeURIComponent(t)+"/snapshots?baseline_period="+l+"&history_limit="+c,method:"POST",headers:{Authorization:"Bearer "+s,"Content-Type":"application/json",Accept:"application/json"},data:JSON.stringify({row_count:p,execution_time_ms:0,evaluate_alerts:!1,baseline_period:l}),timeout:15e3,success:function(e){e&&e.success&&e.history?(r.kpiSnapshotCache[t]={history:e.history||[],trend:e.trend||{},currentValue:p,timestamp:Date.now()},r.kpiModalData=e,r.renderKpiModal(i,e,n)):r.showKpiModalError(i)},error:function(){r.showKpiModalError(i)}})}else r.showKpiModalError(i)},getKpiModalHistoryLimit:function(e){switch(e){case"7d":return 14;case"30d":default:return 60;case"90d":return 180;case"all":return 500}},renderKpiModal:function(e,t,a){e.find(".kpi-modal-loading").addClass("d-none"),e.find(".kpi-modal-content-area").removeClass("d-none"),e.find(".kpi-modal-error").addClass("d-none");var n=(t.history||[]).slice();n.sort((function(e,t){return new Date(e.recorded_at||e.created_at)-new Date(t.recorded_at||t.created_at)}));var r=t.trend||{},i=r.vs_baseline||{},o=r.vs_previous||{},s=this.filterKpiHistoryByDateRange(n,a),d=t.currentValue;!d&&s.length>0&&(d=s[s.length-1].row_count),d=d||"--",e.find(".kpi-modal-value").text(this.formatNumber(d)),this.renderKpiModalTrends(e,i,o);var l=this.calculateKpiStats(s);if(e.find(".kpi-stat-min").text(this.formatNumber(l.min)),e.find(".kpi-stat-max").text(this.formatNumber(l.max)),e.find(".kpi-stat-avg").text(this.formatNumber(l.avg)),e.find(".datapoints-count").text(s.length),s.length>0){var c=s[s.length-1],p=c.recorded_at||c.created_at;p&&e.find(".kpi-modal-last-updated").text("Last updated: "+this.formatTimestamp(p))}this.renderKpiModalChart(e,s)},filterKpiHistoryByDateRange:function(e,t){if("all"===t||!e||0===e.length)return e;var a,n=new Date;switch(t){case"7d":a=new Date(n.getTime()-6048e5);break;case"30d":a=new Date(n.getTime()-2592e6);break;case"90d":a=new Date(n.getTime()-7776e6);break;default:return e}return e.filter((function(e){return new Date(e.recorded_at||e.created_at)>=a}))},renderKpiModalTrends:function(e,t,a){var n="--";if(t&&t.has_baseline){var r=this.formatPercentage(Math.abs(t.change_percent||0)),i=this.getTrendIcon(t.direction);n='<span class="'+("trend-"+(t.direction||"neutral"))+'">'+i+" "+("increase"===t.direction?"+":"decrease"===t.direction?"-":"")+r+" overall</span>"}e.find(".kpi-modal-trend-baseline").html(n);var o="--";if(a&&a.has_previous){var s=this.formatPercentage(Math.abs(a.change_percent||0)),d=this.getTrendIcon(a.direction);o='<span class="'+("trend-"+(a.direction||"neutral"))+'">'+d+" "+("increase"===a.direction?"+":"decrease"===a.direction?"-":"")+s+" since last</span>"}e.find(".kpi-modal-trend-previous").html(o)},calculateKpiStats:function(e){if(!e||0===e.length)return{min:"--",max:"--",avg:"--"};var t=e.map((function(e){return parseFloat(e.row_count)||0})),a=Math.min.apply(null,t),n=Math.max.apply(null,t),r=t.reduce((function(e,t){return e+t}),0);return{min:a,max:n,avg:Math.round(r/t.length)}},renderKpiModalChart:function(e,t){var a=this,n=e.find(".kpi-modal-chart")[0];if(n){this.kpiModalChart&&this.kpiModalChart.destroy();var r=[],i=[],o=null;t.forEach((function(e){var t=parseFloat(e.row_count)||0;if(null===o||t!==o){var n=new Date(e.recorded_at||e.created_at);r.push(a.formatChartDate(n)),i.push(t),o=t}}));var d=n.getContext("2d");this.kpiModalChart=new s(d,{type:"line",data:{labels:r,datasets:[{label:"Value",data:i,borderColor:"#0066cc",backgroundColor:"rgba(0, 102, 204, 0.1)",borderWidth:2,fill:!0,tension:.3,pointRadius:4,pointHoverRadius:6,pointBackgroundColor:"#0066cc",pointBorderColor:"#fff",pointBorderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},plugins:{legend:{display:!1},tooltip:{enabled:!0,backgroundColor:"rgba(0, 0, 0, 0.8)",titleColor:"#fff",bodyColor:"#fff",padding:12,displayColors:!1,callbacks:{title:function(e){return e[0].label},label:function(e){return"Value: "+a.formatNumber(e.parsed.y)}}}},scales:{x:{display:!0,grid:{display:!1},ticks:{maxRotation:45,minRotation:0,autoSkip:!0,maxTicksLimit:10}},y:{display:!0,beginAtZero:!1,grid:{color:"rgba(0, 0, 0, 0.05)"},ticks:{callback:function(e){return a.formatNumber(e)}}}}}})}},formatChartDate:function(e){return["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][e.getMonth()]+" "+e.getDate()},showKpiModalError:function(e){e.find(".kpi-modal-loading").addClass("d-none"),e.find(".kpi-modal-content-area").addClass("d-none"),e.find(".kpi-modal-error").removeClass("d-none")},bindModalEvents:function(t){var a=this,n=t.getRoot();n.on("click",".view-toggle-btn",(function(t){t.preventDefault();var n=e(this).data("view");a.switchModalView(n)})),n.on("change","#modal-chart-type, #modal-chart-x-axis, #modal-chart-y-axis",(function(){"chart"===a.currentView&&a.renderModalChart()})),n.on("click",".modal-retry",(function(e){e.preventDefault(),a.modalReport&&a.loadModalReport(a.modalReport.slug,a.modalReport.source)})),n.on("click",".modal-export",(function(t){t.preventDefault();var n=e(this).data("format");a.exportModalData(n)})),n.on("click",".table-pagination-prev",(function(e){e.preventDefault(),a.tableCurrentPage>1&&(a.tableCurrentPage--,a.renderModalTablePage())})),n.on("click",".table-pagination-next",(function(e){e.preventDefault(),a.tableCurrentPage<a.tableTotalPages&&(a.tableCurrentPage++,a.renderModalTablePage())}))},switchModalView:function(e){var t=this.modal.getBody();t.find(".view-toggle-btn").removeClass("active"),t.find('.view-toggle-btn[data-view="'+e+'"]').addClass("active"),"table"===e?(t.find("#modal-table-view").removeClass("d-none"),t.find("#modal-chart-view").addClass("d-none")):(t.find("#modal-table-view").addClass("d-none"),t.find("#modal-chart-view").removeClass("d-none"),this.renderModalChart()),this.currentView=e},loadModalReport:function(t,a){var n=this,r=this.modal.getBody(),i=t+"_"+a;if(this.reportDataCache[i]){var o=this.reportDataCache[i];return r.find(".modal-loading").addClass("d-none"),void this.renderModalContent(r,o.report,o.results,o.chartData,o.chartType)}var s=this.reports.find((function(e){return e.slug===t}));if(!s)return r.find(".modal-loading").addClass("d-none"),void r.find(".modal-error").removeClass("d-none");if("wizard"===a)e.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/generate_report.php",method:"POST",data:{reportid:s.name||s.report_template_id,sesskey:M.cfg.sesskey},dataType:"json",timeout:3e4}).done((function(e){r.find(".modal-loading").addClass("d-none"),e.success?(n.reportDataCache[i]={report:s,results:e.results||[],chartData:e.chart_data,chartType:e.chart_type},n.renderModalContent(r,s,e.results||[],e.chart_data,e.chart_type)):(r.find(".modal-error").removeClass("d-none"),r.find(".modal-error p").text(e.message||"Failed to load report"))})).fail((function(){r.find(".modal-loading").addClass("d-none"),r.find(".modal-error").removeClass("d-none")}));else{var d=this.apiKey||(window.adeptusAuthData?window.adeptusAuthData.api_key:null);if(!d)return r.find(".modal-loading").addClass("d-none"),void r.find(".modal-error").removeClass("d-none");e.ajax({url:this.backendUrl+"/ai-reports/"+t,method:"GET",headers:{Authorization:"Bearer "+d,Accept:"application/json"},timeout:15e3}).done((function(e){if(e.success&&e.report){var t=e.report,a=e.data||[],o=e.sql||t&&t.sql_query||t&&t.sql;if((e.execution_required||(!a||0===a.length)&&o)&&o)return void n.executeReportLocally(o,t.params||{}).then((function(e){r.find(".modal-loading").addClass("d-none");var a=e.data||[];n.reportDataCache[i]={report:t,results:a,chartData:null,chartType:null},n.renderModalContent(r,t,a,null,null)})).catch((function(e){r.find(".modal-loading").addClass("d-none"),r.find(".modal-error").removeClass("d-none")}));r.find(".modal-loading").addClass("d-none"),n.reportDataCache[i]={report:t,results:a,chartData:null,chartType:null},n.renderModalContent(r,t,a,null,null)}else r.find(".modal-loading").addClass("d-none"),r.find(".modal-error").removeClass("d-none")})).fail((function(){r.find(".modal-loading").addClass("d-none"),r.find(".modal-error").removeClass("d-none")}))}},renderModalContent:function(e,t,a,n,r){this.modalData=a||[],this.modalReport=t,e.find(".modal-content-area").removeClass("d-none");var i=t.category_info||{name:"General",color:"#6c757d"};e.find(".report-category").text(i.name).css("background-color",i.color),e.find(".row-count-num").text(this.modalData.length),e.find(".report-date").text(t.last_executed_at?"Last run: "+new Date(t.last_executed_at).toLocaleDateString():""),this.populateAxisSelectors(e),this.renderModalTable(e,this.modalData),this.currentView="table",e.find(".view-toggle-btn").removeClass("active"),e.find('.view-toggle-btn[data-view="table"]').addClass("active"),e.find("#modal-table-view").removeClass("d-none"),e.find("#modal-chart-view").addClass("d-none")},populateAxisSelectors:function(e){var t=this.modalData;if(t&&0!==t.length){var a=Object.keys(t[0]),n=e.find("#modal-chart-x-axis"),r=e.find("#modal-chart-y-axis");n.empty(),r.empty();var i=this.detectNumericColumns(t,a);a.forEach((function(e,t){var a=e.replace(/_/g," ").replace(/\b\w/g,(function(e){return e.toUpperCase()})),r=0===t?" selected":"";n.append('<option value="'+e+'"'+r+">"+a+"</option>")}));var o=i.length>0?i:a;o.forEach((function(e,t){var a=e.replace(/_/g," ").replace(/\b\w/g,(function(e){return e.toUpperCase()})),n=t===o.length-1?" selected":"";r.append('<option value="'+e+'"'+n+">"+a+"</option>")}))}},detectNumericColumns:function(e,t){var a=[];return t.forEach((function(t){var n=e.every((function(e){var a=e[t];return null==a||""===a||!isNaN(parseFloat(a))&&isFinite(a)})),r=e.some((function(e){var a=e[t];return null!=a&&""!==a&&!isNaN(parseFloat(a))}));n&&r&&a.push(t)})),a},executeReportLocally:function(t,a){return a=a||{},new Promise((function(n,r){e.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/execute_ai_report.php",method:"POST",contentType:"application/json",data:JSON.stringify({sql:t,params:a,sesskey:M.cfg.sesskey}),timeout:6e4,success:function(e){e.success?n({data:e.data||[],headers:e.headers||[],row_count:e.row_count||0,error:null}):n({data:[],headers:[],row_count:0,error:e.message||"Query execution failed"})},error:function(e,t,a){r(new Error("Failed to execute report: "+a))}})}))},renderModalChart:function(){var e=this.modal.getBody(),t=this.modalData;if(t&&0!==t.length){var a=e.find(".modal-chart")[0];if(a){this.chartInstance&&(this.chartInstance.destroy(),this.chartInstance=null);var n=e.find("#modal-chart-type").val()||"bar",r=e.find("#modal-chart-x-axis").val(),i=e.find("#modal-chart-y-axis").val();if(!r||!i){var o=Object.keys(t[0]);r=r||o[0],i=i||o[o.length-1]}var d=i.replace(/_/g," ").replace(/\b\w/g,(function(e){return e.toUpperCase()})),l=t.slice(0,50),c=l.map((function(e){var t=e[r];if(null==t)return"Unknown";var a=String(t);return a.length>30?a.substring(0,30)+"...":a})),p=l.map((function(e){return parseFloat(e[i])||0})),h=this.generateChartColors(p.length,n),u=this.createChartConfig(n,c,p,d,h);try{this.chartInstance=new s(a.getContext("2d"),u)}catch(t){e.find(".chart-container").html('<div class="alert alert-danger"><i class="fa fa-exclamation-triangle"></i> Error rendering chart</div>')}}}else e.find(".chart-container").html('<div class="alert alert-warning text-center"><i class="fa fa-info-circle"></i> No data available for chart</div>')},createChartConfig:function(e,t,a,n,r){var i={responsive:!0,maintainAspectRatio:!1,plugins:{title:{display:!0,text:this.modalReport?this.modalReport.name:"Report",font:{size:14,weight:"bold"},padding:{top:10,bottom:20}},legend:{display:"pie"===e||"doughnut"===e,position:"right"}}};return"pie"===e||"doughnut"===e?{type:e,data:{labels:t,datasets:[{data:a,backgroundColor:r,borderWidth:2}]},options:i}:(i.scales={y:{beginAtZero:!0,title:{display:!0,text:n}},x:{title:{display:!1}}},{type:e,data:{labels:t,datasets:[{label:n,data:a,backgroundColor:"line"===e?"transparent":r[0],borderColor:r[0].replace("0.7","1"),borderWidth:2,fill:"line"!==e,tension:.1}]},options:i})},generateChartColors:function(e,t){for(var a=["rgba(37, 99, 235, 0.7)","rgba(16, 185, 129, 0.7)","rgba(245, 158, 11, 0.7)","rgba(239, 68, 68, 0.7)","rgba(139, 92, 246, 0.7)","rgba(6, 182, 212, 0.7)","rgba(236, 72, 153, 0.7)","rgba(132, 204, 22, 0.7)","rgba(249, 115, 22, 0.7)","rgba(99, 102, 241, 0.7)"],n=[],r=0;r<e;r++)n.push(a[r%a.length]);return n},exportModalData:function(t){var n=this,r=this.modalData,i=this.modalReport;r&&0!==r.length?e.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/check_export_eligibility.php",method:"POST",data:{format:t,sesskey:M.cfg.sesskey},dataType:"json"}).done((function(e){e.success&&e.eligible?n.performExport(t,i,r):n.showExportUpgradePrompt(t,e.message||"Export not available")})).fail((function(){a.addNotification({message:"Unable to verify export eligibility. Please try again.",type:"error"})})):a.addNotification({message:"No data to export",type:"warning"})},showExportUpgradePrompt:function(e,t){var n={pdf:"PDF",csv:"CSV",json:"JSON"}[e]||e.toUpperCase();a.alert(n+" Export",t||n+" export is not available on your current plan.","OK")},captureChartImage:function(e){return new Promise((function(t){setTimeout((function(){var a=document.querySelector(e);if(a)try{var n=a.toDataURL("image/png",.8);n&&n.length>100&&n.length<2e6?t(n):t(null)}catch(e){t(null)}else t(null)}),300)}))},performExport:function(t,n,r){var i=this,o={results:r,headers:r.length>0?Object.keys(r[0]):[],report_name:n?n.name:"Report",report_category:n&&n.category||"",parameters:{}},s=new FormData;s.append("reportid",n?n.slug:"block_export"),s.append("format",t),s.append("sesskey",M.cfg.sesskey),s.append("view",i.currentView||"table"),s.append("report_data",JSON.stringify(o));var d=Promise.resolve(null);if("pdf"===t&&"chart"===i.currentView){d=i.captureChartImage(".modal-chart, .embedded-chart, .tab-chart")}d.then((function(r){r&&s.append("chart_image",r),fetch(M.cfg.wwwroot+"/report/adeptus_insights/ajax/export_report.php",{method:"POST",body:s}).then((function(e){var t=e.headers.get("content-type");if(t&&t.includes("application/json"))return e.json().then((function(e){throw new Error(e.message||"Export failed")}));if(!e.ok)throw new Error("Export failed with status: "+e.status);return e.blob()})).then((function(e){var a=(n?n.name:"report").replace(/[^a-zA-Z0-9\s-]/g,"").replace(/\s+/g,"_").toLowerCase()+"_"+(new Date).toISOString().split("T")[0]+"."+({pdf:"pdf",csv:"csv",json:"json"}[t]||t),r=URL.createObjectURL(e),i=document.createElement("a");i.href=r,i.download=a,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(r)})).catch((function(e){a.addNotification({message:"Export failed: "+e.message,type:"error"})})),e.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/track_export.php",method:"POST",data:{format:t,report_name:n?n.name:"Block Export",sesskey:M.cfg.sesskey}})}))},renderModalTable:function(t,a){this.tableCurrentPage=1,this.tableTotalPages=Math.ceil((a?a.length:0)/this.tableRowsPerPage);var n=t.find(".modal-table").find("thead");if(n.empty(),a&&0!==a.length){var r=Object.keys(a[0]),i=e("<tr>");r.forEach((function(t){var a=t.replace(/_/g," ").replace(/\b\w/g,(function(e){return e.toUpperCase()}));i.append(e("<th>").text(a))})),n.append(i),this.renderModalTablePage()}else t.find(".modal-table-container").addClass("d-none")},renderModalTablePage:function(){var t=this.modal.getBody(),a=this.modalData||[],n=t.find(".modal-table").find("tbody");if(n.empty(),a&&0!==a.length){var r=Object.keys(a[0]),i=(this.tableCurrentPage-1)*this.tableRowsPerPage,o=i+this.tableRowsPerPage;a.slice(i,o).forEach((function(t){var a=e("<tr>");r.forEach((function(n){var r=t[n];null==r&&(r="");var i=String(r);i.length>100&&(i=i.substring(0,100)+"..."),a.append(e("<td>").attr("title",r).text(i))})),n.append(a)}));var s=Math.min(o,a.length);t.find(".row-count").text(a.length+" total rows"),t.find(".table-pagination-info").text(i+1+"-"+s+" of "+a.length),t.find(".table-pagination-prev").prop("disabled",this.tableCurrentPage<=1),t.find(".table-pagination-next").prop("disabled",this.tableCurrentPage>=this.tableTotalPages),this.tableTotalPages>1?t.find(".table-pagination").removeClass("d-none"):t.find(".table-pagination").addClass("d-none")}},openReportNewTab:function(e,t){var a=M.cfg.wwwroot+"/report/adeptus_insights/generated_reports.php?slug="+encodeURIComponent(e);window.open(a,"_blank")},expandReportInline:function(e,t){},exportReport:function(e){a.addNotification({message:"Export to "+e.toUpperCase()+" coming soon",type:"info"})},refresh:function(){var e=this.container.find(".block-adeptus-refresh i");e.addClass("fa-spin"),this.clearAllCaches(),this.showLoading();var t=this;this.waitForAuth((function(){t.fetchReports()})),setTimeout((function(){e.removeClass("fa-spin")}),1e3)},clearAllCaches:function(){try{sessionStorage.removeItem(this.cacheKey)}catch(e){}this.reportDataCache={}},setupAutoRefresh:function(){var e=this.config.autoRefresh;if(e&&"never"!==e){var t;switch(e){case"5m":t=3e5;break;case"15m":t=9e5;break;case"30m":t=18e5;break;case"1h":t=36e5;break;default:return}var a=this;this.refreshTimer=setInterval((function(){document.hidden||a.refresh()}),t)}},showLoading:function(){this.container.find(".block-adeptus-loading").removeClass("d-none"),this.container.find(".block-adeptus-report-list, .block-adeptus-kpi-grid, .block-adeptus-tabs-container, .block-adeptus-content").addClass("d-none"),this.container.find(".block-adeptus-empty, .block-adeptus-error").addClass("d-none")},hideLoading:function(){this.container.find(".block-adeptus-loading").addClass("d-none")},showEmpty:function(){this.hideLoading(),this.container.find(".block-adeptus-empty").removeClass("d-none")},showError:function(e){this.hideLoading(),this.container.find(".block-adeptus-error").removeClass("d-none")},updateTimestamp:function(){if(this.lastUpdated){var e=this.formatTimeAgo(this.lastUpdated),t=this.container.find(".block-adeptus-kpi-footer");if(t.length)return t.find(".timestamp-text").text(e),void t.removeClass("d-none");if(this.config.showTimestamp){var a=this.container.find(".block-adeptus-timestamp");a.find(".timestamp-text").text(e),a.removeClass("d-none")}}},scrollToListTop:function(){var e=this.container.find(".block-adeptus-report-list");e.length&&e[0].scrollIntoView({behavior:"smooth",block:"start"})},scrollToEmbeddedTableTop:function(){var e=this.container.find(".embedded-table-view");e.length&&e[0].scrollIntoView({behavior:"smooth",block:"start"})},showEmbeddedLoadingOverlay:function(){var e=this.container.find(".embedded-loading-overlay");this.container.find(".block-adeptus-content").removeClass("d-none"),e.removeClass("d-none").css("opacity",0).animate({opacity:1},150)},hideEmbeddedLoadingOverlay:function(){this.container.find(".embedded-loading-overlay").animate({opacity:0},150,(function(){e(this).addClass("d-none")}))},toggleSearchableDropdown:function(e){e.hasClass("open")?this.closeSearchableDropdown(e):this.openSearchableDropdown(e)},openSearchableDropdown:function(t){var a=this;this.container.find(".searchable-dropdown.open").each((function(){e(this).is(t)||a.closeSearchableDropdown(e(this))})),t.addClass("open"),t.find(".searchable-dropdown-toggle").attr("aria-expanded","true");var n=t.find(".searchable-dropdown-input");n.val(""),t.find(".searchable-dropdown-item").show().removeClass("focused"),t.find(".searchable-dropdown-empty").addClass("d-none"),setTimeout((function(){n.focus()}),50)},closeSearchableDropdown:function(e){e.removeClass("open"),e.find(".searchable-dropdown-toggle").attr("aria-expanded","false"),e.find(".searchable-dropdown-item").removeClass("focused")},filterSearchableDropdown:function(t,a){var n=t.find(".searchable-dropdown-item"),r=t.find(".searchable-dropdown-empty"),i=0;n.each((function(){var t=e(this).data("search")||"";""===a||-1!==t.indexOf(a)?(e(this).show(),i++):e(this).hide()})),n.filter(":hidden").removeClass("focused"),0===i?r.removeClass("d-none"):r.addClass("d-none")},selectSearchableDropdownItem:function(e,t,a){e.find(".searchable-dropdown-text").text(a),e.find(".searchable-dropdown-item").removeClass("selected"),e.find('.searchable-dropdown-item[data-value="'+t+'"]').addClass("selected");var n=e.siblings("select");n.length&&n.val(t).trigger("change"),this.closeSearchableDropdown(e)},scrollDropdownItemIntoView:function(e){var t=e.closest(".searchable-dropdown-list"),a=t.height(),n=e.position().top,r=e.outerHeight();n<0?t.scrollTop(t.scrollTop()+n):n+r>a&&t.scrollTop(t.scrollTop()+(n+r-a))},escapeHtml:function(e){var t=document.createElement("div");return t.textContent=e,t.innerHTML},formatTimeAgo:function(e){var t=Math.floor((new Date-e)/1e3);if(t<60)return"Just now";var a=Math.floor(t/60);if(a<60)return a+" minute"+(1!==a?"s":"")+" ago";var n=Math.floor(a/60);if(n<24)return n+" hour"+(1!==n?"s":"")+" ago";var r=Math.floor(n/24);return r+" day"+(1!==r?"s":"")+" ago"}},{init:function(e){return new d(e)}}}));
//# sourceMappingURL=block.min.js.map