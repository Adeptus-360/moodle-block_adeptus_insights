/**
 * Main JavaScript controller for the Adeptus Insights block.
 *
 * @module     block_adeptus_insights/block
 * @copyright  2025 Adeptus Analytics
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("block_adeptus_insights/block",["jquery","core/ajax","core/notification","core/str","core/modal_factory","core/modal_events","core/templates","core/chartjs"],(function($,Ajax,Notification,Str,ModalFactory,ModalEvents,Templates,Chart){var BlockController=function(options){this.blockId=options.blockid,this.contextId=options.contextid,this.config=options.config||{},this.apiKey=options.apiKey||"",this.isAdmin=options.isAdmin||!1,this.container=null,this.reports=[],this.lastUpdated=null,this.refreshTimer=null,this.modal=null,this.modalData=null,this.modalReport=null,this.chartInstance=null,this.currentView="table",this.listCurrentPage=1,this.listItemsPerPage=this.config.maxLinkItems||10,this.listTotalPages=1,this.tableCurrentPage=1,this.tableRowsPerPage=25,this.tableTotalPages=1,this.selectedCategory="",this.availableCategories=[],this.selectedReportSlug=this.config.defaultReport||"",this.selectedReportSource="",this.embeddedCurrentView="table",this.embeddedTablePage=1,this.embeddedTableRowsPerPage=25,this.embeddedChartType="bar",this.embeddedXAxis="",this.embeddedYAxis="",this.backendUrl=this.config.backendUrl||"https://backend.adeptus360.com/api/v1",this.cacheKey="adeptus_block_reports_"+this.blockId,this.cacheTTL=3e5,this.reportDataCache={},this.preloadTimeout=null,this.preloadingSlug=null,this.tabPaneStates={},this.tabChartInstances={},this.registeredSnapshots={},this.init()};return BlockController.prototype={init:function(){this.container=$('[data-blockid="'+this.blockId+'"]'),this.container.length&&(this.bindEvents(),this.loadReports(),this.setupAutoRefresh())},bindEvents:function(){var self=this;this.container.on("click",".block-adeptus-refresh, .block-adeptus-retry",(function(e){e.preventDefault(),self.refresh()})),this.container.on("click",".block-adeptus-report-item",(function(e){e.preventDefault();var slug=$(this).data("slug"),source=$(this).data("source");self.handleReportClick(slug,source)})),this.container.on("keydown",".block-adeptus-report-item",(function(e){if("Enter"===e.key||" "===e.key){e.preventDefault();var slug=$(this).data("slug"),source=$(this).data("source");self.handleReportClick(slug,source)}})),this.container.on("click",".block-adeptus-kpi-card",(function(e){e.preventDefault();var slug=$(this).data("slug"),source=$(this).data("source");self.handleReportClick(slug,source)})),this.container.on("shown.bs.tab",".block-adeptus-tab-nav a",(function(e){var tabPane=$($(e.target).attr("href")),slug=tabPane.data("slug"),source=tabPane.data("source");tabPane.data("loaded")||self.loadTabContent(tabPane,slug,source)})),this.container.on("click",".block-adeptus-export",(function(e){e.preventDefault();var format=$(this).data("format");self.exportReport(format)})),this.container.on("click",".pagination-prev",(function(e){e.preventDefault(),self.listCurrentPage>1&&(self.listCurrentPage--,self.renderCurrentPage(),self.scrollToListTop())})),this.container.on("click",".pagination-next",(function(e){e.preventDefault(),self.listCurrentPage<self.listTotalPages&&(self.listCurrentPage++,self.renderCurrentPage(),self.scrollToListTop())})),this.container.on("change",".category-filter-select",(function(){self.selectedCategory=$(this).val(),self.listCurrentPage=1,"embedded"===self.config.displayMode?self.populateReportSelector():self.renderReports()})),this.container.on("change",".report-selector-select",(function(){var selectedValue=$(this).val();if(selectedValue){var parts=selectedValue.split("::"),slug=parts[0],source=parts[1]||"wizard";self.selectedReportSlug=slug,self.selectedReportSource=source,self.embeddedTablePage=1,self.embeddedCurrentView="table",self.loadEmbeddedReport(slug,source)}})),this.container.on("click",".searchable-dropdown-toggle",(function(e){e.preventDefault(),e.stopPropagation();var dropdown=$(this).closest(".searchable-dropdown");self.toggleSearchableDropdown(dropdown)})),this.container.on("input",".searchable-dropdown-input",(function(){var dropdown=$(this).closest(".searchable-dropdown"),query=$(this).val().toLowerCase().trim();self.filterSearchableDropdown(dropdown,query)})),this.container.on("click",".searchable-dropdown-item",(function(e){e.preventDefault(),e.stopPropagation();var dropdown=$(this).closest(".searchable-dropdown"),value=$(this).data("value"),text=$(this).find(".dropdown-item-name").text();self.selectSearchableDropdownItem(dropdown,value,text)})),this.container.on("keydown",".searchable-dropdown-input",(function(e){var dropdown=$(this).closest(".searchable-dropdown"),items=dropdown.find(".searchable-dropdown-item:visible"),focused=dropdown.find(".searchable-dropdown-item.focused");if("ArrowDown"===e.key)if(e.preventDefault(),0===focused.length)items.first().addClass("focused");else{var next=focused.nextAll(".searchable-dropdown-item:visible").first();next.length&&(focused.removeClass("focused"),next.addClass("focused"),self.scrollDropdownItemIntoView(next))}else if("ArrowUp"===e.key){if(e.preventDefault(),focused.length){var prev=focused.prevAll(".searchable-dropdown-item:visible").first();prev.length&&(focused.removeClass("focused"),prev.addClass("focused"),self.scrollDropdownItemIntoView(prev))}}else"Enter"===e.key?(e.preventDefault(),focused.length?focused.trigger("click"):1===items.length&&items.first().trigger("click")):"Escape"===e.key&&self.closeSearchableDropdown(dropdown)})),$(document).on("click",(function(e){$(e.target).closest(".searchable-dropdown").length||self.container.find(".searchable-dropdown.open").each((function(){self.closeSearchableDropdown($(this))}))})),this.container.on("click",".embedded-view-toggle-btn",(function(e){e.preventDefault();var view=$(this).data("view");self.switchEmbeddedView(view)})),this.container.on("click",".embedded-pagination-prev",(function(e){e.preventDefault(),self.embeddedTablePage>1&&(self.embeddedTablePage--,self.renderEmbeddedTablePage(),self.scrollToEmbeddedTableTop())})),this.container.on("click",".embedded-pagination-next",(function(e){e.preventDefault();var totalPages=Math.ceil((self.embeddedData||[]).length/self.embeddedTableRowsPerPage);self.embeddedTablePage<totalPages&&(self.embeddedTablePage++,self.renderEmbeddedTablePage(),self.scrollToEmbeddedTableTop())})),this.container.on("change",".embedded-chart-type",(function(){self.embeddedChartType=$(this).val(),self.renderEmbeddedChart()})),this.container.on("change",".embedded-chart-x-axis",(function(){self.embeddedXAxis=$(this).val(),self.renderEmbeddedChart()})),this.container.on("change",".embedded-chart-y-axis",(function(){self.embeddedYAxis=$(this).val(),self.renderEmbeddedChart()})),this.container.on("click",".embedded-export",(function(e){e.preventDefault();var format=$(this).data("format");self.exportEmbeddedReport(format)})),this.container.on("click",".tab-view-toggle-btn",(function(e){e.preventDefault();var pane=$(this).closest(".tab-pane"),view=$(this).data("view");self.switchTabView(pane,view)})),this.container.on("click",".tab-pagination-prev",(function(e){e.preventDefault();var pane=$(this).closest(".tab-pane"),tabId=pane.attr("id"),state=self.tabPaneStates[tabId];state&&state.tablePage>1&&(state.tablePage--,self.renderTabTablePage(pane,state))})),this.container.on("click",".tab-pagination-next",(function(e){e.preventDefault();var pane=$(this).closest(".tab-pane"),tabId=pane.attr("id"),state=self.tabPaneStates[tabId];if(state){var totalPages=Math.ceil(state.data.length/state.rowsPerPage);state.tablePage<totalPages&&(state.tablePage++,self.renderTabTablePage(pane,state))}})),this.container.on("change",".tab-chart-type",(function(){var pane=$(this).closest(".tab-pane"),tabId=pane.attr("id"),state=self.tabPaneStates[tabId];state&&(state.chartType=$(this).val(),self.renderTabChart(pane,state))})),this.container.on("change",".tab-chart-x-axis",(function(){var pane=$(this).closest(".tab-pane"),tabId=pane.attr("id"),state=self.tabPaneStates[tabId];state&&(state.xAxis=$(this).val(),self.renderTabChart(pane,state))})),this.container.on("change",".tab-chart-y-axis",(function(){var pane=$(this).closest(".tab-pane"),tabId=pane.attr("id"),state=self.tabPaneStates[tabId];state&&(state.yAxis=$(this).val(),self.renderTabChart(pane,state))})),this.container.on("click",".tab-export",(function(e){e.preventDefault();var tabId=$(this).closest(".tab-pane").attr("id"),state=self.tabPaneStates[tabId],format=$(this).data("format");state&&self.exportTabReport(state,format)})),this.container.on("mouseenter",".block-adeptus-report-item",(function(){var slug=$(this).data("slug"),source=$(this).data("source");self.preloadTimeout&&clearTimeout(self.preloadTimeout),self.preloadTimeout=setTimeout((function(){self.preloadReportData(slug,source)}),300)})),this.container.on("mouseleave",".block-adeptus-report-item",(function(){self.preloadTimeout&&(clearTimeout(self.preloadTimeout),self.preloadTimeout=null)}))},loadReports:function(){var self=this;this.showLoading();var cachedData=this.getFromCache();if(cachedData)return this.reports=cachedData,this.lastUpdated=new Date,void this.renderReports();this.waitForAuth((function(){self.fetchReports()}))},getFromCache:function(){try{var cached=sessionStorage.getItem(this.cacheKey);if(cached){var data=JSON.parse(cached);if(data.timestamp&&Date.now()-data.timestamp<this.cacheTTL)return data.reports;sessionStorage.removeItem(this.cacheKey)}}catch(e){}return null},saveToCache:function(reports){try{sessionStorage.setItem(this.cacheKey,JSON.stringify({timestamp:Date.now(),reports:reports}))}catch(e){}},preloadReportData:function(slug,source){var self=this,cacheKey=slug+"_"+source;if(!this.reportDataCache[cacheKey]&&this.preloadingSlug!==slug){this.preloadingSlug=slug;var report=this.reports.find((function(r){return r.slug===slug}));if(report)if("wizard"===source)$.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/generate_report.php",method:"POST",data:{reportid:report.name||report.report_template_id,sesskey:M.cfg.sesskey},dataType:"json",timeout:3e4}).done((function(response){response.success&&(self.reportDataCache[cacheKey]={report:report,results:response.results||[],chartData:response.chart_data,chartType:response.chart_type}),self.preloadingSlug=null})).fail((function(){self.preloadingSlug=null}));else{var token=this.apiKey||(window.adeptusAuthData?window.adeptusAuthData.api_key:null);if(!token)return;$.ajax({url:this.backendUrl+"/ai-reports/"+slug,method:"GET",headers:{Authorization:"Bearer "+token,Accept:"application/json"},timeout:15e3}).done((function(response){if(response.success&&response.report){var reportData=response.report,data=response.data||[],sqlQuery=response.sql||reportData&&reportData.sql_query||reportData&&reportData.sql;if((response.execution_required||(!data||0===data.length)&&sqlQuery)&&sqlQuery)return void self.executeReportLocally(sqlQuery,reportData.params||{}).then((function(executionResult){var localData=executionResult.data||[];self.reportDataCache[cacheKey]={report:reportData,results:localData,chartData:null,chartType:null},self.preloadingSlug=null})).catch((function(){self.preloadingSlug=null}));self.reportDataCache[cacheKey]={report:reportData,results:data,chartData:null,chartType:null}}self.preloadingSlug=null})).fail((function(){self.preloadingSlug=null}))}}},waitForAuth:function(callback){var self=this;if(this.apiKey)return window.adeptusAuthData=window.adeptusAuthData||{},window.adeptusAuthData.api_key=this.apiKey,void callback();window.adeptusAuthData&&window.adeptusAuthData.api_key?callback():$.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/get_auth_status.php",method:"GET",dataType:"json",timeout:1e4}).done((function(response){response&&response.success&&response.data?(window.adeptusAuthData=response.data,callback()):self.showError("Authentication failed")})).fail((function(){self.showError("Could not authenticate")}))},fetchReports:function(){var self=this,token=this.apiKey||(window.adeptusAuthData?window.adeptusAuthData.api_key:null);if(token){var promises=[],source=this.config.reportSource||"all";"all"!==source&&"wizard"!==source&&"manual"!==source&&"category"!==source||promises.push(this.fetchFromApi("/wizard-reports",token)),"all"!==source&&"ai"!==source&&"manual"!==source&&"category"!==source||promises.push(this.fetchFromApi("/ai-reports",token)),$.when.apply($,promises).then((function(){for(var allReports=[],i=0;i<promises.length;i++){var result,reports=(result=1===promises.length?arguments[0]:arguments[i][0]).reports||result.data||[];if(reports&&reports.length){var fetchesBoth="all"===source||"manual"===source||"category"===source,reportSource="ai"===source||1===i&&fetchesBoth?"ai":"wizard";reports.forEach((function(report){report.source=report.source||reportSource,allReports.push(report)}))}}self.reports=allReports,self.lastUpdated=new Date,self.saveToCache(allReports),self.renderReports()})).fail((function(){self.showError()}))}else this.showError("No authentication token")},fetchFromApi:function(endpoint,token){var baseUrl=""+this.backendUrl;return $.ajax({url:baseUrl+endpoint,method:"GET",headers:{Authorization:"Bearer "+token,"Content-Type":"application/json",Accept:"application/json"},timeout:15e3})},renderReports:function(){var mode=this.config.displayMode||"links";if(0!==this.reports.length){"embedded"!==mode&&"links"!==mode||this.populateCategoryFilter();var filteredReports=this.filterReports();switch(mode){case"embedded":this.renderEmbedded(filteredReports);break;case"kpi":var kpiReports=this.getSelectedReportsForMode("kpi",this.reports);this.renderKpi(kpiReports);break;case"tabs":var tabsReports=this.getSelectedReportsForMode("tabs",this.reports);this.renderTabs(tabsReports);break;default:this.renderLinks(filteredReports)}this.hideLoading(),this.updateTimestamp()}else this.showEmpty()},getSelectedReportsForMode:function(mode,allReports){var selectedConfig=[];if("kpi"===mode&&this.config.kpiSelectedReports&&this.config.kpiSelectedReports.length>0?selectedConfig=this.config.kpiSelectedReports:"tabs"===mode&&this.config.tabsSelectedReports&&this.config.tabsSelectedReports.length>0&&(selectedConfig=this.config.tabsSelectedReports),0===selectedConfig.length)return allReports;var result=[];return selectedConfig.forEach((function(item){var slug=item.slug||item,source=item.source||"wizard",report=allReports.find((function(r){return r.slug===slug&&(r.source===source||!item.source)}));if(report){var enrichedReport=Object.assign({},report);item.icon&&(enrichedReport.customIcon=item.icon),result.push(enrichedReport)}})),result},populateCategoryFilter:function(){var self=this,categoryMap={},config=this.config,categoryLocked=!!config.reportCategory;if(categoryLocked&&(this.selectedCategory=config.reportCategory),this.reports.forEach((function(report){var catInfo=report.category_info;catInfo&&catInfo.slug?categoryMap[catInfo.slug]={slug:catInfo.slug,name:catInfo.name||catInfo.slug,color:catInfo.color||"#6c757d"}:report.category&&(categoryMap[report.category]={slug:report.category,name:report.category,color:"#6c757d"})})),categoryLocked&&!categoryMap[config.reportCategory]){var displayName=config.reportCategory.replace(/[-_]/g," ").replace(/\b\w/g,(function(l){return l.toUpperCase()}));categoryMap[config.reportCategory]={slug:config.reportCategory,name:displayName,color:"#6c757d"}}this.availableCategories=Object.values(categoryMap).sort((function(a,b){return a.name.localeCompare(b.name)}));var select=this.container.find(".category-filter-select"),dropdown=this.container.find(".category-dropdown"),dropdownList=dropdown.find(".searchable-dropdown-list");if(select.length&&(select.find("option:not(:first)").remove(),this.availableCategories.forEach((function(cat){var selected=self.selectedCategory===cat.slug?" selected":"";select.append('<option value="'+cat.slug+'"'+selected+">"+cat.name+"</option>")}))),dropdownList.length){dropdownList.empty();var allItemHtml='<li class="searchable-dropdown-item '+(this.selectedCategory?"":"selected")+'" data-value="" data-search="all categories" role="option"><span class="dropdown-item-name">All Categories</span></li>';dropdownList.append(allItemHtml),this.availableCategories.forEach((function(cat){var itemHtml='<li class="searchable-dropdown-item '+(self.selectedCategory===cat.slug?"selected":"")+'" data-value="'+cat.slug+'" data-search="'+cat.name.toLowerCase()+'" role="option"><span class="dropdown-item-name">'+self.escapeHtml(cat.name)+'</span><span class="dropdown-item-category" style="background-color: '+cat.color+'"><i class="fa fa-circle" style="font-size: 0.5rem;"></i></span></li>';dropdownList.append(itemHtml)}));var selectedText="All Categories";if(this.selectedCategory){var selectedCat=this.availableCategories.find((function(c){return c.slug===self.selectedCategory}));selectedCat&&(selectedText=selectedCat.name)}dropdown.find(".searchable-dropdown-text").text(selectedText),categoryLocked&&this.container.find(".block-adeptus-category-filter").hide()}},populateReportSelector:function(){var self=this,select=this.container.find(".report-selector-select"),dropdown=this.container.find(".block-adeptus-report-selector .searchable-dropdown"),dropdownList=dropdown.find(".searchable-dropdown-list");if(select.length){var reports=this.filterReports();if(select.find("option:not(:first)").remove(),dropdownList.empty(),reports.forEach((function(report){var reportName=report.name||report.title||report.display_name||report.slug||"Untitled",value=report.slug+"::"+report.source,categoryInfo=report.category_info||{name:"General",color:"#6c757d"},categoryLabel=" ["+categoryInfo.name+"]",selected=self.selectedReportSlug===report.slug?" selected":"";select.append('<option value="'+value+'"'+selected+">"+reportName+categoryLabel+"</option>");var itemHtml='<li class="searchable-dropdown-item" data-value="'+value+'" data-search="'+reportName.toLowerCase()+" "+categoryInfo.name.toLowerCase()+'" role="option"><span class="dropdown-item-name">'+self.escapeHtml(reportName)+'</span><span class="dropdown-item-category" style="background-color: '+categoryInfo.color+'">'+self.escapeHtml(categoryInfo.name)+"</span></li>";dropdownList.append(itemHtml)})),this.selectedReportSlug&&!select.val()){var defaultOption=select.find('option[value^="'+this.selectedReportSlug+'::"]');defaultOption.length&&defaultOption.prop("selected",!0)}if(!select.val()&&reports.length>0){var firstReport=reports[0],firstValue=firstReport.slug+"::"+firstReport.source,firstName=firstReport.name||firstReport.title||firstReport.display_name||firstReport.slug||"Untitled";select.val(firstValue),this.selectedReportSlug=firstReport.slug,this.selectedReportSource=firstReport.source,dropdown.find(".searchable-dropdown-text").text(firstName),dropdown.find(".searchable-dropdown-item").removeClass("selected"),dropdown.find('.searchable-dropdown-item[data-value="'+firstValue+'"]').addClass("selected"),this.loadEmbeddedReport(firstReport.slug,firstReport.source)}else if(select.val()){var parts=select.val().split("::"),selectedReport=reports.find((function(r){return r.slug===parts[0]}));if(selectedReport){var selectedName=selectedReport.name||selectedReport.title||selectedReport.display_name||selectedReport.slug||"Untitled";dropdown.find(".searchable-dropdown-text").text(selectedName),dropdown.find(".searchable-dropdown-item").removeClass("selected"),dropdown.find('.searchable-dropdown-item[data-value="'+select.val()+'"]').addClass("selected")}this.loadEmbeddedReport(parts[0],parts[1]||"wizard")}else dropdown.find(".searchable-dropdown-text").text("-- No Reports --"),this.showEmpty()}},filterReports:function(){var self=this,reports=this.reports.slice(),config=this.config;return config.reportCategory&&(reports=reports.filter((function(r){return(r.category_info?r.category_info.slug:r.category||"")===config.reportCategory}))),this.selectedCategory&&this.selectedCategory!==config.reportCategory&&(reports=reports.filter((function(r){return(r.category_info?r.category_info.slug:r.category||"")===self.selectedCategory}))),reports.sort((function(a,b){var nameA=a.name||a.title||a.display_name||a.report_name||a.slug||"",nameB=b.name||b.title||b.display_name||b.report_name||b.slug||"";return nameA.localeCompare(nameB)})),reports},renderLinks:function(reports){this.filteredReports=reports,this.listItemsPerPage=this.config.maxLinkItems||10,this.listTotalPages=Math.ceil(reports.length/this.listItemsPerPage),this.listCurrentPage=1,this.renderCurrentPage()},renderCurrentPage:function(){var reports=this.filteredReports||[],listContainer=this.container.find(".block-adeptus-report-list"),template=$("#block-adeptus-report-item-template-"+this.blockId),paginationContainer=this.container.find(".block-adeptus-pagination"),startIndex=(this.listCurrentPage-1)*this.listItemsPerPage,endIndex=startIndex+this.listItemsPerPage,pageReports=reports.slice(startIndex,endIndex);if(listContainer.empty(),pageReports.forEach((function(report){var item=template.html(),$item=$(item);$item.attr("data-slug",report.slug),$item.attr("data-source",report.source);var reportName=report.name||report.title||report.display_name||report.report_name||report.slug||"Untitled Report";$item.find(".report-item-name").text(reportName);var categoryName=report.category_info?report.category_info.name:report.category||"General",categoryColor=report.category_info?report.category_info.color:"#6c757d";$item.find(".report-item-category").text(categoryName).css("background-color",categoryColor).css("color","#fff"),listContainer.append($item)})),listContainer.removeClass("d-none"),this.listTotalPages>1){var actualEnd=startIndex+pageReports.length;paginationContainer.find(".pagination-showing").text("Showing "+(startIndex+1)+"-"+actualEnd+" of "+reports.length),paginationContainer.find(".pagination-pages").text("Page "+this.listCurrentPage+" of "+this.listTotalPages),paginationContainer.find(".pagination-prev").prop("disabled",this.listCurrentPage<=1),paginationContainer.find(".pagination-next").prop("disabled",this.listCurrentPage>=this.listTotalPages),paginationContainer.removeClass("d-none")}else paginationContainer.addClass("d-none")},renderEmbedded:function(reports){this.embeddedReport=null,this.embeddedData=null,this.embeddedChartInstance=null,this.populateReportSelector(),0===this.reports.length&&this.showEmpty()},loadEmbeddedReport:function(slug,source){var self=this,cacheKey=slug+"_"+source;if(this.reportDataCache[cacheKey]){var cached=this.reportDataCache[cacheKey];return this.embeddedData=cached.results,void this.renderEmbeddedContent(cached.report,cached.results)}this.showEmbeddedLoadingOverlay();var report=this.reports.find((function(r){return r.slug===slug}));if(!report)return this.hideEmbeddedLoadingOverlay(),void this.showError("Report not found");if("wizard"===source)$.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/generate_report.php",method:"POST",data:{reportid:report.name||report.report_template_id,sesskey:M.cfg.sesskey},dataType:"json",timeout:3e4}).done((function(response){self.hideEmbeddedLoadingOverlay(),response.success?(self.reportDataCache[cacheKey]={report:report,results:response.results||[],chartData:response.chart_data,chartType:response.chart_type},self.embeddedData=response.results||[],self.renderEmbeddedContent(report,response.results||[])):self.showError(response.message||"Failed to load report")})).fail((function(){self.hideEmbeddedLoadingOverlay(),self.showError("Connection error")}));else{var token=this.apiKey||(window.adeptusAuthData?window.adeptusAuthData.api_key:null);if(!token)return this.hideEmbeddedLoadingOverlay(),void this.showError("No authentication token");$.ajax({url:this.backendUrl+"/ai-reports/"+slug,method:"GET",headers:{Authorization:"Bearer "+token,Accept:"application/json"},timeout:15e3}).done((function(response){if(response.success&&response.report){var reportData=response.report,data=response.data||[],sqlQuery=response.sql||reportData&&reportData.sql_query||reportData&&reportData.sql;if((response.execution_required||(!data||0===data.length)&&sqlQuery)&&sqlQuery)return void self.executeReportLocally(sqlQuery,reportData.params||{}).then((function(executionResult){self.hideEmbeddedLoadingOverlay();var localData=executionResult.data||[];self.reportDataCache[cacheKey]={report:reportData,results:localData,chartData:null,chartType:null},self.embeddedData=localData,self.renderEmbeddedContent(reportData,localData)})).catch((function(error){self.hideEmbeddedLoadingOverlay(),self.showError("Failed to execute report")}));self.hideEmbeddedLoadingOverlay(),self.reportDataCache[cacheKey]={report:reportData,results:data,chartData:null,chartType:null},self.embeddedData=data,self.renderEmbeddedContent(reportData,data)}else self.hideEmbeddedLoadingOverlay(),self.showError("Failed to load report")})).fail((function(){self.hideEmbeddedLoadingOverlay(),self.showError("Connection error")}))}},renderEmbeddedContent:function(report,data){var contentArea=this.container.find(".block-adeptus-content");if(data&&0!==data.length){this.embeddedReport=report,this.embeddedData=data;var category=report.category_info||{name:"General",color:"#6c757d"};this.container.find(".report-category").text(category.name).css("background-color",category.color).css("color","#fff"),this.container.find(".row-count-num").text(data.length),this.container.find(".report-date").text("Updated: "+(new Date).toLocaleTimeString()),this.populateEmbeddedChartControls(data),this.embeddedCurrentView="table",this.embeddedTablePage=1,this.container.find(".embedded-view-toggle-btn").removeClass("active"),this.container.find('.embedded-view-toggle-btn[data-view="table"]').addClass("active"),this.container.find(".embedded-table-view").removeClass("d-none"),this.container.find(".embedded-chart-view").addClass("d-none"),this.renderEmbeddedTablePage(),contentArea.removeClass("d-none"),this.hideLoading(),this.updateTimestamp()}else this.showEmpty()},switchEmbeddedView:function(view){this.embeddedCurrentView=view,this.container.find(".embedded-view-toggle-btn").removeClass("active"),this.container.find('.embedded-view-toggle-btn[data-view="'+view+'"]').addClass("active"),"table"===view?(this.container.find(".embedded-table-view").removeClass("d-none"),this.container.find(".embedded-chart-view").addClass("d-none")):(this.container.find(".embedded-table-view").addClass("d-none"),this.container.find(".embedded-chart-view").removeClass("d-none"),this.renderEmbeddedChart())},populateEmbeddedChartControls:function(data){if(data&&0!==data.length){var headers=Object.keys(data[0]),numericCols=this.detectNumericColumns(data,headers),xAxisSelect=this.container.find(".embedded-chart-x-axis"),yAxisSelect=this.container.find(".embedded-chart-y-axis");xAxisSelect.empty(),yAxisSelect.empty(),headers.forEach((function(h){var formatted=h.replace(/_/g," ").replace(/\b\w/g,(function(l){return l.toUpperCase()}));xAxisSelect.append('<option value="'+h+'">'+formatted+"</option>")})),(numericCols.length>0?numericCols:headers).forEach((function(h){var formatted=h.replace(/_/g," ").replace(/\b\w/g,(function(l){return l.toUpperCase()}));yAxisSelect.append('<option value="'+h+'">'+formatted+"</option>")})),this.embeddedXAxis=headers[0],this.embeddedYAxis=numericCols.length>0?numericCols[numericCols.length-1]:headers[headers.length-1],xAxisSelect.val(this.embeddedXAxis),yAxisSelect.val(this.embeddedYAxis)}},renderEmbeddedTablePage:function(){var data=this.embeddedData||[],table=this.container.find(".embedded-table"),thead=table.find("thead"),tbody=table.find("tbody");if(thead.empty(),tbody.empty(),0!==data.length){var headers=Object.keys(data[0]),headerRow=$("<tr>");headers.forEach((function(h){var formatted=h.replace(/_/g," ").replace(/\b\w/g,(function(l){return l.toUpperCase()}));headerRow.append($("<th>").text(formatted))})),thead.append(headerRow);var totalPages=Math.ceil(data.length/this.embeddedTableRowsPerPage),startIndex=(this.embeddedTablePage-1)*this.embeddedTableRowsPerPage,endIndex=Math.min(startIndex+this.embeddedTableRowsPerPage,data.length);data.slice(startIndex,endIndex).forEach((function(row){var tr=$("<tr>");headers.forEach((function(h){var val=row[h];null==val&&(val="");var displayVal=String(val);displayVal.length>50&&(displayVal=displayVal.substring(0,50)+"..."),tr.append($("<td>").attr("title",val).text(displayVal))})),tbody.append(tr)})),this.container.find(".row-count").text("Showing "+(startIndex+1)+"-"+endIndex+" of "+data.length),this.container.find(".embedded-pagination-info").text("Page "+this.embeddedTablePage+" of "+totalPages),this.container.find(".embedded-pagination-prev").prop("disabled",this.embeddedTablePage<=1),this.container.find(".embedded-pagination-next").prop("disabled",this.embeddedTablePage>=totalPages)}},renderEmbeddedChart:function(){var data=this.embeddedData||[],canvas=this.container.find(".embedded-chart")[0];if(canvas&&0!==data.length){this.embeddedChartInstance&&(this.embeddedChartInstance.destroy(),this.embeddedChartInstance=null);var chartType=this.embeddedChartType||"bar",xAxis=this.embeddedXAxis||Object.keys(data[0])[0],yAxis=this.embeddedYAxis||Object.keys(data[0])[1],chartData=data.slice(0,30),labels=chartData.map((function(row){var label=row[xAxis];if(null==label)return"Unknown";var labelStr=String(label);return labelStr.length>20?labelStr.substring(0,20)+"...":labelStr})),values=chartData.map((function(row){return parseFloat(row[yAxis])||0})),colors=this.generateChartColors(values.length,chartType),datasetConfig={label:yAxis.replace(/_/g," ").replace(/\b\w/g,(function(l){return l.toUpperCase()})),data:values};"pie"===chartType||"doughnut"===chartType?(datasetConfig.backgroundColor=colors,datasetConfig.borderWidth=1):(datasetConfig.backgroundColor=colors[0],datasetConfig.borderColor=colors[0].replace("0.7","1"),datasetConfig.borderWidth=1);var config={type:chartType,data:{labels:labels,datasets:[datasetConfig]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:"pie"===chartType||"doughnut"===chartType,position:"right"}}}};"bar"!==chartType&&"line"!==chartType||(config.options.scales={y:{beginAtZero:!0},x:{display:data.length<=15}});try{this.embeddedChartInstance=new Chart(canvas.getContext("2d"),config)}catch(error){this.container.find(".embedded-chart-container").html('<div class="alert alert-warning text-center"><i class="fa fa-exclamation-circle"></i> Could not render chart</div>')}}},exportEmbeddedReport:function(format){var data=this.embeddedData||[],report=this.embeddedReport||{};if(0!==data.length&&"csv"===format){var headers=Object.keys(data[0]),csvContent=headers.join(",")+"\n";data.forEach((function(row){var rowValues=headers.map((function(h){var val=row[h];if(null==val)return"";var strVal=String(val);return(strVal.includes(",")||strVal.includes('"')||strVal.includes("\n"))&&(strVal='"'+strVal.replace(/"/g,'""')+'"'),strVal}));csvContent+=rowValues.join(",")+"\n"}));var blob=new Blob([csvContent],{type:"text/csv;charset=utf-8;"}),link=document.createElement("a"),reportName=report.name||report.slug||"report";link.href=URL.createObjectURL(blob),link.download=reportName.replace(/[^a-z0-9]/gi,"_")+"_"+(new Date).toISOString().split("T")[0]+".csv",link.click()}},renderKpi:function(reports){var self=this,gridContainer=this.container.find(".block-adeptus-kpi-grid"),template=$("#block-adeptus-kpi-card-template-"+this.blockId),maxCards=parseInt(this.config.kpiColumns,10)||2;maxCards=Math.max(1,Math.min(4,maxCards)),gridContainer.empty();var kpiReports=reports.slice(0,maxCards),cardMap={},wizardReports=[],aiReports=[];kpiReports.forEach((function(report,index){var card=template.html(),$card=$(card),reportName=report.name||report.title||report.display_name||report.slug||"Metric";$card.attr("data-slug",report.slug),$card.attr("data-source",report.source),$card.find(".kpi-card-label").text(reportName),$card.find(".kpi-card-value").html('<i class="fa fa-spinner fa-spin"></i>'),$card.find(".kpi-card-trend").addClass("d-none"),$card.find(".kpi-card-sparkline").addClass("d-none");var defaultIcons=["fa-users","fa-graduation-cap","fa-clock-o","fa-check-circle"],iconClass=report.customIcon||defaultIcons[index%defaultIcons.length];$card.find(".kpi-card-icon i").removeClass("fa-bar-chart").addClass(iconClass),gridContainer.append($card),cardMap[report.slug]={$card:$card,report:report,index:index},"wizard"===report.source?wizardReports.push(report):aiReports.push(report)})),gridContainer.removeClass("d-none"),wizardReports.length>0&&this.loadKpiBatch(wizardReports,cardMap),aiReports.forEach((function(report,index){var cardInfo=cardMap[report.slug];setTimeout((function(){self.loadKpiData(report,cardInfo.$card,cardInfo.index)}),100*index)}))},loadKpiBatch:function(reports,cardMap){var self=this,reportIds=(performance.now(),reports.map((function(r){return r.report_template_id||r.id||r.name||r.slug})));$.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/batch_kpi_data.php",method:"POST",data:{reportids:JSON.stringify(reportIds),sesskey:M.cfg.sesskey},dataType:"json",timeout:3e4}).done((function(response){response.success&&response.reports?reports.forEach((function(report){var reportId=report.report_template_id||report.id||report.name||report.slug,reportData=response.reports[reportId],cardInfo=cardMap[report.slug];if(cardInfo){var $card=cardInfo.$card,cacheKey=report.slug+"_"+report.source;reportData&&reportData.success?(self.reportDataCache[cacheKey]={report:report,results:reportData.results||[]},self.renderKpiValue($card,reportData.results||[])):($card.find(".kpi-card-value").text("--"),$card.find(".kpi-card-trend").addClass("d-none"))}})):reports.forEach((function(report,index){var cardInfo=cardMap[report.slug];setTimeout((function(){self.loadKpiData(report,cardInfo.$card,cardInfo.index)}),100*index)}))})).fail((function(){reports.forEach((function(report,index){var cardInfo=cardMap[report.slug];setTimeout((function(){self.loadKpiData(report,cardInfo.$card,cardInfo.index)}),100*index)}))}))},loadKpiData:function(report,$card,cardIndex,retryCount){var self=this,cacheKey=report.slug+"_"+report.source;retryCount=retryCount||0;performance.now();if(this.reportDataCache[cacheKey]){var cached=this.reportDataCache[cacheKey];this.renderKpiValue($card,cached.results)}else{var reportId=report.report_template_id||report.id||report.name||report.slug;if("wizard"===report.source)$.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/generate_report.php",method:"POST",data:{reportid:reportId,sesskey:M.cfg.sesskey},dataType:"json",timeout:3e4}).done((function(response){response.success?(self.reportDataCache[cacheKey]={report:report,results:response.results||[]},self.renderKpiValue($card,response.results||[])):($card.find(".kpi-card-value").text("--"),$card.find(".kpi-card-trend").addClass("d-none"))})).fail((function(jqXHR,textStatus){retryCount<2&&("timeout"===textStatus||jqXHR.status>=500)?setTimeout((function(){self.loadKpiData(report,$card,cardIndex,retryCount+1)}),1e3*(retryCount+1)):($card.find(".kpi-card-value").text("--"),$card.find(".kpi-card-trend").addClass("d-none"))}));else{var token=this.apiKey||(window.adeptusAuthData?window.adeptusAuthData.api_key:null);if(!token)return $card.find(".kpi-card-value").text("--"),void $card.find(".kpi-card-trend").addClass("d-none");$.ajax({url:this.backendUrl+"/ai-reports/"+report.slug,method:"GET",headers:{Authorization:"Bearer "+token,Accept:"application/json"},timeout:3e4}).done((function(response){if(response.success){var reportData=response.report||report,data=response.data||[],sqlQuery=response.sql||reportData&&reportData.sql_query||reportData&&reportData.sql;if((response.execution_required||(!data||0===data.length)&&sqlQuery)&&sqlQuery)return void self.executeReportLocally(sqlQuery,reportData.params||{}).then((function(executionResult){var localData=executionResult.data||[];self.reportDataCache[cacheKey]={report:reportData,results:localData},self.renderKpiValue($card,localData)})).catch((function(error){$card.find(".kpi-card-value").text("--"),$card.find(".kpi-card-trend").addClass("d-none")}));data&&data.length>0?(self.reportDataCache[cacheKey]={report:reportData,results:data},self.renderKpiValue($card,data)):($card.find(".kpi-card-value").text("--"),$card.find(".kpi-card-trend").addClass("d-none"))}else $card.find(".kpi-card-value").text("--"),$card.find(".kpi-card-trend").addClass("d-none")})).fail((function(jqXHR,textStatus){retryCount<2&&("timeout"===textStatus||jqXHR.status>=500)?setTimeout((function(){self.loadKpiData(report,$card,cardIndex,retryCount+1)}),1e3*(retryCount+1)):($card.find(".kpi-card-value").text("--"),$card.find(".kpi-card-trend").addClass("d-none"))}))}}},renderKpiValue:function($card,data){var slug=$card.data("slug"),source=$card.data("source")||"wizard",label=$card.find(".kpi-card-label").text()||"";if(!data||0===data.length)return $card.find(".kpi-card-value").text("0"),void this.saveKpiHistoryToServer($card,slug,0,source,label,0);var value,formattedValue,headers=Object.keys(data[0]),numericCols=this.detectNumericColumns(data,headers);if(numericCols.length>0){var valueCol=numericCols[numericCols.length-1];value=valueCol.toLowerCase().includes("count")||valueCol.toLowerCase().includes("total")||1===data.length?data.reduce((function(sum,row){return sum+(parseFloat(row[valueCol])||0)}),0):data.length}else value=data.length;formattedValue=this.formatKpiValue(value),$card.find(".kpi-card-value").text(formattedValue),this.saveKpiHistoryToServer($card,slug,value,source,label,data.length)},formatKpiValue:function(value){return value>=1e6?(value/1e6).toFixed(1)+"M":value>=1e3?(value/1e3).toFixed(1)+"K":Number.isInteger(value)?value.toLocaleString():value.toFixed(1)},saveKpiHistoryToServer:function($card,slug,value,source,label,rowCount,executionTimeMs){if(!this.config.snapshotsEnabled)return $card.find(".kpi-card-trend").addClass("d-none"),void $card.find(".kpi-card-sparkline").addClass("d-none");this.postSnapshotToBackend($card,slug,value,executionTimeMs||0)},postSnapshotToBackend:function($card,slug,metricValue,executionTimeMs){var self=this,token=this.apiKey,source=$card.data("source")||"wizard";if(!token)return $card.find(".kpi-card-trend").addClass("d-none"),void $card.find(".kpi-card-sparkline").addClass("d-none");var endpoint="ai"===source?"/ai-reports/":"/wizard-reports/";$.ajax({url:this.backendUrl+endpoint+encodeURIComponent(slug)+"/snapshots",method:"POST",headers:{Authorization:"Bearer "+token,"Content-Type":"application/json",Accept:"application/json"},data:JSON.stringify({row_count:metricValue,execution_time_ms:executionTimeMs,evaluate_alerts:!0}),timeout:15e3}).done((function(response){if(response.success&&(self.registerSnapshotSchedule(slug,source,metricValue),response.trend&&response.trend.has_previous?self.updateKpiTrendFromBackend($card,response.trend):$card.find(".kpi-card-trend").addClass("d-none"),response.history&&response.history.length>=2?self.renderKpiSparklineFromBackend($card,slug,response.history):$card.find(".kpi-card-sparkline").addClass("d-none"),response.alerts&&response.alerts.triggered_count>0)){var reportName=$card.find(".kpi-card-label").text()||slug;self.handleTriggeredAlerts(response.alerts.triggered,slug,metricValue,response.trend,reportName)}})).fail((function(){$card.find(".kpi-card-trend").addClass("d-none"),$card.find(".kpi-card-sparkline").addClass("d-none")}))},registerSnapshotSchedule:function(slug,source,metricValue){var self=this,scheduleKey=this.blockId+"_"+slug;if(!this.registeredSnapshots[scheduleKey]){var intervalSeconds=this.config.kpiHistoryInterval||3600;Ajax.call([{methodname:"block_adeptus_insights_register_snapshot_schedule",args:{blockinstanceid:this.blockId,reportslug:slug,reportsource:source,intervalseconds:intervalSeconds,rowcount:metricValue}}])[0].done((function(response){response.success&&(self.registeredSnapshots[scheduleKey]=!0)})).fail((function(){}))}},updateKpiTrendFromBackend:function($card,trend){var trendContainer=$card.find(".kpi-card-trend");trendContainer.removeClass("d-none trend-up trend-down trend-neutral");var changeText,direction=trend.direction,percentage=Math.abs(trend.change_percent||0);changeText=percentage>=100?Math.round(percentage)+"%":percentage>=10?percentage.toFixed(0)+"%":percentage.toFixed(1)+"%","increase"===direction?(trendContainer.addClass("trend-up"),trendContainer.find(".trend-icon").html('<i class="fa fa-arrow-up"></i>'),trendContainer.find(".trend-value").text("+"+changeText+" vs previous")):"decrease"===direction?(trendContainer.addClass("trend-down"),trendContainer.find(".trend-icon").html('<i class="fa fa-arrow-down"></i>'),trendContainer.find(".trend-value").text("-"+changeText+" vs previous")):(trendContainer.addClass("trend-neutral"),trendContainer.find(".trend-icon").html('<i class="fa fa-minus"></i>'),trendContainer.find(".trend-value").text("No change"))},renderKpiSparklineFromBackend:function($card,slug,history){var sparklineData=history.map((function(point){return point.row_count})).reverse();this.renderKpiSparklineFromData($card,slug,sparklineData,sparklineData[sparklineData.length-1])},handleTriggeredAlerts:function(triggeredAlerts,reportSlug,currentValue,trend,reportName){var self=this;if(triggeredAlerts&&0!==triggeredAlerts.length){var alertsConfig=self.config.alertsConfig||[],alertsToSend=triggeredAlerts.map((function(alert){for(var alertName=alert.alert_name||alert.name||"Alert",value=parseFloat(alert.current_value||alert.actual_value||alert.value||currentValue||0),displayReportName=reportName||alert.report_name||reportSlug||"Report",alertId=alert.id||alert.alert_id||0,localConfig=null,i=0;i<alertsConfig.length;i++)if(alertsConfig[i].backend_id===alertId){localConfig=alertsConfig[i];break}var severity="warning",thresholdValue=alert.threshold||alert.threshold_value||"";if(localConfig){var warningThreshold=parseFloat(localConfig.warning_value)||0,criticalThreshold=parseFloat(localConfig.critical_value)||0;criticalThreshold>0&&value>=criticalThreshold?(severity="critical",thresholdValue=criticalThreshold):warningThreshold>0&&value>=warningThreshold&&(severity="warning",thresholdValue=warningThreshold)}else severity=alert.severity||(alert.is_critical?"critical":"warning");var message="Your "+displayReportName+" has reached "+value+", exceeding your "+severity+" threshold ("+thresholdValue+").";if(trend&&trend.has_previous){var direction=trend.direction||"change",changeAbs=Math.abs(trend.change_absolute||0),changePct=Math.abs(trend.change_percent||0).toFixed(1);message+="increase"===direction?" "+alertName+" increased by "+changeAbs+" ("+changePct+"%) since last measurement.":"decrease"===direction?" "+alertName+" decreased by "+changeAbs+" ("+changePct+"%) since last measurement.":" "+alertName+" has remained stable since last measurement."}return{alert_id:alertId,alert_name:alertName,message:message,severity:severity,report_name:displayReportName,report_slug:alert.report_slug||alert.slug||reportSlug||"",current_value:String(value),threshold:String(thresholdValue),notify_users:JSON.stringify(alert.notify_users||[])}}));require(["core/ajax"],(function(Ajax){Ajax.call([{methodname:"block_adeptus_insights_send_alert_notification",args:{blockinstanceid:self.blockId,alerts:alertsToSend}}])[0].done((function(response){response.success&&response.sent_count>0&&setTimeout((function(){self.refreshNotificationArea()}),500)})).fail((function(){}))}))}},refreshNotificationArea:function(){require(["jquery","core/ajax"],(function($,Ajax){try{var $popover=$("#nav-notification-popover-container");if(!$popover.length)return;var userId=$popover.attr("data-userid");if(!userId)return;Ajax.call([{methodname:"message_popup_get_unread_popup_notification_count",args:{useridto:parseInt(userId,10)}}])[0].done((function(count){var $countContainer=$popover.find('[data-region="count-container"]');$countContainer.length&&(count>0?($countContainer.text(count),$countContainer.removeClass("hidden")):$countContainer.addClass("hidden"))})).fail((function(){}))}catch(e){}}))},loadKpiSparklineFromServer:function($card,slug,currentValue){this.config.snapshotsEnabled||$card.find(".kpi-card-sparkline").addClass("d-none")},updateKpiTrendFromServer:function($card,direction,percentage){var trendContainer=$card.find(".kpi-card-trend");trendContainer.removeClass("d-none trend-up trend-down trend-neutral");var changeText,absChange=Math.abs(percentage);changeText=absChange>=100?Math.round(absChange)+"%":absChange>=10?absChange.toFixed(0)+"%":absChange.toFixed(1)+"%","up"===direction?(trendContainer.addClass("trend-up"),trendContainer.find(".trend-icon").html('<i class="fa fa-arrow-up"></i>'),trendContainer.find(".trend-value").text(changeText+" vs previous")):"down"===direction?(trendContainer.addClass("trend-down"),trendContainer.find(".trend-icon").html('<i class="fa fa-arrow-down"></i>'),trendContainer.find(".trend-value").text(changeText+" vs previous")):(trendContainer.addClass("trend-neutral"),trendContainer.find(".trend-icon").html('<i class="fa fa-minus"></i>'),trendContainer.find(".trend-value").text("No change"))},updateKpiTrend:function($card,slug,currentValue){var trendContainer=$card.find(".kpi-card-trend");trendContainer.removeClass("d-none"),trendContainer.addClass("trend-neutral"),trendContainer.find(".trend-icon").html('<i class="fa fa-spinner fa-spin"></i>'),trendContainer.find(".trend-value").text("Loading...")},renderKpiSparklineFromData:function($card,slug,sparklineData,currentValue){var sparklineContainer=$card.find(".kpi-card-sparkline"),canvas=sparklineContainer.find(".sparkline-chart")[0];if(canvas){var dataPoints=sparklineData.slice();if(0!==dataPoints.length&&dataPoints[dataPoints.length-1]===currentValue||dataPoints.push(currentValue),dataPoints.length<2)sparklineContainer.addClass("d-none");else{sparklineContainer.removeClass("d-none");var firstValue=dataPoints[0],lastValue=dataPoints[dataPoints.length-1],trendColor=lastValue>=firstValue?"rgba(40, 167, 69, 0.8)":"rgba(220, 53, 69, 0.8)",trendBgColor=lastValue>=firstValue?"rgba(40, 167, 69, 0.1)":"rgba(220, 53, 69, 0.1)",chartKey="sparkline_"+this.blockId+"_"+slug;this.kpiSparklineCharts&&this.kpiSparklineCharts[chartKey]&&this.kpiSparklineCharts[chartKey].destroy(),this.kpiSparklineCharts||(this.kpiSparklineCharts={});try{this.kpiSparklineCharts[chartKey]=new Chart(canvas.getContext("2d"),{type:"line",data:{labels:dataPoints.map((function(){return""})),datasets:[{data:dataPoints,borderColor:trendColor,backgroundColor:trendBgColor,borderWidth:2,fill:!0,tension:.4,pointRadius:0,pointHoverRadius:0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{enabled:!1}},scales:{x:{display:!1},y:{display:!1}},elements:{line:{borderCapStyle:"round"}},animation:{duration:500}}})}catch(e){sparklineContainer.addClass("d-none")}}}},renderKpiSparkline:function($card,slug,currentValue){},renderTabs:function(reports){var self=this,tabNav=this.container.find(".block-adeptus-tab-nav"),tabContent=this.container.find(".block-adeptus-tab-content"),tabTemplate=$("#block-adeptus-tab-template-"+this.blockId),paneTemplate=$("#block-adeptus-tab-pane-template-"+this.blockId);if(tabNav.empty(),tabContent.empty(),this.tabChartInstances={},reports.slice(0,5).forEach((function(report,index){var tabId="tab-"+self.blockId+"-"+index,reportName=report.name||report.title||report.display_name||report.slug||"Report",tab=$(tabTemplate.html());tab.find("a").attr("href","#"+tabId).attr("aria-controls",tabId),tab.find(".tab-name").text(reportName),0===index&&tab.find("a").addClass("active").attr("aria-selected","true"),tabNav.append(tab);var pane=$(paneTemplate.html());pane.attr("id",tabId),pane.attr("data-slug",report.slug),pane.attr("data-source",report.source),0===index&&pane.addClass("show active"),tabContent.append(pane)})),reports.length>0){var firstPane=tabContent.find(".tab-pane").first();this.loadTabContent(firstPane,reports[0].slug,reports[0].source)}this.container.find(".block-adeptus-tabs-container").removeClass("d-none")},loadTabContent:function(pane,slug,source){var self=this,cacheKey=slug+"_"+source;if(pane.data("loaded",!0),this.reportDataCache[cacheKey]){var cached=this.reportDataCache[cacheKey];this.renderTabContent(pane,cached.report,cached.results)}else{var report=this.reports.find((function(r){return r.slug===slug}));if(!report)return pane.find(".tab-pane-loading").addClass("d-none"),void pane.find(".tab-pane-content").removeClass("d-none").html('<div class="text-center text-muted py-4"><i class="fa fa-exclamation-circle"></i><p class="mt-2">Report not found</p></div>');if("wizard"===source)$.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/generate_report.php",method:"POST",data:{reportid:report.name||report.report_template_id,sesskey:M.cfg.sesskey},dataType:"json",timeout:3e4}).done((function(response){response.success?(self.reportDataCache[cacheKey]={report:report,results:response.results||[]},self.renderTabContent(pane,report,response.results||[])):(pane.find(".tab-pane-loading").addClass("d-none"),pane.find(".tab-pane-content").removeClass("d-none").html('<div class="text-center text-muted py-4"><i class="fa fa-exclamation-circle"></i><p class="mt-2">'+(response.message||"Failed to load")+"</p></div>"))})).fail((function(){pane.find(".tab-pane-loading").addClass("d-none"),pane.find(".tab-pane-content").removeClass("d-none").html('<div class="text-center text-muted py-4"><i class="fa fa-exclamation-circle"></i><p class="mt-2">Connection error</p></div>')}));else{var token=this.apiKey||(window.adeptusAuthData?window.adeptusAuthData.api_key:null);if(!token)return pane.find(".tab-pane-loading").addClass("d-none"),void pane.find(".tab-pane-content").removeClass("d-none").html('<div class="text-center text-muted py-4"><i class="fa fa-exclamation-circle"></i><p class="mt-2">Authentication required</p></div>');$.ajax({url:this.backendUrl+"/ai-reports/"+slug,method:"GET",headers:{Authorization:"Bearer "+token,Accept:"application/json"},timeout:15e3}).done((function(response){if(response.success){var reportData=response.report||report,data=response.data||[],sqlQuery=response.sql||reportData&&reportData.sql_query||reportData&&reportData.sql;if((response.execution_required||(!data||0===data.length)&&sqlQuery)&&sqlQuery)return void self.executeReportLocally(sqlQuery,reportData.params||{}).then((function(executionResult){var localData=executionResult.data||[];self.reportDataCache[cacheKey]={report:reportData,results:localData},self.renderTabContent(pane,reportData,localData)})).catch((function(error){pane.find(".tab-pane-loading").addClass("d-none"),pane.find(".tab-pane-content").removeClass("d-none").html('<div class="text-center text-muted py-4"><i class="fa fa-exclamation-circle"></i><p class="mt-2">Failed to execute report</p></div>')}));self.reportDataCache[cacheKey]={report:reportData,results:data},self.renderTabContent(pane,reportData,data)}else pane.find(".tab-pane-loading").addClass("d-none"),pane.find(".tab-pane-content").removeClass("d-none").html('<div class="text-center text-muted py-4"><i class="fa fa-exclamation-circle"></i><p class="mt-2">Failed to load report</p></div>')})).fail((function(){pane.find(".tab-pane-loading").addClass("d-none"),pane.find(".tab-pane-content").removeClass("d-none").html('<div class="text-center text-muted py-4"><i class="fa fa-exclamation-circle"></i><p class="mt-2">Connection error</p></div>')}))}}},renderTabContent:function(pane,report,data){var tabId=pane.attr("id");pane.find(".tab-pane-loading").addClass("d-none");var contentArea=pane.find(".tab-pane-content");if(data&&0!==data.length){var headers=Object.keys(data[0]),numericCols=this.detectNumericColumns(data,headers),state={data:data,report:report,headers:headers,numericCols:numericCols,currentView:"table",tablePage:1,rowsPerPage:25,chartType:"bar",xAxis:headers[0],yAxis:numericCols.length>0?numericCols[numericCols.length-1]:headers[headers.length-1]};this.tabPaneStates[tabId]=state,contentArea.removeClass("d-none"),this.updateTabMetaBar(pane,report,data),this.populateTabChartControls(pane,state),this.renderTabTablePage(pane,state),pane.find(".tab-view-toggle-btn").removeClass("active"),pane.find('.tab-view-toggle-btn[data-view="table"]').addClass("active"),pane.find(".tab-table-view").removeClass("d-none"),pane.find(".tab-chart-view").addClass("d-none")}else contentArea.removeClass("d-none").html('<div class="text-center text-muted py-4"><i class="fa fa-inbox"></i><p class="mt-2">No data available</p></div>')},updateTabMetaBar:function(pane,report,data){var category=report.category||report.category_name||"",categoryBadge=pane.find(".report-category");category?(categoryBadge.text(category).removeClass("d-none"),report.category_color?categoryBadge.css("background-color",report.category_color):categoryBadge.addClass("bg-primary")):categoryBadge.addClass("d-none"),pane.find(".row-count-num").text(data.length);var dateStr=report.updated_at||report.created_at||"";if(dateStr){var date=new Date(dateStr);pane.find(".report-date").text(date.toLocaleDateString())}},populateTabChartControls:function(pane,state){var xAxisSelect=pane.find(".tab-chart-x-axis"),yAxisSelect=pane.find(".tab-chart-y-axis");xAxisSelect.empty(),yAxisSelect.empty(),state.headers.forEach((function(header){var formatted=header.replace(/_/g," ").replace(/\b\w/g,(function(l){return l.toUpperCase()}));xAxisSelect.append($("<option>").val(header).text(formatted)),yAxisSelect.append($("<option>").val(header).text(formatted))})),xAxisSelect.val(state.xAxis),yAxisSelect.val(state.yAxis)},switchTabView:function(pane,view){var tabId=pane.attr("id"),state=this.tabPaneStates[tabId];state&&(state.currentView=view,pane.find(".tab-view-toggle-btn").removeClass("active"),pane.find('.tab-view-toggle-btn[data-view="'+view+'"]').addClass("active"),"table"===view?(pane.find(".tab-table-view").removeClass("d-none"),pane.find(".tab-chart-view").addClass("d-none")):(pane.find(".tab-table-view").addClass("d-none"),pane.find(".tab-chart-view").removeClass("d-none"),this.renderTabChart(pane,state)))},renderTabTablePage:function(pane,state){var table=pane.find(".tab-table"),thead=table.find("thead"),tbody=table.find("tbody"),data=state.data,headers=state.headers;thead.empty(),tbody.empty();var headerRow=$("<tr>");headers.forEach((function(h){var formatted=h.replace(/_/g," ").replace(/\b\w/g,(function(l){return l.toUpperCase()}));headerRow.append($("<th>").text(formatted))})),thead.append(headerRow);var totalRows=data.length,totalPages=Math.ceil(totalRows/state.rowsPerPage),startIndex=(state.tablePage-1)*state.rowsPerPage,endIndex=Math.min(startIndex+state.rowsPerPage,totalRows);data.slice(startIndex,endIndex).forEach((function(row){var tr=$("<tr>");headers.forEach((function(h){var val=row[h];null==val&&(val="");var displayVal=String(val);displayVal.length>50&&(displayVal=displayVal.substring(0,50)+"..."),tr.append($("<td>").attr("title",val).text(displayVal))})),tbody.append(tr)}));var showingText="Showing "+(startIndex+1)+"-"+endIndex+" of "+totalRows;pane.find(".row-count").text(showingText),pane.find(".tab-pagination-info").text("Page "+state.tablePage+" of "+totalPages),pane.find(".tab-pagination-prev").prop("disabled",state.tablePage<=1),pane.find(".tab-pagination-next").prop("disabled",state.tablePage>=totalPages),totalPages>1?pane.find(".tab-table-pagination").removeClass("d-none"):pane.find(".tab-table-pagination").addClass("d-none")},renderTabChart:function(pane,state){var tabId=pane.attr("id"),canvas=pane.find(".tab-chart")[0];if(canvas&&state.data&&0!==state.data.length){this.tabChartInstances&&this.tabChartInstances[tabId]&&this.tabChartInstances[tabId].destroy();var chartType=state.chartType,xAxis=state.xAxis,yAxis=state.yAxis,data=state.data,chartData=data.slice(0,20),labels=chartData.map((function(row){var label=row[xAxis];if(null==label)return"Unknown";var labelStr=String(label);return labelStr.length>20?labelStr.substring(0,20)+"...":labelStr})),values=chartData.map((function(row){return parseFloat(row[yAxis])||0})),colors=this.generateChartColors(values.length,chartType),config={type:chartType,data:{labels:labels,datasets:[{label:yAxis.replace(/_/g," ").replace(/\b\w/g,(function(l){return l.toUpperCase()})),data:values,backgroundColor:"pie"===chartType||"doughnut"===chartType?colors:colors[0],borderColor:"line"===chartType?colors[0]:"pie"===chartType||"doughnut"===chartType?"#fff":colors[0],borderWidth:"pie"===chartType||"doughnut"===chartType?2:1,fill:"line"!==chartType&&void 0,tension:"line"===chartType?.1:void 0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:"pie"===chartType||"doughnut"===chartType,position:"right"}},scales:"pie"===chartType||"doughnut"===chartType?{}:{y:{beginAtZero:!0},x:{display:data.length<=10}}}};try{this.tabChartInstances=this.tabChartInstances||{},this.tabChartInstances[tabId]=new Chart(canvas.getContext("2d"),config)}catch(error){pane.find(".tab-chart-container").html('<div class="alert alert-warning text-center"><i class="fa fa-exclamation-circle"></i> Could not render chart</div>')}}},exportTabReport:function(state,format){if(state&&state.data&&0!==state.data.length&&"csv"===format){var headers=state.headers,csvRows=[];csvRows.push(headers.map((function(h){return'"'+h.replace(/"/g,'""')+'"'})).join(",")),state.data.forEach((function(row){var rowData=headers.map((function(h){var val=row[h];return null==val&&(val=""),'"'+String(val).replace(/"/g,'""')+'"'}));csvRows.push(rowData.join(","))}));var csvContent=csvRows.join("\n"),blob=new Blob([csvContent],{type:"text/csv;charset=utf-8;"}),url=URL.createObjectURL(blob),link=document.createElement("a"),reportName=state.report.name||state.report.slug||"report";link.href=url,link.download=reportName.replace(/[^a-z0-9]/gi,"_")+".csv",document.body.appendChild(link),link.click(),document.body.removeChild(link),URL.revokeObjectURL(url)}},renderTabTable:function(pane,data){var table=pane.find("table"),thead=table.find("thead"),tbody=table.find("tbody"),maxRows=this.config.tableMaxRows||10;if(thead.empty(),tbody.empty(),data&&0!==data.length){var headers=Object.keys(data[0]),headerRow=$("<tr>");headers.forEach((function(h){var formatted=h.replace(/_/g," ").replace(/\b\w/g,(function(l){return l.toUpperCase()}));headerRow.append($("<th>").text(formatted))})),thead.append(headerRow),data.slice(0,maxRows).forEach((function(row){var tr=$("<tr>");headers.forEach((function(h){var val=row[h];null==val&&(val="");var displayVal=String(val);displayVal.length>40&&(displayVal=displayVal.substring(0,40)+"..."),tr.append($("<td>").attr("title",val).text(displayVal))})),tbody.append(tr)}))}},handleReportClick:function(slug,source){switch(this.config.clickAction||"modal"){case"modal":this.openReportModal(slug,source);break;case"newtab":this.openReportNewTab(slug,source);break;case"expand":this.expandReportInline(slug,source)}},openReportModal:function(slug,source){var self=this,report=this.reports.find((function(r){return r.slug===slug}));report&&(this.modalData=null,this.modalReport=null,this.currentView="table",this.chartInstance&&(this.chartInstance.destroy(),this.chartInstance=null),Templates.render("block_adeptus_insights/report_modal",{blockid:this.blockId}).then((function(html){return ModalFactory.create({type:ModalFactory.types.DEFAULT,title:report.name,body:html,large:!0})})).then((function(modal){return self.modal=modal,self.bindModalEvents(modal),modal.getRoot().on(ModalEvents.shown,(function(){self.loadModalReport(slug,source)})),modal.getRoot().on(ModalEvents.hidden,(function(){self.chartInstance&&(self.chartInstance.destroy(),self.chartInstance=null),modal.destroy(),self.modal=null,self.modalData=null,self.modalReport=null})),modal.show(),modal})).catch(Notification.exception))},bindModalEvents:function(modal){var self=this,modalRoot=modal.getRoot();modalRoot.on("click",".view-toggle-btn",(function(e){e.preventDefault();var view=$(this).data("view");self.switchModalView(view)})),modalRoot.on("change","#modal-chart-type, #modal-chart-x-axis, #modal-chart-y-axis",(function(){"chart"===self.currentView&&self.renderModalChart()})),modalRoot.on("click",".modal-retry",(function(e){e.preventDefault(),self.modalReport&&self.loadModalReport(self.modalReport.slug,self.modalReport.source)})),modalRoot.on("click",'.modal-export[data-format="csv"]',(function(e){e.preventDefault(),self.exportModalData("csv")})),modalRoot.on("click",".table-pagination-prev",(function(e){e.preventDefault(),self.tableCurrentPage>1&&(self.tableCurrentPage--,self.renderModalTablePage())})),modalRoot.on("click",".table-pagination-next",(function(e){e.preventDefault(),self.tableCurrentPage<self.tableTotalPages&&(self.tableCurrentPage++,self.renderModalTablePage())}))},switchModalView:function(view){var modalBody=this.modal.getBody();modalBody.find(".view-toggle-btn").removeClass("active"),modalBody.find('.view-toggle-btn[data-view="'+view+'"]').addClass("active"),"table"===view?(modalBody.find("#modal-table-view").removeClass("d-none"),modalBody.find("#modal-chart-view").addClass("d-none")):(modalBody.find("#modal-table-view").addClass("d-none"),modalBody.find("#modal-chart-view").removeClass("d-none"),this.renderModalChart()),this.currentView=view},loadModalReport:function(slug,source){var self=this,modalBody=this.modal.getBody(),cacheKey=slug+"_"+source;if(this.reportDataCache[cacheKey]){var cached=this.reportDataCache[cacheKey];return modalBody.find(".modal-loading").addClass("d-none"),void this.renderModalContent(modalBody,cached.report,cached.results,cached.chartData,cached.chartType)}var report=this.reports.find((function(r){return r.slug===slug}));if(!report)return modalBody.find(".modal-loading").addClass("d-none"),void modalBody.find(".modal-error").removeClass("d-none");if("wizard"===source)$.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/generate_report.php",method:"POST",data:{reportid:report.name||report.report_template_id,sesskey:M.cfg.sesskey},dataType:"json",timeout:3e4}).done((function(response){modalBody.find(".modal-loading").addClass("d-none"),response.success?(self.reportDataCache[cacheKey]={report:report,results:response.results||[],chartData:response.chart_data,chartType:response.chart_type},self.renderModalContent(modalBody,report,response.results||[],response.chart_data,response.chart_type)):(modalBody.find(".modal-error").removeClass("d-none"),modalBody.find(".modal-error p").text(response.message||"Failed to load report"))})).fail((function(){modalBody.find(".modal-loading").addClass("d-none"),modalBody.find(".modal-error").removeClass("d-none")}));else{var token=this.apiKey||(window.adeptusAuthData?window.adeptusAuthData.api_key:null);if(!token)return modalBody.find(".modal-loading").addClass("d-none"),void modalBody.find(".modal-error").removeClass("d-none");$.ajax({url:this.backendUrl+"/ai-reports/"+slug,method:"GET",headers:{Authorization:"Bearer "+token,Accept:"application/json"},timeout:15e3}).done((function(response){if(response.success&&response.report){var reportData=response.report,data=response.data||[],sqlQuery=response.sql||reportData&&reportData.sql_query||reportData&&reportData.sql;if((response.execution_required||(!data||0===data.length)&&sqlQuery)&&sqlQuery)return void self.executeReportLocally(sqlQuery,reportData.params||{}).then((function(executionResult){modalBody.find(".modal-loading").addClass("d-none");var localData=executionResult.data||[];self.reportDataCache[cacheKey]={report:reportData,results:localData,chartData:null,chartType:null},self.renderModalContent(modalBody,reportData,localData,null,null)})).catch((function(error){modalBody.find(".modal-loading").addClass("d-none"),modalBody.find(".modal-error").removeClass("d-none")}));modalBody.find(".modal-loading").addClass("d-none"),self.reportDataCache[cacheKey]={report:reportData,results:data,chartData:null,chartType:null},self.renderModalContent(modalBody,reportData,data,null,null)}else modalBody.find(".modal-loading").addClass("d-none"),modalBody.find(".modal-error").removeClass("d-none")})).fail((function(){modalBody.find(".modal-loading").addClass("d-none"),modalBody.find(".modal-error").removeClass("d-none")}))}},renderModalContent:function(modalBody,report,data,chartData,chartType){this.modalData=data||[],this.modalReport=report,modalBody.find(".modal-content-area").removeClass("d-none");var category=report.category_info||{name:"General",color:"#6c757d"};if(modalBody.find(".report-category").text(category.name).css("background-color",category.color),modalBody.find(".row-count-num").text(this.modalData.length),modalBody.find(".report-date").text(report.last_executed_at?"Last run: "+new Date(report.last_executed_at).toLocaleDateString():""),this.populateAxisSelectors(modalBody),this.renderModalTable(modalBody,this.modalData),this.isAdmin){var reportUrl=M.cfg.wwwroot+"/report/adeptus_insights/generated_reports.php?slug="+encodeURIComponent(report.slug);modalBody.find(".view-full-report").attr("href",reportUrl),modalBody.find(".modal-footer-link").removeClass("d-none")}else modalBody.find(".modal-footer-link").addClass("d-none");this.currentView="table",modalBody.find(".view-toggle-btn").removeClass("active"),modalBody.find('.view-toggle-btn[data-view="table"]').addClass("active"),modalBody.find("#modal-table-view").removeClass("d-none"),modalBody.find("#modal-chart-view").addClass("d-none")},populateAxisSelectors:function(modalBody){var data=this.modalData;if(data&&0!==data.length){var headers=Object.keys(data[0]),xAxisSelect=modalBody.find("#modal-chart-x-axis"),yAxisSelect=modalBody.find("#modal-chart-y-axis");xAxisSelect.empty(),yAxisSelect.empty();var numericCols=this.detectNumericColumns(data,headers);headers.forEach((function(header,idx){var formattedHeader=header.replace(/_/g," ").replace(/\b\w/g,(function(l){return l.toUpperCase()})),selected=0===idx?" selected":"";xAxisSelect.append('<option value="'+header+'"'+selected+">"+formattedHeader+"</option>")}));var yAxisOptions=numericCols.length>0?numericCols:headers;yAxisOptions.forEach((function(col,idx){var formattedHeader=col.replace(/_/g," ").replace(/\b\w/g,(function(l){return l.toUpperCase()})),selected=idx===yAxisOptions.length-1?" selected":"";yAxisSelect.append('<option value="'+col+'"'+selected+">"+formattedHeader+"</option>")}))}},detectNumericColumns:function(data,headers){var numericCols=[];return headers.forEach((function(header){var isNumeric=data.every((function(row){var val=row[header];return null==val||""===val||!isNaN(parseFloat(val))&&isFinite(val)})),hasNumbers=data.some((function(row){var val=row[header];return null!=val&&""!==val&&!isNaN(parseFloat(val))}));isNumeric&&hasNumbers&&numericCols.push(header)})),numericCols},executeReportLocally:function(sql,params){return params=params||{},new Promise((function(resolve,reject){$.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/execute_ai_report.php",method:"POST",contentType:"application/json",data:JSON.stringify({sql:sql,params:params,sesskey:M.cfg.sesskey}),timeout:6e4,success:function(response){response.success?resolve({data:response.data||[],headers:response.headers||[],row_count:response.row_count||0,error:null}):resolve({data:[],headers:[],row_count:0,error:response.message||"Query execution failed"})},error:function(xhr,status,error){reject(new Error("Failed to execute report: "+error))}})}))},renderModalChart:function(){var modalBody=this.modal.getBody(),data=this.modalData;if(data&&0!==data.length){var canvas=modalBody.find(".modal-chart")[0];if(canvas){this.chartInstance&&(this.chartInstance.destroy(),this.chartInstance=null);var chartType=modalBody.find("#modal-chart-type").val()||"bar",labelKey=modalBody.find("#modal-chart-x-axis").val(),valueKey=modalBody.find("#modal-chart-y-axis").val();if(!labelKey||!valueKey){var headers=Object.keys(data[0]);labelKey=labelKey||headers[0],valueKey=valueKey||headers[headers.length-1]}var valueKeyFormatted=valueKey.replace(/_/g," ").replace(/\b\w/g,(function(l){return l.toUpperCase()})),chartData=data.slice(0,50),labels=chartData.map((function(row){var label=row[labelKey];if(null==label)return"Unknown";var labelStr=String(label);return labelStr.length>30?labelStr.substring(0,30)+"...":labelStr})),values=chartData.map((function(row){return parseFloat(row[valueKey])||0})),colors=this.generateChartColors(values.length,chartType),config=this.createChartConfig(chartType,labels,values,valueKeyFormatted,colors);try{this.chartInstance=new Chart(canvas.getContext("2d"),config)}catch(error){modalBody.find(".chart-container").html('<div class="alert alert-danger"><i class="fa fa-exclamation-triangle"></i> Error rendering chart</div>')}}}else modalBody.find(".chart-container").html('<div class="alert alert-warning text-center"><i class="fa fa-info-circle"></i> No data available for chart</div>')},createChartConfig:function(chartType,labels,values,valueKey,colors){var baseOptions={responsive:!0,maintainAspectRatio:!1,plugins:{title:{display:!0,text:this.modalReport?this.modalReport.name:"Report",font:{size:14,weight:"bold"},padding:{top:10,bottom:20}},legend:{display:"pie"===chartType||"doughnut"===chartType,position:"right"}}};return"pie"===chartType||"doughnut"===chartType?{type:chartType,data:{labels:labels,datasets:[{data:values,backgroundColor:colors,borderWidth:2}]},options:baseOptions}:(baseOptions.scales={y:{beginAtZero:!0,title:{display:!0,text:valueKey}},x:{title:{display:!1}}},{type:chartType,data:{labels:labels,datasets:[{label:valueKey,data:values,backgroundColor:"line"===chartType?"transparent":colors[0],borderColor:colors[0].replace("0.7","1"),borderWidth:2,fill:"line"!==chartType,tension:.1}]},options:baseOptions})},generateChartColors:function(count,chartType){for(var baseColors=["rgba(37, 99, 235, 0.7)","rgba(16, 185, 129, 0.7)","rgba(245, 158, 11, 0.7)","rgba(239, 68, 68, 0.7)","rgba(139, 92, 246, 0.7)","rgba(6, 182, 212, 0.7)","rgba(236, 72, 153, 0.7)","rgba(132, 204, 22, 0.7)","rgba(249, 115, 22, 0.7)","rgba(99, 102, 241, 0.7)"],colors=[],i=0;i<count;i++)colors.push(baseColors[i%baseColors.length]);return colors},exportModalData:function(format){var data=this.modalData,report=this.modalReport;if(data&&0!==data.length){if("csv"===format){var headers=Object.keys(data[0]),csvContent=headers.join(",")+"\n";data.forEach((function(row){var values=headers.map((function(h){var val=row[h];return null==val&&(val=""),-1===(val=String(val).replace(/"/g,'""')).indexOf(",")&&-1===val.indexOf('"')&&-1===val.indexOf("\n")||(val='"'+val+'"'),val}));csvContent+=values.join(",")+"\n"}));var blob=new Blob([csvContent],{type:"text/csv;charset=utf-8;"}),link=document.createElement("a");link.href=URL.createObjectURL(blob),link.download=(report?report.name.replace(/[^a-z0-9]/gi,"_"):"report")+".csv",link.click()}}else Notification.addNotification({message:"No data to export",type:"warning"})},renderModalTable:function(modalBody,data){this.tableCurrentPage=1,this.tableTotalPages=Math.ceil((data?data.length:0)/this.tableRowsPerPage);var thead=modalBody.find(".modal-table").find("thead");if(thead.empty(),data&&0!==data.length){var headers=Object.keys(data[0]),headerRow=$("<tr>");headers.forEach((function(h){var formatted=h.replace(/_/g," ").replace(/\b\w/g,(function(l){return l.toUpperCase()}));headerRow.append($("<th>").text(formatted))})),thead.append(headerRow),this.renderModalTablePage()}else modalBody.find(".modal-table-container").addClass("d-none")},renderModalTablePage:function(){var modalBody=this.modal.getBody(),data=this.modalData||[],tbody=modalBody.find(".modal-table").find("tbody");if(tbody.empty(),data&&0!==data.length){var headers=Object.keys(data[0]),startIndex=(this.tableCurrentPage-1)*this.tableRowsPerPage,endIndex=startIndex+this.tableRowsPerPage;data.slice(startIndex,endIndex).forEach((function(row){var tr=$("<tr>");headers.forEach((function(h){var val=row[h];null==val&&(val="");var displayVal=String(val);displayVal.length>100&&(displayVal=displayVal.substring(0,100)+"..."),tr.append($("<td>").attr("title",val).text(displayVal))})),tbody.append(tr)}));var actualEnd=Math.min(endIndex,data.length);modalBody.find(".row-count").text(data.length+" total rows"),modalBody.find(".table-pagination-info").text(startIndex+1+"-"+actualEnd+" of "+data.length),modalBody.find(".table-pagination-prev").prop("disabled",this.tableCurrentPage<=1),modalBody.find(".table-pagination-next").prop("disabled",this.tableCurrentPage>=this.tableTotalPages),this.tableTotalPages>1?modalBody.find(".table-pagination").removeClass("d-none"):modalBody.find(".table-pagination").addClass("d-none")}},openReportNewTab:function(slug,source){var url=M.cfg.wwwroot+"/report/adeptus_insights/generated_reports.php?slug="+encodeURIComponent(slug);window.open(url,"_blank")},expandReportInline:function(slug,source){},exportReport:function(format){Notification.addNotification({message:"Export to "+format.toUpperCase()+" coming soon",type:"info"})},refresh:function(){var refreshBtn=this.container.find(".block-adeptus-refresh i");refreshBtn.addClass("fa-spin"),this.clearAllCaches(),this.showLoading();var self=this;this.waitForAuth((function(){self.fetchReports()})),setTimeout((function(){refreshBtn.removeClass("fa-spin")}),1e3)},clearAllCaches:function(){try{sessionStorage.removeItem(this.cacheKey)}catch(e){}this.reportDataCache={}},setupAutoRefresh:function(){var interval=this.config.autoRefresh;if(interval&&"never"!==interval){var ms;switch(interval){case"5m":ms=3e5;break;case"15m":ms=9e5;break;case"30m":ms=18e5;break;case"1h":ms=36e5;break;default:return}var self=this;this.refreshTimer=setInterval((function(){document.hidden||self.refresh()}),ms)}},showLoading:function(){this.container.find(".block-adeptus-loading").removeClass("d-none"),this.container.find(".block-adeptus-report-list, .block-adeptus-kpi-grid, .block-adeptus-tabs-container, .block-adeptus-content").addClass("d-none"),this.container.find(".block-adeptus-empty, .block-adeptus-error").addClass("d-none")},hideLoading:function(){this.container.find(".block-adeptus-loading").addClass("d-none")},showEmpty:function(){this.hideLoading(),this.container.find(".block-adeptus-empty").removeClass("d-none")},showError:function(message){this.hideLoading(),this.container.find(".block-adeptus-error").removeClass("d-none")},updateTimestamp:function(){if(this.lastUpdated){var text=this.formatTimeAgo(this.lastUpdated),kpiFooter=this.container.find(".block-adeptus-kpi-footer");if(kpiFooter.length)return kpiFooter.find(".timestamp-text").text(text),void kpiFooter.removeClass("d-none");if(this.config.showTimestamp){var timestampEl=this.container.find(".block-adeptus-timestamp");timestampEl.find(".timestamp-text").text(text),timestampEl.removeClass("d-none")}}},scrollToListTop:function(){var listContainer=this.container.find(".block-adeptus-report-list");listContainer.length&&listContainer[0].scrollIntoView({behavior:"smooth",block:"start"})},scrollToEmbeddedTableTop:function(){var tableContainer=this.container.find(".embedded-table-view");tableContainer.length&&tableContainer[0].scrollIntoView({behavior:"smooth",block:"start"})},showEmbeddedLoadingOverlay:function(){var overlay=this.container.find(".embedded-loading-overlay");this.container.find(".block-adeptus-content").removeClass("d-none"),overlay.removeClass("d-none").css("opacity",0).animate({opacity:1},150)},hideEmbeddedLoadingOverlay:function(){this.container.find(".embedded-loading-overlay").animate({opacity:0},150,(function(){$(this).addClass("d-none")}))},toggleSearchableDropdown:function(dropdown){dropdown.hasClass("open")?this.closeSearchableDropdown(dropdown):this.openSearchableDropdown(dropdown)},openSearchableDropdown:function(dropdown){var self=this;this.container.find(".searchable-dropdown.open").each((function(){$(this).is(dropdown)||self.closeSearchableDropdown($(this))})),dropdown.addClass("open"),dropdown.find(".searchable-dropdown-toggle").attr("aria-expanded","true");var input=dropdown.find(".searchable-dropdown-input");input.val(""),dropdown.find(".searchable-dropdown-item").show().removeClass("focused"),dropdown.find(".searchable-dropdown-empty").addClass("d-none"),setTimeout((function(){input.focus()}),50)},closeSearchableDropdown:function(dropdown){dropdown.removeClass("open"),dropdown.find(".searchable-dropdown-toggle").attr("aria-expanded","false"),dropdown.find(".searchable-dropdown-item").removeClass("focused")},filterSearchableDropdown:function(dropdown,query){var items=dropdown.find(".searchable-dropdown-item"),emptyState=dropdown.find(".searchable-dropdown-empty"),visibleCount=0;items.each((function(){var searchText=$(this).data("search")||"";""===query||-1!==searchText.indexOf(query)?($(this).show(),visibleCount++):$(this).hide()})),items.filter(":hidden").removeClass("focused"),0===visibleCount?emptyState.removeClass("d-none"):emptyState.addClass("d-none")},selectSearchableDropdownItem:function(dropdown,value,text){dropdown.find(".searchable-dropdown-text").text(text),dropdown.find(".searchable-dropdown-item").removeClass("selected"),dropdown.find('.searchable-dropdown-item[data-value="'+value+'"]').addClass("selected");var select=dropdown.siblings("select");select.length&&select.val(value).trigger("change"),this.closeSearchableDropdown(dropdown)},scrollDropdownItemIntoView:function(item){var list=item.closest(".searchable-dropdown-list"),listHeight=list.height(),itemTop=item.position().top,itemHeight=item.outerHeight();itemTop<0?list.scrollTop(list.scrollTop()+itemTop):itemTop+itemHeight>listHeight&&list.scrollTop(list.scrollTop()+(itemTop+itemHeight-listHeight))},escapeHtml:function(text){var div=document.createElement("div");return div.textContent=text,div.innerHTML},formatTimeAgo:function(date){var seconds=Math.floor((new Date-date)/1e3);if(seconds<60)return"Just now";var minutes=Math.floor(seconds/60);if(minutes<60)return minutes+" minute"+(1!==minutes?"s":"")+" ago";var hours=Math.floor(minutes/60);if(hours<24)return hours+" hour"+(1!==hours?"s":"")+" ago";var days=Math.floor(hours/24);return days+" day"+(1!==days?"s":"")+" ago"}},{init:function(options){return new BlockController(options)}}}));

//# sourceMappingURL=block.min.js.map