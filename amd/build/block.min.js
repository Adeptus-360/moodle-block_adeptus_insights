define(["jquery","core/ajax","core/notification","core/str","core/modal_factory","core/modal_events","core/templates","core/chartjs"],function(c,e,o,t,i,s,d,p){"use strict";function a(e){this.blockId=e.blockid,this.contextId=e.contextid,this.config=e.config||{},this.apiKey=e.apiKey||"",this.isAdmin=e.isAdmin||!1,this.container=null,this.reports=[],this.lastUpdated=null,this.refreshTimer=null,this.modal=null,this.modalData=null,this.modalReport=null,this.chartInstance=null,this.currentView="table",this.listCurrentPage=1,this.listItemsPerPage=this.config.maxLinkItems||10,this.listTotalPages=1,this.tableCurrentPage=1,this.tableRowsPerPage=25,this.tableTotalPages=1,this.selectedCategory="",this.availableCategories=[],this.selectedReportSlug=this.config.defaultReport||"",this.selectedReportSource="",this.embeddedCurrentView="table",this.embeddedTablePage=1,this.embeddedTableRowsPerPage=25,this.embeddedChartType="bar",this.embeddedXAxis="",this.embeddedYAxis="",this.backendUrl="https://backend.adeptus360.com/api/v1",this.cacheKey="adeptus_block_reports_"+this.blockId,this.cacheTTL=3e5,this.reportDataCache={},this.preloadTimeout=null,this.preloadingSlug=null,this.tabPaneStates={},this.tabChartInstances={},this.init()}return a.prototype={init:function(){this.container=c('[data-blockid="'+this.blockId+'"]'),this.container.length&&(this.bindEvents(),this.loadReports(),this.setupAutoRefresh())},bindEvents:function(){var o=this;this.container.on("click",".block-adeptus-refresh, .block-adeptus-retry",function(e){e.preventDefault(),o.refresh()}),this.container.on("click",".block-adeptus-report-item",function(e){e.preventDefault();var e=c(this).data("slug"),t=c(this).data("source");o.handleReportClick(e,t)}),this.container.on("keydown",".block-adeptus-report-item",function(e){var t;"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),e=c(this).data("slug"),t=c(this).data("source"),o.handleReportClick(e,t))}),this.container.on("click",".block-adeptus-kpi-card",function(e){e.preventDefault();var e=c(this).data("slug"),t=c(this).data("source");o.handleReportClick(e,t)}),this.container.on("shown.bs.tab",".block-adeptus-tab-nav a",function(e){var e=c(c(e.target).attr("href")),t=e.data("slug"),a=e.data("source");e.data("loaded")||o.loadTabContent(e,t,a)}),this.container.on("click",".block-adeptus-export",function(e){e.preventDefault();e=c(this).data("format");o.exportReport(e)}),this.container.on("click",".pagination-prev",function(e){e.preventDefault(),1<o.listCurrentPage&&(o.listCurrentPage--,o.renderCurrentPage(),o.scrollToListTop())}),this.container.on("click",".pagination-next",function(e){e.preventDefault(),o.listCurrentPage<o.listTotalPages&&(o.listCurrentPage++,o.renderCurrentPage(),o.scrollToListTop())}),this.container.on("change",".category-filter-select",function(){o.selectedCategory=c(this).val(),o.listCurrentPage=1,"embedded"===o.config.displayMode?o.populateReportSelector():o.renderReports()}),this.container.on("change",".report-selector-select",function(){var e,t=c(this).val();t&&(e=(t=t.split("::"))[0],t=t[1]||"wizard",o.selectedReportSlug=e,o.selectedReportSource=t,o.embeddedTablePage=1,o.embeddedCurrentView="table",o.loadEmbeddedReport(e,t))}),this.container.on("click",".searchable-dropdown-toggle",function(e){e.preventDefault(),e.stopPropagation();e=c(this).closest(".searchable-dropdown");o.toggleSearchableDropdown(e)}),this.container.on("input",".searchable-dropdown-input",function(){var e=c(this).closest(".searchable-dropdown"),t=c(this).val().toLowerCase().trim();o.filterSearchableDropdown(e,t)}),this.container.on("click",".searchable-dropdown-item",function(e){e.preventDefault(),e.stopPropagation();var e=c(this).closest(".searchable-dropdown"),t=c(this).data("value"),a=c(this).find(".dropdown-item-name").text();o.selectSearchableDropdownItem(e,t,a)}),this.container.on("keydown",".searchable-dropdown-input",function(e){var t,a=c(this).closest(".searchable-dropdown"),n=a.find(".searchable-dropdown-item:visible"),r=a.find(".searchable-dropdown-item.focused");"ArrowDown"===e.key?(e.preventDefault(),0===r.length?n.first().addClass("focused"):(t=r.nextAll(".searchable-dropdown-item:visible").first()).length&&(r.removeClass("focused"),t.addClass("focused"),o.scrollDropdownItemIntoView(t))):"ArrowUp"===e.key?(e.preventDefault(),!r.length||(t=r.prevAll(".searchable-dropdown-item:visible").first()).length&&(r.removeClass("focused"),t.addClass("focused"),o.scrollDropdownItemIntoView(t))):"Enter"===e.key?(e.preventDefault(),r.length?r.trigger("click"):1===n.length&&n.first().trigger("click")):"Escape"===e.key&&o.closeSearchableDropdown(a)}),c(document).on("click",function(e){c(e.target).closest(".searchable-dropdown").length||o.container.find(".searchable-dropdown.open").each(function(){o.closeSearchableDropdown(c(this))})}),this.container.on("click",".embedded-view-toggle-btn",function(e){e.preventDefault();e=c(this).data("view");o.switchEmbeddedView(e)}),this.container.on("click",".embedded-pagination-prev",function(e){e.preventDefault(),1<o.embeddedTablePage&&(o.embeddedTablePage--,o.renderEmbeddedTablePage(),o.scrollToEmbeddedTableTop())}),this.container.on("click",".embedded-pagination-next",function(e){e.preventDefault();e=Math.ceil((o.embeddedData||[]).length/o.embeddedTableRowsPerPage);o.embeddedTablePage<e&&(o.embeddedTablePage++,o.renderEmbeddedTablePage(),o.scrollToEmbeddedTableTop())}),this.container.on("change",".embedded-chart-type",function(){o.embeddedChartType=c(this).val(),o.renderEmbeddedChart()}),this.container.on("change",".embedded-chart-x-axis",function(){o.embeddedXAxis=c(this).val(),o.renderEmbeddedChart()}),this.container.on("change",".embedded-chart-y-axis",function(){o.embeddedYAxis=c(this).val(),o.renderEmbeddedChart()}),this.container.on("click",".embedded-export",function(e){e.preventDefault();e=c(this).data("format");o.exportEmbeddedReport(e)}),this.container.on("click",".tab-view-toggle-btn",function(e){e.preventDefault();var e=c(this).closest(".tab-pane"),t=c(this).data("view");o.switchTabView(e,t)}),this.container.on("click",".tab-pagination-prev",function(e){e.preventDefault();var e=c(this).closest(".tab-pane"),t=e.attr("id"),t=o.tabPaneStates[t];t&&1<t.tablePage&&(t.tablePage--,o.renderTabTablePage(e,t))}),this.container.on("click",".tab-pagination-next",function(e){e.preventDefault();var t,e=c(this).closest(".tab-pane"),a=e.attr("id"),a=o.tabPaneStates[a];a&&(t=Math.ceil(a.data.length/a.rowsPerPage),a.tablePage<t&&(a.tablePage++,o.renderTabTablePage(e,a)))}),this.container.on("change",".tab-chart-type",function(){var e=c(this).closest(".tab-pane"),t=e.attr("id"),t=o.tabPaneStates[t];t&&(t.chartType=c(this).val(),o.renderTabChart(e,t))}),this.container.on("change",".tab-chart-x-axis",function(){var e=c(this).closest(".tab-pane"),t=e.attr("id"),t=o.tabPaneStates[t];t&&(t.xAxis=c(this).val(),o.renderTabChart(e,t))}),this.container.on("change",".tab-chart-y-axis",function(){var e=c(this).closest(".tab-pane"),t=e.attr("id"),t=o.tabPaneStates[t];t&&(t.yAxis=c(this).val(),o.renderTabChart(e,t))}),this.container.on("click",".tab-export",function(e){e.preventDefault();var e=c(this).closest(".tab-pane").attr("id"),e=o.tabPaneStates[e],t=c(this).data("format");e&&o.exportTabReport(e,t)}),this.container.on("mouseenter",".block-adeptus-report-item",function(){var e=c(this).data("slug"),t=c(this).data("source");o.preloadTimeout&&clearTimeout(o.preloadTimeout),o.preloadTimeout=setTimeout(function(){o.preloadReportData(e,t)},300)}),this.container.on("mouseleave",".block-adeptus-report-item",function(){o.preloadTimeout&&(clearTimeout(o.preloadTimeout),o.preloadTimeout=null)})},loadReports:function(){var e=this,t=(this.showLoading(),this.getFromCache());if(t)return this.reports=t,this.lastUpdated=new Date,void this.renderReports();this.waitForAuth(function(){e.fetchReports()})},getFromCache:function(){try{var e=sessionStorage.getItem(this.cacheKey);if(e){var t=JSON.parse(e);if(t.timestamp&&Date.now()-t.timestamp<this.cacheTTL)return t.reports;sessionStorage.removeItem(this.cacheKey)}}catch(e){}return null},saveToCache:function(e){try{sessionStorage.setItem(this.cacheKey,JSON.stringify({timestamp:Date.now(),reports:e}))}catch(e){}},preloadReportData:function(t,e){var a,n=this,r=t+"_"+e;this.reportDataCache[r]||this.preloadingSlug===t||(this.preloadingSlug=t,(a=this.reports.find(function(e){return e.slug===t}))&&("wizard"===e?c.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/generate_report.php",method:"POST",data:{reportid:a.name||a.report_template_id,sesskey:M.cfg.sesskey},dataType:"json",timeout:3e4}).done(function(e){e.success&&(n.reportDataCache[r]={report:a,results:e.results||[],chartData:e.chart_data,chartType:e.chart_type}),n.preloadingSlug=null}).fail(function(){n.preloadingSlug=null}):(e=this.apiKey||(window.adeptusAuthData?window.adeptusAuthData.api_key:null))&&c.ajax({url:this.backendUrl+"/ai-reports/"+t,method:"GET",headers:{Authorization:"Bearer "+e,Accept:"application/json"},timeout:15e3}).done(function(e){e.success&&e.report&&(n.reportDataCache[r]={report:e.report,results:e.data||[],chartData:null,chartType:null}),n.preloadingSlug=null}).fail(function(){n.preloadingSlug=null})))},waitForAuth:function(t){var a=this;if(this.apiKey)return window.adeptusAuthData=window.adeptusAuthData||{},window.adeptusAuthData.api_key=this.apiKey,void t();window.adeptusAuthData&&window.adeptusAuthData.api_key?t():c.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/get_auth_status.php",method:"GET",dataType:"json",timeout:1e4}).done(function(e){e&&e.success&&e.data?(window.adeptusAuthData=e.data,t()):a.showError("Authentication failed")}).fail(function(){a.showError("Could not authenticate")})},fetchReports:function(){var r,o,i=this,e=this.apiKey||(window.adeptusAuthData?window.adeptusAuthData.api_key:null);e?(r=[],"all"!==(o=this.config.reportSource||"all")&&"wizard"!==o&&"manual"!==o&&"category"!==o||r.push(this.fetchFromApi("/wizard-reports",e)),"all"!==o&&"ai"!==o&&"manual"!==o&&"category"!==o||r.push(this.fetchFromApi("/ai-reports",e)),c.when.apply(c,r).then(function(){for(var t=[],e=0;e<r.length;e++){var a,n=(1===r.length?arguments:arguments[e])[0],n=n.reports||n.data||[];n&&n.length&&(a="ai"===o||1===e&&("all"===o||"manual"===o||"category"===o)?"ai":"wizard",n.forEach(function(e){e.source=e.source||a,t.push(e)}))}i.reports=t,i.lastUpdated=new Date,i.saveToCache(t),i.renderReports()}).fail(function(){i.showError()})):this.showError("No authentication token")},fetchFromApi:function(e,t){var a=""+this.backendUrl;return c.ajax({url:a+e,method:"GET",headers:{Authorization:"Bearer "+t,"Content-Type":"application/json",Accept:"application/json"},timeout:15e3})},renderReports:function(){var e=this.config.displayMode||"links";if(0!==this.reports.length){"embedded"!==e&&"links"!==e||this.populateCategoryFilter();var t=this.filterReports();switch(e){case"embedded":this.renderEmbedded(t);break;case"kpi":var a=this.getSelectedReportsForMode("kpi",t);this.renderKpi(a);break;case"tabs":a=this.getSelectedReportsForMode("tabs",t);this.renderTabs(a);break;default:this.renderLinks(t)}this.hideLoading(),this.updateTimestamp()}else this.showEmpty()},getSelectedReportsForMode:function(e,r){var t=[];if("kpi"===e&&this.config.kpiSelectedReports&&0<this.config.kpiSelectedReports.length?t=this.config.kpiSelectedReports:"tabs"===e&&this.config.tabsSelectedReports&&0<this.config.tabsSelectedReports.length&&(t=this.config.tabsSelectedReports),0===t.length)return r;var o=[];return t.forEach(function(t){var a=t.slug||t,n=t.source||"wizard",e=r.find(function(e){return e.slug===a&&(e.source===n||!t.source)});e&&(e=Object.assign({},e),t.icon&&(e.customIcon=t.icon),o.push(e))}),o},populateCategoryFilter:function(){var e,t,a=this,n={},r=this.config,o="category"===r.reportSource&&r.reportCategory,i=(o&&(this.selectedCategory=r.reportCategory),this.reports.forEach(function(e){var t=e.category_info;t&&t.slug?n[t.slug]={slug:t.slug,name:t.name||t.slug,color:t.color||"#6c757d"}:e.category&&(n[e.category]={slug:e.category,name:e.category,color:"#6c757d"})}),o&&!n[r.reportCategory]&&(e=r.reportCategory.replace(/[-_]/g," ").replace(/\b\w/g,function(e){return e.toUpperCase()}),n[r.reportCategory]={slug:r.reportCategory,name:e,color:"#6c757d"}),this.availableCategories=Object.values(n).sort(function(e,t){return e.name.localeCompare(t.name)}),this.container.find(".category-filter-select")),r=this.container.find(".category-dropdown"),s=r.find(".searchable-dropdown-list");i.length&&(i.find("option:not(:first)").remove(),this.availableCategories.forEach(function(e){var t=a.selectedCategory===e.slug?" selected":"";i.append('<option value="'+e.slug+'"'+t+">"+e.name+"</option>")})),s.length&&(s.empty(),e=this.selectedCategory?"":"selected",s.append('<li class="searchable-dropdown-item '+e+'" data-value="" data-search="all categories" role="option"><span class="dropdown-item-name">All Categories</span></li>'),this.availableCategories.forEach(function(e){e='<li class="searchable-dropdown-item '+(a.selectedCategory===e.slug?"selected":"")+'" data-value="'+e.slug+'" data-search="'+e.name.toLowerCase()+'" role="option"><span class="dropdown-item-name">'+a.escapeHtml(e.name)+'</span><span class="dropdown-item-category" style="background-color: '+e.color+'"><i class="fa fa-circle" style="font-size: 0.5rem;"></i></span></li>';s.append(e)}),e="All Categories",!this.selectedCategory||(t=this.availableCategories.find(function(e){return e.slug===a.selectedCategory}))&&(e=t.name),r.find(".searchable-dropdown-text").text(e),o&&(r.addClass("disabled"),r.find(".searchable-dropdown-toggle").addClass("disabled").attr("disabled",!0).css("pointer-events","none").attr("title","Category is set by block configuration"),i.prop("disabled",!0)))},populateReportSelector:function(){var e,t,a,n,r,o=this,i=this.container.find(".report-selector-select"),s=this.container.find(".block-adeptus-report-selector .searchable-dropdown"),d=s.find(".searchable-dropdown-list");i.length&&(e=this.filterReports(),i.find("option:not(:first)").remove(),d.empty(),e.forEach(function(e){var t=e.name||e.title||e.display_name||e.slug||"Untitled",a=e.slug+"::"+e.source,n=e.category_info||{name:"General",color:"#6c757d"},r=" ["+n.name+"]",e=o.selectedReportSlug===e.slug?" selected":"",e=(i.append('<option value="'+a+'"'+e+">"+t+r+"</option>"),'<li class="searchable-dropdown-item" data-value="'+a+'" data-search="'+t.toLowerCase()+" "+n.name.toLowerCase()+'" role="option"><span class="dropdown-item-name">'+o.escapeHtml(t)+'</span><span class="dropdown-item-category" style="background-color: '+n.color+'">'+o.escapeHtml(n.name)+"</span></li>");d.append(e)}),!this.selectedReportSlug||i.val()||(t=i.find('option[value^="'+this.selectedReportSlug+'::"]')).length&&t.prop("selected",!0),!i.val()&&0<e.length?(r=(t=e[0]).slug+"::"+t.source,n=t.name||t.title||t.display_name||t.slug||"Untitled",i.val(r),this.selectedReportSlug=t.slug,this.selectedReportSource=t.source,s.find(".searchable-dropdown-text").text(n),s.find(".searchable-dropdown-item").removeClass("selected"),s.find('.searchable-dropdown-item[data-value="'+r+'"]').addClass("selected"),this.loadEmbeddedReport(t.slug,t.source)):i.val()?(a=i.val().split("::"),(n=e.find(function(e){return e.slug===a[0]}))&&(r=n.name||n.title||n.display_name||n.slug||"Untitled",s.find(".searchable-dropdown-text").text(r),s.find(".searchable-dropdown-item").removeClass("selected"),s.find('.searchable-dropdown-item[data-value="'+i.val()+'"]').addClass("selected")),this.loadEmbeddedReport(a[0],a[1]||"wizard")):(s.find(".searchable-dropdown-text").text("-- No Reports --"),this.showEmpty()))},filterReports:function(){var t,a=this,e=this.reports.slice(),n=this.config;return this.selectedCategory&&(e=e.filter(function(e){return(e.category_info?e.category_info.slug:e.category||"")===a.selectedCategory})),"category"===n.reportSource&&n.reportCategory&&(e=e.filter(function(e){return(e.category_info?e.category_info.slug:e.category||"")===n.reportCategory})),"manual"===n.reportSource&&n.manualSelectedReports&&n.manualSelectedReports.length&&(t=n.manualSelectedReports.map(function(e){return"string"==typeof e?e:e.slug}),e=e.filter(function(e){return-1!==t.indexOf(e.slug)})),e.sort(function(e,t){e=e.name||e.title||e.display_name||e.report_name||e.slug||"",t=t.name||t.title||t.display_name||t.report_name||t.slug||"";return e.localeCompare(t)}),e},renderLinks:function(e){this.filteredReports=e,this.listItemsPerPage=this.config.maxLinkItems||10,this.listTotalPages=Math.ceil(e.length/this.listItemsPerPage),this.listCurrentPage=1,this.renderCurrentPage()},renderCurrentPage:function(){var e=this.filteredReports||[],n=this.container.find(".block-adeptus-report-list"),r=c("#block-adeptus-report-item-template-"+this.blockId),t=this.container.find(".block-adeptus-pagination"),a=(this.listCurrentPage-1)*this.listItemsPerPage,o=a+this.listItemsPerPage,o=e.slice(a,o);n.empty(),o.forEach(function(e){var t=r.html(),t=c(t),a=(t.attr("data-slug",e.slug),t.attr("data-source",e.source),e.name||e.title||e.display_name||e.report_name||e.slug||"Untitled Report"),a=(t.find(".report-item-name").text(a),e.category_info?e.category_info.name:e.category||"General"),e=e.category_info?e.category_info.color:"#6c757d";t.find(".report-item-category").text(a).css("background-color",e).css("color","#fff"),n.append(t)}),n.removeClass("d-none"),1<this.listTotalPages?(o=a+o.length,t.find(".pagination-showing").text("Showing "+(1+a)+"-"+o+" of "+e.length),t.find(".pagination-pages").text("Page "+this.listCurrentPage+" of "+this.listTotalPages),t.find(".pagination-prev").prop("disabled",this.listCurrentPage<=1),t.find(".pagination-next").prop("disabled",this.listCurrentPage>=this.listTotalPages),t.removeClass("d-none")):t.addClass("d-none")},renderEmbedded:function(e){this.embeddedReport=null,this.embeddedData=null,this.embeddedChartInstance=null,this.populateReportSelector(),0===this.reports.length&&this.showEmpty()},loadEmbeddedReport:function(t,e){var a=this,n=t+"_"+e;if(this.reportDataCache[n])return o=this.reportDataCache[n],this.embeddedData=o.results,void this.renderEmbeddedContent(o.report,o.results);this.showEmbeddedLoadingOverlay();var r=this.reports.find(function(e){return e.slug===t});if(!r)return this.hideEmbeddedLoadingOverlay(),void this.showError("Report not found");if("wizard"===e)c.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/generate_report.php",method:"POST",data:{reportid:r.name||r.report_template_id,sesskey:M.cfg.sesskey},dataType:"json",timeout:3e4}).done(function(e){a.hideEmbeddedLoadingOverlay(),e.success?(a.reportDataCache[n]={report:r,results:e.results||[],chartData:e.chart_data,chartType:e.chart_type},a.embeddedData=e.results||[],a.renderEmbeddedContent(r,e.results||[])):a.showError(e.message||"Failed to load report")}).fail(function(){a.hideEmbeddedLoadingOverlay(),a.showError("Connection error")});else{var o=this.apiKey||(window.adeptusAuthData?window.adeptusAuthData.api_key:null);if(!o)return this.hideEmbeddedLoadingOverlay(),void this.showError("No authentication token");c.ajax({url:this.backendUrl+"/ai-reports/"+t,method:"GET",headers:{Authorization:"Bearer "+o,Accept:"application/json"},timeout:15e3}).done(function(e){a.hideEmbeddedLoadingOverlay(),e.success&&e.report?(a.reportDataCache[n]={report:e.report,results:e.data||[],chartData:null,chartType:null},a.embeddedData=e.data||[],a.renderEmbeddedContent(e.report,e.data||[])):a.showError("Failed to load report")}).fail(function(){a.hideEmbeddedLoadingOverlay(),a.showError("Connection error")})}},renderEmbeddedContent:function(e,t){var a=this.container.find(".block-adeptus-content");t&&0!==t.length?(this.embeddedReport=e,this.embeddedData=t,e=e.category_info||{name:"General",color:"#6c757d"},this.container.find(".report-category").text(e.name).css("background-color",e.color).css("color","#fff"),this.container.find(".row-count-num").text(t.length),this.container.find(".report-date").text("Updated: "+(new Date).toLocaleTimeString()),this.populateEmbeddedChartControls(t),this.embeddedCurrentView="table",this.embeddedTablePage=1,this.container.find(".embedded-view-toggle-btn").removeClass("active"),this.container.find('.embedded-view-toggle-btn[data-view="table"]').addClass("active"),this.container.find(".embedded-table-view").removeClass("d-none"),this.container.find(".embedded-chart-view").addClass("d-none"),this.renderEmbeddedTablePage(),a.removeClass("d-none"),this.hideLoading(),this.updateTimestamp()):this.showEmpty()},switchEmbeddedView:function(e){this.embeddedCurrentView=e,this.container.find(".embedded-view-toggle-btn").removeClass("active"),this.container.find('.embedded-view-toggle-btn[data-view="'+e+'"]').addClass("active"),"table"===e?(this.container.find(".embedded-table-view").removeClass("d-none"),this.container.find(".embedded-chart-view").addClass("d-none")):(this.container.find(".embedded-table-view").addClass("d-none"),this.container.find(".embedded-chart-view").removeClass("d-none"),this.renderEmbeddedChart())},populateEmbeddedChartControls:function(e){var t,a,n;e&&0!==e.length&&(t=Object.keys(e[0]),e=this.detectNumericColumns(e,t),a=this.container.find(".embedded-chart-x-axis"),n=this.container.find(".embedded-chart-y-axis"),a.empty(),n.empty(),t.forEach(function(e){var t=e.replace(/_/g," ").replace(/\b\w/g,function(e){return e.toUpperCase()});a.append('<option value="'+e+'">'+t+"</option>")}),(0<e.length?e:t).forEach(function(e){var t=e.replace(/_/g," ").replace(/\b\w/g,function(e){return e.toUpperCase()});n.append('<option value="'+e+'">'+t+"</option>")}),this.embeddedXAxis=t[0],this.embeddedYAxis=0<e.length?e[e.length-1]:t[t.length-1],a.val(this.embeddedXAxis),n.val(this.embeddedYAxis))},renderEmbeddedTablePage:function(){var e,t,a,n=this.embeddedData||[],r=this.container.find(".embedded-table"),o=r.find("thead"),i=r.find("tbody");o.empty(),i.empty(),0!==n.length&&(e=Object.keys(n[0]),t=c("<tr>"),e.forEach(function(e){e=e.replace(/_/g," ").replace(/\b\w/g,function(e){return e.toUpperCase()});t.append(c("<th>").text(e))}),o.append(t),r=Math.ceil(n.length/this.embeddedTableRowsPerPage),o=(this.embeddedTablePage-1)*this.embeddedTableRowsPerPage,a=Math.min(o+this.embeddedTableRowsPerPage,n.length),n.slice(o,a).forEach(function(a){var n=c("<tr>");e.forEach(function(e){var e=a[e],t=(null==e&&(e=""),String(e));50<t.length&&(t=t.substring(0,50)+"..."),n.append(c("<td>").attr("title",e).text(t))}),i.append(n)}),this.container.find(".row-count").text("Showing "+(1+o)+"-"+a+" of "+n.length),this.container.find(".embedded-pagination-info").text("Page "+this.embeddedTablePage+" of "+r),this.container.find(".embedded-pagination-prev").prop("disabled",this.embeddedTablePage<=1),this.container.find(".embedded-pagination-next").prop("disabled",this.embeddedTablePage>=r))},renderEmbeddedChart:function(){var e=this.embeddedData||[],t=this.container.find(".embedded-chart")[0];if(t&&0!==e.length){this.embeddedChartInstance&&(this.embeddedChartInstance.destroy(),this.embeddedChartInstance=null);var a=this.embeddedChartType||"bar",n=this.embeddedXAxis||Object.keys(e[0])[0],r=this.embeddedYAxis||Object.keys(e[0])[1],o=e.slice(0,30),i=o.map(function(e){e=e[n];if(null==e)return"Unknown";e=String(e);return 20<e.length?e.substring(0,20)+"...":e}),o=o.map(function(e){return parseFloat(e[r])||0}),s=this.generateChartColors(o.length,a),o={label:r.replace(/_/g," ").replace(/\b\w/g,function(e){return e.toUpperCase()}),data:o},s=("pie"===a||"doughnut"===a?o.backgroundColor=s:(o.backgroundColor=s[0],o.borderColor=s[0].replace("0.7","1")),o.borderWidth=1,{type:a,data:{labels:i,datasets:[o]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:"pie"===a||"doughnut"===a,position:"right"}}}});"bar"!==a&&"line"!==a||(s.options.scales={y:{beginAtZero:!0},x:{display:e.length<=15}});try{this.embeddedChartInstance=new p(t.getContext("2d"),s)}catch(e){this.container.find(".embedded-chart-container").html('<div class="alert alert-warning text-center"><i class="fa fa-exclamation-circle"></i> Could not render chart</div>')}}},exportEmbeddedReport:function(e){var a,n,t=this.embeddedData||[],r=this.embeddedReport||{};0!==t.length&&"csv"===e&&(a=Object.keys(t[0]),n=a.join(",")+"\n",t.forEach(function(t){var e=a.map(function(e){e=t[e];if(null==e)return"";e=String(e);return e=e.includes(",")||e.includes('"')||e.includes("\n")?'"'+e.replace(/"/g,'""')+'"':e});n+=e.join(",")+"\n"}),e=new Blob([n],{type:"text/csv;charset=utf-8;"}),t=document.createElement("a"),r=r.name||r.slug||"report",t.href=URL.createObjectURL(e),t.download=r.replace(/[^a-z0-9]/gi,"_")+"_"+(new Date).toISOString().split("T")[0]+".csv",t.click())},renderKpi:function(e){var n=this,r=this.container.find(".block-adeptus-kpi-grid"),o=c("#block-adeptus-kpi-card-template-"+this.blockId),t=parseInt(this.config.kpiColumns,10)||2,t=Math.min(2*t,4),e=(r.empty(),e.slice(0,t)),i={},s=[],d=[];e.forEach(function(e,t){var a=o.html(),a=c(a),n=e.name||e.title||e.display_name||e.slug||"Metric",n=(a.attr("data-slug",e.slug),a.attr("data-source",e.source),a.find(".kpi-card-label").text(n),a.find(".kpi-card-value").html('<i class="fa fa-spinner fa-spin"></i>'),a.find(".kpi-card-trend").addClass("d-none"),a.find(".kpi-card-sparkline").addClass("d-none"),["fa-users","fa-graduation-cap","fa-clock-o","fa-check-circle"]),n=e.customIcon||n[t%n.length];a.find(".kpi-card-icon i").removeClass("fa-bar-chart").addClass(n),r.append(a),i[e.slug]={$card:a,report:e,index:t},("wizard"===e.source?s:d).push(e)}),r.removeClass("d-none"),0<s.length&&this.loadKpiBatch(s,i),d.forEach(function(e,t){var a=i[e.slug];setTimeout(function(){n.loadKpiData(e,a.$card,a.index)},100*t)})},loadKpiBatch:function(r,i){var s=this,d=performance.now(),t=r.map(function(e){return e.report_template_id||e.id||e.name||e.slug});console.log("[AdeptusKPI] Starting batch load for "+t.length+" wizard reports"),c.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/batch_kpi_data.php",method:"POST",data:{reportids:JSON.stringify(t),sesskey:M.cfg.sesskey},dataType:"json",timeout:3e4}).done(function(o){var e=Math.round(performance.now()-d);console.log("[AdeptusKPI] Batch load completed in "+e+"ms for "+t.length+" reports (server: "+(o.total_time_ms||"?")+"ms)"),o.success&&o.reports?r.forEach(function(e){var t,a,n=e.report_template_id||e.id||e.name||e.slug,n=o.reports[n],r=i[e.slug];r&&(t=r.$card,a=e.slug+"_"+e.source,n&&n.success?(console.log("[AdeptusKPI] Card "+r.index+" ("+e.slug+") loaded in batch ("+(n.time_ms||"?")+"ms, "+n.count+" rows)"),s.reportDataCache[a]={report:e,results:n.results||[]},s.renderKpiValue(t,n.results||[])):(console.warn("[AdeptusKPI] Card "+r.index+" ("+e.slug+") failed in batch:",n?n.error:"No data"),t.find(".kpi-card-value").text("--"),t.find(".kpi-card-trend").addClass("d-none")))}):(console.warn("[AdeptusKPI] Batch load failed, falling back to individual requests"),r.forEach(function(e,t){var a=i[e.slug];setTimeout(function(){s.loadKpiData(e,a.$card,a.index)},100*t)}))}).fail(function(e,t,a){var n=Math.round(performance.now()-d);console.error("[AdeptusKPI] Batch load failed after "+n+"ms:",t,a),r.forEach(function(e,t){var a=i[e.slug];setTimeout(function(){s.loadKpiData(e,a.$card,a.index)},100*t)})})},loadKpiData:function(r,o,i,s){var d=this,a=r.slug+"_"+r.source,l=(s=s||0,performance.now());if(this.reportDataCache[a])return e=this.reportDataCache[a],console.log("[AdeptusKPI] Card "+i+" ("+r.slug+") loaded from cache"),void this.renderKpiValue(o,e.results);var e=r.report_template_id||r.id||r.name||r.slug;if(console.log("[AdeptusKPI] Card "+i+" ("+r.slug+") starting request..."),"wizard"===r.source)c.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/generate_report.php",method:"POST",data:{reportid:e,sesskey:M.cfg.sesskey},dataType:"json",timeout:3e4}).done(function(e){var t=Math.round(performance.now()-l);e.success?(console.log("[AdeptusKPI] Card "+i+" ("+r.slug+") loaded in "+t+"ms"),d.reportDataCache[a]={report:r,results:e.results||[]},d.renderKpiValue(o,e.results||[])):(console.warn("[AdeptusKPI] Card "+i+" ("+r.slug+") failed in "+t+"ms:",e.error||"Unknown error"),o.find(".kpi-card-value").text("--"),o.find(".kpi-card-trend").addClass("d-none"))}).fail(function(e,t,a){var n=Math.round(performance.now()-l);console.error("[AdeptusKPI] Card "+i+" ("+r.slug+") AJAX error after "+n+"ms:",t,a,"Status:",e.status),s<2&&("timeout"===t||500<=e.status)?(console.log("[AdeptusKPI] Retrying card "+i+" (attempt "+(s+2)+")"),setTimeout(function(){d.loadKpiData(r,o,i,s+1)},1e3*(s+1))):(o.find(".kpi-card-value").text("--"),o.find(".kpi-card-trend").addClass("d-none"))});else{e=this.apiKey||(window.adeptusAuthData?window.adeptusAuthData.api_key:null);if(!e)return console.warn("[AdeptusKPI] Card "+i+" ("+r.slug+"): No API token available"),o.find(".kpi-card-value").text("--"),void o.find(".kpi-card-trend").addClass("d-none");c.ajax({url:this.backendUrl+"/ai-reports/"+r.slug,method:"GET",headers:{Authorization:"Bearer "+e,Accept:"application/json"},timeout:3e4}).done(function(e){var t=Math.round(performance.now()-l);e.success&&e.data?(console.log("[AdeptusKPI] Card "+i+" ("+r.slug+") AI loaded in "+t+"ms"),d.reportDataCache[a]={report:e.report||r,results:e.data||[]},d.renderKpiValue(o,e.data||[])):(console.warn("[AdeptusKPI] Card "+i+" ("+r.slug+") AI failed in "+t+"ms:",e.error||"No data returned"),o.find(".kpi-card-value").text("--"),o.find(".kpi-card-trend").addClass("d-none"))}).fail(function(e,t,a){var n=Math.round(performance.now()-l);console.error("[AdeptusKPI] Card "+i+" ("+r.slug+") AI error after "+n+"ms:",t,a,"Status:",e.status),s<2&&("timeout"===t||500<=e.status)?(console.log("[AdeptusKPI] Retrying AI card "+i+" (attempt "+(s+2)+")"),setTimeout(function(){d.loadKpiData(r,o,i,s+1)},1e3*(s+1))):(o.find(".kpi-card-value").text("--"),o.find(".kpi-card-trend").addClass("d-none"))})}},renderKpiValue:function(e,t){var a=e.data("slug"),n=e.data("source")||"wizard",r=e.find(".kpi-card-label").text()||"";if(!t||0===t.length)return e.find(".kpi-card-value").text("0"),void this.saveKpiHistoryToServer(e,a,0,n,r,0);var o,i,s=Object.keys(t[0]),s=this.detectNumericColumns(t,s);s=0<s.length&&((i=s[s.length-1]).toLowerCase().includes("count")||i.toLowerCase().includes("total")||1===t.length)?t.reduce(function(e,t){return e+(parseFloat(t[i])||0)},0):t.length,o=this.formatKpiValue(s),e.find(".kpi-card-value").text(o),this.saveKpiHistoryToServer(e,a,s,n,r,t.length)},formatKpiValue:function(e){return 1e6<=e?(e/1e6).toFixed(1)+"M":1e3<=e?(e/1e3).toFixed(1)+"K":Number.isInteger(e)?e.toLocaleString():e.toFixed(1)},saveKpiHistoryToServer:function(t,a,n,r,o,i){var s=this,d=parseInt(this.config.kpiHistoryInterval,10)||3600;require(["core/ajax"],function(e){e.call([{methodname:"block_adeptus_insights_save_kpi_history",args:{blockinstanceid:s.blockId,reportslug:a,value:n,source:r||"wizard",label:o||"",rowcount:i||0,contexttype:"site",contextid:0,interval:d}}])[0].done(function(e){e.success&&s.updateKpiTrendFromServer(t,e.trend_direction,e.trend_percentage)}).fail(function(){})}),this.loadKpiSparklineFromServer(t,a,n)},loadKpiSparklineFromServer:function(t,a,n){var r=this;require(["core/ajax"],function(e){e.call([{methodname:"block_adeptus_insights_get_kpi_history",args:{blockinstanceid:r.blockId,reportslug:a,limit:10}}])[0].done(function(e){e.success&&e.sparkline&&2<=e.sparkline.length?r.renderKpiSparklineFromData(t,a,e.sparkline,n):t.find(".kpi-card-sparkline").addClass("d-none")}).fail(function(){t.find(".kpi-card-sparkline").addClass("d-none")})})},updateKpiTrendFromServer:function(e,t,a){e=e.find(".kpi-card-trend"),e.removeClass("d-none trend-up trend-down trend-neutral"),a=Math.abs(a),a=100<=a?Math.round(a)+"%":10<=a?a.toFixed(0)+"%":a.toFixed(1)+"%";"up"===t?(e.addClass("trend-up"),e.find(".trend-icon").html('<i class="fa fa-arrow-up"></i>'),e.find(".trend-value").text(a+" vs previous")):"down"===t?(e.addClass("trend-down"),e.find(".trend-icon").html('<i class="fa fa-arrow-down"></i>'),e.find(".trend-value").text(a+" vs previous")):(e.addClass("trend-neutral"),e.find(".trend-icon").html('<i class="fa fa-minus"></i>'),e.find(".trend-value").text("No change"))},updateKpiTrend:function(e,t,a){e=e.find(".kpi-card-trend");e.removeClass("d-none"),e.addClass("trend-neutral"),e.find(".trend-icon").html('<i class="fa fa-spinner fa-spin"></i>'),e.find(".trend-value").text("Loading...")},renderKpiSparklineFromData:function(t,e,a,n){var t=t.find(".kpi-card-sparkline"),r=t.find(".sparkline-chart")[0];if(r){a=a.slice();if(0!==a.length&&a[a.length-1]===n||a.push(n),a.length<2)t.addClass("d-none");else{t.removeClass("d-none");var n=a[0],o=a[a.length-1],i=n<=o?"rgba(40, 167, 69, 0.8)":"rgba(220, 53, 69, 0.8)",n=n<=o?"rgba(40, 167, 69, 0.1)":"rgba(220, 53, 69, 0.1)",o="sparkline_"+this.blockId+"_"+e;this.kpiSparklineCharts&&this.kpiSparklineCharts[o]&&this.kpiSparklineCharts[o].destroy(),this.kpiSparklineCharts||(this.kpiSparklineCharts={});try{this.kpiSparklineCharts[o]=new p(r.getContext("2d"),{type:"line",data:{labels:a.map(function(){return""}),datasets:[{data:a,borderColor:i,backgroundColor:n,borderWidth:2,fill:!0,tension:.4,pointRadius:0,pointHoverRadius:0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{enabled:!1}},scales:{x:{display:!1},y:{display:!1}},elements:{line:{borderCapStyle:"round"}},animation:{duration:500}}})}catch(e){t.addClass("d-none")}}}},renderKpiSparkline:function(e,t,a){},renderTabs:function(e){var t,o=this,i=this.container.find(".block-adeptus-tab-nav"),s=this.container.find(".block-adeptus-tab-content"),d=c("#block-adeptus-tab-template-"+this.blockId),l=c("#block-adeptus-tab-pane-template-"+this.blockId);i.empty(),s.empty(),this.tabChartInstances={},e.slice(0,5).forEach(function(e,t){var a="tab-"+o.blockId+"-"+t,n=e.name||e.title||e.display_name||e.slug||"Report",r=c(d.html()),n=(r.find("a").attr("href","#"+a).attr("aria-controls",a),r.find(".tab-name").text(n),0===t&&r.find("a").addClass("active").attr("aria-selected","true"),i.append(r),c(l.html()));n.attr("id",a),n.attr("data-slug",e.slug),n.attr("data-source",e.source),0===t&&n.addClass("show active"),s.append(n)}),0<e.length&&(t=s.find(".tab-pane").first(),this.loadTabContent(t,e[0].slug,e[0].source)),this.container.find(".block-adeptus-tabs-container").removeClass("d-none")},loadTabContent:function(t,a,e){var n=this,r=a+"_"+e;if(t.data("loaded",!0),this.reportDataCache[r])return i=this.reportDataCache[r],void this.renderTabContent(t,i.report,i.results);var o=this.reports.find(function(e){return e.slug===a});if(!o)return t.find(".tab-pane-loading").addClass("d-none"),void t.find(".tab-pane-content").removeClass("d-none").html('<div class="text-center text-muted py-4"><i class="fa fa-exclamation-circle"></i><p class="mt-2">Report not found</p></div>');if("wizard"===e)c.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/generate_report.php",method:"POST",data:{reportid:o.name||o.report_template_id,sesskey:M.cfg.sesskey},dataType:"json",timeout:3e4}).done(function(e){e.success?(n.reportDataCache[r]={report:o,results:e.results||[]},n.renderTabContent(t,o,e.results||[])):(t.find(".tab-pane-loading").addClass("d-none"),t.find(".tab-pane-content").removeClass("d-none").html('<div class="text-center text-muted py-4"><i class="fa fa-exclamation-circle"></i><p class="mt-2">'+(e.message||"Failed to load")+"</p></div>"))}).fail(function(){t.find(".tab-pane-loading").addClass("d-none"),t.find(".tab-pane-content").removeClass("d-none").html('<div class="text-center text-muted py-4"><i class="fa fa-exclamation-circle"></i><p class="mt-2">Connection error</p></div>')});else{var i=this.apiKey||(window.adeptusAuthData?window.adeptusAuthData.api_key:null);if(!i)return t.find(".tab-pane-loading").addClass("d-none"),void t.find(".tab-pane-content").removeClass("d-none").html('<div class="text-center text-muted py-4"><i class="fa fa-exclamation-circle"></i><p class="mt-2">Authentication required</p></div>');c.ajax({url:this.backendUrl+"/ai-reports/"+a,method:"GET",headers:{Authorization:"Bearer "+i,Accept:"application/json"},timeout:15e3}).done(function(e){e.success?(n.reportDataCache[r]={report:e.report||o,results:e.data||[]},n.renderTabContent(t,e.report||o,e.data||[])):(t.find(".tab-pane-loading").addClass("d-none"),t.find(".tab-pane-content").removeClass("d-none").html('<div class="text-center text-muted py-4"><i class="fa fa-exclamation-circle"></i><p class="mt-2">Failed to load report</p></div>'))}).fail(function(){t.find(".tab-pane-loading").addClass("d-none"),t.find(".tab-pane-content").removeClass("d-none").html('<div class="text-center text-muted py-4"><i class="fa fa-exclamation-circle"></i><p class="mt-2">Connection error</p></div>')})}},renderTabContent:function(e,t,a){var n,r,o=e.attr("id"),i=(e.find(".tab-pane-loading").addClass("d-none"),e.find(".tab-pane-content"));a&&0!==a.length?(r={data:a,report:t,headers:n=Object.keys(a[0]),numericCols:r=this.detectNumericColumns(a,n),currentView:"table",tablePage:1,rowsPerPage:25,chartType:"bar",xAxis:n[0],yAxis:0<r.length?r[r.length-1]:n[n.length-1]},this.tabPaneStates[o]=r,i.removeClass("d-none"),this.updateTabMetaBar(e,t,a),this.populateTabChartControls(e,r),this.renderTabTablePage(e,r),e.find(".tab-view-toggle-btn").removeClass("active"),e.find('.tab-view-toggle-btn[data-view="table"]').addClass("active"),e.find(".tab-table-view").removeClass("d-none"),e.find(".tab-chart-view").addClass("d-none")):i.removeClass("d-none").html('<div class="text-center text-muted py-4"><i class="fa fa-inbox"></i><p class="mt-2">No data available</p></div>')},updateTabMetaBar:function(e,t,a){var n=t.category||t.category_name||"",r=e.find(".report-category"),n=(n?(r.text(n).removeClass("d-none"),t.category_color?r.css("background-color",t.category_color):r.addClass("bg-primary")):r.addClass("d-none"),e.find(".row-count-num").text(a.length),t.updated_at||t.created_at||"");n&&(r=new Date(n),e.find(".report-date").text(r.toLocaleDateString()))},populateTabChartControls:function(e,t){var a=e.find(".tab-chart-x-axis"),n=e.find(".tab-chart-y-axis");a.empty(),n.empty(),t.headers.forEach(function(e){var t=e.replace(/_/g," ").replace(/\b\w/g,function(e){return e.toUpperCase()});a.append(c("<option>").val(e).text(t)),n.append(c("<option>").val(e).text(t))}),a.val(t.xAxis),n.val(t.yAxis)},switchTabView:function(e,t){var a=e.attr("id"),a=this.tabPaneStates[a];a&&(a.currentView=t,e.find(".tab-view-toggle-btn").removeClass("active"),e.find('.tab-view-toggle-btn[data-view="'+t+'"]').addClass("active"),"table"===t?(e.find(".tab-table-view").removeClass("d-none"),e.find(".tab-chart-view").addClass("d-none")):(e.find(".tab-table-view").addClass("d-none"),e.find(".tab-chart-view").removeClass("d-none"),this.renderTabChart(e,a)))},renderTabTablePage:function(e,t){var a=e.find(".tab-table"),n=a.find("thead"),r=a.find("tbody"),a=t.data,o=t.headers,i=(n.empty(),r.empty(),c("<tr>")),n=(o.forEach(function(e){e=e.replace(/_/g," ").replace(/\b\w/g,function(e){return e.toUpperCase()});i.append(c("<th>").text(e))}),n.append(i),a.length),s=Math.ceil(n/t.rowsPerPage),d=(t.tablePage-1)*t.rowsPerPage,l=Math.min(d+t.rowsPerPage,n),a=(a.slice(d,l).forEach(function(a){var n=c("<tr>");o.forEach(function(e){var e=a[e],t=(null==e&&(e=""),String(e));50<t.length&&(t=t.substring(0,50)+"..."),n.append(c("<td>").attr("title",e).text(t))}),r.append(n)}),"Showing "+(1+d)+"-"+l+" of "+n);e.find(".row-count").text(a),e.find(".tab-pagination-info").text("Page "+t.tablePage+" of "+s),e.find(".tab-pagination-prev").prop("disabled",t.tablePage<=1),e.find(".tab-pagination-next").prop("disabled",t.tablePage>=s),1<s?e.find(".tab-table-pagination").removeClass("d-none"):e.find(".tab-table-pagination").addClass("d-none")},renderTabChart:function(t,e){var a=t.attr("id"),n=t.find(".tab-chart")[0];if(n&&e.data&&0!==e.data.length){this.tabChartInstances&&this.tabChartInstances[a]&&this.tabChartInstances[a].destroy();var r=e.chartType,o=e.xAxis,i=e.yAxis,e=e.data,s=e.slice(0,20),d=s.map(function(e){e=e[o];if(null==e)return"Unknown";e=String(e);return 20<e.length?e.substring(0,20)+"...":e}),s=s.map(function(e){return parseFloat(e[i])||0}),l=this.generateChartColors(s.length,r),d={type:r,data:{labels:d,datasets:[{label:i.replace(/_/g," ").replace(/\b\w/g,function(e){return e.toUpperCase()}),data:s,backgroundColor:"pie"===r||"doughnut"===r?l:l[0],borderColor:"line"!==r&&("pie"===r||"doughnut"===r)?"#fff":l[0],borderWidth:"pie"===r||"doughnut"===r?2:1,fill:"line"!==r&&void 0,tension:"line"===r?.1:void 0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:"pie"===r||"doughnut"===r,position:"right"}},scales:"pie"===r||"doughnut"===r?{}:{y:{beginAtZero:!0},x:{display:e.length<=10}}}};try{this.tabChartInstances=this.tabChartInstances||{},this.tabChartInstances[a]=new p(n.getContext("2d"),d)}catch(e){t.find(".tab-chart-container").html('<div class="alert alert-warning text-center"><i class="fa fa-exclamation-circle"></i> Could not render chart</div>')}}},exportTabReport:function(e,t){var a,n,r;e&&e.data&&0!==e.data.length&&"csv"===t&&(a=e.headers,(n=[]).push(a.map(function(e){return'"'+e.replace(/"/g,'""')+'"'}).join(",")),e.data.forEach(function(t){var e=a.map(function(e){e=t[e];return null==e&&(e=""),'"'+String(e).replace(/"/g,'""')+'"'});n.push(e.join(","))}),t=n.join("\n"),t=new Blob([t],{type:"text/csv;charset=utf-8;"}),t=URL.createObjectURL(t),r=document.createElement("a"),e=e.report.name||e.report.slug||"report",r.href=t,r.download=e.replace(/[^a-z0-9]/gi,"_")+".csv",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(t))},renderTabTable:function(e,t){var r,a,e=e.find("table"),n=e.find("thead"),o=e.find("tbody"),e=this.config.tableMaxRows||10;n.empty(),o.empty(),t&&0!==t.length&&(r=Object.keys(t[0]),a=c("<tr>"),r.forEach(function(e){e=e.replace(/_/g," ").replace(/\b\w/g,function(e){return e.toUpperCase()});a.append(c("<th>").text(e))}),n.append(a),t.slice(0,e).forEach(function(a){var n=c("<tr>");r.forEach(function(e){var e=a[e],t=(null==e&&(e=""),String(e));40<t.length&&(t=t.substring(0,40)+"..."),n.append(c("<td>").attr("title",e).text(t))}),o.append(n)}))},handleReportClick:function(e,t){switch(this.config.clickAction||"modal"){case"modal":this.openReportModal(e,t);break;case"newtab":this.openReportNewTab(e,t);break;case"expand":this.expandReportInline(e,t)}},openReportModal:function(t,a){var n=this,r=this.reports.find(function(e){return e.slug===t});r&&(this.modalData=null,this.modalReport=null,this.currentView="table",this.chartInstance&&(this.chartInstance.destroy(),this.chartInstance=null),d.render("block_adeptus_insights/report_modal",{blockid:this.blockId}).then(function(e){return i.create({type:i.types.DEFAULT,title:r.name,body:e,large:!0})}).then(function(e){return n.modal=e,n.bindModalEvents(e),e.getRoot().on(s.shown,function(){n.loadModalReport(t,a)}),e.getRoot().on(s.hidden,function(){n.chartInstance&&(n.chartInstance.destroy(),n.chartInstance=null),e.destroy(),n.modal=null,n.modalData=null,n.modalReport=null}),e.show(),e}).catch(o.exception))},bindModalEvents:function(e){var t=this,e=e.getRoot();e.on("click",".view-toggle-btn",function(e){e.preventDefault();e=c(this).data("view");t.switchModalView(e)}),e.on("change","#modal-chart-type, #modal-chart-x-axis, #modal-chart-y-axis",function(){"chart"===t.currentView&&t.renderModalChart()}),e.on("click",".modal-retry",function(e){e.preventDefault(),t.modalReport&&t.loadModalReport(t.modalReport.slug,t.modalReport.source)}),e.on("click",'.modal-export[data-format="csv"]',function(e){e.preventDefault(),t.exportModalData("csv")}),e.on("click",".table-pagination-prev",function(e){e.preventDefault(),1<t.tableCurrentPage&&(t.tableCurrentPage--,t.renderModalTablePage())}),e.on("click",".table-pagination-next",function(e){e.preventDefault(),t.tableCurrentPage<t.tableTotalPages&&(t.tableCurrentPage++,t.renderModalTablePage())})},switchModalView:function(e){var t=this.modal.getBody();t.find(".view-toggle-btn").removeClass("active"),t.find('.view-toggle-btn[data-view="'+e+'"]').addClass("active"),"table"===e?(t.find("#modal-table-view").removeClass("d-none"),t.find("#modal-chart-view").addClass("d-none")):(t.find("#modal-table-view").addClass("d-none"),t.find("#modal-chart-view").removeClass("d-none"),this.renderModalChart()),this.currentView=e},loadModalReport:function(t,e){var a=this,n=this.modal.getBody(),r=t+"_"+e;if(this.reportDataCache[r])return i=this.reportDataCache[r],n.find(".modal-loading").addClass("d-none"),void this.renderModalContent(n,i.report,i.results,i.chartData,i.chartType);var o=this.reports.find(function(e){return e.slug===t});if(!o)return n.find(".modal-loading").addClass("d-none"),void n.find(".modal-error").removeClass("d-none");if("wizard"===e)c.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/generate_report.php",method:"POST",data:{reportid:o.name||o.report_template_id,sesskey:M.cfg.sesskey},dataType:"json",timeout:3e4}).done(function(e){n.find(".modal-loading").addClass("d-none"),e.success?(a.reportDataCache[r]={report:o,results:e.results||[],chartData:e.chart_data,chartType:e.chart_type},a.renderModalContent(n,o,e.results||[],e.chart_data,e.chart_type)):(n.find(".modal-error").removeClass("d-none"),n.find(".modal-error p").text(e.message||"Failed to load report"))}).fail(function(){n.find(".modal-loading").addClass("d-none"),n.find(".modal-error").removeClass("d-none")});else{var i=this.apiKey||(window.adeptusAuthData?window.adeptusAuthData.api_key:null);if(!i)return n.find(".modal-loading").addClass("d-none"),void n.find(".modal-error").removeClass("d-none");c.ajax({url:this.backendUrl+"/ai-reports/"+t,method:"GET",headers:{Authorization:"Bearer "+i,Accept:"application/json"},timeout:15e3}).done(function(e){n.find(".modal-loading").addClass("d-none"),e.success&&e.report?(a.reportDataCache[r]={report:e.report,results:e.data||[],chartData:null,chartType:null},a.renderModalContent(n,e.report,e.data||[],null,null)):n.find(".modal-error").removeClass("d-none")}).fail(function(){n.find(".modal-loading").addClass("d-none"),n.find(".modal-error").removeClass("d-none")})}},renderModalContent:function(e,t,a,n,r){this.modalData=a||[],this.modalReport=t;e.find(".modal-content-area").removeClass("d-none");var a=t.category_info||{name:"General",color:"#6c757d"};e.find(".report-category").text(a.name).css("background-color",a.color),e.find(".row-count-num").text(this.modalData.length),e.find(".report-date").text(t.last_executed_at?"Last run: "+new Date(t.last_executed_at).toLocaleDateString():""),this.populateAxisSelectors(e),this.renderModalTable(e,this.modalData),this.isAdmin?(a=M.cfg.wwwroot+"/report/adeptus_insights/generated_reports.php?slug="+encodeURIComponent(t.slug),e.find(".view-full-report").attr("href",a),e.find(".modal-footer-link").removeClass("d-none")):e.find(".modal-footer-link").addClass("d-none"),this.currentView="table",e.find(".view-toggle-btn").removeClass("active"),e.find('.view-toggle-btn[data-view="table"]').addClass("active"),e.find("#modal-table-view").removeClass("d-none"),e.find("#modal-chart-view").addClass("d-none")},populateAxisSelectors:function(e){var t,n,r,o,a=this.modalData;a&&0!==a.length&&(t=Object.keys(a[0]),n=e.find("#modal-chart-x-axis"),r=e.find("#modal-chart-y-axis"),n.empty(),r.empty(),e=this.detectNumericColumns(a,t),t.forEach(function(e,t){var a=e.replace(/_/g," ").replace(/\b\w/g,function(e){return e.toUpperCase()});n.append('<option value="'+e+'"'+(0===t?" selected":"")+">"+a+"</option>")}),(o=0<e.length?e:t).forEach(function(e,t){var a=e.replace(/_/g," ").replace(/\b\w/g,function(e){return e.toUpperCase()}),t=t===o.length-1?" selected":"";r.append('<option value="'+e+'"'+t+">"+a+"</option>")}))},detectNumericColumns:function(n,e){var r=[];return e.forEach(function(t){var e=n.every(function(e){e=e[t];return null==e||""===e||!isNaN(parseFloat(e))&&isFinite(e)}),a=n.some(function(e){e=e[t];return null!=e&&""!==e&&!isNaN(parseFloat(e))});e&&a&&r.push(t)}),r},renderModalChart:function(){var t=this.modal.getBody(),e=this.modalData;if(e&&0!==e.length){var a=t.find(".modal-chart")[0];if(a){this.chartInstance&&(this.chartInstance.destroy(),this.chartInstance=null);var n=t.find("#modal-chart-type").val()||"bar",r=t.find("#modal-chart-x-axis").val(),o=t.find("#modal-chart-y-axis").val(),i=(r&&o||(i=Object.keys(e[0]),r=r||i[0],o=o||i[i.length-1]),o.replace(/_/g," ").replace(/\b\w/g,function(e){return e.toUpperCase()})),e=e.slice(0,50),s=e.map(function(e){e=e[r];if(null==e)return"Unknown";e=String(e);return 30<e.length?e.substring(0,30)+"...":e}),e=e.map(function(e){return parseFloat(e[o])||0}),d=this.generateChartColors(e.length,n),n=this.createChartConfig(n,s,e,i,d);try{this.chartInstance=new p(a.getContext("2d"),n)}catch(e){t.find(".chart-container").html('<div class="alert alert-danger"><i class="fa fa-exclamation-triangle"></i> Error rendering chart</div>')}}}else t.find(".chart-container").html('<div class="alert alert-warning text-center"><i class="fa fa-info-circle"></i> No data available for chart</div>')},createChartConfig:function(e,t,a,n,r){var o={responsive:!0,maintainAspectRatio:!1,plugins:{title:{display:!0,text:this.modalReport?this.modalReport.name:"Report",font:{size:14,weight:"bold"},padding:{top:10,bottom:20}},legend:{display:"pie"===e||"doughnut"===e,position:"right"}}};return"pie"===e||"doughnut"===e?{type:e,data:{labels:t,datasets:[{data:a,backgroundColor:r,borderWidth:2}]},options:o}:(o.scales={y:{beginAtZero:!0,title:{display:!0,text:n}},x:{title:{display:!1}}},{type:e,data:{labels:t,datasets:[{label:n,data:a,backgroundColor:"line"===e?"transparent":r[0],borderColor:r[0].replace("0.7","1"),borderWidth:2,fill:"line"!==e,tension:.1}]},options:o})},generateChartColors:function(e,t){for(var a=["rgba(37, 99, 235, 0.7)","rgba(16, 185, 129, 0.7)","rgba(245, 158, 11, 0.7)","rgba(239, 68, 68, 0.7)","rgba(139, 92, 246, 0.7)","rgba(6, 182, 212, 0.7)","rgba(236, 72, 153, 0.7)","rgba(132, 204, 22, 0.7)","rgba(249, 115, 22, 0.7)","rgba(99, 102, 241, 0.7)"],n=[],r=0;r<e;r++)n.push(a[r%a.length]);return n},exportModalData:function(e){var a,n,t=this.modalData,r=this.modalReport;t&&0!==t.length?"csv"===e&&(a=Object.keys(t[0]),n=a.join(",")+"\n",t.forEach(function(t){var e=a.map(function(e){e=t[e];return null==e&&(e=""),e=-1===(e=String(e).replace(/"/g,'""')).indexOf(",")&&-1===e.indexOf('"')&&-1===e.indexOf("\n")?e:'"'+e+'"'});n+=e.join(",")+"\n"}),e=new Blob([n],{type:"text/csv;charset=utf-8;"}),(t=document.createElement("a")).href=URL.createObjectURL(e),t.download=(r?r.name.replace(/[^a-z0-9]/gi,"_"):"report")+".csv",t.click()):o.addNotification({message:"No data to export",type:"warning"})},renderModalTable:function(e,t){this.tableCurrentPage=1,this.tableTotalPages=Math.ceil((t?t.length:0)/this.tableRowsPerPage);var a,n=e.find(".modal-table").find("thead");n.empty(),t&&0!==t.length?(t=Object.keys(t[0]),a=c("<tr>"),t.forEach(function(e){e=e.replace(/_/g," ").replace(/\b\w/g,function(e){return e.toUpperCase()});a.append(c("<th>").text(e))}),n.append(a),this.renderModalTablePage()):e.find(".modal-table-container").addClass("d-none")},renderModalTablePage:function(){var e,t,a,n=this.modal.getBody(),r=this.modalData||[],o=n.find(".modal-table").find("tbody");o.empty(),r&&0!==r.length&&(e=Object.keys(r[0]),a=(t=(this.tableCurrentPage-1)*this.tableRowsPerPage)+this.tableRowsPerPage,r.slice(t,a).forEach(function(a){var n=c("<tr>");e.forEach(function(e){var e=a[e],t=(null==e&&(e=""),String(e));100<t.length&&(t=t.substring(0,100)+"..."),n.append(c("<td>").attr("title",e).text(t))}),o.append(n)}),a=Math.min(a,r.length),n.find(".row-count").text(r.length+" total rows"),n.find(".table-pagination-info").text(1+t+"-"+a+" of "+r.length),n.find(".table-pagination-prev").prop("disabled",this.tableCurrentPage<=1),n.find(".table-pagination-next").prop("disabled",this.tableCurrentPage>=this.tableTotalPages),1<this.tableTotalPages?n.find(".table-pagination").removeClass("d-none"):n.find(".table-pagination").addClass("d-none"))},openReportNewTab:function(e,t){e=M.cfg.wwwroot+"/report/adeptus_insights/generated_reports.php?slug="+encodeURIComponent(e);window.open(e,"_blank")},expandReportInline:function(e,t){},exportReport:function(e){o.addNotification({message:"Export to "+e.toUpperCase()+" coming soon",type:"info"})},refresh:function(){var e=this.container.find(".block-adeptus-refresh i"),t=(e.addClass("fa-spin"),this.clearAllCaches(),this.showLoading(),this);this.waitForAuth(function(){t.fetchReports()}),setTimeout(function(){e.removeClass("fa-spin")},1e3)},clearAllCaches:function(){try{sessionStorage.removeItem(this.cacheKey)}catch(e){}this.reportDataCache={}},setupAutoRefresh:function(){var e,t=this.config.autoRefresh;if(t&&"never"!==t){switch(t){case"5m":e=3e5;break;case"15m":e=9e5;break;case"30m":e=18e5;break;case"1h":e=36e5;break;default:return}var a=this;this.refreshTimer=setInterval(function(){document.hidden||a.refresh()},e)}},showLoading:function(){this.container.find(".block-adeptus-loading").removeClass("d-none"),this.container.find(".block-adeptus-report-list, .block-adeptus-kpi-grid, .block-adeptus-tabs-container, .block-adeptus-content").addClass("d-none"),this.container.find(".block-adeptus-empty, .block-adeptus-error").addClass("d-none")},hideLoading:function(){this.container.find(".block-adeptus-loading").addClass("d-none")},showEmpty:function(){this.hideLoading(),this.container.find(".block-adeptus-empty").removeClass("d-none")},showError:function(e){this.hideLoading(),this.container.find(".block-adeptus-error").removeClass("d-none")},updateTimestamp:function(){var e,t;if(this.lastUpdated)return e=this.formatTimeAgo(this.lastUpdated),t=this.container.find(".block-adeptus-kpi-footer"),t.length?(t.find(".timestamp-text").text(e),void t.removeClass("d-none")):void(this.config.showTimestamp&&((t=this.container.find(".block-adeptus-timestamp")).find(".timestamp-text").text(e),t.removeClass("d-none")))},scrollToListTop:function(){var e=this.container.find(".block-adeptus-report-list");e.length&&e[0].scrollIntoView({behavior:"smooth",block:"start"})},scrollToEmbeddedTableTop:function(){var e=this.container.find(".embedded-table-view");e.length&&e[0].scrollIntoView({behavior:"smooth",block:"start"})},showEmbeddedLoadingOverlay:function(){var e=this.container.find(".embedded-loading-overlay");this.container.find(".block-adeptus-content").removeClass("d-none"),e.removeClass("d-none").css("opacity",0).animate({opacity:1},150)},hideEmbeddedLoadingOverlay:function(){this.container.find(".embedded-loading-overlay").animate({opacity:0},150,function(){c(this).addClass("d-none")})},toggleSearchableDropdown:function(e){e.hasClass("open")?this.closeSearchableDropdown(e):this.openSearchableDropdown(e)},openSearchableDropdown:function(e){var t=this,a=(this.container.find(".searchable-dropdown.open").each(function(){c(this).is(e)||t.closeSearchableDropdown(c(this))}),e.addClass("open"),e.find(".searchable-dropdown-toggle").attr("aria-expanded","true"),e.find(".searchable-dropdown-input"));a.val(""),e.find(".searchable-dropdown-item").show().removeClass("focused"),e.find(".searchable-dropdown-empty").addClass("d-none"),setTimeout(function(){a.focus()},50)},closeSearchableDropdown:function(e){e.removeClass("open"),e.find(".searchable-dropdown-toggle").attr("aria-expanded","false"),e.find(".searchable-dropdown-item").removeClass("focused")},filterSearchableDropdown:function(e,t){var a=e.find(".searchable-dropdown-item"),e=e.find(".searchable-dropdown-empty"),n=0;a.each(function(){var e=c(this).data("search")||"";""===t||-1!==e.indexOf(t)?(c(this).show(),n++):c(this).hide()}),a.filter(":hidden").removeClass("focused"),0===n?e.removeClass("d-none"):e.addClass("d-none")},selectSearchableDropdownItem:function(e,t,a){e.find(".searchable-dropdown-text").text(a),e.find(".searchable-dropdown-item").removeClass("selected"),e.find('.searchable-dropdown-item[data-value="'+t+'"]').addClass("selected");a=e.siblings("select");a.length&&a.val(t).trigger("change"),this.closeSearchableDropdown(e)},scrollDropdownItemIntoView:function(e){var t=e.closest(".searchable-dropdown-list"),a=t.height(),n=e.position().top,e=e.outerHeight();n<0?t.scrollTop(t.scrollTop()+n):a<n+e&&t.scrollTop(t.scrollTop()+(n+e-a))},escapeHtml:function(e){var t=document.createElement("div");return t.textContent=e,t.innerHTML},formatTimeAgo:function(e){e=Math.floor((new Date-e)/1e3);if(e<60)return"Just now";e=Math.floor(e/60);if(e<60)return e+" minute"+(1!==e?"s":"")+" ago";e=Math.floor(e/60);if(e<24)return e+" hour"+(1!==e?"s":"")+" ago";e=Math.floor(e/24);return e+" day"+(1!==e?"s":"")+" ago"}},{init:function(e){return new a(e)}}});